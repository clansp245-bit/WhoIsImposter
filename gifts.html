<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
Â Â Â  <meta charset="UTF-8">
Â Â Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â Â Â  <title>ğŸ’ Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„Ù…Ù„ÙƒÙŠ Ø§Ù„Ø£Ø³Ø·ÙˆØ±ÙŠ</title>

Â Â Â  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
Â Â Â  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
Â Â Â  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
Â Â Â  <script src="auth.js"></script> 

Â Â Â  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
Â Â Â  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

Â Â Â  <style>
Â Â Â Â Â Â Â  :root {
Â Â Â Â Â Â Â Â Â Â Â  --primary: #6366f1;
Â Â Â Â Â Â Â Â Â Â Â  --accent-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
Â Â Â Â Â Â Â Â Â Â Â  --bg-body: #0a0f1e;
Â Â Â Â Â Â Â Â Â Â Â  --card-bg: rgba(30, 41, 59, 0.7);
Â Â Â Â Â Â Â Â Â Â Â  --text-main: #f1f5f9;
Â Â Â Â Â Â Â Â Â Â Â  --text-dim: #94a3b8;
Â Â Â Â Â Â Â Â Â Â Â  --gold: #ffd700;
Â Â Â Â Â Â Â Â Â Â Â  --gem-color: #22d3ee;
Â Â Â Â Â Â Â Â Â Â Â  --pro-color: #f472b6;
Â Â Â Â Â Â Â Â Â Â Â  --tool-color: #38bdf8;
Â Â Â Â Â Â Â Â Â Â Â  --xp-color: #10b981;
Â Â Â Â Â Â Â  }

Â Â Â Â Â Â Â  body {
Â Â Â Â Â Â Â Â Â Â Â  font-family: 'Cairo', sans-serif;
Â Â Â Â Â Â Â Â Â Â Â  background-color: var(--bg-body);
Â Â Â Â Â Â Â Â Â Â Â  background-image: radial-gradient(circle at top right, #1e1b4b, transparent);
Â Â Â Â Â Â Â Â Â Â Â  color: var(--text-main);
Â Â Â Â Â Â Â Â Â Â Â  padding: 10px; margin: 0;
Â Â Â Â Â Â Â Â Â Â Â  display: flex; flex-direction: column; align-items: center;
Â Â Â Â Â Â Â  }

Â Â Â Â Â Â Â  .top-info-bar { width: 100%; max-width: 500px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; gap: 5px; }
Â Â Â Â Â Â Â  .currency-display { background: rgba(255, 255, 255, 0.05); padding: 8px 12px; border-radius: 15px; font-weight: 900; border: 1px solid rgba(255,255,255,0.1); font-size: 0.85rem; }
Â Â Â Â Â Â Â  #coins-display { color: var(--gold); border-color: var(--gold); }
Â Â Â Â Â Â Â  #gems-display { color: var(--gem-color); border-color: var(--gem-color); }

Â Â Â Â Â Â Â  .card {
Â Â Â Â Â Â Â Â Â Â Â  background: var(--card-bg); backdrop-filter: blur(15px); padding: 15px; border-radius: 20px;
Â Â Â Â Â Â Â Â Â Â Â  width: 100%; max-width: 500px; border: 1px solid rgba(255,255,255,0.1); box-sizing: border-box; margin-bottom: 12px;
Â Â Â Â Â Â Â Â Â Â Â  position: relative;
Â Â Â Â Â Â Â  }

Â Â Â Â Â Â Â  .search-container { position: relative; width: 100%; }
Â Â Â Â Â Â Â  #player-search { width: 100%; padding: 12px; border-radius: 10px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: white; font-family: 'Cairo'; box-sizing: border-box; outline: none; }
Â Â Â Â Â Â Â  .search-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: #1e293b; border-radius: 10px; z-index: 100; max-height: 200px; overflow-y: auto; display: none; border: 1px solid var(--primary); margin-top: 5px; }
Â Â Â Â Â Â Â  .search-item { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; font-size: 0.85rem; display: flex; justify-content: space-between; }
Â Â Â Â Â Â Â  .search-item:hover { background: var(--primary); }

Â Â Â Â Â Â Â  .tabs { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; width: 100%; max-width: 500px; scrollbar-width: none; padding-bottom: 5px; }
Â Â Â Â Â Â Â  .tab { padding: 8px 15px; background: rgba(255,255,255,0.05); border-radius: 20px; cursor: pointer; white-space: nowrap; font-weight: 700; font-size: 0.75rem; transition: 0.3s; }
Â Â Â Â Â Â Â  .tab.active { background: var(--primary); color: white; }

Â Â Â Â Â Â Â  .gifts-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; width: 100%; }
Â Â Â Â Â Â Â  .gift-item { 
Â Â Â Â Â Â Â Â Â Â Â  background: rgba(255, 255, 255, 0.03); padding: 15px 5px; border-radius: 18px; border: 1px solid rgba(255,255,255,0.05);
Â Â Â Â Â Â Â Â Â Â Â  display: flex; flex-direction: column; align-items: center; text-align: center; position: relative;
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â  .gift-icon-container { width: 60px; height: 60px; border-radius: 18px; background: rgba(255,255,255,0.05); display: flex; justify-content: center; align-items: center; font-size: 1.8rem; margin-bottom: 8px; }
Â Â Â Â Â Â Â  .badge-icon { color: var(--gold); }
Â Â Â Â Â Â Â  .tool-icon { color: var(--tool-color); }
Â Â Â Â Â Â Â  .pro-exclusive-tag { position: absolute; top: 8px; left: 8px; background: var(--pro-color); color: white; font-size: 0.6rem; padding: 2px 8px; border-radius: 6px; font-weight: 900; }

Â Â Â Â Â Â Â  .gift-name { font-weight: 800; font-size: 0.85rem; color: #fff; line-height: 1.2; margin-bottom: 4px; }
Â Â Â Â Â Â Â  .gift-xp { color: var(--xp-color); font-size: 0.75rem; font-weight: bold; margin-bottom: 5px; }
Â Â Â Â Â Â Â  .gift-price { font-weight: 900; font-size: 0.85rem; }
Â Â Â Â Â Â Â  .price-coins { color: var(--gold); }
Â Â Â Â Â Â Â  .price-gems { color: var(--gem-color); }

Â Â Â Â Â Â Â  .qty-controls { display: flex; align-items: center; gap: 12px; margin-top: 10px; }
Â Â Â Â Â Â Â  .qty-btn { width: 28px; height: 28px; border: none; background: var(--primary); color: white; border-radius: 8px; cursor: pointer; font-weight: 900; }
Â Â Â Â Â Â Â  .qty-num { min-width: 20px; font-weight: 900; }

Â Â Â Â Â Â Â  .send-btn { width: 100%; padding: 15px; border-radius: 18px; border: none; background: var(--accent-gradient); color: white; font-weight: 900; cursor: pointer; margin-top: 15px; font-size: 1rem; }
Â Â Â Â Â Â Â  .send-btn:disabled { opacity: 0.3; cursor: not-allowed; }

Â Â Â Â Â Â Â  #purchase-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 1000; display: none; flex-direction: column; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
Â Â Â  </style>
</head>

<body onload="initGiftPage()">

<div class="top-info-bar">
Â Â Â  <a href="index.html" style="color: var(--text-dim); text-decoration: none; font-size: 1.2rem;"><i class="fas fa-chevron-right"></i></a>
Â Â Â  <div style="display: flex; gap: 8px;">
Â Â Â Â Â Â Â  <div id="coins-display" class="currency-display"><i class="fas fa-coins"></i> <span id="user-coins">0</span></div>
Â Â Â Â Â Â Â  <div id="gems-display" class="currency-display"><i class="fas fa-gem"></i> <span id="user-gems">0</span></div>
Â Â Â  </div>
</div>

<h2 style="font-weight: 900; color: #fff; margin: 10px 0;">ğŸ’ Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„Ù…Ù„ÙƒÙŠ</h2>

<div class="card">
Â Â Â  <div class="search-container">
Â Â Â Â Â Â Â  <input type="text" id="player-search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† ØµØ¯ÙŠÙ‚ Ù„Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø¯ÙŠØ© Ù„Ù‡...">
Â Â Â Â Â Â Â  <div id="search-results" class="search-dropdown"></div>
Â Â Â  </div>
Â Â Â  <div id="rec-info" style="margin-top: 10px; font-size: 0.85rem; color: var(--primary); font-weight: bold; text-align: center;">
Â Â Â Â Â Â Â  Ø§Ù„Ù…Ø³ØªÙ„Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="rec-name" style="color:#fff; border-bottom: 1px dashed #fff;">Ù†ÙØ³ÙŠ (Ø­Ø³Ø§Ø¨ÙŠ)</span>
Â Â Â  </div>
</div>

<div class="tabs">
Â Â Â  <div class="tab active" onclick="filterGifts('all', this)">Ø§Ù„ÙƒÙ„</div>
Â Â Â  <div class="tab" onclick="filterGifts('luxury', this)">Ù…Ù„ÙƒÙŠ ğŸ’</div>
Â Â Â  <div class="tab" onclick="filterGifts('medium', this)">Ù…ØªÙˆØ³Ø· âš–ï¸</div>
Â Â Â  <div class="tab" onclick="filterGifts('cheap', this)">Ø¨Ø³ÙŠØ· âœ¨</div>
Â Â Â  <div class="tab" onclick="filterGifts('pro', this)">Ø¨Ø±Ùˆ ğŸ”¥</div>
Â Â Â  <div class="tab" onclick="filterGifts('tools', this)">Ø£Ø¯ÙˆØ§Øª ğŸ› ï¸</div>
Â Â Â  <div class="tab" onclick="filterGifts('badges', this)">Ø´Ø§Ø±Ø§Øª ğŸ…</div>
</div>

<div class="card">
Â Â Â  <div id="gifts-container" class="gifts-grid"></div>
Â Â Â  <div style="text-align: center; margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
Â Â Â Â Â Â Â  <div style="display: flex; flex-direction: column; gap: 8px;">
Â Â Â Â Â Â Â Â Â Â Â  <span style="color: var(--text-dim); font-size: 0.85rem;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ù„ÙƒÙŠØ©:</span>
Â Â Â Â Â Â Â Â Â Â Â  <div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <span id="total-coins-cost" style="color: var(--gold); font-weight: 900; font-size: 1.1rem;">0 ÙƒÙˆÙŠÙ†Ø²</span>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <span style="color: white; margin: 0 8px; opacity: 0.3;">|</span>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <span id="total-gems-cost" style="color: var(--gem-color); font-weight: 900; font-size: 1.1rem;">0 Ø¬ÙˆØ§Ù‡Ø±</span>
Â Â Â Â Â Â Â Â Â Â Â  </div>
Â Â Â Â Â Â Â  </div>
Â Â Â  </div>
Â Â Â  <button class="send-btn" id="send-btn" disabled onclick="processPurchase()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¢Ù†</button>
</div>

<div id="purchase-overlay">
Â Â Â  <i class="fas fa-crown fa-spin" style="font-size: 3.5rem; color: var(--gold); margin-bottom: 15px;"></i>
Â Â Â  <p style="font-weight: bold; font-size: 1.1rem;">Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ùƒ ÙÙŠ Ø§Ù„Ø®Ø²ÙŠÙ†Ø©...</p>
</div>

<script>
let currentUserData = {};
let selectedPlayerUid = null;
let cart = {};

// Ø¯Ø§ØªØ§ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ - Ù…Ø­Ø¯Ø«Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
const gifts = [
Â Â Â  // --- Ø§Ù„Ø£Ø¯ÙˆØ§Øª ÙˆØ§Ù„Ø´Ø§Ø±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ---
Â Â Â  {id: 777, name:"Premium Pass", cost:3, currency: "gems", cat:"tools", icon:"fas fa-ticket-alt", isTool: true, xp: 1000},
Â Â Â  {id: 50, name:"Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø§Ø³Ù…", cost:5000, currency: "coins", cat:"tools", icon:"fas fa-id-card", isTool: true, xp: 0},
Â Â Â  {id: 51, name:"Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù€ ID", cost:1000000, currency: "coins", cat:"tools", icon:"fas fa-fingerprint", isTool: true, xp: 0},
Â Â Â  {id: 100, name:"Ø´Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø·ÙˆØ±Ø©", cost:50000, currency: "coins", cat:"badges", icon:"legend_badge", isBadge: true, xp: 0},
Â Â Â  {id: 101, name:"Ø´Ø§Ø±Ø© Ø§Ù„ØªÙ†ÙŠÙ†", cost:30000, currency: "coins", cat:"badges", icon:"dragon_badge", isBadge: true, xp: 0},

Â Â Â  // --- Ù‡Ø¯Ø§ÙŠØ§ Ù…Ù„ÙƒÙŠØ© (Luxury) ---
Â Â Â  {id: 200, name:"Ù‚ØµØ± Ø§Ù„ØµÙŠÙ", cost:150000, currency: "coins", cat:"luxury", icon:"ğŸ°", xp: 15000},
Â Â Â  {id: 201, name:"ÙŠØ®Øª Ù…Ù„ÙƒÙŠ", cost:85000, currency: "coins", cat:"luxury", icon:"ğŸš¢", xp: 8500},
Â Â Â  {id: 202, name:"Ø·Ø§Ø¦Ø±Ø© Ù†ÙØ§Ø«Ø©", cost:250000, currency: "coins", cat:"luxury", icon:"ğŸ›©ï¸", xp: 30000},
Â Â Â  {id: 203, name:"Ø¨Ø±Ø¬ Ø¯Ø¨ÙŠ", cost:500000, currency: "coins", cat:"luxury", icon:"ğŸ™ï¸", xp: 60000},
Â Â Â  {id: 204, name:"ØªØ§Ø¬ Ù…Ø±ØµØ¹", cost:120000, currency: "coins", cat:"luxury", icon:"ğŸ‘‘", xp: 12000},
Â Â Â  {id: 205, name:"Ø³ÙŠØ§Ø±Ø© Ø°Ù‡Ø¨ÙŠØ©", cost:95000, currency: "coins", cat:"luxury", icon:"ğŸš•", xp: 9000},
Â Â Â  {id: 206, name:"Ø¬Ø²ÙŠØ±Ø© Ø®Ø§ØµØ©", cost:300000, currency: "coins", cat:"luxury", icon:"ğŸï¸", xp: 35000},

Â Â Â  // --- Ù‡Ø¯Ø§ÙŠØ§ Ù…ØªÙˆØ³Ø·Ø© (Medium) ---
Â Â Â  {id: 300, name:"Ø³ÙŠØ§Ø±Ø© Ø±ÙŠØ§Ø¶ÙŠØ©", cost:25000, currency: "coins", cat:"medium", icon:"ğŸï¸", xp: 2500},
Â Â Â  {id: 301, name:"Ø³Ø§Ø¹Ø© ÙŠØ¯ ÙØ§Ø®Ø±Ø©", cost:12000, currency: "coins", cat:"medium", icon:"âŒš", xp: 1500},
Â Â Â  {id: 302, name:"Ø¯Ø±Ø§Ø¬Ø© Ù†Ø§Ø±ÙŠØ©", cost:8000, currency: "coins", cat:"medium", icon:"ğŸï¸", xp: 1000},
Â Â Â  {id: 303, name:"Ø®Ø§ØªÙ… Ø§Ù„Ù…Ø§Ø³", cost:15000, currency: "coins", cat:"medium", icon:"ğŸ’", xp: 2000},
Â Â Â  {id: 304, name:"Ù„Ø§Ø¨ØªÙˆØ¨ Ù‚ÙŠÙ…Ù†Ù‚", cost:6000, currency: "coins", cat:"medium", icon:"ğŸ’»", xp: 800},
Â Â Â  {id: 305, name:"ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ø­ØªØ±Ø§ÙÙŠØ©", cost:4500, currency: "coins", cat:"medium", icon:"ğŸ“·", xp: 600},

Â Â Â  // --- Ù‡Ø¯Ø§ÙŠØ§ Ø¨Ø³ÙŠØ·Ø© (Cheap) ---
Â Â Â  {id: 1, name:"ÙˆØ±Ø¯Ø© Ø­Ù…Ø±Ø§Ø¡", cost:50, currency: "coins", cat:"cheap", icon:"ğŸŒ¹", xp: 5},
Â Â Â  {id: 2, name:"Ù‚Ù„Ø¨ Ø­Ø¨", cost:100, currency: "coins", cat:"cheap", icon:"â¤ï¸", xp: 10},
Â Â Â  {id: 3, name:"ÙÙ†Ø¬Ø§Ù† Ù‚Ù‡ÙˆØ©", cost:20, currency: "coins", cat:"cheap", icon:"â˜•", xp: 2},
Â Â Â  {id: 4, name:"Ø¯ÙˆÙ†Ø§Øª", cost:40, currency: "coins", cat:"cheap", icon:"ğŸ©", xp: 4},
Â Â Â  {id: 5, name:"Ø¨ÙŠØªØ²Ø§", cost:150, currency: "coins", cat:"cheap", icon:"ğŸ•", xp: 15},
Â Â Â  {id: 6, name:"Ø¨Ø§Ù„ÙˆÙ† Ù†ÙŠÙˆÙ†", cost:30, currency: "coins", cat:"cheap", icon:"ğŸˆ", xp: 3},

Â Â Â  // --- Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ø¨Ø±Ùˆ (Pro) ---
Â Â Â  {id: 60, name:"ØªØ§Ø¬ Ø§Ù„Ø¨Ø±Ùˆ", cost:30000, currency: "coins", cat:"pro", icon:"fas fa-crown", proOnly: true, xp: 5000},
Â Â Â  {id: 61, name:"ØºÙˆØ§ØµØ© Ù†ÙŠÙˆÙ†", cost:45000, currency: "coins", cat:"pro", icon:"fas fa-subway", proOnly: true, xp: 7000},
Â Â Â  {id: 62, name:"Ø¯Ø±Ø¹ Ø§Ù„ÙØ§Ø±Ø³", cost:15000, currency: "coins", cat:"pro", icon:"fas fa-shield-alt", proOnly: true, xp: 2000}
];

// ØªÙˆÙ„ÙŠØ¯ Ø£ÙƒØ«Ø± Ù…Ù† 40 Ù‡Ø¯ÙŠØ© Ø¥Ø¶Ø§ÙÙŠØ© Ù…ØªÙ†ÙˆØ¹Ø© Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹ Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¹Ø¯Ø¯ ÙÙˆÙ‚ 50
const extraIcons = ["ğŸ¸", "ğŸ¨", "ğŸ®", "ğŸš€", "ğŸ›¸", "ğŸ’", "ğŸ…", "ğŸ†", "ğŸ“½ï¸", "ğŸ¤", "ğŸ§", "ğŸ•¶ï¸", "ğŸ‘”", "ğŸ‘œ", "ğŸ‘ ", "ğŸ‘Ÿ", "ğŸ‘—", "ğŸ‘˜", "ğŸ’„", "ğŸŒ‚", "ğŸ‘œ", "ğŸ’", "ğŸ‘’", "ğŸ“", "ğŸ‘‘", "ğŸ¤³", "ğŸ“±", "ğŸ“²", "ğŸ“º", "ğŸ“¼", "ğŸ“·", "ğŸ“¹", "ğŸ“", "â˜ï¸", "ğŸ“¡", "ğŸ”‹", "ğŸ’¡", "ğŸ”¦", "ğŸ•¯ï¸", "ğŸ› ï¸", "â›ï¸", "âš™ï¸", "ğŸ›¡ï¸", "ğŸ¹", "ğŸ—¡ï¸", "âš”ï¸", "ğŸ”«", "ğŸ”®", "ğŸ§¿"];

extraIcons.forEach((icon, index) => {
Â Â Â  let category = "cheap";
Â Â Â  let cost = 200 + (index * 150);
Â Â Â  let xp = Math.floor(cost / 10);
Â Â Â  
Â Â Â  if(cost > 10000) category = "medium";
Â Â Â  if(cost > 40000) category = "luxury";

Â Â Â  gifts.push({
Â Â Â Â Â Â Â  id: 1000 + index,
Â Â Â Â Â Â Â  name: `Ù‡Ø¯ÙŠØ© Ù…Ù„ÙƒÙŠØ© #${index + 1}`,
Â Â Â Â Â Â Â  cost: cost,
Â Â Â Â Â Â Â  currency: "coins",
Â Â Â Â Â Â Â  cat: category,
Â Â Â Â Â Â Â  icon: icon,
Â Â Â Â Â Â Â  xp: xp
Â Â Â  });
});

async function initGiftPage() {
Â Â Â  firebase.auth().onAuthStateChanged(async user => {
Â Â Â Â Â Â Â  if(!user) return;
Â Â Â Â Â Â Â  selectedPlayerUid = user.uid;
Â Â Â Â Â Â Â  const doc = await db.collection('users').doc(user.uid).get();
Â Â Â Â Â Â Â  currentUserData = doc.data() || {};
Â Â Â Â Â Â Â  document.getElementById("user-coins").innerText = (currentUserData.totalCoins || 0).toLocaleString();
Â Â Â Â Â Â Â  document.getElementById("user-gems").innerText = (currentUserData.s_gems || 0).toLocaleString();
Â Â Â Â Â Â Â  renderGifts('all');
Â Â Â Â Â Â Â  setupSearch();
Â Â Â  });
}

function renderGifts(filter) {
Â Â Â  const container = document.getElementById("gifts-container");
Â Â Â  container.innerHTML = '';
Â Â Â  
Â Â Â  gifts.forEach(g => {
Â Â Â Â Â Â Â  if(filter !== 'all' && g.cat !== filter) return;
Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â  const div = document.createElement("div");
Â Â Â Â Â Â Â  div.className = "gift-item";
Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â  let displayIcon = g.icon;
Â Â Â Â Â Â Â  if(g.isBadge) {
Â Â Â Â Â Â Â Â Â Â Â  const icons = {"legend_badge":"fa-shield-halved", "dragon_badge":"fa-dragon"};
Â Â Â Â Â Â Â Â Â Â Â  displayIcon = `<i class="fas ${icons[g.icon]} badge-icon"></i>`;
Â Â Â Â Â Â Â  } else if(g.icon.startsWith('fas')) {
Â Â Â Â Â Â Â Â Â Â Â  displayIcon = `<i class="${g.icon} tool-icon"></i>`;
Â Â Â Â Â Â Â  } else {
Â Â Â Â Â Â Â Â Â Â Â  displayIcon = `<span>${g.icon}</span>`;
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â  div.innerHTML = `
Â Â Â Â Â Â Â Â Â Â Â  ${g.proOnly ? '<span class="pro-exclusive-tag">PRO</span>' : ''}
Â Â Â Â Â Â Â Â Â Â Â  <div class="gift-icon-container">${displayIcon}</div>
Â Â Â Â Â Â Â Â Â Â Â  <div class="gift-name">${g.name}</div>
Â Â Â Â Â Â Â Â Â Â Â  <div class="gift-xp">${g.xp > 0 ? `+${g.xp} XP` : 'Ø¹Ù†ØµØ± Ø®Ø§Øµ'}</div>
Â Â Â Â Â Â Â Â Â Â Â  <div class="gift-price ${g.currency === 'gems' ? 'price-gems' : 'price-coins'}">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <i class="fas ${g.currency === 'gems' ? 'fa-gem' : 'fa-coins'}"></i> ${g.cost.toLocaleString()}
Â Â Â Â Â Â Â Â Â Â Â  </div>
Â Â Â Â Â Â Â Â Â Â Â  <div class="qty-controls">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <button class="qty-btn" onclick="changeQty(${g.id}, -1)">-</button>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <span class="qty-num" id="qty-${g.id}">${cart[g.id] || 0}</span>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <button class="qty-btn" onclick="changeQty(${g.id}, 1)">+</button>
Â Â Â Â Â Â Â Â Â Â Â  </div>
Â Â Â Â Â Â Â  `;
Â Â Â Â Â Â Â  container.appendChild(div);
Â Â Â  });
}

function changeQty(id, delta) {
Â Â Â  const gift = gifts.find(g => g.id === id);
Â Â Â  cart[id] = Math.max(0, (cart[id] || 0) + delta);
Â Â Â  
Â Â Â  if((gift.isBadge || gift.isTool) && cart[id] > 1) cart[id] = 1;
Â Â Â  
Â Â Â  document.getElementById(`qty-${id}`).innerText = cart[id];
Â Â Â  updateTotal();
}

function updateTotal() {
Â Â Â  let coinsTotal = 0; let gemsTotal = 0;
Â Â Â  for(let id in cart) {
Â Â Â Â Â Â Â  const gift = gifts.find(g => g.id == id);
Â Â Â Â Â Â Â  if(!gift) continue;
Â Â Â Â Â Â Â  if(gift.currency === "gems") gemsTotal += gift.cost * cart[id];
Â Â Â Â Â Â Â  else coinsTotal += gift.cost * cart[id];
Â Â Â  }
Â Â Â  document.getElementById("total-coins-cost").innerText = coinsTotal.toLocaleString() + " ÙƒÙˆÙŠÙ†Ø²";
Â Â Â  document.getElementById("total-gems-cost").innerText = gemsTotal.toLocaleString() + " Ø¬ÙˆØ§Ù‡Ø±";
Â Â Â  
Â Â Â  const canAfford = coinsTotal <= (currentUserData.totalCoins || 0) && gemsTotal <= (currentUserData.s_gems || 0);
Â Â Â  document.getElementById("send-btn").disabled = (coinsTotal + gemsTotal === 0) || !canAfford;
}

function setupSearch() {
Â Â Â  const input = document.getElementById('player-search');
Â Â Â  const results = document.getElementById('search-results');
Â Â Â  input.addEventListener('input', async () => {
Â Â Â Â Â Â Â  const val = input.value.trim();
Â Â Â Â Â Â Â  if(val.length < 2) { results.style.display = 'none'; return; }
Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â  const snap = await db.collection('users').where('displayName', '>=', val).where('displayName', '<=', val + '\uf8ff').limit(5).get();
Â Â Â Â Â Â Â  results.innerHTML = '';
Â Â Â Â Â Â Â  if(snap.empty) {
Â Â Â Â Â Â Â Â Â Â Â  results.innerHTML = '<div class="search-item">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø§Ø¹Ø¨ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù…</div>';
Â Â Â Â Â Â Â  } else {
Â Â Â Â Â Â Â Â Â Â Â  snap.forEach(doc => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const data = doc.data();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const div = document.createElement('div');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  div.className = 'search-item';
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  div.innerHTML = `<span>${data.displayName}</span> <small style="color:var(--primary)">${doc.id.substring(0,6)}#</small>`;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  div.onclick = () => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  selectedPlayerUid = doc.id;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  document.getElementById('rec-name').innerText = data.displayName;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  results.style.display = 'none';
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  input.value = '';
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  };
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  results.appendChild(div);
Â Â Â Â Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  results.style.display = 'block';
Â Â Â  });
}

function filterGifts(cat, el) {
Â Â Â  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
Â Â Â  el.classList.add('active');
Â Â Â  renderGifts(cat);
}

async function processPurchase() {
Â Â Â  document.getElementById("purchase-overlay").style.display = "flex";
Â Â Â  const batch = db.batch();
Â Â Â  const myUid = firebase.auth().currentUser.uid;
Â Â Â  const myRef = db.collection('users').doc(myUid);
Â Â Â  const targetRef = db.collection('users').doc(selectedPlayerUid);

Â Â Â  let tCoins = 0; let tGems = 0;

Â Â Â  for(let id in cart) {
Â Â Â Â Â Â Â  if(cart[id] <= 0) continue;
Â Â Â Â Â Â Â  const gift = gifts.find(g => g.id == id);
Â Â Â Â Â Â Â  const qty = cart[id];

Â Â Â Â Â Â Â  if(gift.currency === "gems") tGems += gift.cost * qty;
Â Â Â Â Â Â Â  else tCoins += gift.cost * qty;

Â Â Â Â Â Â Â  if(gift.isBadge) {
Â Â Â Â Â Â Â Â Â Â Â  batch.update(targetRef, { badges: firebase.firestore.FieldValue.arrayUnion(gift.icon) });
Â Â Â Â Â Â Â  } else if(gift.isTool) {
Â Â Â Â Â Â Â Â Â Â Â  for(let i=0; i<qty; i++) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  batch.update(targetRef, { inventory: firebase.firestore.FieldValue.arrayUnion(gift.name) });
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  } else {
Â Â Â Â Â Â Â Â Â Â Â  batch.update(targetRef, { xp: firebase.firestore.FieldValue.increment(gift.xp * qty) });
Â Â Â Â Â Â Â  }
Â Â Â  }

Â Â Â  try {
Â Â Â Â Â Â Â  batch.update(myRef, { 
Â Â Â Â Â Â Â Â Â Â Â  totalCoins: firebase.firestore.FieldValue.increment(-tCoins),
Â Â Â Â Â Â Â Â Â Â Â  s_gems: firebase.firestore.FieldValue.increment(-tGems)
Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â  await batch.commit();
Â Â Â Â Â Â Â  alert("ğŸ’ ØªÙ… Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­! Ø´ÙƒØ±Ø§Ù‹ Ù„ÙƒØ±Ù…Ùƒ Ø§Ù„Ù…Ù„ÙƒÙŠ.");
Â Â Â Â Â Â Â  location.reload();
Â Â Â  } catch(e) {
Â Â Â Â Â Â Â  alert("âŒ ÙØ´Ù„Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.");
Â Â Â  } finally {
Â Â Â Â Â Â Â  document.getElementById("purchase-overlay").style.display = "none";
Â Â Â  }
}
</script>

</body>
</html>
