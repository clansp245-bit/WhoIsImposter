<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’ Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„Ù…Ù„ÙƒÙŠ Ø§Ù„Ø£Ø³Ø·ÙˆØ±ÙŠ</title>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="auth.js"></script> 

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        :root {
            --primary: #6366f1;
            --accent-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            --bg-body: #0a0f1e;
            --card-bg: rgba(30, 41, 59, 0.7);
            --text-main: #f1f5f9;
            --text-dim: #94a3b8;
            --gold: #ffd700;
            --pro-color: #f472b6;
            --tool-color: #38bdf8;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-body);
            background-image: radial-gradient(circle at top right, #1e1b4b, transparent);
            color: var(--text-main);
            padding: 10px; margin: 0;
            display: flex; flex-direction: column; align-items: center;
        }

        .top-info-bar { width: 100%; max-width: 500px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        #coins-display { background: rgba(251, 191, 36, 0.1); padding: 8px 15px; border-radius: 15px; color: var(--gold); font-weight: 900; border: 1px solid var(--gold); }

        .card {
            background: var(--card-bg); backdrop-filter: blur(15px); padding: 15px; border-radius: 20px;
            width: 100%; max-width: 500px; border: 1px solid rgba(255,255,255,0.1); box-sizing: border-box; margin-bottom: 12px;
            position: relative;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¨Ø­Ø« */
        .search-container { position: relative; width: 100%; }
        #player-search { width: 100%; padding: 12px; border-radius: 10px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: white; font-family: 'Cairo'; box-sizing: border-box; }
        .search-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: #1e293b; border-radius: 10px; z-index: 100; max-height: 150px; overflow-y: auto; display: none; border: 1px solid var(--primary); margin-top: 5px; }
        .search-item { padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; font-size: 0.85rem; }
        .search-item:hover { background: var(--primary); }

        .tabs { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; width: 100%; max-width: 500px; scrollbar-width: none; }
        .tab { padding: 8px 15px; background: rgba(255,255,255,0.05); border-radius: 20px; cursor: pointer; white-space: nowrap; font-weight: 700; font-size: 0.8rem; }
        .tab.active { background: var(--primary); color: white; }

        .gifts-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; width: 100%; }
        .gift-item { 
            background: rgba(255, 255, 255, 0.03); padding: 15px 5px; border-radius: 18px; border: 1px solid rgba(255,255,255,0.05);
            display: flex; flex-direction: column; align-items: center; text-align: center; position: relative;
        }
        
        .gift-icon-container { width: 60px; height: 60px; border-radius: 20px; background: rgba(255,255,255,0.05); display: flex; justify-content: center; align-items: center; font-size: 1.8rem; margin-bottom: 8px; }
        .badge-icon { color: var(--gold); }
        .tool-icon { color: var(--tool-color); }
        .pro-exclusive-tag { position: absolute; top: 5px; left: 5px; background: var(--pro-color); color: white; font-size: 0.6rem; padding: 2px 6px; border-radius: 5px; font-weight: 900; }

        .gift-name { font-weight: 900; font-size: 0.85rem; color: #fff; }
        .gift-price { color: var(--gold); font-weight: 900; font-size: 0.8rem; margin-top: 5px; }

        .qty-controls { display: flex; align-items: center; gap: 10px; margin-top: 8px; }
        .qty-btn { width: 25px; height: 25px; border: none; background: var(--primary); color: white; border-radius: 5px; cursor: pointer; font-weight: 900; }

        .send-btn { width: 100%; padding: 15px; border-radius: 15px; border: none; background: var(--accent-gradient); color: white; font-weight: 900; cursor: pointer; margin-top: 15px; }
        .send-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        #purchase-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; display: none; flex-direction: column; justify-content: center; align-items: center; }
    </style>
</head>

<body onload="initGiftPage()">

<div class="top-info-bar">
    <a href="index.html" style="color: var(--text-dim); text-decoration: none;"><i class="fas fa-chevron-right"></i></a>
    <div id="coins-display"><i class="fas fa-coins"></i> <span id="user-coins">0</span></div>
</div>

<h2 style="font-weight: 900; color: #fff;">ğŸ’ Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„Ù…Ù„ÙƒÙŠ</h2>

<div class="card">
    <div class="search-container">
        <input type="text" id="player-search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† ØµØ¯ÙŠÙ‚ Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù€ ID...">
        <div id="search-results" class="search-dropdown"></div>
    </div>
    <div id="rec-info" style="margin-top: 10px; font-size: 0.8rem; color: var(--primary); font-weight: bold;">Ø§Ù„Ù…Ø³ØªÙ„Ù…: <span id="rec-name" style="color:#fff">Ù†ÙØ³ÙŠ</span></div>
</div>

<div class="tabs">
    <div class="tab active" onclick="filterGifts('all', this)">Ø§Ù„ÙƒÙ„</div>
    <div class="tab" onclick="filterGifts('tools', this)">Ø§Ù„Ø£Ø¯ÙˆØ§Øª</div>
    <div class="tab" onclick="filterGifts('badges', this)">Ø´Ø§Ø±Ø§Øª</div>
    <div class="tab" onclick="filterGifts('pro', this)">Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ø¨Ø±Ùˆ ğŸ”¥</div>
</div>

<div class="card">
    <div id="gifts-container" class="gifts-grid"></div>
    <div style="text-align: center; margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;">
        <span style="color: var(--text-dim)">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span>
        <span id="total-cost" style="color: var(--gold); font-weight: 900; font-size: 1.2rem;">0</span>
    </div>
    <button class="send-btn" id="send-btn" disabled onclick="processPurchase()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø´Ø±Ø§Ø¡</button>
</div>

<div id="purchase-overlay">
    <i class="fas fa-spinner fa-spin" style="font-size: 3rem; color: var(--primary);"></i>
    <p>Ø¬Ø§Ø±ÙŠ ØªÙ†ÙÙŠØ° Ø§Ù„Ø·Ù„Ø¨...</p>
</div>

<script>
let currentUserData = {};
let selectedPlayerUid = null;
let cart = {};

const gifts = [
    // --- Ø§Ù„Ø£Ø¯ÙˆØ§Øª ---
    {id: 50, name:"Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø§Ø³Ù…", cost:1000, cat:"tools", icon:"fas fa-id-card", isTool: true},
    {id: 51, name:"Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù€ ID", cost:1000000, cat:"tools", icon:"fas fa-fingerprint", isTool: true},

    // --- Ø§Ù„Ø¨Ø±Ùˆ (15 Ù‡Ø¯ÙŠØ©) ---
    {id: 60, name:"Ø§Ù„ØªØ§Ø¬ Ø§Ù„Ù…Ù„ÙƒÙŠ", cost:5000, cat:"pro", icon:"fas fa-crown", proOnly: true, xp: 2000},
    {id: 61, name:"Ø³ÙŠØ§Ø±Ø© Ø°Ù‡Ø¨ÙŠØ©", cost:25000, cat:"pro", icon:"fas fa-car-side", proOnly: true, xp: 12000},
    {id: 62, name:"Ø®Ø§ØªÙ… Ø§Ù„Ù…Ø§Ø³ Ø¨Ø±Ùˆ", cost:4000, cat:"pro", icon:"fas fa-ring", proOnly: true, xp: 1500},
    {id: 63, name:"ÙŠØ®Øª Ù…Ù„ÙƒÙŠ", cost:80000, cat:"pro", icon:"fas fa-ship", proOnly: true, xp: 45000},
    {id: 64, name:"ØµØ§Ø±ÙˆØ® ÙØ¶Ø§Ø¦ÙŠ", cost:500000, cat:"pro", icon:"fas fa-rocket", proOnly: true, xp: 250000},
    {id: 65, name:"Ø¨Ø±Ø¬ Ø°Ù‡Ø¨ÙŠ", cost:30000, cat:"pro", icon:"fas fa-archway", proOnly: true, xp: 15000},
    {id: 66, name:"Ø·Ø§Ø¦Ø±Ø© Ø®Ø§ØµØ©", cost:120000, cat:"pro", icon:"fas fa-plane", proOnly: true, xp: 70000},
    {id: 67, name:"Ù…ÙŠØ¯Ø§Ù„ÙŠØ© VIP", cost:2000, cat:"pro", icon:"fas fa-award", proOnly: true, xp: 1000},
    {id: 68, name:"Ø³Ø§Ø¹Ø© Ø§Ù„Ù…Ø§Ø³", cost:9000, cat:"pro", icon:"fas fa-clock", proOnly: true, xp: 5000},
    {id: 69, name:"Ø¬Ø§Ø¦Ø²Ø© Ù†ÙˆØ¨Ù„", cost:15000, cat:"pro", icon:"fas fa-trophy", proOnly: true, xp: 8000},
    {id: 70, name:"Ø¯Ø±Ø¹ Ø§Ù„ÙƒØ±ÙŠØ³ØªØ§Ù„", cost:6000, cat:"pro", icon:"fas fa-shield-cat", proOnly: true, xp: 3000},
    {id: 71, name:"Ù…ÙØªØ§Ø­ Ø§Ù„Ø¬Ù†Ø©", cost:40000, cat:"pro", icon:"fas fa-key", proOnly: true, xp: 20000},
    {id: 72, name:"Ù‚Ù„Ø§Ø¯Ø© Ø§Ù„Ù†ÙˆØ±", cost:3500, cat:"pro", icon:"fas fa-circle-notch", proOnly: true, xp: 1500},

    // --- Ø´Ø§Ø±Ø§Øª ---
    {id: 100, name:"Ø§Ù„Ø£Ø³Ø·ÙˆØ±Ø©", cost:20000, cat:"badges", icon:"fas fa-shield-halved", isBadge: true},
    {id: 101, name:"Ø§Ù„ØªÙ†ÙŠÙ†", cost:15000, cat:"badges", icon:"fas fa-dragon", isBadge: true},
    {id: 102, name:"Ø§Ù„Ù…Ø­Ø§Ø±Ø¨", cost:10000, cat:"badges", icon:"fas fa-hand-fist", isBadge: true},

    // --- Ù‡Ø¯Ø§ÙŠØ§ Ø¹Ø§Ù…Ø© (35 Ù‡Ø¯ÙŠØ©) ---
    {id: 1, name:"ÙˆØ±Ø¯Ø©", cost:20, cat:"all", icon:"ğŸŒ¹", xp: 10},
    {id: 2, name:"Ù‚Ù„Ø¨", cost:50, cat:"all", icon:"â¤ï¸", xp: 30},
    {id: 3, name:"Ø´ÙˆÙƒÙˆÙ„Ø§ØªØ©", cost:100, cat:"all", icon:"ğŸ«", xp: 60},
    {id: 4, name:"Ø¨ÙŠØªØ²Ø§", cost:250, cat:"all", icon:"ğŸ•", xp: 150},
    {id: 5, name:"Ø¯Ø¨ Ù„Ø¹Ø¨Ø©", cost:400, cat:"all", icon:"ğŸ§¸", xp: 200},
    {id: 6, name:"Ø¹Ø·Ø± ÙØ§Ø®Ø±", cost:1200, cat:"all", icon:"ğŸ§´", xp: 700},
    {id: 7, name:"Ù„Ø§Ø¨ØªÙˆØ¨", cost:5000, cat:"all", icon:"ğŸ’»", xp: 2500},
    {id: 8, name:"Ù‡Ø§ØªÙ", cost:3000, cat:"all", icon:"ğŸ“±", xp: 1500},
    {id: 9, name:"Ù†Ø¸Ø§Ø±Ø©", cost:600, cat:"all", icon:"ğŸ•¶ï¸", xp: 300},
    {id: 10, name:"Ø³Ø§Ø¹Ø©", cost:1500, cat:"all", icon:"âŒš", xp: 800},
    {id: 11, name:"Ø³ÙŠØ§Ø±Ø©", cost:20000, cat:"all", icon:"ğŸš—", xp: 10000},
    {id: 12, name:"Ù…Ù†Ø²Ù„", cost:100000, cat:"all", icon:"ğŸ ", xp: 60000},
    {id: 13, name:"Ø¨ÙŠØ§Ù†Ùˆ", cost:8000, cat:"all", icon:"ğŸ¹", xp: 4500},
    {id: 14, name:"ÙƒØ§Ù…ÙŠØ±Ø§", cost:2500, cat:"all", icon:"ğŸ“·", xp: 1200},
    {id: 15, name:"ØºÙŠØªØ§Ø±", cost:1800, cat:"all", icon:"ğŸ¸", xp: 900},
    {id: 16, name:"Ù‚Ù‡ÙˆØ©", cost:15, cat:"all", icon:"â˜•", xp: 5},
    {id: 17, name:"Ø§ÙŠØ³ ÙƒØ±ÙŠÙ…", cost:30, cat:"all", icon:"ğŸ¦", xp: 15},
    {id: 18, name:"ÙƒØ¹ÙƒØ©", cost:200, cat:"all", icon:"ğŸ‚", xp: 100},
    {id: 19, name:"Ø¨Ø§Ù„ÙˆÙ†", cost:10, cat:"all", icon:"ğŸˆ", xp: 5},
    {id: 20, name:"ØªØ°ÙƒØ±Ø© Ø³ÙØ±", cost:3500, cat:"all", icon:"âœˆï¸", xp: 2000},
    {id: 21, name:"Ø¯Ø±Ø§Ø¬Ø©", cost:1200, cat:"all", icon:"ğŸš²", xp: 600},
    {id: 22, name:"ÙƒØ±Ø© Ù‚Ø¯Ù…", cost:150, cat:"all", icon:"âš½", xp: 80},
    {id: 23, name:"Ø±ÙˆØ¨ÙˆØª", cost:4500, cat:"all", icon:"ğŸ¤–", xp: 2200},
    {id: 24, name:"ØªÙ„Ø³ÙƒÙˆØ¨", cost:3200, cat:"all", icon:"ğŸ”­", xp: 1800}
];

async function initGiftPage() {
    firebase.auth().onAuthStateChanged(async user => {
        if(!user) return;
        selectedPlayerUid = user.uid;
        const doc = await firebase.firestore().collection('users').doc(user.uid).get();
        currentUserData = doc.data() || {};
        document.getElementById("user-coins").innerText = (currentUserData.totalCoins || 0).toLocaleString();
        renderGifts('all');
        setupSearch();
    });
}

function renderGifts(filter) {
    const container = document.getElementById("gifts-container");
    container.innerHTML = '';
    
    gifts.forEach(g => {
        if(filter !== 'all' && g.cat !== filter) return;
        
        const div = document.createElement("div");
        div.className = "gift-item";
        let iconContent = g.icon.startsWith('fas') ? `<i class="${g.icon} ${g.isBadge ? 'badge-icon' : 'tool-icon'}"></i>` : `<span>${g.icon}</span>`;
        
        div.innerHTML = `
            ${g.proOnly ? '<span class="pro-exclusive-tag">PRO</span>' : ''}
            <div class="gift-icon-container">${iconContent}</div>
            <div class="gift-name">${g.name}</div>
            <div class="gift-price">${g.cost.toLocaleString()}</div>
            <div class="qty-controls">
                <button class="qty-btn" onclick="changeQty(${g.id}, 1)">+</button>
                <span id="qty-${g.id}">${cart[g.id] || 0}</span>
                <button class="qty-btn" onclick="changeQty(${g.id}, -1)">-</button>
            </div>
        `;
        container.appendChild(div);
    });
}

function setupSearch() {
    const input = document.getElementById('player-search');
    const results = document.getElementById('search-results');

    input.addEventListener('input', async () => {
        const val = input.value.trim();
        if(val.length < 2) { results.style.display = 'none'; return; }

        const snap = await firebase.firestore().collection('users')
            .where('displayName', '>=', val)
            .where('displayName', '<=', val + '\uf8ff')
            .limit(5).get();

        results.innerHTML = '';
        if(snap.empty) {
            results.innerHTML = '<div class="search-item">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
        } else {
            snap.forEach(doc => {
                const data = doc.data();
                const div = document.createElement('div');
                div.className = 'search-item';
                div.innerHTML = `${data.displayName} (ID: ${doc.id.substring(0,6)})`;
                div.onclick = () => {
                    selectedPlayerUid = doc.id;
                    document.getElementById('rec-name').innerText = data.displayName;
                    results.style.display = 'none';
                    input.value = '';
                };
                results.appendChild(div);
            });
        }
        results.style.display = 'block';
    });
}

function changeQty(id, delta) {
    const gift = gifts.find(g => g.id === id);
    const isPro = (currentUserData.proExpiryTime || 0) > Date.now();
    
    if(gift.proOnly && !isPro) {
        alert("Ø­ØµØ±ÙŠ Ù„Ø£Ø¹Ø¶Ø§Ø¡ PRO!");
        return;
    }

    cart[id] = Math.max(0, (cart[id] || 0) + delta);
    if(gift.isBadge || gift.isTool) cart[id] = Math.min(cart[id], 1);

    document.getElementById(`qty-${id}`).innerText = cart[id];
    updateTotal();
}

function updateTotal() {
    let total = 0;
    for(let id in cart) {
        const gift = gifts.find(g => g.id == id);
        total += gift.cost * cart[id];
    }
    document.getElementById("total-cost").innerText = total.toLocaleString();
    document.getElementById("send-btn").disabled = total === 0 || total > currentUserData.totalCoins;
}

function filterGifts(cat, el) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    renderGifts(cat);
}

async function processPurchase() {
    document.getElementById("purchase-overlay").style.display = "flex";
    const db = firebase.firestore();
    const batch = db.batch();
    const myRef = db.collection('users').doc(firebase.auth().currentUser.uid);
    const targetRef = db.collection('users').doc(selectedPlayerUid);

    let totalCost = 0;
    for(let id in cart) {
        if(cart[id] > 0) {
            const gift = gifts.find(g => g.id == id);
            totalCost += gift.cost * cart[id];
            if(gift.isBadge) batch.update(targetRef, { badges: firebase.firestore.FieldValue.arrayUnion(gift.icon) });
            else if(gift.isTool) batch.update(targetRef, { inventory: firebase.firestore.FieldValue.arrayUnion(gift.name) });
            else batch.update(targetRef, { xp: firebase.firestore.FieldValue.increment(gift.xp * cart[id]) });
        }
    }

    try {
        batch.update(myRef, { totalCoins: firebase.firestore.FieldValue.increment(-totalCost) });
        await batch.commit();
        alert("ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!");
        location.reload();
    } catch(e) {
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£!");
    } finally {
        document.getElementById("purchase-overlay").style.display = "none";
    }
}
</script>
</body>
</html>

