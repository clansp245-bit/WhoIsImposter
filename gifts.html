<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’ Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„Ù…Ù„ÙƒÙŠ Ø§Ù„Ø£Ø³Ø·ÙˆØ±ÙŠ</title>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="auth.js"></script> 

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        :root {
            --primary: #6366f1;
            --accent-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            --bg-body: #0a0f1e;
            --card-bg: rgba(30, 41, 59, 0.7);
            --text-main: #f1f5f9;
            --text-dim: #94a3b8;
            --gold: #ffd700;
            --pro-color: #f472b6;
            --tool-color: #38bdf8;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-body);
            background-image: radial-gradient(circle at top right, #1e1b4b, transparent);
            color: var(--text-main);
            padding: 10px; margin: 0;
            display: flex; flex-direction: column; align-items: center;
        }

        .top-info-bar { width: 100%; max-width: 500px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        #coins-display { background: rgba(251, 191, 36, 0.1); padding: 8px 15px; border-radius: 15px; color: var(--gold); font-weight: 900; border: 1px solid var(--gold); }

        .card {
            background: var(--card-bg); backdrop-filter: blur(15px); padding: 15px; border-radius: 20px;
            width: 100%; max-width: 500px; border: 1px solid rgba(255,255,255,0.1); box-sizing: border-box; margin-bottom: 12px;
        }

        /* Tabs */
        .tabs { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; width: 100%; max-width: 500px; scrollbar-width: none; }
        .tab { padding: 8px 15px; background: rgba(255,255,255,0.05); border-radius: 20px; cursor: pointer; white-space: nowrap; font-weight: 700; font-size: 0.8rem; }
        .tab.active { background: var(--primary); color: white; }

        /* Gifts Grid */
        .gifts-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; width: 100%; }
        .gift-item { 
            background: rgba(255, 255, 255, 0.03); padding: 15px 5px; border-radius: 18px; border: 1px solid rgba(255,255,255,0.05);
            display: flex; flex-direction: column; align-items: center; text-align: center; position: relative;
        }
        
        .gift-icon-container { 
            width: 65px; height: 65px; border-radius: 20px; background: rgba(255,255,255,0.05);
            display: flex; justify-content: center; align-items: center; font-size: 2rem; margin-bottom: 10px;
        }

        /* ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª */
        .badge-icon { color: var(--gold); text-shadow: 0 0 10px rgba(255,215,0,0.3); }
        .tool-icon { color: var(--tool-color); }
        .pro-exclusive-tag { 
            position: absolute; top: 5px; left: 5px; background: var(--pro-color); 
            color: white; font-size: 0.6rem; padding: 2px 6px; border-radius: 5px; font-weight: 900;
        }

        .gift-name { font-weight: 900; font-size: 0.9rem; color: #fff; }
        .gift-price { color: var(--gold); font-weight: 900; font-size: 0.85rem; margin-top: 5px; }

        .qty-controls { display: flex; align-items: center; gap: 12px; margin-top: 10px; }
        .qty-btn { width: 28px; height: 28px; border: none; background: var(--primary); color: white; border-radius: 8px; cursor: pointer; font-weight: 900; }

        .send-btn { width: 100%; padding: 15px; border-radius: 15px; border: none; background: var(--accent-gradient); color: white; font-weight: 900; cursor: pointer; margin-top: 15px; }
        .send-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        #purchase-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; display: none; flex-direction: column; justify-content: center; align-items: center; }
    </style>
</head>

<body onload="initGiftPage()">

<div class="top-info-bar">
    <a href="index.html" style="color: var(--text-dim); text-decoration: none;"><i class="fas fa-chevron-right"></i></a>
    <div id="coins-display"><i class="fas fa-coins"></i> <span id="user-coins">0</span></div>
</div>

<h2 style="font-weight: 900; color: #fff;">ğŸ’ Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„Ù…Ù„ÙƒÙŠ</h2>

<div class="card">
    <input type="text" id="player-search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† ØµØ¯ÙŠÙ‚ Ø¨Ø§Ù„Ø§Ø³Ù…..." style="width: 100%; padding: 12px; border-radius: 10px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: white; font-family: 'Cairo';">
    <div id="rec-info" style="margin-top: 10px; font-size: 0.8rem; color: var(--primary); font-weight: bold;">Ø§Ù„Ù…Ø³ØªÙ„Ù…: <span id="rec-name">Ù†ÙØ³ÙŠ</span></div>
</div>

<div class="tabs">
    <div class="tab active" onclick="filterGifts('all', this)">Ø§Ù„ÙƒÙ„</div>
    <div class="tab" onclick="filterGifts('tools', this)">Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø£Ø¯ÙˆØ§Øª</div>
    <div class="tab" onclick="filterGifts('badges', this)">Ø´Ø§Ø±Ø§Øª</div>
    <div class="tab" onclick="filterGifts('pro', this)">Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ø¨Ø±Ùˆ ğŸ”¥</div>
</div>

<div class="card">
    <div id="gifts-container" class="gifts-grid"></div>
    <div style="text-align: center; margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;">
        <span style="color: var(--text-dim)">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span>
        <span id="total-cost" style="color: var(--gold); font-weight: 900; font-size: 1.2rem;">0</span>
    </div>
    <button class="send-btn" id="send-btn" disabled onclick="processPurchase()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø´Ø±Ø§Ø¡</button>
</div>

<div id="purchase-overlay">
    <i class="fas fa-spinner fa-spin" style="font-size: 3rem; color: var(--primary);"></i>
    <p>Ø¬Ø§Ø±ÙŠ ØªÙ†ÙÙŠØ° Ø§Ù„Ø·Ù„Ø¨...</p>
</div>

<script>
let currentUserData = {};
let selectedPlayerUid = null;
let cart = {};

const gifts = [
    // --- Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø£Ø¯ÙˆØ§Øª (Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©) ---
    {id: 50, name:"Ø¨Ø·Ø§Ù‚Ø© ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…", cost:500, cat:"tools", icon:"fas fa-id-card", isTool: true},
    {id: 51, name:"Ø¨Ø·Ø§Ù‚Ø© ØªØºÙŠÙŠØ± ID", cost:1000000, cat:"tools", icon:"fas fa-fingerprint", isTool: true},

    // --- Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ø¨Ø±Ùˆ Ø§Ù„Ø­ØµØ±ÙŠØ© ---
    {id: 60, name:"Ø§Ù„ØªØ§Ø¬ Ø§Ù„Ù…Ù„ÙƒÙŠ", cost:5000, cat:"pro", icon:"fas fa-crown", proOnly: true, xp: 2000},
    {id: 61, name:"Ø³ÙŠØ§Ø±Ø© Ø°Ù‡Ø¨ÙŠØ©", cost:15000, cat:"pro", icon:"fas fa-car-side", proOnly: true, xp: 7000},
    {id: 62, name:"Ø®Ø§ØªÙ… Ø§Ù„Ø£Ù„Ù…Ø§Ø³", cost:3000, cat:"pro", icon:"fas fa-ring", proOnly: true, xp: 1200},

    // --- Ø§Ù„Ø´Ø§Ø±Ø§Øª (Badges) ---
    {id: 100, name:"Ø§Ù„Ø£Ø³Ø·ÙˆØ±Ø©", cost:10000, cat:"badges", icon:"fas fa-shield-halved", isBadge: true},
    {id: 101, name:"Ø§Ù„ØªÙ†ÙŠÙ†", cost:7000, cat:"badges", icon:"fas fa-dragon", isBadge: true},
    {id: 102, name:"Ø§Ù„Ù…Ø­Ø§Ø±Ø¨", cost:5000, cat:"badges", icon:"fas fa-hand-fist", isBadge: true},

    // --- Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© ---
    {id: 1, name:"ÙˆØ±Ø¯Ø©", cost:50, cat:"all", icon:"ğŸŒ¹", xp: 20},
    {id: 2, name:"Ù‚Ù„Ø¨", cost:100, cat:"all", icon:"â¤ï¸", xp: 50},
    {id: 7, name:"Ù„Ø§Ø¨ØªÙˆØ¨", cost:3000, cat:"all", icon:"ğŸ’»", xp: 1500}
];

async function initGiftPage() {
    firebase.auth().onAuthStateChanged(async user => {
        if(!user) return;
        selectedPlayerUid = user.uid;
        const doc = await firebase.firestore().collection('users').doc(user.uid).get();
        currentUserData = doc.data();
        document.getElementById("user-coins").innerText = currentUserData.totalCoins.toLocaleString();
        renderGifts('all');
    });
}

function renderGifts(filter) {
    const container = document.getElementById("gifts-container");
    container.innerHTML = '';
    
    gifts.forEach(g => {
        if(filter !== 'all' && g.cat !== filter) return;
        
        const isPro = (currentUserData.proExpiryTime || 0) > Date.now();
        const div = document.createElement("div");
        div.className = "gift-item";
        
        let iconContent = g.icon.startsWith('fas') ? `<i class="${g.icon} ${g.isBadge ? 'badge-icon' : 'tool-icon'}"></i>` : `<span>${g.icon}</span>`;
        
        div.innerHTML = `
            ${g.proOnly ? '<span class="pro-exclusive-tag">PRO ÙÙ‚Ø·</span>' : ''}
            <div class="gift-icon-container">${iconContent}</div>
            <div class="gift-name">${g.name}</div>
            <div class="gift-price">${g.cost.toLocaleString()} ÙƒÙˆÙŠÙ†Ø²</div>
            <div class="qty-controls">
                <button class="qty-btn" onclick="changeQty(${g.id}, 1)">+</button>
                <span id="qty-${g.id}">${cart[g.id] || 0}</span>
                <button class="qty-btn" onclick="changeQty(${g.id}, -1)">-</button>
            </div>
        `;
        container.appendChild(div);
    });
}

function changeQty(id, delta) {
    const gift = gifts.find(g => g.id === id);
    const isPro = (currentUserData.proExpiryTime || 0) > Date.now();
    
    // Ø´Ø±Ø· Ø§Ù„Ø¨Ø±Ùˆ
    if(gift.proOnly && !isPro) {
        alert("Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ± Ø­ØµØ±ÙŠ Ù„Ø£Ø¹Ø¶Ø§Ø¡ PRO ÙÙ‚Ø·!");
        return;
    }

    cart[id] = Math.max(0, (cart[id] || 0) + delta);
    if(gift.isBadge || gift.isTool) cart[id] = Math.min(cart[id], 1); // Ù‚Ø·Ø¹Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· Ù…Ù† Ø§Ù„Ø£Ø¯ÙˆØ§Øª ÙˆØ§Ù„Ø´Ø§Ø±Ø§Øª

    document.getElementById(`qty-${id}`).innerText = cart[id];
    updateTotal();
}

function updateTotal() {
    let total = 0;
    for(let id in cart) {
        const gift = gifts.find(g => g.id == id);
        total += gift.cost * cart[id];
    }
    document.getElementById("total-cost").innerText = total.toLocaleString();
    document.getElementById("send-btn").disabled = total === 0 || total > currentUserData.totalCoins;
}

function filterGifts(cat, el) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    renderGifts(cat);
}

async function processPurchase() {
    document.getElementById("purchase-overlay").style.display = "flex";
    const db = firebase.firestore();
    const batch = db.batch();
    const myRef = db.collection('users').doc(firebase.auth().currentUser.uid);
    const targetRef = db.collection('users').doc(selectedPlayerUid);

    let totalCost = 0;
    let itemsToGive = [];

    for(let id in cart) {
        if(cart[id] > 0) {
            const gift = gifts.find(g => g.id == id);
            totalCost += gift.cost * cart[id];
            itemsToGive.push({ ...gift, count: cart[id] });
        }
    }

    try {
        // Ø®ØµÙ… Ø§Ù„ÙƒÙˆÙŠÙ†Ø²
        batch.update(myRef, { totalCoins: firebase.firestore.FieldValue.increment(-totalCost) });

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø£Ùˆ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ù„Ù„Ù…Ø³ØªÙ„Ù…
        itemsToGive.forEach(item => {
            if(item.isBadge) {
                batch.update(targetRef, { badges: firebase.firestore.FieldValue.arrayUnion(item.icon) });
            } else if(item.isTool) {
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ø£Ø¯ÙˆØ§Øª (inventory)
                batch.update(targetRef, { inventory: firebase.firestore.FieldValue.arrayUnion(item.name) });
            } else {
                // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù€ XP Ù„Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
                batch.update(targetRef, { xp: firebase.firestore.FieldValue.increment(item.xp * item.count) });
            }
        });

        await batch.commit();
        alert("ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­! ØªÙÙ‚Ø¯ Ù…Ù„ÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠ.");
        location.href = "profile.html";
    } catch(e) {
        console.error(e);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø´Ø±Ø§Ø¡");
    } finally {
        document.getElementById("purchase-overlay").style.display = "none";
    }
}
</script>
</body>
</html>

