<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’ Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„Ù…Ù„ÙƒÙŠ Ø§Ù„Ø£Ø³Ø·ÙˆØ±ÙŠ</title>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="auth.js"></script> 

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        :root {
            --primary: #6366f1;
            --accent-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            --bg-body: #0a0f1e;
            --card-bg: rgba(30, 41, 59, 0.7);
            --text-main: #f1f5f9;
            --text-dim: #94a3b8;
            --gold: #ffd700;
            --pro-color: #f472b6;
            --tool-color: #38bdf8;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-body);
            background-image: radial-gradient(circle at top right, #1e1b4b, transparent);
            color: var(--text-main);
            padding: 10px; margin: 0;
            display: flex; flex-direction: column; align-items: center;
        }

        .top-info-bar { width: 100%; max-width: 500px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        #coins-display { background: rgba(251, 191, 36, 0.2); padding: 8px 15px; border-radius: 15px; color: var(--gold); font-weight: 900; border: 1px solid var(--gold); }

        .card {
            background: var(--card-bg); backdrop-filter: blur(15px); padding: 15px; border-radius: 20px;
            width: 100%; max-width: 500px; border: 1px solid rgba(255,255,255,0.1); box-sizing: border-box; margin-bottom: 12px;
            position: relative;
        }

        .search-box-container { position: relative; width: 100%; }
        #player-search {
            width: 100%; padding: 12px; border-radius: 12px; 
            background: rgba(15, 23, 42, 0.9); border: 1px solid var(--primary); 
            color: white; font-family: 'Cairo'; box-sizing: border-box; outline: none;
        }
        .search-results-list {
            position: absolute; top: 55px; left: 0; right: 0; 
            background: #1e293b; border-radius: 12px; z-index: 999;
            max-height: 200px; overflow-y: auto; border: 1px solid var(--primary);
            display: none; box-shadow: 0 10px 25px rgba(0,0,0,0.8);
        }
        .search-item {
            padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05);
            cursor: pointer; display: flex; justify-content: space-between; align-items: center;
        }
        .search-item:hover { background: var(--primary); }

        .tabs { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; width: 100%; max-width: 500px; scrollbar-width: none; padding: 5px 0; }
        .tab { padding: 8px 18px; background: rgba(255,255,255,0.05); border-radius: 20px; cursor: pointer; white-space: nowrap; font-size: 0.8rem; font-weight: bold; transition: 0.3s; }
        .tab.active { background: var(--primary); color: white; transform: scale(1.05); }

        .gifts-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; width: 100%; }
        .gift-item { 
            background: rgba(255, 255, 255, 0.03); padding: 15px 5px; border-radius: 18px; border: 1px solid rgba(255,255,255,0.05);
            display: flex; flex-direction: column; align-items: center; text-align: center; position: relative;
        }
        
        .gift-icon-container { width: 55px; height: 55px; font-size: 1.8rem; display: flex; align-items: center; justify-content: center; margin-bottom: 8px; background: rgba(255,255,255,0.05); border-radius: 15px;}
        .pro-exclusive-tag { position: absolute; top: 8px; right: 8px; background: var(--pro-color); color: white; font-size: 0.55rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; }

        .qty-controls { display: flex; align-items: center; gap: 12px; margin-top: 10px; background: rgba(0,0,0,0.3); padding: 4px 10px; border-radius: 8px; }
        .qty-btn { background: var(--primary); border: none; color: white; width: 24px; height: 24px; border-radius: 4px; cursor: pointer; font-weight: bold; }

        .send-btn { width: 100%; padding: 15px; border-radius: 15px; border: none; background: var(--accent-gradient); color: white; font-weight: 900; cursor: pointer; margin-top: 10px; transition: 0.3s; }
        .send-btn:disabled { opacity: 0.3; filter: grayscale(1); }

        #purchase-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: none; flex-direction: column; justify-content: center; align-items: center; }
    </style>
</head>

<body>

<div class="top-info-bar">
    <a href="index.html" style="color: var(--text-dim); text-decoration: none;"><i class="fas fa-chevron-right"></i> Ø±Ø¬ÙˆØ¹</a>
    <div id="coins-display"><i class="fas fa-coins"></i> <span id="user-coins">ØªØ­Ù…ÙŠÙ„...</span></div>
</div>

<div class="card">
    <div class="search-box-container">
        <input type="text" id="player-search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù€ ID...">
        <div id="search-results" class="search-results-list"></div>
    </div>
    <div id="rec-info" style="margin-top: 10px; font-size: 0.85rem; color: var(--tool-color);">
        Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰: <span id="rec-name" style="color: #fff; font-weight: bold;">Ù†ÙØ³ÙŠ (Ø£Ù†Øª)</span>
    </div>
</div>

<div class="tabs">
    <div class="tab active" onclick="filterGifts('all', this)">ğŸ Ø§Ù„ÙƒÙ„</div>
    <div class="tab" onclick="filterGifts('tools', this)">ğŸ› ï¸ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</div>
    <div class="tab" onclick="filterGifts('pro', this)">ğŸ”¥ Ø¨Ø±Ùˆ</div>
    <div class="tab" onclick="filterGifts('badges', this)">ğŸ… Ø´Ø§Ø±Ø§Øª</div>
    <div class="tab" onclick="filterGifts('luxury', this)">ğŸ’ Ù…Ù„ÙƒÙŠ</div>
    <div class="tab" onclick="filterGifts('cheap', this)">ğŸˆ Ø¨Ø³ÙŠØ·Ø©</div>
</div>

<div class="card">
    <div id="gifts-container" class="gifts-grid"></div>
    <div style="margin-top: 20px; text-align: center; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
        <div id="total-cost" style="font-size: 1.5rem; color: var(--gold); font-weight: 900; margin-bottom: 5px;">0</div>
        <button class="send-btn" id="send-btn" disabled onclick="processPurchase()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø´Ø±Ø§Ø¡ ÙˆØ§Ù„Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
</div>

<div id="purchase-overlay">
    <i class="fas fa-circle-notch fa-spin" style="font-size: 3rem; color: var(--primary);"></i>
    <p style="margin-top:15px">Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨...</p>
</div>

<script>
const db = firebase.firestore();
let currentUserData = {};
let selectedPlayerUid = null;
let cart = {};

// --- Ø§Ù„Ø¯Ø§ØªØ§ Ø§Ù„Ø¶Ø®Ù…Ø© (50+ Ù‡Ø¯ÙŠØ©) ---
const gifts = [
    // Ø¨Ø·Ø§Ù‚Ø§Øª
    {id: 50, name:"ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…", cost:1000, cat:"tools", icon:"fas fa-id-card", isTool: true},
    {id: 51, name:"ØªØºÙŠÙŠØ± Ø§Ù„Ù€ ID", cost:2000000, cat:"tools", icon:"fas fa-fingerprint", isTool: true},
    // Ø´Ø§Ø±Ø§Øª
    {id: 100, name:"Ø§Ù„Ø£Ø³Ø·ÙˆØ±Ø©", cost:50000, cat:"badges", icon:"fas fa-shield-halved", isBadge: true},
    {id: 101, name:"Ø§Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±", cost:40000, cat:"badges", icon:"fas fa-crown", isBadge: true},
    {id: 102, name:"Ø§Ù„ØªÙ†ÙŠÙ†", cost:30000, cat:"badges", icon:"fas fa-dragon", isBadge: true},
    // Ø¨Ø±Ùˆ (10 Ù‡Ø¯Ø§ÙŠØ§ Ø¥Ø¶Ø§ÙÙŠØ©)
    {id: 60, name:"Ù„Ø§Ù…Ø¨ÙˆØ±ØºÙŠÙ†ÙŠ Ø¨Ø±Ùˆ", cost:50000, cat:"pro", icon:"fas fa-car-side", proOnly: true, xp: 25000},
    {id: 61, name:"ÙŠØ®Øª Ø§Ù„Ø¨Ø±Ùˆ", cost:100000, cat:"pro", icon:"fas fa-ship", proOnly: true, xp: 60000},
    {id: 62, name:"ØµØ§Ø±ÙˆØ® ÙØ¶Ø§Ø¦ÙŠ", cost:500000, cat:"pro", icon:"fas fa-rocket", proOnly: true, xp: 300000},
    {id: 63, name:"Ø®Ø§ØªÙ… Ø§Ù„Ù…Ø§Ø³", cost:10000, cat:"pro", icon:"fas fa-ring", proOnly: true, xp: 5000},
    {id: 64, name:"ØªØ°ÙƒØ±Ø© VIP", cost:5000, cat:"pro", icon:"fas fa-ticket-alt", proOnly: true, xp: 2000},
    {id: 65, name:"Ø¨Ø±Ø¬ Ø°Ù‡Ø¨ÙŠ", cost:80000, cat:"pro", icon:"fas fa-archway", proOnly: true, xp: 45000},
    {id: 66, name:"Ø·Ø§Ø¦Ø±Ø© Ø¯Ø±ÙˆÙ† Ø¨Ø±Ùˆ", cost:15000, cat:"pro", icon:"fas fa-helicopter", proOnly: true, xp: 8000},
    {id: 67, name:"Ø³Ø§Ø¹Ø© Ø§Ù„Ù…Ø§Ø³", cost:12000, cat:"pro", icon:"fas fa-clock", proOnly: true, xp: 6500},
    {id: 68, name:"ØªØ§Ø¬ Ø§Ù„Ù…Ù„Ùƒ", cost:25000, cat:"pro", icon:"fas fa-crown", proOnly: true, xp: 12000},
    {id: 69, name:"Ø¬Ø§Ø¦Ø²Ø© Ø§Ù„Ø£ÙˆØ³ÙƒØ§Ø±", cost:35000, cat:"pro", icon:"fas fa-trophy", proOnly: true, xp: 18000},
    // Ù…Ù„ÙƒÙŠ
    {id: 200, name:"Ù‚ØµØ± Ù…Ù„ÙƒÙŠ", cost:250000, cat:"luxury", icon:"ğŸ°", xp: 150000},
    {id: 201, name:"Ø¬Ø²ÙŠØ±Ø© Ø®Ø§ØµØ©", cost:600000, cat:"luxury", icon:"ğŸï¸", xp: 400000},
    {id: 202, name:"Ø·Ø§Ø¦Ø±Ø© Ø®Ø§ØµØ©", cost:150000, cat:"luxury", icon:"âœˆï¸", xp: 90000},
    {id: 203, name:"ØµÙ†Ø¯ÙˆÙ‚ ÙƒÙ†ÙˆØ²", cost:20000, cat:"luxury", icon:"ğŸ’°", xp: 10000},
    {id: 204, name:"Ø­ØµØ§Ù† Ø£ØµÙŠÙ„", cost:12000, cat:"luxury", icon:"ğŸ", xp: 6000},
    {id: 205, name:"ØªÙ…Ø«Ø§Ù„ Ø°Ù‡Ø¨", cost:45000, cat:"luxury", icon:"ğŸ—¿", xp: 22000},
    // Ø±Ø®ÙŠØµØ© ÙˆØ¨Ø³ÙŠØ·Ø© (Ø£ÙƒØ«Ø± Ù…Ù† 25 Ù‡Ø¯ÙŠØ©)
    {id: 1, name:"ÙˆØ±Ø¯Ø©", cost:20, cat:"cheap", icon:"ğŸŒ¹", xp: 10},
    {id: 2, name:"Ù‚Ù„Ø¨", cost:50, cat:"cheap", icon:"â¤ï¸", xp: 25},
    {id: 3, name:"Ø¨ÙŠØªØ²Ø§", cost:100, cat:"cheap", icon:"ğŸ•", xp: 50},
    {id: 4, name:"Ø¯ÙˆÙ†Ø§Øª", cost:30, cat:"cheap", icon:"ğŸ©", xp: 15},
    {id: 5, name:"Ø¨Ø§Ù„ÙˆÙ†", cost:15, cat:"cheap", icon:"ğŸˆ", xp: 5},
    {id: 6, name:"Ù‚Ù‡ÙˆØ©", cost:25, cat:"cheap", icon:"â˜•", xp: 10},
    {id: 7, name:"Ø¹ØµÙŠØ±", cost:20, cat:"cheap", icon:"ğŸ¹", xp: 8},
    {id: 8, name:"Ø¢ÙŠØ³ ÙƒØ±ÙŠÙ…", cost:40, cat:"cheap", icon:"ğŸ¦", xp: 20},
    {id: 9, name:"Ù„Ø¹Ø¨Ø© Ø¯Ø¨", cost:150, cat:"cheap", icon:"ğŸ§¸", xp: 80},
    {id: 10, name:"Ù†Ø¸Ø§Ø±Ø©", cost:200, cat:"cheap", icon:"ğŸ•¶ï¸", xp: 100}
];

// ØªÙƒÙ…Ù„Ø© Ø§Ù„Ù€ 50 Ù‡Ø¯ÙŠØ© Ø¢Ù„ÙŠØ§Ù‹ ÙÙŠ ÙØ¦Ø© "Ø¨Ø³ÙŠØ·Ø©" Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¹Ø¯Ø¯
for(let i=11; i<=30; i++) {
    gifts.push({ id: 400+i, name: "Ù‡Ø¯ÙŠØ© Ù…ØªÙ†ÙˆØ¹Ø© "+i, cost: 50*i, cat: "cheap", icon: "ğŸ", xp: 25*i });
}

// --- Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ---

document.addEventListener('DOMContentLoaded', () => {
    firebase.auth().onAuthStateChanged(async user => {
        if (user) {
            selectedPlayerUid = user.uid;
            await syncUserData(user.uid);
            setupSearch();
            renderGifts('all');
        } else {
            window.location.href = "auth.html";
        }
    });
});

async function syncUserData(uid) {
    const doc = await db.collection('users').doc(uid).get();
    if (doc.exists) {
        currentUserData = doc.data();
        document.getElementById("user-coins").innerText = (currentUserData.totalCoins || 0).toLocaleString();
    }
}

function renderGifts(filter) {
    const container = document.getElementById("gifts-container");
    container.innerHTML = '';
    
    const isPro = (currentUserData.proExpiryTime || 0) > Date.now();

    const filtered = gifts.filter(g => filter === 'all' || g.cat === filter);
    
    filtered.forEach(g => {
        const div = document.createElement("div");
        div.className = "gift-item";
        let iconHtml = g.icon.includes('fa-') ? `<i class="${g.icon}"></i>` : `<span>${g.icon}</span>`;
        
        div.innerHTML = `
            ${g.proOnly ? '<span class="pro-exclusive-tag">PRO ğŸ”¥</span>' : ''}
            <div class="gift-icon-container" style="color:${g.cat==='badges'?'#ffd700':g.cat==='tools'?'#38bdf8':'#fff'}">${iconHtml}</div>
            <div style="font-size:0.85rem; font-weight:900; color:#fff">${g.name}</div>
            <div style="color:var(--gold); font-size:0.8rem; font-weight:bold;">${g.cost.toLocaleString()}</div>
            <div class="qty-controls">
                <button class="qty-btn" onclick="changeQty(${g.id}, 1)">+</button>
                <span id="qty-${g.id}" style="font-weight:bold; min-width:15px">${cart[g.id] || 0}</span>
                <button class="qty-btn" onclick="changeQty(${g.id}, -1)">-</button>
            </div>
        `;
        container.appendChild(div);
    });
}

function filterGifts(cat, el) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    renderGifts(cat);
}

function changeQty(id, delta) {
    const gift = gifts.find(g => g.id === id);
    const isPro = (currentUserData.proExpiryTime || 0) > Date.now();
    
    if(gift.proOnly && !isPro) {
        alert("Ù‡Ø°Ù‡ Ø§Ù„Ù‡Ø¯ÙŠØ© Ø­ØµØ±ÙŠØ© Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø¨Ø±Ùˆ!");
        return;
    }

    cart[id] = Math.max(0, (cart[id] || 0) + delta);
    
    // Ø§Ù„Ø´Ø§Ø±Ø§Øª ÙˆØ§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ù‚Ø·Ø¹Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
    if((gift.isBadge || gift.isTool) && cart[id] > 1) cart[id] = 1;

    const qtySpan = document.getElementById(`qty-${id}`);
    if(qtySpan) qtySpan.innerText = cart[id];
    updateTotal();
}

function updateTotal() {
    let total = 0;
    for(let id in cart) {
        const gift = gifts.find(g => g.id == id);
        total += gift.cost * cart[id];
    }
    document.getElementById("total-cost").innerText = total.toLocaleString();
    document.getElementById("send-btn").disabled = (total === 0 || total > (currentUserData.totalCoins || 0));
}

function setupSearch() {
    const input = document.getElementById('player-search');
    const resultsList = document.getElementById('search-results');

    input.addEventListener('input', async () => {
        const val = input.value.trim().toLowerCase();
        if (val.length < 2) { resultsList.style.display = 'none'; return; }

        // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Firestore Ø¨Ø§Ù„Ø§Ø³Ù…
        const snap = await db.collection('users')
            .where('displayName', '>=', val)
            .where('displayName', '<=', val + '\uf8ff')
            .limit(5).get();

        resultsList.innerHTML = '';
        if (snap.empty) {
            resultsList.innerHTML = '<div class="search-item">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù…</div>';
        } else {
            snap.forEach(doc => {
                const user = doc.data();
                const div = document.createElement('div');
                div.className = 'search-item';
                div.innerHTML = `<span>${user.displayName}</span><small style="color:var(--text-dim)">ID: ${doc.id.slice(0,6)}</small>`;
                div.onclick = () => {
                    selectedPlayerUid = doc.id;
                    document.getElementById('rec-name').innerText = user.displayName;
                    resultsList.style.display = 'none';
                    input.value = '';
                };
                resultsList.appendChild(div);
            });
        }
        resultsList.style.display = 'block';
    });
}

async function processPurchase() {
    const totalCost = parseInt(document.getElementById("total-cost").innerText.replace(/,/g, ''));
    if (totalCost > currentUserData.totalCoins) return alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ÙƒÙˆÙŠÙ†Ø² ÙƒØ§ÙÙŠØ©!");

    document.getElementById("purchase-overlay").style.display = "flex";
    
    const batch = db.batch();
    const myRef = db.collection('users').doc(firebase.auth().currentUser.uid);
    const targetRef = db.collection('users').doc(selectedPlayerUid);

    for (let id in cart) {
        if (cart[id] > 0) {
            const gift = gifts.find(g => g.id == id);
            if (gift.isBadge) {
                batch.update(targetRef, { badges: firebase.firestore.FieldValue.arrayUnion(gift.icon) });
            } else if (gift.isTool) {
                batch.update(targetRef, { inventory: firebase.firestore.FieldValue.arrayUnion(gift.name) });
            } else {
                batch.update(targetRef, { xp: firebase.firestore.FieldValue.increment(gift.xp * cart[id]) });
            }
        }
    }

    batch.update(myRef, { totalCoins: firebase.firestore.FieldValue.increment(-totalCost) });

    try {
        await batch.commit();
        alert("ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­! Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ.");
        location.reload();
    } catch (e) {
        console.error(e);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹.");
    } finally {
        document.getElementById("purchase-overlay").style.display = "none";
    }
}
</script>
</body>
</html>
