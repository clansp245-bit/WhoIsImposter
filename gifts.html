<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ Ù…ØªØ¬Ø± Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ù…Ù„ÙƒÙŠ</title>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="auth.js"></script> 

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        :root {
            --primary: #6366f1;
            --accent-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            --bg-body: #0a0f1e;
            --card-bg: rgba(30, 41, 59, 0.7);
            --text-main: #f1f5f9;
            --text-dim: #94a3b8;
            --gold: #ffd700;
            --success: #10b981;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-body);
            background-image: radial-gradient(circle at top right, #1e1b4b, transparent), radial-gradient(circle at bottom left, #1e1b4b, transparent);
            color: var(--text-main);
            padding: 15px;
            min-height: 100vh;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .top-info-bar { width: 100%; max-width: 500px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        #coins-display { background: rgba(251, 191, 36, 0.1); padding: 8px 15px; border-radius: 15px; color: var(--gold); font-weight: 900; border: 1px solid var(--gold); font-size: 0.9rem; }

        h2 { font-size: 1.8rem; font-weight: 900; margin: 5px 0; background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .card {
            background: var(--card-bg); backdrop-filter: blur(15px); padding: 15px; border-radius: 20px;
            width: 100%; max-width: 500px; border: 1px solid rgba(255,255,255,0.1); text-align: right; box-sizing: border-box; margin-bottom: 12px;
        }

        .recipient-box { display: flex; gap: 8px; margin-bottom: 10px; }
        #self-gift-btn { background: var(--primary); color: white; border: none; padding: 10px 15px; border-radius: 10px; font-weight: 700; cursor: pointer; font-size: 0.85rem; }
        
        input[type="text"] { flex-grow: 1; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255,255,255,0.1); padding: 10px; border-radius: 10px; color: white; font-family: 'Cairo'; font-size: 0.85rem; }

        .search-results { position: absolute; background: #1e293b; width: 100%; z-index: 100; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); top: 45px; }
        .search-item { padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; }

        .tabs { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; width: 100%; max-width: 500px; scrollbar-width: none; }
        .tab { padding: 6px 15px; background: rgba(255,255,255,0.05); border-radius: 20px; cursor: pointer; white-space: nowrap; font-weight: 700; font-size: 0.8rem; }
        .tab.active { background: var(--primary); color: white; }

        /* ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù€ Grid Ù„ÙŠØµØ¨Ø­ Ù…ØªØ¬Ø§ÙˆØ¨Ø§Ù‹ ÙˆÙ„Ø§ ÙŠØ®Ø±Ø¬ Ø¹Ù† Ø§Ù„Ø­ÙˆØ§Ù */
        .gifts-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 10px; 
            width: 100%;
        }

        .gift-item { 
            background: rgba(255, 255, 255, 0.03); padding: 12px 8px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.05);
            display: flex; flex-direction: column; align-items: center; text-align: center;
        }
        .gift-icon { font-size: 2rem; margin-bottom: 5px; }
        .gift-name { font-weight: 700; font-size: 0.85rem; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; }
        .gift-info { font-size: 0.7rem; color: var(--text-dim); margin-bottom: 5px; }
        .gift-price { color: var(--gold); font-weight: 900; font-size: 0.8rem; margin-bottom: 8px; }

        .qty-controls { display: flex; align-items: center; gap: 8px; background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 8px; }
        .qty-btn { width: 24px; height: 24px; border: none; background: var(--primary); color: white; border-radius: 5px; cursor: pointer; font-weight: 900; font-size: 1rem; }
        .qty-num { min-width: 15px; font-weight: 900; font-size: 0.9rem; }

        #cart-summary { background: rgba(16, 185, 129, 0.1); padding: 15px; border-radius: 15px; margin-top: 15px; border: 1px solid var(--success); font-size: 0.85rem; }
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 3px; }
        .total-price { font-size: 1.1rem; color: var(--gold); font-weight: 900; margin-top: 8px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 8px; }

        .send-btn {
            width: 100%; padding: 15px; border-radius: 15px; border: none;
            background: var(--accent-gradient); color: white; font-weight: 900;
            font-size: 1.1rem; cursor: pointer; margin-top: 15px;
        }
        .send-btn:disabled { opacity: 0.4; cursor: not-allowed; }

        #purchase-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000;
            display: none; flex-direction: column; justify-content: center; align-items: center; backdrop-filter: blur(10px);
        }
    </style>
</head>

<body onload="initGiftPage()">

<div class="top-info-bar">
    <a href="index.html" style="color: var(--text-dim); text-decoration: none; font-size: 0.9rem;"><i class="fas fa-arrow-right"></i> Ø±Ø¬ÙˆØ¹</a>
    <div id="coins-display"><i class="fas fa-coins"></i> <span id="user-coins">0</span></div>
</div>

<h2>ğŸ Ù…ØªØ¬Ø± Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ù…Ù„ÙƒÙŠ</h2>

<div class="card">
    <div class="recipient-box">
        <button id="self-gift-btn" onclick="selectSelf()">Ù„Ù†ÙØ³ÙŠ</button>
        <div style="flex-grow:1; position:relative;">
            <input type="text" id="player-search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† ØµØ¯ÙŠÙ‚ Ø¨Ø§Ù„Ø§Ø³Ù…...">
            <div id="search-results" class="search-results"></div>
        </div>
    </div>
    <div id="recipient-alert" style="text-align: center; font-weight: 700; color: var(--primary); font-size: 0.8rem;">Ø§Ù„Ù…Ø³ØªÙ„Ù…: (Ø£Ù†Øª)</div>
</div>

<div class="tabs">
    <div class="tab active" onclick="filterGifts('all', this)">Ø§Ù„ÙƒÙ„</div>
    <div class="tab" onclick="filterGifts('pro', this)">Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Pro</div>
    <div class="tab" onclick="filterGifts('xp', this)">ØªØ·ÙˆÙŠØ± Ø§Ù„Ù…Ø³ØªÙˆÙ‰</div>
    <div class="tab" onclick="filterGifts('luxury', this)">ÙØ®Ø§Ù…Ø©</div>
</div>

<div class="card" style="padding: 10px;">
    <div id="gifts-container" class="gifts-grid"></div>
    
    <div id="cart-summary">
        <div class="summary-row"><span>XP Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span> <span id="total-xp-display">0</span></div>
        <div class="summary-row"><span>Ø£ÙŠØ§Ù… Pro Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©:</span> <span id="total-pro-days">0</span></div>
        <div class="total-price summary-row"><span>Ø§Ù„ØªÙƒÙ„ÙØ©:</span> <span><span id="total-cost-display">0</span> ÙƒÙˆÙŠÙ†Ø²</span></div>
    </div>

    <button class="send-btn" id="send-gift-btn" disabled onclick="processPurchase()">ØªØ£ÙƒÙŠØ¯ ÙˆØ¥Ø±Ø³Ø§Ù„ <i class="fas fa-paper-plane"></i></button>
</div>

<div id="purchase-overlay">
    <div style="font-size: 4rem;">ğŸ</div>
    <h3 style="color: white; margin-top: 15px;">Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø¯Ø§ÙŠØ§Ùƒ...</h3>
</div>

<script>
let currentUserData = {};
let selectedPlayer = { uid: null, displayName: "Ù†ÙØ³Ùƒ" }; 
let giftCart = {}; 
let currentUserId = null;

// Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø§Ù„ØªØ§Ù… Ø¨Ø£Ø³Ø¹Ø§Ø± Ø¨Ø±Ùˆ Ø§Ù„Ø£ØµÙ„ÙŠØ©
const gifts = [
    // Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø¨Ø±Ùˆ Ø¨Ø£Ø³Ø¹Ø§Ø±Ù‡Ø§ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
    {id: 8, name:"Ø¨Ø±Ùˆ Ø£Ø³Ø¨ÙˆØ¹", cost:150, days: 7, icon:"â­", cat: 'pro'},
    {id: 9, name:"Ø¨Ø±Ùˆ Ø´Ù‡Ø±", cost:450, days: 30, icon:"ğŸ†", cat: 'pro'},
    {id: 10, name:"Ø¨Ø±Ùˆ 3 Ø£Ø´Ù‡Ø±", cost:1080, days: 90, icon:"âœ¨", cat: 'pro'},
    {id: 11, name:"Ø¨Ø±Ùˆ Ø³Ù†Ø©", cost:2414, days: 365, icon:"ğŸ‘‘", cat: 'pro'},

    // Ù‡Ø¯Ø§ÙŠØ§ XP
    {id: 0, name:"ÙˆØ±Ø¯Ø© Ø­Ù…Ø±Ø§Ø¡", cost:50, xp:15, icon:"ğŸŒ¹", cat: 'xp'},
    {id: 1, name:"Ø´ÙˆÙƒÙˆÙ„Ø§ØªØ©", cost:120, xp:40, icon:"ğŸ«", cat: 'xp'},
    {id: 4, name:"ÙƒØªØ§Ø¨ Ø§Ù„Ø­ÙƒÙ…Ø©", cost:500, xp:200, icon:"ğŸ“š", cat: 'xp'},
    {id: 5, name:"Ø­Ù‚ÙŠØ¨Ø© ÙƒÙˆÙŠÙ†Ø²", cost:1000, xp:450, icon:"ğŸ’°", cat: 'xp'},
    
    // Ù‡Ø¯Ø§ÙŠØ§ ÙØ§Ø®Ø±Ø©
    {id: 12, name:"Ø³ÙŠØ§Ø±Ø©", cost:15000, xp:7000, icon:"ğŸï¸", cat: 'luxury'},
    {id: 13, name:"ÙŠØ®Øª", cost:50000, xp:25000, icon:"ğŸ›¥ï¸", cat: 'luxury'},
    {id: 16, name:"ØµØ§Ø±ÙˆØ®", cost:1000000, xp:750000, icon:"ğŸš€", cat: 'luxury'}
];

async function initGiftPage() {
    renderGifts('all');
    firebase.auth().onAuthStateChanged(async user => {
        if(!user) return window.location.href="auth.html";
        currentUserId = user.uid; 
        const data = await loadUserData();
        if(data) {
            currentUserData = data;
            document.getElementById("user-coins").innerText = (data.totalCoins || 0).toLocaleString();
            selectSelf();
            setupSearch();
        }
    });
}

function renderGifts(filter) {
    const container = document.getElementById("gifts-container");
    container.innerHTML = '';
    const filtered = filter === 'all' ? gifts : gifts.filter(g => g.cat === filter);
    
    filtered.forEach(g => {
        const qty = giftCart[g.id] || 0;
        const div = document.createElement("div");
        div.className = "gift-item";
        div.innerHTML = `
            <div class="gift-icon">${g.icon}</div>
            <div class="gift-name">${g.name}</div>
            <div class="gift-info">${g.cat === 'pro' ? '+' + g.days + ' ÙŠÙˆÙ…' : '+' + g.xp + ' XP'}</div>
            <div class="gift-price">${g.cost.toLocaleString()}</div>
            <div class="qty-controls">
                <button class="qty-btn" onclick="updateQty(${g.id}, 1)">+</button>
                <span class="qty-num" id="qty-${g.id}">${qty}</span>
                <button class="qty-btn" onclick="updateQty(${g.id}, -1)">-</button>
            </div>
        `;
        container.appendChild(div);
    });
}

function filterGifts(cat, el) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    renderGifts(cat);
}

function updateQty(id, change) {
    let current = giftCart[id] || 0;
    let newVal = Math.max(0, current + change);
    if (newVal === 0) delete giftCart[id];
    else giftCart[id] = newVal;
    
    if(document.getElementById(`qty-${id}`)) {
        document.getElementById(`qty-${id}`).innerText = newVal;
    }
    calculateTotal();
}

function calculateTotal() {
    let cost = 0, xp = 0, days = 0;
    for (const id in giftCart) {
        const gift = gifts.find(g => g.id == id);
        cost += gift.cost * giftCart[id];
        if (gift.cat === 'pro') days += gift.days * giftCart[id];
        else xp += gift.xp * giftCart[id];
    }
    document.getElementById("total-cost-display").innerText = cost.toLocaleString();
    document.getElementById("total-xp-display").innerText = xp.toLocaleString();
    document.getElementById("total-pro-days").innerText = days;
    
    const canAfford = currentUserData.totalCoins >= cost;
    document.getElementById("send-gift-btn").disabled = cost === 0 || !canAfford;
}

function selectSelf() {
    selectedPlayer = { uid: currentUserId, displayName: "Ù†ÙØ³Ùƒ" };
    document.getElementById("recipient-alert").innerText = "Ø§Ù„Ù…Ø³ØªÙ„Ù…: Ø£Ù†Øª (ØªØ·ÙˆÙŠØ± Ø­Ø³Ø§Ø¨Ùƒ)";
}

function setupSearch() {
    const input = document.getElementById("player-search");
    const resultsDiv = document.getElementById("search-results");

    input.addEventListener("input", async () => {
        const query = input.value.trim();
        if (query.length < 2) { resultsDiv.innerHTML = ""; return; }

        const snap = await firebase.firestore().collection("users")
            .where("displayName", ">=", query).where("displayName", "<=", query + "\uf8ff")
            .limit(5).get();

        resultsDiv.innerHTML = "";
        snap.forEach(doc => {
            if (doc.id === currentUserId) return;
            const item = document.createElement("div");
            item.className = "search-item";
            item.innerText = doc.data().displayName;
            item.onclick = () => {
                selectedPlayer = { uid: doc.id, displayName: doc.data().displayName };
                document.getElementById("recipient-alert").innerText = `Ø§Ù„Ù…Ø³ØªÙ„Ù…: ${doc.data().displayName}`;
                input.value = "";
                resultsDiv.innerHTML = "";
            };
            resultsDiv.appendChild(item);
        });
    });
}

async function processPurchase() {
    const overlay = document.getElementById("purchase-overlay");
    let totalCost = 0, totalXP = 0, totalDays = 0;
    for (const id in giftCart) {
        const gift = gifts.find(g => g.id == id);
        totalCost += gift.cost * giftCart[id];
        if (gift.cat === 'pro') totalDays += gift.days * giftCart[id];
        else totalXP += gift.xp * giftCart[id];
    }

    if (currentUserData.totalCoins < totalCost) return alert("Ø§Ù„Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙ!");
    overlay.style.display = "flex";

    try {
        const db = firebase.firestore();
        const batch = db.batch();
        const senderRef = db.collection("users").doc(currentUserId);
        const recipientRef = db.collection("users").doc(selectedPlayer.uid);

        batch.update(senderRef, { totalCoins: firebase.firestore.FieldValue.increment(-totalCost) });

        let updates = {};
        if (totalXP > 0) updates.xp = firebase.firestore.FieldValue.increment(totalXP);
        if (totalDays > 0) {
            const recipientDoc = await recipientRef.get();
            const currentExpiry = recipientDoc.data().proExpiryTime || Date.now();
            const base = currentExpiry > Date.now() ? currentExpiry : Date.now();
            updates.proExpiryTime = base + (totalDays * 24 * 60 * 60 * 1000);
        }

        batch.update(recipientRef, updates);
        await batch.commit();
        setTimeout(() => location.href = "index.html", 1000);
    } catch (e) {
        alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„!");
        overlay.style.display = "none";
    }
}
</script>
</body>
</html>

