<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ Ù…ØªØ¬Ø± Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ù…Ù„ÙƒÙŠ</title>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="auth.js"></script> 

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        :root {
            --primary: #6366f1;
            --accent-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            --bg-body: #0a0f1e;
            --card-bg: rgba(30, 41, 59, 0.7);
            --text-main: #f1f5f9;
            --text-dim: #94a3b8;
            --gold: #ffd700;
            --success: #10b981;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-body);
            background-image: radial-gradient(circle at top right, #1e1b4b, transparent), radial-gradient(circle at bottom left, #1e1b4b, transparent);
            color: var(--text-main);
            padding: 20px;
            min-height: 100vh;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .top-info-bar { width: 100%; max-width: 600px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        #coins-display { background: rgba(251, 191, 36, 0.1); padding: 10px 20px; border-radius: 20px; color: var(--gold); font-weight: 900; border: 1px solid var(--gold); }

        h2 { font-size: 2.5rem; font-weight: 900; margin: 10px 0; background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .card {
            background: var(--card-bg); backdrop-filter: blur(15px); padding: 20px; border-radius: 24px;
            width: 100%; max-width: 600px; border: 1px solid rgba(255,255,255,0.1); text-align: right; box-sizing: border-box; margin-bottom: 15px;
        }

        .recipient-box { display: flex; gap: 10px; margin-bottom: 15px; }
        #self-gift-btn { background: var(--primary); color: white; border: none; padding: 12px 25px; border-radius: 12px; font-weight: 900; cursor: pointer; transition: 0.3s; }
        #self-gift-btn:hover { transform: scale(1.05); }
        input[type="text"] { flex-grow: 1; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255,255,255,0.1); padding: 12px; border-radius: 12px; color: white; font-family: 'Cairo'; }

        .search-results { position: absolute; background: #1e293b; width: 60%; z-index: 10; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); overflow: hidden; }
        .search-item { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: 0.2s; }
        .search-item:hover { background: var(--primary); }

        /* ØªØµÙ†ÙŠÙØ§Øª Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; width: 100%; max-width: 600px; }
        .tab { padding: 8px 20px; background: rgba(255,255,255,0.05); border-radius: 30px; cursor: pointer; white-space: nowrap; font-weight: 700; transition: 0.3s; }
        .tab.active { background: var(--primary); color: white; }

        .gifts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .gift-item { 
            background: rgba(255, 255, 255, 0.03); padding: 15px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.05);
            display: flex; flex-direction: column; align-items: center; text-align: center; transition: 0.3s;
        }
        .gift-item:hover { background: rgba(255,255,255,0.07); transform: translateY(-5px); }
        .gift-icon { font-size: 2.5rem; margin-bottom: 10px; }
        .gift-name { font-weight: 900; margin-bottom: 5px; }
        .gift-info { font-size: 0.8rem; color: var(--text-dim); margin-bottom: 10px; }
        .gift-price { color: var(--gold); font-weight: 900; margin-bottom: 12px; }

        .qty-controls { display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 12px; }
        .qty-btn { width: 28px; height: 28px; border: none; background: var(--primary); color: white; border-radius: 6px; cursor: pointer; font-weight: 900; }
        .qty-num { min-width: 20px; font-weight: 900; }

        #cart-summary { background: rgba(16, 185, 129, 0.1); padding: 20px; border-radius: 20px; margin-top: 20px; border: 1px solid var(--success); }
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-weight: 700; }
        .total-price { font-size: 1.5rem; color: var(--gold); font-weight: 900; margin-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px; }

        .send-btn {
            width: 100%; padding: 20px; border-radius: 20px; border: none;
            background: var(--accent-gradient); color: white; font-weight: 900;
            font-size: 1.3rem; cursor: pointer; margin-top: 20px; box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);
        }
        .send-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: scale(1) !important; }

        #purchase-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000;
            display: none; flex-direction: column; justify-content: center; align-items: center; backdrop-filter: blur(10px);
        }
    </style>
</head>

<body onload="initGiftPage()">

<div class="top-info-bar">
    <a href="index.html" style="color: var(--text-dim); text-decoration: none;"><i class="fas fa-arrow-right"></i> Ø±Ø¬ÙˆØ¹</a>
    <div id="coins-display"><i class="fas fa-coins"></i> <span id="user-coins">0</span></div>
</div>

<h2>ğŸ Ù…ØªØ¬Ø± Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ù…Ù„ÙƒÙŠ</h2>

<div class="card">
    <div class="recipient-box">
        <button id="self-gift-btn" onclick="selectSelf()">Ù„Ù†ÙØ³ÙŠ</button>
        <div style="flex-grow:1; position:relative;">
            <input type="text" id="player-search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† ØµØ¯ÙŠÙ‚ Ø¨Ø§Ù„Ø§Ø³Ù…...">
            <div id="search-results" class="search-results"></div>
        </div>
    </div>
    <div id="recipient-alert" style="text-align: center; font-weight: 900; color: var(--primary);">Ø§Ù„Ù…Ø³ØªÙ„Ù…: (Ø£Ù†Øª)</div>
</div>

<div class="tabs">
    <div class="tab active" onclick="filterGifts('all', this)">Ø§Ù„ÙƒÙ„</div>
    <div class="tab" onclick="filterGifts('cheap', this)">Ù‡Ø¯Ø§ÙŠØ§ Ø¨Ø³ÙŠØ·Ø©</div>
    <div class="tab" onclick="filterGifts('xp', this)">ØªØ·ÙˆÙŠØ± Ø§Ù„Ù…Ø³ØªÙˆÙ‰ (XP)</div>
    <div class="tab" onclick="filterGifts('pro', this)">Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Pro</div>
    <div class="tab" onclick="filterGifts('luxury', this)">Ù‡Ø¯Ø§ÙŠØ§ ÙØ§Ø®Ø±Ø©</div>
</div>

<div class="card">
    <div id="gifts-container" class="gifts-grid"></div>
    
    <div id="cart-summary">
        <div class="summary-row"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù€ XP:</span> <span id="total-xp-display">0</span></div>
        <div class="summary-row"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£ÙŠØ§Ù… Pro:</span> <span id="total-pro-days">0</span></div>
        <div class="total-price summary-row"><span>Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©:</span> <span><span id="total-cost-display">0</span> ÙƒÙˆÙŠÙ†Ø²</span></div>
    </div>

    <button class="send-btn" id="send-gift-btn" disabled onclick="processPurchase()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø´Ø±Ø§Ø¡ ÙˆØ§Ù„Ø¥Ø±Ø³Ø§Ù„ <i class="fas fa-gift"></i></button>
</div>

<div id="purchase-overlay">
    <div style="font-size: 6rem;">ğŸ</div>
    <h2 style="color: white;">Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø¯Ø§ÙŠØ§Ùƒ...</h2>
    <p style="color: var(--text-dim);">ÙŠØ±Ø¬Ù‰ Ø¹Ø¯Ù… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©</p>
</div>

<script>
let currentUserData = {};
let selectedPlayer = { uid: null, displayName: "Ù†ÙØ³Ùƒ" }; 
let giftCart = {}; 
let currentUserId = null;

const gifts = [
    // Ù‡Ø¯Ø§ÙŠØ§ Ø¨Ø³ÙŠØ·Ø©
    {id: 0, name:"ÙˆØ±Ø¯Ø© Ø­Ù…Ø±Ø§Ø¡", cost:50, xp:15, icon:"ğŸŒ¹", cat: 'cheap'},
    {id: 1, name:"Ø¹Ù„Ø¨Ø© Ø´ÙˆÙƒÙˆÙ„Ø§ØªØ©", cost:120, xp:40, icon:"ğŸ«", cat: 'cheap'},
    {id: 2, name:"ÙƒÙˆØ¨ Ù‚Ù‡ÙˆØ©", cost:80, xp:25, icon:"â˜•", cat: 'cheap'},
    {id: 3, name:"Ø¨Ø§Ù„ÙˆÙ†Ø§Øª", cost:150, xp:50, icon:"ğŸˆ", cat: 'cheap'},
    
    // Ù‡Ø¯Ø§ÙŠØ§ XP Ù…ØªÙˆØ³Ø·Ø©
    {id: 4, name:"ÙƒØªØ§Ø¨ Ø§Ù„Ø­ÙƒÙ…Ø©", cost:500, xp:200, icon:"ğŸ“š", cat: 'xp'},
    {id: 5, name:"Ø­Ù‚ÙŠØ¨Ø© Ù†Ù‚ÙˆØ¯", cost:1000, xp:450, icon:"ğŸ’°", cat: 'xp'},
    {id: 6, name:"Ø³Ø§Ø¹Ø© ÙØ¶ÙŠØ©", cost:1500, xp:700, icon:"âŒš", cat: 'xp'},
    {id: 7, name:"Ø®Ø§ØªÙ… Ø§Ù„Ù…Ø§Ø³", cost:2500, xp:1200, icon:"ğŸ’", cat: 'xp'},
    
    // Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Pro
    {id: 8, name:"Pro (3 Ø£ÙŠØ§Ù…)", cost:100, days: 3, icon:"âš¡", cat: 'pro'},
    {id: 9, name:"Pro (Ø£Ø³Ø¨ÙˆØ¹)", cost:200, days: 7, icon:"â­", cat: 'pro'},
    {id: 10, name:"Pro (Ø´Ù‡Ø±)", cost:600, days: 30, icon:"ğŸ†", cat: 'pro'},
    {id: 11, name:"Pro (Ø³Ù†Ø©)", cost:5000, days: 365, icon:"ğŸ‘‘", cat: 'pro'},

    // Ù‡Ø¯Ø§ÙŠØ§ ÙØ§Ø®Ø±Ø© (Luxury)
    {id: 12, name:"Ø³ÙŠØ§Ø±Ø© Ø±ÙŠØ§Ø¶ÙŠØ©", cost:15000, xp:7000, icon:"ğŸï¸", cat: 'luxury'},
    {id: 13, name:"ÙŠØ®Øª Ù…Ù„ÙƒÙŠ", cost:50000, xp:25000, icon:"ğŸ›¥ï¸", cat: 'luxury'},
    {id: 14, name:"Ø·Ø§Ø¦Ø±Ø© Ø®Ø§ØµØ©", cost:100000, xp:55000, icon:"ğŸ›©ï¸", cat: 'luxury'},
    {id: 15, name:"Ø¬Ø²ÙŠØ±Ø© Ø®Ø§ØµØ©", cost:500000, xp:300000, icon:"ğŸï¸", cat: 'luxury'},
    {id: 16, name:"ØµØ§Ø±ÙˆØ® ÙØ¶Ø§Ø¡", cost:1000000, xp:750000, icon:"ğŸš€", cat: 'luxury'}
];

async function initGiftPage() {
    renderGifts('all');
    firebase.auth().onAuthStateChanged(async user => {
        if(!user) return window.location.href="auth.html";
        currentUserId = user.uid; 
        const data = await loadUserData();
        if(data) {
            currentUserData = data;
            document.getElementById("user-coins").innerText = (data.totalCoins || 0).toLocaleString();
            selectSelf();
            setupSearch();
        }
    });
}

function renderGifts(filter) {
    const container = document.getElementById("gifts-container");
    container.innerHTML = '';
    const filtered = filter === 'all' ? gifts : gifts.filter(g => g.cat === filter);
    
    filtered.forEach(g => {
        const qty = giftCart[g.id] || 0;
        const div = document.createElement("div");
        div.className = "gift-item";
        div.innerHTML = `
            <div class="gift-icon">${g.icon}</div>
            <div class="gift-name">${g.name}</div>
            <div class="gift-info">${g.cat === 'pro' ? '+' + g.days + ' ÙŠÙˆÙ… Pro' : '+' + g.xp + ' XP'}</div>
            <div class="gift-price">${g.cost.toLocaleString()} ÙƒÙˆÙŠÙ†Ø²</div>
            <div class="qty-controls">
                <button class="qty-btn" onclick="updateQty(${g.id}, 1)">+</button>
                <span class="qty-num" id="qty-${g.id}">${qty}</span>
                <button class="qty-btn" onclick="updateQty(${g.id}, -1)">-</button>
            </div>
        `;
        container.appendChild(div);
    });
}

function filterGifts(cat, el) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    renderGifts(cat);
}

function updateQty(id, change) {
    let current = giftCart[id] || 0;
    let newVal = Math.max(0, current + change);
    if (newVal === 0) delete giftCart[id];
    else giftCart[id] = newVal;
    
    if(document.getElementById(`qty-${id}`)) {
        document.getElementById(`qty-${id}`).innerText = newVal;
    }
    calculateTotal();
}

function calculateTotal() {
    let cost = 0, xp = 0, days = 0;
    for (const id in giftCart) {
        const gift = gifts.find(g => g.id == id);
        cost += gift.cost * giftCart[id];
        if (gift.cat === 'pro') days += gift.days * giftCart[id];
        else xp += gift.xp * giftCart[id];
    }
    document.getElementById("total-cost-display").innerText = cost.toLocaleString();
    document.getElementById("total-xp-display").innerText = xp.toLocaleString();
    document.getElementById("total-pro-days").innerText = days;
    
    const canAfford = currentUserData.totalCoins >= cost;
    const hasItems = cost > 0;
    document.getElementById("send-gift-btn").disabled = !hasItems || !canAfford;
}

function selectSelf() {
    selectedPlayer = { uid: currentUserId, displayName: "Ù†ÙØ³Ùƒ" };
    document.getElementById("recipient-alert").innerText = "Ø§Ù„Ù…Ø³ØªÙ„Ù…: Ø£Ù†Øª (ØªØ·ÙˆÙŠØ± Ø­Ø³Ø§Ø¨Ùƒ)";
    calculateTotal();
}

function setupSearch() {
    const input = document.getElementById("player-search");
    const resultsDiv = document.getElementById("search-results");

    input.addEventListener("input", async () => {
        const query = input.value.trim();
        if (query.length < 2) { resultsDiv.innerHTML = ""; return; }

        const snap = await firebase.firestore().collection("users")
            .where("displayName", ">=", query)
            .where("displayName", "<=", query + "\uf8ff")
            .limit(5).get();

        resultsDiv.innerHTML = "";
        snap.forEach(doc => {
            if (doc.id === currentUserId) return;
            const item = document.createElement("div");
            item.className = "search-item";
            item.innerText = doc.data().displayName;
            item.onclick = () => {
                selectedPlayer = { uid: doc.id, displayName: doc.data().displayName };
                document.getElementById("recipient-alert").innerText = `Ø§Ù„Ù…Ø³ØªÙ„Ù…: ${doc.data().displayName}`;
                input.value = "";
                resultsDiv.innerHTML = "";
                calculateTotal();
            };
            resultsDiv.appendChild(item);
        });
    });
}

async function processPurchase() {
    const overlay = document.getElementById("purchase-overlay");
    let totalCost = 0, totalXP = 0, totalDays = 0;
    let giftsSent = [];

    for (const id in giftCart) {
        const gift = gifts.find(g => g.id == id);
        totalCost += gift.cost * giftCart[id];
        if (gift.cat === 'pro') totalDays += gift.days * giftCart[id];
        else totalXP += gift.xp * giftCart[id];
        giftsSent.push({ name: gift.name, qty: giftCart[id] });
    }

    if (currentUserData.totalCoins < totalCost) return alert("Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ!");

    overlay.style.display = "flex";

    try {
        const db = firebase.firestore();
        const batch = db.batch();
        const senderRef = db.collection("users").doc(currentUserId);
        const recipientRef = db.collection("users").doc(selectedPlayer.uid);

        // Ø®ØµÙ… Ø§Ù„ÙƒÙˆÙŠÙ†Ø² Ù…Ù† Ø§Ù„Ù…Ø±Ø³Ù„
        batch.update(senderRef, { 
            totalCoins: firebase.firestore.FieldValue.increment(-totalCost) 
        });

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù€ XP ÙˆØ§Ù„Ø£ÙŠØ§Ù… Ù„Ù„Ù…Ø³ØªÙ„Ù… (Ù†ÙØ³Ùƒ Ø£Ùˆ ØµØ¯ÙŠÙ‚)
        let updates = {};
        if (totalXP > 0) updates.xp = firebase.firestore.FieldValue.increment(totalXP);
        
        if (totalDays > 0) {
            const recipientDoc = await recipientRef.get();
            const currentExpiry = recipientDoc.data().proExpiryTime || Date.now();
            const base = currentExpiry > Date.now() ? currentExpiry : Date.now();
            updates.proExpiryTime = base + (totalDays * 24 * 60 * 60 * 1000);
        }

        // Ø¥Ø°Ø§ Ø£Ø±Ø³Ù„Øª Ù„Ø´Ø®Øµ Ø¢Ø®Ø±ØŒ Ø£Ø¶Ù Ù„Ù‡ ØªÙ†Ø¨ÙŠÙ‡Ø§Ù‹ Ø¨Ø§Ù„Ù‡Ø¯ÙŠØ©
        if (selectedPlayer.uid !== currentUserId) {
            updates.newGifts = firebase.firestore.FieldValue.arrayUnion({
                senderName: currentUserData.displayName,
                giftName: giftsSent.map(g => `${g.qty}x ${g.name}`).join('ØŒ ')
            });
        }

        batch.update(recipientRef, updates);
        await batch.commit();

        setTimeout(() => {
            location.href = "index.html";
        }, 1500);

    } catch (e) {
        console.error(e);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„!");
        overlay.style.display = "none";
    }
}
</script>
</body>
</html>

