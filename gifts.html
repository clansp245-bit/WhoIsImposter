<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ Ù…ØªØ¬Ø± Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§</title>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="auth.js"></script> 

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
    :root {
        --primary: #6366f1;
        --accent-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
        --bg-body: #0a0f1e;
        --card-bg: rgba(30, 41, 59, 0.7);
        --text-main: #f1f5f9;
        --text-dim: #94a3b8;
        --gold: #ffd700;
        --pro-blue: #3b82f6;
    }

    body {
        font-family: 'Cairo', sans-serif;
        background-color: var(--bg-body);
        background-image: radial-gradient(circle at top right, #1e1b4b, transparent), radial-gradient(circle at bottom left, #1e1b4b, transparent);
        color: var(--text-main);
        padding: 20px;
        min-height: 100vh;
        margin: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    /* Ø´Ø±ÙŠØ· Ø§Ù„ÙƒÙˆÙŠÙ†Ø² Ø§Ù„Ø¹Ù„ÙˆÙŠ */
    .top-info-bar {
        width: 100%;
        max-width: 500px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    #home-link { color: var(--text-dim); text-decoration: none; font-size: 1.2rem; }
    #coins-display { background: rgba(251, 191, 36, 0.1); padding: 8px 15px; border-radius: 20px; color: var(--gold); font-weight: 900; border: 1px solid rgba(251, 191, 36, 0.2); }

    h2 { font-size: 2.2rem; font-weight: 900; margin-bottom: 20px; background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

    .card {
        background: var(--card-bg);
        backdrop-filter: blur(15px);
        padding: 20px;
        border-radius: 24px;
        width: 100%;
        max-width: 500px;
        border: 1px solid rgba(255,255,255,0.1);
        text-align: right;
        box-sizing: border-box;
        margin-bottom: 15px;
    }

    /* Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªÙ„Ù… */
    .recipient-box { display: flex; gap: 10px; margin-bottom: 15px; }
    #self-gift-btn { 
        background: var(--primary); color: white; border: none; padding: 10px 20px; 
        border-radius: 12px; font-weight: 700; cursor: pointer; transition: 0.3s;
    }
    input[type="text"] {
        flex-grow: 1; background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(255,255,255,0.1);
        padding: 12px; border-radius: 12px; color: white; font-family: 'Cairo';
    }

    .recipient-alert { 
        background: rgba(99, 102, 241, 0.1); padding: 10px; border-radius: 12px; 
        text-align: center; font-weight: 700; font-size: 0.9rem; color: var(--primary);
    }

    /* Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ */
    .gift-item { 
        display: flex; align-items: center; justify-content: space-between;
        background: rgba(255, 255, 255, 0.03); 
        padding: 12px; border-radius: 15px; margin-bottom: 10px; 
        border: 1px solid rgba(255,255,255,0.05);
        transition: 0.3s;
    }
    .gift-item:hover { background: rgba(255, 255, 255, 0.07); }

    .gift-info { flex-grow: 1; margin-right: 12px; }
    .gift-name { font-weight: 900; font-size: 1.1rem; }
    .gift-meta { font-size: 0.8rem; color: var(--text-dim); }
    .gift-cost { color: #34d399; font-weight: 700; }

    /* Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„ÙƒÙ…ÙŠØ© */
    .qty-controls { display: flex; align-items: center; background: rgba(0,0,0,0.2); border-radius: 10px; padding: 5px; }
    .qty-btn { 
        width: 30px; height: 30px; border: none; background: var(--primary); 
        color: white; border-radius: 8px; cursor: pointer; font-weight: 900;
    }
    .qty-num { width: 35px; text-align: center; font-weight: 900; font-size: 1rem; }

    /* Ù…Ù„Ø®Øµ Ø§Ù„Ø³Ù„Ø© */
    #cart-summary {
        background: rgba(0, 0, 0, 0.2); padding: 15px; border-radius: 18px; 
        margin-top: 20px; border: 1px dashed rgba(255,255,255,0.1);
    }
    .summary-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9rem; }
    .total-price { font-size: 1.3rem; color: var(--gold); font-weight: 900; margin-top: 10px; }

    .send-btn {
        width: 100%; padding: 18px; border-radius: 18px; border: none;
        background: var(--accent-gradient); color: white; font-weight: 900;
        font-size: 1.2rem; cursor: pointer; margin-top: 15px;
        box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);
        transition: 0.3s;
    }
    .send-btn:disabled { opacity: 0.3; cursor: not-allowed; transform: scale(0.98); }

    /* ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† (Ù†ÙØ³ ÙÙƒØ±Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù„ÙƒÙ† Ø¨Ù„Ù…Ø³Ø§Øª Ø²Ø¬Ø§Ø¬ÙŠØ©) */
    #purchase-animation-overlay {
        position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px);
        display: none; justify-content: center; align-items: center; z-index: 1000;
    }
    .anim-card {
        background: var(--card-bg); padding: 40px; border-radius: 30px;
        border: 2px solid var(--primary); text-align: center; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    .search-result-item {
        padding: 10px; background: rgba(255,255,255,0.05); margin-top: 5px;
        border-radius: 10px; cursor: pointer; transition: 0.2s;
    }
    .search-result-item:hover { background: var(--primary); }

</style>
</head>

<body onload="initGiftPage()">

<div class="top-info-bar">
    <a href="index.html" id="home-link"><i class="fas fa-chevron-right"></i> Ø±Ø¬ÙˆØ¹</a>
    <div id="coins-display"><i class="fas fa-coins"></i> <span id="user-coins">0</span></div>
</div>

<h2>ğŸ Ù…ØªØ¬Ø± Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§</h2>

<div class="card">
    <div class="recipient-box">
        <button id="self-gift-btn" onclick="selectSelf()">Ù„Ù†ÙØ³ÙŠ</button>
        <input type="text" id="player-search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù„Ø§Ø¹Ø¨ (Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶)...">
    </div>
    <div id="search-results"></div>
    <div class="recipient-alert" id="recipient-alert">Ø§Ù„Ù…Ø³ØªÙ„Ù…: (Ø£Ù†Øª)</div>
</div>

<div class="card">
    <h3 style="margin-top:0;"><i class="fas fa-shopping-basket"></i> Ø§Ø®ØªØ± Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§</h3>
    <div id="gifts-container"></div>
    
    <div id="cart-summary">
        <div class="summary-row"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù€ XP Ù„Ù„Ù…Ø³ØªÙ„Ù…:</span> <span id="total-xp-display">0</span></div>
        <div class="summary-row"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£ÙŠØ§Ù… Ø§Ù„Ù€ Pro:</span> <span id="total-pro-days">0</span></div>
        <div class="total-price">Ø§Ù„ØªÙƒÙ„ÙØ©: <span id="total-cost-display">0</span> ÙƒÙˆÙŠÙ†Ø²</div>
    </div>

    <button class="send-btn" id="send-gift-btn" disabled onclick="sendGifts()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ <i class="fas fa-paper-plane"></i></button>
</div>

<div id="purchase-animation-overlay">
    <div class="anim-card" id="anim-box">
        <div id="animation-icon" style="font-size: 5rem; margin-bottom: 20px;">ğŸ</div>
        <h3 id="animation-text" style="margin:0; font-size: 1.5rem;">ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­!</h3>
    </div>
</div>

<script>
// Ù†ÙØ³ Ù…Ù†Ø·Ù‚ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠ Ø§Ù„Ø°ÙŠ Ø£Ø±Ø³Ù„ØªÙ‡ Ø³Ø§Ø¨Ù‚Ø§Ù‹ Ù…Ø¹ Ø±Ø¨Ø·Ù‡ Ø¨Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
let currentUserData = {};
let selectedPlayer = { uid: null, displayName: null }; 
let giftCart = {}; 
let currentUserId = null;

const gifts = [
    {name:"ÙˆØ±Ø¯Ø© Ø¨Ø³ÙŠØ·Ø©", cost:50, xp:10, rarity:"Ø¹Ø§Ø¯ÙŠ", icon:"ğŸŒ¹", type: 'xp'},
    {name:"ÙƒØªØ§Ø¨ Ø³Ø­Ø±ÙŠ", cost:100, xp:20, rarity:"Ø¹Ø§Ø¯ÙŠ", icon:"ğŸ“–", type: 'xp'},
    {name:"Ù‚Ù„Ù… Ø°Ù‡Ø¨ÙŠ", cost:200, xp:50, rarity:"ØºØ§Ù„ÙŠ", icon:"ğŸ–‹ï¸", type: 'xp'},
    {name:"ÙŠØ®Øª ÙØ§Ø®Ø±", cost:3000, xp:800, rarity:"ØºØ§Ù„ÙŠ", icon:"ğŸ›¥ï¸", type: 'xp'},
    {name:"Ø³ÙŠØ§Ø±Ø© Ø³Ø¨Ø§Ù‚", cost:1500, xp:450, rarity:"Ø£Ø³Ø·ÙˆØ±ÙŠ", icon:"ğŸï¸", type: 'xp'},
    {name:"ØªØ§Ø¬ Ù…Ù„ÙƒÙŠ", cost:10000, xp:2500, rarity:"Ø£Ø³Ø·ÙˆØ±ÙŠ", icon:"ğŸ‘‘", type: 'xp'},
    {name:"Ø§Ø´ØªØ±Ø§Ùƒ Pro (Ø£Ø³Ø¨ÙˆØ¹)", cost:150, days: 7, rarity:"Pro", icon:"â­", type: 'pro'},
    {name:"Ø§Ø´ØªØ±Ø§Ùƒ Pro (Ø´Ù‡Ø±)", cost:450, days: 30, rarity:"Pro", icon:"ğŸ†", type: 'pro'},
    {name:"Ø§Ø´ØªØ±Ø§Ùƒ Pro (Ø³Ù†Ø©)", cost:2414, days: 365, rarity:"Pro", icon:"ğŸ‘‘", type: 'pro'},
];

async function initGiftPage() {
    populateGifts();
    firebase.auth().onAuthStateChanged(async user => {
        if(!user) return window.location.href="auth.html";
        currentUserId = user.uid; 
        const data = await loadUserData();
        if(data) {
            currentUserData = data;
            document.getElementById("user-coins").innerText = data.totalCoins || 0;
        }
        selectSelf();
        setupSearch();
    });
}

function populateGifts() {
    const container = document.getElementById("gifts-container");
    container.innerHTML = '';
    gifts.forEach((g, i) => {
        const div = document.createElement("div");
        div.className = "gift-item";
        div.innerHTML = `
            <div class="gift-info">
                <div class="gift-name">${g.icon} ${g.name}</div>
                <div class="gift-meta">
                    <span class="gift-cost">${g.cost} ÙƒÙˆÙŠÙ†Ø²</span> | 
                    <span>${g.type === 'xp' ? g.xp + ' XP' : g.days + ' ÙŠÙˆÙ… Pro'}</span>
                </div>
            </div>
            <div class="qty-controls">
                <button class="qty-btn" onclick="updateQty(${i}, 1)">+</button>
                <span class="qty-num" id="qty-${i}">0</span>
                <button class="qty-btn" onclick="updateQty(${i}, -1)">-</button>
            </div>
        `;
        container.appendChild(div);
    });
}

function updateQty(index, change) {
    let current = giftCart[index] || 0;
    let newVal = Math.max(0, current + change);
    
    // Ù‚ÙŠØ¯ Pro
    if (gifts[index].type === 'pro' && newVal > 1) newVal = 1;

    if (newVal === 0) delete giftCart[index];
    else giftCart[index] = newVal;

    document.getElementById(`qty-${index}`).innerText = newVal;
    calculateTotal();
}

function calculateTotal() {
    let totalCost = 0, totalXP = 0, totalDays = 0;
    for (const i in giftCart) {
        const g = gifts[i], q = giftCart[i];
        totalCost += g.cost * q;
        if (g.type === 'xp') totalXP += g.xp * q;
        else totalDays += g.days * q;
    }
    document.getElementById("total-cost-display").innerText = totalCost;
    document.getElementById("total-xp-display").innerText = totalXP;
    document.getElementById("total-pro-days").innerText = totalDays;
    
    const canAfford = (currentUserData.totalCoins || 0) >= totalCost;
    document.getElementById("send-gift-btn").disabled = totalCost === 0 || !selectedPlayer.uid || !canAfford;
}

function selectSelf() {
    selectedPlayer = { uid: currentUserId, displayName: "Ø£Ù†Øª" };
    document.getElementById("recipient-alert").innerText = "Ø§Ù„Ù…Ø³ØªÙ„Ù…: (Ø£Ù†Øª)";
    document.getElementById("recipient-alert").style.color = "var(--primary)";
    calculateTotal();
}

function setupSearch() {
    const input = document.getElementById("player-search");
    input.addEventListener("input", async () => {
        const q = input.value.trim();
        const results = document.getElementById("search-results");
        if (q.length < 3) { results.innerHTML = ""; return; }
        
        const users = await searchUsersByDisplayName(q); 
        results.innerHTML = "";
        users.forEach(u => {
            if (u.uid === currentUserId) return;
            const d = document.createElement("div");
            d.className = "search-result-item";
            d.innerText = u.displayName;
            d.onclick = () => {
                selectedPlayer = { uid: u.uid, displayName: u.displayName };
                document.getElementById("recipient-alert").innerText = `Ø§Ù„Ù…Ø³ØªÙ„Ù…: ${u.displayName}`;
                document.getElementById("recipient-alert").style.color = "#34d399";
                results.innerHTML = "";
                input.value = "";
                calculateTotal();
            };
            results.appendChild(d);
        });
    });
}

async function sendGifts() {
    // Ø§Ø³ØªØ®Ø¯Ù… Ù…Ù†Ø·Ù‚ Transaction Ø§Ù„Ø°ÙŠ Ø£Ø±Ø³Ù„ØªÙ‡ Ø³Ø§Ø¨Ù‚Ø§Ù‹ Ù‡Ù†Ø§
    // Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„ØªØ§Ù„ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­:
    showAnim();
}

function showAnim() {
    const overlay = document.getElementById("purchase-animation-overlay");
    overlay.style.display = 'flex';
    setTimeout(() => {
        overlay.style.display = 'none';
        location.reload(); 
    }, 2500);
}
</script>
</body>
</html>

