<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’ Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„Ù…Ù„ÙƒÙŠ Ø§Ù„Ø£Ø³Ø·ÙˆØ±ÙŠ</title>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="auth.js"></script> 

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        :root {
            --primary: #6366f1;
            --accent-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            --bg-body: #0a0f1e;
            --card-bg: rgba(30, 41, 59, 0.7);
            --text-main: #f1f5f9;
            --text-dim: #94a3b8;
            --gold: #ffd700;
            --pro-color: #f472b6;
            --tool-color: #38bdf8;
            --xp-color: #10b981;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-body);
            background-image: radial-gradient(circle at top right, #1e1b4b, transparent);
            color: var(--text-main);
            padding: 10px; margin: 0;
            display: flex; flex-direction: column; align-items: center;
        }

        .top-info-bar { width: 100%; max-width: 500px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        #coins-display { background: rgba(251, 191, 36, 0.1); padding: 8px 15px; border-radius: 15px; color: var(--gold); font-weight: 900; border: 1px solid var(--gold); }

        .card {
            background: var(--card-bg); backdrop-filter: blur(15px); padding: 15px; border-radius: 20px;
            width: 100%; max-width: 500px; border: 1px solid rgba(255,255,255,0.1); box-sizing: border-box; margin-bottom: 12px;
            position: relative;
        }

        .search-container { position: relative; width: 100%; }
        #player-search { width: 100%; padding: 12px; border-radius: 10px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: white; font-family: 'Cairo'; box-sizing: border-box; }
        .search-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: #1e293b; border-radius: 10px; z-index: 100; max-height: 150px; overflow-y: auto; display: none; border: 1px solid var(--primary); margin-top: 5px; }
        .search-item { padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; font-size: 0.85rem; }
        .search-item:hover { background: var(--primary); }

        .tabs { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; width: 100%; max-width: 500px; scrollbar-width: none; padding-bottom: 5px; }
        .tab { padding: 8px 15px; background: rgba(255,255,255,0.05); border-radius: 20px; cursor: pointer; white-space: nowrap; font-weight: 700; font-size: 0.75rem; }
        .tab.active { background: var(--primary); color: white; }

        .gifts-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; width: 100%; }
        .gift-item { 
            background: rgba(255, 255, 255, 0.03); padding: 12px 5px; border-radius: 18px; border: 1px solid rgba(255,255,255,0.05);
            display: flex; flex-direction: column; align-items: center; text-align: center; position: relative;
        }
        
        .gift-icon-container { width: 55px; height: 55px; border-radius: 18px; background: rgba(255,255,255,0.05); display: flex; justify-content: center; align-items: center; font-size: 1.6rem; margin-bottom: 8px; }
        .badge-icon { color: var(--gold); }
        .tool-icon { color: var(--tool-color); }
        .pro-exclusive-tag { position: absolute; top: 5px; left: 5px; background: var(--pro-color); color: white; font-size: 0.55rem; padding: 2px 6px; border-radius: 5px; font-weight: 900; }

        .gift-name { font-weight: 800; font-size: 0.85rem; color: #fff; line-height: 1.2; }
        .gift-xp { color: var(--xp-color); font-size: 0.7rem; font-weight: bold; margin-bottom: 4px; }
        .gift-price { color: var(--gold); font-weight: 900; font-size: 0.8rem; }

        .qty-controls { display: flex; align-items: center; gap: 10px; margin-top: 8px; }
        .qty-btn { width: 25px; height: 25px; border: none; background: var(--primary); color: white; border-radius: 5px; cursor: pointer; font-weight: 900; }

        .send-btn { width: 100%; padding: 15px; border-radius: 15px; border: none; background: var(--accent-gradient); color: white; font-weight: 900; cursor: pointer; margin-top: 15px; }
        .send-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        #purchase-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; display: none; flex-direction: column; justify-content: center; align-items: center; }
    </style>
</head>

<body onload="initGiftPage()">

<div class="top-info-bar">
    <a href="index.html" style="color: var(--text-dim); text-decoration: none;"><i class="fas fa-chevron-right"></i></a>
    <div id="coins-display"><i class="fas fa-coins"></i> <span id="user-coins">0</span></div>
</div>

<h2 style="font-weight: 900; color: #fff; margin: 10px 0;">ğŸ’ Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„Ù…Ù„ÙƒÙŠ</h2>

<div class="card">
    <div class="search-container">
        <input type="text" id="player-search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† ØµØ¯ÙŠÙ‚ Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù€ ID...">
        <div id="search-results" class="search-dropdown"></div>
    </div>
    <div id="rec-info" style="margin-top: 10px; font-size: 0.8rem; color: var(--primary); font-weight: bold;">Ø§Ù„Ù…Ø³ØªÙ„Ù…: <span id="rec-name" style="color:#fff">Ù†ÙØ³ÙŠ</span></div>
</div>

<div class="tabs">
    <div class="tab active" onclick="filterGifts('all', this)">Ø§Ù„ÙƒÙ„</div>
    <div class="tab" onclick="filterGifts('luxury', this)">Ù…Ù„ÙƒÙŠ ğŸ’</div>
    <div class="tab" onclick="filterGifts('medium', this)">Ù…ØªÙˆØ³Ø· âš–ï¸</div>
    <div class="tab" onclick="filterGifts('cheap', this)">Ø¨Ø³ÙŠØ· âœ¨</div>
    <div class="tab" onclick="filterGifts('pro', this)">Ø¨Ø±Ùˆ ğŸ”¥</div>
    <div class="tab" onclick="filterGifts('tools', this)">Ø£Ø¯ÙˆØ§Øª ğŸ› ï¸</div>
    <div class="tab" onclick="filterGifts('badges', this)">Ø´Ø§Ø±Ø§Øª ğŸ…</div>
</div>

<div class="card">
    <div id="gifts-container" class="gifts-grid"></div>
    <div style="text-align: center; margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;">
        <span style="color: var(--text-dim)">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span>
        <span id="total-cost" style="color: var(--gold); font-weight: 900; font-size: 1.2rem;">0</span>
    </div>
    <button class="send-btn" id="send-btn" disabled onclick="processPurchase()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø´Ø±Ø§Ø¡</button>
</div>

<div id="purchase-overlay">
    <i class="fas fa-spinner fa-spin" style="font-size: 3rem; color: var(--primary);"></i>
    <p>Ø¬Ø§Ø±ÙŠ ØªÙ†ÙÙŠØ° Ø§Ù„Ø·Ù„Ø¨...</p>
</div>

<script>
let currentUserData = {};
let selectedPlayerUid = null;
let cart = {};

const gifts = [
    // --- Ø§Ù„Ø£Ø¯ÙˆØ§Øª (Ù„Ø§ ØªØ¹Ø·ÙŠ XP) ---
    {id: 50, name:"Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø§Ø³Ù…", cost:1000, cat:"tools", icon:"fas fa-id-card", isTool: true, xp: 0},
    {id: 51, name:"Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù€ ID", cost:1000000, cat:"tools", icon:"fas fa-fingerprint", isTool: true, xp: 0},

    // --- Ø§Ù„Ø´Ø§Ø±Ø§Øª (Ù„Ø§ ØªØ¹Ø·ÙŠ XP) ---
    {id: 100, name:"Ø§Ù„Ø£Ø³Ø·ÙˆØ±Ø©", cost:20000, cat:"badges", icon:"fas fa-shield-halved", isBadge: true, xp: 0},
    {id: 101, name:"Ø§Ù„ØªÙ†ÙŠÙ†", cost:15000, cat:"badges", icon:"fas fa-dragon", isBadge: true, xp: 0},

    // --- Ù‡Ø¯Ø§ÙŠØ§ Ù…Ù„ÙƒÙŠØ© (Luxury) ---
    {id: 200, name:"Ù‚ØµØ± Ø§Ù„ØµÙŠÙ", cost:50000, cat:"luxury", icon:"ğŸ°", xp: 25000},
    {id: 201, name:"Ø¬Ø²ÙŠØ±Ø© Ø®Ø§ØµØ©", cost:150000, cat:"luxury", icon:"ğŸï¸", xp: 80000},
    {id: 202, name:"Ø·Ø§Ø¦Ø±Ø© Ø®Ø§ØµØ©", cost:100000, cat:"luxury", icon:"âœˆï¸", xp: 50000},
    {id: 203, name:"ÙŠØ®Øª Ù…Ù„ÙƒÙŠ", cost:75000, cat:"luxury", icon:"ğŸš¢", xp: 35000},

    // --- Ù‡Ø¯Ø§ÙŠØ§ Ù…ØªÙˆØ³Ø·Ø© (Medium) ---
    {id: 300, name:"Ø³ÙŠØ§Ø±Ø© Ø±ÙŠØ§Ø¶ÙŠØ©", cost:10000, cat:"medium", icon:"ğŸï¸", xp: 4500},
    {id: 301, name:"Ø³Ø§Ø¹Ø© Ø§Ù„Ù…Ø§Ø³", cost:8000, cat:"medium", icon:"âŒš", xp: 3500},
    {id: 302, name:"Ø®Ø§ØªÙ… Ø°Ù‡Ø¨", cost:5000, cat:"medium", icon:"ğŸ’", xp: 2000},
    {id: 303, name:"Ù„Ø§Ø¨ØªÙˆØ¨", cost:3000, cat:"medium", icon:"ğŸ’»", xp: 1200},

    // --- Ù‡Ø¯Ø§ÙŠØ§ Ø¨Ø³ÙŠØ·Ø© (Cheap) ---
    {id: 1, name:"ÙˆØ±Ø¯Ø©", cost:20, cat:"cheap", icon:"ğŸŒ¹", xp: 10},
    {id: 2, name:"Ù‚Ù„Ø¨", cost:50, cat:"cheap", icon:"â¤ï¸", xp: 25},
    {id: 3, name:"Ù‚Ù‡ÙˆØ©", cost:15, cat:"cheap", icon:"â˜•", xp: 5},
    {id: 4, name:"Ø¯ÙˆÙ†Ø§Øª", cost:30, cat:"cheap", icon:"ğŸ©", xp: 15},
    {id: 5, name:"Ø¨Ø§Ù„ÙˆÙ†", cost:10, cat:"cheap", icon:"ğŸˆ", xp: 4},

    // --- Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ø¨Ø±Ùˆ (Pro) ---
    {id: 60, name:"Ø§Ù„ØªØ§Ø¬ Ø§Ù„Ø£Ø±Ø¬ÙˆØ§Ù†ÙŠ", cost:12000, cat:"pro", icon:"fas fa-crown", proOnly: true, xp: 6000},
    {id: 61, name:"Ø³ÙŠØ§Ø±Ø© Ù†ÙŠÙˆÙ†", cost:18000, cat:"pro", icon:"fas fa-car-side", proOnly: true, xp: 9000},
    {id: 62, name:"Ø¯Ø±Ø¹ Ø§Ù„ÙØ§Ø±Ø³", cost:7000, cat:"pro", icon:"fas fa-shield-alt", proOnly: true, xp: 3500}
];

// ØªÙˆÙ„ÙŠØ¯ Ù‡Ø¯Ø§ÙŠØ§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù„ØªÙƒÙ…Ù„Ø© Ø§Ù„Ø¹Ø¯Ø¯ (ØªØ¬Ù†Ø¨Ø§Ù‹ Ù„Ù„ØªÙƒØ±Ø§Ø± Ø§Ù„ÙŠØ¯ÙˆÙŠ)
for(let i=1; i<=30; i++) {
    gifts.push({
        id: 500+i,
        name: `Ù‡Ø¯ÙŠØ© Ù…Ù†ÙˆØ¹Ø© ${i}`,
        cost: 100 * i,
        cat: i > 20 ? "luxury" : (i > 10 ? "medium" : "cheap"),
        icon: "ğŸ",
        xp: 50 * i
    });
}

async function initGiftPage() {
    firebase.auth().onAuthStateChanged(async user => {
        if(!user) return;
        selectedPlayerUid = user.uid;
        const doc = await firebase.firestore().collection('users').doc(user.uid).get();
        currentUserData = doc.data() || {};
        document.getElementById("user-coins").innerText = (currentUserData.totalCoins || 0).toLocaleString();
        renderGifts('all');
        setupSearch();
    });
}

function renderGifts(filter) {
    const container = document.getElementById("gifts-container");
    container.innerHTML = '';
    
    gifts.forEach(g => {
        if(filter !== 'all' && g.cat !== filter) return;
        
        const div = document.createElement("div");
        div.className = "gift-item";
        let iconContent = g.icon.startsWith('fas') ? `<i class="${g.icon} ${g.isBadge ? 'badge-icon' : 'tool-icon'}"></i>` : `<span>${g.icon}</span>`;
        
        div.innerHTML = `
            ${g.proOnly ? '<span class="pro-exclusive-tag">PRO</span>' : ''}
            <div class="gift-icon-container">${iconContent}</div>
            <div class="gift-name">${g.name}</div>
            <div class="gift-xp">${g.xp > 0 ? `+${g.xp} XP` : 'Ø¨Ø¯ÙˆÙ† XP'}</div>
            <div class="gift-price">${g.cost.toLocaleString()} ÙƒÙˆÙŠÙ†Ø²</div>
            <div class="qty-controls">
                <button class="qty-btn" onclick="changeQty(${g.id}, 1)">+</button>
                <span id="qty-${g.id}">${cart[g.id] || 0}</span>
                <button class="qty-btn" onclick="changeQty(${g.id}, -1)">-</button>
            </div>
        `;
        container.appendChild(div);
    });
}

function setupSearch() {
    const input = document.getElementById('player-search');
    const results = document.getElementById('search-results');

    input.addEventListener('input', async () => {
        const val = input.value.trim();
        if(val.length < 2) { results.style.display = 'none'; return; }

        const snap = await firebase.firestore().collection('users')
            .where('displayName', '>=', val)
            .where('displayName', '<=', val + '\uf8ff')
            .limit(5).get();

        results.innerHTML = '';
        if(snap.empty) {
            results.innerHTML = '<div class="search-item">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
        } else {
            snap.forEach(doc => {
                const data = doc.data();
                const div = document.createElement('div');
                div.className = 'search-item';
                div.innerHTML = `${data.displayName} (ID: ${doc.id.substring(0,6)})`;
                div.onclick = () => {
                    selectedPlayerUid = doc.id;
                    document.getElementById('rec-name').innerText = data.displayName;
                    results.style.display = 'none';
                    input.value = '';
                };
                results.appendChild(div);
            });
        }
        results.style.display = 'block';
    });
}

function changeQty(id, delta) {
    const gift = gifts.find(g => g.id === id);
    const isPro = (currentUserData.proExpiryTime || 0) > Date.now();
    
    if(gift.proOnly && !isPro) {
        alert("Ø­ØµØ±ÙŠ Ù„Ø£Ø¹Ø¶Ø§Ø¡ PRO!");
        return;
    }

    cart[id] = Math.max(0, (cart[id] || 0) + delta);
    if(gift.isBadge || gift.isTool) cart[id] = Math.min(cart[id], 1);

    document.getElementById(`qty-${id}`).innerText = cart[id];
    updateTotal();
}

function updateTotal() {
    let total = 0;
    for(let id in cart) {
        const gift = gifts.find(g => g.id == id);
        total += gift.cost * cart[id];
    }
    document.getElementById("total-cost").innerText = total.toLocaleString();
    document.getElementById("send-btn").disabled = total === 0 || total > currentUserData.totalCoins;
}

function filterGifts(cat, el) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    renderGifts(cat);
}

async function processPurchase() {
    document.getElementById("purchase-overlay").style.display = "flex";
    const db = firebase.firestore();
    const batch = db.batch();
    const myRef = db.collection('users').doc(firebase.auth().currentUser.uid);
    const targetRef = db.collection('users').doc(selectedPlayerUid);

    let totalCost = 0;
    for(let id in cart) {
        if(cart[id] > 0) {
            const gift = gifts.find(g => g.id == id);
            totalCost += gift.cost * cart[id];
            if(gift.isBadge) batch.update(targetRef, { badges: firebase.firestore.FieldValue.arrayUnion(gift.icon) });
            else if(gift.isTool) batch.update(targetRef, { inventory: firebase.firestore.FieldValue.arrayUnion(gift.name) });
            else batch.update(targetRef, { xp: firebase.firestore.FieldValue.increment(gift.xp * cart[id]) });
        }
    }

    try {
        batch.update(myRef, { totalCoins: firebase.firestore.FieldValue.increment(-totalCost) });
        await batch.commit();
        alert("ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!");
        location.reload();
    } catch(e) {
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£!");
    } finally {
        document.getElementById("purchase-overlay").style.display = "none";
    }
}
</script>
</body>
</html>

