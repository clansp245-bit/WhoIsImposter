<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ Ù…ØªØ¬Ø± Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ</title>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="auth.js"></script> 

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        :root {
            --primary: #6366f1;
            --accent-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            --bg-body: #0a0f1e;
            --card-bg: rgba(30, 41, 59, 0.7);
            --text-main: #f1f5f9;
            --text-dim: #94a3b8;
            --gold: #ffd700;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-body);
            background-image: radial-gradient(circle at top right, #1e1b4b, transparent), radial-gradient(circle at bottom left, #1e1b4b, transparent);
            color: var(--text-main);
            padding: 20px;
            min-height: 100vh;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .top-info-bar {
            width: 100%;
            max-width: 500px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        #coins-display { background: rgba(251, 191, 36, 0.1); padding: 8px 15px; border-radius: 20px; color: var(--gold); font-weight: 900; border: 1px solid rgba(251, 191, 36, 0.2); }

        h2 { font-size: 2.2rem; font-weight: 900; margin-bottom: 20px; background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .card {
            background: var(--card-bg);
            backdrop-filter: blur(15px);
            padding: 20px;
            border-radius: 24px;
            width: 100%;
            max-width: 500px;
            border: 1px solid rgba(255,255,255,0.1);
            text-align: right;
            box-sizing: border-box;
            margin-bottom: 15px;
        }

        .recipient-box { display: flex; gap: 10px; margin-bottom: 15px; }
        #self-gift-btn { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 12px; font-weight: 700; cursor: pointer; }
        input[type="text"] { flex-grow: 1; background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(255,255,255,0.1); padding: 12px; border-radius: 12px; color: white; font-family: 'Cairo'; }

        .recipient-alert { background: rgba(99, 102, 241, 0.1); padding: 10px; border-radius: 12px; text-align: center; font-weight: 700; font-size: 0.9rem; color: var(--primary); }

        .gift-item { 
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(255, 255, 255, 0.03); padding: 12px; border-radius: 15px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.05);
        }

        .qty-controls { display: flex; align-items: center; background: rgba(0,0,0,0.2); border-radius: 10px; padding: 5px; }
        .qty-btn { width: 30px; height: 30px; border: none; background: var(--primary); color: white; border-radius: 8px; cursor: pointer; font-weight: 900; }
        .qty-num { width: 35px; text-align: center; font-weight: 900; }

        #cart-summary { background: rgba(0, 0, 0, 0.2); padding: 15px; border-radius: 18px; margin-top: 20px; border: 1px dashed rgba(255,255,255,0.1); }
        .total-price { font-size: 1.3rem; color: var(--gold); font-weight: 900; margin-top: 10px; }

        .send-btn {
            width: 100%; padding: 18px; border-radius: 18px; border: none;
            background: var(--accent-gradient); color: white; font-weight: 900;
            font-size: 1.2rem; cursor: pointer; margin-top: 15px; transition: 0.3s;
        }
        .send-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        #purchase-animation-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .anim-card { background: var(--card-bg); padding: 40px; border-radius: 30px; border: 2px solid var(--primary); text-align: center; }
        
        .search-result-item { padding: 10px; background: rgba(255,255,255,0.05); margin-top: 5px; border-radius: 10px; cursor: pointer; }
        .search-result-item:hover { background: var(--primary); }
    </style>
</head>

<body onload="initGiftPage()">

<div class="top-info-bar">
    <a href="index.html" style="color: var(--text-dim); text-decoration: none;"><i class="fas fa-chevron-right"></i> Ø±Ø¬ÙˆØ¹</a>
    <div id="coins-display"><i class="fas fa-coins"></i> <span id="user-coins">0</span></div>
</div>

<h2>ğŸ Ù…ØªØ¬Ø± Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§</h2>

<div class="card">
    <div class="recipient-box">
        <button id="self-gift-btn" onclick="selectSelf()">Ù„Ù†ÙØ³ÙŠ</button>
        <input type="text" id="player-search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù„Ø§Ø¹Ø¨ Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶...">
    </div>
    <div id="search-results"></div>
    <div class="recipient-alert" id="recipient-alert">Ø§Ù„Ù…Ø³ØªÙ„Ù…: (Ø£Ù†Øª)</div>
</div>

<div class="card">
    <h3 style="margin:0 0 15px 0;"><i class="fas fa-shopping-basket"></i> Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ù…ØªÙˆÙØ±Ø©</h3>
    <div id="gifts-container"></div>
    
    <div id="cart-summary">
        <div style="display:flex; justify-content: space-between;"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù€ XP:</span> <span id="total-xp-display">0</span></div>
        <div style="display:flex; justify-content: space-between;"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£ÙŠØ§Ù… Pro:</span> <span id="total-pro-days">0</span></div>
        <div class="total-price">Ø§Ù„ØªÙƒÙ„ÙØ©: <span id="total-cost-display">0</span> ÙƒÙˆÙŠÙ†Ø²</div>
    </div>

    <button class="send-btn" id="send-gift-btn" disabled onclick="sendGifts()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ <i class="fas fa-paper-plane"></i></button>
</div>

<div id="purchase-animation-overlay">
    <div class="anim-card">
        <div style="font-size: 5rem; margin-bottom: 20px;">ğŸ‰</div>
        <h3 id="animation-text">ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!</h3>
    </div>
</div>

<script>
let currentUserData = {};
let selectedPlayer = { uid: null, displayName: null }; 
let giftCart = {}; 
let currentUserId = null;

const gifts = [
    {name:"ÙˆØ±Ø¯Ø© Ø¨Ø³ÙŠØ·Ø©", cost:50, xp:10, icon:"ğŸŒ¹", type: 'xp'},
    {name:"ÙƒØªØ§Ø¨ Ø³Ø­Ø±ÙŠ", cost:100, xp:20, icon:"ğŸ“–", type: 'xp'},
    {name:"Ù‚Ù„Ù… Ø°Ù‡Ø¨ÙŠ", cost:200, xp:50, icon:"ğŸ–‹ï¸", type: 'xp'},
    {name:"ÙŠØ®Øª ÙØ§Ø®Ø±", cost:3000, xp:800, icon:"ğŸ›¥ï¸", type: 'xp'},
    {name:"ØªØ§Ø¬ Ù…Ù„ÙƒÙŠ", cost:10000, xp:2500, icon:"ğŸ‘‘", type: 'xp'},
    {name:"Ø§Ø´ØªØ±Ø§Ùƒ Pro (Ø£Ø³Ø¨ÙˆØ¹)", cost:150, days: 7, icon:"â­", type: 'pro'},
    {name:"Ø§Ø´ØªØ±Ø§Ùƒ Pro (Ø´Ù‡Ø±)", cost:450, days: 30, icon:"ğŸ†", type: 'pro'},
    {name:"Ø§Ø´ØªØ±Ø§Ùƒ Pro (Ø³Ù†Ø©)", cost:2414, days: 365, icon:"ğŸ‘‘", type: 'pro'},
];

async function initGiftPage() {
    populateGifts();
    firebase.auth().onAuthStateChanged(async user => {
        if(!user) return window.location.href="auth.html";
        currentUserId = user.uid; 
        const data = await loadUserData();
        if(data) {
            currentUserData = data;
            document.getElementById("user-coins").innerText = data.totalCoins || 0;
            selectSelf();
            setupSearch();
        }
    });
}

function populateGifts() {
    const container = document.getElementById("gifts-container");
    container.innerHTML = '';
    gifts.forEach((g, i) => {
        const div = document.createElement("div");
        div.className = "gift-item";
        div.innerHTML = `
            <div>
                <div style="font-weight:900;">${g.icon} ${g.name}</div>
                <div style="font-size:0.8rem; color:var(--text-dim);">${g.cost} ÙƒÙˆÙŠÙ†Ø² | ${g.type === 'xp' ? g.xp + ' XP' : g.days + ' ÙŠÙˆÙ…'}</div>
            </div>
            <div class="qty-controls">
                <button class="qty-btn" onclick="updateQty(${i}, 1)">+</button>
                <span class="qty-num" id="qty-${i}">0</span>
                <button class="qty-btn" onclick="updateQty(${i}, -1)">-</button>
            </div>
        `;
        container.appendChild(div);
    });
}

function updateQty(index, change) {
    let current = giftCart[index] || 0;
    let newVal = Math.max(0, current + change);
    if (gifts[index].type === 'pro' && newVal > 1) newVal = 1;
    if (newVal === 0) delete giftCart[index];
    else giftCart[index] = newVal;
    document.getElementById(`qty-${index}`).innerText = newVal;
    calculateTotal();
}

function calculateTotal() {
    let cost = 0, xp = 0, days = 0;
    for (const i in giftCart) {
        cost += gifts[i].cost * giftCart[i];
        if (gifts[i].type === 'xp') xp += gifts[i].xp * giftCart[i];
        else days += gifts[i].days * giftCart[i];
    }
    document.getElementById("total-cost-display").innerText = cost;
    document.getElementById("total-xp-display").innerText = xp;
    document.getElementById("total-pro-days").innerText = days;
    document.getElementById("send-gift-btn").disabled = cost === 0 || !selectedPlayer.uid || (currentUserData.totalCoins < cost);
}

function selectSelf() {
    selectedPlayer = { uid: currentUserId, displayName: "Ù†ÙØ³Ùƒ" };
    document.getElementById("recipient-alert").innerText = "Ø§Ù„Ù…Ø³ØªÙ„Ù…: (Ø£Ù†Øª)";
    calculateTotal();
}

function setupSearch() {
    const input = document.getElementById("player-search");
    input.addEventListener("input", async () => {
        const q = input.value.trim();
        const results = document.getElementById("search-results");
        if (q.length < 3) { results.innerHTML = ""; return; }
        const snap = await firebase.firestore().collection("users").where("displayName", ">=", q).where("displayName", "<=", q + '\uf8ff').limit(5).get();
        results.innerHTML = "";
        snap.forEach(doc => {
            if (doc.id === currentUserId) return;
            const d = document.createElement("div");
            d.className = "search-result-item";
            d.innerText = doc.data().displayName;
            d.onclick = () => {
                selectedPlayer = { uid: doc.id, displayName: doc.data().displayName };
                document.getElementById("recipient-alert").innerText = `Ø§Ù„Ù…Ø³ØªÙ„Ù…: ${doc.data().displayName}`;
                results.innerHTML = "";
                input.value = "";
                calculateTotal();
            };
            results.appendChild(d);
        });
    });
}

// Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…ØµØ­Ø­Ø© Ù„Ø­Ù„ Ø®Ø·Ø£ "Firestore transactions require all reads to be executed before all writes"
async function sendGifts() {
    const btn = document.getElementById("send-gift-btn");
    let totalCost = parseInt(document.getElementById("total-cost-display").innerText);
    let totalXP = parseInt(document.getElementById("total-xp-display").innerText);
    let totalDays = parseInt(document.getElementById("total-pro-days").innerText);

    if (currentUserData.totalCoins < totalCost) return alert("Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ");

    btn.disabled = true;
    btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";

    try {
        const db = firebase.firestore();
        const senderRef = db.collection("users").doc(currentUserId);
        const recipientRef = db.collection("users").doc(selectedPlayer.uid);

        await db.runTransaction(async (transaction) => {
            // 1. Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© (Reads) - ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø¯Ø§Ø¦Ù…Ø§Ù‹
            const senderDoc = await transaction.get(senderRef);
            const recipientDoc = await transaction.get(recipientRef);

            if (!senderDoc.exists) throw "Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø±Ø³Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯";
            if (!recipientDoc.exists) throw "Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³ØªÙ„Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯";

            if (senderDoc.data().totalCoins < totalCost) throw "Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙ";

            // 2. Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
            const currentExpiry = recipientDoc.data().proExpiryTime || 0;
            const now = Date.now();
            const base = currentExpiry > now ? currentExpiry : now;
            const newExpiry = base + (totalDays * 24 * 60 * 60 * 1000);

            // 3. Ù…Ø±Ø­Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© (Writes) - ØªØ£ØªÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø±Ø³Ù„ (Ø®ØµÙ… Ø§Ù„ÙƒÙˆÙŠÙ†Ø²)
            transaction.update(senderRef, { 
                totalCoins: firebase.firestore.FieldValue.increment(-totalCost) 
            });

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªÙ„Ù… (Ø¥Ø¶Ø§ÙØ© XP Ø£Ùˆ Pro)
            let updateData = {};
            if (totalXP > 0) updateData.xp = firebase.firestore.FieldValue.increment(totalXP);
            if (totalDays > 0) updateData.proExpiryTime = newExpiry;

            transaction.update(recipientRef, updateData);
        });

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        currentUserData.totalCoins -= totalCost;
        document.getElementById("user-coins").innerText = currentUserData.totalCoins;
        
        showAnim();
    } catch (e) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:", e);
        alert("ÙØ´Ù„Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: " + e);
        btn.disabled = false;
        btn.innerText = "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§";
    }
}

function showAnim() {
    document.getElementById("purchase-animation-overlay").style.display = 'flex';
    setTimeout(() => { location.reload(); }, 2000);
}
</script>
</body>
</html>

