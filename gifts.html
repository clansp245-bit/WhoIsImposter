<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ Ù…ØªØ¬Ø± Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ù…Ù„ÙƒÙŠ Ø§Ù„Ù…Ø·ÙˆØ±</title>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="auth.js"></script> 

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        :root {
            --primary: #6366f1;
            --accent-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            --bg-body: #0a0f1e;
            --card-bg: rgba(30, 41, 59, 0.7);
            --text-main: #f1f5f9;
            --text-dim: #94a3b8;
            --gold: #ffd700;
            --success: #10b981;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-body);
            background-image: radial-gradient(circle at top right, #1e1b4b, transparent), radial-gradient(circle at bottom left, #1e1b4b, transparent);
            color: var(--text-main);
            padding: 15px;
            min-height: 100vh;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .top-info-bar { width: 100%; max-width: 500px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        #coins-display { background: rgba(251, 191, 36, 0.1); padding: 8px 15px; border-radius: 15px; color: var(--gold); font-weight: 900; border: 1px solid var(--gold); font-size: 0.9rem; }

        .card {
            background: var(--card-bg); backdrop-filter: blur(15px); padding: 15px; border-radius: 20px;
            width: 100%; max-width: 500px; border: 1px solid rgba(255,255,255,0.1); text-align: right; box-sizing: border-box; margin-bottom: 12px;
        }

        /* Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø·ÙˆØ± */
        .search-container { position: relative; flex-grow: 1; }
        input[type="text"] { width: 100%; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255,255,255,0.1); padding: 12px; border-radius: 12px; color: white; font-family: 'Cairo'; box-sizing: border-box; }
        .search-results { position: absolute; background: #1e293b; width: 100%; z-index: 100; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); top: 50px; overflow: hidden; }
        .search-item { padding: 10px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: 0.3s; }
        .search-item:hover { background: var(--primary); }

        /* Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙ„Ù… Ø§Ù„Ù…Ø®ØªØµØ± */
        .recipient-profile {
            display: flex; align-items: center; gap: 15px; background: rgba(99, 102, 241, 0.1);
            padding: 12px; border-radius: 15px; border: 1px dashed var(--primary); margin-top: 10px;
        }
        .user-avatar { width: 45px; height: 45px; background: var(--accent-gradient); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.2rem; font-weight: 900; }

        .tabs { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; width: 100%; max-width: 500px; scrollbar-width: none; }
        .tab { padding: 8px 18px; background: rgba(255,255,255,0.05); border-radius: 20px; cursor: pointer; white-space: nowrap; font-weight: 700; font-size: 0.85rem; transition: 0.3s; }
        .tab.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(99, 102, 241, 0.4); }

        .gifts-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; width: 100%; }
        .gift-item { 
            background: rgba(255, 255, 255, 0.03); padding: 15px 10px; border-radius: 18px; border: 1px solid rgba(255,255,255,0.05);
            display: flex; flex-direction: column; align-items: center; text-align: center; position: relative;
        }
        .badge-tag { position: absolute; top: 5px; right: 5px; background: var(--gold); color: black; font-size: 0.6rem; padding: 2px 6px; border-radius: 5px; font-weight: 900; }
        
        .gift-icon { font-size: 2.5rem; margin-bottom: 8px; }
        .gift-name { font-weight: 700; font-size: 0.9rem; color: var(--text-main); }
        .gift-info { font-size: 0.75rem; color: var(--text-dim); margin: 4px 0; }
        .gift-price { color: var(--gold); font-weight: 900; font-size: 0.9rem; }

        .qty-controls { display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.3); padding: 5px 12px; border-radius: 10px; margin-top: 10px; }
        .qty-btn { width: 28px; height: 28px; border: none; background: var(--primary); color: white; border-radius: 6px; cursor: pointer; font-weight: 900; }

        #cart-summary { background: rgba(16, 185, 129, 0.05); padding: 15px; border-radius: 15px; margin-top: 15px; border: 1px solid var(--success); }
        .total-price { font-size: 1.3rem; color: var(--gold); font-weight: 900; text-align: center; margin-top: 10px; }

        .send-btn {
            width: 100%; padding: 18px; border-radius: 15px; border: none;
            background: var(--accent-gradient); color: white; font-weight: 900; font-size: 1.2rem; cursor: pointer; margin-top: 15px; transition: 0.3s;
        }
        .send-btn:disabled { opacity: 0.4; filter: grayscale(1); }

        #purchase-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000; display: none; flex-direction: column; justify-content: center; align-items: center; backdrop-filter: blur(10px); }
    </style>
</head>

<body onload="initGiftPage()">

<div class="top-info-bar">
    <a href="index.html" style="color: var(--text-dim); text-decoration: none;"><i class="fas fa-arrow-right"></i> Ø±Ø¬ÙˆØ¹</a>
    <div id="coins-display"><i class="fas fa-coins"></i> <span id="user-coins">0</span></div>
</div>

<h2 style="text-align: center;">ğŸ’ Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„Ù…Ù„ÙƒÙŠ</h2>

<div class="card">
    <div style="display: flex; gap: 10px; align-items: center;">
        <button id="self-gift-btn" onclick="selectSelf()" style="padding: 12px; background: var(--primary); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 900;">Ù„Ù†ÙØ³ÙŠ</button>
        <div class="search-container">
            <input type="text" id="player-search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù„Ø§Ø¹Ø¨ Ø¨Ø§Ø³Ù…Ù‡...">
            <div id="search-results" class="search-results"></div>
        </div>
    </div>
    
    <div id="recipient-profile-box" class="recipient-profile">
        <div class="user-avatar" id="rec-avatar">ØŸ</div>
        <div style="flex-grow: 1;">
            <div id="rec-name" style="font-weight: 900; font-size: 1rem;">Ø§Ø®ØªØ± Ù…Ø³ØªÙ„Ù… Ø§Ù„Ù‡Ø¯ÙŠØ©</div>
            <div id="rec-stats" style="font-size: 0.75rem; color: var(--text-dim);">Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ Ù„Ø¥Ù‡Ø¯Ø§Ø¦Ù‡Ù… Ø´Ø§Ø±Ø§Øª Ø£Ùˆ XP</div>
        </div>
    </div>
</div>

<div class="tabs">
    <div class="tab active" onclick="filterGifts('all', this)">ÙƒÙ„ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§</div>
    <div class="tab" onclick="filterGifts('badges', this)">ğŸ”¥ Ø´Ø§Ø±Ø§Øª Ù†Ø§Ø¯Ø±Ø©</div>
    <div class="tab" onclick="filterGifts('pro', this)">Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Pro</div>
    <div class="tab" onclick="filterGifts('xp', this)">ØªØ·ÙˆÙŠØ± Ø§Ù„Ù…Ø³ØªÙˆÙ‰</div>
</div>

<div class="card" style="padding: 10px;">
    <div id="gifts-container" class="gifts-grid"></div>
    
    <div id="cart-summary">
        <div style="display: flex; justify-content: space-between; font-size: 0.85rem;">
            <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù€ XP: <b id="total-xp-display">0</b></span>
            <span>Ø£ÙŠØ§Ù… Pro: <b id="total-pro-days">0</b></span>
        </div>
        <div class="total-price">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: <span id="total-cost-display">0</span> ÙƒÙˆÙŠÙ†Ø²</div>
    </div>

    <button class="send-btn" id="send-gift-btn" disabled onclick="processPurchase()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ù…Ù„ÙƒÙŠØ© <i class="fas fa-gem"></i></button>
</div>

<div id="purchase-overlay">
    <div style="font-size: 5rem; animation: bounce 1s infinite;">ğŸ</div>
    <h2 style="color: white; margin-top: 20px;">ØªØªÙ… Ø§Ù„Ø¢Ù† Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø§Ù„Ù…Ù„ÙƒÙŠØ©...</h2>
</div>

<script>
let currentUserData = {};
let selectedPlayer = { uid: null, displayName: "Ù†ÙØ³Ùƒ" }; 
let giftCart = {}; 
let currentUserId = null;

const gifts = [
    // Ø´Ø§Ø±Ø§Øª Ù†Ø§Ø¯Ø±Ø© (Badges) - ØºØ§Ù„ÙŠØ©
    {id: 100, name:"Ø´Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø·ÙˆØ±Ø©", cost:10000, type: 'badge', icon:"ğŸ›¡ï¸", info: "ØªØ¸Ù‡Ø± Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ø³Ù…Ùƒ Ù„Ù„Ø£Ø¨Ø¯"},
    {id: 101, name:"Ø´Ø§Ø±Ø© Ø§Ù„Ø«Ø±ÙŠ", cost:8000, type: 'badge', icon:"ğŸ’", info: "Ù„Ù„Ø£Ø«Ø±ÙŠØ§Ø¡ ÙÙ‚Ø·"},
    {id: 102, name:"Ø´Ø§Ø±Ø© Ø§Ù„Ù†ÙŠÙ†Ø¬Ø§", cost:5000, type: 'badge', icon:"ğŸ¥·", info: "ØªØ£Ù„Ù‚ Ø¨Ù„Ù…Ø³Ø© ØºØ§Ù…Ø¶Ø©"},
    {id: 103, name:"Ø´Ø§Ø±Ø© Ø§Ù„Ù†Ø§Ø±", cost:3000, type: 'badge', icon:"ğŸ”¥", info: "Ø´Ø§Ø±Ø© Ù…Ø´ØªØ¹Ù„Ø©"},
    {id: 104, name:"Ø´Ø§Ø±Ø© Ø§Ù„Ù‚Ù„Ø¨", cost:1500, type: 'badge', icon:"â¤ï¸", info: "Ø§Ù†Ø´Ø± Ø§Ù„Ø­Ø¨"},
    {id: 105, name:"Ø´Ø§Ø±Ø© Ø§Ù„Ø¨Ø±Ù‚", cost:1000, type: 'badge', icon:"âš¡", info: "ÙƒÙ† Ø³Ø±ÙŠØ¹Ø§Ù‹ ÙƒØ§Ù„Ø¨Ø±Ù‚"},

    // Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø¨Ø±Ùˆ
    {id: 8, name:"Ø¨Ø±Ùˆ Ø£Ø³Ø¨ÙˆØ¹", cost:150, days: 7, icon:"â­", cat: 'pro'},
    {id: 9, name:"Ø¨Ø±Ùˆ Ø´Ù‡Ø±", cost:450, days: 30, icon:"ğŸ†", cat: 'pro'},
    {id: 11, name:"Ø¨Ø±Ùˆ Ø³Ù†Ø©", cost:2414, days: 365, icon:"ğŸ‘‘", cat: 'pro'},

    // Ù‡Ø¯Ø§ÙŠØ§ XP Ù…ØªÙ†ÙˆØ¹Ø©
    {id: 0, name:"ÙˆØ±Ø¯Ø© Ù…Ù„ÙƒÙŠØ©", cost:50, xp:20, icon:"ğŸŒ¹", cat: 'xp'},
    {id: 1, name:"ØµÙ†Ø¯ÙˆÙ‚ ÙƒÙ†ÙˆØ²", cost:1200, xp:600, icon:"ğŸ“¦", cat: 'xp'},
    {id: 4, name:"ØªØ§Ø¬ Ù…Ù„ÙƒÙŠ", cost:5000, xp:2500, icon:"ğŸ‘‘", cat: 'xp'},
    {id: 5, name:"ÙŠØ®Øª Ø®Ø§Øµ", cost:15000, xp:8000, icon:"ğŸ›¥ï¸", cat: 'luxury'},
    {id: 6, name:"Ù‚ØµØ± ÙØ®Ù…", cost:50000, xp:30000, icon:"ğŸ°", cat: 'luxury'},
    {id: 7, name:"ÙƒÙˆÙƒØ¨ Ø§Ù„Ù…Ø±ÙŠØ®", cost:500000, xp:350000, icon:"ğŸª", cat: 'luxury'}
];

function calculateLevel(xp) { return Math.floor(Math.sqrt(xp / 100)) + 1; }

async function initGiftPage() {
    renderGifts('all');
    firebase.auth().onAuthStateChanged(async user => {
        if(!user) return window.location.href="auth.html";
        currentUserId = user.uid; 
        const data = await loadUserData();
        if(data) {
            currentUserData = data;
            document.getElementById("user-coins").innerText = (data.totalCoins || 0).toLocaleString();
            selectSelf();
            setupSearch();
        }
    });
}

function renderGifts(filter) {
    const container = document.getElementById("gifts-container");
    container.innerHTML = '';
    
    let filtered = gifts;
    if(filter === 'badges') filtered = gifts.filter(g => g.type === 'badge');
    else if(filter !== 'all') filtered = gifts.filter(g => g.cat === filter || g.type === filter);

    filtered.forEach(g => {
        const qty = giftCart[g.id] || 0;
        const isBadge = g.type === 'badge';
        const div = document.createElement("div");
        div.className = "gift-item";
        div.innerHTML = `
            ${isBadge ? '<span class="badge-tag">Ù†Ø§Ø¯Ø±Ø©</span>' : ''}
            <div class="gift-icon">${g.icon}</div>
            <div class="gift-name">${g.name}</div>
            <div class="gift-info">${g.type === 'badge' ? g.info : (g.days ? '+' + g.days + ' ÙŠÙˆÙ…' : '+' + g.xp + ' XP')}</div>
            <div class="gift-price">${g.cost.toLocaleString()} ÙƒÙˆÙŠÙ†Ø²</div>
            <div class="qty-controls">
                <button class="qty-btn" onclick="updateQty(${g.id}, 1)">+</button>
                <span class="qty-num" id="qty-${g.id}">${qty}</span>
                <button class="qty-btn" onclick="updateQty(${g.id}, -1)">-</button>
            </div>
        `;
        container.appendChild(div);
    });
}

function filterGifts(cat, el) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    renderGifts(cat);
}

function updateQty(id, change) {
    const gift = gifts.find(g => g.id === id);
    let current = giftCart[id] || 0;
    let newVal = Math.max(0, current + change);
    
    // Ø§Ù„Ø´Ø§Ø±Ø§Øª ØªØ´ØªØ±Ù‰ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· ÙÙŠ ÙƒÙ„ Ø¹Ù…Ù„ÙŠØ©
    if (gift.type === 'badge' && newVal > 1) newVal = 1;
    
    if (newVal === 0) delete giftCart[id];
    else giftCart[id] = newVal;
    
    if(document.getElementById(`qty-${id}`)) document.getElementById(`qty-${id}`).innerText = newVal;
    calculateTotal();
}

function calculateTotal() {
    let cost = 0, xp = 0, days = 0;
    for (const id in giftCart) {
        const gift = gifts.find(g => g.id == id);
        cost += gift.cost * giftCart[id];
        if (gift.cat === 'pro') days += gift.days * giftCart[id];
        else if (gift.cat === 'xp' || gift.cat === 'luxury') xp += gift.xp * giftCart[id];
    }
    document.getElementById("total-cost-display").innerText = cost.toLocaleString();
    document.getElementById("total-xp-display").innerText = xp.toLocaleString();
    document.getElementById("total-pro-days").innerText = days;
    document.getElementById("send-gift-btn").disabled = cost === 0 || currentUserData.totalCoins < cost;
}

function selectSelf() {
    selectedPlayer = { uid: currentUserId, displayName: currentUserData.displayName };
    updateRecipientUI(currentUserData);
    document.getElementById("rec-name").innerText = "Ø£Ù†Øª (ØªØ·ÙˆÙŠØ± Ø­Ø³Ø§Ø¨Ùƒ)";
}

function updateRecipientUI(data) {
    const lvl = calculateLevel(data.xp || 0);
    document.getElementById("rec-avatar").innerText = data.displayName[0].toUpperCase();
    document.getElementById("rec-name").innerText = data.displayName;
    document.getElementById("rec-stats").innerHTML = `Ø§Ù„Ù…Ø³ØªÙˆÙ‰: ${lvl} | XP: ${data.xp || 0} | Ø´Ø§Ø±Ø§Øª: ${(data.badges || []).length}`;
}

function setupSearch() {
    const input = document.getElementById("player-search");
    const resultsDiv = document.getElementById("search-results");

    input.addEventListener("input", async () => {
        const query = input.value.trim();
        if (query.length < 2) { resultsDiv.innerHTML = ""; return; }

        const snap = await firebase.firestore().collection("users")
            .where("displayName", ">=", query).where("displayName", "<=", query + "\uf8ff")
            .limit(5).get();

        resultsDiv.innerHTML = "";
        snap.forEach(doc => {
            const data = doc.data();
            const lvl = calculateLevel(data.xp || 0);
            const item = document.createElement("div");
            item.className = "search-item";
            item.innerHTML = `
                <div class="user-avatar" style="width:30px; height:30px; font-size:0.8rem;">${data.displayName[0]}</div>
                <div>
                    <div style="font-weight:bold; font-size:0.85rem;">${data.displayName}</div>
                    <div style="font-size:0.65rem; color:#aaa;">Lvl: ${lvl} | XP: ${data.xp || 0}</div>
                </div>
            `;
            item.onclick = () => {
                selectedPlayer = { uid: doc.id, ...data };
                updateRecipientUI(data);
                resultsDiv.innerHTML = "";
                input.value = "";
            };
            resultsDiv.appendChild(item);
        });
    });
}

async function processPurchase() {
    const overlay = document.getElementById("purchase-overlay");
    let totalCost = 0, totalXP = 0, totalDays = 0;
    let badgesToGain = [];

    for (const id in giftCart) {
        const gift = gifts.find(g => g.id == id);
        totalCost += gift.cost * giftCart[id];
        if (gift.type === 'badge') badgesToGain.push(gift.icon);
        else if (gift.cat === 'pro') totalDays += gift.days * giftCart[id];
        else totalXP += gift.xp * giftCart[id];
    }

    if (currentUserData.totalCoins < totalCost) return alert("Ø§Ù„Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙ!");
    overlay.style.display = "flex";

    try {
        const db = firebase.firestore();
        const batch = db.batch();
        const senderRef = db.collection("users").doc(currentUserId);
        const recipientRef = db.collection("users").doc(selectedPlayer.uid);

        batch.update(senderRef, { totalCoins: firebase.firestore.FieldValue.increment(-totalCost) });

        let updates = {};
        if (totalXP > 0) updates.xp = firebase.firestore.FieldValue.increment(totalXP);
        if (badgesToGain.length > 0) updates.badges = firebase.firestore.FieldValue.arrayUnion(...badgesToGain);
        
        if (totalDays > 0) {
            const recipientDoc = await recipientRef.get();
            const currentExpiry = recipientDoc.data().proExpiryTime || Date.now();
            const base = currentExpiry > Date.now() ? currentExpiry : Date.now();
            updates.proExpiryTime = base + (totalDays * 24 * 60 * 60 * 1000);
        }

        batch.update(recipientRef, updates);
        await batch.commit();
        
        setTimeout(() => location.href = "index.html", 1500);
    } catch (e) {
        alert("ÙØ´Ù„ ÙÙŠ Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù…Ù„ÙƒÙŠØ©!");
        overlay.style.display = "none";
    }
}
</script>
</body>
</html>

