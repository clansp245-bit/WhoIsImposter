<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’ Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„Ù…Ù„ÙƒÙŠ Ø§Ù„Ø£Ø³Ø·ÙˆØ±ÙŠ</title>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="auth.js"></script> 

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        :root {
            --primary: #6366f1;
            --accent-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            --bg-body: #0a0f1e;
            --card-bg: rgba(30, 41, 59, 0.7);
            --text-main: #f1f5f9;
            --text-dim: #94a3b8;
            --gold: #ffd700;
            --success: #10b981;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-body);
            background-image: radial-gradient(circle at top right, #1e1b4b, transparent), radial-gradient(circle at bottom left, #1e1b4b, transparent);
            color: var(--text-main);
            padding: 10px;
            min-height: 100vh;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .top-info-bar { width: 100%; max-width: 500px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        #coins-display { background: rgba(251, 191, 36, 0.1); padding: 8px 15px; border-radius: 15px; color: var(--gold); font-weight: 900; border: 1px solid var(--gold); }

        .card {
            background: var(--card-bg); backdrop-filter: blur(15px); padding: 15px; border-radius: 20px;
            width: 100%; max-width: 500px; border: 1px solid rgba(255,255,255,0.1); text-align: right; box-sizing: border-box; margin-bottom: 12px;
        }

        .search-container { position: relative; flex-grow: 1; }
        input[type="text"] { width: 100%; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255,255,255,0.1); padding: 10px; border-radius: 10px; color: white; font-family: 'Cairo'; }
        
        .search-results { position: absolute; background: #1e293b; width: 100%; z-index: 100; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); top: 45px; overflow: hidden; border: 1px solid var(--primary); }
        .search-item { padding: 10px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; }

        .recipient-profile {
            display: flex; align-items: center; gap: 12px; background: rgba(99, 102, 241, 0.1);
            padding: 10px; border-radius: 15px; border: 1px dashed var(--primary); margin-top: 10px;
        }
        .user-avatar { width: 40px; height: 40px; background: var(--accent-gradient); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: 900; }

        .tabs { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; width: 100%; max-width: 500px; scrollbar-width: none; }
        .tab { padding: 8px 15px; background: rgba(255,255,255,0.05); border-radius: 20px; cursor: pointer; white-space: nowrap; font-weight: 700; font-size: 0.8rem; }
        .tab.active { background: var(--primary); color: white; }

        .gifts-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; width: 100%; }
        .gift-item { 
            background: rgba(255, 255, 255, 0.03); padding: 15px 5px; border-radius: 18px; border: 1px solid rgba(255,255,255,0.05);
            display: flex; flex-direction: column; align-items: center; text-align: center;
        }
        
        .gift-icon-container { 
            width: 60px; height: 60px; border-radius: 15px; background: rgba(255,255,255,0.05);
            display: flex; justify-content: center; align-items: center; font-size: 1.8rem; margin-bottom: 10px;
        }
        .badge-icon { color: var(--gold); text-shadow: 0 0 15px var(--gold); }
        .normal-icon { font-size: 2.2rem; }

        .gift-name { font-weight: 700; font-size: 0.85rem; }
        .gift-info { font-size: 0.7rem; color: var(--text-dim); margin-bottom: 5px; }
        .gift-price { color: var(--gold); font-weight: 900; font-size: 0.85rem; }

        .qty-controls { display: flex; align-items: center; gap: 8px; background: rgba(0,0,0,0.4); padding: 4px 10px; border-radius: 8px; margin-top: 8px; }
        .qty-btn { width: 25px; height: 25px; border: none; background: var(--primary); color: white; border-radius: 5px; cursor: pointer; font-weight: 900; }

        #cart-summary { background: rgba(16, 185, 129, 0.05); padding: 12px; border-radius: 15px; margin-top: 10px; border: 1px solid var(--success); text-align: center; }
        .send-btn { width: 100%; padding: 15px; border-radius: 15px; border: none; background: var(--accent-gradient); color: white; font-weight: 900; font-size: 1.1rem; cursor: pointer; margin-top: 10px; }
        .send-btn:disabled { opacity: 0.3; }

        #purchase-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000; display: none; flex-direction: column; justify-content: center; align-items: center; backdrop-filter: blur(10px); }
    </style>
</head>

<body onload="initGiftPage()">

<div class="top-info-bar">
    <a href="index.html" style="color: var(--text-dim); text-decoration: none;"><i class="fas fa-chevron-right"></i> Ø±Ø¬ÙˆØ¹</a>
    <div id="coins-display"><i class="fas fa-coins"></i> <span id="user-coins">0</span></div>
</div>

<h2 style="font-weight: 900; color: var(--gold); text-align: center;">ğŸ”± Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„Ù…Ù„ÙƒÙŠ Ø§Ù„Ø£Ø³Ø·ÙˆØ±ÙŠ</h2>

<div class="card">
    <div style="display: flex; gap: 8px; align-items: center;">
        <button id="self-gift-btn" onclick="selectSelf()" style="padding: 10px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 900; cursor: pointer;">Ù†ÙØ³ÙŠ</button>
        <div class="search-container">
            <input type="text" id="player-search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† ØµØ¯ÙŠÙ‚...">
            <div id="search-results" class="search-results"></div>
        </div>
    </div>
    
    <div id="recipient-profile-box" class="recipient-profile">
        <div class="user-avatar" id="rec-avatar"><i class="fas fa-user"></i></div>
        <div style="flex-grow: 1;">
            <div id="rec-name" style="font-weight: 900;">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙ„Ù…</div>
            <div id="rec-stats" style="font-size: 0.65rem; color: var(--text-dim);">Ø§ÙƒØªØ´Ù Ø£ØµØ¯Ù‚Ø§Ø¡ Ø¬Ø¯Ø¯ ÙˆØ£Ø±Ø³Ù„ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§</div>
        </div>
    </div>
</div>

<div class="tabs">
    <div class="tab active" onclick="filterGifts('all', this)">Ø§Ù„ÙƒÙ„</div>
    <div class="tab" onclick="filterGifts('badges', this)">Ø´Ø§Ø±Ø§Øª Ù†Ø§Ø¯Ø±Ø©</div>
    <div class="tab" onclick="filterGifts('simple', this)">Ù‡Ø¯Ø§ÙŠØ§ Ø¨Ø³ÙŠØ·Ø©</div>
    <div class="tab" onclick="filterGifts('luxury', this)">Ù‡Ø¯Ø§ÙŠØ§ Ù…Ù„ÙƒÙŠØ©</div>
    <div class="tab" onclick="filterGifts('pro', this)">Ø¹Ø¶ÙˆÙŠØ© Pro</div>
</div>

<div class="card" style="padding: 10px;">
    <div id="gifts-container" class="gifts-grid"></div>
    
    <div id="cart-summary">
        <div style="display: flex; justify-content: space-between; font-size: 0.75rem;">
            <span>XP: <b id="total-xp-display" style="color:var(--success)">0</b></span>
            <span>Ø¨Ø±Ùˆ: <b id="total-pro-days" style="color:var(--primary)">0</b> ÙŠÙˆÙ…</span>
        </div>
        <div style="font-weight: 900; font-size: 1.1rem; margin-top: 5px; color: var(--gold);">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="total-cost-display">0</span> ÙƒÙˆÙŠÙ†Ø²</div>
    </div>

    <button class="send-btn" id="send-gift-btn" disabled onclick="processPurchase()">ØªØ£ÙƒÙŠØ¯ ÙˆØ¥Ø±Ø³Ø§Ù„ <i class="fas fa-paper-plane"></i></button>
</div>

<div id="purchase-overlay">
    <i class="fas fa-gem fa-beat" style="font-size: 4rem; color: var(--gold);"></i>
    <h3 style="color: white; margin-top: 20px;">Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ÙƒÙ†ÙˆØ²...</h3>
</div>

<script>
let currentUserData = {};
let selectedPlayer = { uid: null, displayName: "Ù†ÙØ³Ùƒ" }; 
let giftCart = {}; 
let currentUserId = null;

const gifts = [
    // --- Ø§Ù„Ø´Ø§Ø±Ø§Øª (Badges) - ØªØ³ØªØ®Ø¯Ù… Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Font Awesome ---
    {id: 100, name:"Ø§Ù„Ø£Ø³Ø·ÙˆØ±Ø©", cost:10000, type: 'badges', icon:"fas fa-shield-halved", isBadge: true, info: "ØªØ¸Ù‡Ø± Ù„Ù„Ø£Ø¨Ø¯"},
    {id: 101, name:"Ø§Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±", cost:8500, type: 'badges', icon:"fas fa-crown", isBadge: true, info: "Ø³ÙŠØ§Ø¯Ø© Ù…Ø·Ù„Ù‚Ø©"},
    {id: 102, name:"Ø§Ù„ØªÙ†ÙŠÙ†", cost:7000, type: 'badges', icon:"fas fa-dragon", isBadge: true, info: "Ù‚ÙˆØ© Ù†Ø§Ø±ÙŠØ©"},
    {id: 103, name:"Ø§Ù„Ù…Ø­Ø§Ø±Ø¨", cost:5500, type: 'badges', icon:"fas fa-hand-fist", isBadge: true, info: "Ø´Ø¬Ø§Ø¹Ø©"},
    {id: 104, name:"Ø§Ù„Ù…Ø§Ø³Ø©", cost:4000, type: 'badges', icon:"fas fa-gem", isBadge: true, info: "Ù„Ù…Ø¹Ø§Ù† Ù…Ù„ÙƒÙŠ"},
    {id: 105, name:"Ø§Ù„Ø¨Ø±Ù‚", cost:2500, type: 'badges', icon:"fas fa-bolt", isBadge: true, info: "Ø³Ø±Ø¹Ø©"},
    {id: 106, name:"Ø§Ù„Ù†Ø¬Ù…", cost:1500, type: 'badges', icon:"fas fa-star", isBadge: true, info: "Ù†Ø¬Ù… Ø³Ø§Ø·Ø¹"},
    {id: 107, name:"Ø§Ù„Ù…Ø­Ø¨Ø©", cost:1000, type: 'badges', icon:"fas fa-heart", isBadge: true, info: "Ù‚Ù„Ø¨ Ø°Ù‡Ø¨ÙŠ"},

    // --- Ù‡Ø¯Ø§ÙŠØ§ ÙˆØ§Ø´ØªØ±Ø§ÙƒØ§Øª (ØªØ³ØªØ®Ø¯Ù… Ø¥ÙŠÙ…ÙˆØ¬ÙŠ) ---
    {id: 1, name:"ÙˆØ±Ø¯Ø©", cost:50, xp:25, icon:"ğŸŒ¹", cat: 'simple'},
    {id: 2, name:"Ø¨ÙŠØªØ²Ø§", cost:200, xp:110, icon:"ğŸ•", cat: 'simple'},
    {id: 3, name:"Ø³Ø§Ø¹Ø©", cost:500, xp:300, icon:"âŒš", cat: 'simple'},
    {id: 4, name:"Ø­Ù‚ÙŠØ¨Ø©", cost:1000, xp:650, icon:"ğŸ’¼", cat: 'simple'},
    {id: 5, name:"Ø¨Ø±Ø¬Ø±", cost:150, xp:80, icon:"ğŸ”", cat: 'simple'},
    {id: 6, name:"Ø¢ÙŠØ³ ÙƒØ±ÙŠÙ…", cost:80, xp:40, icon:"ğŸ¦", cat: 'simple'},
    {id: 7, name:"Ù„Ø§Ø¨ØªÙˆØ¨", cost:3000, xp:1500, icon:"ğŸ’»", cat: 'simple'},
    {id: 8, name:"Ù‡Ø§ØªÙ", cost:2000, xp:1200, icon:"ğŸ“±", cat: 'simple'},

    {id: 20, name:"Ø®Ø§ØªÙ…", cost:5000, xp:3000, icon:"ğŸ’", cat: 'luxury'},
    {id: 21, name:"Ø³ÙŠØ§Ø±Ø©", cost:15000, xp:10000, icon:"ğŸï¸", cat: 'luxury'},
    {id: 22, name:"Ø·Ø§Ø¦Ø±Ø©", cost:50000, xp:35000, icon:"âœˆï¸", cat: 'luxury'},
    {id: 23, name:"Ù‚ØµØ±", cost:150000, xp:110000, icon:"ğŸ°", cat: 'luxury'},
    {id: 24, name:"Ø¬Ø²ÙŠØ±Ø©", cost:500000, xp:400000, icon:"ğŸï¸", cat: 'luxury'},
    {id: 25, name:"ÙƒÙˆÙƒØ¨", cost:1000000, xp:850000, icon:"ğŸª", cat: 'luxury'},

    {id: 30, name:"Ø¨Ø±Ùˆ Ø£Ø³Ø¨ÙˆØ¹", cost:150, days: 7, icon:"â­", cat: 'pro'},
    {id: 31, name:"Ø¨Ø±Ùˆ Ø´Ù‡Ø±", cost:450, days: 30, icon:"ğŸ†", cat: 'pro'},
    {id: 32, name:"Ø¨Ø±Ùˆ Ø³Ù†Ø©", cost:2414, days: 365, icon:"ğŸ‘‘", cat: 'pro'}
];

function calculateLevel(xp) { return Math.floor(Math.sqrt(xp / 100)) + 1; }

async function initGiftPage() {
    renderGifts('all');
    firebase.auth().onAuthStateChanged(async user => {
        if(!user) return window.location.href="auth.html";
        currentUserId = user.uid; 
        const data = await loadUserData();
        if(data) {
            currentUserData = data;
            document.getElementById("user-coins").innerText = (data.totalCoins || 0).toLocaleString();
            selectSelf();
            setupSearch();
        }
    });
}

function renderGifts(filter) {
    const container = document.getElementById("gifts-container");
    container.innerHTML = '';
    
    // Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ÙÙ„ØªØ±Ø©: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† cat Ùˆ type
    let filtered = gifts;
    if(filter !== 'all') {
        filtered = gifts.filter(g => g.cat === filter || g.type === filter);
    }

    filtered.forEach(g => {
        const qty = giftCart[g.id] || 0;
        const div = document.createElement("div");
        div.className = "gift-item";
        
        // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø§Ù„Ø´Ø§Ø±Ø© ÙÙ‚Ø· ØªØ¸Ù‡Ø± ÙƒØ£ÙŠÙ‚ÙˆÙ†Ø©
        const iconHTML = g.isBadge 
            ? `<i class="${g.icon} badge-icon"></i>` 
            : `<span class="normal-icon">${g.icon}</span>`;

        div.innerHTML = `
            <div class="gift-icon-container">${iconHTML}</div>
            <div class="gift-name">${g.name}</div>
            <div class="gift-info">${g.isBadge ? g.info : (g.days ? '+' + g.days + ' ÙŠÙˆÙ…' : '+' + g.xp + ' XP')}</div>
            <div class="gift-price">${g.cost.toLocaleString()} <i class="fas fa-coins" style="font-size:0.7rem"></i></div>
            <div class="qty-controls">
                <button class="qty-btn" onclick="updateQty(${g.id}, 1)">+</button>
                <span class="qty-num" id="qty-${g.id}">${qty}</span>
                <button class="qty-btn" onclick="updateQty(${g.id}, -1)">-</button>
            </div>
        `;
        container.appendChild(div);
    });
}

function filterGifts(cat, el) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    renderGifts(cat);
}

function updateQty(id, change) {
    const gift = gifts.find(g => g.id === id);
    let current = giftCart[id] || 0;
    let newVal = Math.max(0, current + change);
    if (gift.isBadge && newVal > 1) newVal = 1;
    if (newVal === 0) delete giftCart[id];
    else giftCart[id] = newVal;
    if(document.getElementById(`qty-${id}`)) document.getElementById(`qty-${id}`).innerText = newVal;
    calculateTotal();
}

function calculateTotal() {
    let cost = 0, xp = 0, days = 0;
    for (const id in giftCart) {
        const gift = gifts.find(g => g.id == id);
        cost += gift.cost * giftCart[id];
        if (gift.cat === 'pro') days += gift.days * giftCart[id];
        else if (gift.xp) xp += gift.xp * giftCart[id];
    }
    document.getElementById("total-cost-display").innerText = cost.toLocaleString();
    document.getElementById("total-xp-display").innerText = xp.toLocaleString();
    document.getElementById("total-pro-days").innerText = days;
    document.getElementById("send-gift-btn").disabled = cost === 0 || currentUserData.totalCoins < cost;
}

function selectSelf() {
    selectedPlayer = { uid: currentUserId, displayName: currentUserData.displayName };
    updateRecipientUI(currentUserData);
}

function updateRecipientUI(data) {
    const lvl = calculateLevel(data.xp || 0);
    document.getElementById("rec-avatar").innerHTML = `<i class="fas fa-user"></i>`;
    document.getElementById("rec-name").innerText = data.displayName + (data.uid === currentUserId ? " (Ø£Ù†Øª)" : "");
    document.getElementById("rec-stats").innerHTML = `Ø§Ù„Ù…Ø³ØªÙˆÙ‰: ${lvl} | XP: ${data.xp || 0}`;
}

function setupSearch() {
    const input = document.getElementById("player-search");
    const resultsDiv = document.getElementById("search-results");
    input.addEventListener("input", async () => {
        const query = input.value.trim();
        if (query.length < 2) { resultsDiv.innerHTML = ""; return; }
        const snap = await firebase.firestore().collection("users")
            .where("displayName", ">=", query).where("displayName", "<=", query + "\uf8ff")
            .limit(5).get();
        resultsDiv.innerHTML = "";
        snap.forEach(doc => {
            const data = doc.data();
            const item = document.createElement("div");
            item.className = "search-item";
            item.innerHTML = `<div class="user-avatar" style="width:30px; height:30px;">${data.displayName[0]}</div>
                              <div style="font-size:0.8rem; font-weight:bold;">${data.displayName}</div>`;
            item.onclick = () => {
                selectedPlayer = { uid: doc.id, ...data };
                updateRecipientUI(data);
                resultsDiv.innerHTML = "";
                input.value = "";
            };
            resultsDiv.appendChild(item);
        });
    });
}

async function processPurchase() {
    const overlay = document.getElementById("purchase-overlay");
    let totalCost = 0, totalXP = 0, totalDays = 0;
    let badgesToGain = [];

    for (const id in giftCart) {
        const gift = gifts.find(g => g.id == id);
        totalCost += gift.cost * giftCart[id];
        // Ø­ÙØ¸ ÙƒÙ„Ø§Ø³ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙÙŠ Ù…ØµÙÙˆÙØ© Ø§Ù„Ø´Ø§Ø±Ø§Øª
        if (gift.isBadge) badgesToGain.push(gift.icon);
        else if (gift.cat === 'pro') totalDays += gift.days * giftCart[id];
        else if (gift.xp) totalXP += gift.xp * giftCart[id];
    }

    if (currentUserData.totalCoins < totalCost) return alert("Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ!");
    overlay.style.display = "flex";

    try {
        const db = firebase.firestore();
        const batch = db.batch();
        const senderRef = db.collection("users").doc(currentUserId);
        const recipientRef = db.collection("users").doc(selectedPlayer.uid);

        batch.update(senderRef, { totalCoins: firebase.firestore.FieldValue.increment(-totalCost) });

        let updates = {};
        if (totalXP > 0) updates.xp = firebase.firestore.FieldValue.increment(totalXP);
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø§Ø±Ø§Øª Ù„Ù„Ù…ØµÙÙˆÙØ© ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
        if (badgesToGain.length > 0) updates.badges = firebase.firestore.FieldValue.arrayUnion(...badgesToGain);
        
        if (totalDays > 0) {
            const recipientDoc = await recipientRef.get();
            const currentExpiry = recipientDoc.data().proExpiryTime || Date.now();
            const base = currentExpiry > Date.now() ? currentExpiry : Date.now();
            updates.proExpiryTime = base + (totalDays * 24 * 60 * 60 * 1000);
        }

        batch.update(recipientRef, updates);
        await batch.commit();
        
        setTimeout(() => location.href = "index.html", 1500);
    } catch (e) {
        alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„!");
        overlay.style.display = "none";
    }
}
</script>
</body>
</html>

