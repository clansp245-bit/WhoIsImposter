<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’ Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„Ù…Ù„ÙƒÙŠ Ø§Ù„Ø£Ø³Ø·ÙˆØ±ÙŠ</title>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="auth.js"></script> 

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        :root {
            --primary: #6366f1;
            --accent-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            --bg-body: #0a0f1e;
            --card-bg: rgba(30, 41, 59, 0.7);
            --text-main: #f1f5f9;
            --text-dim: #94a3b8;
            --gold: #ffd700;
            --pro-color: #f472b6;
            --tool-color: #38bdf8;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-body);
            background-image: radial-gradient(circle at top right, #1e1b4b, transparent);
            color: var(--text-main);
            padding: 10px; margin: 0;
            display: flex; flex-direction: column; align-items: center;
        }

        .top-info-bar { width: 100%; max-width: 500px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        #coins-display { background: rgba(251, 191, 36, 0.1); padding: 8px 15px; border-radius: 15px; color: var(--gold); font-weight: 900; border: 1px solid var(--gold); }

        .card {
            background: var(--card-bg); backdrop-filter: blur(15px); padding: 15px; border-radius: 20px;
            width: 100%; max-width: 500px; border: 1px solid rgba(255,255,255,0.1); box-sizing: border-box; margin-bottom: 12px;
            position: relative;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØµÙ„Ø­ */
        .search-box-container { position: relative; width: 100%; }
        #player-search {
            width: 100%; padding: 12px; border-radius: 12px; 
            background: rgba(15, 23, 42, 0.9); border: 1px solid var(--primary); 
            color: white; font-family: 'Cairo'; box-sizing: border-box;
        }
        .search-results-list {
            position: absolute; top: 50px; left: 0; right: 0; 
            background: #1e293b; border-radius: 12px; z-index: 100;
            max-height: 200px; overflow-y: auto; border: 1px solid rgba(255,255,255,0.1);
            display: none; box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        .search-item {
            padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05);
            cursor: pointer; transition: 0.2s; display: flex; justify-content: space-between;
        }
        .search-item:hover { background: var(--primary); }

        .tabs { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; width: 100%; max-width: 500px; scrollbar-width: none; padding: 5px 0; }
        .tab { padding: 8px 18px; background: rgba(255,255,255,0.05); border-radius: 20px; cursor: pointer; white-space: nowrap; font-size: 0.8rem; border: 1px solid transparent; }
        .tab.active { background: var(--primary); border-color: var(--tool-color); }

        .gifts-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; width: 100%; }
        .gift-item { 
            background: rgba(255, 255, 255, 0.03); padding: 15px 5px; border-radius: 18px; border: 1px solid rgba(255,255,255,0.05);
            display: flex; flex-direction: column; align-items: center; text-align: center; position: relative;
        }
        
        .gift-icon-container { width: 60px; height: 60px; font-size: 2rem; display: flex; align-items: center; justify-content: center; margin-bottom: 8px; }
        .badge-icon { color: var(--gold); }
        .tool-icon { color: var(--tool-color); }
        .pro-exclusive-tag { position: absolute; top: 8px; right: 8px; background: var(--pro-color); color: white; font-size: 0.55rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; }

        .qty-controls { display: flex; align-items: center; gap: 15px; margin-top: 10px; background: rgba(0,0,0,0.2); padding: 5px 12px; border-radius: 10px; }
        .qty-btn { background: var(--primary); border: none; color: white; width: 25px; height: 25px; border-radius: 5px; cursor: pointer; }

        .send-btn { width: 100%; padding: 15px; border-radius: 15px; border: none; background: var(--accent-gradient); color: white; font-weight: 900; cursor: pointer; margin-top: 10px; }
        #purchase-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; display: none; flex-direction: column; justify-content: center; align-items: center; }
    </style>
</head>

<body onload="initGiftPage()">

<div class="top-info-bar">
    <a href="index.html" style="color: var(--text-dim); text-decoration: none;"><i class="fas fa-chevron-right"></i> Ø±Ø¬ÙˆØ¹</a>
    <div id="coins-display"><i class="fas fa-coins"></i> <span id="user-coins">0</span></div>
</div>

<div class="card">
    <div class="search-box-container">
        <input type="text" id="player-search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù€ ID...">
        <div id="search-results" class="search-results-list"></div>
    </div>
    <div id="rec-info" style="margin-top: 10px; font-size: 0.85rem; color: var(--tool-color);">
        Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰: <span id="rec-name" style="color: white; font-weight: bold;">Ù†ÙØ³ÙŠ (Ø£Ù†Øª)</span>
    </div>
</div>

<div class="tabs">
    <div class="tab active" onclick="filterGifts('all', this)">ğŸ Ø§Ù„ÙƒÙ„</div>
    <div class="tab" onclick="filterGifts('tools', this)">ğŸ› ï¸ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</div>
    <div class="tab" onclick="filterGifts('pro', this)">ğŸ”¥ Ù‡Ø¯Ø§ÙŠØ§ Ø¨Ø±Ùˆ</div>
    <div class="tab" onclick="filterGifts('badges', this)">ğŸ… Ø§Ù„Ø´Ø§Ø±Ø§Øª</div>
    <div class="tab" onclick="filterGifts('luxury', this)">ğŸ’ Ù…Ù„ÙƒÙŠ</div>
    <div class="tab" onclick="filterGifts('cheap', this)">ğŸˆ Ø¨Ø³ÙŠØ·Ø©</div>
</div>

<div class="card">
    <div id="gifts-container" class="gifts-grid"></div>
    <div style="margin-top: 20px; text-align: center; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
        <div style="font-size: 0.9rem; color: var(--text-dim);">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒÙ„ÙØ©</div>
        <div id="total-cost" style="font-size: 1.5rem; color: var(--gold); font-weight: 900;">0</div>
        <button class="send-btn" id="send-btn" disabled onclick="processPurchase()">ØªØ£ÙƒÙŠØ¯ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§</button>
    </div>
</div>

<div id="purchase-overlay">
    <i class="fas fa-magic fa-spin" style="font-size: 3rem; color: var(--primary);"></i>
    <p>Ø¬Ø§Ø±ÙŠ Ø³Ø­Ø± Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§...</p>
</div>

<script>
const db = firebase.firestore();
let currentUserData = {};
let selectedPlayerUid = null;
let cart = {};

const gifts = [
    // Ø¨Ø·Ø§Ù‚Ø§Øª
    {id: 50, name:"Ø¨Ø·Ø§Ù‚Ø© ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…", cost:500, cat:"tools", icon:"fas fa-id-card", isTool: true},
    {id: 51, name:"Ø¨Ø·Ø§Ù‚Ø© ØªØºÙŠÙŠØ± ID", cost:1000000, cat:"tools", icon:"fas fa-fingerprint", isTool: true},
    // Ø´Ø§Ø±Ø§Øª
    {id: 100, name:"Ø´Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø·ÙˆØ±Ø©", cost:25000, cat:"badges", icon:"fas fa-shield-halved", isBadge: true},
    {id: 101, name:"ØªØ§Ø¬ Ø§Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±", cost:20000, cat:"badges", icon:"fas fa-crown", isBadge: true},
    {id: 102, name:"Ø§Ù„ØªÙ†ÙŠÙ† Ø§Ù„Ù…Ù„ÙƒÙŠ", cost:15000, cat:"badges", icon:"fas fa-dragon", isBadge: true},
    // Ø¨Ø±Ùˆ
    {id: 60, name:"Ø³ÙŠØ§Ø±Ø© Ø¨Ø±Ùˆ Ø°Ù‡Ø¨ÙŠØ©", cost:30000, cat:"pro", icon:"fas fa-car-side", proOnly: true, xp: 15000},
    {id: 61, name:"ÙŠØ®Øª Ø§Ù„Ø¨Ø±Ùˆ", cost:75000, cat:"pro", icon:"fas fa-ship", proOnly: true, xp: 40000},
    {id: 62, name:"ØµØ§Ø±ÙˆØ® ÙØ¶Ø§Ø¦ÙŠ", cost:500000, cat:"pro", icon:"fas fa-rocket", proOnly: true, xp: 250000},
    {id: 63, name:"Ø®Ø§ØªÙ… Ø§Ù„Ù…Ø§Ø³ Ø¨Ø±Ùˆ", cost:5000, cat:"pro", icon:"fas fa-ring", proOnly: true, xp: 2500},
    // ØºØ§Ù„ÙŠ ÙˆÙ…Ù„ÙƒÙŠ
    {id: 200, name:"Ù‚ØµØ± Ø§Ù„ØµÙŠÙ", cost:150000, cat:"luxury", icon:"ğŸ°", xp: 80000},
    {id: 201, name:"Ø¬Ø²ÙŠØ±Ø© Ø®Ø§ØµØ©", cost:300000, cat:"luxury", icon:"ğŸï¸", xp: 180000},
    {id: 202, name:"Ø·Ø§Ø¦Ø±Ø© Ø¨ÙˆÙŠÙ†Ø¬", cost:100000, cat:"luxury", icon:"âœˆï¸", xp: 55000},
    {id: 203, name:"Ø¨Ø±Ø¬ Ø¯Ø¨ÙŠ", cost:800000, cat:"luxury", icon:"ğŸ™ï¸", xp: 500000},
    // Ø±Ø®ÙŠØµ ÙˆØ¨Ø³ÙŠØ·
    {id: 1, name:"ÙˆØ±Ø¯Ø© Ø­Ù…Ø±Ø§Ø¡", cost:20, cat:"cheap", icon:"ğŸŒ¹", xp: 10},
    {id: 2, name:"Ù‚Ù„Ø¨ Ø­Ø¨", cost:50, cat:"cheap", icon:"â¤ï¸", xp: 30},
    {id: 3, name:"Ø¨ÙŠØªØ²Ø§", cost:120, cat:"cheap", icon:"ğŸ•", xp: 70},
    {id: 4, name:"Ù‚Ù‡ÙˆØ©", cost:15, cat:"cheap", icon:"â˜•", xp: 5},
    {id: 5, name:"Ø¯ÙˆÙ†Ø§Øª", cost:30, cat:"cheap", icon:"ğŸ©", xp: 15}
];

// Ø¥Ø¶Ø§ÙØ© Ù‡Ø¯Ø§ÙŠØ§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù„ØªÙƒÙ…Ù„Ø© Ø§Ù„Ù€ 50
for(let i=1; i<=30; i++) {
    gifts.push({
        id: 300+i, 
        name: "Ù‡Ø¯ÙŠØ© Ø±Ù‚Ù… " + i, 
        cost: 100 * i, 
        cat: i % 2 == 0 ? "luxury" : "cheap", 
        icon: "ğŸ", 
        xp: 50 * i
    });
}

async function initGiftPage() {
    firebase.auth().onAuthStateChanged(async user => {
        if(!user) return location.href="auth.html";
        selectedPlayerUid = user.uid;
        const doc = await db.collection('users').doc(user.uid).get();
        currentUserData = doc.data();
        document.getElementById("user-coins").innerText = currentUserData.totalCoins.toLocaleString();
        setupSearch();
        renderGifts('all');
    });
}

function setupSearch() {
    const input = document.getElementById('player-search');
    const results = document.getElementById('search-results');

    input.addEventListener('input', async () => {
        const val = input.value.trim();
        if(val.length < 2) { results.style.display = 'none'; return; }

        // Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù€ UID
        const snap = await db.collection('users')
            .where('displayName', '>=', val)
            .where('displayName', '<=', val + '\uf8ff')
            .limit(5).get();

        results.innerHTML = '';
        if(snap.empty) {
            results.innerHTML = '<div class="search-item">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
        } else {
            snap.forEach(doc => {
                const data = doc.data();
                const div = document.createElement('div');
                div.className = 'search-item';
                div.innerHTML = `<span>${data.displayName}</span> <small style="color:gray">ID: ${doc.id.substring(0,6)}...</small>`;
                div.onclick = () => {
                    selectedPlayerUid = doc.id;
                    document.getElementById('rec-name').innerText = data.displayName;
                    results.style.display = 'none';
                    input.value = '';
                };
                results.appendChild(div);
            });
        }
        results.style.display = 'block';
    });
}

function renderGifts(filter) {
    const container = document.getElementById("gifts-container");
    container.innerHTML = '';
    
    const isPro = (currentUserData.proExpiryTime || 0) > Date.now();

    gifts.forEach(g => {
        if(filter !== 'all' && g.cat !== filter) return;
        
        const div = document.createElement("div");
        div.className = "gift-item";
        let iconHtml = g.icon.includes('fa-') ? `<i class="${g.icon} ${g.isBadge?'badge-icon':'tool-icon'}"></i>` : `<span>${g.icon}</span>`;
        
        div.innerHTML = `
            ${g.proOnly ? '<span class="pro-exclusive-tag">PRO</span>' : ''}
            <div class="gift-icon-container">${iconHtml}</div>
            <div style="font-size:0.8rem; font-weight:bold;">${g.name}</div>
            <div style="color:var(--gold); font-size:0.75rem;">${g.cost.toLocaleString()} ÙƒÙˆÙŠÙ†</div>
            <div class="qty-controls">
                <button class="qty-btn" onclick="changeQty(${g.id}, 1)">+</button>
                <b id="qty-${g.id}">${cart[g.id] || 0}</b>
                <button class="qty-btn" onclick="changeQty(${g.id}, -1)">-</button>
            </div>
        `;
        container.appendChild(div);
    });
}

function changeQty(id, delta) {
    const gift = gifts.find(g => g.id === id);
    const isPro = (currentUserData.proExpiryTime || 0) > Date.now();
    
    if(gift.proOnly && !isPro) return alert("Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ± Ù„Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ø¨Ø±Ùˆ ÙÙ‚Ø·!");

    cart[id] = Math.max(0, (cart[id] || 0) + delta);
    if(gift.isBadge || gift.isTool) cart[id] = Math.min(cart[id], 1);

    document.getElementById(`qty-${id}`).innerText = cart[id];
    updateTotal();
}

function updateTotal() {
    let total = 0;
    for(let id in cart) {
        const gift = gifts.find(g => g.id == id);
        total += gift.cost * cart[id];
    }
    document.getElementById("total-cost").innerText = total.toLocaleString();
    document.getElementById("send-btn").disabled = total === 0 || total > currentUserData.totalCoins;
}

function filterGifts(cat, el) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    renderGifts(cat);
}

async function processPurchase() {
    document.getElementById("purchase-overlay").style.display = "flex";
    const batch = db.batch();
    const myRef = db.collection('users').doc(firebase.auth().currentUser.uid);
    const targetRef = db.collection('users').doc(selectedPlayerUid);

    let totalCost = 0;
    for(let id in cart) {
        if(cart[id] > 0) {
            const gift = gifts.find(g => g.id == id);
            totalCost += gift.cost * cart[id];
            
            if(gift.isBadge) batch.update(targetRef, { badges: firebase.firestore.FieldValue.arrayUnion(gift.icon) });
            else if(gift.isTool) batch.update(targetRef, { inventory: firebase.firestore.FieldValue.arrayUnion(gift.name) });
            else batch.update(targetRef, { xp: firebase.firestore.FieldValue.increment(gift.xp * cart[id]) });
        }
    }

    try {
        batch.update(myRef, { totalCoins: firebase.firestore.FieldValue.increment(-totalCost) });
        await batch.commit();
        alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø¨Ù†Ø¬Ø§Ø­!");
        location.reload();
    } catch(e) {
        alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©!");
    }
}
</script>
</body>
</html>
