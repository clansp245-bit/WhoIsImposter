<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ‘¤ Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ</title>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="auth.js"></script> <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
body{
    font-family:'Cairo',sans-serif;
    background:#0f172a;
    color:#f1f5f9;
    text-align:center;
    padding:20px
}
h2 {
    color: #34d399;
}
.card{
    background:#1e293b;
    padding:25px;
    border-radius:12px;
    max-width:450px;
    margin:20px auto;
    text-align:right;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 10px 15px rgba(0, 0, 0, 0.2);
}
.info-item{
    display:flex;
    justify-content:space-between;
    padding:8px 0;
    border-bottom:1px solid #334155;
    font-weight: 700;
}
input,button{
    width:100%;
    padding:12px;
    border-radius:8px;
    border:none;
    font-family:'Cairo';
    box-sizing: border-box;
}
input{
    background:#334155;
    color:white;
    margin-bottom:10px;
    font-size: 16px;
}
button{
    background:#34d399;
    color:white;
    font-weight:700;
    cursor:pointer;
    transition: background-color 0.3s;
}
button:hover:enabled {
    background: #10b981;
}
button:disabled{
    background:#475569;
    cursor:not-allowed
}
#error{
    margin-top:10px;
    font-size:14px;
    min-height: 20px;
}
</style>
</head>

<body>

<h2>ğŸ‘¤ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h2>

<div class="card">
    <div class="info-item"><span>Ø§Ù„Ø¨Ø±ÙŠØ¯</span><span id="email">...</span></div>
    <div class="info-item"><span>Ø§Ù„Ù…Ø³ØªÙˆÙ‰</span><span id="level">...</span></div>
    <div class="info-item"><span>XP</span><span id="xp">...</span></div>
    <div class="info-item"><span>Ø§Ù„Ø­Ø§Ù„Ø©</span><span id="status">...</span></div>
    <div class="info-item"><span>Ø§Ù„ÙƒÙˆÙŠÙ†Ø²</span><span id="coins">...</span></div>
</div>

<div class="card">
    <h3>ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶</h3>
    <p id="costText" style="color:#facc15;font-weight:700"></p>
    <input id="nameInput" disabled placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙŠØ¯">
    <button id="saveBtn" disabled>Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±</button>
    <div id="error"></div>
</div>

<button id="back-btn" onclick="location.href='index.html'" style="background: #6366f1; width: 450px; max-width: 90%; margin-top: 20px;">
    Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¹Ø¨Ø© <i class="fas fa-arrow-right"></i>
</button>

<script>
let userData=null;
let isSaving=false;
const BASE_COST=500;

const nameInput=document.getElementById("nameInput");
const saveBtn=document.getElementById("saveBtn");
const errorBox=document.getElementById("error");
const costText=document.getElementById("costText");

// ------------------------------------------------------------------
// 1. Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© (Ù…ØµØ­Ø­)
// ------------------------------------------------------------------

firebase.auth().onAuthStateChanged(async user=>{
    if(!user) return location.href="auth.html";
    
    // ğŸš¨ ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firestore
    userData = await loadUserData(); 
    
    if (!userData) {
        document.getElementById("status").innerText="ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
        errorBox.innerText = "âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Firestore.";
        return;
    }

    // ğŸš¨ Ø¶Ù…Ø§Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¥Ø°Ø§ Ù„Ù… ØªØ±Ø¯ Ù…Ù† Firestore
    userData.hasChangedNameBefore = userData.hasChangedNameBefore ?? false;
    userData.proExpiryTime = userData.proExpiryTime ?? 0;
    userData.dailyDiscount = userData.dailyDiscount ?? {date: null, percent: 0};


    // Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    document.getElementById("email").innerText=user.email;
    document.getElementById("level").innerText=userData.level || 1;
    document.getElementById("xp").innerText=userData.xp || 0;
    document.getElementById("coins").innerText=userData.totalCoins || 0;

    // ğŸš¨ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Pro
    const isPro = userData.proExpiryTime > Date.now();
    document.getElementById("status").innerHTML=isPro ? "Pro ğŸ‘‘" : "Ø¹Ø§Ø¯ÙŠ";

    nameInput.value = user.displayName || user.email.split("@")[0];
    nameInput.disabled = false;

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙƒÙ„ÙØ© Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø­Ø§Ù„Ø© Pro ÙˆØ§Ù„Ø®ØµÙˆÙ…Ø§Øª
    await updateCost(isPro);
    validate();
});

// ------------------------------------------------------------------
// 2. Ù…Ù†Ø·Ù‚ ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø±
// ------------------------------------------------------------------

nameInput.addEventListener("input",validate);

function validate(){
    const current=nameInput.value.trim();
    const original=firebase.auth().currentUser?.displayName || firebase.auth().currentUser?.email.split("@")[0];
    
    // ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„Ø­ÙØ¸: Ù„ÙŠØ³ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸ØŒ Ø£Ø·ÙˆÙ„ Ù…Ù† 3 Ø£Ø­Ø±ÙØŒ ÙˆÙ…Ø®ØªÙ„Ù Ø¹Ù† Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ.
    saveBtn.disabled = isSaving || current.length < 3 || current === original;
}

async function isNameAvailable(name){
    // Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø§Ù„ÙˆØ§Ø³Ø¹Ø© Ù„Ù„Ù‚Ø±Ø§Ø¡Ø©
    const snap=await firebase.firestore()
        .collection("users")
        .where("displayName","==",name)
        .limit(1).get();

    return snap.empty || snap.docs[0].id === firebase.auth().currentUser.uid;
}

// ------------------------------------------------------------------
// 3. Ù…Ù†Ø·Ù‚ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙƒÙ„ÙØ© (Ù…ØµØ­Ø­)
// ------------------------------------------------------------------

async function updateCost(isPro){
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø£ÙˆÙ„ ØªØºÙŠÙŠØ± Ø§Ø³Ù…ØŒ ÙØ§Ù„ØªÙƒÙ„ÙØ© ØµÙØ±
    if(!userData.hasChangedNameBefore){
        costText.innerText="ğŸ‰ Ø£ÙˆÙ„ ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ù…Ø¬Ø§Ù†ÙŠ";
        userData.finalCost=0;
        return;
    }

    let cost=BASE_COST;
    costText.innerText=`ğŸ’° ØªÙƒÙ„ÙØ© Ø§Ù„ØªØºÙŠÙŠØ±: ${BASE_COST} ÙƒÙˆÙŠÙ†Ø²`; // Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©

    if(isPro){
        const today=new Date().toDateString();
        let currentDiscount = userData.dailyDiscount;
        
        // ğŸš¨ Ø¥Ù†Ø´Ø§Ø¡ Ø®ØµÙ… Ø¬Ø¯ÙŠØ¯ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙŠÙˆÙ… Ù…Ø®ØªÙ„ÙØ§Ù‹
        if(!currentDiscount || currentDiscount.date !== today){
            // ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Firestore
            const percent=Math.floor(Math.random()*46)+5;
            await firebase.firestore().collection("users")
                .doc(firebase.auth().currentUser.uid)
                .set({dailyDiscount:{date:today,percent}}, {merge:true});
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸
            userData.dailyDiscount = {date:today,percent};
            currentDiscount = userData.dailyDiscount;
        }
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙƒÙ„ÙØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø®ØµÙ…
        cost = Math.floor(BASE_COST * (1 - currentDiscount.percent/100));
        costText.innerText=`ğŸ‘‘ Ø®ØµÙ… Ø§Ù„ÙŠÙˆÙ… ${currentDiscount.percent}% â†’ ${cost} ÙƒÙˆÙŠÙ†Ø²`;
    }

    userData.finalCost=cost;
}

// ------------------------------------------------------------------
// 4. Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ« (Ù…ØµØ­Ø­ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… saveUserData)
// ------------------------------------------------------------------

saveBtn.onclick=async()=>{
    if(isSaving) return;
    isSaving=true;
    saveBtn.disabled=true;
    errorBox.innerText="";

    const user=firebase.auth().currentUser;
    const newName=nameInput.value.trim();

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆØ§ÙØ± Ø§Ù„Ø§Ø³Ù…
    if(!(await isNameAvailable(newName))){
        errorBox.innerText="âŒ Ø§Ù„Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„";
        errorBox.style.color="#ef4444";
        isSaving=false;
        validate();
        return;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆÙŠÙ†Ø²
    if(userData.totalCoins < userData.finalCost){
        errorBox.innerText=`âŒ ÙƒÙˆÙŠÙ†Ø² ØºÙŠØ± ÙƒØ§ÙÙŠØ©. Ù…Ø·Ù„ÙˆØ¨ ${userData.finalCost} ÙƒÙˆÙŠÙ†Ø².`;
        errorBox.style.color="#ef4444";
        isSaving=false;
        validate();
        return;
    }

    try{
        // 1. ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶ ÙÙŠ Firebase Auth
        await user.updateProfile({displayName:newName});
        const newCoins = userData.totalCoins - userData.finalCost;

        // ğŸš¨ 2. ØªØ­Ø¯ÙŠØ« Firestore Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… saveUserData Ù„Ø¶Ù…Ø§Ù† Ø­ÙØ¸ ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ (Ø§Ù„Ù…Ø³ØªÙˆÙ‰ØŒ XPØŒ ProØŒ Ø¥Ù„Ø®)
        await saveUserData(
            newCoins,
            userData.proExpiryTime || 0,
            userData.players || [],
            userData.settings || {},
            userData.level || 1,
            userData.xp || 0,
            userData.ownedPacksPermanent || [],
            userData.ownedPacksTemporary || {}
        );
        
        // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ (ÙÙŠ Firestore)
        await firebase.firestore().collection("users").doc(user.uid)
        .set({
            hasChangedNameBefore: true,
            displayName: newName // ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ Ø£ÙŠØ¶Ø§Ù‹ Ù‡Ù†Ø§ Ù„Ù„ØªØ£ÙƒÙŠØ¯
        },{merge:true});

        // 4. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        userData.totalCoins=newCoins;
        userData.hasChangedNameBefore=true;
        document.getElementById("coins").innerText=newCoins;
        
        errorBox.innerText=userData.finalCost===0
            ?"âœ… ØªÙ… Ø§Ù„ØªØºÙŠÙŠØ± Ù…Ø¬Ø§Ù†Ù‹Ø§"
            :`âœ… ØªÙ… Ø§Ù„Ø®ØµÙ… ${userData.finalCost} ÙƒÙˆÙŠÙ†Ø²`;
        errorBox.style.color="#22c55e";

        // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙƒÙ„ÙØ© ÙˆØ¹Ø±Ø¶Ù‡Ø§ Ø¨Ø¹Ø¯ Ø§Ù„ØªØºÙŠÙŠØ±
        await updateCost(userData.proExpiryTime > Date.now()); 
        validate();

    }catch(e){
        console.error("Error during name change:", e);
        errorBox.innerText="âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸. Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹.";
        errorBox.style.color="#ef4444";
    }

    isSaving=false;
};
</script>

</body>
</html>
