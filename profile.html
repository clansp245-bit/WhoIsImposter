<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‘¤ Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="auth.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        :root {
            --primary: #6366f1;
            --accent-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            --bg-body: #0a0f1e;
            --card-bg: rgba(30, 41, 59, 0.7);
            --text-main: #f1f5f9;
            --text-dim: #94a3b8;
            --gold: #ffd700;
            --error: #ef4444;
            --success: #10b981;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-body);
            background-image: radial-gradient(circle at top right, #1e1b4b, transparent), radial-gradient(circle at bottom left, #1e1b4b, transparent);
            color: var(--text-main);
            padding: 20px;
            min-height: 100vh;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h2 {
            font-weight: 900;
            font-size: 2rem;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
        }

        .card {
            background: var(--card-bg);
            backdrop-filter: blur(15px);
            padding: 25px;
            border-radius: 24px;
            width: 100%;
            max-width: 480px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            margin-bottom: 20px;
            box-sizing: border-box;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .info-item span:first-child { color: var(--text-dim); font-weight: bold; }
        .info-item span:last-child { color: var(--text-main); font-weight: 900; }

        /* ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø±Ø¶ Ø§Ù„Ù€ UID */
        .uid-container {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0,0,0,0.2);
            padding: 5px 12px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        #publicUid { color: var(--gold) !important; font-family: monospace; letter-spacing: 1px; }
        .copy-btn { background: none; border: none; color: var(--text-dim); cursor: pointer; transition: 0.3s; }
        .copy-btn:hover { color: var(--primary); transform: scale(1.2); }

        /* Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ */
        .gifts-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-top: 15px;
        }
        .gift-icon {
            background: rgba(255,255,255,0.03);
            aspect-ratio: 1;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            position: relative;
            border: 1px solid rgba(255,255,255,0.05);
            transition: 0.3s;
        }
        .gift-icon.unlocked { border-color: var(--primary); background: rgba(99, 102, 241, 0.1); }
        .gift-icon.locked { filter: grayscale(1); opacity: 0.3; }
        .gift-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--primary);
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 50px;
            font-weight: 900;
        }
        .best-sender { font-size: 0.55rem; color: var(--gold); margin-top: 5px; max-width: 90%; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }

        /* ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù… */
        input {
            width: 100%;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 15px;
            color: white;
            font-family: 'Cairo';
            margin: 15px 0 10px 0;
            text-align: center;
            box-sizing: border-box;
        }
        input:focus { border-color: var(--primary); outline: none; }

        .btn-save {
            width: 100%;
            padding: 15px;
            border-radius: 15px;
            border: none;
            background: var(--accent-gradient);
            color: white;
            font-weight: 900;
            cursor: pointer;
            transition: 0.3s;
        }
        .btn-save:disabled { opacity: 0.3; transform: none; }
        .btn-back {
            background: rgba(255,255,255,0.05);
            color: var(--text-dim);
            border: 1px solid rgba(255,255,255,0.1);
            margin-top: 10px;
            width: 100%;
            max-width: 480px;
            padding: 12px;
            border-radius: 15px;
            font-family: 'Cairo';
            font-weight: bold;
            cursor: pointer;
        }

        #error { font-size: 0.85rem; margin-top: 10px; font-weight: bold; }
    </style>
</head>

<body>

<h2>ğŸ‘¤ Ù…Ù„Ù Ø§Ù„Ù„Ø§Ø¹Ø¨</h2>

<div class="card">
    <div class="info-item">
        <span>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</span>
        <span id="email">...</span>
    </div>
    
    <div class="info-item">
        <span>Ù…Ø¹Ø±Ù Ø§Ù„Ù„Ø§Ø¹Ø¨ (Public UID)</span>
        <div class="uid-container">
            <span id="publicUid">...</span>
            <button class="copy-btn" onclick="copyPublicUid()" title="Ù†Ø³Ø®">
                <i class="fas fa-copy"></i>
            </button>
        </div>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
        <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 15px; text-align: center;">
            <div style="font-size: 0.7rem; color: var(--text-dim);">Ø§Ù„Ù…Ø³ØªÙˆÙ‰</div>
            <div id="level" style="font-size: 1.2rem; font-weight: 900; color: var(--success);">1</div>
        </div>
        <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 15px; text-align: center;">
            <div style="font-size: 0.7rem; color: var(--text-dim);">Ø§Ù„ÙƒÙˆÙŠÙ†Ø²</div>
            <div id="coins" style="font-size: 1.2rem; font-weight: 900; color: var(--gold);">0</div>
        </div>
    </div>

    <div class="info-item" style="border: none; margin-top: 10px;">
        <span>Ø§Ù„Ø­Ø§Ù„Ø©</span>
        <span id="status" style="background: var(--primary); padding: 2px 12px; border-radius: 50px; font-size: 0.8rem;">...</span>
    </div>
</div>

<div class="card">
    <h3 style="margin:0; font-size: 1.1rem;"><i class="fas fa-gift" style="color: var(--error);"></i> Ù…Ø¹Ø±Ø¶ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§</h3>
    <div id="gifts-collection-container" class="gifts-grid">
        </div>
</div>

<div class="card">
    <h3 style="margin:0; font-size: 1.1rem;"><i class="fas fa-user-edit" style="color: var(--primary);"></i> ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…</h3>
    <p id="costText" style="color: var(--gold); font-size: 0.8rem; margin: 10px 0 0 0; font-weight: bold;"></p>
    <input id="nameInput" disabled placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯">
    <button id="saveBtn" class="btn-save" disabled onclick="handleSaveName()">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
    <div id="error"></div>
</div>

<button class="btn-back" onclick="location.href='index.html'">
    <i class="fas fa-chevron-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
</button>

<script>
// --- Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠ (Ù†ÙØ³ Ù…Ù†Ø·Ù‚Ùƒ Ù…Ø¹ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¹Ø±Ø¶) ---
let userData = null;
let isSaving = false;
const BASE_COST = 500;
const GIFTS_DEFINITION = [
    {name:"ÙˆØ±Ø¯Ø©", icon:"ğŸŒ¹"}, {name:"Ù‚Ù„Ù… Ø°Ù‡Ø¨ÙŠ", icon:"ğŸ–‹ï¸"},
    {name:"Ø³ÙŠØ§Ø±Ø© Ø³Ø¨Ø§Ù‚", icon:"ğŸï¸"}, {name:"Ø·Ø§Ø¦Ø±Ø© Ø®Ø§ØµØ©", icon:"âœˆï¸"},
    {name:"ÙŠØ®Øª ÙØ§Ø®Ø±", icon:"ğŸ›¥ï¸"}, {name:"Ù…Ø¬ÙˆÙ‡Ø±Ø§Øª", icon:"ğŸ’"},
    {name:"ÙƒØªØ§Ø¨ Ø³Ø­Ø±ÙŠ", icon:"ğŸ“–"}, {name:"ØªØ§Ø¬ Ù…Ù„ÙƒÙŠ", icon:"ğŸ‘‘"}
];

const nameInput = document.getElementById("nameInput");
const saveBtn = document.getElementById("saveBtn");
const errorBox = document.getElementById("error");

firebase.auth().onAuthStateChanged(async user => {
    if (!user) return location.href = "auth.html";
    
    userData = await loadUserData();
    if (!userData) return errorBox.innerText = "ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";

    document.getElementById("email").innerText = user.email;
    document.getElementById("publicUid").innerText = userData.publicUid || "---";
    document.getElementById("level").innerText = userData.level || 1;
    document.getElementById("coins").innerText = userData.totalCoins || 0;
    
    const isPro = (userData.proExpiryTime || 0) > Date.now();
    document.getElementById("status").innerText = isPro ? "Ø¹Ø¶Ùˆ PRO ğŸ‘‘" : "Ø¹Ø¶Ùˆ Ø¹Ø§Ø¯ÙŠ";

    nameInput.value = user.displayName || user.email.split("@")[0];
    nameInput.disabled = false;

    updateCost(isPro);
    renderGifts();
});

function renderGifts() {
    const container = document.getElementById("gifts-collection-container");
    container.innerHTML = '';
    const received = userData.receivedGifts || {};

    GIFTS_DEFINITION.forEach((gift, index) => {
        const giftData = received[index];
        const hasGift = !!giftData && giftData.count > 0;
        
        const div = document.createElement('div');
        div.className = `gift-icon ${hasGift ? 'unlocked' : 'locked'}`;
        div.innerHTML = `
            ${gift.icon}
            ${hasGift ? `<span class="gift-count">${giftData.count}</span>` : ''}
            ${hasGift ? `<span class="best-sender">Ù…Ù†: ${giftData.senderName || 'Ù…Ø¬Ù‡ÙˆÙ„'}</span>` : ''}
        `;
        container.appendChild(div);
    });
}

function updateCost(isPro) {
    if (!userData.hasChangedNameBefore) {
        document.getElementById("costText").innerText = "ğŸ Ø£ÙˆÙ„ ØªØºÙŠÙŠØ± Ù„Ù„Ø§Ø³Ù… Ù…Ø¬Ø§Ù†ÙŠ ØªÙ…Ø§Ù…Ø§Ù‹!";
        userData.finalCost = 0;
    } else {
        document.getElementById("costText").innerText = `ğŸ’° ØªÙƒÙ„ÙØ© Ø§Ù„ØªØºÙŠÙŠØ±: ${BASE_COST} ÙƒÙˆÙŠÙ†Ø²`;
        userData.finalCost = BASE_COST;
    }
}

nameInput.addEventListener("input", () => {
    const val = nameInput.value.trim();
    saveBtn.disabled = val.length < 3 || val === (firebase.auth().currentUser.displayName || "");
});

function copyPublicUid() {
    const uid = document.getElementById("publicUid").innerText;
    navigator.clipboard.writeText(uid).then(() => {
        alert("ØªÙ… Ù†Ø³Ø® Ù…Ø¹Ø±Ù Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø¨Ù†Ø¬Ø§Ø­!");
    });
}

async function handleSaveName() {
    // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù‡Ù†Ø§
}
</script>
</body>
</html>
