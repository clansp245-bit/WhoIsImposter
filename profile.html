<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ‘¤ Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ</title>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="auth.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
body{
    font-family:'Cairo',sans-serif;
    background:#0f172a;
    color:#f1f5f9;
    text-align:center;
    padding:20px
}
h2 { color:#34d399; }
.card{
    background:#1e293b;
    padding:25px;
    border-radius:12px;
    max-width:450px;
    margin:20px auto;
    text-align:right;
}
.info-item{
    display:flex;
    justify-content:space-between;
    padding:8px 0;
    border-bottom:1px solid #334155;
    font-weight:700;
}
input,button{
    width:100%;
    padding:12px;
    border-radius:8px;
    border:none;
    font-family:'Cairo'
}
input{
    background:#334155;
    color:white;
    margin-bottom:10px
}
button{
    background:#34d399;
    color:white;
    font-weight:700;
    cursor:pointer
}
button:disabled{background:#475569}
#error{margin-top:10px;min-height:20px}
</style>
</head>

<body>

<h2>ğŸ‘¤ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h2>

<div class="card">
    <div class="info-item"><span>Ø§Ù„Ø¨Ø±ÙŠØ¯</span><span id="email">...</span></div>
    <div class="info-item"><span>Public UID</span><span id="publicUid">...</span></div>
    <div class="info-item"><span>Ø§Ù„Ù…Ø³ØªÙˆÙ‰</span><span id="level">...</span></div>
    <div class="info-item"><span>XP</span><span id="xp">...</span></div>
    <div class="info-item"><span>Ø§Ù„Ø­Ø§Ù„Ø©</span><span id="status">...</span></div>
    <div class="info-item"><span>Ø§Ù„ÙƒÙˆÙŠÙ†Ø²</span><span id="coins">...</span></div>
</div>

<div class="card">
    <h3>ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶</h3>
    <p id="costText" style="color:#facc15;font-weight:700"></p>
    <input id="nameInput" disabled placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙŠØ¯">
    <button id="saveBtn" disabled>Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±</button>
    <div id="error"></div>
</div>

<button onclick="location.href='index.html'" style="background:#6366f1;max-width:450px;width:100%">
    Ø§Ù„Ø¹ÙˆØ¯Ø© <i class="fas fa-arrow-right"></i>
</button>

<script>
let userData=null;
let isSaving=false;
const BASE_COST=500;

const nameInput=document.getElementById("nameInput");
const saveBtn=document.getElementById("saveBtn");
const errorBox=document.getElementById("error");
const costText=document.getElementById("costText");

/* ---------------- PUBLIC UID ---------------- */

function generatePublicUid(){
    const chars="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    const part=()=>Array.from({length:4},()=>chars[Math.floor(Math.random()*chars.length)]).join("");
    return `IMP-${part()}-${part()}`;
}

async function generateUniquePublicUid(){
    while(true){
        const uid=generatePublicUid();
        const snap=await firebase.firestore()
            .collection("users")
            .where("publicUid","==",uid)
            .limit(1).get();
        if(snap.empty) return uid;
    }
}

/* ---------------- AUTH LOAD ---------------- */

firebase.auth().onAuthStateChanged(async user=>{
    if(!user) return location.href="auth.html";

    userData=await loadUserData();
    if(!userData){ errorBox.innerText="ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"; return; }

    // Ø¥Ù†Ø´Ø§Ø¡ Public UID Ø¥Ø°Ø§ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯
    if(!userData.publicUid){
        const newUid=await generateUniquePublicUid();
        await firebase.firestore().collection("users").doc(user.uid)
            .set({publicUid:newUid},{merge:true});
        userData.publicUid=newUid;
    }

    document.getElementById("email").innerText=user.email;
    document.getElementById("publicUid").innerText=userData.publicUid;
    document.getElementById("level").innerText=userData.level||1;
    document.getElementById("xp").innerText=userData.xp||0;
    document.getElementById("coins").innerText=userData.totalCoins||0;

    const isPro=userData.proExpiryTime>Date.now();
    document.getElementById("status").innerText=isPro?"Pro ğŸ‘‘":"Ø¹Ø§Ø¯ÙŠ";

    nameInput.value=user.displayName||user.email.split("@")[0];
    nameInput.disabled=false;

    await updateCost(isPro);
    validate();
});

/* ---------------- NAME CHANGE ---------------- */

nameInput.addEventListener("input",validate);

function validate(){
    const current=nameInput.value.trim();
    const original=firebase.auth().currentUser.displayName||firebase.auth().currentUser.email.split("@")[0];
    saveBtn.disabled=isSaving||current.length<3||current===original;
}

async function isNameAvailable(name){
    const snap=await firebase.firestore()
        .collection("users")
        .where("displayName","==",name)
        .limit(1).get();
    return snap.empty||snap.docs[0].id===firebase.auth().currentUser.uid;
}

async function updateCost(isPro){
    if(!userData.hasChangedNameBefore){
        costText.innerText="ğŸ‰ Ø£ÙˆÙ„ ØªØºÙŠÙŠØ± Ù…Ø¬Ø§Ù†ÙŠ";
        userData.finalCost=0;
        return;
    }
    userData.finalCost=BASE_COST;
    costText.innerText=`ğŸ’° ØªÙƒÙ„ÙØ© Ø§Ù„ØªØºÙŠÙŠØ±: ${BASE_COST} ÙƒÙˆÙŠÙ†Ø²`;
}

saveBtn.onclick=async()=>{
    if(isSaving) return;
    isSaving=true; saveBtn.disabled=true; errorBox.innerText="";

    const user=firebase.auth().currentUser;
    const newName=nameInput.value.trim();

    if(!(await isNameAvailable(newName))){
        errorBox.innerText="âŒ Ø§Ù„Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù…";
        isSaving=false; validate(); return;
    }

    if(userData.totalCoins<userData.finalCost){
        errorBox.innerText="âŒ ÙƒÙˆÙŠÙ†Ø² ØºÙŠØ± ÙƒØ§ÙÙŠØ©";
        isSaving=false; validate(); return;
    }

    try{
        await user.updateProfile({displayName:newName});
        const newCoins=userData.totalCoins-userData.finalCost;

        await firebase.firestore().collection("users").doc(user.uid).set({
            displayName:newName,
            totalCoins:newCoins,
            hasChangedNameBefore:true
        },{merge:true});

        userData.totalCoins=newCoins;
        document.getElementById("coins").innerText=newCoins;
        errorBox.innerText="âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸";
        errorBox.style.color="#22c55e";
    }catch(e){
        errorBox.innerText="âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸";
        errorBox.style.color="#ef4444";
    }
    isSaving=false; validate();
};
</script>

</body>
</html>
