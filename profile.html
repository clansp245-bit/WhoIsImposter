<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‘¤ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ù„ÙƒÙŠ Ø§Ù„Ù…Ø·ÙˆØ± v4</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="auth.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        :root {
            --primary: #6366f1;
            --accent: #a855f7;
            --bg-body: #050811;
            --card-bg: rgba(15, 23, 42, 0.8);
            --gold: #f59e0b;
            --silver: #94a3b8;
            /* Ù†Ø¯Ø±Ø© Ø§Ù„Ø´Ø§Ø±Ø§Øª */
            --rarity-dev: linear-gradient(45deg, #ef4444, #7f1d1d);
            --rarity-pro: linear-gradient(45deg, #f472b6, #7c3aed);
            --rarity-gold-season: linear-gradient(45deg, #fbbf24, #d97706);
            --rarity-silver-season: linear-gradient(45deg, #cbd5e1, #64748b);
            --rarity-rare: linear-gradient(45deg, #3b82f6, #1e3a8a);
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: var(--bg-body);
            color: white; margin: 0; padding: 15px;
            display: flex; flex-direction: column; align-items: center;
        }

        .card {
            background: var(--card-bg); backdrop-filter: blur(20px);
            border-radius: 28px; width: 100%; max-width: 480px;
            border: 1px solid rgba(255,255,255,0.08); margin-bottom: 20px;
            padding: 25px; box-sizing: border-box; position: relative;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        /* Ù‡ÙŠØ¯Ø± Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ */
        .profile-header { text-align: center; }
        .avatar-box { width: 120px; height: 120px; margin: 0 auto 15px; position: relative; }
        .avatar-img { width: 100%; height: 100%; border-radius: 50%; border: 3px solid var(--primary); object-fit: cover; }
        
        /* Ø´Ø§Ø±Ø§Øª Ø§Ù„Ù‡ÙŠØ¯Ø± */
        #user-badges { display: flex; justify-content: center; gap: 8px; margin-top: 10px; height: 45px; }
        .badge-icon {
            width: 40px; height: 40px; border-radius: 12px; display: flex;
            align-items: center; justify-content: center; font-size: 1.2rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.2);
            transition: 0.3s;
        }

        /* Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ø³Ø® */
        .id-container {
            background: rgba(0,0,0,0.3); padding: 8px 15px; border-radius: 12px;
            display: inline-flex; align-items: center; gap: 10px; margin-top: 10px;
            border: 1px dashed rgba(255,255,255,0.2);
        }
        .copy-btn { cursor: pointer; color: var(--gold); transition: 0.2s; }
        .copy-btn:hover { transform: scale(1.2); }

        /* Ø®Ø²Ø§Ù†Ø© Ø§Ù„Ø´Ø§Ø±Ø§Øª */
        .library-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 15px;
        }
        .lib-item {
            background: rgba(255,255,255,0.05); border-radius: 15px; padding: 10px;
            text-align: center; cursor: pointer; border: 1px solid transparent; transition: 0.3s;
        }
        .lib-item i { font-size: 1.4rem; display: block; margin-bottom: 5px; }
        .lib-item span { font-size: 0.6rem; display: block; font-weight: bold; }
        .lib-item.locked { opacity: 0.2; filter: grayscale(1); cursor: not-allowed; }
        .lib-item.active { border-color: var(--gold); background: rgba(245, 158, 11, 0.1); }

        /* Ø®Ù„ÙÙŠØ§Øª Ø§Ù„Ø´Ø§Ø±Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù†Ø¯Ø±Ø© */
        .bg-dev { background: var(--rarity-dev); color: #fff; }
        .bg-pro { background: var(--rarity-pro); color: #fff; }
        .bg-gold { background: var(--rarity-gold-season); color: #fff; }
        .bg-silver { background: var(--rarity-silver-season); color: #fff; }
        .bg-rare { background: var(--rarity-rare); color: #fff; }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .action-btn {
            width: 100%; padding: 14px; border-radius: 15px; border: none;
            font-weight: 900; cursor: pointer; margin-top: 10px; transition: 0.3s;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn-primary { background: linear-gradient(90deg, var(--primary), var(--accent)); color: white; }
        .btn-special { background: linear-gradient(90deg, #f59e0b, #fbbf24); color: #000; }
        .action-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        input {
            width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #334155;
            background: #0f172a; color: white; margin-top: 10px; box-sizing: border-box;
        }

        .toast {
            position: fixed; bottom: 20px; background: var(--primary);
            padding: 10px 20px; border-radius: 10px; display: none; z-index: 1000;
        }
    </style>
</head>
<body>

<div class="card profile-header">
    <div class="avatar-box">
        <img id="profile-img" class="avatar-img" src="https://via.placeholder.com/150">
    </div>
    
    <div id="user-badges"></div>

    <h2 id="display-name" style="margin: 15px 0 5px 0; font-weight: 900; font-size: 1.6rem;">...</h2>
    
    <div class="id-container">
        <span>ID: <b id="user-id-text" style="color: var(--gold);">---</b></span>
        <i class="fas fa-copy copy-btn" onclick="copyID()" title="Ù†Ø³Ø®"></i>
    </div>
</div>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h3 style="margin:0; font-size: 1rem; color: var(--gold);"><i class="fas fa-box-open"></i> Ø®Ø²Ø§Ù†Ø© Ø§Ù„Ø´Ø§Ø±Ø§Øª</h3>
        <span style="font-size: 0.7rem; opacity: 0.6;">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 5</span>
    </div>
    <div id="badges-library" class="library-grid"></div>
</div>

<div class="card">
    <h3 style="margin:0 0 10px 0; font-size: 1rem; color: var(--primary);"><i class="fas fa-tools"></i> Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ®ØµÙŠØµ</h3>
    
    <input id="nameInput" type="text" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯...">
    <button id="saveNameBtn" class="action-btn btn-primary" onclick="changeName()">
        <i class="fas fa-id-card"></i> ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…
    </button>

    <div id="special-id-section" style="display: none; margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
        <input id="customIdInput" type="text" placeholder="Ø£Ø¯Ø®Ù„ ID Ù…Ø®ØµØµ (Ù…Ø«Ø§Ù„: KING-1)">
        <button class="action-btn btn-special" onclick="changeCustomID()">
            <i class="fas fa-star"></i> ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¢ÙŠØ¯ÙŠ Ø§Ù„Ù…Ù…ÙŠØ²
        </button>
    </div>
</div>

<button class="action-btn" style="background: #1e293b; color: white; max-width: 480px;" onclick="location.href='index.html'">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>

<div id="toast" class="toast">ØªÙ… Ø§Ù„Ù†Ø³Ø® Ø¨Ù†Ø¬Ø§Ø­!</div>

<script>
// --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø§Ø±Ø§Øª Ø§Ù„Ø±Ù‡ÙŠØ¨Ø© ---
const BADGE_DATA = {
    "dev_badge": { name: "Ù…Ø·ÙˆØ±", icon: "fa-code", bg: "bg-dev" },
    "pro_badge": { name: "Ø¹Ø¶Ùˆ Ø¨Ø±Ùˆ", icon: "fa-crown", bg: "bg-pro" },
    "gold_s_badge": { name: "Ø³ÙŠØ²ÙˆÙ† 1 Ø°Ù‡Ø¨ÙŠ", icon: "fa-medal", bg: "bg-gold" },
    "silver_s_badge": { name: "Ø³ÙŠØ²ÙˆÙ† 1 ÙØ¶ÙŠ", icon: "fa-award", bg: "bg-silver" },
    "rich_badge": { name: "Ø§Ù„Ù…Ù„ÙŠØ§Ø±Ø¯ÙŠØ±", icon: "fa-gem", bg: "bg-rare" },
    "falcon_badge": { name: "Ø§Ù„ØµÙ‚Ø±", icon: "fa-feather-alt", bg: "bg-rare" }
};

let userStats = null;
const MY_DEV_ID = "IMP-VVVC-2JZ7"; // Ø§Ù„Ø¢ÙŠØ¯ÙŠ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ ÙƒÙ…Ø·ÙˆØ±

auth.onAuthStateChanged(user => {
    if (!user) return;
    
    db.collection('users').doc(user.uid).onSnapshot(doc => {
        if (doc.exists) {
            userStats = doc.data();
            autoSyncBadges(user.uid); // Ù…Ø²Ø§Ù…Ù†Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù„Ù„Ø±ØªØ¨
            updateUI();
        }
    });
});

// --- Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø´Ø§Ø±Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ---
async function autoSyncBadges(uid) {
    let currentBadges = userStats.badges || [];
    let needsUpdate = false;

    // 1. ÙØ­Øµ Ø§Ù„Ù…Ø·ÙˆØ±
    if (userStats.customID === MY_DEV_ID && !currentBadges.includes("dev_badge")) {
        currentBadges.push("dev_badge"); needsUpdate = true;
    }

    // 2. ÙØ­Øµ Ø§Ù„Ø¨Ø±Ùˆ (ØªØ§Ø¬ Ø§Ù„Ø¨Ø±Ùˆ Ù„ÙŠØ³ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø£ØµÙØ±)
    const isPro = userStats.proExpiryTime > Date.now();
    if (isPro && !currentBadges.includes("pro_badge")) {
        currentBadges.push("pro_badge"); needsUpdate = true;
    } else if (!isPro && currentBadges.includes("pro_badge")) {
        currentBadges = currentBadges.filter(b => b !== "pro_badge"); needsUpdate = true;
    }

    if (needsUpdate) {
        await db.collection('users').doc(uid).update({ badges: currentBadges });
    }
}

function updateUI() {
    // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    document.getElementById("display-name").innerText = userStats.displayName || "Ù„Ø§Ø¹Ø¨";
    const user_id = userStats.customID || userStats.publicUid || "---";
    document.getElementById("user-id-text").innerText = user_id;
    if (userStats.photoURL) document.getElementById("profile-img").src = userStats.photoURL;

    // Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¬Ù‡Ø²Ø© ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±
    const badgeBox = document.getElementById("user-badges");
    badgeBox.innerHTML = "";
    const equipped = userStats.equippedBadges || [];
    equipped.forEach(key => {
        const info = BADGE_DATA[key];
        if(info) {
            badgeBox.innerHTML += `<div class="badge-icon ${info.bg}"><i class="fas ${info.icon}"></i></div>`;
        }
    });

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø²Ø§Ù†Ø©
    renderLibrary();

    // ÙØ­Øµ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª (ØªØºÙŠÙŠØ± Ø§Ø³Ù… / Ø¢ÙŠØ¯ÙŠ Ù…Ù…ÙŠØ²)
    const inv = userStats.inventory || [];
    const nameCardCount = inv.filter(i => i === "Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø§Ø³Ù…").length;
    document.getElementById("saveNameBtn").disabled = nameCardCount === 0;
    document.getElementById("saveNameBtn").innerHTML = nameCardCount > 0 ? 
        `<i class="fas fa-id-card"></i> ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù… (${nameCardCount})` : "Ù„Ø§ ØªÙ…Ù„Ùƒ Ø¨Ø·Ø§Ù‚Ø© Ø§Ø³Ù…";

    const hasSpecialIDCard = inv.includes("Ø¨Ø·Ø§Ù‚Ø© Ø¢ÙŠØ¯ÙŠ Ù…Ù…ÙŠØ²");
    document.getElementById("special-id-section").style.display = hasSpecialIDCard ? "block" : "none";
}

function renderLibrary() {
    const grid = document.getElementById("badges-library");
    grid.innerHTML = "";
    const owned = userStats.badges || [];
    const equipped = userStats.equippedBadges || [];

    Object.keys(BADGE_DATA).forEach(key => {
        const info = BADGE_DATA[key];
        const isOwned = owned.includes(key);
        const isEquipped = equipped.includes(key);

        const div = document.createElement("div");
        div.className = `lib-item ${!isOwned ? 'locked' : ''} ${isEquipped ? 'active' : ''}`;
        div.innerHTML = `
            <i class="fas ${info.icon} ${isOwned ? info.bg : ''}" style="-webkit-background-clip: text; ${isOwned ? 'color:transparent;' : ''}"></i>
            <span>${info.name}</span>
        `;
        
        if(isOwned) div.onclick = () => toggleBadge(key);
        grid.appendChild(div);
    });
}

async function toggleBadge(key) {
    let equipped = [...(userStats.equippedBadges || [])];
    if(equipped.includes(key)) {
        equipped = equipped.filter(k => k !== key);
    } else {
        if(equipped.length >= 5) return showToast("Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 5 Ø´Ø§Ø±Ø§Øª!");
        equipped.push(key);
    }
    await db.collection('users').doc(auth.currentUser.uid).update({ equippedBadges: equipped });
}

async function changeName() {
    const newName = document.getElementById("nameInput").value.trim();
    if(newName.length < 3) return alert("Ø§Ù„Ø§Ø³Ù… Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹");
    
    let inv = [...(userStats.inventory || [])];
    const idx = inv.indexOf("Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø§Ø³Ù…");
    if(idx > -1) {
        inv.splice(idx, 1);
        await db.collection('users').doc(auth.currentUser.uid).update({
            displayName: newName,
            inventory: inv
        });
        showToast("ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù… Ø¨Ù†Ø¬Ø§Ø­!");
    }
}

async function changeCustomID() {
    const newID = document.getElementById("customIdInput").value.trim();
    if(newID.length < 3) return alert("Ø§Ù„Ø¢ÙŠØ¯ÙŠ Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹");

    // ÙØ­Øµ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¢ÙŠØ¯ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ù‚Ø¨Ù„
    const snapshot = await db.collection('users').where('customID', '==', newID).get();
    if(!snapshot.empty) return alert("Ù‡Ø°Ø§ Ø§Ù„Ø¢ÙŠØ¯ÙŠ Ù…Ø­Ø¬ÙˆØ² Ù„Ù„Ø§Ø¹Ø¨ Ø¢Ø®Ø±!");

    let inv = [...(userStats.inventory || [])];
    const idx = inv.indexOf("Ø¨Ø·Ø§Ù‚Ø© Ø¢ÙŠØ¯ÙŠ Ù…Ù…ÙŠØ²");
    if(idx > -1) {
        inv.splice(idx, 1);
        await db.collection('users').doc(auth.currentUser.uid).update({
            customID: newID,
            inventory: inv
        });
        showToast("Ù…Ø¨Ø±ÙˆÙƒ! Ø§Ù„Ø¢ÙŠØ¯ÙŠ Ø§Ù„Ù…Ù…ÙŠØ² Ù…ÙØ¹Ù„.");
    }
}

function copyID() {
    const id = document.getElementById("user-id-text").innerText;
    navigator.clipboard.writeText(id);
    showToast("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø¢ÙŠØ¯ÙŠ: " + id);
}

function showToast(msg) {
    const t = document.getElementById("toast");
    t.innerText = msg;
    t.style.display = "block";
    setTimeout(() => t.style.display = "none", 2500);
}
</script>

</body>
</html>
