<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ğŸ‘¤ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Firebase v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <!-- Ù…Ù„Ù Firebase Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ -->
    <script src="auth.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: Cairo, sans-serif;
            background:#0f172a;
            color:#f1f5f9;
            text-align:center;
            padding:20px;
        }
        .card {
            background:#1e293b;
            padding:20px;
            margin:20px auto;
            border-radius:10px;
            max-width:400px;
            text-align:right;
        }
        .row {
            display:flex;
            justify-content:space-between;
            padding:8px 0;
            border-bottom:1px solid #334155;
        }
        button {
            width:100%;
            padding:10px;
            margin-top:10px;
            font-weight:bold;
            cursor:pointer;
        }
        input {
            width:100%;
            padding:8px;
            margin-top:5px;
        }
    </style>
</head>

<body>

<h2>ğŸ‘¤ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h2>

<div class="card">
    <div class="row"><span>Ø§Ù„Ø¨Ø±ÙŠØ¯:</span><span id="email">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span></div>
    <div class="row"><span>Ø§Ù„Ù…Ø³ØªÙˆÙ‰:</span><span id="level">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span></div>
    <div class="row"><span>XP:</span><span id="xp">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span></div>
    <div class="row"><span>Ø§Ù„ÙƒÙˆÙŠÙ†Ø²:</span><span id="coins">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span></div>
    <div class="row"><span>Ø§Ù„Ø­Ø§Ù„Ø©:</span><span id="pro">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span></div>
</div>

<div class="card">
    <label>ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶</label>
    <input id="displayName" disabled>
    <button id="saveBtn" disabled>Ø­ÙØ¸</button>
    <p id="msg"></p>
</div>

<script>
let currentUserData = null;
const COST = 500;

const emailEl = document.getElementById("email");
const levelEl = document.getElementById("level");
const xpEl = document.getElementById("xp");
const coinsEl = document.getElementById("coins");
const proEl = document.getElementById("pro");
const nameInput = document.getElementById("displayName");
const saveBtn = document.getElementById("saveBtn");
const msg = document.getElementById("msg");

/* ===============================
   Ø§Ù„Ø­Ù„ Ø§Ù„Ø¬Ø°Ø±ÙŠ: Ø§Ù†ØªØ¸Ø§Ø± Firebase
================================ */
document.addEventListener("DOMContentLoaded", () => {

    firebase.auth().onAuthStateChanged(async (user) => {

        if (!user) {
            window.location.href = "auth.html";
            return;
        }

        try {
            currentUserData = await loadUserData();
            console.log("LOADED:", currentUserData);

            if (!currentUserData) {
                throw new Error("NO DATA");
            }

            // Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            emailEl.textContent = user.email;
            levelEl.textContent = currentUserData.level;
            xpEl.textContent = currentUserData.xp;
            coinsEl.textContent = currentUserData.totalCoins;
            proEl.textContent =
                currentUserData.proExpiryTime > Date.now()
                ? "Pro â­"
                : "Ø¹Ø§Ø¯ÙŠ";

            nameInput.value = user.displayName || user.email.split("@")[0];
            nameInput.disabled = false;
            saveBtn.disabled = false;

        } catch (e) {
            console.error(e);
            emailEl.textContent = "Ø®Ø·Ø£";
            levelEl.textContent = "Ø®Ø·Ø£";
            xpEl.textContent = "Ø®Ø·Ø£";
            coinsEl.textContent = "Ø®Ø·Ø£";
            proEl.textContent = "Ø®Ø·Ø£";
        }
    });
});

/* ===============================
   Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù…
================================ */
saveBtn.onclick = async () => {
    const user = firebase.auth().currentUser;
    const newName = nameInput.value.trim();
    msg.textContent = "";

    if (!newName || newName.length < 3) {
        msg.textContent = "Ø§Ù„Ø§Ø³Ù… Ù‚ØµÙŠØ±";
        return;
    }

    if (currentUserData.totalCoins < COST) {
        msg.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒÙˆÙŠÙ†Ø² ÙƒØ§ÙÙŠØ©";
        return;
    }

    saveBtn.disabled = true;

    try {
        await user.updateProfile({ displayName: newName });

        const newCoins = currentUserData.totalCoins - COST;

        await saveUserData(
            newCoins,
            currentUserData.proExpiryTime,
            currentUserData.players,
            currentUserData.settings,
            currentUserData.level,
            currentUserData.xp,
            currentUserData.ownedPacksPermanent,
            currentUserData.ownedPacksTemporary
        );

        currentUserData.totalCoins = newCoins;
        coinsEl.textContent = newCoins;

        msg.textContent = "âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­";

    } catch (err) {
        console.error(err);
        msg.textContent = "âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«";
    }

    saveBtn.disabled = false;
};
</script>

</body>
</html>
