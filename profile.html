here<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ‘¤ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</title>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="auth.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">

<style>
body {
    font-family: 'Cairo', sans-serif;
    background:#0f172a;
    color:#f1f5f9;
    text-align:center;
    padding:20px;
}
h1 { color:#34d399; }
.card {
    background:#1e293b;
    padding:25px;
    border-radius:12px;
    max-width:450px;
    margin:20px auto;
    text-align:right;
}
.info-item {
    display:flex;
    justify-content:space-between;
    border-bottom:1px solid #334155;
    padding:8px 0;
}
input {
    width:100%;
    padding:12px;
    border-radius:8px;
    background:#334155;
    color:white;
    border:none;
}
button {
    width:100%;
    padding:12px;
    border:none;
    border-radius:8px;
    font-weight:bold;
    cursor:pointer;
}
button:disabled {
    background:#475569;
    cursor:not-allowed;
}
#save-name-btn { background:#34d399; }
#back-btn { background:#6366f1; margin-top:20px; }
#error-message { margin-top:10px; font-size:0.9rem; }
</style>
</head>

<body>

<h1>ğŸ‘¤ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h1>

<div class="card">
<h3>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨</h3>
<div class="info-item"><span>Ø§Ù„Ù…Ø³ØªÙˆÙ‰</span><span id="level">...</span></div>
<div class="info-item"><span>XP</span><span id="xp">...</span></div>
<div class="info-item"><span>Ø§Ù„Ø¨Ø±ÙŠØ¯</span><span id="email">...</span></div>
<div class="info-item"><span>Ø§Ù„Ø­Ø§Ù„Ø©</span><span id="status">...</span></div>
<div class="info-item"><span>Ø§Ù„ÙƒÙˆÙŠÙ†Ø²</span><span id="coins">...</span></div>
</div>

<div class="card">
<h3>ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶</h3>
<p id="cost-text" style="color:#ffcc00;font-weight:700;"></p>
<input id="name-input" disabled>
<p id="error-message"></p>
<button id="save-name-btn" disabled>Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±</button>
</div>

<button id="back-btn" onclick="location.href='index.html'">â¬… Ø§Ù„Ø¹ÙˆØ¯Ø©</button>

<script>
const NAME_COST = 500;
let currentUserData = null;
let isSaving = false;

const nameInput = document.getElementById("name-input");
const saveBtn = document.getElementById("save-name-btn");
const errorMsg = document.getElementById("error-message");
const costText = document.getElementById("cost-text");

firebase.auth().onAuthStateChanged(async user => {
    if (!user) return location.href = "auth.html";

    currentUserData = await loadUserData();
    if (!currentUserData) return;

    email.innerText = user.email;
    level.innerText = currentUserData.level;
    xp.innerText = currentUserData.xp;
    coins.innerText = currentUserData.totalCoins;

    const isPro = currentUserData.proExpiryTime > Date.now();
    status.innerText = isPro ? "Pro ğŸ‘‘" : "Ø¹Ø§Ø¯ÙŠ";

    nameInput.value = user.displayName || user.email.split("@")[0];
    nameInput.disabled = false;

    updateCost(isPro);
    validateName();
});

nameInput.addEventListener("input", validateName);

function validateName() {
    const user = firebase.auth().currentUser;
    if (!user) return;

    const newName = nameInput.value.trim();
    saveBtn.disabled = newName.length < 3 || newName === user.displayName || isSaving;
}

async function updateCost(isPro) {
    if (!currentUserData.hasChangedNameBefore) {
        costText.innerText = "ğŸ‰ Ø£ÙˆÙ„ ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ù…Ø¬Ø§Ù†ÙŠ";
        return;
    }

    let cost = NAME_COST;

    if (isPro) {
        const today = new Date().toDateString();
        if (currentUserData.dailyNameDiscount?.date !== today) {
            const discount = Math.floor(Math.random() * 46) + 5; // 5-50%
            await firebase.firestore().collection("users").doc(firebase.auth().currentUser.uid)
                .set({ dailyNameDiscount: { date: today, percent: discount } }, { merge:true });
            currentUserData.dailyNameDiscount = { date: today, percent: discount };
        }
        cost = Math.floor(NAME_COST * (1 - currentUserData.dailyNameDiscount.percent / 100));
        costText.innerText = `ğŸ‘‘ Ø®ØµÙ… Ø§Ù„ÙŠÙˆÙ…: ${currentUserData.dailyNameDiscount.percent}% â†’ ${cost} ÙƒÙˆÙŠÙ†Ø²`;
    } else {
        costText.innerText = `ğŸš¨ Ø±Ø³ÙˆÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…: ${NAME_COST} ÙƒÙˆÙŠÙ†Ø²`;
    }

    currentUserData.finalNameCost = cost;
}

saveBtn.onclick = async () => {
    if (isSaving) return;
    isSaving = true;

    const user = firebase.auth().currentUser;
    const newName = nameInput.value.trim();

    errorMsg.innerText = "";

    const available = await isDisplayNameAvailable(newName);
    if (!available) {
        errorMsg.innerText = "âŒ Ø§Ù„Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„";
        errorMsg.style.color = "#ff4f4f";
        isSaving = false;
        validateName();
        return;
    }

    const cost = currentUserData.hasChangedNameBefore ? currentUserData.finalNameCost || NAME_COST : 0;

    if (currentUserData.totalCoins < cost) {
        errorMsg.innerText = "âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙˆÙŠÙ†Ø² ÙƒØ§ÙÙŠØ©";
        errorMsg.style.color = "#ff4f4f";
        isSaving = false;
        validateName();
        return;
    }

    saveBtn.disabled = true;

    try {
        await user.updateProfile({ displayName: newName });

        const newCoins = currentUserData.totalCoins - cost;

        await firebase.firestore().collection("users").doc(user.uid).set({
            displayName: newName,
            totalCoins: newCoins,
            hasChangedNameBefore: true
        }, { merge:true });

        currentUserData.totalCoins = newCoins;
        currentUserData.hasChangedNameBefore = true;
        coins.innerText = newCoins;

        errorMsg.innerText = cost === 0
            ? "âœ… ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù… Ù…Ø¬Ø§Ù†Ù‹Ø§"
            : `âœ… ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù… ÙˆØ®ØµÙ… ${cost} ÙƒÙˆÙŠÙ†Ø²`;
        errorMsg.style.color = "#34d399";

        validateName();
        updateCost(currentUserData.proExpiryTime > Date.now());

    } catch (e) {
        errorMsg.innerText = "âŒ ÙØ´Ù„ Ø§Ù„ØªØºÙŠÙŠØ±";
        errorMsg.style.color = "#ff4f4f";
        console.error(e);
    }

    isSaving = false;
};
</script>

</body>
</html>
