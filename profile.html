<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‘¤ Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ</title>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="auth.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #0f172a; 
            color: #f1f5f9; 
            text-align: center;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h1 { color: #34d399; margin-bottom: 30px; }
        .card {
            background-color: #1e293b; 
            padding: 30px;
            border-radius: 12px;
            max-width: 450px;
            width: 90%;
            margin: 20px auto;
            text-align: right;
        }
        input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            background: #334155;
            color: white;
            border: none;
            margin-bottom: 15px;
        }
        button {
            width: 100%;
            padding: 12px;
            font-weight: bold;
            border-radius: 8px;
            border: none;
            cursor: pointer;
        }
        #save-name-btn { background: #34d399; color: white; }
        #save-name-btn:disabled { background: #475569; }
        #back-btn { background: #6366f1; color: white; margin-top: 20px; }
        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #334155;
        }
        .label { color: #94a3b8; }
        .value { font-weight: bold; }
        #error-message { margin-top: 10px; font-size: 0.9rem; }
    </style>
</head>

<body>

<h1>ğŸ‘¤ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h1>

<div class="card">
    <h3>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨</h3>
    <div class="info-item"><span class="label">Ø§Ù„Ù…Ø³ØªÙˆÙ‰:</span><span id="user-level-profile">...</span></div>
    <div class="info-item"><span class="label">XP:</span><span id="user-xp-profile">...</span></div>
    <div class="info-item"><span class="label">Ø§Ù„Ø¨Ø±ÙŠØ¯:</span><span id="user-email">...</span></div>
    <div class="info-item"><span class="label">Ø§Ù„Ø­Ø§Ù„Ø©:</span><span id="pro-status">...</span></div>
    <div class="info-item"><span class="label">Ø§Ù„ÙƒÙˆÙŠÙ†Ø²:</span><span id="user-coins">...</span></div>
</div>

<div class="card">
    <h3>ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶</h3>
    <p id="name-cost-text" style="color:#ffcc00;font-weight:700;"></p>
    <input id="display-name-input" disabled>
    <p id="error-message"></p>
    <button id="save-name-btn" disabled>Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±</button>
</div>

<button id="back-btn" onclick="location.href='index.html'">
    <i class="fas fa-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¹Ø¨Ø©
</button>

<script>
let currentUserData = null;
const NAME_CHANGE_COST = 500;

const nameInput = document.getElementById("display-name-input");
const saveBtn = document.getElementById("save-name-btn");
const errorMsg = document.getElementById("error-message");
const costText = document.getElementById("name-cost-text");

document.addEventListener("DOMContentLoaded", () => {
    firebase.auth().onAuthStateChanged(async (user) => {
        if (!user) return location.href = "auth.html";

        currentUserData = await loadUserData();
        if (!currentUserData) return;

        document.getElementById("user-email").innerText = user.email;
        document.getElementById("user-level-profile").innerText = currentUserData.level;
        document.getElementById("user-xp-profile").innerText = currentUserData.xp;
        document.getElementById("user-coins").innerText = currentUserData.totalCoins;

        document.getElementById("pro-status").innerText =
            currentUserData.proExpiryTime > Date.now() ? "Pro ğŸ‘‘" : "Ø¹Ø§Ø¯ÙŠ";

        nameInput.value = user.displayName || user.email.split("@")[0];
        nameInput.disabled = false;
        saveBtn.disabled = false;

        updateCostText();
    });
});

function updateCostText() {
    if (!currentUserData.hasChangedNameBefore) {
        costText.innerText = "ğŸ‰ Ø£ÙˆÙ„ ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ù…Ø¬Ø§Ù†ÙŠ!";
    } else {
        costText.innerText = `ğŸš¨ Ø±Ø³ÙˆÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…: ${NAME_CHANGE_COST} ÙƒÙˆÙŠÙ†Ø²`;
    }
}

saveBtn.onclick = async () => {
    const user = firebase.auth().currentUser;
    const newName = nameInput.value.trim();
    errorMsg.innerText = "";

    if (newName.length < 3) {
        errorMsg.innerText = "Ø§Ù„Ø§Ø³Ù… Ù‚ØµÙŠØ± Ø¬Ø¯Ù‹Ø§";
        errorMsg.style.color = "#ff4f4f";
        return;
    }

    const isFree = !currentUserData.hasChangedNameBefore;
    const cost = isFree ? 0 : NAME_CHANGE_COST;

    if (currentUserData.totalCoins < cost) {
        errorMsg.innerText = "Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙˆÙŠÙ†Ø² ÙƒØ§ÙÙŠØ©";
        errorMsg.style.color = "#ff4f4f";
        return;
    }

    saveBtn.disabled = true;

    try {
        await user.updateProfile({ displayName: newName });

        const newCoins = currentUserData.totalCoins - cost;

        await firebase.firestore()
            .collection("users")
            .doc(user.uid)
            .set({
                totalCoins: newCoins,
                hasChangedNameBefore: true,
                displayName: newName
            }, { merge: true });

        currentUserData.totalCoins = newCoins;
        currentUserData.hasChangedNameBefore = true;

        document.getElementById("user-coins").innerText = newCoins;
        updateCostText();

        errorMsg.innerText = cost === 0
            ? "âœ… ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù… Ù…Ø¬Ø§Ù†Ù‹Ø§!"
            : `âœ… ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù… ÙˆØ®ØµÙ… ${cost} ÙƒÙˆÙŠÙ†Ø²`;
        errorMsg.style.color = "#34d399";

    } catch (e) {
        console.error(e);
        errorMsg.innerText = "âŒ ÙØ´Ù„ Ø§Ù„ØªØºÙŠÙŠØ±";
        errorMsg.style.color = "#ff4f4f";
    }

    saveBtn.disabled = false;
};
</script>

</body>
</html>
