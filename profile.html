<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‘¤ Ù…Ù„ÙÙŠ Ø§Ù„Ù…Ù„ÙƒÙŠ Ø§Ù„Ù…Ø·ÙˆØ±</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="auth.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        :root {
            --primary: #6366f1;
            --accent-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            --bg-body: #0a0f1e;
            --card-bg: rgba(30, 41, 59, 0.7);
            --text-main: #f1f5f9;
            --text-dim: #94a3b8;
            --gold: #ffd700;
            
            /* Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù†Ø¯Ø±Ø© */
            --rarity-dev: linear-gradient(45deg, #ff0000, #330000);
            --rarity-pro: linear-gradient(45deg, #f472b6, #7c3aed);
            --rarity-legendary: linear-gradient(45deg, #fbbf24, #d97706);
            --rarity-epic: linear-gradient(45deg, #a855f7, #6366f1);
            --rarity-rare: linear-gradient(45deg, #10b981, #059669);
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-body);
            background-image: radial-gradient(circle at top right, #1e1b4b, transparent);
            color: var(--text-main);
            padding: 20px; min-height: 100vh;
            display: flex; flex-direction: column; align-items: center; margin: 0;
        }

        .card {
            background: var(--card-bg); backdrop-filter: blur(15px); padding: 25px;
            border-radius: 24px; width: 100%; max-width: 500px;
            border: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); box-sizing: border-box;
        }

        .profile-header { text-align: center; }
        .avatar-container { width: 110px; height: 110px; margin: 0 auto 15px; position: relative; }
        .avatar-frame { width: 100%; height: 100%; border-radius: 50%; border: 4px solid var(--primary); overflow: hidden; background: #1e293b; }
        #profile-img { width: 100%; height: 100%; object-fit: cover; }

        /* --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ø§Ø±Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯ --- */
        #user-badges { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
        
        .badge-slot {
            width: 40px; height: 40px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; position: relative;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
        }

        /* Ø³ØªØ§ÙŠÙ„Ø§Øª Ø§Ù„Ù†Ø¯Ø±Ø© */
        .rarity-dev { background: var(--rarity-dev); border-color: #ff0000; box-shadow: 0 0 15px rgba(255,0,0,0.5); }
        .rarity-pro { background: var(--rarity-pro); border-color: #f472b6; }
        .rarity-legendary { background: var(--rarity-legendary); border-color: #fbbf24; }
        .rarity-epic { background: var(--rarity-epic); border-color: #a855f7; }
        .rarity-rare { background: var(--rarity-rare); border-color: #10b981; }

        .badges-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 12px; margin-top: 15px; }
        .badge-item {
            background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px; padding: 10px 5px; text-align: center; cursor: pointer;
            transition: 0.3s; position: relative;
        }
        .badge-item.locked { filter: grayscale(1) opacity(0.3); cursor: not-allowed; }
        .badge-item.selected { border-color: var(--gold); transform: scale(1.05); background: rgba(255,255,255,0.1); }
        .badge-item i { font-size: 1.5rem; margin-bottom: 5px; display: block; }
        .badge-item span { font-size: 0.6rem; font-weight: bold; display: block; }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .btn-save { background: var(--accent-gradient); border: none; color: white; padding: 12px 20px; border-radius: 12px; font-weight: 900; cursor: pointer; width: 100%; margin-top: 10px; }
        .btn-save:disabled { opacity: 0.3; }
        .item-badge { background: rgba(99, 102, 241, 0.1); color: var(--primary); padding: 4px 12px; border-radius: 10px; font-size: 0.75rem; font-weight: bold; margin-bottom: 5px; }
    </style>
</head>
<body>

<div class="card profile-header">
    <div class="avatar-container">
        <div class="avatar-frame"><img id="profile-img" src="https://via.placeholder.com/150"></div>
    </div>
    
    <div id="user-badges"></div>

    <h2 id="display-name" style="margin: 5px 0;">...</h2>
    <p style="font-size: 0.9rem;">ID: <span id="user-id-display" style="color:var(--gold); font-weight:900;">---</span></p>
</div>

<div class="card">
    <h3 style="margin:0; font-size: 1rem; color: var(--gold);"><i class="fas fa-medal"></i> Ø®Ø²Ø§Ù†Ø© Ø§Ù„Ø´Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù„ÙƒÙŠØ©</h3>
    <div id="badges-library" class="badges-grid"></div>
</div>

<div class="card">
    <h3 style="margin:0; font-size: 1rem; color: var(--primary);"><i class="fas fa-user-edit"></i> ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
    <input id="nameInput" type="text" placeholder="Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯..." style="width:100%; padding:12px; background:rgba(0,0,0,0.3); border:1px solid #444; border-radius:10px; color:white; margin-top:10px; box-sizing:border-box;">
    <button id="saveBtn" class="btn-save" disabled onclick="handleSaveName()">Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯</button>
</div>

<button class="btn-save" style="max-width:500px; background:#1e293b;" onclick="location.href='index.html'">Ø§Ù„Ø¹ÙˆØ¯Ø©</button>

<script>
// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø§Ø±Ø§Øª Ø§Ù„Ø´Ø§Ù…Ù„Ø© (Ø§Ù„Ù†Ø¯Ø±Ø©ØŒ Ø§Ù„Ø´Ø±ÙˆØ·ØŒ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª)
const BADGE_SETTINGS = {
    "dev_badge": { name: "Ø§Ù„Ù…Ø·ÙˆØ±", icon: "fa-code", rarity: "dev", desc: "Ø®Ø§Øµ Ø¨Ù…Ø·ÙˆØ± Ø§Ù„Ù†Ø¸Ø§Ù…" },
    "pro_badge": { name: "ØªØ§Ø¬ Ø§Ù„Ø¨Ø±Ùˆ", icon: "fa-crown", rarity: "pro", desc: "Ù„Ù…Ø´ØªØ±ÙƒÙŠ Ø§Ù„Ø¨Ø±Ùˆ" },
    "rich_badge": { name: "Ø«Ø±ÙŠ (Top 10)", icon: "fa-gem", rarity: "legendary", desc: "Ø£ØºÙ†Ù‰ 10 Ù„Ø§Ø¹Ø¨ÙŠÙ†" },
    "active_badge": { name: "Ù…ØªÙØ§Ø¹Ù„ (Top 10)", icon: "fa-fire", rarity: "epic", desc: "Ø£ÙƒØ«Ø± 10 Ù†Ø´Ø§Ø·Ø§Ù‹" },
    "legend_badge": { name: "Ø§Ù„Ø£Ø³Ø·ÙˆØ±Ø©", icon: "fa-shield-halved", rarity: "rare", desc: "Ø´Ø§Ø±Ø© Ù†Ø§Ø¯Ø±Ø©" },
    "dragon_badge": { name: "Ø§Ù„ØªÙ†ÙŠÙ†", icon: "fa-dragon", rarity: "rare", desc: "Ø´Ø§Ø±Ø© Ù†Ø§Ø¯Ø±Ø©" }
};

let userDocData = null;

auth.onAuthStateChanged(async user => {
    if (!user) return;
    
    // ÙØ­Øµ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Ø±Ø§Øª Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø±Ø¶
    await checkAutoBadges(user.uid);

    db.collection('users').doc(user.uid).onSnapshot(doc => {
        if (doc.exists) {
            userDocData = doc.data();
            updateUI();
        }
    });
});

// Ø¯Ø§Ù„Ø© ÙØ­Øµ Ø§Ù„Ø´Ø§Ø±Ø§Øª Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© (Ø§Ù„Ø¨Ø±ÙˆØŒ Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†ØŒ Ø§Ù„Ù…Ø·ÙˆØ±)
async function checkAutoBadges(uid) {
    const userRef = db.collection('users').doc(uid);
    const doc = await userRef.get();
    const data = doc.data();
    let currentBadges = data.badges || [];
    let changed = false;

    // 1. Ø´Ø§Ø±Ø© Ø§Ù„Ù…Ø·ÙˆØ± (Ø¶Ø¹ Ø§ÙŠÙ…ÙŠÙ„Ùƒ Ø£Ùˆ Ø§Ù„Ù€ ID Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù‡Ù†Ø§)
    if(data.role === 'admin' || data.email === 'admin@gmail.com') {
        if(!currentBadges.includes('dev_badge')) { currentBadges.push('dev_badge'); changed = true; }
    }

    // 2. Ø´Ø§Ø±Ø© Ø§Ù„Ø¨Ø±Ùˆ
    const isPro = data.proExpiryTime > Date.now();
    if(isPro && !currentBadges.includes('pro_badge')) {
        currentBadges.push('pro_badge'); changed = true;
    } else if(!isPro && currentBadges.includes('pro_badge')) {
        currentBadges = currentBadges.filter(b => b !== 'pro_badge'); changed = true;
    }

    // 3. Ø´Ø§Ø±Ø© Ø«Ø±ÙŠ (Ø£ÙØ¶Ù„ 10 ÙƒÙˆÙŠÙ†Ø²)
    const topCoins = await db.collection('users').orderBy('totalCoins', 'desc').limit(10).get();
    const isTopCoin = topCoins.docs.some(d => d.id === uid);
    if(isTopCoin && !currentBadges.includes('rich_badge')) {
        currentBadges.push('rich_badge'); changed = true;
    }

    // 4. Ø´Ø§Ø±Ø© Ù…ØªÙØ§Ø¹Ù„ (Ø£ÙØ¶Ù„ 10 XP)
    const topXP = await db.collection('users').orderBy('xp', 'desc').limit(10).get();
    const isTopXP = topXP.docs.some(d => d.id === uid);
    if(isTopXP && !currentBadges.includes('active_badge')) {
        currentBadges.push('active_badge'); changed = true;
    }

    if(changed) await userRef.update({ badges: currentBadges });
}

function updateUI() {
    document.getElementById("display-name").innerText = userDocData.displayName || "Ù„Ø§Ø¹Ø¨";
    document.getElementById("user-id-display").innerText = userDocData.customID || userDocData.publicUid || "---";
    if (userDocData.photoURL) document.getElementById('profile-img').src = userDocData.photoURL;

    // Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¬Ù‡Ø²Ø© ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±
    const badgeContainer = document.getElementById("user-badges");
    badgeContainer.innerHTML = "";
    const equipped = userDocData.equippedBadges || [];
    
    equipped.forEach(bKey => {
        const config = BADGE_SETTINGS[bKey];
        if(config) {
            badgeContainer.innerHTML += `
                <div class="badge-slot rarity-${config.rarity}" title="${config.name}">
                    <i class="fas ${config.icon}"></i>
                </div>`;
        }
    });

    renderLibrary();
    
    // ÙØ­Øµ Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø§Ø³Ù…
    const nameCards = (userDocData.inventory || []).filter(i => i === "Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø§Ø³Ù…").length;
    document.getElementById("saveBtn").disabled = nameCards === 0;
    document.getElementById("saveBtn").innerText = nameCards > 0 ? `ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù… (Ù…ØªØ§Ø­ ${nameCards})` : "Ù„Ø§ ØªÙ…Ù„Ùƒ Ø¨Ø·Ø§Ù‚Ø© ØªØºÙŠÙŠØ± Ø§Ø³Ù…";
}

function renderLibrary() {
    const lib = document.getElementById("badges-library");
    lib.innerHTML = "";
    const owned = userDocData.badges || [];
    const equipped = userDocData.equippedBadges || [];

    Object.keys(BADGE_SETTINGS).forEach(key => {
        const config = BADGE_SETTINGS[key];
        const isOwned = owned.includes(key);
        const isEquipped = equipped.includes(key);

        const div = document.createElement("div");
        div.className = `badge-item ${!isOwned ? 'locked' : ''} ${isEquipped ? 'selected' : ''}`;
        div.innerHTML = `
            <i class="fas ${config.icon} ${isOwned ? 'text-white' : ''}"></i>
            <span>${config.name}</span>
            <small style="font-size:8px; opacity:0.6">${config.rarity.toUpperCase()}</small>
        `;

        if(isOwned) {
            div.onclick = () => toggleBadge(key);
        }
        lib.appendChild(div);
    });
}

async function toggleBadge(key) {
    let equipped = [...(userDocData.equippedBadges || [])];
    if(equipped.includes(key)) {
        equipped = equipped.filter(k => k !== key);
    } else {
        if(equipped.length >= 5) return alert("Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 5 Ø´Ø§Ø±Ø§Øª ÙÙ‚Ø·!");
        equipped.push(key);
    }
    await db.collection('users').doc(auth.currentUser.uid).update({ equippedBadges: equipped });
}

async function handleSaveName() {
    const newName = document.getElementById('nameInput').value.trim();
    if(newName.length < 3) return alert("Ø§Ù„Ø§Ø³Ù… Ù‚ØµÙŠØ±!");
    
    let inv = [...(userDocData.inventory || [])];
    const idx = inv.indexOf("Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø§Ø³Ù…");
    if(idx > -1) {
        inv.splice(idx, 1);
        await db.collection('users').doc(auth.currentUser.uid).update({ 
            displayName: newName, 
            inventory: inv 
        });
        alert("ØªÙ… Ø§Ù„ØªØºÙŠÙŠØ±!");
    }
}
</script>
</body>
</html>
