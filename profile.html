<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ‘¤ Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ</title>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="auth.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
/* ... (Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ) ... */
body{font-family:'Cairo',sans-serif;background:#0f172a;color:#f1f5f9;text-align:center;padding:20px}
h2 { color:#34d399; }
.card{background:#1e293b;padding:25px;border-radius:12px;max-width:450px;margin:20px auto;text-align:right;}
.info-item{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #334155;font-weight:700;}
input,button{width:100%;padding:12px;border-radius:8px;border:none;font-family:'Cairo'}
input{background:#334155;color:white;margin-bottom:10px}
button{background:#34d399;color:white;font-weight:700;cursor:pointer}
button:disabled{background:#475569}
#error{margin-top:10px;min-height:20px;text-align:center;}

/* ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø±Ø¶ Ø§Ù„Ù€ UID Ù…Ø¹ Ø²Ø± Ø§Ù„Ù†Ø³Ø® */
.uid-container {
    display: flex;
    align-items: center;
    justify-content: flex-end; /* Ù„Ø¬Ø¹Ù„Ù‡ ÙŠØ¨Ø¯Ø£ Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† */
    gap: 10px;
    direction: ltr; /* Ù„Ø¶Ù…Ø§Ù† Ø¹Ø±Ø¶ Ø§Ù„Ù€ UID Ù…Ù† Ø§Ù„ÙŠØ³Ø§Ø± Ù„Ù„ÙŠÙ…ÙŠÙ† */
}
#publicUid {
    direction: ltr; 
    font-size: 0.9rem;
    color: #ffd700;
}
.copy-btn {
    background: none;
    border: none;
    color: #94a3b8;
    cursor: pointer;
    padding: 0;
    width: 20px;
}
.copy-btn:hover {
    color: #34d399;
}
/* Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù‡Ø¯Ø§ÙŠØ§ */
.gifts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 15px;
    margin-top: 20px;
    text-align: center;
}
.gift-icon {
    background: #334155;
    padding: 10px;
    border-radius: 8px;
    font-size: 2rem;
    position: relative;
    overflow: hidden;
    transition: transform 0.2s;
}
.gift-icon:hover {
    transform: translateY(-3px);
}

.gift-icon.locked {
    filter: grayscale(100%) opacity(50%);
}
.gift-icon.unlocked {
    border: 2px solid #34d399;
}
.gift-icon.unlocked .count {
    background: #34d399;
    color: #0f172a;
    border-radius: 50%;
    padding: 2px 6px;
    font-size: 0.7rem;
    position: absolute;
    top: -5px;
    right: -5px;
    font-weight: 700;
}
.gift-icon.unlocked .best-sender {
    font-size: 0.6rem;
    color: #facc15;
    display: block;
    margin-top: 5px;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
}
</style>
</head>

<body>

<h2>ğŸ‘¤ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h2>

<div class="card">
    <div class="info-item"><span>Ø§Ù„Ø¨Ø±ÙŠØ¯</span><span id="email">...</span></div>
    
    <div class="info-item">
        <span>Public UID</span>
        <div class="uid-container">
            <span id="publicUid">...</span>
            <button class="copy-btn" onclick="copyPublicUid()">
                <i class="fas fa-copy"></i>
            </button>
        </div>
    </div>
    
    <div class="info-item"><span>Ø§Ù„Ù…Ø³ØªÙˆÙ‰</span><span id="level">...</span></div>
    <div class="info-item"><span>XP</span><span id="xp">...</span></div>
    <div class="info-item"><span>Ø§Ù„Ø­Ø§Ù„Ø©</span><span id="status">...</span></div>
    <div class="info-item"><span>Ø§Ù„ÙƒÙˆÙŠÙ†Ø²</span><span id="coins">...</span></div>
</div>

<div class="card">
    <h3>Ù…Ø¬Ù…ÙˆØ¹Ø© Ù‡Ø¯Ø§ÙŠØ§ <i class="fas fa-box-open"></i></h3>
    <p style="color:#94a3b8; font-size:0.9rem;">Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„ØªÙŠ ØªÙ„Ù‚ÙŠØªÙ‡Ø§</p>
    <div id="gifts-collection-container" class="gifts-grid">
        Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§...
    </div>
</div>

<div class="card">
    <h3>ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶</h3>
    <p id="costText" style="color:#facc15;font-weight:700"></p>
    <input id="nameInput" disabled placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙŠØ¯">
    <button id="saveBtn" disabled>Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±</button>
    <div id="error"></div>
</div>

<button onclick="location.href='index.html'" style="background:#6366f1;max-width:450px;width:100%">
    Ø§Ù„Ø¹ÙˆØ¯Ø© <i class="fas fa-arrow-right"></i>
</button>

<script>
let userData=null;
let isSaving=false;
const BASE_COST=500;
const GIFTS_DEFINITION = [ /* ... (Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ) ... */
    {name:"ÙˆØ±Ø¯Ø©", icon:"ğŸŒ¹"},
    {name:"Ù‚Ù„Ù… Ø°Ù‡Ø¨ÙŠ", icon:"ğŸ–‹ï¸"},
    {name:"Ø³ÙŠØ§Ø±Ø© Ø³Ø¨Ø§Ù‚", icon:"ğŸï¸"},
    {name:"Ø·Ø§Ø¦Ø±Ø© Ø®Ø§ØµØ©", icon:"âœˆï¸"},
    {name:"ÙŠØ®Øª ÙØ§Ø®Ø±", icon:"ğŸ›¥ï¸"},
    {name:"Ù…Ø¬ÙˆÙ‡Ø±Ø§Øª", icon:"ğŸ’"},
    {name:"ÙƒØªØ§Ø¨ Ø³Ø­Ø±ÙŠ", icon:"ğŸ“–"},
    {name:"ØªØ§Ø¬ Ù…Ù„ÙƒÙŠ", icon:"ğŸ‘‘"}
];

const nameInput=document.getElementById("nameInput");
const saveBtn=document.getElementById("saveBtn");
const errorBox=document.getElementById("error");
const costText=document.getElementById("costText");

// ğŸš¨ Ø¯Ø§Ù„Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
function copyPublicUid() {
    const uid = document.getElementById("publicUid").innerText;
    navigator.clipboard.writeText(uid)
        .then(() => {
            errorBox.innerText = "âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù€ UID!";
            errorBox.style.color = "#22c55e";
            setTimeout(() => { errorBox.innerText = ""; }, 3000);
        })
        .catch(err => {
            console.error('ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®:', err);
            errorBox.innerText = "âŒ ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®";
            errorBox.style.color = "#ef4444";
        });
}

// ğŸš¨ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯Ø§Ù„Ø©: Ù„Ù† Ù†Ø­ØªØ§Ø¬ Ù„Ù€ generateUniquePublicUid Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ø¢Ù†ØŒ ÙÙ‚Ø· ÙÙŠ auth.js
// ÙˆÙ„ÙƒÙ† ÙŠØ¬Ø¨ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ù„Ø© isPro/isProUser ÙÙŠ auth.js 
function isProUser(data) {
    const expiry = data?.proExpiryTime || 0;
    return expiry > Date.now();
}


/* ---------------- GIFT RENDERING ---------------- */

async function loadGiftsData() {
    const user = firebase.auth().currentUser;
    if (!user) return {};

    const receivedGifts = userData.receivedGifts || {};
    
    const senderUids = new Set();
    for (const index in receivedGifts) {
        const senders = receivedGifts[index].senders || {};
        const maxSenderUid = Object.keys(senders).reduce((a, b) => senders[a] > senders[b] ? a : b, null);
        if (maxSenderUid) senderUids.add(maxSenderUid);
    }

    const senderNames = {};
    if (senderUids.size > 0) {
        // ğŸš¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ù„Ø© getDisplayNamesByUids Ù…Ù† auth.js
        const namesMap = await getDisplayNamesByUids(Array.from(senderUids)); 
        Object.assign(senderNames, namesMap);
    }
    
    return { receivedGifts, senderNames };
}

async function renderGifts() {
    const container = document.getElementById("gifts-collection-container");
    container.innerHTML = 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§...';
    
    try {
        const { receivedGifts, senderNames } = await loadGiftsData();
        container.innerHTML = '';
        
        GIFTS_DEFINITION.forEach((gift, index) => {
            const giftData = receivedGifts[index];
            const unlocked = !!giftData && (giftData.count || 0) > 0;
            
            const div = document.createElement('div');
            div.className = `gift-icon ${unlocked ? 'unlocked' : 'locked'}`;
            div.setAttribute('title', gift.name);
            
            let bestSenderName = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
            if (unlocked) {
                bestSenderName = getBestSenderName(giftData.senders, senderNames);
            }
            
            div.innerHTML = `
                ${gift.icon}
                ${unlocked ? `<span class="count">${giftData.count}</span>` : ''}
                ${unlocked ? `<span class="best-sender">Ù…Ù†: ${bestSenderName}</span>` : ''}
            `;
            container.appendChild(div);
        });
        
        if (GIFTS_DEFINITION.length === 0) {
            container.innerHTML = "<p style='color:#94a3b8;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‡Ø¯Ø§ÙŠØ§ Ù…Ø­Ø¯Ø¯Ø© Ø¨Ø¹Ø¯.</p>";
        }

    } catch (error) {
        console.error("ÙØ´Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§:", error);
        container.innerHTML = "<p style='color:#ef4444;'>Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§.</p>";
    }
}

function getBestSenderName(senders, senderNames) {
    if (!senders || Object.keys(senders).length === 0) return 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';

    const maxSenderUid = Object.keys(senders).reduce((a, b) => senders[a] > senders[b] ? a : b);
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø±Ø³Ù„ Ù‡Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†ÙØ³Ù‡ØŒ Ù„Ø§ ØªØ¹Ø±Ø¶ Ø§Ù„Ø§Ø³Ù…
    if (maxSenderUid === firebase.auth().currentUser.uid) {
        return 'Ù†ÙØ³Ùƒ';
    }
    
    return senderNames[maxSenderUid] || 'Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¬Ù‡ÙˆÙ„';
}

/* ---------------- AUTH LOAD ---------------- */

firebase.auth().onAuthStateChanged(async user=>{
    if(!user) return location.href="auth.html";

    // ğŸš¨ Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ù„Ø¥Ù†Ø´Ø§Ø¡ UID Ù‡Ù†Ø§ØŒ Ø¨Ù„ Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ auth.js Ù„Ø¬Ù„Ø¨ Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Public UID
    userData=await loadUserData();
    if(!userData){ errorBox.innerText="ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"; return; }

    // Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„
    document.getElementById("email").innerText=user.email;
    document.getElementById("publicUid").innerText=userData.publicUid||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯"; // ğŸš¨ Ø¹Ø±Ø¶ Public UID
    document.getElementById("level").innerText=userData.level||1;
    document.getElementById("xp").innerText=userData.xp||0;
    document.getElementById("coins").innerText=userData.totalCoins||0;

    const isPro = isProUser(userData);
    document.getElementById("status").innerText=isPro?"Pro ğŸ‘‘":"Ø¹Ø§Ø¯ÙŠ";

    nameInput.value=user.displayName||user.email.split("@")[0];
    nameInput.disabled=false;

    await updateCost(isPro);
    validate();
    
    await renderGifts();
});

/* ---------------- NAME CHANGE ---------------- */

nameInput.addEventListener("input",validate);

function validate(){
    const current=nameInput.value.trim();
    const original=firebase.auth().currentUser.displayName||firebase.auth().currentUser.email.split("@")[0];
    saveBtn.disabled=isSaving||current.length<3||current===original;
}

async function isNameAvailable(name){
    // ğŸš¨ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø§Ø³Ù… ÙˆØ¹Ø¯Ù… ØªØ¶Ø§Ø±Ø¨ Ø§Ù„Ù€ Public UID
    if (name.toUpperCase().startsWith("IMP-")) return false; // Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… ÙŠØ¨Ø¯Ø£ Ø¨Ù€ Public UID
    
    const snap=await firebase.firestore()
        .collection("users")
        .where("displayName","==",name)
        .limit(1).get();
    return snap.empty||snap.docs[0].id===firebase.auth().currentUser.uid;
}

async function updateCost(isPro){
    if(!userData.hasChangedNameBefore){
        costText.innerText="ğŸ‰ Ø£ÙˆÙ„ ØªØºÙŠÙŠØ± Ù…Ø¬Ø§Ù†ÙŠ";
        userData.finalCost=0;
        return;
    }
    userData.finalCost=BASE_COST;
    costText.innerText=`ğŸ’° ØªÙƒÙ„ÙØ© Ø§Ù„ØªØºÙŠÙŠØ±: ${BASE_COST} ÙƒÙˆÙŠÙ†Ø²`;
}

saveBtn.onclick=async()=>{
    if(isSaving) return;
    isSaving=true; saveBtn.disabled=true; errorBox.innerText="";

    const user=firebase.auth().currentUser;
    const newName=nameInput.value.trim();

    if(!(await isNameAvailable(newName))){
        errorBox.innerText="âŒ Ø§Ù„Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„ Ø£Ùˆ Ù…Ø­Ø¬ÙˆØ² (Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ IMP-)";
        isSaving=false; validate(); return;
    }

    if(userData.totalCoins<userData.finalCost){
        errorBox.innerText="âŒ ÙƒÙˆÙŠÙ†Ø² ØºÙŠØ± ÙƒØ§ÙÙŠØ© Ù„Ù„ØªØºÙŠÙŠØ±";
        isSaving=false; validate(); return;
    }

    try{
        // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù… ÙÙŠ Firebase Auth
        await user.updateProfile({displayName:newName});
        const newCoins=userData.totalCoins-userData.finalCost;

        // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ© ÙÙŠ Firestore Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… merge: true
        // (Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« displayNameØŒ totalCoinsØŒ hasChangedNameBefore ÙÙ‚Ø·)
        await firebase.firestore().collection("users").doc(user.uid).set({
            displayName:newName,
            totalCoins:newCoins,
            hasChangedNameBefore:true,
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp() // Ù…Ù‡Ù… Ù„Ù„Ù‚ÙˆØ§Ø¹Ø¯
        },{merge:true});

        // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        userData.totalCoins=newCoins;
        userData.hasChangedNameBefore=true;
        document.getElementById("coins").innerText=newCoins;
        errorBox.innerText="âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙˆØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…";
        errorBox.style.color="#22c55e";
    }catch(e){
        errorBox.innerText="âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸ (Ù‚Ø¯ ØªÙƒÙˆÙ† Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø§Ù†)";
        errorBox.style.color="#ef4444";
        console.error("Ø®Ø·Ø£ ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…:", e);
    }
    isSaving=false; validate();
};
</script>

</body>
</html>
