<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‘¤ Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ</title>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="auth.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #0f172a; 
            color: #f1f5f9; 
            text-align: center;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h1 {
            color: #34d399;
            margin-bottom: 30px;
        }
        .card {
            background-color: #1e293b; 
            padding: 30px;
            border-radius: 12px;
            max-width: 450px;
            width: 90%;
            margin: 20px auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 10px 15px rgba(0, 0, 0, 0.2);
            text-align: right;
        }
        input[type="text"] {
            font-family: 'Cairo', sans-serif;
            width: calc(100% - 24px); 
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #334155;
            font-size: 16px;
            background-color: #334155; 
            color: #f1f5f9;
            margin-bottom: 20px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            font-weight: 700;
            border: none;
            border-radius: 8px; 
            cursor: pointer;
            transition: background-color 0.3s;
            width: 100%;
            margin-top: 10px;
        }
        #save-name-btn {
            background-color: #34d399;
            color: white;
        }
        #save-name-btn:hover:enabled {
            background-color: #10b981;
        }
        #save-name-btn:disabled {
            background-color: #475569;
            cursor: not-allowed;
        }
        #back-btn {
            background-color: #6366f1;
            color: white;
        }
        #back-btn:hover {
            background-color: #4f46e5;
        }
        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #334155;
        }
        .info-item:last-child {
            border-bottom: none;
        }
        .label {
            color: #94a3b8;
        }
        .value {
            font-weight: 700;
        }
        #error-message {
            margin-top: 10px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body onload="checkAuthState()">

    <h1>ğŸ‘¤ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h1>

    <div class="card">
        <h3>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨</h3>
        <div class="info-item">
            <span class="label">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ:</span>
            <span class="value" id="user-level-profile">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
        </div>
        <div class="info-item">
            <span class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù†Ù‚Ø§Ø· Ø§Ù„Ø®Ø¨Ø±Ø© (XP):</span>
            <span class="value" id="user-xp-profile">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
        </div>
        <div class="info-item">
            <span class="label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</span>
            <span class="value" id="user-email">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
        </div>
        <div class="info-item">
            <span class="label">Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©:</span>
            <span class="value" id="pro-status">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
        </div>
        <div class="info-item">
            <span class="label">Ø§Ù„ÙƒÙˆÙŠÙ†Ø² Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©:</span>
            <span class="value" id="user-coins">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
        </div>
    </div>

    <div class="card">
        <h3>ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶</h3>
        <p style="color:#ffcc00; font-weight:700;">ğŸš¨ Ø±Ø³ÙˆÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…: <span id="name-change-cost">500</span> ÙƒÙˆÙŠÙ†Ø²</p>
        <label for="display-name-input" style="font-weight: 700; color: #f1f5f9;">Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„ÙŠ:</label>
        <input type="text" id="display-name-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙŠØ¯" disabled>
        <p id="error-message"></p>
        <button id="save-name-btn" onclick="saveNewDisplayName()" disabled>Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±</button>
    </div>

    <button id="back-btn" onclick="location.href='index.html'">
        <i class="fas fa-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¹Ø¨Ø©
    </button>
    
<script>
    let currentUserData = null; 
    const db = firebase.firestore();
    const NAME_CHANGE_COST = 500; 

    const nameInput = document.getElementById('display-name-input');
    const saveBtn = document.getElementById('save-name-btn');
    const errorMsg = document.getElementById('error-message');

    // ----------------------------------
    // Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© 
    // ----------------------------------
    function isProUser() {
        const expiryTime = currentUserData?.proExpiryTime || 0;
        return expiryTime > Date.now();
    }
    
    /**
     * @function isNameTaken (Ù…Ø¨Ø³Ø·Ø© Ù„ØªÙ‚Ù„ÙŠÙ„ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø£Ù…Ø§Ù†)
     */
    async function isNameTaken(name) {
        const usersRef = db.collection('users');
        const user = firebase.auth().currentUser;
        if (!user) return false;
        
        try {
            const snapshot = await usersRef.where('displayName', '==', name).limit(1).get();
            if (!snapshot.empty) {
                // Ø¥Ø°Ø§ ÙˆØ¬Ø¯Ù†Ø§ ÙˆØ«ÙŠÙ‚Ø©ØŒ Ù†ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù†Ù‡Ø§ Ù„ÙŠØ³Øª ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ù†ÙØ³Ù‡
                return snapshot.docs[0].id !== user.uid;
            }
            return false;
        } catch(error) {
            console.error("Firebase Rule/Query Error in isNameTaken:", error);
            // Ø¥Ø°Ø§ ÙØ´Ù„Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©ØŒ Ù†Ø¹ØªØ¨Ø± Ø§Ù„Ø§Ø³Ù… ØºÙŠØ± Ù…Ø£Ø®ÙˆØ° Ù„ØªØ¬Ù†Ø¨ ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
            return false; 
        }
    }

    // ----------------------------------
    // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ 
    // ----------------------------------

    async function checkAuthState() {
         firebase.auth().onAuthStateChanged(async (user) => {
            if (user) {
                try {
                    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¨Ø± Ø§Ù„Ø¯Ø§Ù„Ø© ÙÙŠ auth.js
                    currentUserData = await loadUserData(); 
                } catch(err) {
                    console.error("Critical error during loadUserData:", err);
                    displayLoadingError('âš ï¸ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
                    return; 
                }
                
                if (currentUserData) {
                    displayProfileInfo(user);
                    
                    // ØªÙ…ÙƒÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± Ø¹Ù†Ø¯ Ù†Ø¬Ø§Ø­ Ø§Ù„ØªØ­Ù…ÙŠÙ„
                    nameInput.value = user.displayName || user.email.split('@')[0];
                    nameInput.disabled = false;
                    saveBtn.disabled = false;

                } else {
                    displayLoadingError('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….');
                }
                
            } else {
                window.location.href = "auth.html";
            }
        });
    }

    function displayLoadingError(message) {
        const errorText = 'âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„';
        document.getElementById('user-email').innerText = errorText;
        document.getElementById('user-coins').innerText = errorText;
        document.getElementById('user-level-profile').innerText = errorText;
        document.getElementById('user-xp-profile').innerText = errorText;
        document.getElementById('pro-status').innerText = errorText;
        errorMsg.style.color = '#ff4f4f';
        errorMsg.innerText = message || 'ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….';
    }


    function displayProfileInfo(user) {
        document.getElementById('user-email').innerText = user.email || 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
        document.getElementById('user-coins').innerText = currentUserData.totalCoins || 0;
        
        document.getElementById('user-level-profile').innerText = currentUserData.level || 1;
        document.getElementById('user-xp-profile').innerText = currentUserData.xp || 0;
        document.getElementById('name-change-cost').innerText = NAME_CHANGE_COST; 
        
        const statusElement = document.getElementById('pro-status');
        if (isProUser()) {
            statusElement.innerHTML = 'Ø¹Ø¶Ùˆ Ù…ØªÙ…ÙŠØ² (Pro) <i class="fas fa-crown" style="color:#ffd700;"></i>';
        } else {
            statusElement.innerText = 'Ø¹Ø¶Ùˆ Ø¹Ø§Ø¯ÙŠ';
        }
    }

    async function saveNewDisplayName() {
        const newName = nameInput.value.trim();
        const user = firebase.auth().currentUser;
        errorMsg.innerText = '';
        
        if (!currentUserData || !user) {
            errorMsg.innerText = 'âš ï¸ ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù…. Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø­Ù…Ù„Ø©.';
            errorMsg.style.color = '#ff4f4f';
            return;
        }

        if (newName.length < 3) {
            errorMsg.innerText = 'ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ø§Ø³Ù… 3 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.';
            errorMsg.style.color = '#ff4f4f';
            return;
        }
        
        if (newName === user.displayName) {
             errorMsg.innerText = 'Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‡Ùˆ Ù†ÙØ³Ù‡ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯.';
             errorMsg.style.color = '#ffcc00';
             return;
        }

        saveBtn.disabled = true;
        saveBtn.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„ØªØ­Ù‚Ù‚...';

        // ğŸš¨ 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆÙŠÙ†Ø² Ù‚Ø¨Ù„ Ø§Ù„ØªØºÙŠÙŠØ±
        const currentCoins = currentUserData.totalCoins || 0;
        if (currentCoins < NAME_CHANGE_COST) {
            errorMsg.innerText = `âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙˆÙŠÙ†Ø² ÙƒØ§ÙÙŠØ©! Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: ${NAME_CHANGE_COST} ÙƒÙˆÙŠÙ†Ø². Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${currentCoins}.`;
            errorMsg.style.color = '#ff4f4f';
            saveBtn.disabled = false;
            saveBtn.innerText = 'Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±';
            return;
        }

        try {
            // 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø±
            if (await isNameTaken(newName)) {
                errorMsg.innerText = 'âŒ Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„. Ø§Ø®ØªØ± Ø§Ø³Ù…Ø§Ù‹ Ø¢Ø®Ø±.';
                errorMsg.style.color = '#ff4f4f';
                return;
            }
            
            saveBtn.innerText = 'Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù…...';

            // 3. ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶ ÙÙŠ Firebase Auth (ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø§Ù„ØªØ¹Ù„ÙŠÙ‚)
            user.updateProfile({ displayName: newName })
                .catch(err => console.error("Firebase Auth Profile Update Failed:", err));
            
            // 4. Ø®ØµÙ… Ø§Ù„ÙƒÙˆÙŠÙ†Ø² ÙˆØªØ­Ø¯ÙŠØ« Firestore 
            const newCoins = currentCoins - NAME_CHANGE_COST;
            
            await saveUserData(
                newCoins,
                currentUserData.proExpiryTime || 0,
                currentUserData.players || [],
                currentUserData.settings || {},
                currentUserData.level || 1,
                currentUserData.xp || 0,
                currentUserData.ownedPacksPermanent || [],
                currentUserData.ownedPacksTemporary || {}
            );
            
            // 5. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸
            currentUserData.totalCoins = newCoins;
            
            errorMsg.style.color = '#34d399';
            errorMsg.innerText = `âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù… Ø¨Ù†Ø¬Ø§Ø­! ØªÙ… Ø®ØµÙ… ${NAME_CHANGE_COST} ÙƒÙˆÙŠÙ†Ø².`;
            
            displayProfileInfo(user);
            
        } catch (error) {
            console.error("Ø®Ø·Ø£ Ø­Ø§Ø³Ù… ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù…:", error);
            errorMsg.style.color = '#ff4f4f';
            errorMsg.innerText = 'ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù…: ' + (error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ.');
        } finally {
            saveBtn.disabled = false;
            saveBtn.innerText = 'Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±';
        }
    }
</script>

</body>
</html>
