<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ‘¤ Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ</title>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="auth.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght=400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
/* Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© */
body{font-family:'Cairo',sans-serif;background:#0f172a;color:#f1f5f9;text-align:center;padding:20px}
h2 { color:#34d399; }
.card{background:#1e293b;padding:25px;border-radius:12px;max-width:450px;margin:20px auto;text-align:right;}
.info-item{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #334155;font-weight:700;}
input,button{width:100%;padding:12px;border-radius:8px;border:none;font-family:'Cairo'}
input{background:#334155;color:white;margin-bottom:10px}
button{background:#34d399;color:white;font-weight:700;cursor:pointer}
button:disabled{background:#475569}
#error{margin-top:10px;min-height:20px}

/* Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù‡Ø¯Ø§ÙŠØ§ */
.gifts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 15px;
    margin-top: 20px;
    text-align: center;
}
.gift-icon {
    background: #334155;
    padding: 10px;
    border-radius: 8px;
    font-size: 2rem;
    position: relative;
    overflow: hidden;
    transition: transform 0.2s;
}
.gift-icon:hover {
    transform: translateY(-3px);
}

.gift-icon.locked {
    filter: grayscale(100%) opacity(50%);
}
.gift-icon.unlocked {
    border: 2px solid #34d399;
}
.gift-icon.unlocked .count {
    background: #34d399;
    color: #0f172a;
    border-radius: 50%;
    padding: 2px 6px;
    font-size: 0.7rem;
    position: absolute;
    top: -5px;
    right: -5px;
    font-weight: 700;
}
.gift-icon.unlocked .best-sender {
    font-size: 0.6rem;
    color: #facc15;
    display: block;
    margin-top: 5px;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
}
</style>
</head>

<body>

<h2>ğŸ‘¤ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h2>

<div class="card">
    <div class="info-item"><span>Ø§Ù„Ø¨Ø±ÙŠØ¯</span><span id="email">...</span></div>
    <div class="info-item"><span>Public UID</span><span id="publicUid">...</span></div>
    <div class="info-item"><span>Ø§Ù„Ù…Ø³ØªÙˆÙ‰</span><span id="level">...</span></div>
    <div class="info-item"><span>XP</span><span id="xp">...</span></div>
    <div class="info-item"><span>Ø§Ù„Ø­Ø§Ù„Ø©</span><span id="status">...</span></div>
    <div class="info-item"><span>Ø§Ù„ÙƒÙˆÙŠÙ†Ø²</span><span id="coins">...</span></div>
</div>

<div class="card">
    <h3>Ù…Ø¬Ù…ÙˆØ¹Ø© Ù‡Ø¯Ø§ÙŠØ§ <i class="fas fa-box-open"></i></h3>
    <p style="color:#94a3b8; font-size:0.9rem;">Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„ØªÙŠ ØªÙ„Ù‚ÙŠØªÙ‡Ø§</p>
    <div id="gifts-collection-container" class="gifts-grid">
        </div>
</div>

<div class="card">
    <h3>ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶</h3>
    <p id="costText" style="color:#facc15;font-weight:700"></p>
    <input id="nameInput" disabled placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙŠØ¯">
    <button id="saveBtn" disabled>Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±</button>
    <div id="error"></div>
</div>

<button onclick="location.href='index.html'" style="background:#6366f1;max-width:450px;width:100%">
    Ø§Ù„Ø¹ÙˆØ¯Ø© <i class="fas fa-arrow-right"></i>
</button>

<script>
let userData=null;
let isSaving=false;
const BASE_COST=500;
const GIFTS_DEFINITION = [ // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ (ÙŠØ¬Ø¨ Ø£Ù† ØªØªØ·Ø§Ø¨Ù‚ Ù…Ø¹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ ÙÙŠ gifts.html)
    {name:"ÙˆØ±Ø¯Ø©", icon:"ğŸŒ¹"},
    {name:"Ù‚Ù„Ù… Ø°Ù‡Ø¨ÙŠ", icon:"ğŸ–‹ï¸"},
    {name:"Ø³ÙŠØ§Ø±Ø© Ø³Ø¨Ø§Ù‚", icon:"ğŸï¸"},
    {name:"Ø·Ø§Ø¦Ø±Ø© Ø®Ø§ØµØ©", icon:"âœˆï¸"},
    {name:"ÙŠØ®Øª ÙØ§Ø®Ø±", icon:"ğŸ›¥ï¸"},
    {name:"Ù…Ø¬ÙˆÙ‡Ø±Ø§Øª", icon:"ğŸ’"},
    {name:"ÙƒØªØ§Ø¨ Ø³Ø­Ø±ÙŠ", icon:"ğŸ“–"},
    {name:"ØªØ§Ø¬ Ù…Ù„ÙƒÙŠ", icon:"ğŸ‘‘"}
];

const nameInput=document.getElementById("nameInput");
const saveBtn=document.getElementById("saveBtn");
const errorBox=document.getElementById("error");
const costText=document.getElementById("costText");

/* ---------------- PUBLIC UID ---------------- */
function generatePublicUid(){
    const chars="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    const part=()=>Array.from({length:4},()=>chars[Math.floor(Math.random()*chars.length)]).join("");
    return `IMP-${part()}-${part()}`;
}

async function generateUniquePublicUid(){
    while(true){
        const uid=generatePublicUid();
        const snap=await firebase.firestore()
            .collection("users")
            .where("publicUid","==",uid)
            .limit(1).get();
        if(snap.empty) return uid;
    }
}

/* ---------------- GIFT RENDERING ---------------- */

async function loadGiftsData() {
    const user = firebase.auth().currentUser;
    if (!user) return {};

    // ğŸš¨ Ø§ÙØªØ±Ø§Ø¶: ÙŠØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø© ÙÙŠ Ø­Ù‚Ù„ 'receivedGifts'
    // { "giftIndex": { "count": 5, "senders": { "UID1": 3, "UID2": 2 } }, ... }
    
    // Ø³Ù†Ø³ØªØ®Ø¯Ù… Ø¯Ø§Ù„Ø© loadUserData Ù„Ø­ÙØ¸ Ø§Ù„Ø­Ù‚Ù„
    const receivedGifts = userData.receivedGifts || {};
    
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¹Ø±Ø¶ (Display Names) Ù„Ù„Ù…Ø±Ø³Ù„ÙŠÙ† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠÙŠÙ†
    const senderUids = new Set();
    for (const index in receivedGifts) {
        const senders = receivedGifts[index].senders || {};
        const maxSenderUid = Object.keys(senders).reduce((a, b) => senders[a] > senders[b] ? a : b, null);
        if (maxSenderUid) senderUids.add(maxSenderUid);
    }

    const senderNames = {};
    if (senderUids.size > 0) {
        // ØªØ­Ù…ÙŠÙ„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù‚Ø¯ ØªÙƒÙˆÙ† Ù…Ø¹Ù‚Ø¯Ø© ÙˆØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø©)
        // ğŸš¨ Ø§ÙØªØ±Ø§Ø¶: Ù„Ø¯ÙŠÙ†Ø§ Ø¯Ø§Ù„Ø© getDisplayNamesByUids(uids) ÙÙŠ auth.js
        const namesMap = await getDisplayNamesByUids(Array.from(senderUids));
        Object.assign(senderNames, namesMap);
    }
    
    return { receivedGifts, senderNames };
}

async function renderGifts() {
    const container = document.getElementById("gifts-collection-container");
    container.innerHTML = 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§...';
    
    const { receivedGifts, senderNames } = await loadGiftsData();
    container.innerHTML = '';
    
    GIFTS_DEFINITION.forEach((gift, index) => {
        const giftData = receivedGifts[index];
        const unlocked = !!giftData;
        
        const div = document.createElement('div');
        div.className = `gift-icon ${unlocked ? 'unlocked' : 'locked'}`;
        div.setAttribute('title', gift.name);
        div.innerHTML = `
            ${gift.icon}
            ${unlocked ? `<span class="count">${giftData.count}</span>` : ''}
            ${unlocked ? `<span class="best-sender">Ù…Ù†: ${getBestSenderName(giftData.senders, senderNames)}</span>` : ''}
        `;
        container.appendChild(div);
    });
}

function getBestSenderName(senders, senderNames) {
    if (!senders || Object.keys(senders).length === 0) return 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';

    // Ø¥ÙŠØ¬Ø§Ø¯ UID Ù„Ù„Ù…Ø±Ø³Ù„ Ø§Ù„Ø°ÙŠ Ø£Ø±Ø³Ù„ Ø£ÙƒØ¨Ø± Ø¹Ø¯Ø¯
    const maxSenderUid = Object.keys(senders).reduce((a, b) => senders[a] > senders[b] ? a : b);
    
    // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ "Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¬Ù‡ÙˆÙ„"
    return senderNames[maxSenderUid] || 'Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¬Ù‡ÙˆÙ„';
}

/* ---------------- AUTH LOAD ---------------- */

firebase.auth().onAuthStateChanged(async user=>{
    if(!user) return location.href="auth.html";

    userData=await loadUserData();
    if(!userData){ errorBox.innerText="ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"; return; }

    // Ø¥Ù†Ø´Ø§Ø¡ Public UID Ø¥Ø°Ø§ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯
    if(!userData.publicUid){
        const newUid=await generateUniquePublicUid();
        await firebase.firestore().collection("users").doc(user.uid)
            .set({publicUid:newUid},{merge:true});
        userData.publicUid=newUid;
    }

    // Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„
    document.getElementById("email").innerText=user.email;
    document.getElementById("publicUid").innerText=userData.publicUid;
    document.getElementById("level").innerText=userData.level||1;
    document.getElementById("xp").innerText=userData.xp||0;
    document.getElementById("coins").innerText=userData.totalCoins||0;

    const isPro=isProUser(userData); // ğŸš¨ Ø§ÙØªØ±Ø§Ø¶ Ø¯Ø§Ù„Ø© isProUser Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ auth.js
    document.getElementById("status").innerText=isPro?"Pro ğŸ‘‘":"Ø¹Ø§Ø¯ÙŠ";

    nameInput.value=user.displayName||user.email.split("@")[0];
    nameInput.disabled=false;

    await updateCost(isPro);
    validate();
    
    // ğŸš¨ Ø¹Ø±Ø¶ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§
    await renderGifts();
});

/* ---------------- NAME CHANGE ---------------- */

// ... (Ø¨Ù‚ÙŠØ© Ù…Ù†Ø·Ù‚ ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù… ÙƒÙ…Ø§ ÙƒØ§Ù† ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ)

nameInput.addEventListener("input",validate);

function validate(){
    const current=nameInput.value.trim();
    const original=firebase.auth().currentUser.displayName||firebase.auth().currentUser.email.split("@")[0];
    saveBtn.disabled=isSaving||current.length<3||current===original;
}

async function isNameAvailable(name){
    const snap=await firebase.firestore()
        .collection("users")
        .where("displayName","==",name)
        .limit(1).get();
    return snap.empty||snap.docs[0].id===firebase.auth().currentUser.uid;
}

async function updateCost(isPro){
    if(!userData.hasChangedNameBefore){
        costText.innerText="ğŸ‰ Ø£ÙˆÙ„ ØªØºÙŠÙŠØ± Ù…Ø¬Ø§Ù†ÙŠ";
        userData.finalCost=0;
        return;
    }
    userData.finalCost=BASE_COST;
    costText.innerText=`ğŸ’° ØªÙƒÙ„ÙØ© Ø§Ù„ØªØºÙŠÙŠØ±: ${BASE_COST} ÙƒÙˆÙŠÙ†Ø²`;
}

saveBtn.onclick=async()=>{
    if(isSaving) return;
    isSaving=true; saveBtn.disabled=true; errorBox.innerText="";

    const user=firebase.auth().currentUser;
    const newName=nameInput.value.trim();

    if(!(await isNameAvailable(newName))){
        errorBox.innerText="âŒ Ø§Ù„Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù…";
        isSaving=false; validate(); return;
    }

    if(userData.totalCoins<userData.finalCost){
        errorBox.innerText="âŒ ÙƒÙˆÙŠÙ†Ø² ØºÙŠØ± ÙƒØ§ÙÙŠØ©";
        isSaving=false; validate(); return;
    }

    try{
        await user.updateProfile({displayName:newName});
        const newCoins=userData.totalCoins-userData.finalCost;

        await firebase.firestore().collection("users").doc(user.uid).set({
            displayName:newName,
            totalCoins:newCoins,
            hasChangedNameBefore:true
        },{merge:true});

        userData.totalCoins=newCoins;
        document.getElementById("coins").innerText=newCoins;
        errorBox.innerText="âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸";
        errorBox.style.color="#22c55e";
    }catch(e){
        errorBox.innerText="âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸";
        errorBox.style.color="#ef4444";
    }
    isSaving=false; validate();
};
</script>

</body>
</html>

