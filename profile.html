<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‘¤ Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="auth.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        :root {
            --primary: #6366f1;
            --accent-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            --bg-body: #0a0f1e;
            --card-bg: rgba(30, 41, 59, 0.7);
            --text-main: #f1f5f9;
            --gold: #ffd700;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-body);
            background-image: radial-gradient(circle at top right, #1e1b4b, transparent);
            color: var(--text-main);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* ØªØµÙ…ÙŠÙ… Ù‚Ø³Ù… Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ© */
        .profile-avatar-section {
            position: relative;
            margin-bottom: 25px;
        }

        .avatar-wrapper {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: var(--accent-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 4px solid var(--card-bg);
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.4);
            overflow: hidden;
            position: relative;
        }

        .avatar-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-wrapper i {
            font-size: 4rem;
            color: white;
        }

        .change-photo-btn {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: var(--primary);
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 3px solid var(--bg-body);
            transition: 0.3s;
        }

        .change-photo-btn:hover { transform: scale(1.1); }

        /* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ÙˆØ¨Ø§Ù‚ÙŠ Ø§Ù„Ø¹Ù†Ø§ØµØ± */
        .card {
            background: var(--card-bg);
            backdrop-filter: blur(15px);
            padding: 25px;
            border-radius: 24px;
            width: 100%;
            max-width: 480px;
            border: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
            box-sizing: border-box;
        }

        .info-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .uid-container { display: flex; gap: 8px; background: rgba(0,0,0,0.2); padding: 5px 12px; border-radius: 10px; font-family: monospace; }
        
        #file-input { display: none; }
        .loading-overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.6);
            display: none; align-items: center; justify-content: center; font-size: 0.8rem;
        }
    </style>
</head>

<body onload="initProfile()">

<h2>ğŸ‘¤ Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ</h2>

<div class="profile-avatar-section">
    <div class="avatar-wrapper" id="avatar-container">
        <div class="loading-overlay" id="upload-loader"><i class="fas fa-spinner fa-spin"></i></div>
        <i class="fas fa-user" id="default-icon"></i>
        <img id="user-photo" src="" style="display: none;">
    </div>
    <label for="file-input" class="change-photo-btn">
        <i class="fas fa-camera" style="font-size: 0.9rem;"></i>
    </label>
    <input type="file" id="file-input" accept="image/*" onchange="uploadPhoto(event)">
</div>

<div class="card">
    <div class="info-item"><span>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</span><span id="display-name">...</span></div>
    <div class="info-item">
        <span>Ù…Ø¹Ø±Ù Ø§Ù„Ù„Ø§Ø¹Ø¨</span>
        <div class="uid-container">
            <span id="publicUid" style="color: var(--gold);">---</span>
            <i class="fas fa-copy" onclick="copyUID()" style="cursor:pointer"></i>
        </div>
    </div>
    <div class="info-item"><span>Ø§Ù„Ø±ØµÙŠØ¯</span><span id="coins" style="color: var(--gold);">0 ÙƒÙˆÙŠÙ†Ø²</span></div>
</div>

<button class="card" onclick="location.href='index.html'" style="background: var(--primary); text-align: center; font-weight: 900; color: white; cursor: pointer;">
    Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
</button>

<script>
let currentUser;

async function initProfile() {
    firebase.auth().onAuthStateChanged(async user => {
        if (!user) return window.location.href = "auth.html";
        currentUser = user;
        
        // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firestore
        const userData = await loadUserData(); // Ø¯Ø§Ù„Ø© Ù…Ù† Ù…Ù„Ù auth.js Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
        
        document.getElementById('display-name').innerText = user.displayName || "Ù„Ø§Ø¹Ø¨ Ù…Ø¬Ù‡ÙˆÙ„";
        document.getElementById('publicUid').innerText = userData.publicUid || "---";
        document.getElementById('coins').innerText = (userData.totalCoins || 0) + " ÙƒÙˆÙŠÙ†Ø²";

        // Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ© Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª
        updateAvatarUI(user.photoURL);
    });
}

function updateAvatarUI(url) {
    const img = document.getElementById('user-photo');
    const icon = document.getElementById('default-icon');
    if (url) {
        img.src = url;
        img.style.display = 'block';
        icon.style.display = 'none';
    } else {
        img.style.display = 'none';
        icon.style.display = 'block';
    }
}

async function uploadPhoto(event) {
    const file = event.target.files[0];
    if (!file) return;

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¬Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ - Ù…Ø«Ù„Ø§Ù‹ Ø£Ù‚Ù„ Ù…Ù† 2 Ù…ÙŠØ¬Ø§)
    if (file.size > 2 * 1024 * 1024) {
        alert("Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ØŒ Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø£Ù‚Ù„ Ù…Ù† 2 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª");
        return;
    }

    const loader = document.getElementById('upload-loader');
    loader.style.display = 'flex';

    try {
        // 1. Ø§Ù„ØªØ®Ø²ÙŠÙ† ÙÙŠ Firebase Storage
        const storageRef = firebase.storage().ref(`avatars/${currentUser.uid}`);
        await storageRef.put(file);
        const downloadURL = await storageRef.getDownloadURL();

        // 2. ØªØ­Ø¯ÙŠØ« Ù…Ù„Ù Ø§Ù„ØªØ¹Ø±ÙŠÙ ÙÙŠ Auth
        await currentUser.updateProfile({ photoURL: downloadURL });

        // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ Firestore Ù„ÙŠÙƒÙˆÙ† Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù…ØªØ§Ø­Ø§Ù‹
        await db.collection('users').doc(currentUser.uid).update({
            photoURL: downloadURL
        });

        updateAvatarUI(downloadURL);
        alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­!");
    } catch (error) {
        console.error(error);
        alert("ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©: " + error.message);
    } finally {
        loader.style.display = 'none';
    }
}

function copyUID() {
    const uid = document.getElementById('publicUid').innerText;
    navigator.clipboard.writeText(uid);
    alert("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù…Ø¹Ø±Ù!");
}
</script>
</body>
</html>

