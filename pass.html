<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ† Ø³ÙŠØ²ÙˆÙ† Ø§Ù„Ø£Ø³Ø§Ø·ÙŠØ±: Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù‡Ø§Ù… ÙˆØ§Ù„Ø¬ÙˆØ§Ø¦Ø²</title>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="auth.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <style>
        :root {
            --bg: #070912;
            --primary: #6366f1;
            --gold: #ffb100;
            --glass: rgba(255,255,255,0.05);
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: var(--bg); color: #fff; margin: 0;
            background-image: radial-gradient(circle at top right, #1e1b4b, transparent);
        }

        .tabs-nav {
            display: flex; background: rgba(0,0,0,0.4);
            position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--glass);
        }
        .tab-btn {
            flex: 1; padding: 15px; border: none; background: none;
            color: #94a3b8; font-weight: 900; cursor: pointer; font-family: 'Cairo';
        }
        .tab-btn.active { color: var(--primary); border-bottom: 3px solid var(--primary); background: rgba(99, 102, 241, 0.1); }

        .container { padding: 15px; max-width: 600px; margin: auto; }

        /* Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ù… */
        .task-card {
            background: var(--glass); border-radius: 15px; padding: 15px;
            margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: space-between; align-items: center;
        }
        .task-info h4 { margin: 0; font-size: 0.9rem; }
        .task-xp { color: #10b981; font-weight: bold; font-size: 0.8rem; }
        .btn-claim-task { 
            background: var(--primary); border: none; color: white; 
            padding: 5px 15px; border-radius: 8px; cursor: pointer; font-weight: bold;
        }
        .btn-claim-task:disabled { background: #334155; cursor: not-allowed; opacity: 0.5; }

        /* Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø³ÙŠØ²ÙˆÙ† */
        .lvl-row {
            display: grid; grid-template-columns: 50px 1fr 1fr;
            gap: 10px; margin-bottom: 15px; align-items: stretch;
        }
        .lvl-number {
            background: #1e293b; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 900; border: 1px solid var(--primary);
        }
        .reward-box {
            background: var(--glass); border-radius: 12px; padding: 10px;
            text-align: center; border: 1px solid rgba(255,255,255,0.05);
            display: flex; flex-direction: column; align-items: center; justify-content: space-between;
        }
        .reward-box.premium { border-color: rgba(255, 177, 0, 0.2); background: rgba(255, 177, 0, 0.03); }
        .reward-box i { font-size: 1.5rem; margin-bottom: 5px; }
        
        .btn-claim-reward {
            width: 100%; margin-top: 8px; font-size: 0.7rem; padding: 4px;
            border-radius: 5px; border: none; cursor: pointer; font-weight: 900;
            background: #10b981; color: white;
        }
        .btn-claim-reward.locked { background: #1e293b; color: #64748b; cursor: not-allowed; }
        .btn-claim-reward.done { background: none; border: 1px solid #10b981; color: #10b981; cursor: default; }

        /* Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… */
        .claimed-anim { animation: pulse 0.5s; }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .footer-buy {
            position: fixed; bottom: 0; left: 0; right: 0;
            padding: 15px; background: rgba(10,15,26,0.9); backdrop-filter: blur(10px);
            display: flex; gap: 10px;
        }
    </style>
</head>
<body onload="initApp()">

    <div class="tabs-nav">
        <button class="tab-btn active" onclick="showTab('pass')"><i class="fas fa-trophy"></i> Ø§Ù„Ø³ÙŠØ²ÙˆÙ†</button>
        <button class="tab-btn" onclick="showTab('tasks')"><i class="fas fa-tasks"></i> Ø§Ù„Ù…Ù‡Ø§Ù…</button>
    </div>

    <div id="pass-tab" class="container">
        <div id="header-info" style="text-align: center; margin-bottom: 20px;">
            <h2 style="margin:0">Ø§Ù„Ù…ÙˆØ³Ù… 1 <span id="user-lvl-display" style="color:var(--primary)">1</span></h2>
            <div style="background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px; margin: 10px 0;">
                <div id="xp-bar" style="height: 100%; background: var(--primary); width: 0%; border-radius: 4px; transition: 0.5s;"></div>
            </div>
            <span id="xp-text" style="font-size: 0.8rem; color: #94a3b8;">0 / 1000 XP</span>
        </div>
        <div id="rewards-list"></div>
    </div>

    <div id="tasks-tab" class="container" style="display: none;">
        <h3>Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h3>
        <div id="tasks-list"></div>
    </div>

    <div style="height: 100px;"></div> <div class="footer-buy">
        <button id="buy-btn" onclick="upgradePass()" style="flex: 2; background: var(--gold); border: none; border-radius: 12px; font-weight: 900; cursor: pointer; font-family: 'Cairo'; padding: 12px;">
            ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø³ÙŠØ²ÙˆÙ† Ø§Ù„Ù…Ù„ÙƒÙŠ (1400 ÙƒÙˆÙŠÙ†Ø²)
        </button>
        <button onclick="skipLevel()" style="flex: 1; background: var(--glass); border: 1px solid var(--primary); color: white; border-radius: 12px; cursor: pointer;">
            ØªØ®Ø·Ù‰ Ù„ÙÙ„
        </button>
    </div>

<script>
    let uData = null;
    const XP_STEP = 1000;

    // Ø¯Ø§ØªØ§ Ø§Ù„Ù…Ù‡Ø§Ù…
    const dailyTasks = [
        { id: 't1', title: 'Ø§Ù„Ø¹Ø¨ 5 Ù…Ø±Ø§Øª Ø¹Ø§Ø¯ÙŠ', goal: 5, xp: 200, type: 'games_played' },
        { id: 't2', title: 'Ø§Ù„Ø¹Ø¨ 5 Ù…Ø±Ø§Øª Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†', goal: 5, xp: 300, type: 'online_played' },
        { id: 't3', title: 'Ø£Ø±Ø³Ù„ Ù‡Ø¯ÙŠØ© Ù„ØµØ¯ÙŠÙ‚', goal: 1, xp: 500, type: 'gift_sent' },
        { id: 't4', title: 'ØªØµØ¯Ø± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒÙˆÙŠÙ†Ø²', goal: 1, xp: 1000, type: 'rank_top' }
    ];

    // ØªÙˆÙ„ÙŠØ¯ 30 Ù„ÙÙ„ Ù…Ù† Ø§Ù„Ø¬ÙˆØ§Ø¦Ø²
    const rewards = [];
    for(let i=1; i<=30; i++) {
        rewards.push({
            lvl: i,
            free: { id: `f${i}`, n: `${i*10} ÙƒÙˆÙŠÙ†Ø²`, i: "fa-coins", val: i*10, type: 'coins' },
            prem: { id: `p${i}`, n: i % 5 === 0 ? "ID Ù…Ù…ÙŠØ²" : `${i*50} ÙƒÙˆÙŠÙ†Ø²`, i: i % 5 === 0 ? "fa-id-badge" : "fa-coins", val: i*50, type: i % 5 === 0 ? 'special_id' : 'coins' }
        });
    }

    async function initApp() {
        auth.onAuthStateChanged(user => {
            if(!user) return;
            db.collection('users').doc(user.uid).onSnapshot(doc => {
                uData = doc.data();
                if(!uData.s_claimed) db.collection('users').doc(user.uid).update({ s_claimed: [], s_tasks: {}, s_xp: 0, s_premium: false });
                renderAll();
            });
        });
    }

    function showTab(tab) {
        document.getElementById('pass-tab').style.display = tab === 'pass' ? 'block' : 'none';
        document.getElementById('tasks-tab').style.display = tab === 'tasks' ? 'block' : 'none';
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }

    function renderAll() {
        const xp = uData.s_xp || 0;
        const currentLvl = Math.floor(xp / XP_STEP) + 1;
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‡ÙŠØ¯Ø±
        document.getElementById('user-lvl-display').innerText = currentLvl;
        document.getElementById('xp-bar').style.width = ((xp % XP_STEP) / XP_STEP * 100) + '%';
        document.getElementById('xp-text').innerText = `${xp % XP_STEP} / ${XP_STEP} XP`;
        if(uData.s_premium) document.getElementById('buy-btn').style.display = 'none';

        // Ø±Ù†Ø¯Ø± Ø§Ù„Ø¬ÙˆØ§Ø¦Ø²
        const rList = document.getElementById('rewards-list');
        rList.innerHTML = '';
        rewards.forEach(r => {
            const row = document.createElement('div');
            row.className = 'lvl-row';
            row.innerHTML = `
                <div class="lvl-number">${r.lvl}</div>
                ${createRewardBox(r.lvl, r.free, false)}
                ${createRewardBox(r.lvl, r.prem, true)}
            `;
            rList.appendChild(row);
        });

        // Ø±Ù†Ø¯Ø± Ø§Ù„Ù…Ù‡Ø§Ù…
        const tList = document.getElementById('tasks-list');
        tList.innerHTML = '';
        dailyTasks.forEach(task => {
            const progress = uData.s_tasks?.[task.type] || 0;
            const isDone = progress >= task.goal;
            const alreadyClaimed = uData.s_claimed.includes(task.id);

            const div = document.createElement('div');
            div.className = 'task-card';
            div.innerHTML = `
                <div class="task-info">
                    <h4>${task.title}</h4>
                    <div class="task-xp">+${task.xp} XP Ø³ÙŠØ²ÙˆÙ†</div>
                    <small>${progress}/${task.goal}</small>
                </div>
                <button class="btn-claim-task" ${(!isDone || alreadyClaimed) ? 'disabled' : ''} onclick="claimTask('${task.id}', ${task.xp})">
                    ${alreadyClaimed ? 'ØªÙ…' : 'Ø§Ø³ØªÙ„Ø§Ù…'}
                </button>
            `;
            tList.appendChild(div);
        });
    }

    function createRewardBox(lvl, item, isPrem) {
        const userLvl = Math.floor((uData.s_xp || 0) / XP_STEP) + 1;
        const canClaim = lvl <= userLvl && (!isPrem || uData.s_premium);
        const isClaimed = uData.s_claimed.includes(item.id);

        let btnState = `<button class="btn-claim-reward locked">Ù…Ù‚ÙÙ„</button>`;
        if (isClaimed) btnState = `<button class="btn-claim-reward done"><i class="fas fa-check"></i> ØªÙ…</button>`;
        else if (canClaim) btnState = `<button class="btn-claim-reward animate__animated animate__pulse animate__infinite" onclick="claimReward('${item.id}', '${item.type}', ${item.val})">Ø§Ø³ØªÙ„Ø§Ù…</button>`;

        return `
            <div class="reward-box ${isPrem ? 'premium' : ''}">
                <i class="fas ${item.i}" style="color: ${isPrem ? 'var(--gold)' : 'var(--primary)'}"></i>
                <span style="font-size:0.6rem">${item.n}</span>
                ${btnState}
            </div>
        `;
    }

    async function claimReward(id, type, val) {
        const ref = db.collection('users').doc(auth.currentUser.uid);
        let updateData = { s_claimed: firebase.firestore.FieldValue.arrayUnion(id) };
        
        if(type === 'coins') updateData.totalCoins = firebase.firestore.FieldValue.increment(val);
        if(type === 'special_id') updateData.hasSpecialID = true;

        await ref.update(updateData);
        alert("ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¬Ø§Ø¦Ø²Ø© Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰");
    }

    async function claimTask(id, xp) {
        await db.collection('users').doc(auth.currentUser.uid).update({
            s_xp: firebase.firestore.FieldValue.increment(xp),
            s_claimed: firebase.firestore.FieldValue.arrayUnion(id)
        });
    }

    async function upgradePass() {
        if(uData.totalCoins < 1400) return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒÙˆÙŠÙ†Ø² ÙƒØ§ÙÙŠØ©!");
        if(confirm("ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø³ÙŠØ²ÙˆÙ† Ø§Ù„Ù…Ù„ÙƒÙŠ Ù…Ù‚Ø§Ø¨Ù„ 1400 ÙƒÙˆÙŠÙ†Ø²ØŸ")) {
            await db.collection('users').doc(auth.currentUser.uid).update({
                totalCoins: firebase.firestore.FieldValue.increment(-1400),
                s_premium: true
            });
        }
    }

    async function skipLevel() {
        const price = 500; // Ø³Ø¹Ø± Ø«Ø§Ø¨Øª Ø£Ùˆ Ù…ØªØºÙŠØ±
        if(uData.totalCoins < price) return alert("ÙƒÙˆÙŠÙ†Ø² ØºÙŠØ± ÙƒØ§ÙÙŠØ©!");
        await db.collection('users').doc(auth.currentUser.uid).update({
            totalCoins: firebase.firestore.FieldValue.increment(-price),
            s_xp: firebase.firestore.FieldValue.increment(XP_STEP)
        });
    }
</script>
</body>
</html>

