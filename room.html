<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ•¹ï¸ ØºØ±ÙØ© Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</title>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="auth.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>

<body onload="initLobby()">

<script>
/* âœ… ØªØ£ÙƒÙŠØ¯ ØªØ¹Ø±ÙŠÙ Firestore */
const db = firebase.firestore();

/* ================== Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ================== */
let currentUID;
let roomCode;
let roomData = null;
let isHost = false;
let listenerUnsubscribe = null;
let allUsersData = {};
let isFetchingDetails = false;

const IMPOSTOR_NO_WORD_TAG = 'IMPOSTOR_NO_WORD_TAG_BLANK';

/* ================== Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† (âœ”ï¸ Ù…ØµØ­Ø­Ø©) ================== */
async function fetchAllPlayerDetails(playerUIDs) {
    if (isFetchingDetails) return;
    isFetchingDetails = true;

    try {
        const promises = playerUIDs.map(uid =>
            db.collection('users').doc(uid).get()
        );

        const docs = await Promise.all(promises);

        docs.forEach(doc => {
            const uid = doc.id;
            if (doc.exists) {
                const d = doc.data();
                allUsersData[uid] = {
                    displayName: d.displayName || `Ù„Ø§Ø¹Ø¨#${uid.slice(0,4)}`,
                    publicUid: d.publicUid || uid.slice(0,8),
                    level: d.level || 1,
                    gamesPlayed: d.gamesPlayed || 0,
                    impostorWins: d.impostorWins || 0
                };
            } else {
                allUsersData[uid] = {
                    displayName: `Ù„Ø§Ø¹Ø¨ Ù…Ø¬Ù‡ÙˆÙ„`,
                    publicUid: uid.slice(0,8),
                    error: true
                };
            }
        });

    } catch (e) {
        console.error("âŒ Ø®Ø·Ø£ Ø¬Ù„Ø¨ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†:", e);
    } finally {
        isFetchingDetails = false;
    }
}

/* ================== Ø¨Ø¯Ø¡ Ø§Ù„ØºØ±ÙØ© ================== */
function initLobby() {
    const params = new URLSearchParams(location.search);
    roomCode = params.get('id');
    if (!roomCode) return location.href = 'index.html';

    firebase.auth().onAuthStateChanged(user => {
        if (!user) return location.href = 'auth.html';
        currentUID = user.uid;
        listenRoom();
    });
}

function listenRoom() {
    const ref = db.collection('rooms').doc(roomCode);
    listenerUnsubscribe = ref.onSnapshot(async snap => {
        if (!snap.exists) return location.href = 'index.html';

        roomData = snap.data();
        isHost = roomData.hostUID === currentUID;

        if (!roomData.players.includes(currentUID)) {
            alert("ØªÙ… Ø¥Ø®Ø±Ø§Ø¬Ùƒ Ù…Ù† Ø§Ù„ØºØ±ÙØ©");
            return location.href = 'index.html';
        }

        await fetchAllPlayerDetails(roomData.players);
        renderPlayers();
    });
}

/* ================== Ø¹Ø±Ø¶ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† ================== */
function renderPlayers() {
    const box = document.getElementById('players-list-container');
    box.innerHTML = '';

    roomData.players.forEach(uid => {
        const u = allUsersData[uid];
        const div = document.createElement('div');
        div.innerHTML = `
            <div style="padding:10px;background:#334155;margin:5px;border-radius:8px">
                <span onclick="openProfile('${uid}')">
                    ${u ? u.displayName : '...'}
                </span>
            </div>
        `;
        box.appendChild(div);
    });
}

/* ================== Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ ================== */
function openProfile(uid) {
    const u = allUsersData[uid];
    if (!u) return alert("Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...");
    alert(
        `ğŸ‘¤ ${u.displayName}\nğŸ® Ù„Ø¹Ø¨: ${u.gamesPlayed}\nğŸ”¥ Ø§Ù†ØªØµØ§Ø±Ø§Øª: ${u.impostorWins}`
    );
}
</script>

<div id="players-list-container"></div>

</body>
</html>
