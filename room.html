
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ•¹ï¸ ØºØ±ÙØ© Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</title>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="auth.js"></script> 
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
/* Ù†ÙØ³ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© */
#home-icon { position: absolute; top: 20px; left: 20px; font-size: 24px; color: #94a3b8; cursor: pointer; transition: color 0.3s; }
#home-icon:hover { color: #ff4f4f; }
body { font-family: 'Cairo', sans-serif; background-color: #0f172a; color: #f1f5f9; text-align: center; padding: 20px; min-height: 100vh; margin: 0; display: flex; flex-direction: column; align-items: center; }
.card { background-color: #1e293b; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; margin: 15px auto; box-shadow: 0 8px 15px rgba(0,0,0,0.3); text-align: right; }
h2 { font-size: 2rem; font-weight: 700; margin-bottom: 10px; color: #34d399; }
#room-code-display { background-color: #334155; padding: 15px; border-radius: 8px; margin-bottom: 25px; display: flex; justify-content: center; align-items: center; gap: 15px; font-size: 1.2rem; color: #ffd700; }
#room-code-value { font-size: 1.8rem; font-weight: 700; letter-spacing: 3px; text-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
#copy-btn { background: none; border: none; color: #34d399; font-size: 1.2rem; cursor: pointer; transition: color 0.2s; }
.players-list { margin-top: 20px; }
.player-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; margin-bottom: 8px; background-color: #334155; border-radius: 8px; font-weight: 700; border-left: 5px solid transparent; }
.player-item.host { border-left-color: #6366f1; }
.kick-btn { background-color: #ff4f4f; color: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: background-color 0.2s; margin-left: 5px; }
.kick-btn:hover { background-color: #e53e3e; }
#start-game-btn { margin-top: 25px; padding: 15px 30px; font-size: 20px; font-weight: 700; background-color: #34d399; color: #0f172a; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.3s; width: 100%; }
#start-game-btn:disabled { background-color: #4b5563; cursor: not-allowed; color: #94a3b8; }
#role-card { background-color: #1e293b; padding: 40px; border-radius: 15px; box-shadow: 0 0 20px rgba(52, 211, 153, 0.4); margin-top: 30px; text-align: center; border: 3px solid #34d399; }
#role-title { font-size: 2.5rem; color: #ffd700; margin-bottom: 10px; }
#role-word { font-size: 1.8rem; color: #f1f5f9; font-weight: 700; margin-bottom: 20px; }
#role-instructions { color: #94a3b8; font-size: 1rem; }
#status-message { margin-top: 20px; color: #ffcc00; font-weight: 700; }
.player-name-link { cursor: pointer; transition: color 0.2s; }
.player-name-link:hover { color: #ffd700; }
.modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
.modal-content { background-color: #1e293b; margin: 10% auto; padding: 20px; border: 1px solid #334155; width: 80%; max-width: 400px; border-radius: 12px; text-align: right; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
.close-btn { color: #aaa; float: left; font-size: 28px; font-weight: bold; }
.close-btn:hover, .close-btn:focus { color: #ff4f4f; text-decoration: none; cursor: pointer; }
.gift-btn { background-color: #ffd700; color: #0f172a; border:none; padding: 10px 20px; border-radius: 8px; margin-top: 20px; font-weight: 700; cursor: pointer; transition: background-color 0.2s; }
.gift-btn:hover { background-color: #ffc400; }
</style>
</head>

<body onload="initLobby()">

<a href="#" id="home-icon" title="Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØºØ±ÙØ©" onclick="leaveRoom(event)">
    <i class="fas fa-sign-out-alt"></i>
</a>

<div class="card" id="waiting-lobby">
    <h2 id="room-title">ØºØ±ÙØ© Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù„Ø¹Ø¨</h2>
    
    <div id="room-code-display">
        Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©: <span id="room-code-value">---</span>
        <button id="copy-btn" title="Ù†Ø³Ø® Ø§Ù„Ø±Ù…Ø²" onclick="copyCode()"><i class="fas fa-copy"></i></button>
    </div>
    
    <div id="status-message">Ø¬Ø§Ø±ÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†...</div>

    <div class="words-settings-summary" style="color:#94a3b8; font-size:0.9rem; text-align: center; margin-bottom: 15px;">
        <i class="fas fa-cog"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª: <span id="settings-summary">---</span>
    </div>
    
    <h3><i class="fas fa-users"></i> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† (<span id="player-count">0</span>)</h3>
    <div class="players-list" id="players-list-container"></div>
    
    <button id="start-game-btn" onclick="startGame()" disabled style="display: none;">
        <i class="fas fa-play"></i> Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨
    </button>
</div>

<div class="card" id="role-display-card" style="display:none;">
    <h2>Ø¯ÙˆØ±Ùƒ ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø©</h2>
    <div id="role-card">
        <div id="role-title">---</div>
        <div id="role-word">---</div>
        <div id="role-instructions">---</div>
    </div>
    <button onclick="hideRoleCard()" style="margin-top: 20px; background-color: #6366f1;">
        <i class="fas fa-eye-slash"></i> Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
    </button>
</div>

<div id="profile-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="document.getElementById('profile-modal').style.display='none'">&times;</span>
        <h3 style="color:#34d399;"><i class="fas fa-id-badge"></i> Ù…Ù„Ù Ø§Ù„Ù„Ø§Ø¹Ø¨</h3>
        <div id="modal-profile-content"></div>
    </div>
</div>

<script>
let currentUID;
let roomCode;
let roomData = null;
let isHost = false;
let listenerUnsubscribe = null;
let allUsersData = {}; 
let isFetchingDetails = false;

// Ø§Ù„Ø«ÙˆØ§Ø¨Øª
const IMPOSTOR_NO_WORD_TAG = 'IMPOSTOR_NO_WORD_TAG_BLANK'; 

// ğŸ¯ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒÙ„Ù…Ø§Øª ÙˆØ§Ù„Ø£Ù‚Ø³Ø§Ù… - ØªÙ… ØªØ²ÙˆÙŠØ¯Ù‡Ø§ Ø¨Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„ØªÙŠ Ø·Ù„Ø¨ØªÙ‡Ø§ ğŸ¯
const wordCategories = {
    free: [
        { id: 'objects', name: 'Ø£Ø´ÙŠØ§Ø¡ ÙˆØ£Ø¯ÙˆØ§Øª', words: ["Ù‚Ù„Ù…", "ÙƒÙˆØ¨", "ÙƒØ±Ø³ÙŠ", "Ù…ÙØªØ§Ø­", "Ù‡Ø§ØªÙ", "ÙƒØªØ§Ø¨", "Ø³Ø§Ø¹Ø©", "Ù…ØµØ¨Ø§Ø­", "Ù…Ù„Ø¹Ù‚Ø©", "Ø­Ø°Ø§Ø¡", "Ø­Ù‚ÙŠØ¨Ø©", "Ø·Ø§ÙˆÙ„Ø©", "Ù…Ø±Ø¢Ø©", "Ø¯ÙØªØ±", "Ù…Ù…Ø­Ø§Ø©", "Ø¬Ø¯Ø§Ø±", "Ø´Ø¨Ø§Ùƒ", "Ø¨Ø§Ø¨", "Ø³Ø±ÙŠØ±", "ÙˆØ³Ø§Ø¯Ø©", "ØºØ·Ø§Ø¡", "Ø¬Ø±Ø³", "Ù…Ø¸Ù„Ø©", "Ù„ÙˆØ­Ø©", "Ù…Ø±ÙˆØ­Ø©", "ØµÙ†Ø¯ÙˆÙ‚", "ÙØ±Ø´Ø§Ø©", "Ù…Ø´Ø·", "Ù…Ù…Ø­Ø§Ø©", "Ù…Ø·Ø±Ù‚Ø©", "Ù…Ø³Ù…Ø§Ø±", "Ø®ÙŠØ·", "Ø¥Ø¨Ø±Ø©", "Ø®Ø²Ø§Ù†Ø©", "Ø­Ø¨Ù„", "Ø´Ø±ÙŠØ·", "ÙƒØ§Ù…ÙŠØ±Ø§", "Ù…Ø§ÙˆØ³", "Ø¨Ø·Ø§Ø±ÙŠØ©", "Ù„Ù…Ø¨Ø©", "Ù…Ù‚Øµ", "Ù…Ù†Ø´ÙØ©", "ØµÙ†Ø¨ÙˆØ±", "Ù‚ÙÙ„", "Ø³Ù„Ø©", "Ø³Ù„Ùƒ", "Ø´Ø§Ø­Ù†", "Ø£Ø±ÙŠÙƒØ©", "Ø±Ù"] },
        { id: 'nature', name: 'Ø§Ù„Ø·Ø¨ÙŠØ¹Ø© ÙˆØ§Ù„Ø¨ÙŠØ¦Ø©', words: ["Ø´Ø¬Ø±Ø©", "Ù†Ù‡Ø±", "Ø¬Ø¨Ù„", "Ø³Ù…Ø§Ø¡", "Ø¨Ø­Ø±", "Ø´Ù…Ø³", "Ù‚Ù…Ø±", "Ù†Ø¬Ù…", "ØºÙŠÙ…Ø©", "Ù…Ø·Ø±", "Ø«Ù„Ø¬", "ØµØ®Ø±Ø©", "Ø±Ù…Ù„", "Ø¹Ø´Ø¨", "ÙˆØ±Ø¯Ø©", "Ù†Ø®Ù„Ø©", "Ø´Ø§Ø·Ø¦", "Ø¨Ø±ÙƒØ§Ù†", "ØµØ­Ø±Ø§Ø¡", "ÙˆØ§Ø¯ÙŠ", "ÙƒÙ‡Ù", "Ø¨Ø­ÙŠØ±Ø©", "Ø¶Ø¨Ø§Ø¨", "Ø±ÙŠØ§Ø­", "ØµÙ‚ÙŠØ¹", "ØªØ±Ø§Ø¨", "Ù†Ø¨ØªØ©", "Ø¨Ø°Ø±Ø©", "ÙØ¶Ø§Ø¡", "ÙƒÙˆÙƒØ¨", "Ø´Ù‡Ø§Ø¨", "Ø£ÙÙ‚", "Ø¬Ø³Ø±", "Ù…Ø²Ø±Ø¹Ø©", "Ø¹Ø§ØµÙØ©", "Ù†Ø³ÙŠÙ…", "Ø¸Ù„", "Ø¶ÙˆØ¡", "Ù…Ø­ÙŠØ·", "Ø¬Ø²ÙŠØ±Ø©", "Ø´Ù„Ø§Ù„", "Ù†Ø¨Ø¹", "Ø¬Ø°Ø¹", "ÙˆØ±Ù‚Ø©", "ØºØ§Ø¨Ø©", "Ø£Ø²Ù‡Ø§Ø±", "Ø³Ø­Ø§Ø¨Ø©", "Ø¨Ø¦Ø±"] },
        { id: 'jobs', name: 'Ù…Ù‡Ù† ÙˆÙˆØ¸Ø§Ø¦Ù', words: ["Ø·Ø¨ÙŠØ¨", "Ù…Ø¹Ù„Ù…", "Ù…Ù‡Ù†Ø¯Ø³", "Ø´Ø±Ø·ÙŠ", "Ø®Ø¨Ø§Ø²", "Ù…Ø²Ø§Ø±Ø¹", "Ù†Ø¬Ø§Ø±", "Ø·Ø¨Ø§Ø®", "Ø±Ø³Ø§Ù…", "Ù…Ø°ÙŠØ¹", "Ù‚Ø§Ø¶ÙŠ", "ÙƒØ§ØªØ¨", "Ø¬Ù†Ø¯ÙŠ", "Ø¨Ø­Ø§Ø±", "Ø·ÙŠØ§Ø±", "ØµÙŠØ¯Ù„ÙŠ", "Ù…Ù…Ø±Ø¶", "Ù…ØµÙˆØ±", "Ù…ÙˆØ³ÙŠÙ‚ÙŠ", "Ø®ÙŠØ§Ø·", "Ø³Ø§Ø¦Ù‚", "Ù…Ø­Ø§Ù…ÙŠ", "Ø¨Ø§Ø¦Ø¹", "Ù…ØªØ±Ø¬Ù…", "Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠ", "Ø¨Ù†Ø§Ø¡", "ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ", "Ø­Ø¯Ø§Ø¯", "Ø¬Ø²Ø§Ø±", "Ø´Ø§Ø¹Ø±", "ØµØ­ÙÙŠ", "Ù†Ø§Ù‚Ø¯", "Ø­Ø§Ø±Ø³", "Ø±ÙŠØ§Ø¶ÙŠ", "Ø¹Ø§Ù…Ù„", "Ø¥Ø·ÙØ§Ø¦ÙŠ", "Ù…Ø±Ø´Ø¯", "Ø®Ø§Ø¯Ù…", "Ù…Ø­Ø§Ø³Ø¨", "Ù…Ø¯Ø±Ø¨", "ÙÙ†Ø§Ù†", "ØµØ§Ù†Ø¹", "Ù…ÙˆØ²Ø¹", "Ù…ÙØªØ´", "Ø¹Ø§Ù„Ù…", "ÙÙ„ÙƒÙŠ", "Ù…Ø±Ø§Ø³Ù„"] }
    ],
    pro: [
        { id: 'foods', name: 'Ù…Ø£ÙƒÙˆÙ„Ø§Øª ÙˆÙ…Ø´Ø±ÙˆØ¨Ø§Øª', words: ["ØªÙØ§Ø­", "Ù…ÙˆØ²", "Ø¨Ø±ØªÙ‚Ø§Ù„", "Ù…Ø§Ø¡", "Ù‚Ù‡ÙˆØ©", "Ø´Ø§ÙŠ", "Ø®Ø¨Ø²", "Ø£Ø±Ø²", "Ù„Ø­Ù…", "Ø¯Ø¬Ø§Ø¬", "Ø³Ù…Ùƒ", "Ø¹ØµÙŠØ±", "Ø­Ù„ÙŠØ¨", "Ø¬Ø¨Ù†", "Ø¨ÙŠØ¶", "Ø³ÙƒØ±", "Ù…Ù„Ø­", "Ø²ÙŠØª", "Ø²Ø¨Ø¯Ø©", "Ø¹Ø³Ù„", "Ø¨Ø·Ø§Ø·Ø§", "Ø·Ù…Ø§Ø·Ù…", "Ø¨ØµÙ„", "Ø«ÙˆÙ…", "Ø®Ø³", "Ø¬Ø²Ø±", "ÙƒØ¹ÙƒØ©", "Ù…Ø«Ù„Ø¬Ø§Øª", "Ù…ÙƒØ±ÙˆÙ†Ø©", "Ø¨ÙŠØªØ²Ø§", "Ø³Ù„Ø·Ø©", "Ø­Ø³Ø§Ø¡", "ØªÙˆØ§Ø¨Ù„", "Ù…Ø´Ø±ÙˆØ¨", "Ø¹Ù†Ø¨", "Ù…Ø§Ù†Ø¬Ùˆ", "ÙÙ„ÙÙ„", "Ù„ÙŠÙ…ÙˆÙ†", "Ø¨Ø³ÙƒÙˆÙŠØª", "ÙÙˆÙ„", "Ø¹Ø¯Ø³", "ÙØ±Ø§ÙˆÙ„Ø©", "Ø²ÙŠØªÙˆÙ†", "Ù…Ø±Ø¨Ù‰", "Ø³ÙƒØ±", "Ø´ÙˆÙƒÙˆÙ„Ø§ØªØ©", "ÙØ·Ø±", "Ø¹Ù„ÙƒØ©"] },
        { id: 'animals', name: 'Ø­ÙŠÙˆØ§Ù†Ø§Øª ÙˆØ·ÙŠÙˆØ±', words: ["ÙƒÙ„Ø¨", "Ù‚Ø·Ø©", "Ø£Ø³Ø¯", "Ù†Ù…Ø±", "ÙÙŠÙ„", "Ø²Ø±Ø§ÙØ©", "Ù‚Ø±Ø¯", "Ø­ØµØ§Ù†", "Ø¬Ù…Ù„", "Ø¶ÙØ¯Ø¹", "Ø«Ø¹Ù„Ø¨", "Ø°Ø¦Ø¨", "Ø¯Ø¨", "Ø£Ø±Ù†Ø¨", "Ø³Ù†Ø¬Ø§Ø¨", "Ø·Ø§Ø¦Ø±", "Ø­Ù…Ø§Ù…Ø©", "ØµÙ‚Ø±", "Ø¨ÙˆÙ…Ø©", "Ù†Ø³Ø±", "Ø¨Ø·Ø©", "Ø¯ÙŠÙƒ", "Ø¯Ø¬Ø§Ø¬Ø©", "Ø¨Ù‚Ø±Ø©", "ØºØ²Ø§Ù„", "ØªÙ…Ø³Ø§Ø­", "Ø«Ø¹Ø¨Ø§Ù†", "Ø³Ù…ÙƒØ©", "Ù‚Ø±Ø´", "Ø¯ÙˆÙ„ÙÙŠÙ†", "Ø­ÙˆØª", "Ù†Ø­Ù„Ø©", "Ù†Ù…Ù„Ø©", "Ø¹Ù†ÙƒØ¨ÙˆØª", "ÙØ±Ø§Ø´Ø©", "ÙŠØ±Ø¨ÙˆØ¹", "Ø³Ù„Ø­ÙØ§Ø©", "Ø®Ø±ÙˆÙ", "Ù…Ø§Ø¹Ø²", "ÙØ£Ø±", "Ø¨Ø¨ØºØ§Ø¡", "ÙƒÙ†ØºØ±", "Ø¨Ø·Ø±ÙŠÙ‚", "Ø¶Ø¨Ø¹", "Ù†ÙˆØ±Ø³", "Ø¹Ù‚Ø§Ø¨", "Ø³Ø¹Ø¯Ø§Ù†"] },
        { id: 'clothes', name: 'Ù…Ù„Ø§Ø¨Ø³ ÙˆØ¥ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª', words: ["Ù‚Ù…ÙŠØµ", "Ø¨Ù†Ø·Ø§Ù„", "ÙØ³ØªØ§Ù†", "ØªÙ†ÙˆØ±Ø©", "Ù…Ø¹Ø·Ù", "Ø³ØªØ±Ø©", "Ø­Ø¬Ø§Ø¨", "ÙˆØ´Ø§Ø­", "Ù‚Ø¨Ø¹Ø©", "Ø¬ÙˆØ±Ø¨", "Ù‚ÙØ§Ø²", "Ø­Ø°Ø§Ø¡", "ØµÙ†Ø¯Ù„", "Ø­Ù‚ÙŠØ¨Ø©", "Ù†Ø¸Ø§Ø±Ø©", "Ø­Ø²Ø§Ù…", "Ø³Ø§Ø¹Ø© ÙŠØ¯", "Ø®Ø§ØªÙ…", "Ù‚Ù„Ø§Ø¯Ø©", "Ø³ÙˆØ§Ø±", "Ø¬ÙŠØ¨", "Ø²Ø±", "Ø³Ø­Ø§Ø¨", "Ù‚Ù…Ø§Ø´", "Ø­Ø±ÙŠØ±", "Ø¬Ù„Ø¯", "Ù‚Ø·Ù†", "ØµÙˆÙ", "Ø¹Ø¨Ø§Ø¡Ø©", "Ø¨ÙŠØ¬Ø§Ù…Ø©", "Ø±Ø¨Ø·Ø© Ø¹Ù†Ù‚", "Ù…Ø±ÙŠÙˆÙ„", "ÙƒØ¨Ùƒ", "ÙØ±Ùˆ", "Ø´Ø§Ù„", "ØµØ¯Ø±ÙŠØ©", "Ù…Ù†Ø´ÙØ©", "Ù…Ù†Ø§Ù…Ø©", "Ù‚Ø¨Ø¹Ø© Ø´Ù…Ø³", "Ù…Ø´Ø¯", "Ø²ÙŠ", "Ø¨Ø§Ø±ÙˆÙƒØ©", "Ø¨ÙˆØª", "Ø¬ÙˆØ§Ø±Ø¨", "Ù„Ø¨Ø§Ø³", "Ø±Ø¯Ø§Ø¡", "Ù…Ø¦Ø²Ø±", "Ø³Ø±ÙˆØ§Ù„"] },
        { id: 'places', name: 'Ø£Ù…Ø§ÙƒÙ† ÙˆÙ…Ø¹Ø§Ù„Ù…', words: ["Ù…Ø¯Ø±Ø³Ø©", "Ù…Ø³ØªØ´ÙÙ‰", "Ù…Ù†Ø²Ù„", "Ù…Ø³Ø¬Ø¯", "ÙƒÙ†ÙŠØ³Ø©", "Ø³ÙˆÙ‚", "Ù…ÙƒØªØ¨Ø©", "Ù…Ø·Ø§Ø±", "Ù…Ø­Ø·Ø©", "Ø­Ø¯ÙŠÙ‚Ø©", "Ù…ØªØ­Ù", "Ù…ØµÙ†Ø¹", "Ù…Ù‚Ù‡Ù‰", "Ù…Ø·Ø¹Ù…", "ÙÙ†Ø¯Ù‚", "Ù…Ø¨Ù†Ù‰", "Ø¬Ø³Ø±", "Ø·Ø±ÙŠÙ‚", "Ø´Ø§Ø±Ø¹", "Ø³Ø§Ø­Ø©", "Ù‚ØµØ±", "Ù‚Ù„Ø¹Ø©", "Ø¨Ø±Ø¬", "Ø¨ÙˆØ§Ø¨Ø©", "Ø¨Ø¦Ø±", "Ù…Ù„Ø¹Ø¨", "Ù†Ø§Ø¯ÙŠ", "Ø¬Ø§Ù…Ø¹Ø©", "ÙˆØ²Ø§Ø±Ø©", "Ø³ÙØ§Ø±Ø©", "ÙƒØ±Ø§Ø¬", "Ù†ÙÙ‚", "Ù…Ù…Ø±", "Ù‚Ø¨Ùˆ", "Ø³Ø·Ø­", "Ø´Ø±ÙØ©", "Ù…Ø®Ø²Ù†", "Ù…ÙˆÙ‚Ù", "ØºØ±ÙØ©", "Ù‚Ø§Ø¹Ø©", "Ø¨Ù‡Ùˆ", "Ù…Ø³ØªÙˆØ¯Ø¹", "Ù…Ø¬Ù„Ø³", "Ø®ÙŠÙ…Ø©", "Ù…Ø®Ø¨Ø²", "Ù…ØºØ³Ù„Ø©", "Ø¯ÙƒØ§Ù†"] },
        { id: 'activities', name: 'Ø£ÙØ¹Ø§Ù„ ÙˆÙ†Ø´Ø§Ø·Ø§Øª', words: ["Ø¬Ø±ÙŠ", "Ø³Ø¨Ø§Ø­Ø©", "Ù‚Ø±Ø§Ø¡Ø©", "ÙƒØªØ§Ø¨Ø©", "Ø±Ø³Ù…", "ØºÙ†Ø§Ø¡", "Ø±Ù‚Øµ", "Ù„Ø¹Ø¨", "Ù†ÙˆÙ…", "Ø£ÙƒÙ„", "Ø´Ø±Ø¨", "Ø¶Ø­Ùƒ", "Ø¨ÙƒØ§Ø¡", "ØµØ±Ø§Ø®", "Ù…Ø´Ø§Ù‡Ø¯Ø©", "Ø§Ø³ØªÙ…Ø§Ø¹", "Ø­Ø¯ÙŠØ«", "Ø³ÙØ±", "ØµÙŠØ¯", "Ø·Ø¨Ø®", "ØªÙ†Ø¸ÙŠÙ", "Ø¹Ù…Ù„", "Ø¯Ø±Ø§Ø³Ø©", "Ù‚ÙŠØ§Ø¯Ø©", "Ø¨Ù†Ø§Ø¡", "Ù‡Ø¯Ù…", "Ø²Ø±Ø¹", "Ø­ØµØ§Ø¯", "Ø¥ØµÙ„Ø§Ø­", "ÙƒØ³Ø±", "ÙØªØ­", "Ø¥ØºÙ„Ø§Ù‚", "Ù‚ÙØ²", "ØµØ¹ÙˆØ¯", "Ù‡Ø¨ÙˆØ·", "Ø§Ù†ØªØ¸Ø§Ø±", "ØªÙÙƒÙŠØ±", "Ø­Ù„Ù…", "Ø¨Ù‚Ø§Ø¡", "ØªØ£Ù…Ù„", "ØªØ¬ÙˆÙ„", "Ø§Ø³ØªØ±Ø§Ø­Ø©", "Ø§Ø¬ØªÙ…Ø§Ø¹", "Ø¥Ø´Ø§Ø±Ø©", "Ø¥Ø±Ø³Ø§Ù„", "Ø§Ø³ØªÙ‚Ø¨Ø§Ù„", "Ø³Ø¤Ø§Ù„"] },
        { id: 'adjectives', name: 'ØµÙØ§Øª ÙˆØ£Ø­ÙˆØ§Ù„', words: ["Ø³Ø±ÙŠØ¹", "Ø¨Ø·ÙŠØ¡", "ÙƒØ¨ÙŠØ±", "ØµØºÙŠØ±", "Ø·ÙˆÙŠÙ„", "Ù‚ØµÙŠØ±", "Ø¬Ù…ÙŠÙ„", "Ù‚Ø¨ÙŠØ­", "Ø³Ø¹ÙŠØ¯", "Ø­Ø²ÙŠÙ†", "ØºØ§Ø¶Ø¨", "Ù‡Ø§Ø¯Ø¦", "ØµØ§Ø®Ø¨", "Ù†Ø¸ÙŠÙ", "Ù…ØªØ³Ø®", "Ù‚ÙˆÙŠ", "Ø¶Ø¹ÙŠÙ", "Ø¨Ø§Ø±Ø¯", "Ø­Ø§Ø±", "Ù…Ø´Ø±Ù‚", "Ù…Ø¸Ù„Ù…", "Ø¬Ø¯ÙŠØ¯", "Ù‚Ø¯ÙŠÙ…", "ØµØ¹Ø¨", "Ø³Ù‡Ù„", "Ø®ÙÙŠÙ", "Ø«Ù‚ÙŠÙ„", "Ø¬Ø§Ø¦Ø¹", "Ø¹Ø·Ø´Ø§Ù†", "Ù…Ø±ÙŠØ¶", "Ø³Ù„ÙŠÙ…", "Ø¨Ø¹ÙŠØ¯", "Ù‚Ø±ÙŠØ¨", "Ø­Ù‚ÙŠÙ‚ÙŠ", "ÙˆÙ‡Ù…ÙŠ", "Ø´Ø¬Ø§Ø¹", "Ø¬Ø¨Ø§Ù†", "Ù…Ø¶Ø­Ùƒ", "Ø¬Ø¯ÙŠ", "Ù…Ø£Ù„ÙˆÙ", "ØºØ±ÙŠØ¨", "Ø­ÙƒÙŠÙ…", "Ø£Ø­Ù…Ù‚", "Ù†Ø§Ø¬Ø­", "ÙØ§Ø´Ù„"] }
    ]
};

function initLobby() {
    const urlParams = new URLSearchParams(window.location.search);
    roomCode = urlParams.get('id');

    if (!roomCode) {
        alert("âŒ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©.");
        window.location.href = "index.html";
        return;
    }
    
    document.getElementById('room-code-value').innerText = roomCode;
    document.getElementById('room-title').innerText = `ØºØ±ÙØ© ${roomCode}`;

    firebase.auth().onAuthStateChanged(user => {
        if (!user) { 
            window.location.href = "auth.html"; 
            return; 
        }
        currentUID = user.uid;
        startRoomListener(roomCode);
    });
}

function startRoomListener(code) {
    if (listenerUnsubscribe) { listenerUnsubscribe(); } 

    const roomRef = db.collection('rooms').doc(code);

    listenerUnsubscribe = roomRef.onSnapshot(async doc => {
        if (!doc.exists) {
            console.warn("Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.");
            return;
        }

        roomData = doc.data();
        isHost = (roomData.hostUID === currentUID);
        
        // ğŸ›‘ Ù…Ù„Ø§Ø­Ø¸Ø©: ØªÙ… Ø­Ø°Ù Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø·Ø±Ø¯ Ø­ØªÙ‰ Ù†ØµÙ„Ø­ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø£ÙˆÙ„Ø§Ù‹
        
        await fetchAllPlayerDetails(roomData.players || []);

        if (roomData.status === 'playing') {
            displayRoleCard();
            return;
        }

        updateLobbyUI();
    }, error => {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØºØ±ÙØ©:", error);
    });
}

async function fetchAllPlayerDetails(playerUIDs) {
    if (isFetchingDetails || !playerUIDs || playerUIDs.length === 0) return;
    isFetchingDetails = true;
    
    // Ø¬Ù„Ø¨ ÙÙ‚Ø· Ù…Ù† Ù„ÙŠØ³ Ù„Ø¯ÙŠÙ†Ø§ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡Ù…
    const usersToFetch = playerUIDs.filter(uid => !allUsersData[uid] || !allUsersData[uid].displayName);

    if (usersToFetch.length === 0) {
        isFetchingDetails = false;
        return;
    }

    try {
        const promises = usersToFetch.map(uid => db.collection('users').doc(uid).get());
        const docs = await Promise.all(promises);
        
        docs.forEach(doc => {
            const uid = doc.id;
            if (doc.exists) {
                const data = doc.data();
                const playerName = data.displayName || data.username || data.name || `Ù„Ø§Ø¹Ø¨#${uid.substring(0, 4)}`;

                allUsersData[uid] = {
                    displayName: playerName, 
                    publicUid: data.publicUid || '---',
                    level: data.level || 1, 
                    gamesPlayed: data.gamesPlayed || 0,
                    impostorWins: data.impostorWins || 0
                };
            } else {
                allUsersData[uid] = { 
                    displayName: `Ù…Ø¬Ù‡ÙˆÙ„#${uid.substring(0, 4)}`,
                    publicUid: '---',
                    error: true
                };
            }
        });
        
        updateLobbyUI();

    } catch (error) {
        console.error("ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†:", error);
    } finally {
        isFetchingDetails = false;
    }
}

function updateLobbyUI() {
    if (!roomData) return;
    
    document.getElementById('waiting-lobby').style.display = 'block';
    document.getElementById('role-display-card').style.display = 'none';

    const playersContainer = document.getElementById('players-list-container');
    const startGameBtn = document.getElementById('start-game-btn');
    const players = roomData.players || [];
    const playerCount = players.length;

    document.getElementById('player-count').innerText = playerCount;
    
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    const settings = roomData.settings || {};
    document.getElementById('settings-summary').innerText = `Ù…Ø­ØªØ§Ù„ÙˆÙ†: ${settings.impostors || 1}`;
    
    // Ø²Ø± Ø§Ù„Ø¨Ø¯Ø¡
    if (isHost) {
        startGameBtn.style.display = 'block';
        if (playerCount >= 3) {
            startGameBtn.disabled = false;
            document.getElementById('status-message').innerText = 'Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¨Ø¯Ø¡!';
            document.getElementById('status-message').style.color = '#34d399';
        } else {
            startGameBtn.disabled = true;
            document.getElementById('status-message').innerText = `Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø¹Ø¯Ø¯ (Ø§Ù„Ø­Ø§Ù„ÙŠ: ${playerCount})`;
        }
    } else {
        startGameBtn.style.display = 'none';
        document.getElementById('status-message').innerText = `Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø¶ÙŠÙ... (Ø§Ù„Ø¹Ø¯Ø¯: ${playerCount})`;
    }

    // Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    playersContainer.innerHTML = '';
    players.forEach(uid => {
        const playerDetails = allUsersData[uid];
        const name = playerDetails ? playerDetails.displayName : `Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...`;
        
        const isPlayerHost = (uid === roomData.hostUID);
        const div = document.createElement('div');
        div.className = `player-item ${isPlayerHost ? 'host' : ''}`;
        
        let actionsHTML = '';
        if (isHost && uid !== currentUID) {
            actionsHTML = `<button class="kick-btn" onclick="kickPlayer('${uid}', '${name}')"><i class="fas fa-user-times"></i></button>`;
        }

        const crownIcon = isPlayerHost ? '<i class="fas fa-crown" style="color:#ffd700;"></i> ' : '';
        
        div.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px;">
                <span class="player-name-link" onclick="openProfileModal('${uid}')">
                    ${crownIcon} ${name}
                </span>
            </div>
            <div>${actionsHTML}</div>
        `;
        playersContainer.appendChild(div);
    });
}

async function startGame() {
    if (!isHost) return;
    
    // ğŸš¨ ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± ÙˆØ§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„ØµØ­ÙŠØ­ Ù‡Ù†Ø§
    const roomRef = db.collection('rooms').doc(roomCode);
    
    // ØªÙˆØ²ÙŠØ¹ Ø¨Ø³ÙŠØ· Ù„Ù„Ø£Ø¯ÙˆØ§Ø± Ù„Ù„ØªØ¬Ø±Ø¨Ø©
    const players = roomData.players;
    const roles = {};
    players.forEach((p, i) => {
        // ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© 'ØªØ¬Ø±Ø¨Ø©' Ø¥Ù„Ù‰ ÙƒÙ„Ù…Ø© Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒÙ„Ù…Ø§Øª
        roles[p] = { role: i === 0 ? 'impostor' : 'civilian', word: 'ØªØ¬Ø±Ø¨Ø©' }; 
    });

    await roomRef.update({
        status: 'playing',
        currentGameData: { roles: roles }
    });
}

function displayRoleCard() {
    // ğŸš¨ ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ø¹Ø±Ø¶ Ø§Ù„Ø¯ÙˆØ± ÙˆØ§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù‡Ù†Ø§
    document.getElementById('waiting-lobby').style.display = 'none';
    document.getElementById('role-display-card').style.display = 'block';
    
    // Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù…Ø¤Ù‚ØªØ©
    const role = roomData.currentGameData.roles[currentUID];
    
    document.getElementById('role-title').innerText = role.role === 'impostor' ? 'Ø£Ù†Øª Ø§Ù„Ù…Ø­ØªØ§Ù„ ğŸ˜ˆ' : 'Ø£Ù†Øª Ù…Ø¯Ù†ÙŠ ğŸ˜‡';
    document.getElementById('role-word').innerText = role.word === IMPOSTOR_NO_WORD_TAG ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙ„Ù…Ø© Ù„Ùƒ' : `Ø§Ù„ÙƒÙ„Ù…Ø©: ${role.word}`;
    document.getElementById('role-instructions').innerText = role.role === 'impostor' ? 'Ø­Ø§ÙˆÙ„ Ù…Ø¹Ø±ÙØ© Ø§Ù„ÙƒÙ„Ù…Ø© ÙˆØªØ¸Ø§Ù‡Ø± Ø£Ù†Ùƒ ØªØ¹Ø±ÙÙ‡Ø§.' : 'Ø­Ø§ÙˆÙ„ Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ù…Ø­ØªØ§Ù„ Ù…Ù† Ø®Ù„Ø§Ù„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©.';
}

function openProfileModal(playerUID) {
    const playerDetails = allUsersData[playerUID];
    const modalContent = document.getElementById('modal-profile-content');
    
    if (!playerDetails) { return; }
    
    modalContent.innerHTML = `
        <h4 style="color:#f1f5f9;">${playerDetails.displayName}</h4>
        <p>Ø§Ù„Ù…Ø¹Ø±Ù‘Ù: ${playerDetails.publicUid}</p>
        <p>Ø§Ù„Ù…Ø³ØªÙˆÙ‰: ${playerDetails.level}</p>
        <button class="gift-btn" onclick="alert('Ù‚Ø±ÙŠØ¨Ø§Ù‹!')">Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø¯ÙŠØ©</button>
    `;
    document.getElementById('profile-modal').style.display = 'block';
}

// Ø¨Ù‚ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© (Ù†Ø³Ø® Ø§Ù„Ø±Ù…Ø²ØŒ Ù…ØºØ§Ø¯Ø±Ø©ØŒ Ø¥Ù„Ø®)
function copyCode() {
    const code = document.getElementById('room-code-value').innerText;
    navigator.clipboard.writeText(code);
}
function leaveRoom(e) {
    e.preventDefault();
    // ğŸš¨ ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØºØ±ÙØ© Ù…Ù† Firestore Ù‡Ù†Ø§
    window.location.href = "index.html";
}
function hideRoleCard() {
    document.getElementById('role-display-card').style.display = 'none';
    // ğŸš¨ ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙˆØªÙØ¹ÙŠÙ„ Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù‡Ù†Ø§
}
// Ø¯ÙˆØ§Ù„ Ø§Ù„Ø·Ø±Ø¯
async function kickPlayer(uid, name) {
    if(!confirm(`Ø·Ø±Ø¯ ${name}ØŸ`)) return;
    await db.collection('rooms').doc(roomCode).update({
        players: firebase.firestore.FieldValue.arrayRemove(uid)
    });
}
</script>
</body>
</html>
