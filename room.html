<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ•¹ï¸ ØºØ±ÙØ© Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</title>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="auth.js"></script> 
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
/* ---------------------------------- */
/* Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© ÙˆØ§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª */
#home-icon { position: absolute; top: 20px; left: 20px; font-size: 24px; color: #94a3b8; cursor: pointer; transition: color 0.3s; }
#home-icon:hover { color: #ff4f4f; }
body { font-family: 'Cairo', sans-serif; background-color: #0f172a; color: #f1f5f9; text-align: center; padding: 20px; min-height: 100vh; margin: 0; display: flex; flex-direction: column; align-items: center; }
.card { background-color: #1e293b; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; margin: 15px auto; box-shadow: 0 8px 15px rgba(0,0,0,0.3); text-align: right; }
h2 { font-size: 2rem; font-weight: 700; margin-bottom: 10px; color: #34d399; }
/* ---------------------------------- */
/* ØªØµÙ…ÙŠÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø±Ù…Ø² */
#room-code-display { background-color: #334155; padding: 15px; border-radius: 8px; margin-bottom: 25px; display: flex; justify-content: center; align-items: center; gap: 15px; font-size: 1.2rem; color: #ffd700; }
#room-code-value { font-size: 1.8rem; font-weight: 700; letter-spacing: 3px; text-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
#copy-btn { background: none; border: none; color: #34d399; font-size: 1.2rem; cursor: pointer; transition: color 0.2s; }
/* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† */
.players-list { margin-top: 20px; }
.player-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; margin-bottom: 8px; background-color: #334155; border-radius: 8px; font-weight: 700; border-left: 5px solid transparent; }
.player-item.host { border-left-color: #6366f1; }
.kick-btn { background-color: #ff4f4f; color: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: background-color 0.2s; margin-left: 5px; }
.kick-btn:hover { background-color: #e53e3e; }

/* Ø²Ø± Ø§Ù„Ø¨Ø¯Ø¡ */
#start-game-btn { margin-top: 25px; padding: 15px 30px; font-size: 20px; font-weight: 700; background-color: #34d399; color: #0f172a; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.3s; width: 100%; }
#start-game-btn:disabled { background-color: #4b5563; cursor: not-allowed; color: #94a3b8; }

/* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¯ÙˆØ± */
#role-card { background-color: #1e293b; padding: 40px; border-radius: 15px; box-shadow: 0 0 20px rgba(52, 211, 153, 0.4); margin-top: 30px; text-align: center; border: 3px solid #34d399; }
#role-title { font-size: 2.5rem; color: #ffd700; margin-bottom: 10px; }
#role-word { font-size: 1.8rem; color: #f1f5f9; font-weight: 700; margin-bottom: 20px; }
#role-instructions { color: #94a3b8; font-size: 1rem; }
#status-message { margin-top: 20px; color: #ffcc00; font-weight: 700; }

/* Ø³ØªØ§ÙŠÙ„ Ù„Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø¶ØºØ· */
.player-name-link { 
    cursor: pointer; 
    transition: color 0.2s; 
}
.player-name-link:hover { 
    color: #ffd700; 
}

/* Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ù€ Modal (Ù…Ù„Ù Ø§Ù„ØªØ¹Ø±ÙŠÙ) */
.modal {
    display: none; 
    position: fixed; 
    z-index: 100; 
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.6);
}
.modal-content {
    background-color: #1e293b;
    margin: 10% auto;
    padding: 20px;
    border: 1px solid #334155;
    width: 80%;
    max-width: 400px;
    border-radius: 12px;
    text-align: right;
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
}
.close-btn {
    color: #aaa;
    float: left;
    font-size: 28px;
    font-weight: bold;
}
.close-btn:hover,
.close-btn:focus {
    color: #ff4f4f;
    text-decoration: none;
    cursor: pointer;
}
.gift-btn {
    background-color: #ffd700; 
    color: #0f172a; 
    border:none; 
    padding: 10px 20px; 
    border-radius: 8px; 
    margin-top: 20px; 
    font-weight: 700;
    cursor: pointer;
    transition: background-color 0.2s;
}
.gift-btn:hover {
    background-color: #ffc400;
}

</style>
</head>

<body onload="initLobby()">

<a href="#" id="home-icon" title="Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØºØ±ÙØ©" onclick="leaveRoom(event)">
    <i class="fas fa-sign-out-alt"></i>
</a>

<div class="card" id="waiting-lobby">
    <h2 id="room-title">ØºØ±ÙØ© Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù„Ø¹Ø¨</h2>
    
    <div id="room-code-display">
        Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©: <span id="room-code-value">---</span>
        <button id="copy-btn" title="Ù†Ø³Ø® Ø§Ù„Ø±Ù…Ø²" onclick="copyCode()"><i class="fas fa-copy"></i></button>
    </div>
    
    <div id="status-message">Ø¬Ø§Ø±ÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ 3)...</div>

    <div class="words-settings-summary" style="color:#94a3b8; font-size:0.9rem; text-align: center; margin-bottom: 15px;">
        <i class="fas fa-cog"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø·Ø¨Ù‚Ø©: <span id="settings-summary">---</span>
    </div>
    
    <h3><i class="fas fa-users"></i> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† (<span id="player-count">0</span>)</h3>
    <div class="players-list" id="players-list-container">
        </div>
    
    <button id="start-game-btn" onclick="startGame()" disabled style="display: none;">
        <i class="fas fa-play"></i> Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨ (ÙŠØªØ·Ù„Ø¨ 3 Ù„Ø§Ø¹Ø¨ÙŠÙ†)
    </button>
</div>

<div class="card" id="role-display-card" style="display:none;">
    <h2>Ø¯ÙˆØ±Ùƒ ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø©</h2>
    <div id="role-card">
        <div id="role-title">---</div>
        <div id="role-word">---</div>
        <div id="role-instructions">---</div>
    </div>
    <button onclick="hideRoleCard()" style="margin-top: 20px; background-color: #6366f1;">
        <i class="fas fa-eye-slash"></i> Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© (Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ù†Ø§Ù‚Ø´Ø©)
    </button>
</div>

<div id="profile-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="document.getElementById('profile-modal').style.display='none'">&times;</span>
        <h3 style="color:#34d399;"><i class="fas fa-id-badge"></i> Ù…Ù„Ù Ø§Ù„Ù„Ø§Ø¹Ø¨</h3>
        <div id="modal-profile-content">
            </div>
    </div>
</div>


<script>
let currentUID;
let roomCode;
let roomData = null;
let isHost = false;
let listenerUnsubscribe = null;
let allUsersData = {}; 
let isFetchingDetails = false; // Ù„Ù…Ù†Ø¹ Ø§Ù„Ø¬Ù„Ø¨ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯ ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙˆÙ‚Øª

const IMPOSTOR_NO_WORD_TAG = 'IMPOSTOR_NO_WORD_TAG_BLANK'; 

// Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒÙ„Ù…Ø§Øª ÙˆØ§Ù„Ø£Ù‚Ø³Ø§Ù… 
const wordCategories = {
    // ØªÙ… Ø­Ø°Ù Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ù‡Ù†Ø§ Ù„Ù„Ø§Ø®ØªØµØ§Ø±ØŒ Ù„ÙƒÙ† ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©
    free: [
        { id: 'objects', name: 'Ø£Ø´ÙŠØ§Ø¡ ÙˆØ£Ø¯ÙˆØ§Øª', words: ["Ù‚Ù„Ù…", "ÙƒÙˆØ¨", "ÙƒØ±Ø³ÙŠ", "Ù…ÙØªØ§Ø­", "Ù‡Ø§ØªÙ", "ÙƒØªØ§Ø¨", "Ø³Ø§Ø¹Ø©", "Ù…ØµØ¨Ø§Ø­", "Ù…Ù„Ø¹Ù‚Ø©", "Ø­Ø°Ø§Ø¡", "Ø­Ù‚ÙŠØ¨Ø©", "Ø·Ø§ÙˆÙ„Ø©", "Ù…Ø±Ø¢Ø©", "Ø¯ÙØªØ±", "Ù…Ù…Ø­Ø§Ø©", "Ø¬Ø¯Ø§Ø±", "Ø´Ø¨Ø§Ùƒ", "Ø¨Ø§Ø¨", "Ø³Ø±ÙŠØ±", "ÙˆØ³Ø§Ø¯Ø©", "ØºØ·Ø§Ø¡", "Ø¬Ø±Ø³", "Ù…Ø¸Ù„Ø©", "Ù„ÙˆØ­Ø©", "Ù…Ø±ÙˆØ­Ø©", "ØµÙ†Ø¯ÙˆÙ‚", "ÙØ±Ø´Ø§Ø©", "Ù…Ø´Ø·", "Ù…Ù…Ø­Ø§Ø©", "Ù…Ø·Ø±Ù‚Ø©", "Ù…Ø³Ù…Ø§Ø±", "Ø®ÙŠØ·", "Ø¥Ø¨Ø±Ø©", "Ø®Ø²Ø§Ù†Ø©", "Ø­Ø¨Ù„", "Ø´Ø±ÙŠØ·", "ÙƒØ§Ù…ÙŠØ±Ø§", "Ù…Ø§ÙˆØ³", "Ø¨Ø·Ø§Ø±ÙŠØ©", "Ù„Ù…Ø¨Ø©", "Ù…Ù‚Øµ", "Ù…Ù†Ø´ÙØ©", "ØµÙ†Ø¨ÙˆØ±", "Ù‚ÙÙ„", "Ø³Ù„Ø©", "Ø³Ù„Ùƒ", "Ø´Ø§Ø­Ù†", "Ø£Ø±ÙŠÙƒØ©", "Ø±Ù"] },
        { id: 'nature', name: 'Ø§Ù„Ø·Ø¨ÙŠØ¹Ø© ÙˆØ§Ù„Ø¨ÙŠØ¦Ø©', words: ["Ø´Ø¬Ø±Ø©", "Ù†Ù‡Ø±", "Ø¬Ø¨Ù„", "Ø³Ù…Ø§Ø¡", "Ø¨Ø­Ø±", "Ø´Ù…Ø³", "Ù‚Ù…Ø±", "Ù†Ø¬Ù…", "ØºÙŠÙ…Ø©", "Ù…Ø·Ø±", "Ø«Ù„Ø¬", "ØµØ®Ø±Ø©", "Ø±Ù…Ù„", "Ø¹Ø´Ø¨", "ÙˆØ±Ø¯Ø©", "Ù†Ø®Ù„Ø©", "Ø´Ø§Ø·Ø¦", "Ø¨Ø±ÙƒØ§Ù†", "ØµØ­Ø±Ø§Ø¡", "ÙˆØ§Ø¯ÙŠ", "ÙƒÙ‡Ù", "Ø¨Ø­ÙŠØ±Ø©", "Ø¶Ø¨Ø§Ø¨", "Ø±ÙŠØ§Ø­", "ØµÙ‚ÙŠØ¹", "ØªØ±Ø§Ø¨", "Ù†Ø¨ØªØ©", "Ø¨Ø°Ø±Ø©", "ÙØ¶Ø§Ø¡", "ÙƒÙˆÙƒØ¨", "Ø´Ù‡Ø§Ø¨", "Ø£ÙÙ‚", "Ø¬Ø³Ø±", "Ù…Ø²Ø±Ø¹Ø©", "Ø¹Ø§ØµÙØ©", "Ù†Ø³ÙŠÙ…", "Ø¸Ù„", "Ø¶ÙˆØ¡", "Ù…Ø­ÙŠØ·", "Ø¬Ø²ÙŠØ±Ø©", "Ø´Ù„Ø§Ù„", "Ù†Ø¨Ø¹", "Ø¬Ø°Ø¹", "ÙˆØ±Ù‚Ø©", "ØºØ§Ø¨Ø©", "Ø£Ø²Ù‡Ø§Ø±", "Ø³Ø­Ø§Ø¨Ø©", "Ø¨Ø¦Ø±"] },
        { id: 'jobs', name: 'Ù…Ù‡Ù† ÙˆÙˆØ¸Ø§Ø¦Ù', words: ["Ø·Ø¨ÙŠØ¨", "Ù…Ø¹Ù„Ù…", "Ù…Ù‡Ù†Ø¯Ø³", "Ø´Ø±Ø·ÙŠ", "Ø®Ø¨Ø§Ø²", "Ù…Ø²Ø§Ø±Ø¹", "Ù†Ø¬Ø§Ø±", "Ø·Ø¨Ø§Ø®", "Ø±Ø³Ø§Ù…", "Ù…Ø°ÙŠØ¹", "Ù‚Ø§Ø¶ÙŠ", "ÙƒØ§ØªØ¨", "Ø¬Ù†Ø¯ÙŠ", "Ø¨Ø­Ø§Ø±", "Ø·ÙŠØ§Ø±", "ØµÙŠØ¯Ù„ÙŠ", "Ù…Ù…Ø±Ø¶", "Ù…ØµÙˆØ±", "Ù…ÙˆØ³ÙŠÙ‚ÙŠ", "Ø®ÙŠØ§Ø·", "Ø³Ø§Ø¦Ù‚", "Ù…Ø­Ø§Ù…ÙŠ", "Ø¨Ø§Ø¦Ø¹", "Ù…ØªØ±Ø¬Ù…", "Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠ", "Ø¨Ù†Ø§Ø¡", "ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ", "Ø­Ø¯Ø§Ø¯", "Ø¬Ø²Ø§Ø±", "Ø´Ø§Ø¹Ø±", "ØµØ­ÙÙŠ", "Ù†Ø§Ù‚Ø¯", "Ø­Ø§Ø±Ø³", "Ø±ÙŠØ§Ø¶ÙŠ", "Ø¹Ø§Ù…Ù„", "Ø¥Ø·ÙØ§Ø¦ÙŠ", "Ù…Ø±Ø´Ø¯", "Ø®Ø§Ø¯Ù…", "Ù…Ø­Ø§Ø³Ø¨", "Ù…Ø¯Ø±Ø¨", "ÙÙ†Ø§Ù†", "ØµØ§Ù†Ø¹", "Ù…ÙˆØ²Ø¹", "Ù…ÙØªØ´", "Ø¹Ø§Ù„Ù…", "ÙÙ„ÙƒÙŠ", "Ù…Ø±Ø§Ø³Ù„"] }
    ],
    pro: [
        { id: 'foods', name: 'Ù…Ø£ÙƒÙˆÙ„Ø§Øª ÙˆÙ…Ø´Ø±ÙˆØ¨Ø§Øª', words: ["ØªÙØ§Ø­", "Ù…ÙˆØ²", "Ø¨Ø±ØªÙ‚Ø§Ù„", "Ù…Ø§Ø¡", "Ù‚Ù‡ÙˆØ©", "Ø´Ø§ÙŠ", "Ø®Ø¨Ø²", "Ø£Ø±Ø²", "Ù„Ø­Ù…", "Ø¯Ø¬Ø§Ø¬", "Ø³Ù…Ùƒ", "Ø¹ØµÙŠØ±", "Ø­Ù„ÙŠØ¨", "Ø¬Ø¨Ù†", "Ø¨ÙŠØ¶", "Ø³ÙƒØ±", "Ù…Ù„Ø­", "Ø²ÙŠØª", "Ø²Ø¨Ø¯Ø©", "Ø¹Ø³Ù„", "Ø¨Ø·Ø§Ø·Ø§", "Ø·Ù…Ø§Ø·Ù…", "Ø¨ØµÙ„", "Ø«ÙˆÙ…", "Ø®Ø³", "Ø¬Ø²Ø±", "ÙƒØ¹ÙƒØ©", "Ù…Ø«Ù„Ø¬Ø§Øª", "Ù…ÙƒØ±ÙˆÙ†Ø©", "Ø¨ÙŠØªØ²Ø§", "Ø³Ù„Ø·Ø©", "Ø­Ø³Ø§Ø¡", "ØªÙˆØ§Ø¨Ù„", "Ù…Ø´Ø±ÙˆØ¨", "Ø¹Ù†Ø¨", "Ù…Ø§Ù†Ø¬Ùˆ", "ÙÙ„ÙÙ„", "Ù„ÙŠÙ…ÙˆÙ†", "Ø¨Ø³ÙƒÙˆÙŠØª", "ÙÙˆÙ„", "Ø¹Ø¯Ø³", "ÙØ±Ø§ÙˆÙ„Ø©", "Ø²ÙŠØªÙˆÙ†", "Ù…Ø±Ø¨Ù‰", "Ø³ÙƒØ±", "Ø´ÙˆÙƒÙˆÙ„Ø§ØªØ©", "ÙØ·Ø±", "Ø¹Ù„ÙƒØ©"] },
        { id: 'animals', name: 'Ø­ÙŠÙˆØ§Ù†Ø§Øª ÙˆØ·ÙŠÙˆØ±', words: ["ÙƒÙ„Ø¨", "Ù‚Ø·Ø©", "Ø£Ø³Ø¯", "Ù†Ù…Ø±", "ÙÙŠÙ„", "Ø²Ø±Ø§ÙØ©", "Ù‚Ø±Ø¯", "Ø­ØµØ§Ù†", "Ø¬Ù…Ù„", "Ø¶ÙØ¯Ø¹", "Ø«Ø¹Ù„Ø¨", "Ø°Ø¦Ø¨", "Ø¯Ø¨", "Ø£Ø±Ù†Ø¨", "Ø³Ù†Ø¬Ø§Ø¨", "Ø·Ø§Ø¦Ø±", "Ø­Ù…Ø§Ù…Ø©", "ØµÙ‚Ø±", "Ø¨ÙˆÙ…Ø©", "Ù†Ø³Ø±", "Ø¨Ø·Ø©", "Ø¯ÙŠÙƒ", "Ø¯Ø¬Ø§Ø¬Ø©", "Ø¨Ù‚Ø±Ø©", "ØºØ²Ø§Ù„", "ØªÙ…Ø³Ø§Ø­", "Ø«Ø¹Ø¨Ø§Ù†", "Ø³Ù…ÙƒØ©", "Ù‚Ø±Ø´", "Ø¯ÙˆÙ„ÙÙŠÙ†", "Ø­ÙˆØª", "Ù†Ø­Ù„Ø©", "Ù†Ù…Ù„Ø©", "Ø¹Ù†ÙƒØ¨ÙˆØª", "ÙØ±Ø§Ø´Ø©", "ÙŠØ±Ø¨ÙˆØ¹", "Ø³Ù„Ø­ÙØ§Ø©", "Ø®Ø±ÙˆÙ", "Ù…Ø§Ø¹Ø²", "ÙØ£Ø±", "Ø¨Ø¨ØºØ§Ø¡", "ÙƒÙ†ØºØ±", "Ø¨Ø·Ø±ÙŠÙ‚", "Ø¶Ø¨Ø¹", "Ù†ÙˆØ±Ø³", "Ø¹Ù‚Ø§Ø¨", "Ø³Ø¹Ø¯Ø§Ù†"] },
        { id: 'clothes', name: 'Ù…Ù„Ø§Ø¨Ø³ ÙˆØ¥ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª', words: ["Ù‚Ù…ÙŠØµ", "Ø¨Ù†Ø·Ø§Ù„", "ÙØ³ØªØ§Ù†", "ØªÙ†ÙˆØ±Ø©", "Ù…Ø¹Ø·Ù", "Ø³ØªØ±Ø©", "Ø­Ø¬Ø§Ø¨", "ÙˆØ´Ø§Ø­", "Ù‚Ø¨Ø¹Ø©", "Ø¬ÙˆØ±Ø¨", "Ù‚ÙØ§Ø²", "Ø­Ø°Ø§Ø¡", "ØµÙ†Ø¯Ù„", "Ø­Ù‚ÙŠØ¨Ø©", "Ù†Ø¸Ø§Ø±Ø©", "Ø­Ø²Ø§Ù…", "Ø³Ø§Ø¹Ø© ÙŠØ¯", "Ø®Ø§ØªÙ…", "Ù‚Ù„Ø§Ø¯Ø©", "Ø³ÙˆØ§Ø±", "Ø¬ÙŠØ¨", "Ø²Ø±", "Ø³Ø­Ø§Ø¨", "Ù‚Ù…Ø§Ø´", "Ø­Ø±ÙŠØ±", "Ø¬Ù„Ø¯", "Ù‚Ø·Ù†", "ØµÙˆÙ", "Ø¹Ø¨Ø§Ø¡Ø©", "Ø¨ÙŠØ¬Ø§Ù…Ø©", "Ø±Ø¨Ø·Ø© Ø¹Ù†Ù‚", "Ù…Ø±ÙŠÙˆÙ„", "ÙƒØ¨Ùƒ", "ÙØ±Ùˆ", "Ø´Ø§Ù„", "ØµØ¯Ø±ÙŠØ©", "Ù…Ù†Ø´ÙØ©", "Ù…Ù†Ø§Ù…Ø©", "Ù‚Ø¨Ø¹Ø© Ø´Ù…Ø³", "Ù…Ø´Ø¯", "Ø²ÙŠ", "Ø¨Ø§Ø±ÙˆÙƒØ©", "Ø¨ÙˆØª", "Ø¬ÙˆØ§Ø±Ø¨", "Ù„Ø¨Ø§Ø³", "Ø±Ø¯Ø§Ø¡", "Ù…Ø¦Ø²Ø±", "Ø³Ø±ÙˆØ§Ù„"] },
        { id: 'places', name: 'Ø£Ù…Ø§ÙƒÙ† ÙˆÙ…Ø¹Ø§Ù„Ù…', words: ["Ù…Ø¯Ø±Ø³Ø©", "Ù…Ø³ØªØ´ÙÙ‰", "Ù…Ù†Ø²Ù„", "Ù…Ø³Ø¬Ø¯", "ÙƒÙ†ÙŠØ³Ø©", "Ø³ÙˆÙ‚", "Ù…ÙƒØªØ¨Ø©", "Ù…Ø·Ø§Ø±", "Ù…Ø­Ø·Ø©", "Ø­Ø¯ÙŠÙ‚Ø©", "Ù…ØªØ­Ù", "Ù…ØµÙ†Ø¹", "Ù…Ù‚Ù‡Ù‰", "Ù…Ø·Ø¹Ù…", "ÙÙ†Ø¯Ù‚", "Ù…Ø¨Ù†Ù‰", "Ø¬Ø³Ø±", "Ø·Ø±ÙŠÙ‚", "Ø´Ø§Ø±Ø¹", "Ø³Ø§Ø­Ø©", "Ù‚ØµØ±", "Ù‚Ù„Ø¹Ø©", "Ø¨Ø±Ø¬", "Ø¨ÙˆØ§Ø¨Ø©", "Ø¨Ø¦Ø±", "Ù…Ù„Ø¹Ø¨", "Ù†Ø§Ø¯ÙŠ", "Ø¬Ø§Ù…Ø¹Ø©", "ÙˆØ²Ø§Ø±Ø©", "Ø³ÙØ§Ø±Ø©", "ÙƒØ±Ø§Ø¬", "Ù†ÙÙ‚", "Ù…Ù…Ø±", "Ù‚Ø¨Ùˆ", "Ø³Ø·Ø­", "Ø´Ø±ÙØ©", "Ù…Ø®Ø²Ù†", "Ù…ÙˆÙ‚Ù", "ØºØ±ÙØ©", "Ù‚Ø§Ø¹Ø©", "Ø¨Ù‡Ùˆ", "Ù…Ø³ØªÙˆØ¯Ø¹", "Ù…Ø¬Ù„Ø³", "Ø®ÙŠÙ…Ø©", "Ù…Ø®Ø¨Ø²", "Ù…ØºØ³Ù„Ø©", "Ø¯ÙƒØ§Ù†"] },
        { id: 'activities', name: 'Ø£ÙØ¹Ø§Ù„ ÙˆÙ†Ø´Ø§Ø·Ø§Øª', words: ["Ø¬Ø±ÙŠ", "Ø³Ø¨Ø§Ø­Ø©", "Ù‚Ø±Ø§Ø¡Ø©", "ÙƒØªØ§Ø¨Ø©", "Ø±Ø³Ù…", "ØºÙ†Ø§Ø¡", "Ø±Ù‚Øµ", "Ù„Ø¹Ø¨", "Ù†ÙˆÙ…", "Ø£ÙƒÙ„", "Ø´Ø±Ø¨", "Ø¶Ø­Ùƒ", "Ø¨ÙƒØ§Ø¡", "ØµØ±Ø§Ø®", "Ù…Ø´Ø§Ù‡Ø¯Ø©", "Ø§Ø³ØªÙ…Ø§Ø¹", "Ø­Ø¯ÙŠØ«", "Ø³ÙØ±", "ØµÙŠØ¯", "Ø·Ø¨Ø®", "ØªÙ†Ø¸ÙŠÙ", "Ø¹Ù…Ù„", "Ø¯Ø±Ø§Ø³Ø©", "Ù‚ÙŠØ§Ø¯Ø©", "Ø¨Ù†Ø§Ø¡", "Ù‡Ø¯Ù…", "Ø²Ø±Ø¹", "Ø­ØµØ§Ø¯", "Ø¥ØµÙ„Ø§Ø­", "ÙƒØ³Ø±", "ÙØªØ­", "Ø¥ØºÙ„Ø§Ù‚", "Ù‚ÙØ²", "ØµØ¹ÙˆØ¯", "Ù‡Ø¨ÙˆØ·", "Ø§Ù†ØªØ¸Ø§Ø±", "ØªÙÙƒÙŠØ±", "Ø­Ù„Ù…", "Ø¨Ù‚Ø§Ø¡", "ØªØ£Ù…Ù„", "ØªØ¬ÙˆÙ„", "Ø§Ø³ØªØ±Ø§Ø­Ø©", "Ø§Ø¬ØªÙ…Ø§Ø¹", "Ø¥Ø´Ø§Ø±Ø©", "Ø¥Ø±Ø³Ø§Ù„", "Ø§Ø³ØªÙ‚Ø¨Ø§Ù„", "Ø³Ø¤Ø§Ù„"] },
        { id: 'adjectives', name: 'ØµÙØ§Øª ÙˆØ£Ø­ÙˆØ§Ù„', words: ["Ø³Ø±ÙŠØ¹", "Ø¨Ø·ÙŠØ¡", "ÙƒØ¨ÙŠØ±", "ØµØºÙŠØ±", "Ø·ÙˆÙŠÙ„", "Ù‚ØµÙŠØ±", "Ø¬Ù…ÙŠÙ„", "Ù‚Ø¨ÙŠØ­", "Ø³Ø¹ÙŠØ¯", "Ø­Ø²ÙŠÙ†", "ØºØ§Ø¶Ø¨", "Ù‡Ø§Ø¯Ø¦", "ØµØ§Ø®Ø¨", "Ù†Ø¸ÙŠÙ", "Ù…ØªØ³Ø®", "Ù‚ÙˆÙŠ", "Ø¶Ø¹ÙŠÙ", "Ø¨Ø§Ø±Ø¯", "Ø­Ø§Ø±", "Ù…Ø´Ø±Ù‚", "Ù…Ø¸Ù„Ù…", "Ø¬Ø¯ÙŠØ¯", "Ù‚Ø¯ÙŠÙ…", "ØµØ¹Ø¨", "Ø³Ù‡Ù„", "Ø®ÙÙŠÙ", "Ø«Ù‚ÙŠÙ„", "Ø¬Ø§Ø¦Ø¹", "Ø¹Ø·Ø´Ø§Ù†", "Ù…Ø±ÙŠØ¶", "Ø³Ù„ÙŠÙ…", "Ø¨Ø¹ÙŠØ¯", "Ù‚Ø±ÙŠØ¨", "Ø­Ù‚ÙŠÙ‚ÙŠ", "ÙˆÙ‡Ù…ÙŠ", "Ø´Ø¬Ø§Ø¹", "Ø¬Ø¨Ø§Ù†", "Ù…Ø¶Ø­Ùƒ", "Ø¬Ø¯ÙŠ", "Ù…Ø£Ù„ÙˆÙ", "ØºØ±ÙŠØ¨", "Ø­ÙƒÙŠÙ…", "Ø£Ø­Ù…Ù‚", "Ù†Ø§Ø¬Ø­", "ÙØ§Ø´Ù„"] }
    ]
};
// ----------------------------------------------------

function initLobby() {
    const urlParams = new URLSearchParams(window.location.search);
    roomCode = urlParams.get('id');

    if (!roomCode) {
        alert("âŒ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©. Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©.");
        window.location.href = "index.html";
        return;
    }
    
    document.getElementById('room-code-value').innerText = roomCode;
    document.getElementById('room-title').innerText = `ØºØ±ÙØ© ${roomCode}`;

    firebase.auth().onAuthStateChanged(user => {
        if (!user) { 
            window.location.href = "auth.html"; 
            return; 
        }
        
        currentUID = user.uid;
        startRoomListener(roomCode);
    });
}

function startRoomListener(code) {
    if (listenerUnsubscribe) { listenerUnsubscribe(); } 

    const roomRef = db.collection('rooms').doc(code);

    listenerUnsubscribe = roomRef.onSnapshot(async doc => {
        if (!doc.exists) {
            alert("ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØºØ±ÙØ© Ø£Ùˆ Ø·Ø±Ø¯Ùƒ Ù…Ù†Ù‡Ø§.");
            window.location.href = "index.html";
            return;
        }

        roomData = doc.data();
        isHost = (roomData.hostUID === currentUID);
        
        const bannedPlayers = roomData.bannedPlayers || [];
        if (bannedPlayers.includes(currentUID)) {
             alert("Ù„Ù‚Ø¯ ØªÙ… Ø­Ø¸Ø±Ùƒ Ù…Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„ØºØ±ÙØ© Ù…Ù† Ù‚ÙØ¨Ù„ Ø§Ù„Ù…Ø¶ÙŠÙ.");
             window.location.href = "index.html";
             return;
        }

        if (!roomData.players || !roomData.players.includes(currentUID)) {
             alert("Ù„Ù‚Ø¯ ØªÙ… Ø¥Ø®Ø±Ø§Ø¬Ùƒ Ù…Ù† Ø§Ù„ØºØ±ÙØ©.");
             window.location.href = "index.html";
             return;
        }
        
        // ğŸš¨ Ù‡Ø§Ù…: Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ø´ÙƒÙ„ Ù…ØªØ²Ø§Ù…Ù† Ù‚Ø¨Ù„ ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
        await fetchAllPlayerDetails(roomData.players);

        if (roomData.status === 'playing') {
            displayRoleCard();
            return;
        }

        if (roomData.status === 'ended') {
            alert("Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø© ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ØºØ±ÙØ©. Ø§Ù„Ø¹ÙˆØ¯Ø©.");
            window.location.href = "index.html";
            return;
        }
        
        updateLobbyUI();
    }, error => {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØºØ±ÙØ©:", error);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø´Ø¨ÙƒØ©. Ø§Ù„Ø¹ÙˆØ¯Ø©.");
        window.location.href = "index.html";
    });
}

// ----------------------------------------------------
// ğŸš¨ Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø¹Ø¯Ù… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù…Ø´ÙƒÙ„Ø© 1 Ùˆ 3)
// ----------------------------------------------------

async function fetchAllPlayerDetails(playerUIDs) {
    if (isFetchingDetails) return; // Ù…Ù†Ø¹ Ø§Ù„Ø¬Ù„Ø¨ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯
    isFetchingDetails = true;
    const db = firebase.firestore();
    
    // ÙÙ„ØªØ±Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ø°ÙŠÙ† Ù„Ù… ÙŠØªÙ… Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡Ù… Ø¨Ø¹Ø¯ Ø£Ùˆ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡Ù… ØºÙŠØ± ÙƒØ§Ù…Ù„Ø©
    const usersToFetch = playerUIDs.filter(uid => !allUsersData[uid] || !allUsersData[uid].displayName || allUsersData[uid].isStale);

    if (usersToFetch.length === 0) {
        isFetchingDetails = false;
        return;
    }

    try {
        const userRefs = usersToFetch.map(uid => db.collection('users').doc(uid));
        const docs = await db.getAll(...userRefs);
        
        docs.forEach(doc => {
            const uid = doc.id;
            if (doc.exists) {
                const data = doc.data();
                allUsersData[uid] = {
                    displayName: data.playerName || `Ù„Ø§Ø¹Ø¨#${uid.substring(0, 4)}`, 
                    publicUid: data.publicUid || uid.substring(0, 8),
                    level: data.level || 1, 
                    gamesPlayed: data.gamesPlayed || 0,
                    impostorWins: data.impostorWins || 0,
                    isStale: false // ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­
                };
            } else {
                allUsersData[uid] = { 
                    displayName: `Ù„Ø§Ø¹Ø¨ Ù…ÙÙ‚ÙˆØ¯#${uid.substring(0, 4)}`,
                    publicUid: uid.substring(0, 8),
                    error: true,
                    isStale: false 
                };
            }
        });
        
    } catch (error) {
        console.error("ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†:", error);
    } finally {
        isFetchingDetails = false;
    }
}

// ----------------------------------------------------
// ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† (Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¬Ø§Ù‡Ø²ÙŠØ©)
// ----------------------------------------------------

function updateLobbyUI() {
    if (!roomData) return;
    
    document.getElementById('waiting-lobby').style.display = 'block';
    document.getElementById('role-display-card').style.display = 'none';

    const playersContainer = document.getElementById('players-list-container');
    const startGameBtn = document.getElementById('start-game-btn');
    const playerCount = roomData.players.length;

    document.getElementById('player-count').innerText = playerCount;
    
    // 1. Ø¹Ø±Ø¶ Ù…Ù„Ø®Øµ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    const settings = roomData.settings || {};
    const selectedCategoriesNames = getCategoryNamesByIds(settings.selectedCategories);
    const summaryText = `Ù…Ø­ØªØ§Ù„ÙˆÙ†: ${settings.impostors || 1} | Ù…Ø¬Ù…ÙˆØ¹Ø§Øª: ${selectedCategoriesNames.join(', ')}`;
    document.getElementById('settings-summary').innerText = summaryText;
    
    // 2. ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ø¨Ø¯Ø¡ (Ù„Ù„Ù…Ø¶ÙŠÙ ÙÙ‚Ø·)
    if (isHost) {
        startGameBtn.style.display = 'block';
        if (playerCount >= 3) {
            startGameBtn.disabled = false;
            startGameBtn.innerHTML = `<i class="fas fa-play"></i> Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨ (${playerCount} Ù„Ø§Ø¹Ø¨)`;
            document.getElementById('status-message').innerText = 'Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¨Ø¯Ø¡!';
            document.getElementById('status-message').style.color = '#34d399';
        } else {
            startGameBtn.disabled = true;
            startGameBtn.innerHTML = `<i class="fas fa-play"></i> Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨ (ÙŠØªØ·Ù„Ø¨ 3 Ù„Ø§Ø¹Ø¨ÙŠÙ†)`;
            document.getElementById('status-message').innerText = `Ø¬Ø§Ø±ÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ 3. Ø§Ù„Ø­Ø§Ù„ÙŠ: ${playerCount}).`;
            document.getElementById('status-message').style.color = '#ffcc00';
        }
    } else { // Ù„Ø§Ø¹Ø¨ Ø¹Ø§Ø¯ÙŠ
        startGameBtn.style.display = 'none';
        document.getElementById('status-message').innerText = `Ø¬Ø§Ø±ÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø¶ÙŠÙ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©. (Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${playerCount}).`;
        document.getElementById('status-message').style.color = '#ffcc00';
    }

    // 3. Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
    playersContainer.innerHTML = '';
    roomData.players.forEach(uid => {
        const playerDetails = allUsersData[uid];
        // ğŸš¨ Ø§Ù„Ø§Ø³Ù… ÙŠØ¸Ù‡Ø± Ø¨Ø¹Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø¬Ù„Ø¨
        const name = playerDetails && !playerDetails.error ? playerDetails.displayName : `Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...#${uid.substring(0, 4)}`;
        
        const isPlayerHost = (uid === roomData.hostUID);
        const isCurrentPlayer = (uid === currentUID);
        
        const div = document.createElement('div');
        div.className = `player-item ${isPlayerHost ? 'host' : ''}`;
        
        let actionsHTML = '';
        if (isHost && !isCurrentPlayer) {
            // ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¶ÙŠÙ: Ø§Ù„Ø·Ø±Ø¯ ÙÙ‚Ø·
            actionsHTML = `<button class="kick-btn" onclick="kickPlayer('${uid}', '${name}')"><i class="fas fa-user-times"></i> Ø·Ø±Ø¯/Ø­Ø¸Ø±</button>`;
        }

        const crownIcon = isPlayerHost ? '<i class="fas fa-crown" style="color:#ffd700; margin-left: 5px;"></i>' : '';
        
        const nameDisplay = `
            <span class="player-name-link" onclick="openProfileModal('${uid}')">
                ${crownIcon}${name} ${isPlayerHost ? '(Ø§Ù„Ù…Ø¶ÙŠÙ)' : ''}
            </span>
        `;

        div.innerHTML = `
            <div style="display: flex; align-items: center;">
                ${nameDisplay}
            </div>
            <div>${actionsHTML}</div>
        `;
        playersContainer.appendChild(div);
    });
}

// ----------------------------------------------------
// Ø¯Ø§Ù„Ø© Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© (ØªÙ… Ø¥Ø²Ø§Ù„Ø© ÙØ­Øµ Ø§Ù„Ø¬Ø§Ù‡Ø²ÙŠØ©)
// ----------------------------------------------------
async function startGame() {
    if (!isHost || !roomData || roomData.players.length < 3) {
         alert("âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨: ÙŠØªØ·Ù„Ø¨ 3 Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.");
         return;
    }

    const startGameBtn = document.getElementById('start-game-btn');
    startGameBtn.disabled = true;
    startGameBtn.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØ²ÙŠØ¹...';
    
    const allWords = getAllWordsFromSelectedCategories(roomData.settings.selectedCategories);
    
    if (allWords.length === 0) {
        alert("âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙ„Ù…Ø§Øª Ù…ØªØ§Ø­Ø©. Ø¹Ø¯ Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ø®ØªÙØ± Ù…Ø¬Ù…ÙˆØ¹Ø§Øª.");
        startGameBtn.disabled = false;
        startGameBtn.innerText = 'Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨';
        return;
    }
    
    const gameResult = distributeRoles(roomData.players, roomData.settings, allWords);

    if (!gameResult || !gameResult.roles || Object.keys(gameResult.roles).length === 0) {
        alert("âŒ ÙØ´Ù„ Ø¯Ø§Ø®Ù„ÙŠ ÙÙŠ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±.");
        startGameBtn.disabled = false;
        startGameBtn.innerText = 'Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨';
        return;
    }

    const roomRef = db.collection('rooms').doc(roomCode);
    try {
        await roomRef.update({
            status: 'playing',
            currentGameData: gameResult
        });
        displayRoleCard(); 

    } catch (error) {
        console.error("âŒ ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Firebase Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©:", error);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© (Firebase).");
        startGameBtn.disabled = false;
        startGameBtn.innerText = 'Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨';
    }
}


// ----------------------------------------------------
// Ø¯ÙˆØ§Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‡Ø¯ÙŠØ© (Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª)
// ----------------------------------------------------

function openProfileModal(playerUID) {
    const playerDetails = allUsersData[playerUID];
    const modalContent = document.getElementById('modal-profile-content');
    
    // ÙØ­Øµ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© Ø£Ùˆ Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø£Ùˆ ØªØ­Ù…Ù„ Ø®Ø·Ø£
    if (!playerDetails || playerDetails.error || !playerDetails.displayName) {
        modalContent.innerHTML = `
            <p style="color:#ff4f4f; text-align: center;">
                <i class="fas fa-spinner fa-spin"></i>
                âš ï¸ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø£Ùˆ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„ÙŠÙ‡Ø§.
            </p>
        `;
        document.getElementById('profile-modal').style.display = 'block';
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
        if (!isFetchingDetails) {
             fetchAllPlayerDetails([playerUID]);
        }
        return;
    }
    
    // Ø¨Ù†Ø§Ø¡ Ù…Ø­ØªÙˆÙ‰ Modal
    modalContent.innerHTML = `
        <h4 style="color:#f1f5f9;">${playerDetails.displayName}</h4>
        <p style="color:#94a3b8; font-size: 0.9rem;">Ø§Ù„Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¹Ø§Ù…: ${playerDetails.publicUid}</p>
        <hr style="border-color: #334155;">
        
        <p><strong>Ø§Ù„Ù…Ø³ØªÙˆÙ‰:</strong> <span style="color:#ffd700;">${playerDetails.level}</span></p>
        <p><strong>Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„Ù…Ù„Ø¹ÙˆØ¨Ø©:</strong> ${playerDetails.gamesPlayed}</p>
        <p><strong>Ø§Ù†ØªØµØ§Ø±Ø§Øª ÙƒÙ…Ø­ØªØ§Ù„:</strong> <span style="color:#ff4f4f;">${playerDetails.impostorWins}</span></p>
        
        <button class="gift-btn" onclick="sendGiftToPlayer('${playerUID}', '${playerDetails.displayName}')">
            <i class="fas fa-gift"></i> Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø¯ÙŠØ©
        </button>
    `;
    
    document.getElementById('profile-modal').style.display = 'block';
}

function sendGiftToPlayer(receiverUID, receiverName) {
    document.getElementById('profile-modal').style.display = 'none';
    
    if (confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ØµÙØ­Ø© Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ù„Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø¯ÙŠØ© Ø¥Ù„Ù‰ ${receiverName}ØŸ`)) {
        localStorage.setItem('giftReceiverUID', receiverUID);
        localStorage.setItem('giftReceiverName', receiverName);
        // ğŸš¨ ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ù„Ù gifts.html ÙÙŠ Ù…Ø´Ø±ÙˆØ¹Ùƒ
        window.location.href = 'gifts.html'; 
    }
}

// ----------------------------------------------------
// (Ø¨Ù‚ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©)
// ----------------------------------------------------

async function kickPlayer(playerUID, playerName) {
    if (!isHost || !roomData) return;
    
    if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø·Ø±Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨: ${playerName}ØŸ Ø³ÙŠØªÙ… Ø·Ø±Ø¯Ù‡ ÙˆØ­Ø¸Ø±Ù‡ Ù…Ù† Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù‡Ø°Ù‡ Ø§Ù„ØºØ±ÙØ© Ù…Ø¬Ø¯Ø¯Ø§Ù‹.`)) {
        const roomRef = db.collection('rooms').doc(roomCode);
        
        try {
            await roomRef.update({
                players: firebase.firestore.FieldValue.arrayRemove(playerUID),
                bannedPlayers: firebase.firestore.FieldValue.arrayUnion(playerUID),
            });
            alert(`ØªÙ… Ø·Ø±Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ ${playerName} ÙˆØ­Ø¸Ø±Ù‡ Ù…Ù† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„ØºØ±ÙØ©.`);
        } catch (error) {
            console.error("Ø®Ø·Ø£ ÙÙŠ Ø·Ø±Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨:", error);
            alert("ÙØ´Ù„ ÙÙŠ Ø·Ø±Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨. ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Ø£Ù…Ø§Ù† Firestore.");
        }
    }
}

async function leaveRoom(event) {
    event.preventDefault(); 
    if (!roomData || !currentUID) { window.location.href = "index.html"; return; }

    if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØºØ±ÙØ©ØŸ")) return;

    const roomRef = db.collection('rooms').doc(roomCode);
    
    if (isHost) {
        if (roomData.players.length === 1) {
            if (listenerUnsubscribe) listenerUnsubscribe();
            await roomRef.delete();
            window.location.href = "index.html";
            return;
        } else {
            const remainingPlayers = roomData.players.filter(uid => uid !== currentUID);
            const newHostUID = remainingPlayers[0];
            if(newHostUID) {
                 await roomRef.update({
                    hostUID: newHostUID,
                    players: firebase.firestore.FieldValue.arrayRemove(currentUID)
                });
            }
        }
    } else {
        await roomRef.update({
            players: firebase.firestore.FieldValue.arrayRemove(currentUID)
        });
    }

    if (listenerUnsubscribe) listenerUnsubscribe();
    window.location.href = "index.html";
}


function getCategoryNamesByIds(ids) {
    if (!ids) return [];
    let names = [];
    [...wordCategories.free, ...wordCategories.pro].forEach(cat => {
        if (ids.includes(cat.id)) {
            names.push(cat.name);
        }
    });
    return names;
}

function distributeRoles(players, settings, allWords) {
    const numImpostors = settings.impostors || 1;
    const noWordRole = settings.noWordRole || false; 
    
    let playerRoles = {}; 
    const randomWordIndex = Math.floor(Math.random() * allWords.length);
    const civilianWord = allWords[randomWordIndex];
    
    let availablePlayers = [...players];
    let selectedImpostors = [];
    let selectedNoWord = [];

    for (let i = 0; i < numImpostors && availablePlayers.length > 0; i++) {
        const randomIndex = Math.floor(Math.random() * availablePlayers.length);
        selectedImpostors.push(availablePlayers.splice(randomIndex, 1)[0]);
    }

    if (noWordRole && availablePlayers.length > 0) {
        const randomIndex = Math.floor(Math.random() * availablePlayers.length);
        selectedNoWord.push(availablePlayers.splice(randomIndex, 1)[0]);
    }
    
    players.forEach(uid => {
        if (selectedImpostors.includes(uid)) {
            playerRoles[uid] = { role: 'impostor', word: IMPOSTOR_NO_WORD_TAG }; 
        } else if (selectedNoWord.includes(uid)) {
            playerRoles[uid] = { role: 'noWord', word: 'Ù„Ø§ ÙƒÙ„Ù…Ø© Ù„Ùƒ!' };
        } else {
            playerRoles[uid] = { role: 'civilian', word: civilianWord };
        }
    });

    return {
        roles: playerRoles,
        civilianWord: civilianWord,
        impostorWord: IMPOSTOR_NO_WORD_TAG, 
        players: players, 
        settingsUsed: settings
    };
}

function displayRoleCard() {
    document.getElementById('waiting-lobby').style.display = 'none';
    document.getElementById('role-display-card').style.display = 'block';

    if (!roomData || !roomData.currentGameData || !roomData.currentGameData.roles) return;

    const gameData = roomData.currentGameData;
    const playerRoleData = gameData.roles[currentUID];
    
    if (!playerRoleData) {
        console.error("Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¯ÙˆØ± Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¬Ø§Ø±ÙŠØ©.");
        return;
    }

    const { role, word } = playerRoleData;
    let title, color, instructions;
    let displayedWord = word;

    switch (role) {
        case 'impostor':
            title = 'Ø£Ù†Øª Ø§Ù„Ù…Ø­ØªØ§Ù„!';
            color = '#ff4f4f';
            if (word === IMPOSTOR_NO_WORD_TAG) {
                displayedWord = '---'; 
                instructions = `ÙƒÙ„Ù…ØªÙƒ: **Ù„Ø§ ÙƒÙ„Ù…Ø© Ù„Ø¯ÙŠÙƒ**. Ù…Ù‡Ù…ØªÙƒ Ù‡ÙŠ Ù…Ø¹Ø±ÙØ© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø¯Ù†ÙŠÙŠÙ† Ù…Ù† Ø®Ù„Ø§Ù„ Ø¥Ø¬Ø§Ø¨Ø§ØªÙ‡Ù… ÙˆØ¥Ø®ÙØ§Ø¡ Ù‡ÙˆÙŠØªÙƒ ÙƒÙ…Ø­ØªØ§Ù„.`;
            } else {
                instructions = `ÙƒÙ„Ù…ØªÙƒ Ø§Ù„Ù…Ø²ÙŠÙØ© Ù‡ÙŠ: **${word}**. Ù…Ù‡Ù…ØªÙƒ Ù‡ÙŠ Ø§Ù„ØªØ¸Ø§Ù‡Ø± Ø¨Ø£Ù† Ù„Ø¯ÙŠÙƒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø¯Ù†ÙŠÙŠÙ† (Ø¯ÙˆÙ† ÙƒØ´Ù ÙƒÙ„Ù…ØªÙƒ!).`;
            }
            break;
        case 'noWord':
            title = 'Ø£Ù†Øª Ø¨Ù„Ø§ ÙƒÙ„Ù…Ø©!';
            color = '#6366f1';
            displayedWord = 'Ù„Ø§ ÙƒÙ„Ù…Ø© Ù„Ùƒ!';
            instructions = `ÙƒÙ„Ù…ØªÙƒ: **Ù„Ø§ ÙƒÙ„Ù…Ø© Ù„Ùƒ!**. Ù…Ù‡Ù…ØªÙƒ Ù‡ÙŠ ÙƒØ´Ù Ø§Ù„Ù…Ø­ØªØ§Ù„ ÙˆÙƒØ´Ù Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ø°ÙŠÙ† Ù„Ø¯ÙŠÙ‡Ù… Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© Ø¯ÙˆÙ† Ø£Ù† ÙŠÙ†ÙƒØ´Ù Ø£Ù…Ø±Ùƒ.`;
            break;
        case 'civilian':
        default:
            title = 'Ø£Ù†Øª Ù…Ø¯Ù†ÙŠ!';
            color = '#34d399';
            instructions = `ÙƒÙ„Ù…ØªÙƒ Ù‡ÙŠ: **${word}**. Ù…Ù‡Ù…ØªÙƒ Ù‡ÙŠ ÙƒØ´Ù Ø§Ù„Ù…Ø­ØªØ§Ù„ Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ§Ù„Ø£Ø¬ÙˆØ¨Ø©.`;
            break;
    }

    document.getElementById('role-title').innerText = title;
    document.getElementById('role-word').innerText = displayedWord;
    document.getElementById('role-instructions').innerHTML = instructions;
    document.getElementById('role-card').style.borderColor = color;
    document.getElementById('role-title').style.color = color;
}

function hideRoleCard() {
    document.getElementById('role-display-card').style.display = 'none';
    alert("Ø¨Ø¯Ø£Øª Ø§Ù„Ù…Ù†Ø§Ù‚Ø´Ø©! Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨."); 
}

function copyCode() {
    const code = document.getElementById('room-code-value').innerText;
    navigator.clipboard.writeText(code).then(() => {
        const btn = document.getElementById('copy-btn');
        const originalIcon = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i>';
        setTimeout(() => { btn.innerHTML = originalIcon; }, 1000);
    }).catch(err => {
        console.error('ÙØ´Ù„ ÙÙŠ Ù†Ø³Ø® Ø§Ù„Ù†Øµ: ', err);
    });
}
</script>
</body>
</html>

