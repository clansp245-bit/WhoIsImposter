<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ•¹ï¸ ØºØ±ÙØ© Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</title>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="auth.js"></script> 
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
/* Ù†ÙØ³ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© */
#home-icon { position: absolute; top: 20px; left: 20px; font-size: 24px; color: #94a3b8; cursor: pointer; transition: color 0.3s; }
#home-icon:hover { color: #ff4f4f; }
body { font-family: 'Cairo', sans-serif; background-color: #0f172a; color: #f1f5f9; text-align: center; padding: 20px; min-height: 100vh; margin: 0; display: flex; flex-direction: column; align-items: center; }
.card { background-color: #1e293b; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; margin: 15px auto; box-shadow: 0 8px 15px rgba(0,0,0,0.3); text-align: right; }
h2 { font-size: 2rem; font-weight: 700; margin-bottom: 10px; color: #34d399; }
#room-code-display { background-color: #334155; padding: 15px; border-radius: 8px; margin-bottom: 25px; display: flex; justify-content: center; align-items: center; gap: 15px; font-size: 1.2rem; color: #ffd700; }
#room-code-value { font-size: 1.8rem; font-weight: 700; letter-spacing: 3px; text-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
#copy-btn { background: none; border: none; color: #34d399; font-size: 1.2rem; cursor: pointer; transition: color 0.2s; }
.players-list { margin-top: 20px; }
.player-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; margin-bottom: 8px; background-color: #334155; border-radius: 8px; font-weight: 700; border-left: 5px solid transparent; }
.player-item.host { border-left-color: #6366f1; }
.kick-btn { background-color: #ff4f4f; color: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: background-color 0.2s; margin-left: 5px; }
.kick-btn:hover { background-color: #e53e3e; }
#start-game-btn { margin-top: 25px; padding: 15px 30px; font-size: 20px; font-weight: 700; background-color: #34d399; color: #0f172a; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.3s; width: 100%; }
#start-game-btn:disabled { background-color: #4b5563; cursor: not-allowed; color: #94a3b8; }
#role-card { background-color: #1e293b; padding: 40px; border-radius: 15px; box-shadow: 0 0 20px rgba(52, 211, 153, 0.4); margin-top: 30px; text-align: center; border: 3px solid #34d399; }
#role-title { font-size: 2.5rem; color: #ffd700; margin-bottom: 10px; }
#role-word { font-size: 1.8rem; color: #f1f5f9; font-weight: 700; margin-bottom: 20px; }
#role-instructions { color: #94a3b8; font-size: 1rem; }
#status-message { margin-top: 20px; color: #ffcc00; font-weight: 700; }
.player-name-link { cursor: pointer; transition: color 0.2s; }
.player-name-link:hover { color: #ffd700; }
.modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
.modal-content { background-color: #1e293b; margin: 10% auto; padding: 20px; border: 1px solid #334155; width: 80%; max-width: 400px; border-radius: 12px; text-align: right; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
.close-btn { color: #aaa; float: left; font-size: 28px; font-weight: bold; }
.close-btn:hover, .close-btn:focus { color: #ff4f4f; text-decoration: none; cursor: pointer; }
.gift-btn { background-color: #ffd700; color: #0f172a; border:none; padding: 10px 20px; border-radius: 8px; margin-top: 20px; font-weight: 700; cursor: pointer; transition: background-color 0.2s; }
.gift-btn:hover { background-color: #ffc400; }
</style>
</head>

<body onload="initLobby()">

<a href="#" id="home-icon" title="Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØºØ±ÙØ©" onclick="leaveRoom(event)">
    <i class="fas fa-sign-out-alt"></i>
</a>

<div class="card" id="waiting-lobby">
    <h2 id="room-title">ØºØ±ÙØ© Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù„Ø¹Ø¨</h2>
    
    <div id="room-code-display">
        Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©: <span id="room-code-value">---</span>
        <button id="copy-btn" title="Ù†Ø³Ø® Ø§Ù„Ø±Ù…Ø²" onclick="copyCode()"><i class="fas fa-copy"></i></button>
    </div>
    
    <div id="status-message">Ø¬Ø§Ø±ÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†...</div>

    <div class="words-settings-summary" style="color:#94a3b8; font-size:0.9rem; text-align: center; margin-bottom: 15px;">
        <i class="fas fa-cog"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª: <span id="settings-summary">---</span>
    </div>
    
    <h3><i class="fas fa-users"></i> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† (<span id="player-count">0</span>)</h3>
    <div class="players-list" id="players-list-container"></div>
    
    <button id="start-game-btn" onclick="startGame()" disabled style="display: none;">
        <i class="fas fa-play"></i> Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨
    </button>
</div>

<div class="card" id="role-display-card" style="display:none;">
    <h2>Ø¯ÙˆØ±Ùƒ ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø©</h2>
    <div id="role-card">
        <div id="role-title">---</div>
        <div id="role-word">---</div>
        <div id="role-instructions">---</div>
    </div>
    <button onclick="hideRoleCard()" style="margin-top: 20px; background-color: #6366f1;">
        <i class="fas fa-eye-slash"></i> Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
    </button>
</div>

<div id="profile-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="document.getElementById('profile-modal').style.display='none'">&times;</span>
        <h3 style="color:#34d399;"><i class="fas fa-id-badge"></i> Ù…Ù„Ù Ø§Ù„Ù„Ø§Ø¹Ø¨</h3>
        <div id="modal-profile-content"></div>
    </div>
</div>

<script>
let currentUID;
let roomCode;
let roomData = null;
let isHost = false;
let listenerUnsubscribe = null;
let allUsersData = {}; 
let isFetchingDetails = false;

// Ø§Ù„Ø«ÙˆØ§Ø¨Øª
const IMPOSTOR_NO_WORD_TAG = 'IMPOSTOR_NO_WORD_TAG_BLANK'; 
const wordCategories = {
    free: [
        { id: 'objects', name: 'Ø£Ø´ÙŠØ§Ø¡ ÙˆØ£Ø¯ÙˆØ§Øª', words: ["Ù‚Ù„Ù…", "ÙƒÙˆØ¨", "ÙƒØ±Ø³ÙŠ", "Ù…ÙØªØ§Ø­", "Ù‡Ø§ØªÙ"] }, 
        // ... (ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù‚ÙŠØ© Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ù‡Ù†Ø§)
    ],
    pro: [
        { id: 'foods', name: 'Ù…Ø£ÙƒÙˆÙ„Ø§Øª', words: ["ØªÙØ§Ø­", "Ù…ÙˆØ²", "Ø¨Ø±ØªÙ‚Ø§Ù„"] }
        // ... (ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù‚ÙŠØ© Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ù‡Ù†Ø§)
    ]
};

function initLobby() {
    const urlParams = new URLSearchParams(window.location.search);
    roomCode = urlParams.get('id');

    if (!roomCode) {
        alert("âŒ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©.");
        window.location.href = "index.html";
        return;
    }
    
    document.getElementById('room-code-value').innerText = roomCode;
    document.getElementById('room-title').innerText = `ØºØ±ÙØ© ${roomCode}`;

    firebase.auth().onAuthStateChanged(user => {
        if (!user) { 
            window.location.href = "auth.html"; 
            return; 
        }
        currentUID = user.uid;
        startRoomListener(roomCode);
    });
}

function startRoomListener(code) {
    if (listenerUnsubscribe) { listenerUnsubscribe(); } 

    const roomRef = db.collection('rooms').doc(code);

    listenerUnsubscribe = roomRef.onSnapshot(async doc => {
        if (!doc.exists) {
            console.warn("Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.");
            // Ù„Ù† Ù†Ù‚ÙˆÙ… Ø¨Ø§Ù„Ø·Ø±Ø¯ Ù‡Ù†Ø§ Ù„Ù„ØªØ¬Ø±Ø¨Ø©
            return;
        }

        roomData = doc.data();
        isHost = (roomData.hostUID === currentUID);
        
        // ---------------------------------------------------------
        // ğŸ›‘ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø·Ø±Ø¯ Ù…Ø¤Ù‚ØªØ§Ù‹ Ù„Ø­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© ğŸ›‘
        // ---------------------------------------------------------
        /*
        const bannedPlayers = roomData.bannedPlayers || [];
        if (bannedPlayers.includes(currentUID)) {
             alert("Ù„Ù‚Ø¯ ØªÙ… Ø­Ø¸Ø±Ùƒ.");
             window.location.href = "index.html";
             return;
        }

        if (!roomData.players || !roomData.players.includes(currentUID)) {
             alert("Ù„Ù‚Ø¯ ØªÙ… Ø¥Ø®Ø±Ø§Ø¬Ùƒ.");
             window.location.href = "index.html";
             return;
        }
        */
        // ---------------------------------------------------------
        
        // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¨Ø§Ù„Ø£Ø³ÙÙ„)
        await fetchAllPlayerDetails(roomData.players || []);

        if (roomData.status === 'playing') {
            displayRoleCard();
            return;
        }

        updateLobbyUI();
    }, error => {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØºØ±ÙØ©:", error);
    });
}

// ----------------------------------------------------
// âœ… Ø¥ØµÙ„Ø§Ø­ Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: Ø§Ø³ØªØ¨Ø¯Ø§Ù„ db.getAll Ø¨Ù€ Promise.all
// ----------------------------------------------------
async function fetchAllPlayerDetails(playerUIDs) {
    if (isFetchingDetails || !playerUIDs || playerUIDs.length === 0) return;
    isFetchingDetails = true;
    
    // Ø¬Ù„Ø¨ ÙÙ‚Ø· Ù…Ù† Ù„ÙŠØ³ Ù„Ø¯ÙŠÙ†Ø§ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡Ù…
    const usersToFetch = playerUIDs.filter(uid => !allUsersData[uid] || !allUsersData[uid].displayName);

    if (usersToFetch.length === 0) {
        isFetchingDetails = false;
        return;
    }

    try {
        // ğŸ”¥ Ø§Ù„Ø­Ù„ Ù‡Ù†Ø§: Ø§Ø³ØªØ®Ø¯Ø§Ù… Promise.all Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† getAll Ø§Ù„ØªÙŠ Ù„Ø§ ØªØ¹Ù…Ù„ ÙÙŠ Ø§Ù„ÙˆÙŠØ¨
        const promises = usersToFetch.map(uid => db.collection('users').doc(uid).get());
        const docs = await Promise.all(promises);
        
        docs.forEach(doc => {
            const uid = doc.id;
            if (doc.exists) {
                const data = doc.data();
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø§Ø³Ù…
                const playerName = data.displayName || data.username || data.name || `Ù„Ø§Ø¹Ø¨#${uid.substring(0, 4)}`;

                allUsersData[uid] = {
                    displayName: playerName, 
                    publicUid: data.publicUid || '---',
                    level: data.level || 1, 
                    gamesPlayed: data.gamesPlayed || 0,
                    impostorWins: data.impostorWins || 0
                };
            } else {
                allUsersData[uid] = { 
                    displayName: `Ù…Ø¬Ù‡ÙˆÙ„#${uid.substring(0, 4)}`,
                    publicUid: '---',
                    error: true
                };
            }
        });
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙÙˆØ±Ø§Ù‹ Ø¨Ø¹Ø¯ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        updateLobbyUI();

    } catch (error) {
        console.error("ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†:", error);
    } finally {
        isFetchingDetails = false;
    }
}

function updateLobbyUI() {
    if (!roomData) return;
    
    document.getElementById('waiting-lobby').style.display = 'block';
    document.getElementById('role-display-card').style.display = 'none';

    const playersContainer = document.getElementById('players-list-container');
    const startGameBtn = document.getElementById('start-game-btn');
    const players = roomData.players || [];
    const playerCount = players.length;

    document.getElementById('player-count').innerText = playerCount;
    
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    const settings = roomData.settings || {};
    document.getElementById('settings-summary').innerText = `Ù…Ø­ØªØ§Ù„ÙˆÙ†: ${settings.impostors || 1}`;
    
    // Ø²Ø± Ø§Ù„Ø¨Ø¯Ø¡
    if (isHost) {
        startGameBtn.style.display = 'block';
        if (playerCount >= 3) {
            startGameBtn.disabled = false;
            document.getElementById('status-message').innerText = 'Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¨Ø¯Ø¡!';
            document.getElementById('status-message').style.color = '#34d399';
        } else {
            startGameBtn.disabled = true;
            document.getElementById('status-message').innerText = `Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø¹Ø¯Ø¯ (Ø§Ù„Ø­Ø§Ù„ÙŠ: ${playerCount})`;
        }
    } else {
        startGameBtn.style.display = 'none';
        document.getElementById('status-message').innerText = `Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø¶ÙŠÙ... (Ø§Ù„Ø¹Ø¯Ø¯: ${playerCount})`;
    }

    // Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    playersContainer.innerHTML = '';
    players.forEach(uid => {
        const playerDetails = allUsersData[uid];
        const name = playerDetails ? playerDetails.displayName : `Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...`;
        
        const isPlayerHost = (uid === roomData.hostUID);
        const div = document.createElement('div');
        div.className = `player-item ${isPlayerHost ? 'host' : ''}`;
        
        let actionsHTML = '';
        if (isHost && uid !== currentUID) {
            // Ø²Ø± Ø§Ù„Ø·Ø±Ø¯ (Ø´ÙƒÙ„ÙŠ Ø­Ø§Ù„ÙŠØ§Ù‹ Ù„Ø£Ù†Ù†Ø§ Ø£ÙˆÙ‚ÙÙ†Ø§ Ø§Ù„Ù…Ù†Ø·Ù‚)
            actionsHTML = `<button class="kick-btn" onclick="kickPlayer('${uid}', '${name}')"><i class="fas fa-user-times"></i></button>`;
        }

        const crownIcon = isPlayerHost ? '<i class="fas fa-crown" style="color:#ffd700;"></i> ' : '';
        
        div.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px;">
                <span class="player-name-link" onclick="openProfileModal('${uid}')">
                    ${crownIcon} ${name}
                </span>
            </div>
            <div>${actionsHTML}</div>
        `;
        playersContainer.appendChild(div);
    });
}

async function startGame() {
    if (!isHost) return;
    // (ØªÙ… Ø§Ø®ØªØµØ§Ø± Ø§Ù„Ù…Ù†Ø·Ù‚ Ù‡Ù†Ø§ Ù„Ù„ØªØ±ÙƒÙŠØ²ØŒ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙƒØ§Ù…Ù„ ÙÙŠ Ø±Ø¯Ùƒ Ø§Ù„Ø³Ø§Ø¨Ù‚ ØµØ­ÙŠØ­)
    // Ù„ØªØ¬Ø±Ø¨Ø© Ø³Ø±ÙŠØ¹Ø©ØŒ Ø³Ù†Ø¶Ø¹ Ø­Ø§Ù„Ø© playing ÙÙ‚Ø·
    const roomRef = db.collection('rooms').doc(roomCode);
    
    // ØªÙˆØ²ÙŠØ¹ Ø¨Ø³ÙŠØ· Ù„Ù„Ø£Ø¯ÙˆØ§Ø± Ù„Ù„ØªØ¬Ø±Ø¨Ø©
    const players = roomData.players;
    const roles = {};
    players.forEach((p, i) => {
        roles[p] = { role: i === 0 ? 'impostor' : 'civilian', word: 'ØªØ¬Ø±Ø¨Ø©' };
    });

    await roomRef.update({
        status: 'playing',
        currentGameData: { roles: roles }
    });
}

function openProfileModal(playerUID) {
    const playerDetails = allUsersData[playerUID];
    const modalContent = document.getElementById('modal-profile-content');
    
    if (!playerDetails) { return; }
    
    modalContent.innerHTML = `
        <h4 style="color:#f1f5f9;">${playerDetails.displayName}</h4>
        <p>Ø§Ù„Ù…Ø¹Ø±Ù‘Ù: ${playerDetails.publicUid}</p>
        <p>Ø§Ù„Ù…Ø³ØªÙˆÙ‰: ${playerDetails.level}</p>
        <button class="gift-btn" onclick="alert('Ù‚Ø±ÙŠØ¨Ø§Ù‹!')">Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø¯ÙŠØ©</button>
    `;
    document.getElementById('profile-modal').style.display = 'block';
}

// Ø¨Ù‚ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© (Ù†Ø³Ø® Ø§Ù„Ø±Ù…Ø²ØŒ Ù…ØºØ§Ø¯Ø±Ø©ØŒ Ø¥Ù„Ø®)
function copyCode() {
    const code = document.getElementById('room-code-value').innerText;
    navigator.clipboard.writeText(code);
}
function leaveRoom(e) {
    e.preventDefault();
    window.location.href = "index.html";
}
function hideRoleCard() {
    document.getElementById('role-display-card').style.display = 'none';
}
// Ø¯ÙˆØ§Ù„ Ø§Ù„Ø·Ø±Ø¯ (Ù„Ù† ØªØ¹Ù…Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹ Ù„Ø£Ù†Ù†Ø§ Ø£ÙˆÙ‚ÙÙ†Ø§ Ø§Ù„ØªØ­Ù‚Ù‚)
async function kickPlayer(uid, name) {
    if(!confirm(`Ø·Ø±Ø¯ ${name}ØŸ`)) return;
    await db.collection('rooms').doc(roomCode).update({
        players: firebase.firestore.FieldValue.arrayRemove(uid)
    });
}

</script>
</body>
</html>
