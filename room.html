<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ•¹ï¸ ØºØ±ÙØ© Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</title>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="auth.js"></script> 
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
/* Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© */
#home-icon { position: absolute; top: 20px; left: 20px; font-size: 24px; color: #94a3b8; cursor: pointer; transition: color 0.3s; }
#home-icon:hover { color: #ff4f4f; }
body { font-family: 'Cairo', sans-serif; background-color: #0f172a; color: #f1f5f9; text-align: center; padding: 20px; min-height: 100vh; margin: 0; display: flex; flex-direction: column; align-items: center; }
.card { background-color: #1e293b; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; margin: 15px auto; box-shadow: 0 8px 15px rgba(0,0,0,0.3); text-align: right; }
h2 { font-size: 2rem; font-weight: 700; margin-bottom: 10px; color: #34d399; }
#room-code-display { background-color: #334155; padding: 15px; border-radius: 8px; margin-bottom: 25px; display: flex; justify-content: center; align-items: center; gap: 15px; font-size: 1.2rem; color: #ffd700; }
#room-code-value { font-size: 1.8rem; font-weight: 700; letter-spacing: 3px; text-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
#copy-btn { background: none; border: none; color: #34d399; font-size: 1.2rem; cursor: pointer; transition: color 0.2s; }
.players-list { margin-top: 20px; }
.player-item { 
    display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; 
    margin-bottom: 8px; background-color: #334155; border-radius: 8px; font-weight: 700; 
    border-left: 5px solid transparent; 
    transition: all 0.3s; /* Ø¥Ø¶Ø§ÙØ© Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø¯Ø®ÙˆÙ„ */
    position: relative;
}
.player-item.host { border-left-color: #6366f1; }

/* ğŸŒŸ ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø¹Ø¶ÙˆÙŠØ© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© ÙˆØ§Ù„Ù…Ø¯ÙŠØ± (Ø§Ù„Ø¥ØµÙ„Ø§Ø­ 4 Ùˆ 5) */
.player-item.pro-member { border-left-color: #ffd700; }
.player-item.super-host::before {
    content: "ğŸ‘‘ DEV";
    position: absolute;
    top: -10px;
    right: 10px;
    background-color: #ff4f4f;
    color: white;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.7rem;
    animation: pulse 1.5s infinite;
}

/* ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¯Ø®ÙˆÙ„/Ø§Ù„ØªÙ…ÙŠÙŠØ² */
.player-item.new-join {
    animation: join-pulse 1s ease-out;
}
@keyframes join-pulse {
    0% { transform: scale(0.95); opacity: 0.5; }
    50% { transform: scale(1.01); opacity: 1; }
    100% { transform: scale(1); opacity: 1; }
}
@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(255, 79, 79, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(255, 79, 79, 0); }
    100% { box-shadow: 0 0 0 0 rgba(255, 79, 79, 0); }
}

.kick-btn { background-color: #ff4f4f; color: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: background-color 0.2s; margin-left: 5px; }
.kick-btn:hover { background-color: #e53e3e; }
#start-game-btn { margin-top: 25px; padding: 15px 30px; font-size: 20px; font-weight: 700; background-color: #34d399; color: #0f172a; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.3s; width: 100%; }
#start-game-btn:disabled { background-color: #4b5563; cursor: not-allowed; color: #94a3b8; }
.words-settings-summary { text-align: right; border-top: 1px solid #334155; padding-top: 15px; margin-top: 15px; }

/* ğŸƒ ØªØ­Ø³ÙŠÙ† ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© (Ø§Ù„Ø¥ØµÙ„Ø§Ø­ 3) */
#role-display-card {
    background-color: #1e293b;
    padding: 20px;
    border-radius: 15px;
    margin-top: 30px;
    text-align: center;
    border: 3px solid #34d399;
}
#role-card { 
    background: linear-gradient(145deg, #0f172a, #1e293b);
    padding: 30px 20px;
    border-radius: 12px;
    box-shadow: 0 0 25px rgba(52, 211, 153, 0.5), inset 0 0 10px rgba(255, 255, 255, 0.1);
    border: 1px solid #34d399;
    margin-top: 20px;
}
#role-title { 
    font-size: 2.8rem; 
    font-weight: 900;
    color: #ffd700; 
    margin-bottom: 10px;
    text-shadow: 0 0 8px rgba(255, 215, 0, 0.6);
}
#role-word { 
    font-size: 2.2rem; 
    color: #f1f5f9; 
    font-weight: 700; 
    padding: 10px 0;
    border-top: 1px dashed #334155;
    border-bottom: 1px dashed #334155;
    margin: 20px 0;
}
#role-instructions { color: #94a3b8; font-size: 1.1rem; }
#status-message { margin-top: 20px; color: #ffcc00; font-weight: 700; }
.player-name-link { cursor: pointer; transition: color 0.2s; }
.player-name-link:hover { color: #ffd700; }
/* ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
.modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); animation: fadeIn 0.3s; }
.modal-content { background-color: #1e293b; margin: 10% auto; padding: 30px; border: 1px solid #334155; width: 80%; max-width: 400px; border-radius: 12px; text-align: right; box-shadow: 0 8px 25px rgba(0,0,0,0.7); animation: slideIn 0.3s; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
.close-btn { color: #aaa; float: left; font-size: 28px; font-weight: bold; }
.close-btn:hover, .close-btn:focus { color: #ff4f4f; text-decoration: none; cursor: pointer; }
.gift-btn { background-color: #ffd700; color: #0f172a; border:none; padding: 10px 20px; border-radius: 8px; margin-top: 20px; font-weight: 700; cursor: pointer; transition: background-color 0.2s; }
.gift-btn:hover { background-color: #ffc400; }
</style>
</head>

<body onload="initLobby()">

<a href="#" id="home-icon" title="Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØºØ±ÙØ©" onclick="leaveRoom(event)">
    <i class="fas fa-sign-out-alt"></i>
</a>

<div class="card" id="waiting-lobby">
    <h2 id="room-title">ØºØ±ÙØ© Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù„Ø¹Ø¨</h2>
    
    <div id="room-code-display">
        Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©: <span id="room-code-value">---</span>
        <button id="copy-btn" title="Ù†Ø³Ø® Ø§Ù„Ø±Ù…Ø²" onclick="copyCode()"><i class="fas fa-copy"></i></button>
    </div>
    
    <div id="status-message">Ø¬Ø§Ø±ÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†...</div>

    <div class="words-settings-summary">
        <div style="font-size:1.1rem; color:#f1f5f9; font-weight: 700; margin-bottom: 8px;">
            <i class="fas fa-cog"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©
        </div>
        <div style="color:#94a3b8; font-size:0.95rem; text-align: center;">
            <p>Ø§Ù„Ù…Ø­ØªØ§Ù„ÙˆÙ†: <span id="impostors-count">---</span></p>
            <p>Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ÙƒÙ„Ù…Ø§Øª: <span id="categories-list">---</span></p>
        </div>
    </div>
    
    <h3><i class="fas fa-users"></i> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† (<span id="player-count">0</span>)</h3>
    <div class="players-list" id="players-list-container"></div>
    
    <button id="start-game-btn" onclick="startGame()" disabled style="display: none;">
        <i class="fas fa-play"></i> Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨
    </button>
</div>

<div class="card" id="role-display-card" style="display:none;">
    <h2>Ø¯ÙˆØ±Ùƒ ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø©</h2>
    <div id="role-card">
        <div id="role-title">---</div>
        <div id="role-word">---</div>
        <div id="role-instructions">---</div>
    </div>
    <button onclick="hideRoleCard()" style="margin-top: 20px; background-color: #6366f1;">
        <i class="fas fa-eye-slash"></i> Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙˆØ§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØºØ±ÙØ©
    </button>
</div>

<div id="profile-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="document.getElementById('profile-modal').style.display='none'">&times;</span>
        <h3 style="color:#34d399;"><i class="fas fa-id-badge"></i> Ù…Ù„Ù Ø§Ù„Ù„Ø§Ø¹Ø¨</h3>
        <div id="modal-profile-content"></div>
    </div>
</div>

<script>
let currentUID;
let roomCode;
let roomData = null;
let isHost = false;
let listenerUnsubscribe = null;
let allUsersData = {}; 
let isFetchingDetails = false;
let previousPlayers = []; // Ù„ØªØªØ¨Ø¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ø¬Ø¯Ø¯
const DEV_UID = 'IMP-VVVC-2JZ7'; // ğŸ¯ Ø§Ù„Ù€ UID Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ (Ø§Ù„Ø¥ØµÙ„Ø§Ø­ 5)

// Ø§Ù„Ø«ÙˆØ§Ø¨Øª
const IMPOSTOR_NO_WORD_TAG = 'IMPOSTOR_NO_WORD_TAG_BLANK'; 

// ğŸ¯ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒÙ„Ù…Ø§Øª ÙˆØ§Ù„Ø£Ù‚Ø³Ø§Ù… - (ÙƒÙ…Ø§ Ù‡ÙŠ)
const wordCategories = {
    free: [
        { id: 'objects', name: 'Ø£Ø´ÙŠØ§Ø¡ ÙˆØ£Ø¯ÙˆØ§Øª', words: ["Ù‚Ù„Ù…", "ÙƒÙˆØ¨", "ÙƒØ±Ø³ÙŠ", "Ù…ÙØªØ§Ø­", "Ù‡Ø§ØªÙ", "ÙƒØªØ§Ø¨", "Ø³Ø§Ø¹Ø©", "Ù…ØµØ¨Ø§Ø­", "Ù…Ù„Ø¹Ù‚Ø©", "Ø­Ø°Ø§Ø¡", "Ø­Ù‚ÙŠØ¨Ø©", "Ø·Ø§ÙˆÙ„Ø©", "Ù…Ø±Ø¢Ø©", "Ø¯ÙØªØ±", "Ù…Ù…Ø­Ø§Ø©", "Ø¬Ø¯Ø§Ø±", "Ø´Ø¨Ø§Ùƒ", "Ø¨Ø§Ø¨", "Ø³Ø±ÙŠØ±", "ÙˆØ³Ø§Ø¯Ø©", "ØºØ·Ø§Ø¡", "Ø¬Ø±Ø³", "Ù…Ø¸Ù„Ø©", "Ù„ÙˆØ­Ø©", "Ù…Ø±ÙˆØ­Ø©", "ØµÙ†Ø¯ÙˆÙ‚", "ÙØ±Ø´Ø§Ø©", "Ù…Ø´Ø·", "Ù…Ù…Ø­Ø§Ø©", "Ù…Ø·Ø±Ù‚Ø©", "Ù…Ø³Ù…Ø§Ø±", "Ø®ÙŠØ·", "Ø¥Ø¨Ø±Ø©", "Ø®Ø²Ø§Ù†Ø©", "Ø­Ø¨Ù„", "Ø´Ø±ÙŠØ·", "ÙƒØ§Ù…ÙŠØ±Ø§", "Ù…Ø§ÙˆØ³", "Ø¨Ø·Ø§Ø±ÙŠØ©", "Ù„Ù…Ø¨Ø©", "Ù…Ù‚Øµ", "Ù…Ù†Ø´ÙØ©", "ØµÙ†Ø¨ÙˆØ±", "Ù‚ÙÙ„", "Ø³Ù„Ø©", "Ø³Ù„Ùƒ", "Ø´Ø§Ø­Ù†", "Ø£Ø±ÙŠÙƒØ©", "Ø±Ù"] },
        { id: 'nature', name: 'Ø§Ù„Ø·Ø¨ÙŠØ¹Ø© ÙˆØ§Ù„Ø¨ÙŠØ¦Ø©', words: ["Ø´Ø¬Ø±Ø©", "Ù†Ù‡Ø±", "Ø¬Ø¨Ù„", "Ø³Ù…Ø§Ø¡", "Ø¨Ø­Ø±", "Ø´Ù…Ø³", "Ù‚Ù…Ø±", "Ù†Ø¬Ù…", "ØºÙŠÙ…Ø©", "Ù…Ø·Ø±", "Ø«Ù„Ø¬", "ØµØ®Ø±Ø©", "Ø±Ù…Ù„", "Ø¹Ø´Ø¨", "ÙˆØ±Ø¯Ø©", "Ù†Ø®Ù„Ø©", "Ø´Ø§Ø·Ø¦", "Ø¨Ø±ÙƒØ§Ù†", "ØµØ­Ø±Ø§Ø¡", "ÙˆØ§Ø¯ÙŠ", "ÙƒÙ‡Ù", "Ø¨Ø­ÙŠØ±Ø©", "Ø¶Ø¨Ø§Ø¨", "Ø±ÙŠØ§Ø­", "ØµÙ‚ÙŠØ¹", "ØªØ±Ø§Ø¨", "Ù†Ø¨ØªØ©", "Ø¨Ø°Ø±Ø©", "ÙØ¶Ø§Ø¡", "ÙƒÙˆÙƒØ¨", "Ø´Ù‡Ø§Ø¨", "Ø£ÙÙ‚", "Ø¬Ø³Ø±", "Ù…Ø²Ø±Ø¹Ø©", "Ø¹Ø§ØµÙØ©", "Ù†Ø³ÙŠÙ…", "Ø¸Ù„", "Ø¶ÙˆØ¡", "Ù…Ø­ÙŠØ·", "Ø¬Ø²ÙŠØ±Ø©", "Ø´Ù„Ø§Ù„", "Ù†Ø¨Ø¹", "Ø¬Ø°Ø¹", "ÙˆØ±Ù‚Ø©", "ØºØ§Ø¨Ø©", "Ø£Ø²Ù‡Ø§Ø±", "Ø³Ø­Ø§Ø¨Ø©", "Ø¨Ø¦Ø±"] },
        { id: 'jobs', name: 'Ù…Ù‡Ù† ÙˆÙˆØ¸Ø§Ø¦Ù', words: ["Ø·Ø¨ÙŠØ¨", "Ù…Ø¹Ù„Ù…", "Ù…Ù‡Ù†Ø¯Ø³", "Ø´Ø±Ø·ÙŠ", "Ø®Ø¨Ø§Ø²", "Ù…Ø²Ø§Ø±Ø¹", "Ù†Ø¬Ø§Ø±", "Ø·Ø¨Ø§Ø®", "Ø±Ø³Ø§Ù…", "Ù…Ø°ÙŠØ¹", "Ù‚Ø§Ø¶ÙŠ", "ÙƒØ§ØªØ¨", "Ø¬Ù†Ø¯ÙŠ", "Ø¨Ø­Ø§Ø±", "Ø·ÙŠØ§Ø±", "ØµÙŠØ¯Ù„ÙŠ", "Ù…Ù…Ø±Ø¶", "Ù…ØµÙˆØ±", "Ù…ÙˆØ³ÙŠÙ‚ÙŠ", "Ø®ÙŠØ§Ø·", "Ø³Ø§Ø¦Ù‚", "Ù…Ø­Ø§Ù…ÙŠ", "Ø¨Ø§Ø¦Ø¹", "Ù…ØªØ±Ø¬Ù…", "Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠ", "Ø¨Ù†Ø§Ø¡", "ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ", "Ø­Ø¯Ø§Ø¯", "Ø¬Ø²Ø§Ø±", "Ø´Ø§Ø¹Ø±", "ØµØ­ÙÙŠ", "Ù†Ø§Ù‚Ø¯", "Ø­Ø§Ø±Ø³", "Ø±ÙŠØ§Ø¶ÙŠ", "Ø¹Ø§Ù…Ù„", "Ø¥Ø·ÙØ§Ø¦ÙŠ", "Ù…Ø±Ø´Ø¯", "Ø®Ø§Ø¯Ù…", "Ù…Ø­Ø§Ø³Ø¨", "Ù…Ø¯Ø±Ø¨", "ÙÙ†Ø§Ù†", "ØµØ§Ù†Ø¹", "Ù…ÙˆØ²Ø¹", "Ù…ÙØªØ´", "Ø¹Ø§Ù„Ù…", "ÙÙ„ÙƒÙŠ", "Ù…Ø±Ø§Ø³Ù„"] }
    ],
    pro: [
        { id: 'foods', name: 'Ù…Ø£ÙƒÙˆÙ„Ø§Øª ÙˆÙ…Ø´Ø±ÙˆØ¨Ø§Øª', words: ["ØªÙØ§Ø­", "Ù…ÙˆØ²", "Ø¨Ø±ØªÙ‚Ø§Ù„", "Ù…Ø§Ø¡", "Ù‚Ù‡ÙˆØ©", "Ø´Ø§ÙŠ", "Ø®Ø¨Ø²", "Ø£Ø±Ø²", "Ù„Ø­Ù…", "Ø¯Ø¬Ø§Ø¬", "Ø³Ù…Ùƒ", "Ø¹ØµÙŠØ±", "Ø­Ù„ÙŠØ¨", "Ø¬Ø¨Ù†", "Ø¨ÙŠØ¶", "Ø³ÙƒØ±", "Ù…Ù„Ø­", "Ø²ÙŠØª", "Ø²Ø¨Ø¯Ø©", "Ø¹Ø³Ù„", "Ø¨Ø·Ø§Ø·Ø§", "Ø·Ù…Ø§Ø·Ù…", "Ø¨ØµÙ„", "Ø«ÙˆÙ…", "Ø®Ø³", "Ø¬Ø²Ø±", "ÙƒØ¹ÙƒØ©", "Ù…Ø«Ù„Ø¬Ø§Øª", "Ù…ÙƒØ±ÙˆÙ†Ø©", "Ø¨ÙŠØªØ²Ø§", "Ø³Ù„Ø·Ø©", "Ø­Ø³Ø§Ø¡", "ØªÙˆØ§Ø¨Ù„", "Ù…Ø´Ø±ÙˆØ¨", "Ø¹Ù†Ø¨", "Ù…Ø§Ù†Ø¬Ùˆ", "ÙÙ„ÙÙ„", "Ù„ÙŠÙ…ÙˆÙ†", "Ø¨Ø³ÙƒÙˆÙŠØª", "ÙÙˆÙ„", "Ø¹Ø¯Ø³", "ÙØ±Ø§ÙˆÙ„Ø©", "Ø²ÙŠØªÙˆÙ†", "Ù…Ø±Ø¨Ù‰", "Ø³ÙƒØ±", "Ø´ÙˆÙƒÙˆÙ„Ø§ØªØ©", "ÙØ·Ø±", "Ø¹Ù„ÙƒØ©"] },
        { id: 'animals', name: 'Ø­ÙŠÙˆØ§Ù†Ø§Øª ÙˆØ·ÙŠÙˆØ±', words: ["ÙƒÙ„Ø¨", "Ù‚Ø·Ø©", "Ø£Ø³Ø¯", "Ù†Ù…Ø±", "ÙÙŠÙ„", "Ø²Ø±Ø§ÙØ©", "Ù‚Ø±Ø¯", "Ø­ØµØ§Ù†", "Ø¬Ù…Ù„", "Ø¶ÙØ¯Ø¹", "Ø«Ø¹Ù„Ø¨", "Ø°Ø¦Ø¨", "Ø¯Ø¨", "Ø£Ø±Ù†Ø¨", "Ø³Ù†Ø¬Ø§Ø¨", "Ø·Ø§Ø¦Ø±", "Ø­Ù…Ø§Ù…Ø©", "ØµÙ‚Ø±", "Ø¨ÙˆÙ…Ø©", "Ù†Ø³Ø±", "Ø¨Ø·Ø©", "Ø¯ÙŠÙƒ", "Ø¯Ø¬Ø§Ø¬Ø©", "Ø¨Ù‚Ø±Ø©", "ØºØ²Ø§Ù„", "ØªÙ…Ø³Ø§Ø­", "Ø«Ø¹Ø¨Ø§Ù†", "Ø³Ù…ÙƒØ©", "Ù‚Ø±Ø´", "Ø¯ÙˆÙ„ÙÙŠÙ†", "Ø­ÙˆØª", "Ù†Ø­Ù„Ø©", "Ù†Ù…Ù„Ø©", "Ø¹Ù†ÙƒØ¨ÙˆØª", "ÙØ±Ø§Ø´Ø©", "ÙŠØ±Ø¨ÙˆØ¹", "Ø³Ù„Ø­ÙØ§Ø©", "Ø®Ø±ÙˆÙ", "Ù…Ø§Ø¹Ø²", "ÙØ£Ø±", "Ø¨Ø¨ØºØ§Ø¡", "ÙƒÙ†ØºØ±", "Ø¨Ø·Ø±ÙŠÙ‚", "Ø¶Ø¨Ø¹", "Ù†ÙˆØ±Ø³", "Ø¹Ù‚Ø§Ø¨", "Ø³Ø¹Ø¯Ø§Ù†"] },
        { id: 'clothes', name: 'Ù…Ù„Ø§Ø¨Ø³ ÙˆØ¥ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª', words: ["Ù‚Ù…ÙŠØµ", "Ø¨Ù†Ø·Ø§Ù„", "ÙØ³ØªØ§Ù†", "ØªÙ†ÙˆØ±Ø©", "Ù…Ø¹Ø·Ù", "Ø³ØªØ±Ø©", "Ø­Ø¬Ø§Ø¨", "ÙˆØ´Ø§Ø­", "Ù‚Ø¨Ø¹Ø©", "Ø¬ÙˆØ±Ø¨", "Ù‚ÙØ§Ø²", "Ø­Ø°Ø§Ø¡", "ØµÙ†Ø¯Ù„", "Ø­Ù‚ÙŠØ¨Ø©", "Ù†Ø¸Ø§Ø±Ø©", "Ø­Ø²Ø§Ù…", "Ø³Ø§Ø¹Ø© ÙŠØ¯", "Ø®Ø§ØªÙ…", "Ù‚Ù„Ø§Ø¯Ø©", "Ø³ÙˆØ§Ø±", "Ø¬ÙŠØ¨", "Ø²Ø±", "Ø³Ø­Ø§Ø¨", "Ù‚Ù…Ø§Ø´", "Ø­Ø±ÙŠØ±", "Ø¬Ù„Ø¯", "Ù‚Ø·Ù†", "ØµÙˆÙ", "Ø¹Ø¨Ø§Ø¡Ø©", "Ø¨ÙŠØ¬Ø§Ù…Ø©", "Ø±Ø¨Ø·Ø© Ø¹Ù†Ù‚", "Ù…Ø±ÙŠÙˆÙ„", "ÙƒØ¨Ùƒ", "ÙØ±Ùˆ", "Ø´Ø§Ù„", "ØµØ¯Ø±ÙŠØ©", "Ù…Ù†Ø´ÙØ©", "Ù…Ù†Ø§Ù…Ø©", "Ù‚Ø¨Ø¹Ø© Ø´Ù…Ø³", "Ù…Ø´Ø¯", "Ø²ÙŠ", "Ø¨Ø§Ø±ÙˆÙƒØ©", "Ø¨ÙˆØª", "Ø¬ÙˆØ§Ø±Ø¨", "Ù„Ø¨Ø§Ø³", "Ø±Ø¯Ø§Ø¡", "Ù…Ø¦Ø²Ø±", "Ø³Ø±ÙˆØ§Ù„"] },
        { id: 'places', name: 'Ø£Ù…Ø§ÙƒÙ† ÙˆÙ…Ø¹Ø§Ù„Ù…', words: ["Ù…Ø¯Ø±Ø³Ø©", "Ù…Ø³ØªØ´ÙÙ‰", "Ù…Ù†Ø²Ù„", "Ù…Ø³Ø¬Ø¯", "ÙƒÙ†ÙŠØ³Ø©", "Ø³ÙˆÙ‚", "Ù…ÙƒØªØ¨Ø©", "Ù…Ø·Ø§Ø±", "Ù…Ø­Ø·Ø©", "Ø­Ø¯ÙŠÙ‚Ø©", "Ù…ØªØ­Ù", "Ù…ØµÙ†Ø¹", "Ù…Ù‚Ù‡Ù‰", "Ù…Ø·Ø¹Ù…", "ÙÙ†Ø¯Ù‚", "Ù…Ø¨Ù†Ù‰", "Ø¬Ø³Ø±", "Ø·Ø±ÙŠÙ‚", "Ø´Ø§Ø±Ø¹", "Ø³Ø§Ø­Ø©", "Ù‚ØµØ±", "Ù‚Ù„Ø¹Ø©", "Ø¨Ø±Ø¬", "Ø¨ÙˆØ§Ø¨Ø©", "Ø¨Ø¦Ø±", "Ù…Ù„Ø¹Ø¨", "Ù†Ø§Ø¯ÙŠ", "Ø¬Ø§Ù…Ø¹Ø©", "ÙˆØ²Ø§Ø±Ø©", "Ø³ÙØ§Ø±Ø©", "ÙƒØ±Ø§Ø¬", "Ù†ÙÙ‚", "Ù…Ù…Ø±", "Ù‚Ø¨Ùˆ", "Ø³Ø·Ø­", "Ø´Ø±ÙØ©", "Ù…Ø®Ø²Ù†", "Ù…ÙˆÙ‚Ù", "ØºØ±ÙØ©", "Ù‚Ø§Ø¹Ø©", "Ø¨Ù‡Ùˆ", "Ù…Ø³ØªÙˆØ¯Ø¹", "Ù…Ø¬Ù„Ø³", "Ø®ÙŠÙ…Ø©", "Ù…Ø®Ø¨Ø²", "Ù…ØºØ³Ù„Ø©", "Ø¯ÙƒØ§Ù†"] },
        { id: 'activities', name: 'Ø£ÙØ¹Ø§Ù„ ÙˆÙ†Ø´Ø§Ø·Ø§Øª', words: ["Ø¬Ø±ÙŠ", "Ø³Ø¨Ø§Ø­Ø©", "Ù‚Ø±Ø§Ø¡Ø©", "ÙƒØªØ§Ø¨Ø©", "Ø±Ø³Ù…", "ØºÙ†Ø§Ø¡", "Ø±Ù‚Øµ", "Ù„Ø¹Ø¨", "Ù†ÙˆÙ…", "Ø£ÙƒÙ„", "Ø´Ø±Ø¨", "Ø¶Ø­Ùƒ", "Ø¨ÙƒØ§Ø¡", "ØµØ±Ø§Ø®", "Ù…Ø´Ø§Ù‡Ø¯Ø©", "Ø§Ø³ØªÙ…Ø§Ø¹", "Ø­Ø¯ÙŠØ«", "Ø³ÙØ±", "ØµÙŠØ¯", "Ø·Ø¨Ø®", "ØªÙ†Ø¸ÙŠÙ", "Ø¹Ù…Ù„", "Ø¯Ø±Ø§Ø³Ø©", "Ù‚ÙŠØ§Ø¯Ø©", "Ø¨Ù†Ø§Ø¡", "Ù‡Ø¯Ù…", "Ø²Ø±Ø¹", "Ø­ØµØ§Ø¯", "Ø¥ØµÙ„Ø§Ø­", "ÙƒØ³Ø±", "ÙØªØ­", "Ø¥ØºÙ„Ø§Ù‚", "Ù‚ÙØ²", "ØµØ¹ÙˆØ¯", "Ù‡Ø¨ÙˆØ·", "Ø§Ù†ØªØ¸Ø§Ø±", "ØªÙÙƒÙŠØ±", "Ø­Ù„Ù…", "Ø¨Ù‚Ø§Ø¡", "ØªØ£Ù…Ù„", "ØªØ¬ÙˆÙ„", "Ø§Ø³ØªØ±Ø§Ø­Ø©", "Ø§Ø¬ØªÙ…Ø§Ø¹", "Ø¥Ø´Ø§Ø±Ø©", "Ø¥Ø±Ø³Ø§Ù„", "Ø§Ø³ØªÙ‚Ø¨Ø§Ù„", "Ø³Ø¤Ø§Ù„"] },
        { id: 'adjectives', name: 'ØµÙØ§Øª ÙˆØ£Ø­ÙˆØ§Ù„', words: ["Ø³Ø±ÙŠØ¹", "Ø¨Ø·ÙŠØ¡", "ÙƒØ¨ÙŠØ±", "ØµØºÙŠØ±", "Ø·ÙˆÙŠÙ„", "Ù‚ØµÙŠØ±", "Ø¬Ù…ÙŠÙ„", "Ù‚Ø¨ÙŠØ­", "Ø³Ø¹ÙŠØ¯", "Ø­Ø²ÙŠÙ†", "ØºØ§Ø¶Ø¨", "Ù‡Ø§Ø¯Ø¦", "ØµØ§Ø®Ø¨", "Ù†Ø¸ÙŠÙ", "Ù…ØªØ³Ø®", "Ù‚ÙˆÙŠ", "Ø¶Ø¹ÙŠÙ", "Ø¨Ø§Ø±Ø¯", "Ø­Ø§Ø±", "Ù…Ø´Ø±Ù‚", "Ù…Ø¸Ù„Ù…", "Ø¬Ø¯ÙŠØ¯", "Ù‚Ø¯ÙŠÙ…", "ØµØ¹Ø¨", "Ø³Ù‡Ù„", "Ø®ÙÙŠÙ", "Ø«Ù‚ÙŠÙ„", "Ø¬Ø§Ø¦Ø¹", "Ø¹Ø·Ø´Ø§Ù†", "Ù…Ø±ÙŠØ¶", "Ø³Ù„ÙŠÙ…", "Ø¨Ø¹ÙŠØ¯", "Ù‚Ø±ÙŠØ¨", "Ø­Ù‚ÙŠÙ‚ÙŠ", "ÙˆÙ‡Ù…ÙŠ", "Ø´Ø¬Ø§Ø¹", "Ø¬Ø¨Ø§Ù†", "Ù…Ø¶Ø­Ùƒ", "Ø¬Ø¯ÙŠ", "Ù…Ø£Ù„ÙˆÙ", "ØºØ±ÙŠØ¨", "Ø­ÙƒÙŠÙ…", "Ø£Ø­Ù…Ù‚", "Ù†Ø§Ø¬Ø­", "ÙØ§Ø´Ù„"] }
    ]
};

function initLobby() {
    const urlParams = new URLSearchParams(window.location.search);
    roomCode = urlParams.get('id');

    if (!roomCode) {
        alert("âŒ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©.");
        window.location.href = "index.html";
        return;
    }
    
    document.getElementById('room-code-value').innerText = roomCode;
    document.getElementById('room-title').innerText = `ØºØ±ÙØ© ${roomCode}`;

    firebase.auth().onAuthStateChanged(user => {
        if (!user) { 
            window.location.href = "auth.html"; 
            return; 
        }
        currentUID = user.uid;
        startRoomListener(roomCode);
    });
}

function startRoomListener(code) {
    if (listenerUnsubscribe) { listenerUnsubscribe(); } 

    const roomRef = db.collection('rooms').doc(code);

    listenerUnsubscribe = roomRef.onSnapshot(async doc => {
        if (!doc.exists) {
            console.warn("Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.");
            return;
        }

        roomData = doc.data();
        isHost = (roomData.hostUID === currentUID);
        
        await fetchAllPlayerDetails(roomData.players || []);

        if (roomData.status === 'playing') {
            displayRoleCard();
            return;
        }

        updateLobbyUI();
        
        // ğŸ›‘ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«ØŒ Ù‚Ù… Ø¨ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        previousPlayers = roomData.players || [];
    }, error => {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØºØ±ÙØ©:", error);
    });
}

async function fetchAllPlayerDetails(playerUIDs) {
    if (isFetchingDetails || !playerUIDs || playerUIDs.length === 0) return;
    isFetchingDetails = true;
    
    const usersToFetch = playerUIDs.filter(uid => !allUsersData[uid] || !allUsersData[uid].displayName);

    if (usersToFetch.length === 0) {
        isFetchingDetails = false;
        return;
    }

    try {
        const promises = usersToFetch.map(uid => db.collection('users').doc(uid).get());
        const docs = await Promise.all(promises);
        
        docs.forEach(doc => {
            const uid = doc.id;
            if (doc.exists) {
                const data = doc.data();
                const playerName = data.displayName || data.username || data.name || `Ù„Ø§Ø¹Ø¨#${uid.substring(0, 4)}`;
                
                // ğŸ¯ Ø¥Ø¶Ø§ÙØ© Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø±Ùˆ Ù‡Ù†Ø§ (Ø§Ù„Ø¥ØµÙ„Ø§Ø­ 4)
                const isPro = data.proExpiryTime && data.proExpiryTime.seconds > (Date.now() / 1000);

                allUsersData[uid] = {
                    displayName: playerName, 
                    publicUid: data.publicUid || '---',
                    isPro: isPro,
                    level: data.level || 1, 
                    gamesPlayed: data.gamesPlayed || 0,
                    impostorWins: data.impostorWins || 0
                };
            } else {
                allUsersData[uid] = { 
                    displayName: `Ù…Ø¬Ù‡ÙˆÙ„#${uid.substring(0, 4)}`,
                    publicUid: '---',
                    isPro: false,
                    error: true
                };
            }
        });
        
        updateLobbyUI();

    } catch (error) {
        console.error("ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†:", error);
    } finally {
        isFetchingDetails = false;
    }
}

function updateLobbyUI() {
    if (!roomData) return;
    
    document.getElementById('waiting-lobby').style.display = 'block';
    document.getElementById('role-display-card').style.display = 'none';

    const playersContainer = document.getElementById('players-list-container');
    const startGameBtn = document.getElementById('start-game-btn');
    const players = roomData.players || [];
    const playerCount = players.length;

    document.getElementById('player-count').innerText = playerCount;
    
    // ğŸ¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ø§Ù„Ø¥ØµÙ„Ø§Ø­ 1)
    const settings = roomData.settings || {};
    const selectedCategoryIDs = settings.selectedCategories || [];
    const impostorsCount = settings.impostors || 1;
    
    document.getElementById('impostors-count').innerText = impostorsCount;
    
    // ØªØ­ÙˆÙŠÙ„ ID Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¥Ù„Ù‰ Ø£Ø³Ù…Ø§Ø¡ Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù‚Ø±Ø§Ø¡Ø©
    let categoryNames = [];
    const allCategories = [...wordCategories.free, ...wordCategories.pro];
    
    selectedCategoryIDs.forEach(id => {
        const category = allCategories.find(cat => cat.id === id);
        if (category) {
            categoryNames.push(category.name);
        }
    });
    
    document.getElementById('categories-list').innerText = categoryNames.join('ØŒ ') || 'Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ù‚Ø³Ù…!';


    // Ø²Ø± Ø§Ù„Ø¨Ø¯Ø¡
    if (isHost) {
        startGameBtn.style.display = 'block';
        if (playerCount >= 3) {
            startGameBtn.disabled = false;
            document.getElementById('status-message').innerText = 'Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¨Ø¯Ø¡!';
            document.getElementById('status-message').style.color = '#34d399';
        } else {
            startGameBtn.disabled = true;
            document.getElementById('status-message').innerText = `Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø¹Ø¯Ø¯ (Ø§Ù„Ø­Ø§Ù„ÙŠ: ${playerCount})`;
        }
    } else {
        startGameBtn.style.display = 'none';
        document.getElementById('status-message').innerText = `Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø¶ÙŠÙ... (Ø§Ù„Ø¹Ø¯Ø¯: ${playerCount})`;
    }

    // Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    playersContainer.innerHTML = '';
    
    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ø°ÙŠÙ† Ø§Ù†Ø¶Ù…ÙˆØ§ Ù„Ù„ØªÙˆ (Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ù†Ù…ÙŠØ´Ù†)
    const newJoins = players.filter(uid => !previousPlayers.includes(uid));

    players.forEach(uid => {
        const playerDetails = allUsersData[uid];
        const name = playerDetails ? playerDetails.displayName : `Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...`;
        
        const isPlayerHost = (uid === roomData.hostUID);
        const isProMember = playerDetails ? playerDetails.isPro : false;
        const isDev = (playerDetails && playerDetails.publicUid === DEV_UID); // ğŸ¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù€ UID Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ (Ø§Ù„Ø¥ØµÙ„Ø§Ø­ 5)
        
        const div = document.createElement('div');
        
        let classList = ['player-item'];
        if (isPlayerHost) classList.push('host');
        if (isProMember) classList.push('pro-member'); // Ù„Ù„Ø¥ØµÙ„Ø§Ø­ 4
        if (isDev) classList.push('super-host'); // Ù„Ù„Ø¥ØµÙ„Ø§Ø­ 5
        if (newJoins.includes(uid)) classList.push('new-join'); // Ø£Ù†Ù…ÙŠØ´Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„
        
        div.className = classList.join(' ');
        
        let actionsHTML = '';
        if (isHost && uid !== currentUID) {
            actionsHTML = `<button class="kick-btn" onclick="kickPlayer('${uid}', '${name}')"><i class="fas fa-user-times"></i></button>`;
        }

        const iconHTML = isDev ? '<i class="fas fa-bolt" style="color:#ff4f4f;"></i>' : 
                         isPlayerHost ? '<i class="fas fa-crown" style="color:#ffd700;"></i>' : 
                         isProMember ? '<i class="fas fa-star" style="color:#ffd700;"></i>' : '';
        
        div.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px;">
                <span class="player-name-link" onclick="openProfileModal('${uid}')">
                    ${iconHTML} ${name}
                </span>
            </div>
            <div>${actionsHTML}</div>
        `;
        playersContainer.appendChild(div);
    });
}

function getRandomWord(categories) {
    let allWords = [];
    const allCategories = [...wordCategories.free, ...wordCategories.pro];
    
    categories.forEach(id => {
        const category = allCategories.find(cat => cat.id === id);
        if (category) {
            allWords = allWords.concat(category.words);
        }
    });
    
    if (allWords.length === 0) return 'ÙƒÙ„Ù…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©'; // Ø§Ø­ØªÙŠØ§Ø·ÙŠ

    const randomIndex = Math.floor(Math.random() * allWords.length);
    return allWords[randomIndex];
}

async function startGame() {
    if (!isHost) return;
    
    const players = roomData.players;
    const impostorsCount = roomData.settings.impostors || 1;
    
    if (players.length < 3) {
         document.getElementById('status-message').innerText = 'ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ 3 Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø¨Ø¯Ø¡.';
         return;
    }

    // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙƒÙ„Ù…Ø©
    const word = getRandomWord(roomData.settings.selectedCategories);

    // Ø®Ù„Ø· Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø­ØªØ§Ù„ÙŠÙ† Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ø¯Ù„
    const shuffledPlayers = [...players].sort(() => Math.random() - 0.5);
    
    // ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±
    const roles = {};
    for (let i = 0; i < players.length; i++) {
        const playerUID = shuffledPlayers[i];
        
        if (i < impostorsCount) {
            // ğŸ¯ Ø§Ù„Ù…Ø­ØªØ§Ù„ Ø¨Ø¯ÙˆÙ† ÙƒÙ„Ù…Ø© (Ø§Ù„Ø¥ØµÙ„Ø§Ø­ 2)
            roles[playerUID] = { role: 'impostor', word: IMPOSTOR_NO_WORD_TAG };
        } else {
            roles[playerUID] = { role: 'civilian', word: word };
        }
    }

    const roomRef = db.collection('rooms').doc(roomCode);
    
    await roomRef.update({
        status: 'playing',
        currentGameData: { 
            roles: roles,
            actualWord: word
        }
    });
}

function displayRoleCard() {
    // ğŸ¯ Ø¹Ø±Ø¶ Ø§Ù„Ø¯ÙˆØ± ÙˆØ§Ù„ÙƒÙ„Ù…Ø© (Ø§Ù„Ø¥ØµÙ„Ø§Ø­ 2)
    document.getElementById('waiting-lobby').style.display = 'none';
    document.getElementById('role-display-card').style.display = 'block';
    
    const role = roomData.currentGameData.roles[currentUID];
    
    const roleTitleEl = document.getElementById('role-title');
    const roleWordEl = document.getElementById('role-word');
    const roleInstructionsEl = document.getElementById('role-instructions');
    const roleCardEl = document.getElementById('role-card');

    if (role.role === 'impostor') {
        roleTitleEl.innerText = 'Ø£Ù†Øª Ø§Ù„Ù…Ø­ØªØ§Ù„ ğŸ˜ˆ';
        roleTitleEl.style.color = '#ff4f4f';
        roleCardEl.style.borderColor = '#ff4f4f';
        roleWordEl.innerText = 'Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙ„Ù…Ø© Ù„Ùƒ!';
        roleWordEl.style.color = '#ff4f4f';
        roleInstructionsEl.innerText = 'Ù…Ù‡Ù…ØªÙƒ: Ø­Ø§ÙˆÙ„ Ù…Ø¹Ø±ÙØ© Ø§Ù„ÙƒÙ„Ù…Ø© ÙˆØªØ¸Ø§Ù‡Ø± Ø£Ù†Ùƒ Ù…Ø¯Ù†ÙŠ Ù„ØªØªØ¬Ù†Ø¨ ÙƒØ´ÙÙƒ. Ù„Ø§ ØªØ³ØªØ®Ø¯Ù… ÙƒÙ„Ù…Ø© "Ù„Ø§" Ø£Ùˆ "ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©"';
    } else {
        roleTitleEl.innerText = 'Ø£Ù†Øª Ù…Ø¯Ù†ÙŠ ğŸ˜‡';
        roleTitleEl.style.color = '#34d399';
        roleCardEl.style.borderColor = '#34d399';
        roleWordEl.innerText = `Ø§Ù„ÙƒÙ„Ù…Ø©: ${role.word}`;
        roleWordEl.style.color = '#f1f5f9';
        roleInstructionsEl.innerText = 'Ù…Ù‡Ù…ØªÙƒ: Ø­Ø§ÙˆÙ„ Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ù…Ø­ØªØ§Ù„ Ù…Ù† Ø®Ù„Ø§Ù„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø°ÙƒÙŠØ© Ø­ÙˆÙ„ Ø§Ù„ÙƒÙ„Ù…Ø©.';
    }
}

function openProfileModal(playerUID) {
    const playerDetails = allUsersData[playerUID];
    const modalContent = document.getElementById('modal-profile-content');
    
    if (!playerDetails) { return; }
    
    // ğŸ¯ ØªÙ…ÙŠÙŠØ² Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø±Ùˆ ÙÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
    const proStatus = playerDetails.isPro ? 
        '<p style="color:#ffd700;"><i class="fas fa-star"></i> Ø¹Ø¶ÙˆÙŠØ© Ø¨Ø±Ùˆ</p>' : 
        '<p style="color:#94a3b8;"><i class="fas fa-times-circle"></i> Ù„ÙŠØ³ Ø¹Ø¶Ùˆ Ø¨Ø±Ùˆ</p>';

    modalContent.innerHTML = `
        <h4 style="color:#f1f5f9;">${playerDetails.displayName}</h4>
        ${proStatus}
        <p>Ø§Ù„Ù…Ø¹Ø±Ù‘Ù: ${playerDetails.publicUid}</p>
        <p>Ø§Ù„Ù…Ø³ØªÙˆÙ‰: ${playerDetails.level}</p>
        <p>Ø£Ù„Ø¹Ø§Ø¨ ØªÙ… Ù„Ø¹Ø¨Ù‡Ø§: ${playerDetails.gamesPlayed}</p>
        <button class="gift-btn" onclick="alert('Ù‚Ø±ÙŠØ¨Ø§Ù‹!')">Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø¯ÙŠØ©</button>
    `;
    document.getElementById('profile-modal').style.display = 'block';
}

// Ø¨Ù‚ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
function copyCode() {
    const code = document.getElementById('room-code-value').innerText;
    navigator.clipboard.writeText(code);
}
function leaveRoom(e) {
    e.preventDefault();
    if(listenerUnsubscribe) listenerUnsubscribe();
    // ğŸš¨ ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ arrayRemove Ù„Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØºØ±ÙØ© Ù‡Ù†Ø§
    window.location.href = "index.html";
}
function hideRoleCard() {
    // ğŸ¯ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙˆØªÙØ¹ÙŠÙ„ Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù‡Ù†Ø§ (Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ø´Ø§Ø´Ø© Ù„Ø¹Ø¨)
    document.getElementById('role-display-card').style.display = 'none';
    // Ù…Ø¤Ù‚ØªØ§Ù‹ØŒ Ù†Ø¹ÙˆØ¯ Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ù„ÙˆØ¨ÙŠ
    document.getElementById('waiting-lobby').style.display = 'block'; 
}
async function kickPlayer(uid, name) {
    if(!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø·Ø±Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ ${name} Ù…Ù† Ø§Ù„ØºØ±ÙØ©ØŸ`)) return;
    await db.collection('rooms').doc(roomCode).update({
        players: firebase.firestore.FieldValue.arrayRemove(uid)
    });
}
</script>
</body>
</html>

