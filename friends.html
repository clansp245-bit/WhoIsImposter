<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§</title>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="auth.js"></script> 

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
body { font-family: 'Cairo', sans-serif; background:#0f172a; color:#f1f5f9; padding:20px; min-height:100vh; text-align:center; }
h2 { color:#34d399; margin-bottom:20px; font-size:2rem; }
.card { background:#1e293b; border-radius:12px; padding:20px; max-width:500px; margin:15px auto; text-align:right; }
input, select { width:100%; padding:10px; border-radius:8px; border:none; margin-bottom:10px; background:#334155; color:white; }
button { padding:10px; width:100%; border:none; border-radius:8px; font-weight:700; cursor:pointer; margin-top:10px; }
.send-btn { background:#34d399; color:white; }
.send-btn:hover { background:#10b981; }
.gift-card { display:flex; justify-content:space-between; align-items:center; padding:12px 15px; margin-bottom:10px; border-radius:8px; border:1px solid #334155; cursor:pointer; transition:all 0.2s; }
.gift-card.selected { background-color:#6366f1; border-color:#4f46e5; box-shadow:0 0 10px rgba(99,102,241,0.5); }
.gift-name { font-weight:700; }
.gift-cost { font-size:0.85rem; color:#94a3b8; }
.alert { color:#ffcc00; font-size:0.9rem; margin-top:10px; }
</style>
</head>

<body onload="initGiftPage()">

<h2>ğŸ Ø£Ø±Ø³Ù„ Ù‡Ø¯Ø§ÙŠØ§ Ù„Ù„Ø§Ø¹Ø¨</h2>

<div class="card">
    <label>Ø§Ø¨Ø­Ø« Ø¹Ù† Ù„Ø§Ø¹Ø¨:</label>
    <input type="text" id="player-search" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶">
    <div id="search-results"><p class="alert">Ø£Ø¯Ø®Ù„ 3 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø¨Ø­Ø«</p></div>
</div>

<div class="card">
    <h3>Ø§Ø®ØªØ± Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§:</h3>
    <div id="gifts-container"></div>
    <button class="send-btn" id="send-gift-btn" disabled>Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</button>
    <p class="alert" id="gift-alert"></p>
</div>

<div class="card">
    <h3>Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ:</h3>
    <p>Coins: <span id="user-coins">0</span> | XP: <span id="user-xp">0</span> | Ø§Ù„Ù…Ø³ØªÙˆÙ‰: <span id="user-level">1</span></p>
</div>

<script>
let currentUserData = {};
let selectedPlayerId = null;
let selectedGifts = [];

// -------------------- Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ --------------------
const gifts = [
    {name:"ÙˆØ±Ø¯Ø©", cost:50, xp:10, type:"Ø¹Ø§Ø¯ÙŠ"},
    {name:"Ù‚Ù„Ù… Ø°Ù‡Ø¨ÙŠ", cost:200, xp:50, type:"ØºØ§Ù„ÙŠ"},
    {name:"Ø³ÙŠØ§Ø±Ø© Ø³Ø¨Ø§Ù‚", cost:1500, xp:450, type:"Ø£Ø³Ø·ÙˆØ±ÙŠ"},
    {name:"Ø·Ø§Ø¦Ø±Ø© Ø®Ø§ØµØ©", cost:5000, xp:1200, type:"Ø£Ø³Ø·ÙˆØ±ÙŠ"},
    {name:"ÙŠØ®Øª ÙØ§Ø®Ø±", cost:3000, xp:800, type:"ØºØ§Ù„ÙŠ"},
    {name:"Ù…Ø¬ÙˆÙ‡Ø±Ø§Øª", cost:8000, xp:2000, type:"Ø£Ø³Ø·ÙˆØ±ÙŠ"},
    {name:"ÙƒØªØ§Ø¨ Ø³Ø­Ø±ÙŠ", cost:100, xp:20, type:"Ø¹Ø§Ø¯ÙŠ"},
    {name:"ØªØ§Ø¬ Ù…Ù„ÙƒÙŠ", cost:10000, xp:2500, type:"Ø£Ø³Ø·ÙˆØ±ÙŠ"}
];

function populateGifts() {
    const container = document.getElementById("gifts-container");
    gifts.forEach((g, i) => {
        const div = document.createElement("div");
        div.className = "gift-card";
        div.setAttribute("data-index", i);
        div.onclick = () => toggleGift(i);
        div.innerHTML = `<div class="gift-name">${g.name}</div><div class="gift-cost">${g.cost} Coins | ${g.type}</div>`;
        container.appendChild(div);
    });
}

function toggleGift(index) {
    const div = document.querySelector(`.gift-card[data-index='${index}']`);
    if (selectedGifts.includes(index)) {
        selectedGifts = selectedGifts.filter(i => i!==index);
        div.classList.remove("selected");
    } else {
        selectedGifts.push(index);
        div.classList.add("selected");
    }
    document.getElementById("send-gift-btn").disabled = selectedGifts.length === 0 || !selectedPlayerId;
}

// -------------------- INIT --------------------
async function initGiftPage() {
    populateGifts();
    firebase.auth().onAuthStateChanged(async user => {
        if(!user) return window.location.href="auth.html";
        const data = await loadUserData(); // Ù…Ù† auth.js
        if(data) currentUserData = data;
        updateUserDisplay();
        setupSearch();
    });
}

function updateUserDisplay() {
    document.getElementById("user-coins").innerText = currentUserData.totalCoins || 0;
    document.getElementById("user-xp").innerText = currentUserData.xp || 0;
    document.getElementById("user-level").innerText = currentUserData.level || 1;
}

// -------------------- SEARCH --------------------
function setupSearch() {
    const input = document.getElementById("player-search");
    input.addEventListener("input", async () => {
        const q = input.value.trim();
        const resultsDiv = document.getElementById("search-results");
        resultsDiv.innerHTML = '<p class="alert">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</p>';
        if (q.length < 3) { resultsDiv.innerHTML = '<p class="alert">Ø£Ø¯Ø®Ù„ 3 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø¨Ø­Ø«</p>'; return; }
        const res = await searchUsersByDisplayName(q); // Ù…Ù† auth.js
        resultsDiv.innerHTML = "";
        if(!res.length) { resultsDiv.innerHTML = "<p class='alert'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p>"; return; }
        res.forEach(u=>{
            const div = document.createElement("div");
            div.className = "gift-card";
            div.innerHTML = `<div class="gift-name">${u.displayName}</div>`;
            div.onclick = () => { selectedPlayerId = u.uid; document.getElementById("send-gift-btn").disabled = selectedGifts.length === 0; document.getElementById("gift-alert").innerText="ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨!"; };
            resultsDiv.appendChild(div);
        });
    });
}

// -------------------- SEND GIFTS --------------------
document.getElementById("send-gift-btn").addEventListener("click", async () => {
    if(!selectedPlayerId || selectedGifts.length===0) return;
    let totalCost = selectedGifts.reduce((sum,i)=>sum+gifts[i].cost,0);
    if((currentUserData.totalCoins||0)<totalCost){document.getElementById("gift-alert").innerText="Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø±ØµÙŠØ¯ ÙƒØ§ÙÙŠ!"; return;}

    try {
        const user = firebase.auth().currentUser;
        const senderRef = firebase.firestore().collection("users").doc(user.uid);
        const recipientRef = firebase.firestore().collection("users").doc(selectedPlayerId);

        await firebase.firestore().runTransaction(async tx=>{
            const senderDoc = await tx.get(senderRef);
            const recipientDoc = await tx.get(recipientRef);
            if(!senderDoc.exists || !recipientDoc.exists) throw "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø±Ø³Ù„ Ø£Ùˆ Ø§Ù„Ù…Ø³ØªÙ„Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯";

            const senderCoins = senderDoc.data().totalCoins || 0;
            if(senderCoins<totalCost) throw "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±ØµÙŠØ¯ ÙƒØ§ÙÙŠ";

            const recipientXP = recipientDoc.data().xp || 0;
            const totalXP = selectedGifts.reduce((sum,i)=>sum+gifts[i].xp,0);

            tx.update(senderRef,{totalCoins: senderCoins-totalCost});
            tx.update(recipientRef,{xp: recipientXP+totalXP});
        });

        currentUserData.totalCoins -= totalCost;
        updateUserDisplay();
        document.getElementById("gift-alert").innerText=`ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ${selectedGifts.length} Ù‡Ø¯ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­! (+${selectedGifts.reduce((sum,i)=>sum+gifts[i].xp,0)} XP Ù„Ù„Ù…Ø³ØªÙ„Ù…)`;
        selectedGifts=[]; document.querySelectorAll(".gift-card.selected").forEach(c=>c.classList.remove("selected"));
        document.getElementById("send-gift-btn").disabled = true;
    } catch(e){
        console.error(e);
        document.getElementById("gift-alert").innerText="Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§.";
    }
});
</script>
</body>
</html>
