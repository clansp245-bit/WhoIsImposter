<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‘¥ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹ ÙˆØ§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="auth.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        :root { --bg-dark: #0f172a; --card-bg: #1e293b; --accent: #6366f1; --success: #22c55e; --danger: #ef4444; }
        body { font-family: 'Cairo', sans-serif; background-color: var(--bg-dark); color: #f1f5f9; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 500px; }
        .section-card { background: var(--card-bg); border-radius: 16px; padding: 20px; margin-bottom: 20px; }
        .search-box { display: flex; gap: 10px; margin-bottom: 15px; }
        input { flex: 1; background: #0f172a; border: 1px solid #334155; padding: 12px; border-radius: 8px; color: white; }
        .profile-result { background: #334155; border-radius: 12px; padding: 15px; display: flex; align-items: center; gap: 15px; border-left: 4px solid var(--accent); }
        .avatar { width: 50px; height: 50px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .list-item { display: flex; align-items: center; justify-content: space-between; background: #0f172a; padding: 12px; border-radius: 10px; margin-bottom: 8px; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-left: 8px; }
        .online { background: var(--success); box-shadow: 0 0 5px var(--success); }
        .offline { background: #64748b; }
        .btn { border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; color: white; font-family: 'Cairo'; }
        .btn-add { background: var(--accent); }
        .empty-text { color: #64748b; font-size: 0.9rem; text-align: center; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align: right; color: var(--accent);">ğŸ‘¥ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹</h2>

    <div class="section-card">
        <h3>ğŸ” Ø§Ù„Ø¨Ø­Ø«</h3>
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Ø£Ø¯Ø®Ù„ ID Ø§Ù„Ù„Ø§Ø¹Ø¨">
            <button class="btn btn-add" onclick="handleSearch()">Ø¨Ø­Ø«</button>
        </div>
        <div id="searchProfile"></div>
    </div>

    <div class="section-card">
        <h3>ğŸ“© Ø§Ù„Ø·Ù„Ø¨Ø§Øª <span id="reqBadge" style="background:var(--danger); display:none; padding:2px 7px; border-radius:50%; font-size:12px;">0</span></h3>
        <div id="requestsList"></div>
    </div>

    <div class="section-card">
        <h3>ğŸ® Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</h3>
        <div id="friendsList"></div>
    </div>
</div>

<script>
    // Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø«
    async function handleSearch() {
        const val = document.getElementById('searchInput').value;
        const resDiv = document.getElementById('searchProfile');
        resDiv.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...";

        try {
            const user = await searchUsersByPublicId(val);
            if (user) {
                if (user.uid === auth.currentUser.uid) {
                    resDiv.innerHTML = "Ù‡Ø°Ø§ Ø­Ø³Ø§Ø¨Ùƒ Ø§Ù„Ø´Ø®ØµÙŠ";
                    return;
                }
                resDiv.innerHTML = `
                    <div class="profile-result">
                        <div class="avatar">${user.displayName[0]}</div>
                        <div style="flex:1">
                            <div>${user.displayName} ${getBadgesHTML(user)}</div>
                            <small style="color:#94a3b8">${user.publicUid}</small>
                        </div>
                        <button class="btn btn-add" onclick="executeSend('${user.uid}')">Ø¥Ø¶Ø§ÙØ©</button>
                    </div>`;
            } else {
                resDiv.innerHTML = "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù„Ø§Ø¹Ø¨";
            }
        } catch(e) { resDiv.innerHTML = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«"; }
    }

    // Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (ØªÙ… ØªØºÙŠÙŠØ± Ø§Ø³Ù…Ù‡Ø§ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªØ¹Ø§Ø±Ø¶)
    async function executeSend(id) {
        try {
            await sendFriendRequest(id);
            alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨!");
        } catch(e) { alert(e.message); }
    }

    // Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
    function startListeners() {
        const myId = auth.currentUser.uid;

        // Ø§Ù„Ø·Ù„Ø¨Ø§Øª
        db.collection("friendRequests").where("receiverId", "==", myId).where("status", "==", "pending")
        .onSnapshot(async snap => {
            const list = document.getElementById('requestsList');
            document.getElementById('reqBadge').innerText = snap.size;
            document.getElementById('reqBadge').style.display = snap.empty ? 'none' : 'inline';
            
            list.innerHTML = snap.empty ? '<p class="empty-text">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</p>' : '';
            for (const doc of snap.docs) {
                const data = doc.data();
                const u = await db.collection("users").doc(data.senderId).get();
                const userData = u.data();
                list.innerHTML += `
                    <div class="list-item">
                        <div>${userData.displayName} ${getBadgesHTML(userData)}</div>
                        <button class="btn" style="background:var(--success)" onclick="acceptFriendRequest('${doc.id}', '${data.senderId}')">âœ”</button>
                    </div>`;
            }
        });

        // Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡
        db.collection("users").doc(myId).onSnapshot(async doc => {
            const list = document.getElementById('friendsList');
            const friends = doc.data().players || [];
            list.innerHTML = friends.length === 0 ? '<p class="empty-text">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ØµØ¯Ù‚Ø§Ø¡</p>' : '';
            
            for (const fId of friends) {
                const fDoc = await db.collection("users").doc(fId).get();
                const fData = fDoc.data();
                list.innerHTML += `
                    <div class="list-item">
                        <div><span class="status-dot ${fData.isOnline ? 'online' : 'offline'}"></span> ${fData.displayName} ${getBadgesHTML(fData)}</div>
                        <small>${fData.isOnline ? 'Ù†Ø´Ø·' : 'Ø£ÙˆÙÙ„Ø§ÙŠÙ†'}</small>
                    </div>`;
            }
        });
    }

    auth.onAuthStateChanged(user => { if(user) startListeners(); else window.location.href="auth.html"; });
</script>
</body>
</html>

