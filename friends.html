<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ğŸ¤ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ ÙˆØ·Ù„Ø¨Ø§Øª Ø§Ù„ØµØ¯Ø§Ù‚Ø©</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="auth.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background:#0f172a;
            color:#f1f5f9;
            padding:20px;
        }
        h2 { color:#34d399; text-align:center; }
        .container { max-width:600px; margin:auto; }
        .card {
            background:#1e293b;
            padding:20px;
            border-radius:12px;
            margin-bottom:20px;
            text-align:right;
        }
        input {
            width: calc(100% - 90px);
            padding:10px;
            border-radius:8px;
            border:none;
            background:#334155;
            color:white;
        }
        button {
            padding:10px;
            border:none;
            border-radius:8px;
            font-weight:700;
            cursor:pointer;
        }
        .search-btn { background:#6366f1; color:white; width:80px; }
        .user-item {
            display:flex;
            justify-content:space-between;
            align-items:center;
            padding:10px 0;
            border-bottom:1px solid #334155;
        }
        .action-btn {
            padding:5px 10px;
            border-radius:6px;
            font-weight:700;
            margin-right:5px;
        }
        .send { background:#34d399; color:white; }
        .accept { background:#6366f1; color:white; }
        .reject, .remove { background:#ef4444; color:white; }
        .loading { color:#94a3b8; padding:10px; }
    </style>
</head>

<body>

<h2>ğŸ¤ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ ÙˆØ·Ù„Ø¨Ø§Øª Ø§Ù„ØµØ¯Ø§Ù‚Ø©</h2>

<div class="container">

    <!-- Ø§Ù„Ø¨Ø­Ø« -->
    <div class="card">
        <h3>Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù„Ø§Ø¹Ø¨</h3>
        <div style="display:flex; gap:10px;">
            <input id="search-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶">
            <button class="search-btn" onclick="handleSearch()">Ø¨Ø­Ø«</button>
        </div>
        <div id="search-results"></div>
    </div>

    <!-- Ø§Ù„Ø·Ù„Ø¨Ø§Øª -->
    <div class="card">
        <h3>Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµØ¯Ø§Ù‚Ø© <span id="incoming-count">(0)</span></h3>
        <div id="incoming-requests">
            <p class="loading" id="requests-loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
        </div>
    </div>

    <!-- Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ -->
    <div class="card">
        <h3>Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ <span id="friends-count">(0)</span></h3>
        <div id="friends-list">
            <p class="loading" id="friends-loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
        </div>
    </div>

</div>

<script>
const db = firebase.firestore();
let currentUserId = null;
let friends = [];
let requests = [];

firebase.auth().onAuthStateChanged(user => {
    if (!user) return location.href = "auth.html";
    currentUserId = user.uid;
    listenUser();
    listenRequests();
});

// ---------------- USER DATA ----------------
function listenUser() {
    db.collection("users").doc(currentUserId).onSnapshot(doc => {
        friends = doc.data()?.players || [];
        renderFriends();
    });
}

// ---------------- REQUESTS ----------------
function listenRequests() {
    db.collection("friendRequests")
        .where("receiverId","==",currentUserId)
        .where("status","==","pending")
        .onSnapshot(async snap => {
            document.getElementById("requests-loading").style.display="none";
            requests = [];

            const ids = snap.docs.map(d=>d.data().senderId);
            const names = await getNames(ids);

            snap.forEach(doc=>{
                requests.push({
                    id:doc.id,
                    senderId:doc.data().senderId,
                    name:names[doc.data().senderId] || "Ù…Ø³ØªØ®Ø¯Ù…"
                });
            });

            renderRequests();
        });
}

// ---------------- HELPERS ----------------
async function getNames(ids){
    if(!ids.length) return {};
    const map={};
    const chunks=[];
    while(ids.length) chunks.push(ids.splice(0,10));
    for(const c of chunks){
        const s=await db.collection("users")
            .where(firebase.firestore.FieldPath.documentId(),"in",c).get();
        s.forEach(d=>map[d.id]=d.data().displayName);
    }
    return map;
}

// ---------------- RENDER ----------------
function renderRequests(){
    const el=document.getElementById("incoming-requests");
    el.innerHTML="";
    document.getElementById("incoming-count").innerText=`(${requests.length})`;

    if(!requests.length){
        el.innerHTML="<p class='loading'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</p>";
        return;
    }

    requests.forEach(r=>{
        el.innerHTML+=`
        <div class="user-item">
            <span>${r.name}</span>
            <div>
                <button class="action-btn accept" onclick="accept('${r.id}','${r.senderId}')">Ù‚Ø¨ÙˆÙ„</button>
                <button class="action-btn reject" onclick="reject('${r.id}')">Ø±ÙØ¶</button>
            </div>
        </div>`;
    });
}

async function renderFriends(){
    const el=document.getElementById("friends-list");
    document.getElementById("friends-loading").style.display="none";
    document.getElementById("friends-count").innerText=`(${friends.length})`;
    el.innerHTML="";

    if(!friends.length){
        el.innerHTML="<p class='loading'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ØµØ¯Ù‚Ø§Ø¡</p>";
        return;
    }

    const names=await getNames([...friends]);
    friends.forEach(id=>{
        el.innerHTML+=`
        <div class="user-item">
            <span>${names[id]}</span>
            <button class="action-btn remove" onclick="removeFriend('${id}')">Ø­Ø°Ù</button>
        </div>`;
    });
}

// ---------------- SEARCH ----------------
async function handleSearch(){
    const q=document.getElementById("search-input").value.trim();
    const el=document.getElementById("search-results");
    el.innerHTML="<p class='loading'>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</p>";

    if(q.length<3){
        el.innerHTML="<p class='loading'>Ø£Ø¯Ø®Ù„ 3 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„</p>";
        return;
    }

    const res=await searchUsersByDisplayName(q);
    el.innerHTML="";

    if(!res.length){
        el.innerHTML="<p class='loading'>Ù„Ø§ Ù†ØªØ§Ø¦Ø¬</p>";
        return;
    }

    res.forEach(u=>{
        el.innerHTML+=`
        <div class="user-item">
            <span>${u.displayName}</span>
            <button class="action-btn send" onclick="send('${u.uid}')">Ø¥Ø¶Ø§ÙØ©</button>
        </div>`;
    });
}

// ---------------- ACTIONS ----------------
async function send(id){
    if(await sendFriendRequest(id)) alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨");
}
async function accept(id,uid){
    if(await acceptFriendRequest(id,uid)) alert("ØªÙ… Ø§Ù„Ù‚Ø¨ÙˆÙ„");
}
async function reject(id){
    if(await rejectFriendRequest(id)) alert("ØªÙ… Ø§Ù„Ø±ÙØ¶");
}
</script>

</body>
</html>
