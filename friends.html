<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ - Ø¨Ø­Ø« Ø§Ù„Ù„Ø§Ø¹Ø¨</title>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="auth.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
body {
    font-family: 'Cairo', sans-serif;
    background-color: #0f172a;
    color: #f1f5f9;
    text-align: center;
    padding: 20px;
}
h2 { color: #34d399; margin-bottom: 20px; }
#player-input, #send-btn { margin: 10px 0; padding: 10px; border-radius: 8px; border: none; font-size: 16px; width: 250px; }
#send-btn { background-color: #6366f1; color: #fff; cursor: pointer; }
#send-btn:hover { background-color: #4f46e5; }

#suggestions {
    background-color: #1e293b;
    border-radius: 8px;
    margin-top: 5px;
    width: 250px;
    max-height: 150px;
    overflow-y: auto;
    text-align: right;
    padding: 0;
}
.suggestion-item {
    padding: 8px 12px;
    cursor: pointer;
    border-bottom: 1px solid #334155;
}
.suggestion-item:hover {
    background-color: #334155;
}
.gift-card {
    display: inline-block;
    background-color: #1e293b;
    border-radius: 10px;
    padding: 15px;
    margin: 10px;
    width: 120px;
    cursor: pointer;
    border: 2px solid transparent;
    transition: 0.3s;
}
.gift-card.selected { border-color: #34d399; box-shadow: 0 0 10px #34d399; }
.gift-card .gift-name { font-weight: 700; margin-bottom: 5px; }
.gift-card .gift-info { font-size: 0.85rem; color: #94a3b8; }
</style>
</head>
<body onload="initGifts()">

<h2>ğŸ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</h2>

<input type="text" id="player-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù„Ø§Ø¹Ø¨..." autocomplete="off">
<div id="suggestions"></div>

<div id="gifts-container"></div>

<button id="send-btn" onclick="sendSelectedGifts()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§</button>

<script>
let currentUserData = {};
let selectedPlayerId = null;
let gifts = [];
let selectedGifts = [];

// ------------------- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ -------------------
function getGiftList() {
    return [
        { name: 'ÙˆØ±Ø¯Ø©', price: 10, xp: 5, rarity: 'Ø¹Ø§Ø¯ÙŠ' },
        { name: 'Ø´ÙˆÙƒÙˆÙ„Ø§ØªØ©', price: 15, xp: 8, rarity: 'Ø¹Ø§Ø¯ÙŠ' },
        { name: 'ÙƒØªØ§Ø¨', price: 20, xp: 10, rarity: 'Ø¹Ø§Ø¯ÙŠ' },
        { name: 'ÙƒÙˆØ¨', price: 10, xp: 4, rarity: 'Ø¹Ø§Ø¯ÙŠ' },
        { name: 'Ù‚Ø¨Ø¹Ø©', price: 12, xp: 5, rarity: 'Ø¹Ø§Ø¯ÙŠ' },
        { name: 'Ø³ÙŠØ§Ø±Ø©', price: 200, xp: 50, rarity: 'ØºØ§Ù„ÙŠ' },
        { name: 'Ø³Ù…Ø§Ø¹Ø© Ø¨Ù„ÙˆØªÙˆØ«', price: 150, xp: 35, rarity: 'ØºØ§Ù„ÙŠ' },
        { name: 'Ù‡Ø§ØªÙ', price: 180, xp: 45, rarity: 'ØºØ§Ù„ÙŠ' },
        { name: 'Ø³Ø§Ø¹Ø© Ø°ÙƒÙŠØ©', price: 160, xp: 40, rarity: 'ØºØ§Ù„ÙŠ' },
        { name: 'Ø¯Ø±Ø§Ø¬Ø© Ù†Ø§Ø±ÙŠØ©', price: 220, xp: 55, rarity: 'ØºØ§Ù„ÙŠ' },
        { name: 'Ø·Ø§Ø¦Ø±Ø© Ø®Ø§ØµØ©', price: 1000, xp: 200, rarity: 'Ø£Ø³Ø·ÙˆØ±ÙŠ' },
        { name: 'ÙŠØ®Øª ÙØ§Ø®Ø±', price: 1200, xp: 250, rarity: 'Ø£Ø³Ø·ÙˆØ±ÙŠ' },
        { name: 'Ø¬Ø²ÙŠØ±Ø© Ø®Ø§ØµØ©', price: 5000, xp: 800, rarity: 'Ø£Ø³Ø·ÙˆØ±ÙŠ' },
        { name: 'Ø³Ø§Ø¹Ø© Ø±ÙˆÙ„ÙƒØ³ Ø°Ù‡Ø¨ÙŠØ©', price: 900, xp: 180, rarity: 'Ø£Ø³Ø·ÙˆØ±ÙŠ' },
        { name: 'Ø³ÙŠØ§Ø±Ø© Ø±ÙŠØ§Ø¶ÙŠØ© Ù†Ø§Ø¯Ø±Ø©', price: 800, xp: 150, rarity: 'Ø£Ø³Ø·ÙˆØ±ÙŠ' }
    ];
}

// ------------------- Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† -------------------
let searchTimeout = null;
document.getElementById("player-input").addEventListener("input", function() {
    const query = this.value.trim().toLowerCase();
    selectedPlayerId = null;
    const suggestionsDiv = document.getElementById("suggestions");
    suggestionsDiv.innerHTML = "";
    if (query.length < 2) return;

    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(async () => {
        const db = firebase.firestore();
        const snapshot = await db.collection("users")
            .where("displayNameLower", ">=", query)
            .where("displayNameLower", "<=", query + '\uf8ff')
            .limit(5).get();
        snapshot.forEach(doc => {
            const div = document.createElement("div");
            div.className = "suggestion-item";
            div.textContent = doc.data().displayName || doc.data().email;
            div.onclick = () => {
                document.getElementById("player-input").value = div.textContent;
                selectedPlayerId = doc.id;
                suggestionsDiv.innerHTML = "";
            };
            suggestionsDiv.appendChild(div);
        });
    }, 300);
});

// ------------------- ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ -------------------
function initGifts() {
    gifts = getGiftList();
    const container = document.getElementById("gifts-container");
    gifts.forEach((g, idx) => {
        const div = document.createElement("div");
        div.className = "gift-card";
        div.innerHTML = `<div class="gift-name">${g.name}</div>
                         <div class="gift-info">${g.rarity} | ${g.price} ÙƒÙˆÙŠÙ†Ø² | ${g.xp} XP</div>`;
        div.onclick = () => toggleGiftSelection(idx, div);
        container.appendChild(div);
    });
}
function toggleGiftSelection(idx, div) {
    const gift = gifts[idx];
    const selIndex = selectedGifts.indexOf(gift);
    if (selIndex === -1) {
        selectedGifts.push(gift);
        div.classList.add("selected");
    } else {
        selectedGifts.splice(selIndex, 1);
        div.classList.remove("selected");
    }
}

// ------------------- Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ -------------------
async function sendSelectedGifts() {
    if (!selectedPlayerId) { alert("âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù„Ø§Ø¹Ø¨ ØµØ­ÙŠØ­"); return; }
    if (selectedGifts.length === 0) { alert("âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù‡Ø¯ÙŠØ© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„"); return; }

    const user = firebase.auth().currentUser;
    if (!user) { alert("âŒ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"); return; }

    const db = firebase.firestore();
    const senderRef = db.collection("users").doc(user.uid);
    const recipientRef = db.collection("users").doc(selectedPlayerId);

    try {
        await db.runTransaction(async t => {
            const senderDoc = await t.get(senderRef);
            const recipientDoc = await t.get(recipientRef);
            if (!senderDoc.exists) throw "âŒ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø§Ø¨Ùƒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©!";
            if (!recipientDoc.exists) throw "âŒ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©!";

            const senderData = senderDoc.data();
            const recipientData = recipientDoc.data();

            const totalCost = selectedGifts.reduce((acc,g)=>acc+(g.price||0),0);
            if ((senderData.totalCoins||0) < totalCost) throw `âŒ Ø±ØµÙŠØ¯Ùƒ (${senderData.totalCoins||0}) ØºÙŠØ± ÙƒØ§ÙÙ (Ø§Ù„ÙƒÙ„ÙØ©: ${totalCost})`;

            // Ø®ØµÙ… Ø§Ù„Ø±ØµÙŠØ¯
            t.update(senderRef,{ totalCoins: firebase.firestore.FieldValue.increment(-totalCost) });

            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ù„Ù„Ù…Ø³ØªÙ„Ù…
            let xpGain = 0;
            if (!recipientData.gifts) recipientData.gifts=[];
            selectedGifts.forEach(g => {
                xpGain += g.xp||0;
                recipientData.gifts.push({
                    name: g.name,
                    rarity: g.rarity,
                    date: Date.now(),
                    sender: user.uid
                });
            });
            t.update(recipientRef, {
                gifts: recipientData.gifts,
                xp: firebase.firestore.FieldValue.increment(xpGain)
            });
        });
        alert("ğŸ‰ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø¨Ù†Ø¬Ø§Ø­!");
        selectedGifts=[]; document.querySelectorAll(".gift-card.selected").forEach(d=>d.classList.remove("selected"));
        document.getElementById("player-input").value = "";
        selectedPlayerId = null;
    } catch(err) {
        console.error(err);
        alert(typeof err==="string"?err:"âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§");
    }
}
</script>

</body>
</html>
