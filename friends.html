<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ•µï¸ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±</title>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="auth.js"></script> 
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
/* (Ù†ÙØ³ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù…Ø¹ ØªØ¹Ø¯ÙŠÙ„ Ø­Ø¬Ù… Ø§Ù„Ù…Ø±Ø¨Ø¹) */
:root {
    --primary: #6366f1;
    --bg: #0f172a;
    --card-bg: #1e293b;
}

body {
    font-family: 'Cairo', sans-serif;
    background-color: var(--bg);
    color: #f1f5f9;
    margin: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
}

.top-bar {
    width: 100%;
    padding: 15px 25px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(30, 41, 59, 0.5);
    backdrop-filter: blur(10px);
}

#coin-display {
    color: #fbbf24;
    font-weight: 800;
}

/* --- Ø§Ù„Ù…Ø´ÙƒÙ„Ø© 1: ØªÙƒØ¨ÙŠØ± Ø§Ù„Ù…Ø±Ø¨Ø¹ --- */
.identity-card {
    width: 90%;
    max-width: 400px; /* ØªÙ… ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø¹Ø±Ø¶ */
    height: 300px;    /* ØªÙ… ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø·ÙˆÙ„ */
    background: var(--card-bg);
    border-radius: 30px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    border: 3px dashed rgba(148, 163, 184, 0.2);
    transition: all 0.3s ease;
    box-shadow: 0 15px 35px rgba(0,0,0,0.4);
    user-select: none; /* Ù„Ù…Ù†Ø¹ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Øµ ÙƒÙ†Ø³Ø® */
    -webkit-user-select: none;
}

.identity-card.revealed {
    border-style: solid;
    border-color: var(--primary);
    background: linear-gradient(145deg, #2563eb, #1e293b);
    transform: translateY(-10px);
}

.card-icon { font-size: 4rem; margin-bottom: 20px; color: #475569; }

.action-btn {
    margin-top: 30px;
    width: 80%;
    max-width: 300px;
    padding: 18px;
    border-radius: 15px;
    background: var(--primary);
    color: white;
    font-weight: 800;
    border: none;
    cursor: pointer;
}

#timer-box { display: none; text-align: center; margin-top: 50px; }
#timer-display { font-size: 5rem; color: #f59e0b; font-weight: 900; }
</style>
</head>

<body onload="loadGameData()">

<div class="top-bar">
    <div id="coin-display"><i class="fas fa-coins"></i> <span id="total-coins-value">0</span></div>
    <a href="index.html" style="color:#94a3b8; font-size: 1.5rem;"><i class="fas fa-times"></i></a>
</div>

<div id="setup-view" style="width: 100%; display: flex; flex-direction: column; align-items: center; margin-top: 40px;">
    <h1 id="player-name" style="font-size: 2.5rem; margin-bottom: 20px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h1>

    <div id="card" class="identity-card" 
         ontouchstart="showRole()" ontouchend="hideRole()" 
         onmousedown="showRole()" onmouseup="hideRole()">
        <i class="fas fa-fingerprint card-icon"></i>
        <span style="font-size: 1.2rem; font-weight: 600;">Ø§Ø¶ØºØ· Ù…Ø·ÙˆÙ„Ø§Ù‹ Ù„Ù„ÙƒØ´Ù</span>
    </div>

    <button id="nextBtn" class="action-btn" onclick="nextPlayer()">Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„ØªØ§Ù„ÙŠ <i class="fas fa-arrow-left"></i></button>
</div>

<div id="timer-box">
    <h2 style="color: #10b981">ğŸ—£ï¸ ÙˆÙ‚Øª Ø§Ù„Ù†Ù‚Ø§Ø´!</h2>
    <div id="timer-display">00:00</div>
</div>

<script>
let players = [];
let roles = [];
let currentIndex = 0;
let civilWord = "";

// Ù†ÙØ³ ØªØµÙ†ÙŠÙØ§Øª Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
const wordCategories = {
    free: [{ id: 'objects', words: ["Ù‚Ù„Ù…", "ÙƒÙˆØ¨", "ÙƒØ±Ø³ÙŠ", "Ù…ÙØªØ§Ø­", "Ù‡Ø§ØªÙ", "Ø³Ø§Ø¹Ø©", "Ù…ØµØ¨Ø§Ø­"] }],
    pro: [{ id: 'foods', words: ["ØªÙØ§Ø­", "Ù…ÙˆØ²", "Ø¨Ø±ØªÙ‚Ø§Ù„", "Ø£Ø±Ø²", "Ø¨ÙŠØªØ²Ø§"] }]
};

async function loadGameData() {
    auth.onAuthStateChanged(async (user) => {
        if (!user) { window.location.href = "auth.html"; return; }
        const data = await loadUserData();
        if (data) {
            players = data.players || [];
            document.getElementById("total-coins-value").innerText = data.totalCoins || 0;
            if (players.length < 3) { alert("Ø£Ø¶Ù 3 Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„"); window.location.href = "index.html"; return; }
            players.sort(() => Math.random() - 0.5);
            setupRoles(data);
            updateUI();
        }
    });
}

function setupRoles(userData) {
    let allWords = [];
    const isUserPro = isPro(userData);
    
    // Ø¬Ù…Ø¹ Ø§Ù„ÙƒÙ„Ù…Ø§Øª (Ù…Ø«Ø§Ù„ Ø¨Ø³ÙŠØ·: Ù†Ø¬Ù…Ø¹ ÙƒÙ„ Ø§Ù„Ù…ØªØ§Ø­ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…)
    allWords = [...wordCategories.free[0].words];
    if (isUserPro) allWords = [...allWords, ...wordCategories.pro[0].words];

    civilWord = allWords[Math.floor(Math.random() * allWords.length)];
    
    // --- Ø§Ù„Ù…Ø´ÙƒÙ„Ø© 3: Ø¶Ù…Ø§Ù† ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø¨Ø´ÙƒÙ„ Ø³Ù„ÙŠÙ… ---
    roles = Array(players.length).fill("CIVILIAN");
    let impostorIndex = Math.floor(Math.random() * players.length);
    roles[impostorIndex] = "IMPOSTOR";
}

function updateUI() {
    document.getElementById("player-name").innerText = players[currentIndex];
    // --- Ø§Ù„Ù…Ø´ÙƒÙ„Ø© 2: Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø´ÙƒÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø¹Ù†Ø¯ ÙƒÙ„ Ù„Ø§Ø¹Ø¨ Ø¬Ø¯ÙŠØ¯ ---
    hideRole(); 
}

function showRole() {
    const card = document.getElementById("card");
    card.classList.add("revealed");
    const role = roles[currentIndex];
    
    // --- Ø§Ù„Ù…Ø´ÙƒÙ„Ø© 3: Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„Ù…Ø© Ù„Ù„Ù…Ø¯Ù†ÙŠ ÙÙ‚Ø· ÙˆØ¥Ø®ÙØ§Ø¦Ù‡Ø§ Ø¹Ù† Ø§Ù„Ù…Ø­ØªØ§Ù„ ---
    if (role === "CIVILIAN") {
        card.innerHTML = `
            <i class="fas fa-user-check" style="font-size:3rem; margin-bottom:10px;"></i>
            <h2 style="margin:0;">Ø£Ù†Øª Ù…Ø¯Ù†ÙŠ</h2>
            <div style="font-size:2rem; font-weight:900; margin-top:15px; background:white; color:var(--primary); padding:10px 30px; border-radius:15px;">
                ${civilWord}
            </div>
        `;
    } else {
        card.innerHTML = `
            <i class="fas fa-user-secret" style="font-size:4rem; margin-bottom:10px; color:#ff4f4f;"></i>
            <h2 style="color:#ff4f4f; margin:0;">Ø£Ù†Øª Ø§Ù„Ù…Ø­ØªØ§Ù„ ğŸ˜ˆ</h2>
            <p style="font-weight:bold; color:#f1f5f9;">Ø­Ø§ÙˆÙ„ Ø®Ø¯Ø§Ø¹ Ø§Ù„Ø¬Ù…ÙŠØ¹!</p>
        `;
    }
}

function hideRole() {
    const card = document.getElementById("card");
    card.classList.remove("revealed");
    // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
    card.innerHTML = `
        <i class="fas fa-fingerprint card-icon"></i>
        <span style="font-size: 1.2rem; font-weight: 600;">Ø§Ø¶ØºØ· Ù…Ø·ÙˆÙ„Ø§Ù‹ Ù„Ù„ÙƒØ´Ù</span>
    `;
}

async function nextPlayer() {
    currentIndex++;
    if (currentIndex >= players.length) {
        document.getElementById("setup-view").style.display = "none";
        document.getElementById("timer-box").style.display = "block";
        startDiscussion(60); // 60 Ø«Ø§Ù†ÙŠØ© Ù†Ù‚Ø§Ø´
    } else {
        updateUI();
    }
}

function startDiscussion(seconds) {
    let timeLeft = seconds;
    const display = document.getElementById("timer-display");
    const interval = setInterval(() => {
        let m = Math.floor(timeLeft / 60);
        let s = timeLeft % 60;
        display.innerText = `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        if (timeLeft <= 0) { clearInterval(interval); alert("Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ù†Ù‚Ø§Ø´!"); }
        timeLeft--;
    }, 1000);
}
</script>
</body>
</html>

