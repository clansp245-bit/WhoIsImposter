<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§</title>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="auth.js"></script> 

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
body { font-family: 'Cairo', sans-serif; background:#0f172a; color:#f1f5f9; padding:20px; min-height:100vh; text-align:center; }
h2 { color:#34d399; margin-bottom:20px; font-size:2rem; }
.card { background:#1e293b; border-radius:12px; padding:20px; max-width:500px; margin:15px auto; text-align:right; }
input, select { width:100%; padding:10px; border-radius:8px; border:none; margin-bottom:10px; background:#334155; color:white; }
button { padding:10px; width:100%; border:none; border-radius:8px; font-weight:700; cursor:pointer; margin-top:10px; }
.send-btn { background:#34d399; color:white; }
.send-btn:hover { background:#10b981; }
.gift-card { display:flex; justify-content:space-between; align-items:center; padding:12px 15px; margin-bottom:10px; border-radius:8px; border:1px solid #334155; cursor:pointer; transition:all 0.2s; }
.gift-card.selected { background-color:#6366f1; border-color:#4f46e5; box-shadow:0 0 10px rgba(99,102,241,0.5); }
.gift-name { font-weight:700; }
.gift-cost { font-size:0.85rem; color:#94a3b8; }
.alert { color:#ffcc00; font-size:0.9rem; margin-top:10px; }
.player-selected-indicator { color: #34d399; font-weight: 700; margin-top: 5px; }
</style>
</head>

<body onload="initGiftPage()">

<h2>ğŸ Ø£Ø±Ø³Ù„ Ù‡Ø¯Ø§ÙŠØ§ Ù„Ù„Ø§Ø¹Ø¨</h2>

<div class="card">
    <h3>Ø§Ø¨Ø­Ø« Ø¹Ù† Ù„Ø§Ø¹Ø¨:</h3>
    <input type="text" id="player-search" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶">
    <div id="search-results">
        <p class="alert">Ø£Ø¯Ø®Ù„ 3 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø¨Ø­Ø«</p>
    </div>
    <div id="selected-player-info" class="player-selected-indicator"></div>
</div>

<div class="card">
    <h3>Ø§Ø®ØªØ± Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§:</h3>
    <div id="gifts-container"></div>
    <button class="send-btn" id="send-gift-btn" disabled>Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</button>
    <p class="alert" id="gift-alert"></p>
</div>

<div class="card">
    <h3>Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ:</h3>
    <p>Coins: <span id="user-coins">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span> | XP: <span id="user-xp">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span> | Ø§Ù„Ù…Ø³ØªÙˆÙ‰: <span id="user-level">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span></p>
    <p id="auth-status" class="alert"></p>
</div>

<script>
let currentUserData = {};
let selectedPlayerId = null;
let selectedGifts = [];
const db = firebase.firestore(); 

// -------------------- Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ --------------------
const gifts = [
    {name:"ÙˆØ±Ø¯Ø©", cost:50, xp:10, type:"Ø¹Ø§Ø¯ÙŠ"},
    {name:"Ù‚Ù„Ù… Ø°Ù‡Ø¨ÙŠ", cost:200, xp:50, type:"ØºØ§Ù„ÙŠ"},
    {name:"Ø³ÙŠØ§Ø±Ø© Ø³Ø¨Ø§Ù‚", cost:1500, xp:450, type:"Ø£Ø³Ø·ÙˆØ±ÙŠ"},
    {name:"Ø·Ø§Ø¦Ø±Ø© Ø®Ø§ØµØ©", cost:5000, xp:1200, type:"Ø£Ø³Ø·ÙˆØ±ÙŠ"},
    {name:"ÙŠØ®Øª ÙØ§Ø®Ø±", cost:3000, xp:800, type:"ØºØ§Ù„ÙŠ"},
    {name:"Ù…Ø¬ÙˆÙ‡Ø±Ø§Øª", cost:8000, xp:2000, type:"Ø£Ø³Ø·ÙˆØ±ÙŠ"},
    {name:"ÙƒØªØ§Ø¨ Ø³Ø­Ø±ÙŠ", cost:100, xp:20, type:"Ø¹Ø§Ø¯ÙŠ"},
    {name:"ØªØ§Ø¬ Ù…Ù„ÙƒÙŠ", cost:10000, xp:2500, type:"Ø£Ø³Ø·ÙˆØ±ÙŠ"}
];

function populateGifts() {
    const container = document.getElementById("gifts-container");
    gifts.forEach((g, i) => {
        const div = document.createElement("div");
        div.className = "gift-card";
        div.setAttribute("data-index", i);
        div.onclick = () => toggleGift(i);
        div.innerHTML = `<div class="gift-name">${g.name}</div><div class="gift-cost">${g.cost} Coins | ${g.type}</div>`;
        container.appendChild(div);
    });
}

function toggleGift(index) {
    const div = document.querySelector(`.gift-card[data-index='${index}']`);
    if (selectedGifts.includes(index)) {
        selectedGifts = selectedGifts.filter(i => i!==index);
        div.classList.remove("selected");
    } else {
        selectedGifts.push(index);
        div.classList.add("selected");
    }
    document.getElementById("send-gift-btn").disabled = selectedGifts.length === 0 || !selectedPlayerId;
}

// -------------------- INIT --------------------
async function initGiftPage() {
    populateGifts();
    
    document.getElementById("auth-status").innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„...";

    firebase.auth().onAuthStateChanged(async user => {
        if(!user) {
            document.getElementById("auth-status").innerText = "âŒ Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„.";
            // ÙŠÙ…ÙƒÙ† ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù‡Ù†Ø§ Ø¥Ø°Ø§ Ø±ØºØ¨Øª
            return; 
        }
        
        document.getElementById("auth-status").innerText = "âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...";
        
        // loadUserData Ø¯Ø§Ù„Ø© Ù…Ù† auth.js
        const data = await loadUserData(); 
        if(data) {
            currentUserData = data;
            document.getElementById("auth-status").innerText = "";
            updateUserDisplay();
            setupSearch();
        } else {
            document.getElementById("auth-status").innerText = "âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…. Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.";
        }
    });
}

function updateUserDisplay() {
    document.getElementById("user-coins").innerText = currentUserData.totalCoins || 0;
    document.getElementById("user-xp").innerText = currentUserData.xp || 0;
    document.getElementById("user-level").innerText = currentUserData.level || 1;
}

// -------------------- SEARCH --------------------
function setupSearch() {
    const input = document.getElementById("player-search");
    input.addEventListener("input", async () => {
        const q = input.value.trim();
        const resultsDiv = document.getElementById("search-results");
        const selectedInfo = document.getElementById("selected-player-info");
        selectedInfo.innerText = '';
        selectedPlayerId = null; 

        resultsDiv.innerHTML = '<p class="alert">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</p>';
        if (q.length < 3) { resultsDiv.innerHTML = '<p class="alert">Ø£Ø¯Ø®Ù„ 3 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø¨Ø­Ø«</p>'; return; }
        
        // searchUsersByDisplayName Ø¯Ø§Ù„Ø© Ù…Ù† auth.js
        const res = await searchUsersByDisplayName(q); 
        resultsDiv.innerHTML = "";
        
        if(!res.length) { resultsDiv.innerHTML = "<p class='alert'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©</p>"; return; }
        
        res.forEach(u=>{
            const div = document.createElement("div");
            div.className = "gift-card";
            div.innerHTML = `<div class="gift-name"><i class="fas fa-user"></i> ${u.displayName}</div>`;
            
            div.onclick = () => { 
                selectedPlayerId = u.uid; 
                selectedInfo.innerText = `âœ… ØªÙ… Ø§Ø®ØªÙŠØ§Ø±: ${u.displayName}`;
                
                document.querySelectorAll("#search-results .gift-card").forEach(c => c.classList.remove("selected"));
                div.classList.add("selected");
                
                document.getElementById("send-gift-btn").disabled = selectedGifts.length === 0; 
                document.getElementById("gift-alert").innerText="";
            };
            resultsDiv.appendChild(div);
        });
    });
}

// -------------------- SEND GIFTS --------------------
document.getElementById("send-gift-btn").addEventListener("click", async () => {
    if(!selectedPlayerId || selectedGifts.length===0) {
        document.getElementById("gift-alert").innerText="âŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù„Ø§Ø¹Ø¨ ÙˆÙ‡Ø¯Ø§ÙŠØ§!"; 
        return;
    }

    let totalCost = selectedGifts.reduce((sum,i)=>sum+gifts[i].cost,0);
    
    if((currentUserData.totalCoins||0) < totalCost){
        document.getElementById("gift-alert").innerText="âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø±ØµÙŠØ¯ ÙƒØ§ÙÙ Ù„Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§!"; 
        return;
    }

    try {
        const user = firebase.auth().currentUser;
        if (!user) throw new Error("UserNotAuthenticated"); 

        const senderRef = db.collection("users").doc(user.uid);
        const recipientRef = db.collection("users").doc(selectedPlayerId);

        await db.runTransaction(async tx=>{
            const senderDoc = await tx.get(senderRef);
            const recipientDoc = await tx.get(recipientRef);
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø·Ø±ÙÙŠÙ†
            if(!senderDoc.exists) throw new Error("SenderNotFound");
            if(!recipientDoc.exists) throw new Error("RecipientNotFound");

            const senderCoins = senderDoc.data().totalCoins || 0;
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€ Transaction
            if(senderCoins < totalCost) throw new Error("InsufficientFunds");

            const recipientXP = recipientDoc.data().xp || 0;
            const totalXP = selectedGifts.reduce((sum,i)=>sum+gifts[i].xp,0);

            // 1. Ø®ØµÙ… Ø§Ù„ÙƒÙˆÙŠÙ†Ø² Ù…Ù† Ø§Ù„Ù…Ø±Ø³Ù„
            tx.update(senderRef,{totalCoins: senderCoins - totalCost});
            // 2. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®Ø¨Ø±Ø© Ù„Ù„Ù…Ø³ØªÙ„Ù… (ÙŠØªØ·Ù„Ø¨ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© Ù„Ù€ XP)
            tx.update(recipientRef,{xp: recipientXP + totalXP});
        });

        // Ø¥Ø°Ø§ Ù†Ø¬Ø­Øª Ø§Ù„Ù€ Transaction
        currentUserData.totalCoins -= totalCost;
        updateUserDisplay();
        const giftedXP = selectedGifts.reduce((sum,i)=>sum+gifts[i].xp,0);
        document.getElementById("gift-alert").innerText=`âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ${selectedGifts.length} Ù‡Ø¯ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­! (+${giftedXP} XP Ù„Ù„Ù…Ø³ØªÙ„Ù…)`;
        
        // Ù…Ø³Ø­ Ø§Ù„ØªØ­Ø¯ÙŠØ¯
        selectedGifts=[]; 
        document.querySelectorAll(".gift-card.selected").forEach(c=>c.classList.remove("selected"));
        document.getElementById("send-gift-btn").disabled = true;

    } catch(e){
        console.error("Ø®Ø·Ø£ Ø§Ù„Ù€ Transaction:", e.message || e);
        
        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ø¦Ù„ ØªØ´Ø®ÙŠØµÙŠØ© Ø¯Ù‚ÙŠÙ‚Ø©
        if (e.message === "UserNotAuthenticated") {
            document.getElementById("gift-alert").innerText="âŒ Ø®Ø·Ø£: ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§.";
        } else if (e.message === "SenderNotFound") {
            document.getElementById("gift-alert").innerText="âŒ Ø®Ø·Ø£: Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø§Ø¨Ùƒ Ù…ÙÙ‚ÙˆØ¯Ø©. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.";
        } else if (e.message === "RecipientNotFound") {
            document.getElementById("gift-alert").innerText="âŒ Ø®Ø·Ø£: Ø§Ù„Ù…Ø³ØªÙ„Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…. (ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„).";
        } else if (e.code === 'PERMISSION_DENIED') {
            document.getElementById("gift-alert").innerText="âŒ Ø®Ø·Ø£ Ø£Ù…Ø§Ù†: Ù‚ÙˆØ§Ø¹Ø¯ Firestore ØªÙ…Ù†Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«. (ÙŠØ¬Ø¨ Ù†Ø´Ø± Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø§Ù„ØªÙŠ ØªØ³Ù…Ø­ Ø¨ØªØ¹Ø¯ÙŠÙ„ XP).";
        } else {
            document.getElementById("gift-alert").innerText="âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§. (Ø±Ø§Ø¬Ø¹ Console Ù„Ù„Ù…Ø²ÙŠØ¯).";
        }
    }
});
</script>
</body>
</html>

