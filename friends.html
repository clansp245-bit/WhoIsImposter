<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§</title>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="auth.js"></script> 

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
/* -------------------- Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª -------------------- */
body { font-family: 'Cairo', sans-serif; background:#0f172a; color:#f1f5f9; padding:20px; min-height:100vh; text-align:center; }
h2 { color:#34d399; margin-bottom:20px; font-size:2rem; }
.card { background:#1e293b; border-radius:12px; padding:20px; max-width:500px; margin:15px auto; text-align:right; }
input, select { width:100%; padding:10px; border-radius:8px; border:none; margin-bottom:10px; background:#334155; color:white; }
button { padding:10px; width:100%; border:none; border-radius:8px; font-weight:700; cursor:pointer; margin-top:10px; }
.send-btn { background:#34d399; color:white; }
.send-btn:hover:enabled { background:#10b981; }

#coins-header { position: absolute; top: 20px; right: 20px; font-size: 1.2rem; color: #ffd700; font-weight: 700; }
#self-gift-btn { width: auto; padding: 10px 15px; background: #3b82f6; color: white; margin-bottom: 10px; }
#self-gift-btn:hover { background: #2563eb; }

/* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù‡Ø¯ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø¹ Ø§Ù„ÙƒÙ…ÙŠØ© */
.gift-item { display: flex; align-items: center; background: #334155; padding: 10px; border-radius: 8px; margin-bottom: 10px; }
.gift-info { flex-grow: 1; text-align: right; margin-right: 10px; }
.gift-info .gift-cost { color: #34d399; font-weight: 700; }
.gift-info .gift-rarity { font-size: 0.75rem; color: #94a3b8; }
.gift-info .gift-rarity.Ø¹Ø§Ø¯ÙŠ { color: #94a3b8; }
.gift-info .gift-rarity.ØºØ§Ù„ÙŠ { color: #facc15; }
.gift-info .gift-rarity.Ø£Ø³Ø·ÙˆØ±ÙŠ { color: #ef4444; }

.quantity-controls { display: flex; align-items: center; }
.quantity-controls button { width: 30px; height: 30px; margin: 0 5px; padding: 0; background: #475569; font-size: 1.2rem; }
.quantity-display { width: 40px; text-align: center; font-weight: 700; }

/* Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚ */
#cart-summary { background: #0f172a; padding: 15px; border-radius: 8px; border: 1px solid #475569; margin-top: 15px; }
#total-cost-display { font-size: 1.2rem; color: #facc15; font-weight: 700; }
.send-btn:disabled { background: #475569; cursor: not-allowed; }

/* -------------------- Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ (Animation Overlay) -------------------- */
#purchase-animation-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background-color: rgba(0, 0, 0, 0.7); display: none;
    justify-content: center; align-items: center; z-index: 1000;
}
.animation-box {
    width: 300px; height: 300px; border-radius: 20px;
    display: flex; flex-direction: column; justify-content: center;
    align-items: center; font-size: 3rem; color: white;
    position: relative; overflow: hidden; animation: fadeIn 0.5s;
}

@keyframes confetti-fall {
    0% { transform: translateY(-100%) rotate(0deg); opacity: 1; }
    100% { transform: translateY(100%) rotate(720deg); opacity: 0; }
}

.animation-box::before {
    content: ''; position: absolute; top: 0; left: 0;
    width: 100%; height: 100%; pointer-events: none; z-index: 1;
}
.animation-box.Ø¹Ø§Ø¯ÙŠ { background: #1e293b; border: 2px solid #94a3b8; }
.animation-box.ØºØ§Ù„ÙŠ { background: #1e293b; border: 3px solid #facc15; box-shadow: 0 0 20px #facc15; }
.animation-box.Ø£Ø³Ø·ÙˆØ±ÙŠ { background: #1e293b; border: 4px solid #ef4444; box-shadow: 0 0 30px #ef4444; }
.animation-box.Ø£Ø³Ø·ÙˆØ±ÙŠ::before {
    content: 'âœ¨ğŸ”¥ğŸŒŸğŸ‰'; 
    font-size: 20px; white-space: pre; opacity: 0.8;
    animation: confetti-fall 3s linear infinite;
    animation-delay: 0s, 0.5s, 1s, 1.5s;
    height: 100%; width: 100%; top: -100%; left: 0;
    position: absolute; transform: translateY(0);
}

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
.alert { color:#ffcc00; font-size:0.9rem; margin-top:10px; }
</style>
</head>

<body onload="initGiftPage()">

<div id="coins-header">
    <i class="fas fa-coins"></i> <span id="user-coins">0</span>
</div>

<h2>ğŸ Ù…ØªØ¬Ø± Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§</h2>

<div class="card">
    <button id="self-gift-btn" onclick="selectSelf()">
        <i class="fas fa-gift"></i> Ø£Ø±Ø³Ù„ Ù„Ù†ÙØ³ÙŠ
    </button>
    
    <label>Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªÙ„Ù…:</label>
    <input type="text" id="player-search" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶ Ø£Ùˆ Public UID">
    <div id="search-results"><p class="alert">Ø§Ø®ØªØ± Ù„Ù†ÙØ³Ùƒ Ø£Ùˆ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù„Ø§Ø¹Ø¨ Ø¢Ø®Ø±</p></div>
    <p class="alert" id="recipient-alert">Ø§Ù„Ù…Ø³ØªÙ„Ù…: (Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±)</p>
</div>

<div class="card">
    <h3>Ø§Ø®ØªØ± Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ ÙˆØ§Ù„ÙƒÙ…ÙŠØ©:</h3>
    <div id="gifts-container"></div>
    
    <div id="cart-summary">
        <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ XP Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„Ù…Ø³ØªÙ„Ù…: <span id="total-xp-display">0</span> XP</p>
        <p>Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©: <span id="total-cost-display">0</span> Coins</p>
    </div>

    <button class="send-btn" id="send-gift-btn" disabled onclick="sendGifts()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ <i class="fas fa-paper-plane"></i></button>
</div>

<div class="card">
    <h3>Ø¨ÙŠØ§Ù†Ø§ØªÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</h3>
    <p>XP: <span id="user-xp">0</span> | Ø§Ù„Ù…Ø³ØªÙˆÙ‰: <span id="user-level">1</span></p>
</div>

<div id="purchase-animation-overlay">
    <div class="animation-box">
        <i id="animation-icon" class="fas fa-gift"></i>
        <div id="animation-text" style="font-size: 1.5rem; margin-top: 15px;">ØªÙ… Ø§Ù„Ø´Ø±Ø§Ø¡!</div>
    </div>
</div>

<script>
let currentUserData = {};
let selectedPlayer = { uid: null, displayName: null }; // ÙŠØ®Ø²Ù† UID ÙˆØ§Ù„Ø§Ø³Ù…
let giftCart = {}; // { giftIndex: quantity }
let currentUserId = null;

// -------------------- Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ (Ø§Ù„Ù…Ø­Ø¯Ø«Ø©) --------------------
const gifts = [
    // Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ù…Ø§Ø¯ÙŠØ© (XP) - Ø§Ù„Ù†ÙˆØ¹: 'xp'
    {name:"ÙˆØ±Ø¯Ø©", cost:50, xp:10, rarity:"Ø¹Ø§Ø¯ÙŠ", icon:"ğŸŒ¹", type: 'xp'},
    {name:"Ù‚Ù„Ù… Ø°Ù‡Ø¨ÙŠ", cost:200, xp:50, rarity:"ØºØ§Ù„ÙŠ", icon:"ğŸ–‹ï¸", type: 'xp'},
    {name:"Ø³ÙŠØ§Ø±Ø© Ø³Ø¨Ø§Ù‚", cost:1500, xp:450, rarity:"Ø£Ø³Ø·ÙˆØ±ÙŠ", icon:"ğŸï¸", type: 'xp'},
    {name:"Ø·Ø§Ø¦Ø±Ø© Ø®Ø§ØµØ©", cost:5000, xp:1200, rarity:"Ø£Ø³Ø·ÙˆØ±ÙŠ", icon:"âœˆï¸", type: 'xp'},
    {name:"ÙŠØ®Øª ÙØ§Ø®Ø±", cost:3000, xp:800, rarity:"ØºØ§Ù„ÙŠ", icon:"ğŸ›¥ï¸", type: 'xp'},
    {name:"Ù…Ø¬ÙˆÙ‡Ø±Ø§Øª", cost:8000, xp:2000, rarity:"Ø£Ø³Ø·ÙˆØ±ÙŠ", icon:"ğŸ’", type: 'xp'},
    {name:"ÙƒØªØ§Ø¨ Ø³Ø­Ø±ÙŠ", cost:100, xp:20, rarity:"Ø¹Ø§Ø¯ÙŠ", icon:"ğŸ“–", type: 'xp'},
    {name:"ØªØ§Ø¬ Ù…Ù„ÙƒÙŠ", cost:10000, xp:2500, rarity:"Ø£Ø³Ø·ÙˆØ±ÙŠ", icon:"ğŸ‘‘", type: 'xp'},
    
    // Ù‡Ø¯Ø§ÙŠØ§ Pro - Ø§Ù„Ù†ÙˆØ¹: 'pro', Ø§Ù„Ù‚ÙŠÙ…Ø©: Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…
    {name:"Ø¹Ø¶ÙˆÙŠØ© Pro (Ø´Ù‡Ø±)", cost:20000, days: 30, rarity:"Ø£Ø³Ø·ÙˆØ±ÙŠ", icon:"ğŸŒŸ", type: 'pro'},
    {name:"Ø¹Ø¶ÙˆÙŠØ© Pro (Ø³Ù†Ø©)", cost:150000, days: 365, rarity:"Ø£Ø³Ø·ÙˆØ±ÙŠ", icon:"ğŸ‘‘", type: 'pro'},

    // Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„ÙƒÙˆÙŠÙ†Ø² - Ø§Ù„Ù†ÙˆØ¹: 'coins', Ø§Ù„Ù‚ÙŠÙ…Ø©: Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙˆÙŠÙ†Ø²
    {name:"Ø­Ø²Ù…Ø© 5000 ÙƒÙˆÙŠÙ†Ø²", cost:4500, coins: 5000, rarity:"ØºØ§Ù„ÙŠ", icon:"ğŸ’°", type: 'coins'},
    {name:"Ø­Ø²Ù…Ø© 15000 ÙƒÙˆÙŠÙ†Ø²", cost:12000, coins: 15000, rarity:"Ø£Ø³Ø·ÙˆØ±ÙŠ", icon:"ğŸ’¸", type: 'coins'}
];

// -------------------- Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„Ø¹Ø±Ø¶ --------------------

function calculateCartTotals() {
    let totalCost = 0;
    let totalXP = 0;
    
    for (const index in giftCart) {
        const quantity = giftCart[index];
        const gift = gifts[index];
        totalCost += gift.cost * quantity;
        
        // Ø­Ø³Ø§Ø¨ XP ÙÙ‚Ø· Ù„Ù„Ù‡Ø¯Ø§ÙŠØ§ Ù…Ù† Ù†ÙˆØ¹ 'xp'
        if (gift.type === 'xp') {
            totalXP += (gift.xp || 0) * quantity;
        }
    }
    
    document.getElementById("total-cost-display").innerText = totalCost;
    document.getElementById("total-xp-display").innerText = totalXP; 
    
    // ØªÙ…ÙƒÙŠÙ†/ØªØ¹Ø·ÙŠÙ„ Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
    document.getElementById("send-gift-btn").disabled = 
        totalCost === 0 || !selectedPlayer.uid || (currentUserData.totalCoins || 0) < totalCost;
}

function updateGiftQuantity(index, change) {
    const currentQuantity = giftCart[index] || 0;
    let newQuantity = currentQuantity + change;
    
    if (newQuantity < 0) newQuantity = 0;
    
    const gift = gifts[index];
    // Ù‚ÙŠØ¯: Ù‡Ø¯Ø§ÙŠØ§ Pro ÙˆØ§Ù„ÙƒÙˆÙŠÙ†Ø² Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø´Ø±Ø§Ø¤Ù‡Ø§ Ø¨ÙƒÙ…ÙŠØ§Øª Ù…ØªØ¹Ø¯Ø¯Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
    if (gift.type !== 'xp' && newQuantity > 1) {
        newQuantity = 1; 
        if (currentQuantity === 0 && change > 0) { // Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ ÙÙ‚Ø· Ø¹Ù†Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
             alert(`ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± Ù‡Ø¯ÙŠØ© ${gift.name} Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· ÙÙŠ ÙƒÙ„ Ø¥Ø±Ø³Ø§Ù„.`);
        }
    }

    if (newQuantity === 0) {
        delete giftCart[index];
    } else {
        giftCart[index] = newQuantity;
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ…ÙŠØ©
    document.querySelector(`.gift-item[data-index='${index}'] .quantity-display`).innerText = newQuantity;
    
    calculateCartTotals();
}

function populateGifts() {
    const container = document.getElementById("gifts-container");
    container.innerHTML = '';
    gifts.forEach((g, i) => {
        const valueDisplay = g.type === 'xp' ? `${g.xp} XP` : 
                             g.type === 'pro' ? `${g.days} ÙŠÙˆÙ… Pro` : 
                             `${g.coins} Coins`;
        
        const div = document.createElement("div");
        div.className = "gift-item";
        div.setAttribute("data-index", i);
        div.innerHTML = `
            <div class="gift-info">
                <div class="gift-name">${g.icon} ${g.name}</div>
                <div class="gift-cost">${g.cost} Coins | <span class="gift-rarity ${g.rarity}">${g.rarity} (${valueDisplay})</span></div>
            </div>
            <div class="quantity-controls">
                <button onclick="updateGiftQuantity(${i}, 1)"><i class="fas fa-plus"></i></button>
                <span class="quantity-display">${giftCart[i] || 0}</span>
                <button onclick="updateGiftQuantity(${i}, -1)"><i class="fas fa-minus"></i></button>
            </div>
        `;
        container.appendChild(div);
    });
}

function updateUserDisplay() {
    document.getElementById("user-coins").innerText = currentUserData.totalCoins || 0;
    document.getElementById("user-xp").innerText = currentUserData.xp || 0;
    document.getElementById("user-level").innerText = currentUserData.level || 1;
}

function updateRecipientDisplay() {
    const alertElement = document.getElementById("recipient-alert");
    if (selectedPlayer.displayName) {
        alertElement.innerText = `Ø§Ù„Ù…Ø³ØªÙ„Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ: ${selectedPlayer.displayName}`;
        alertElement.style.color = selectedPlayer.uid === currentUserId ? '#3b82f6' : '#34d399';
    } else {
        alertElement.innerText = `Ø§Ù„Ù…Ø³ØªÙ„Ù…: (Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±)`;
        alertElement.style.color = '#ffcc00';
    }
    calculateCartTotals();
}

function selectSelf() {
    selectedPlayer.uid = currentUserId;
    selectedPlayer.displayName = firebase.auth().currentUser.displayName || firebase.auth().currentUser.email.split('@')[0];
    document.getElementById("player-search").value = ''; // Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø«
    document.getElementById("search-results").innerHTML = '<p class="alert">Ø§Ø®ØªØ±Øª Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ù„Ù†ÙØ³Ùƒ.</p>';
    updateRecipientDisplay();
}

// -------------------- INIT --------------------
async function initGiftPage() {
    populateGifts();
    firebase.auth().onAuthStateChanged(async user => {
        if(!user) return window.location.href="auth.html";
        currentUserId = user.uid; 
        
        const data = await loadUserData(); // Ù…Ù† auth.js
        if(data) currentUserData = data;
        
        updateUserDisplay();
        setupSearch();
        selectSelf(); // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†ÙØ³ ÙƒØ®ÙŠØ§Ø± Ø§ÙØªØ±Ø§Ø¶ÙŠ
    });
}


// -------------------- SEARCH --------------------
function setupSearch() {
    const input = document.getElementById("player-search");
    input.addEventListener("input", async () => {
        const q = input.value.trim();
        const resultsDiv = document.getElementById("search-results");
        resultsDiv.innerHTML = '<p class="alert">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</p>';
        
        if (q.length < 3) { 
            resultsDiv.innerHTML = '<p class="alert">Ø£Ø¯Ø®Ù„ 3 Ø£Ø­Ø±Ù Ù„Ù„Ø¨Ø­Ø«ØŒ Ø£Ùˆ Ø§Ø¶ØºØ· "Ø£Ø±Ø³Ù„ Ù„Ù†ÙØ³ÙŠ"</p>'; 
            return; 
        }
        
        const res = await searchUsersByDisplayName(q); // Ù…Ù† auth.js
        resultsDiv.innerHTML = "";
        
        if(!res.length) { 
            resultsDiv.innerHTML = "<p class='alert'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p>"; 
            return; 
        }
        
        res.forEach(u=>{
            // Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ù† Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
            if (u.uid === currentUserId) return; 
            
            const div = document.createElement("div");
            div.className = "gift-item"; 
            div.innerHTML = `<div class="gift-info"><div class="gift-name">${u.displayName} (UID: ${u.publicUid || 'N/A'})</div></div>`;
            div.onclick = () => { 
                selectedPlayer.uid = u.uid; 
                selectedPlayer.displayName = u.displayName; 
                updateRecipientDisplay();
                resultsDiv.innerHTML = ''; // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
            };
            resultsDiv.appendChild(div);
        });
        
        if(resultsDiv.innerHTML === "") {
             resultsDiv.innerHTML = "<p class='alert'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p>"; 
        }
    });
}

// -------------------- ANIMATION --------------------
function showPurchaseAnimation(rarity) {
    const overlay = document.getElementById("purchase-animation-overlay");
    const box = overlay.querySelector(".animation-box");
    const icon = document.getElementById("animation-icon");
    const text = document.getElementById("animation-text");

    let displayIcon = "ğŸ";
    let displayText = "ØªÙ… Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­!";
    
    switch (rarity) {
        case "ØºØ§Ù„ÙŠ":
            displayIcon = "ğŸŒŸ";
            displayText = "Ø´Ø±Ø§Ø¡ Ø±Ø§Ø¦Ø¹! ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.";
            break;
        case "Ø£Ø³Ø·ÙˆØ±ÙŠ":
            displayIcon = "âœ¨";
            displayText = "ØµÙÙ‚Ø© Ø£Ø³Ø·ÙˆØ±ÙŠØ©! ØªÙ‡Ø§Ù†ÙŠÙ†Ø§.";
            break;
    }
    
    box.className = `animation-box ${rarity}`;
    icon.innerHTML = displayIcon;
    text.innerText = displayText;

    overlay.style.display = 'flex';
    setTimeout(() => {
        overlay.style.display = 'none';
    }, 2500); 
}

// -------------------- SEND GIFTS --------------------
async function sendGifts() {
    if(!selectedPlayer.uid || Object.keys(giftCart).length === 0) return;
    
    let totalCost = calculateCartTotalsFromCart();
    let totalXP = 0;
    let totalDaysPro = 0;
    let totalGiftCoins = 0;
    let highestRarity = "Ø¹Ø§Ø¯ÙŠ"; 

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ÙˆØªØ­Ø¯ÙŠØ¯ Ø£Ø¹Ù„Ù‰ Ù†Ø¯Ø±Ø©
    for (const index in giftCart) {
        const quantity = giftCart[index];
        const gift = gifts[index];
        
        if (gift.type === 'xp') {
            totalXP += (gift.xp || 0) * quantity;
        } else if (gift.type === 'pro') {
            totalDaysPro += (gift.days || 0) * quantity;
        } else if (gift.type === 'coins') {
            totalGiftCoins += (gift.coins || 0) * quantity;
        }

        if (gift.rarity === "Ø£Ø³Ø·ÙˆØ±ÙŠ") highestRarity = "Ø£Ø³Ø·ÙˆØ±ÙŠ";
        else if (gift.rarity === "ØºØ§Ù„ÙŠ" && highestRarity !== "Ø£Ø³Ø·ÙˆØ±ÙŠ") highestRarity = "ØºØ§Ù„ÙŠ";
    }

    if((currentUserData.totalCoins || 0) < totalCost) {
        alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø±ØµÙŠØ¯ ÙƒØ§ÙÙŠ Ù„ØªÙ…ÙˆÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§!");
        return;
    }
    
    // ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø´Ø±Ø§Ø¡
    if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ù„Ù€ ${selectedPlayer.displayName} Ø¨ØªÙƒÙ„ÙØ© Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© ${totalCost} CoinsØŸ`)) {
        return;
    }

    try {
        const user = firebase.auth().currentUser;
        const senderRef = firebase.firestore().collection("users").doc(user.uid);
        const recipientRef = firebase.firestore().collection("users").doc(selectedPlayer.uid);

        await firebase.firestore().runTransaction(async tx => {
            const senderDoc = await tx.get(senderRef);
            const recipientDoc = await tx.get(recipientRef);
            if (!senderDoc.exists) throw new Error("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø±Ø³Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.");
            if (!recipientDoc.exists) throw new Error("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.");

            const senderCoins = senderDoc.data().totalCoins || 0;
            if (senderCoins < totalCost) throw new Error("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±ØµÙŠØ¯ ÙƒØ§ÙÙŠ Ù„Ù„Ø®ØµÙ….");
            
            // 1. Ø®ØµÙ… Ø§Ù„ÙƒÙˆÙŠÙ†Ø² Ù…Ù† Ø§Ù„Ù…Ø±Ø³Ù„
            tx.update(senderRef, { totalCoins: senderCoins - totalCost });
            
            // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªÙ„Ù…
            const recipientData = recipientDoc.data();
            let recipientUpdate = {};
            
            // ØªØ­Ø¯ÙŠØ« XP
            if (totalXP > 0) {
                recipientUpdate.xp = (recipientData.xp || 0) + totalXP;
            }

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙˆÙŠÙ†Ø² Ø§Ù„Ù…Ù‡Ø¯Ù‰
            if (totalGiftCoins > 0) {
                recipientUpdate.totalCoins = firebase.firestore.FieldValue.increment(totalGiftCoins);
            }

            // ØªØ­Ø¯ÙŠØ« Ù…Ø¯Ø© Pro
            if (totalDaysPro > 0) {
                const now = Date.now();
                let currentExpiry = recipientData.proExpiryTime || 0;
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¨Ø±Ùˆ Ù…Ù†ØªÙ‡ÙŠØ§Ù‹ØŒ Ù†Ø¨Ø¯Ø£ Ù…Ù† Ø§Ù„Ø¢Ù†ØŒ ÙˆØ¥Ù„Ø§ Ù†Ø¨Ø¯Ø£ Ù…Ù† ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
                const baseTime = (currentExpiry > now) ? currentExpiry : now;
                
                recipientUpdate.proExpiryTime = baseTime + (totalDaysPro * 24 * 60 * 60 * 1000);
            }

            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ­Ø¯ÙŠØ«Ø§Øª Ù„Ù„Ù…Ø³ØªÙ„Ù…
            if (Object.keys(recipientUpdate).length > 0) {
                tx.update(recipientRef, recipientUpdate);
            } else {
                 throw new Error("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙŠÙ…Ø© ÙÙŠ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ù„ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø§Ù„Ù…Ø³ØªÙ„Ù….");
            }
        });

        // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        currentUserData.totalCoins -= totalCost;
        updateUserDisplay();
        
        // 4. Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù†
        showPurchaseAnimation(highestRarity);

        // 5. Ù…Ø³Ø­ Ø§Ù„Ø³Ù„Ø© ÙˆØ¥Ø¸Ù‡Ø§Ø± Ù…Ù„Ø®Øµ
        let summaryMessage = `ğŸ‰ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ ${selectedPlayer.displayName}!`;
        if (totalXP > 0) summaryMessage += ` (+${totalXP} XP)`;
        if (totalGiftCoins > 0) summaryMessage += ` (+${totalGiftCoins} Coins)`;
        if (totalDaysPro > 0) summaryMessage += ` (+${totalDaysPro} ÙŠÙˆÙ… Pro)`;

        alert(summaryMessage);
        giftCart = {}; 
        populateGifts(); 
        calculateCartTotals();
        
    } catch(e) {
        console.error("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§:", e);
        // Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ ÙˆØ§Ø¶Ø­Ø©
        const errorMessage = e.message && e.message.includes('permission') 
                           ? "ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Ø£Ù…Ø§Ù† Firestore (Firestore Rules)." 
                           : `ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„. Ø§Ù„Ø³Ø¨Ø¨: ${e.message || e}`;
        alert(errorMessage);
    }
}

// Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù€ sendGifts
function calculateCartTotalsFromCart() {
    let totalCost = 0;
    for (const index in giftCart) {
        totalCost += gifts[index].cost * giftCart[index];
    }
    return totalCost;
}

function calculateTotalXPFromCart() {
    let totalXP = 0;
    for (const index in giftCart) {
        if (gifts[index].type === 'xp') {
             totalXP += (gifts[index].xp || 0) * giftCart[index];
        }
    }
    return totalXP;
}
</script>
</body>
</html>

