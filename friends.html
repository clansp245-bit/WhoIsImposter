<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ•µï¸ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…ØµÙ„Ø­Ø©</title>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="auth.js"></script> 
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
:root { --primary: #6366f1; --bg: #0f172a; --card-bg: #1e293b; }
body { font-family: 'Cairo', sans-serif; background-color: var(--bg); color: #f1f5f9; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow: hidden; }

.top-bar { width: 100%; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(10px); z-index: 10; }
#coin-display { color: #fbbf24; font-weight: 800; font-size: 1.2rem; }

/* ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„ÙƒØ¨ÙŠØ± */
.identity-card {
    width: 85vw; max-width: 450px; height: 350px;
    background: var(--card-bg); border-radius: 35px;
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    cursor: pointer; border: 4px dashed rgba(255, 255, 255, 0.1);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 20px 50px rgba(0,0,0,0.6);
    user-select: none; -webkit-user-select: none;
    position: relative; overflow: hidden;
}

.identity-card.revealed { border-style: solid; border-color: var(--primary); background: #2563eb; transform: scale(1.02); }

.card-icon { font-size: 5rem; color: #475569; margin-bottom: 20px; }

.action-btn {
    margin-top: 40px; width: 80%; max-width: 300px; padding: 20px;
    border-radius: 20px; background: var(--primary); color: white;
    font-weight: 800; font-size: 1.3rem; border: none; cursor: pointer;
    box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);
}

#timer-box { display: none; text-align: center; margin-top: 50px; animation: fadeIn 0.5s; }
#timer-display { font-size: 6rem; color: #f59e0b; font-weight: 900; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>

<body onload="initGame()">

<div class="top-bar">
    <div id="coin-display"><i class="fas fa-coins"></i> <span id="total-coins-value">...</span></div>
    <a href="index.html" style="color:#94a3b8; font-size: 1.8rem;"><i class="fas fa-times-circle"></i></a>
</div>

<div id="setup-view" style="width: 100%; display: flex; flex-direction: column; align-items: center; margin-top: 30px;">
    <div style="background: var(--primary); padding: 5px 20px; border-radius: 50px; margin-bottom: 10px; font-weight: bold;">Ø¯ÙˆØ± Ø§Ù„Ù„Ø§Ø¹Ø¨:</div>
    <h1 id="player-name" style="font-size: 2.8rem; margin: 0 0 30px 0; text-shadow: 0 4px 10px rgba(0,0,0,0.3);">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h1>

    <div id="card" class="identity-card" 
         ontouchstart="showRole()" ontouchend="hideRole()" 
         onmousedown="showRole()" onmouseup="hideRole()">
        <i class="fas fa-fingerprint card-icon"></i>
        <span style="font-size: 1.3rem; opacity: 0.7;">Ø§Ø¶ØºØ· Ù…Ø·ÙˆÙ„Ø§Ù‹ Ù„Ù„ÙƒØ´Ù</span>
    </div>

    <button id="nextBtn" class="action-btn" onclick="nextPlayer()">Ø§Ù„ØªØ§Ù„ÙŠ <i class="fas fa-arrow-left"></i></button>
</div>

<div id="timer-box">
    <h1 style="color: #10b981; font-size: 2.5rem;">ğŸ—£ï¸ Ø§Ø¨Ø¯Ø£ÙˆØ§ Ø§Ù„Ù†Ù‚Ø§Ø´!</h1>
    <div id="timer-display">00:00</div>
    <p style="color: #94a3b8;">Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬ÙˆØ§Ø¦Ø² ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙˆÙ‚Øª</p>
</div>

<script>
let players = [];
let roles = [];
let currentIndex = 0;
let civilWord = "";
let currentUserData = null;

// Ø§Ù„ÙƒÙ„Ù…Ø§Øª (ØªÙ… Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø§Ø±Ø§ØªÙ‡Ø§)
const wordsList = ["Ø·Ø§Ø¦Ø±Ø©", "Ù…Ø³ØªØ´ÙÙ‰", "Ù…Ø¯Ø±Ø³Ø©", "Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª", "Ø­Ø¯ÙŠÙ‚Ø© Ø­ÙŠÙˆØ§Ù†", "Ù…Ù„Ø¹Ø¨", "Ù…Ø·Ø¹Ù…", "ÙÙ†Ø¯Ù‚", "Ø³ÙŠÙ†Ù…Ø§", "Ù…ÙƒØªØ¨Ø©"];

async function initGame() {
    auth.onAuthStateChanged(async (user) => {
        if (!user) { window.location.href = "auth.html"; return; }
        
        currentUserData = await loadUserData();
        if (currentUserData) {
            players = currentUserData.players || [];
            document.getElementById("total-coins-value").innerText = currentUserData.totalCoins;

            if (players.length < 3) {
                alert("ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© 3 Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©.");
                window.location.href = "index.html";
                return;
            }

            players = [...players].sort(() => Math.random() - 0.5);
            setupGameLogic();
            updateUI();
        }
    });
}

function setupGameLogic() {
    // 1. Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙƒÙ„Ù…Ø© Ø¨Ø´ÙƒÙ„ Ø¹Ø´ÙˆØ§Ø¦ÙŠ ØµØ­ÙŠØ­
    civilWord = wordsList[Math.floor(Math.random() * wordsList.length)];
    
    // 2. ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±
    roles = Array(players.length).fill("CIVILIAN");
    const impostorIndex = Math.floor(Math.random() * players.length);
    roles[impostorIndex] = "IMPOSTOR";
}

function updateUI() {
    document.getElementById("player-name").innerText = players[currentIndex];
    hideRole(); // Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ù‚Ù„Ø¨ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„
}

function showRole() {
    const card = document.getElementById("card");
    card.classList.add("revealed");
    const role = roles[currentIndex];
    
    if (role === "CIVILIAN") {
        card.innerHTML = `
            <i class="fas fa-user-check" style="font-size:3.5rem; margin-bottom:15px;"></i>
            <h2 style="margin:0; font-size: 1.8rem;">Ø£Ù†Øª Ù…Ø¯Ù†ÙŠ</h2>
            <div style="font-size:2.5rem; font-weight:900; margin-top:20px; background:white; color:#2563eb; padding:15px 40px; border-radius:20px; box-shadow: 0 10px 20px rgba(0,0,0,0.2);">
                ${civilWord}
            </div>
        `;
    } else {
        card.innerHTML = `
            <i class="fas fa-user-secret" style="font-size:5rem; margin-bottom:15px; color:#ff4f4f;"></i>
            <h2 style="color:#ff4f4f; margin:0; font-size: 2.2rem;">Ø£Ù†Øª Ø§Ù„Ù…Ø­ØªØ§Ù„ ğŸ˜ˆ</h2>
            <p style="font-weight:bold; font-size: 1.1rem; margin-top: 10px;">Ø­Ø§ÙˆÙ„ ØªØ®Ù…ÙŠÙ† Ø§Ù„ÙƒÙ„Ù…Ø©!</p>
        `;
    }
}

function hideRole() {
    const card = document.getElementById("card");
    card.classList.remove("revealed");
    card.innerHTML = `
        <i class="fas fa-fingerprint card-icon"></i>
        <span style="font-size: 1.3rem; opacity: 0.7;">Ø§Ø¶ØºØ· Ù…Ø·ÙˆÙ„Ø§Ù‹ Ù„Ù„ÙƒØ´Ù</span>
    `;
}

async function nextPlayer() {
    currentIndex++;
    if (currentIndex >= players.length) {
        // Ø§Ù†ØªÙ‡Ø§Ø¡ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±
        document.getElementById("setup-view").style.display = "none";
        document.getElementById("timer-box").style.display = "block";
        startDiscussion(60); 
    } else {
        updateUI();
    }
}

function startDiscussion(seconds) {
    let timeLeft = seconds;
    const display = document.getElementById("timer-display");
    
    const interval = setInterval(async () => {
        let m = Math.floor(timeLeft / 60);
        let s = timeLeft % 60;
        display.innerText = `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        
        if (timeLeft <= 0) {
            clearInterval(interval);
            display.innerText = "Ø§Ù†ØªÙ‡Ù‰!";
            
            // --- Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬ÙˆØ§Ø¦Ø² Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ ---
            if (currentUserData) {
                const reward = await addXPAndCoins(currentUserData, 15, 30); // 15 ÙƒÙˆÙŠÙ†Ø² Ùˆ 30 Ø®Ø¨Ø±Ø©
                alert(`Ù…Ø¨Ø±ÙˆÙƒ! Ø­ØµÙ„Øª Ø¹Ù„Ù‰ ${reward.coins} ÙƒÙˆÙŠÙ†Ø² Ùˆ ${reward.xp} XP`);
                document.getElementById("total-coins-value").innerText = currentUserData.totalCoins + reward.coins;
            }
        }
        timeLeft--;
    }, 1000);
}
</script>
</body>
</html>

