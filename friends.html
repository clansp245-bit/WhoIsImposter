<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‘¥ Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ ÙˆØ§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="auth.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        :root {
            --bg-dark: #0f172a;
            --card-bg: #1e293b;
            --accent: #6366f1;
            --success: #22c55e;
            --danger: #ef4444;
            --pro-gold: #ffd700;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-dark);
            color: #f1f5f9;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container { width: 100%; max-width: 500px; }

        .section-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }

        h3 { margin-top: 0; color: #94a3b8; font-size: 1.1rem; display: flex; justify-content: space-between; }

        /* Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ */
        .search-box { display: flex; gap: 10px; margin-bottom: 15px; }
        input {
            flex: 1;
            background: #0f172a;
            border: 1px solid #334155;
            padding: 12px;
            border-radius: 8px;
            color: white;
            outline: none;
        }

        .profile-result {
            background: #334155;
            border-radius: 12px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-left: 4px solid var(--accent);
        }

        .avatar-container { position: relative; }
        .avatar { width: 60px; height: 60px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
        
        .badge-icon {
            font-size: 0.9rem;
            margin-left: 5px;
            cursor: help;
        }
        .pro-badge { color: var(--pro-gold); }
        .dev-badge { color: #38bdf8; }

        /* Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… */
        .list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #0f172a;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 8px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .online { background: var(--success); box-shadow: 0 0 8px var(--success); }
        .offline { background: #64748b; }

        .btn { border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; color: white; transition: 0.3s; }
        .btn-add { background: var(--accent); }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); }
        .btn:hover { opacity: 0.8; transform: scale(1.05); }

        .empty-text { color: #64748b; font-size: 0.9rem; text-align: center; padding: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align: right; color: var(--accent);">ğŸ‘¥ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹</h2>

    <div class="section-card">
        <h3>ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù„Ø§Ø¹Ø¨</h3>
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Ø£Ø¯Ø®Ù„ ID Ø§Ù„Ù„Ø§Ø¹Ø¨ (IMP-XXXX-XXXX)">
            <button class="btn btn-add" onclick="handleSearch()"><i class="fas fa-search"></i></button>
        </div>
        <div id="searchProfile"></div>
    </div>

    <div class="section-card">
        <h3>ğŸ“© Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµØ¯Ø§Ù‚Ø© <span id="reqBadge" class="btn-danger" style="padding: 2px 8px; border-radius: 20px; font-size: 0.8rem; display:none;">0</span></h3>
        <div id="requestsList"></div>
    </div>

    <div class="section-card">
        <h3>ğŸ® Ø£ØµØ¯Ù‚Ø§Ø¦ÙŠ</h3>
        <div id="friendsList"></div>
    </div>
</div>

<script>
    // Ø´Ø§Ø±Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†Ø·Ù‚ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù„Ø±Ø¨Ø·Ù‡Ø§ Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…)
    function getBadgesHTML(userData) {
        let html = '';
        if (userData.proExpiryTime > Date.now()) {
            html += `<i class="fas fa-crown badge-icon pro-badge" title="Ø¹Ø¶Ùˆ Pro"></i>`;
        }
        if (userData.level >= 10) {
            html += `<i class="fas fa-fire badge-icon" style="color:#fb923c" title="Ù„Ø§Ø¹Ø¨ Ù…Ø®Ø¶Ø±Ù…"></i>`;
        }
        // Ø´Ø§Ø±Ø© Ø§Ù„Ù…Ø·ÙˆØ± (Ù…Ø«Ø§Ù„ ÙŠØ¯ÙˆÙŠ)
        if (userData.email === "admin@example.com") {
            html += `<i class="fas fa-code badge-icon dev-badge" title="Ù…Ø·ÙˆØ±"></i>`;
        }
        return html;
    }

    // --- ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø¨Ø­Ø« ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ ---
    async function handleSearch() {
        const query = document.getElementById('searchInput').value.trim();
        const profileDiv = document.getElementById('searchProfile');
        profileDiv.innerHTML = '<p class="empty-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</p>';

        const results = await searchUsersByDisplayName(query);
        
        if (results.length > 0) {
            const user = results[0];
            profileDiv.innerHTML = `
                <div class="profile-result">
                    <div class="avatar-container">
                        <div class="avatar">${user.displayName.charAt(0)}</div>
                    </div>
                    <div style="flex:1">
                        <div style="font-weight:bold">${user.displayName} ${getBadgesHTML(user)}</div>
                        <div style="font-size:0.8rem; color:#94a3b8">${user.publicUid}</div>
                    </div>
                    <button class="btn btn-add" onclick="sendReq('${user.uid}')" title="Ø¥Ø¶Ø§ÙØ© ØµØ¯ÙŠÙ‚">
                        <i class="fas fa-user-plus"></i>
                    </button>
                </div>`;
        } else {
            profileDiv.innerHTML = '<p class="empty-text">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù„Ø§Ø¹Ø¨ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù€ ID</p>';
        }
    }

    async function sendReq(uid) {
        const ok = await sendFriendRequest(uid);
        if (ok) alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØµØ¯Ø§Ù‚Ø©!");
    }

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù‡Ù†Ø§) ---
    function initRequestsListener() {
        const myId = getCurrentUserId();
        db.collection("friendRequests")
          .where("receiverId", "==", myId)
          .where("status", "==", "pending")
          .onSnapshot(async (snapshot) => {
              const listDiv = document.getElementById('requestsList');
              const badge = document.getElementById('reqBadge');
              
              if (snapshot.empty) {
                  listDiv.innerHTML = '<p class="empty-text">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</p>';
                  badge.style.display = 'none';
                  return;
              }

              badge.innerText = snapshot.size;
              badge.style.display = 'inline';
              listDiv.innerHTML = '';

              // Ø§Ø³ØªØ®Ø¯Ø§Ù… Promise.all Ù„Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø³Ù„ÙŠÙ† Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©
              const requests = await Promise.all(snapshot.docs.map(async (doc) => {
                  const data = doc.data();
                  const userSnap = await db.collection("users").doc(data.senderId).get();
                  return { id: doc.id, senderData: userSnap.data(), senderId: data.senderId };
              }));

              requests.forEach(req => {
                  listDiv.innerHTML += `
                    <div class="list-item">
                        <div style="font-weight:bold">${req.senderData.displayName}</div>
                        <div style="display:flex; gap:5px">
                            <button class="btn btn-success" onclick="acceptFriendRequest('${req.id}', '${req.senderId}')"><i class="fas fa-check"></i></button>
                            <button class="btn btn-danger" onclick="rejectFriendRequest('${req.id}')"><i class="fas fa-times"></i></button>
                        </div>
                    </div>`;
              });
          });
    }

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ ÙˆØ§Ù„Ø­Ø§Ù„Ø© ---
    function initFriendsListener() {
        const myId = getCurrentUserId();
        db.collection("users").doc(myId).onSnapshot(async (doc) => {
            const data = doc.data();
            const friendsList = document.getElementById('friendsList');
            const friendIds = data.players || [];

            if (friendIds.length === 0) {
                friendsList.innerHTML = '<p class="empty-text">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø£ØµØ¯Ù‚Ø§Ø¡ Ø¨Ø¹Ø¯</p>';
                return;
            }

            friendsList.innerHTML = '';
            
            for (const fId of friendIds) {
                const fDoc = await db.collection("users").doc(fId).get();
                const fData = fDoc.data();
                const isOnline = fData.isOnline === true;

                friendsList.innerHTML += `
                    <div class="list-item">
                        <div>
                            <span class="status-dot ${isOnline ? 'online' : 'offline'}"></span>
                            <span>${fData.displayName}</span>
                            ${getBadgesHTML(fData)}
                        </div>
                        <div style="font-size:0.7rem; color:#64748b">
                            ${isOnline ? 'Ù†Ø´Ø· Ø§Ù„Ø¢Ù†' : 'Ø£ÙˆÙÙ„Ø§ÙŠÙ†'}
                        </div>
                    </div>`;
            }
        });
    }

    // Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„
    firebase.auth().onAuthStateChanged(user => {
        if (user) {
            initRequestsListener();
            initFriendsListener();
        } else {
            window.location.href = "auth.html";
        }
    });
</script>

</body>
</html>
