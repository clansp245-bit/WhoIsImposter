<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø¯Ø§ÙŠØ§ - Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ø¯Ù†ÙŠ Ø§Ù„Ù…Ø­ØªØ§Ù„</title>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="auth.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
body { font-family: 'Cairo', sans-serif; background:#0f172a; color:#f1f5f9; text-align:center; padding:20px; min-height:100vh; }
h1 { font-size:2rem; color:#34d399; margin-bottom:20px; }
.card { background:#1e293b; padding:20px; border-radius:12px; margin:15px auto; max-width:500px; text-align:right; }
input, select { width: 100%; padding:10px; border-radius:8px; border:none; margin-bottom:10px; background:#334155; color:white; }
button { padding:10px; width:100%; border:none; border-radius:8px; font-weight:700; cursor:pointer; margin-top:5px; }
.send-btn { background:#34d399; color:white; }
.send-btn:hover { background:#10b981; }
.loading { color:#94a3b8; padding:10px; }
.player-item { display:flex; justify-content:space-between; align-items:center; padding:8px; border-bottom:1px solid #334155; }
.alert { color:#ffcc00; font-size:0.9rem; margin-top:10px; }
</style>
</head>

<body onload="initPage()">

<h1>ğŸ Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø¯Ø§ÙŠØ§ Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</h1>

<div class="card">
    <label>Ø§Ø¨Ø­Ø« Ø¹Ù† Ù„Ø§Ø¹Ø¨:</label>
    <input type="text" id="player-search" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶">
    <div id="search-results"><p class="loading">Ø£Ø¯Ø®Ù„ 3 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø¨Ø­Ø«</p></div>
</div>

<div class="card">
    <label>Ø§Ø®ØªØ± Ø§Ù„Ù‡Ø¯ÙŠØ©:</label>
    <select id="gift-select"></select>
    <button class="send-btn" id="send-gift-btn" disabled>Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‡Ø¯ÙŠØ©</button>
    <p class="alert" id="gift-alert"></p>
</div>

<div class="card">
    <h3>Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ:</h3>
    <p>Coins: <span id="user-coins">0</span> | XP: <span id="user-xp">0</span> | Ø§Ù„Ù…Ø³ØªÙˆÙ‰: <span id="user-level">1</span></p>
</div>

<script>
let currentUserData = {};
let selectedPlayerId = null;

// ---------------- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ ----------------
const gifts = [
    {name:"ÙˆØ±Ø¯Ø©", cost:10, xp:5},
    {name:"Ø´ÙˆÙƒÙˆÙ„Ø§ØªØ©", cost:20, xp:10},
    {name:"ÙƒØªØ§Ø¨", cost:50, xp:15},
    {name:"Ø³Ø§Ø¹Ø©", cost:80, xp:20},
    {name:"Ø³ÙŠØ§Ø±Ø©", cost:200, xp:50},
    {name:"Ø·Ø§Ø¦Ø±Ø©", cost:500, xp:120},
    {name:"Ù‚Ø§Ø±Ø¨", cost:300, xp:70},
    {name:"ÙƒÙ…Ø¨ÙŠÙˆØªØ±", cost:150, xp:40},
    {name:"Ù‡Ø§ØªÙ", cost:100, xp:30},
    {name:"Ø¯Ø±Ø§Ø¬Ø©", cost:70, xp:20},
    {name:"Ø­Ù‚ÙŠØ¨Ø©", cost:40, xp:15},
    {name:"Ù‚Ø¨Ø¹Ø©", cost:25, xp:10},
    {name:"Ù†Ø¸Ø§Ø±Ø© Ø´Ù…Ø³ÙŠØ©", cost:35, xp:12},
    {name:"Ø­Ù„ÙˆÙŠØ§Øª", cost:15, xp:8},
    {name:"Ø²Ù‡ÙˆØ±", cost:30, xp:15}
];

// ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ ÙÙŠ select
function populateGifts() {
    const select = document.getElementById("gift-select");
    gifts.forEach((g, i) => {
        const option = document.createElement("option");
        option.value = i;
        option.text = `${g.name} (${g.cost} Coins, +${g.xp} XP)`;
        select.add(option);
    });
}

// ---------------- INIT ----------------
async function initPage() {
    populateGifts();
    firebase.auth().onAuthStateChanged(async user => {
        if (!user) return window.location.href = "auth.html";
        const data = await loadUserData();
        if (data) currentUserData = data;
        updateUserDisplay();
        setupSearch();
    });
}

function updateUserDisplay() {
    document.getElementById("user-coins").innerText = currentUserData.totalCoins || 0;
    document.getElementById("user-xp").innerText = currentUserData.xp || 0;
    document.getElementById("user-level").innerText = currentUserData.level || 1;
}

// ---------------- SEARCH ----------------
function setupSearch() {
    const input = document.getElementById("player-search");
    input.addEventListener("input", async () => {
        const q = input.value.trim();
        const resultsDiv = document.getElementById("search-results");
        resultsDiv.innerHTML = '<p class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</p>';
        if (q.length < 3) {
            resultsDiv.innerHTML = '<p class="loading">Ø£Ø¯Ø®Ù„ 3 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø¨Ø­Ø«</p>';
            return;
        }
        const res = await searchUsersByDisplayName(q);
        resultsDiv.innerHTML = "";
        if (!res.length) {
            resultsDiv.innerHTML = "<p class='loading'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p>";
            return;
        }
        res.forEach(u=>{
            const div = document.createElement("div");
            div.className = "player-item";
            div.innerHTML = `<span>${u.displayName}</span><button onclick="selectPlayer('${u.uid}')">Ø§Ø®ØªÙŠØ§Ø±</button>`;
            resultsDiv.appendChild(div);
        });
    });
}

function selectPlayer(uid) {
    selectedPlayerId = uid;
    document.getElementById("send-gift-btn").disabled = false;
    document.getElementById("gift-alert").innerText = "ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨!";
}

// ---------------- SEND GIFT ----------------
document.getElementById("send-gift-btn").addEventListener("click", async () => {
    if (!selectedPlayerId) return;
    const giftIndex = parseInt(document.getElementById("gift-select").value);
    const gift = gifts[giftIndex];
    
    if ((currentUserData.totalCoins || 0) < gift.cost) {
        document.getElementById("gift-alert").innerText = "Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ù…Ø§ ÙŠÙƒÙÙŠ Ù…Ù† Coins!";
        return;
    }

    try {
        // ØªÙ†ÙÙŠØ° Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©
        const senderRef = firebase.firestore().collection("users").doc(firebase.auth().currentUser.uid);
        const recipientRef = firebase.firestore().collection("users").doc(selectedPlayerId);

        await firebase.firestore().runTransaction(async (tx) => {
            const senderDoc = await tx.get(senderRef);
            const recipientDoc = await tx.get(recipientRef);

            if (!senderDoc.exists || !recipientDoc.exists) throw "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";

            // Ø®ØµÙ… Coins Ù…Ù† Ø§Ù„Ù…Ø±Ø³Ù„
            const newSenderCoins = (senderDoc.data().totalCoins || 0) - gift.cost;
            tx.update(senderRef, { totalCoins: newSenderCoins });

            // Ø¥Ø¶Ø§ÙØ© XP Ù„Ù„Ù…Ø³ØªÙ„Ù…
            const newRecipientXP = (recipientDoc.data().xp || 0) + gift.xp;
            tx.update(recipientRef, { xp: newRecipientXP });
        });

        // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ù„ÙŠ
        currentUserData.totalCoins -= gift.cost;
        updateUserDisplay();

        document.getElementById("gift-alert").innerText = `ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ${gift.name} Ø¨Ù†Ø¬Ø§Ø­! +${gift.xp} XP Ù„Ù„Ù…Ø³ØªÙ„Ù…`;
    } catch(e) {
        console.error(e);
        document.getElementById("gift-alert").innerText = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‡Ø¯ÙŠØ©!";
    }
});
</script>

</body>
</html>
