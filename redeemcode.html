<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„ÙƒÙˆØ¯</title>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="auth.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">

<style>
body{
  font-family:'Cairo',sans-serif;
  background:#0f172a;
  color:#f1f5f9;
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:20px;
  min-height:100vh;
}
.card{
  background:#1e293b;
  padding:25px;
  border-radius:12px;
  width:90%;
  max-width:400px;
}
h2{text-align:center;color:#34d399;margin-bottom:20px;}
label{display:block;margin-top:12px;}
input{width:100%;margin-top:6px;padding:10px;border-radius:8px;border:1px solid #334155;background:#334155;color:#fff;}
button{
  margin-top:12px;
  padding:10px;
  border:none;
  border-radius:8px;
  background:#6366f1;
  color:#fff;
  cursor:pointer;
}
button:hover{background:#4f46e5;}
.msg{margin-top:12px;text-align:center;color:#ffd700;}
</style>
</head>
<body>

<h2>ğŸ Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„ÙƒÙˆØ¯</h2>

<div class="card">
  <label>Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯</label>
  <input type="text" id="promocode" placeholder="Ù…Ø«Ø§Ù„: FREE100">
  <button id="redeemBtn">Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„ÙƒÙˆØ¯</button>
  <div id="msg" class="msg"></div>
</div>

<script>
firebase.auth().onAuthStateChanged(user=>{
  if(!user){ location.href="auth.html"; return; }

  const db = firebase.firestore();
  const msgDiv = document.getElementById("msg");

  document.getElementById("redeemBtn").onclick = async () => {
    const code = document.getElementById("promocode").value.trim().toUpperCase();
    if(!code){ msgDiv.textContent="âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ ØµØ§Ù„Ø­"; return; }

    try{
      const codeRef = db.collection("promocodes").doc(code);
      await db.runTransaction(async t=>{
        const doc = await t.get(codeRef);
        if(!doc.exists) throw "âŒ Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯";
        const data = doc.data();
        if(data.active===false) throw "â›” Ø§Ù„ÙƒÙˆØ¯ Ù…Ø¹Ø·Ù„";
        const usedBy = data.redeemedBy || [];
        const maxUses = data.maxUses || Infinity;
        const usedCount = data.usedCount || 0;
        if(usedBy.includes(user.uid)) throw "âš ï¸ Ù„Ù‚Ø¯ Ø§Ø³ØªØ®Ø¯Ù…Øª Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§";
        if(usedCount >= maxUses) throw "âŒ› Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙƒÙˆØ¯ (ÙˆØµÙ„ Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰)";

        // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const userRef = db.collection("users").doc(user.uid);
        const userDoc = await t.get(userRef);
        let userData = userDoc.exists ? userDoc.data() : {totalCoins:0, proExpiryTime:0};

        const now = Date.now();
        if(data.coins && data.coins>0){
          userData.totalCoins = (userData.totalCoins||0) + data.coins;
          msgDiv.textContent = `ğŸ‰ ØªÙ… Ø¥Ø¶Ø§ÙØ© ${data.coins} ÙƒÙˆÙŠÙ†Ø² Ù„Ø­Ø³Ø§Ø¨Ùƒ!`;
        }
        if(data.durationDays && data.durationDays>0){
          const currentExpiry = (userData.proExpiryTime > now) ? userData.proExpiryTime : now;
          userData.proExpiryTime = currentExpiry + (data.durationDays*24*60*60*1000);
          msgDiv.textContent += ` ğŸ‰ ØªÙ… ØªÙØ¹ÙŠÙ„ Ø¹Ø¶ÙˆÙŠØ© Pro Ù„Ù…Ø¯Ø© ${data.durationDays} ÙŠÙˆÙ…Ù‹Ø§!`;
        }

        // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        t.set(userRef,userData,{merge:true});

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙˆØ¯
        t.update(codeRef,{
          usedCount: firebase.firestore.FieldValue.increment(1),
          redeemedBy: firebase.firestore.FieldValue.arrayUnion(user.uid)
        });
      });

      document.getElementById("promocode").value = "";
    }catch(err){
      msgDiv.textContent = typeof err === "string"? err : "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯";
      console.error(err);
    }
  };
});
</script>

</body>
</html>


