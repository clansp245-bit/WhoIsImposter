<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©</title>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="auth.js"></script> 

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        :root {
            --primary: #6366f1;
            --accent: #34d399;
            --glass-bg: rgba(30, 41, 59, 0.6);
            --glass-border: rgba(255, 255, 255, 0.1);
            --gold: #ffd700;
            --gem-color: #00d2ff;
            --xp-color: #a855f7;
            --rarity-dev: linear-gradient(45deg, #ff4757, #990000);
            --rarity-pro: linear-gradient(45deg, #ffd700, #b8860b); 
            --rarity-rich: linear-gradient(45deg, #2ecc71, #27ae60);
            --rarity-gem: linear-gradient(45deg, #00d2ff, #3a7bd5);
            --rarity-fire: linear-gradient(45deg, #f093fb, #f5576c);
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: #0a0f1e;
            background-image: radial-gradient(circle at top right, #1e1b4b, transparent);
            color: #f1f5f9; padding: 20px; min-height: 100vh;
            display: flex; flex-direction: column; align-items: center; margin: 0;
        }

        /* Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙ„ØªØ±Ø© */
        .filter-tabs {
            display: flex; background: var(--glass-bg); border-radius: 15px;
            padding: 5px; margin-bottom: 25px; border: 1px solid var(--glass-border);
            width: 100%; max-width: 500px;
        }
        .filter-btn {
            flex: 1; padding: 12px; border: none; background: transparent;
            color: #94a3b8; cursor: pointer; font-family: 'Cairo'; font-weight: bold;
            transition: 0.3s; border-radius: 12px; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .filter-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3); }
        .filter-btn.active.btn-coins { background: #eab308; }
        .filter-btn.active.btn-gems { background: #06b6d4; }
        .filter-btn.active.btn-xp { background: #a855f7; }

        .leaderboard-card {
            background: var(--glass-bg); backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border); padding: 25px; border-radius: 24px;
            width: 100%; max-width: 600px; min-height: 400px;
        }

        .player-item {
            display: flex; align-items: center; background: rgba(255, 255, 255, 0.03);
            margin-bottom: 12px; padding: 12px 15px; border-radius: 18px;
            transition: 0.3s; cursor: pointer; border: 1px solid transparent;
        }
        .player-item:hover { 
            background: rgba(255, 255, 255, 0.08); transform: scale(1.02);
            border-color: var(--primary);
        }

        .rank { width: 40px; font-weight: 900; color: var(--accent); font-size: 1.2rem; }
        .rank-1 { color: #ffd700; }
        .rank-2 { color: #c0c0c0; }
        .rank-3 { color: #cd7f32; }

        .avatar-frame {
            width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--primary);
            margin-left: 12px; overflow: hidden; background: #1e293b;
            display: flex; align-items: center; justify-content: center; flex-shrink: 0;
        }
        .avatar-frame img { width: 100%; height: 100%; object-fit: cover; }

        .info { flex-grow: 1; min-width: 0; }
        .name { font-weight: 700; color: #fff; font-size: 1rem; margin-bottom: 4px; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        .badges-list { display: flex; gap: 5px; }
        .badge-circle {
            width: 22px; height: 22px; border-radius: 50%; display: flex; 
            align-items: center; justify-content: center; font-size: 0.65rem;
            border: 1px solid rgba(255,255,255,0.2); flex-shrink: 0;
        }

        .value { font-weight: 900; font-size: 1rem; }
        .val-coins { color: var(--gold); }
        .val-gems { color: var(--gem-color); }
        .val-xp { color: var(--xp-color); }

        /* Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù„Ù„Ø´Ø§Ø±Ø§Øª */
        .bg-dev { background: var(--rarity-dev); }
        .bg-pro { background: var(--rarity-pro); }
        .bg-rich { background: var(--rarity-rich); }
        .bg-gem-rich { background: var(--rarity-gem); }
        .bg-fire { background: var(--rarity-fire); }

        /* Modal */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; align-items: center; justify-content: center; }
        .modal-content { background: #1e293b; width: 90%; max-width: 400px; border-radius: 30px; padding: 30px; text-align: center; border: 1px solid var(--primary); }
    </style>
</head>
<body>

    <h2 style="font-weight: 900; margin: 20px 0;"><i class="fas fa-trophy text-gold"></i> Ù‚Ù…Ø© Ø§Ù„Ø£Ø³Ø§Ø·ÙŠØ±</h2>

    <div class="filter-tabs">
        <button class="filter-btn active btn-coins" onclick="switchTab('totalCoins', this)">
            <i class="fas fa-coins"></i> ÙƒÙˆÙŠÙ†Ø²
        </button>
        <button class="filter-btn btn-gems" onclick="switchTab('s_gems', this)">
            <i class="fas fa-gem"></i> Ø¬ÙˆØ§Ù‡Ø±
        </button>
        <button class="filter-btn btn-xp" onclick="switchTab('xp', this)">
            <i class="fas fa-bolt"></i> Ø§Ù„Ø®Ø¨Ø±Ø©
        </button>
    </div>

    <div class="leaderboard-card">
        <div id="list-container">
            <div style="text-align:center; padding: 50px;"><i class="fas fa-spinner fa-spin fa-2x"></i></div>
        </div>
    </div>

    <div id="profileModal" class="modal" onclick="if(event.target == this) closeModal()">
        <div class="modal-content">
            <div id="modal-body"></div>
            <button onclick="closeModal()" style="margin-top:20px; width:100%; padding:12px; border-radius:10px; background:var(--primary); color:white; border:none; cursor:pointer;">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

<script>
    const BADGES_CONFIG = {
        "dev_badge": { icon: "fa-code", bg: "bg-dev" },
        "pro_badge": { icon: "fa-crown", bg: "bg-pro" },
        "rich_badge": { icon: "fa-money-bill-trend-up", bg: "bg-rich" },
        "gem_rich_badge": { icon: "fa-gem", bg: "bg-gem-rich" },
        "blue_fire_badge": { icon: "fa-fire-flame-curved", bg: "bg-fire" }
    };

    let currentField = 'totalCoins';
    let topLists = { totalCoins: [], s_gems: [], xp: [] };

    async function loadData() {
        try {
            const usersRef = db.collection('users');
            // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø«Ù„Ø§Ø« ØªØµÙ†ÙŠÙØ§Øª Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø´Ø§Ø±Ø§Øª Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
            const [cSnap, gSnap, xSnap] = await Promise.all([
                usersRef.orderBy('totalCoins', 'desc').limit(10).get(),
                usersRef.orderBy('s_gems', 'desc').limit(10).get(),
                usersRef.orderBy('xp', 'desc').limit(10).get()
            ]);

            topLists.totalCoins = cSnap.docs.map(d => d.id);
            topLists.s_gems = gSnap.docs.map(d => d.id);
            topLists.xp = xSnap.docs.map(d => d.id);

            renderLeaderboard(currentField === 'totalCoins' ? cSnap : (currentField === 's_gems' ? gSnap : xSnap));
        } catch (e) { console.error(e); }
    }

    function renderLeaderboard(snapshot) {
        const container = document.getElementById('list-container');
        container.innerHTML = "";
        let rank = 1;

        snapshot.forEach(doc => {
            const user = doc.data();
            const userId = doc.id;
            const val = user[currentField] || 0;

            const item = document.createElement('div');
            item.className = 'player-item';
            item.onclick = () => openProfile(user, userId);

            // ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„ÙÙ„ØªØ±
            let iconClass = "fa-coins val-coins";
            if(currentField === 's_gems') iconClass = "fa-gem val-gems";
            if(currentField === 'xp') iconClass = "fa-bolt val-xp";

            item.innerHTML = `
                <span class="rank rank-${rank}">#${rank++}</span>
                <div class="avatar-frame">
                    ${user.photoURL ? `<img src="${user.photoURL}">` : `<i class="fas fa-user" style="color:#fff"></i>`}
                </div>
                <div class="info">
                    <span class="name">${user.displayName || 'Ù„Ø§Ø¹Ø¨'}</span>
                    <div class="badges-list">${getAutoBadgesHTML(user, userId)}</div>
                </div>
                <div class="value ${iconClass.split(' ')[1]}">
                    ${val.toLocaleString()} <i class="fas ${iconClass.split(' ')[0]}"></i>
                </div>
            `;
            container.appendChild(item);
        });
    }

    function getAutoBadgesHTML(user, uid) {
        let html = "";
        const isOwner = (uid === "REX-999" || user.email === "clansp245@gmail.com");
        const equipped = user.equippedBadges || [];

        // 1. Ø´Ø§Ø±Ø© Ø§Ù„Ù…Ø·ÙˆØ±
        if(isOwner) html += createBadge('dev_badge');

        // 2. Ø§Ù„Ø´Ø§Ø±Ø§Øª Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© (ØªØ¸Ù‡Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø´Ø®Øµ Ø¶Ù…Ù† Ø§Ù„ØªÙˆØ¨ 10)
        if(topLists.totalCoins.includes(uid)) html += createBadge('rich_badge');
        if(topLists.s_gems.includes(uid)) html += createBadge('gem_rich_badge');
        if(topLists.xp.includes(uid)) html += createBadge('blue_fire_badge');
        
        // 3. Ø´Ø§Ø±Ø© Ø¨Ø±Ùˆ (ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®)
        if(user.proExpiryTime > Date.now()) html += createBadge('pro_badge');

        // 4. Ø§Ù„Ø´Ø§Ø±Ø§Øª Ø§Ù„ÙŠØ¯ÙˆÙŠØ© Ø§Ù„Ù…Ø¬Ù‡Ø²Ø© Ø§Ù„Ø£Ø®Ø±Ù‰
        equipped.forEach(b => {
            if(!['dev_badge','rich_badge','gem_rich_badge','blue_fire_badge','pro_badge'].includes(b)) {
                html += createBadge(b);
            }
        });

        return html;
    }

    function createBadge(id) {
        const config = BADGES_CONFIG[id] || {icon: "fa-medal", bg: "bg-rare"};
        return `<div class="badge-circle ${config.bg}"><i class="fas ${config.icon}" style="color:white"></i></div>`;
    }

    async function switchTab(field, btn) {
        currentField = field;
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('list-container').innerHTML = '<div style="text-align:center; padding: 50px;"><i class="fas fa-spinner fa-spin fa-2x"></i></div>';
        
        const snap = await db.collection('users').orderBy(field, 'desc').limit(10).get();
        renderLeaderboard(snap);
    }

    function openProfile(user, uid) {
        const modalBody = document.getElementById('modal-body');
        const level = Math.floor(Math.sqrt((user.xp || 0) / 100)) + 1;
        modalBody.innerHTML = `
            <div style="width:100px; height:100px; border-radius:50%; border:4px solid var(--primary); margin:0 auto 15px; overflow:hidden; background:#000;">
                <img src="${user.photoURL || ''}" style="width:100%; height:100%; object-fit:cover; ${!user.photoURL ? 'display:none' : ''}">
                ${!user.photoURL ? '<i class="fas fa-user" style="font-size:3rem; color:white; margin-top:20px;"></i>' : ''}
            </div>
            <h2 style="margin:0">${user.displayName || 'Ù„Ø§Ø¹Ø¨'}</h2>
            <p style="color:#94a3b8; font-size:0.8rem">ID: ${user.customID || user.publicUid || '---'}</p>
            <div style="display:flex; justify-content:center; gap:10px; margin:15px 0">${getAutoBadgesHTML(user, uid)}</div>
            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; background:rgba(0,0,0,0.3); padding:15px; border-radius:15px;">
                <div><small>Ø§Ù„Ù…Ø³ØªÙˆÙ‰</small><br><b>${level}</b></div>
                <div><small>Ø¬ÙˆØ§Ù‡Ø±</small><br><b style="color:var(--gem-color)">${(user.s_gems || 0)}</b></div>
                <div><small>ÙƒÙˆÙŠÙ†Ø²</small><br><b style="color:var(--gold)">${(user.totalCoins || 0)}</b></div>
            </div>
        `;
        document.getElementById('profileModal').style.display = 'flex';
    }

    function closeModal() { document.getElementById('profileModal').style.display = 'none'; }

    auth.onAuthStateChanged(user => { if(user) loadData(); });
</script>
</body>
</html>
