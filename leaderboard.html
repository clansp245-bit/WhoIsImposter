<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†</title>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script src="auth.js"></script> 

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
:root {
    --bg-dark: #0f172a;
    --card-dark: #1e293b;
    --accent-color: #34d399;
    --gold-color: #ffd700;
    --pro-border: #ffd700;
    --admin-bg: #4f46e5;
}
body {
    font-family: 'Cairo', sans-serif;
    background: var(--bg-dark);
    color: #f1f5f9;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    min-height: 100vh;
}
h2 {
    color: var(--accent-color);
    margin-bottom: 30px;
}
.leaderboard-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 30px;
    width: 90%;
    max-width: 1200px;
}
.leaderboard-card {
    background: var(--card-dark);
    padding: 20px;
    border-radius: 12px;
    width: 100%;
    max-width: 500px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}
h3 {
    text-align: center;
    color: var(--gold-color);
    margin-bottom: 20px;
    border-bottom: 2px solid #334155;
    padding-bottom: 10px;
}
.player-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 15px;
    margin-bottom: 8px;
    border-radius: 8px;
    background: #334155;
    transition: transform 0.2s, box-shadow 0.2s;
    font-size: 1rem;
    position: relative;
    overflow: hidden;
}
.player-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
}
.rank {
    font-size: 1.2rem;
    font-weight: bold;
    color: var(--accent-color);
    width: 30px;
    text-align: center;
}
.info {
    flex-grow: 1;
    margin-right: 15px;
}
.name {
    font-weight: bold;
    color: #f8fafc;
}
.public-uid {
    font-size: 0.8rem;
    color: #94a3b8;
    display: block;
}
.value {
    font-size: 1.1rem;
    font-weight: bold;
    color: var(--gold-color);
}

/* ØªÙ…ÙŠÙŠØ² Ø­Ø§Ù„Ø© PRO */
.player-item.pro {
    border: 2px solid var(--pro-border);
    background: #334155; /* Ø®Ù„ÙÙŠØ© Ø«Ø§Ø¨ØªØ© Ù„ØªØ¸Ù‡Ø± Ø§Ù„Ø¥Ø·Ø§Ø± */
    padding-right: 25px;
}
.player-item.pro::after {
    content: "â­ PRO";
    position: absolute;
    left: 0;
    top: 0;
    background: var(--pro-border);
    color: var(--bg-dark);
    padding: 2px 5px;
    font-size: 0.7rem;
    border-radius: 0 0 8px 0;
    font-weight: bold;
}

/* ØªÙ…ÙŠÙŠØ² Ø§Ù„Ù…Ø·ÙˆØ±/Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ */
.player-item.admin {
    background: var(--admin-bg);
    border: 2px solid #f8fafc;
    box-shadow: 0 0 10px var(--admin-bg);
}
.player-item.admin .name {
    color: var(--gold-color);
}
.player-item.admin::before {
    content: "ğŸ‘‘ DEVELOPER";
    position: absolute;
    right: 0;
    top: 0;
    background: #dc2626;
    color: #fff;
    padding: 2px 5px;
    font-size: 0.7rem;
    border-radius: 0 8px 0 8px;
    font-weight: bold;
}
</style>
</head>
<body>

<h2><i class="fas fa-trophy"></i> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† (Leaderboard)</h2>

<div id="loading" style="text-align: center; margin-top: 50px;">
    <i class="fas fa-spinner fa-spin fa-3x" style="color: var(--accent-color);"></i>
    <p style="margin-top: 15px;">ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†...</p>
</div>

<div class="leaderboard-container">
    <div id="coins-leaderboard" class="leaderboard-card">
        <h3><i class="fas fa-coins"></i> Ø§Ù„Ø£Ø¹Ù„Ù‰ ÙƒÙˆÙŠÙ†Ø²</h3>
    </div>
    
    <div id="xp-leaderboard" class="leaderboard-card">
        <h3><i class="fas fa-star"></i> Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø®Ø¨Ø±Ø© (XP)</h3>
    </div>
</div>

<script>
// Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ db Ø¹Ø¨Ø± auth.js
if (typeof db === 'undefined' || typeof isPro === 'undefined') {
    document.getElementById('loading').innerHTML = '<p style="color: #ef4444;">âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Firebase: ØªØ£ÙƒØ¯ Ù…Ù† ØªØ¶Ù…ÙŠÙ† Ù…Ù„Ù auth.js Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.</p>';
}

const ADMIN_EMAIL = "clansp245@gmail.com";
const COINS_LIMIT = 10;
const XP_LIMIT = 10;
const usersRef = db.collection('users');

/**
 * Ø¯Ø§Ù„Ø© Ù„Ø±Ø³Ù… Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†
 * @param {string} containerId - ID Ù„Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø­Ø§ÙˆÙŠ (Ù…Ø«Ù„ 'coins-leaderboard')
 * @param {Array<Object>} data - Ù…ØµÙÙˆÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
 * @param {string} valueField - Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¹Ø±Ø¶Ù‡ (Ù…Ø«Ù„ 'totalCoins')
 */
function renderLeaderboard(containerId, data, valueField) {
    const container = document.getElementById(containerId);
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
    const title = container.querySelector('h3');
    container.innerHTML = '';
    container.appendChild(title);
    
    if (data.length === 0) {
        container.innerHTML += '<p style="text-align: center; color: #94a3b8;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶.</p>';
        return;
    }

    data.forEach((user, index) => {
        let classes = 'player-item';
        
        // 1. ØªÙ…ÙŠÙŠØ² Pro
        if (isPro(user)) {
            classes += ' pro';
        }

        // 2. ØªÙ…ÙŠÙŠØ² Ø§Ù„Ù…Ø·ÙˆØ±
        if (user.email === ADMIN_EMAIL) {
            classes += ' admin';
        }

        const playerDiv = document.createElement('div');
        playerDiv.className = classes;
        
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ù„Ø© Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¥Ù„Ù‰ Ù†Øµ Ù…Ø¨Ø³Ø· (Ù…Ø«Ù„Ø§Ù‹: 123456 -> 123,456)
        const formattedValue = new Intl.NumberFormat().format(user[valueField]);

        playerDiv.innerHTML = `
            <span class="rank">${index + 1}</span>
            <div class="info">
                <span class="name">${user.displayName || 'Ù…Ø³ØªØ®Ø¯Ù…'}</span>
                <span class="public-uid">${user.publicUid || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ID'}</span>
            </div>
            <span class="value">
                ${formattedValue} 
                <i class="${valueField === 'totalCoins' ? 'fas fa-coins' : 'fas fa-star'}"></i>
            </span>
        `;
        container.appendChild(playerDiv);
    });
}

/**
 * Ø¯Ø§Ù„Ø© Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firestore
 * @param {string} orderByField - Ø§Ù„Ø­Ù‚Ù„ Ù„Ù„ØªØ±ØªÙŠØ¨ (Ù…Ø«Ù„ 'totalCoins' Ø£Ùˆ 'xp')
 * @param {number} limit - Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ù†ØªØ§Ø¦Ø¬
 */
async function fetchLeaderboard(orderByField, limit) {
    try {
        const snapshot = await usersRef
            .orderBy(orderByField, 'desc')
            .limit(limit)
            .get();
        
        const data = [];
        snapshot.forEach(doc => {
            // Ø¥Ø¶Ø§ÙØ© Firebase UID Ø¯Ø§Ø®Ù„ ÙƒØ§Ø¦Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ù…Ø¹ Ø§Ù„Ù…Ø·ÙˆØ±
            data.push({ ...doc.data(), uid: doc.id }); 
        });
        return data;
        
    } catch (error) {
        console.error(`Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ù…ØªØµØ¯Ø±ÙŠÙ† ${orderByField}:`, error);
        if (error.code === 'permission-denied') {
             alert(`âŒ Ø®Ø·Ø£ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª: ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù‚ÙˆØ§Ø¹Ø¯ Firestore ØªØ³Ù…Ø­ Ø¨Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© /users.`);
        }
        return [];
    }
}

async function loadLeaderboards() {
    document.getElementById('loading').style.display = 'block';

    // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ Ù…ØªÙˆØ§Ø²Ù
    const [coinsData, xpData] = await Promise.all([
        fetchLeaderboard('totalCoins', COINS_LIMIT),
        fetchLeaderboard('xp', XP_LIMIT)
    ]);
    
    document.getElementById('loading').style.display = 'none';

    // 1. Ø±Ø³Ù… Ù„ÙˆØ­Ø© Ø§Ù„ÙƒÙˆÙŠÙ†Ø²
    renderLeaderboard('coins-leaderboard', coinsData, 'totalCoins');
    
    // 2. Ø±Ø³Ù… Ù„ÙˆØ­Ø© Ø§Ù„Ø®Ø¨Ø±Ø©
    renderLeaderboard('xp-leaderboard', xpData, 'xp');
}

// Ø§Ø¨Ø¯Ø£ Ø¨ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† Ø¨Ù…Ø¬Ø±Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ ØªÙ‡ÙŠØ¦Ø© Firebase
firebase.auth().onAuthStateChanged(user => {
    // ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ù„Ø±Ø¤ÙŠØ© Ø§Ù„ØµÙØ­Ø© (Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù‚ÙˆØ§Ø¹Ø¯Ùƒ)
    if (user) {
        loadLeaderboards();
    } else {
        document.body.innerHTML = "<h2 style='color:#ffd700;'>ğŸ›‘ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†.</h2>";
    }
});

</script>
</body>
</html>

