<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸšª Ø§Ù„Ø¯Ø®ÙˆÙ„/Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©</title>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="auth.js"></script> 

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
/* CSS Styles */
#home-icon { position: absolute; top: 20px; left: 20px; font-size: 24px; color: #94a3b8; cursor: pointer; transition: color 0.3s; }
#home-icon:hover { color: #34d399; }
body { font-family: 'Cairo', sans-serif; background-color: #0f172a; color: #f1f5f9; text-align: center; padding: 20px; min-height: 100vh; margin: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; }
.card { background-color: #1e293b; padding: 40px; border-radius: 12px; max-width: 400px; width: 90%; margin: 20px auto; box-shadow: 0 8px 15px rgba(0,0,0,0.3); text-align: right; }
h2 { font-size: 2rem; font-weight: 700; margin-bottom: 30px; color: #34d399; }
input[type="text"] { font-family: 'Cairo', sans-serif; width: 100%; padding: 15px; margin: 10px 0 20px 0; border-radius: 8px; border: 1px solid #334155; font-size: 18px; background-color: #334155; color: #f1f5f9; box-sizing: border-box; text-align: center; }
button { margin-top: 15px; padding: 14px 30px; font-size: 18px; font-weight: 700; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.3s, transform 0.2s; width: 100%; box-shadow: 0 2px 4px rgba(0,0,0,0.15); }
#create-btn { background-color: #6366f1; color: #ffffff; }
#create-btn:hover { background-color: #4f46e5; transform: translateY(-2px); }
#join-btn { background-color: #34d399; color: #0f172a; }
#join-btn:hover { background-color: #10b981; transform: translateY(-2px); }
.separator { text-align: center; margin: 25px 0; color: #94a3b8; font-weight: 700; }
#error-msg { color: #ff4f4f; margin-top: 15px; text-align: center; font-weight: 700; }
</style>
</head>

<body>

<a href="index.html" id="home-icon" title="Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">
    <i class="fas fa-arrow-right"></i>
</a>

<div class="card">
    <h2>Ø§Ù†Ø¶Ù…Ø§Ù… Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©</h2>

    <button id="create-btn" onclick="createRoom()">
        <i class="fas fa-plus-circle"></i> Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©
    </button>
    
    <div class="separator">Ø£Ùˆ</div>

    <label for="room-code" style="color:#f1f5f9; margin-bottom: 10px;">Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©:</label>
    <input type="text" id="room-code" maxlength="6" placeholder="Ù…Ø«Ù„Ø§Ù‹: XYZ123">
    
    <button id="join-btn" onclick="joinRoom()">
        <i class="fas fa-sign-in-alt"></i> Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ©
    </button>
    
    <div id="error-msg"></div>
</div>

<script>
let currentUserData = {};
let currentUID;
let isUserDataLoaded = false; 

// ğŸš¨ ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªØ­Ù‚Ù‚ ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„ - ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ auth.js
auth.onAuthStateChanged(async (user) => {
    if (!user) {
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ØŒ Ø£Ø¹Ø¯ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡
        window.location.href = "auth.html";
        return;
    }
    currentUID = user.uid;
    
    try {
        const data = await loadUserData(); 
        if(data) {
            currentUserData = data;
        } else {
             // ØªØ¹ÙŠÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ
            currentUserData.settings = { impostors: 1, selectedCategories: ['objects'] }; 
            currentUserData.playerName = `Ù„Ø§Ø¹Ø¨#${currentUID.substring(0, 4)}`; // ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ playerName ÙÙŠ auth.js
        }
    } catch (e) {
        console.error("ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", e);
        // Ø¨ÙŠØ§Ù†Ø§Øª Ø·ÙˆØ§Ø±Ø¦
        currentUserData.settings = { impostors: 1, selectedCategories: ['objects'] }; 
        currentUserData.playerName = `Ù„Ø§Ø¹Ø¨#${currentUID.substring(0, 4)}`;
    }
    isUserDataLoaded = true;
});

/**
 * @function generateRoomCode
 * @description ØªÙˆÙ„ÙŠØ¯ Ø±Ù…Ø² ÙØ±ÙŠØ¯ Ù„Ù„ØºØ±ÙØ© Ù…ÙƒÙˆÙ† Ù…Ù† 6 Ø£Ø­Ø±Ù ÙƒØ¨ÙŠØ±Ø©.
 */
function generateRoomCode() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ13579';
    let code = '';
    for (let i = 0; i < 6; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return code;
}

/**
 * @function createRoom
 * @description Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªÙ†Ø¯ Ø¬Ø¯ÙŠØ¯ Ù„Ù„ØºØ±ÙØ© ÙÙŠ Firestore ÙˆÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ùˆ Ø§Ù„Ù…Ø¶ÙŠÙ.
 */
async function createRoom() {
    document.getElementById('error-msg').innerText = 'Ø¬Ø§Ø±ÙŠ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©...';
    
    if (!isUserDataLoaded || !currentUID) {
        document.getElementById('error-msg').innerText = 'âš ï¸ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…. Ø§Ù†ØªØ¸Ø± Ø«ÙˆØ§Ù†Ù ÙˆØ­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹.';
        return;
    }
    
    if (!currentUserData.settings || currentUserData.settings.selectedCategories?.length === 0) {
        document.getElementById('error-msg').innerText = 'âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¶Ø¨Ø· Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ø®ØªÙŠØ§Ø± Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø£ÙˆÙ„Ø§Ù‹.';
        return;
    }
    
    let roomCode;
    let roomRef;
    let attempts = 0;
    
    while (attempts < 5) {
        roomCode = generateRoomCode();
        roomRef = db.collection('rooms').doc(roomCode);
        
        try {
            document.getElementById('error-msg').innerText = `Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù…Ø²: ${roomCode}`;
            const doc = await roomRef.get();
            if (!doc.exists) {
                break; 
            }
            attempts++;
        } catch (error) {
            console.error("âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firestore Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù…Ø²:", error);
            document.getElementById('error-msg').innerText = `âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø¯Ù…Ø©. ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ ÙˆÙ‚ÙˆØ§Ø¹Ø¯ Ø£Ù…Ø§Ù† Firebase.`;
            return; 
        }
    }

    if (attempts === 5) {
        document.getElementById('error-msg').innerText = 'ÙØ´Ù„ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ Ø±Ù…Ø² ØºØ±ÙØ© ÙØ±ÙŠØ¯. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
        return;
    }

    const initialSettings = currentUserData.settings || {}; 
    const playerName = currentUserData.playerName || `Ù„Ø§Ø¹Ø¨#${currentUID.substring(0, 4)}`;

    const roomData = {
        hostUID: currentUID,
        hostName: playerName,
        status: 'waiting', 
        players: [currentUID], 
        playerNames: { [currentUID]: playerName }, 
        settings: initialSettings,
        currentGameData: null,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    try {
        document.getElementById('error-msg').innerText = 'Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØºØ±ÙØ©...';
        await roomRef.set(roomData);
        
        // ğŸš€ Ø§Ù„Ù†Ø¬Ø§Ø­! Ø§Ù„Ø¢Ù† Ù†Ù‚ÙˆÙ… Ø¨Ø§Ù„ØªÙˆØ¬ÙŠÙ‡
        window.location.href = `room.html?id=${roomCode}`; 
    } catch (error) {
        console.error("âŒ ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ© ÙˆØ­ÙØ¸Ù‡Ø§ (Ø±Ø§Ø¬Ø¹ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø§Ù†):", error);
        document.getElementById('error-msg').innerText = `âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ÙØ¸: ${error.message}. ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Ø£Ù…Ø§Ù† Firestore.`;
    }
}


/**
 * @function joinRoom
 * @description Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ ØºØ±ÙØ© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¹Ø¨Ø± Ø§Ù„Ø±Ù…Ø².
 */
async function joinRoom() {
    const codeInput = document.getElementById('room-code');
    const roomCode = codeInput.value.trim().toUpperCase();
    document.getElementById('error-msg').innerText = 'Ø¬Ø§Ø±ÙŠ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…...';

    if (roomCode.length !== 6) {
        document.getElementById('error-msg').innerText = 'âŒ Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù/Ø£Ø±Ù‚Ø§Ù….';
        return;
    }

    if (!isUserDataLoaded || !currentUID) {
        document.getElementById('error-msg').innerText = 'âš ï¸ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
        return;
    }

    const roomRef = db.collection('rooms').doc(roomCode);
    
    try {
        await db.runTransaction(async t => {
            const doc = await t.get(roomRef);

            if (!doc.exists) {
                throw new Error("Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.");
            }
            
            let roomData = doc.data();
            
            if (roomData.status !== 'waiting') {
                throw new Error("Ø§Ù„Ù„Ø¹Ø¨Ø© ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ØºØ±ÙØ© Ø¨Ø¯Ø£Øª Ø¨Ø§Ù„ÙØ¹Ù„ Ø£Ùˆ Ø§Ù†ØªÙ‡Øª.");
            }
            
            const playerName = currentUserData.playerName || `Ù„Ø§Ø¹Ø¨#${currentUID.substring(0, 4)}`;

            if (!roomData.players.includes(currentUID)) {
                
                if (roomData.players.length >= 10) { 
                    throw new Error("Ø§Ù„ØºØ±ÙØ© Ù…Ù…ØªÙ„Ø¦Ø© (10 Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰).");
                }
                roomData.players.push(currentUID);
                roomData.playerNames[currentUID] = playerName;
                
                t.update(roomRef, { 
                    players: roomData.players, 
                    playerNames: roomData.playerNames 
                });
            }

            // ğŸš€ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„ØµØ­ÙŠØ­
            window.location.href = `room.html?id=${roomCode}`;
        });
    } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…:", error);
        document.getElementById('error-msg').innerText = `âŒ ${error.message || "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…."}`;
    }
}
</script>
</body>
</html>
