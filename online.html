<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸšª Ø§Ù„Ø¯Ø®ÙˆÙ„/Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©</title>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="auth.js"></script> 

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
/* Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª ÙƒÙ…Ø§ Ù‡ÙŠ ÙÙŠ ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø£ØµÙ„ÙŠ */
#home-icon { position: absolute; top: 20px; left: 20px; font-size: 24px; color: #94a3b8; cursor: pointer; transition: color 0.3s; }
#home-icon:hover { color: #34d399; }
body { font-family: 'Cairo', sans-serif; background-color: #0f172a; color: #f1f5f9; text-align: center; padding: 20px; min-height: 100vh; margin: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; }
.card { background-color: #1e293b; padding: 40px; border-radius: 12px; max-width: 400px; width: 90%; margin: 20px auto; box-shadow: 0 8px 15px rgba(0,0,0,0.3); text-align: right; }
h2 { font-size: 2rem; font-weight: 700; margin-bottom: 30px; color: #34d399; }
input[type="text"] { font-family: 'Cairo', sans-serif; width: 100%; padding: 15px; margin: 10px 0 20px 0; border-radius: 8px; border: 1px solid #334155; font-size: 18px; background-color: #334155; color: #f1f5f9; box-sizing: border-box; text-align: center; }
button { margin-top: 15px; padding: 14px 30px; font-size: 18px; font-weight: 700; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.3s, transform 0.2s; width: 100%; box-shadow: 0 2px 4px rgba(0,0,0,0.15); }
#create-btn { background-color: #6366f1; color: #ffffff; }
#create-btn:hover { background-color: #4f46e5; transform: translateY(-2px); }
#join-btn { background-color: #34d399; color: #0f172a; }
#join-btn:hover { background-color: #10b981; transform: translateY(-2px); }
.separator { text-align: center; margin: 25px 0; color: #94a3b8; font-weight: 700; }
#error-msg { color: #ff4f4f; margin-top: 15px; text-align: center; font-weight: 700; font-size: 0.9rem; }
</style>
</head>

<body>

<a href="index.html" id="home-icon" title="Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">
    <i class="fas fa-arrow-right"></i>
</a>

<div class="card">
    <h2>Ø§Ù†Ø¶Ù…Ø§Ù… Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©</h2>

    <button id="create-btn" onclick="createRoom()">
        <i class="fas fa-plus-circle"></i> Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©
    </button>
    
    <div class="separator">Ø£Ùˆ</div>

    <label for="room-code" style="color:#f1f5f9; margin-bottom: 10px;">Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©:</label>
    <input type="text" id="room-code" maxlength="6" placeholder="Ù…Ø«Ù„Ø§Ù‹: XYZ123">
    
    <button id="join-btn" onclick="joinRoom()">
        <i class="fas fa-sign-in-alt"></i> Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ©
    </button>
    
    <div id="error-msg"></div>
</div>

<script>
let currentUserData = null;
let currentUID = null;
let isUserDataLoaded = false; 

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
firebase.auth().onAuthStateChanged(async (user) => {
    if (!user) {
        window.location.href = "auth.html";
        return;
    }
    currentUID = user.uid;
    
    try {
        const data = await loadUserData(); // Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ auth.js
        if(data) {
            currentUserData = data;
            isUserDataLoaded = true;
            document.getElementById('error-msg').innerText = '';
        }
    } catch (e) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„:", e);
        document.getElementById('error-msg').innerText = 'âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ.';
    }
});

function generateRoomCode() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ123456789';
    let code = '';
    for (let i = 0; i < 6; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return code;
}

async function createRoom() {
    const errorDiv = document.getElementById('error-msg');
    if (!isUserDataLoaded) {
        errorDiv.innerText = 'âš ï¸ Ø§Ù†ØªØ¸Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ...';
        return;
    }

    errorDiv.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡...';
    
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
    const settings = currentUserData.settings || { impostors: 1, selectedCategories: ['objects'] };
    const playerName = currentUserData.displayName || "Ù„Ø§Ø¹Ø¨ Ù…Ø¬Ù‡ÙˆÙ„";

    let roomCode = generateRoomCode();
    let roomRef = db.collection('rooms').doc(roomCode);

    try {
        // ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø±Ù…Ø² ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù… (Ø¨Ø³ÙŠØ·)
        const doc = await roomRef.get();
        if (doc.exists) { 
            createRoom(); // Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø±Ù…Ø² Ø¬Ø¯ÙŠØ¯
            return;
        }

        await roomRef.set({
            hostUID: currentUID,
            hostName: playerName,
            status: 'waiting', 
            players: [currentUID], 
            playerNames: { [currentUID]: playerName }, 
            settings: settings,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        window.location.href = `room.html?id=${roomCode}`;
    } catch (e) {
        errorDiv.innerText = "âŒ ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©: " + e.message;
    }
}

async function joinRoom() {
    const codeInput = document.getElementById('room-code');
    const roomCode = codeInput.value.trim().toUpperCase();
    const errorDiv = document.getElementById('error-msg');

    if (roomCode.length !== 6) {
        errorDiv.innerText = 'âŒ Ø§Ù„Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­.';
        return;
    }

    errorDiv.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…...';

    const roomRef = db.collection('rooms').doc(roomCode);
    const playerName = currentUserData.displayName || "Ù„Ø§Ø¹Ø¨ Ù…Ø¬Ù‡ÙˆÙ„";

    try {
        await db.runTransaction(async (transaction) => {
            const doc = await transaction.get(roomRef);
            if (!doc.exists) throw "Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©!";
            
            const data = doc.data();
            if (data.status !== 'waiting') throw "Ø¨Ø¯Ø£Øª Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ø§Ù„ÙØ¹Ù„!";
            if (data.players.length >= 10) throw "Ø§Ù„ØºØ±ÙØ© Ù…Ù…ØªÙ„Ø¦Ø©!";

            // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ Ø£ØµÙ„Ø§Ù‹ØŒ Ù†Ø¶ÙŠÙÙ‡
            if (!data.players.includes(currentUID)) {
                transaction.update(roomRef, {
                    players: firebase.firestore.FieldValue.arrayUnion(currentUID),
                    [`playerNames.${currentUID}`]: playerName
                });
            }
        });

        window.location.href = `room.html?id=${roomCode}`;
    } catch (e) {
        errorDiv.innerText = "âŒ " + e;
    }
}
</script>
</body>
</html>

