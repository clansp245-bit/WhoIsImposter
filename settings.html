<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©</title>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="auth.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
body {
  font-family: 'Cairo', sans-serif;
  background-color: #0f172a; 
  color: #f1f5f9; 
  text-align: center;
  padding: 20px;
  min-height: 100vh;
  margin: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
}
h2 { font-size: 2rem; font-weight: 700; margin-bottom: 25px; color: #34d399; }
.card {
  background-color: #1e293b; 
  padding: 30px;
  border-radius: 12px;
  max-width: 450px;
  width: 90%;
  margin: 10px auto;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1), 0 10px 15px rgba(0,0,0,0.2);
  text-align: right;
}
label { display: block; margin-top: 15px; margin-bottom: 5px; font-weight: 700; color: #94a3b8; font-size: 0.95rem; }
textarea, select, input[type="number"], input[type="text"] {
  font-family: 'Cairo', sans-serif;
  width: 100%;
  margin: 8px 0 15px 0;
  padding: 14px 10px;
  border-radius: 8px;
  border: 1px solid #334155;
  font-size: 16px;
  background-color: #334155; 
  color: #f1f5f9;
  transition: border-color 0.3s, background-color 0.3s;
  box-sizing: border-box;
}
textarea:disabled, select:disabled, input:disabled { cursor: not-allowed; background-color: #1e293b; opacity: 0.8; }
.toggle-container { display: flex; align-items: center; justify-content: space-between; margin-top: 15px; padding: 12px 15px; background-color: #334155; border-radius: 8px; border-left: 5px solid transparent; transition: border-color 0.3s; }
.toggle-container.highlight { border-left-color: #ffcc00; }
.toggle-container label { margin: 0; font-weight: 700; color: #f1f5f9; font-size: 1rem; display: inline; }
.toggle-container input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; margin: 0; background-color: #1e293b; border: 1px solid #94a3b8; accent-color: #34d399; }
.manual-role-container { padding: 15px; border: 1px dashed #334155; border-radius: 8px; margin-top: 20px; text-align: left; }
.manual-role-container h3 { font-size: 1.1rem; color: #6366f1; margin-top: 0; border-bottom: 1px solid #334155; padding-bottom: 10px; margin-bottom: 15px; }
.manual-role-container textarea { min-height: 80px; }
button { margin-top: 15px; padding: 12px 30px; font-size: 18px; font-weight: 700; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s; background-color: #6366f1; color: #ffffff; width: 100%; box-shadow: 0 2px 4px rgba(0,0,0,0.15); }

/* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
.words-section-header {
    color: #34d399;
    font-size: 1.25rem;
    font-weight: 700;
    margin-top: 30px;
    margin-bottom: 15px;
    text-align: center;
    border-bottom: 2px solid #334155;
    padding-bottom: 10px;
}
.word-category {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    margin-bottom: 10px;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.2s, box-shadow 0.2s;
    border: 1px solid #334155;
}
.word-category:hover:not(.pro-category:not(.unlocked)) {
    background-color: #334155;
}
.word-category.selected {
    background-color: #6366f1; 
    border-color: #4f46e5;
    box-shadow: 0 0 10px rgba(99, 102, 241, 0.5);
}
.word-category.pro-category {
    border-left: 5px solid #ffd700; 
}
.word-category.pro-category.unlocked {
    opacity: 1;
    cursor: pointer;
}
.category-info span {
    font-weight: 700;
    font-size: 1rem;
}
.category-info small {
    display: block;
    color: #94a3b8;
    font-size: 0.8rem;
}
.category-icon {
    font-size: 1.2rem;
    color: #34d399;
}
.category-icon.pro-icon {
    color: #ffd700;
}
.word-category.pro-category input[type="checkbox"] {
    accent-color: #ffd700; 
}
.word-category.pro-category:not(.unlocked) {
    cursor: not-allowed;
    background-color: #1e293b;
    opacity: 0.4;
}
.word-category.pro-category:not(.unlocked) .category-info small {
    color: #ff4f4f;
    font-weight: 700;
}
</style>
</head>
<body onload="loadSettings()">

<h2>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©</h2>

<div class="card">
    <label for="discussionTimer">Ù…Ø¤Ù‚Øª Ø§Ù„Ù…Ù†Ø§Ù‚Ø´Ø© (Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ)</label>
    <input type="number" id="discussionTimer" value="120" min="0" max="600" onchange="toggleNoTimer()">
    <div class="toggle-container" style="margin-top: 10px;">
        <label for="noTimerMode">Ø§Ù„Ù„Ø¹Ø¨ Ø¨Ù„Ø§ Ù…Ø¤Ù‚Øª (ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯)</label>
        <input type="checkbox" id="noTimerMode" onclick="toggleTimerInput()">
    </div>
    <small style="color: #94a3b8; display:block; margin-top:-10px; margin-bottom:15px;">Ø§Ø¬Ø¹Ù„ Ø§Ù„Ù‚ÙŠÙ…Ø© 0 Ø£Ùˆ ÙØ¹Ù‘Ù„ Ø§Ù„Ø®ÙŠØ§Ø± Ù„Ù„Ø¹Ø¨ Ø¨Ù„Ø§ ÙˆÙ‚Øª.</small>

    <label for="impostors">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­ØªØ§Ù„ÙŠÙ†</label>
    <input type="number" id="impostors" value="1" min="1">

    <div class="toggle-container">
        <label for="multiWordMode">ÙƒÙ„Ù…Ø§Øª Ù…Ø¯Ù†ÙŠÙŠÙ† Ù…Ø®ØªÙ„ÙØ© (ØµØ¹ÙˆØ¨Ø© Ø¹Ø§Ù„ÙŠØ©)</label>
        <input type="checkbox" id="multiWordMode">
    </div>
    <small style="color:#94a3b8; display:block; margin-top:-10px; margin-bottom:15px;">ÙŠØ³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ø§Ù„ÙˆØ¶Ø¹ ÙƒÙ„Ù…ØªÙŠÙ† Ù…Ø®ØªÙ„ÙØªÙŠÙ† Ù„Ù„Ù…Ø¯Ù†ÙŠÙŠÙ† ÙˆØ§Ù„Ù…Ø­ØªØ§Ù„.</small>

    <div class="toggle-container">
        <label for="noWordRole">Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ± "Ù„Ø§ ÙƒÙ„Ù…Ø© Ù„Ùƒ!" (Ù…Ø¯Ù†ÙŠ)</label>
        <input type="checkbox" id="noWordRole">
    </div>

    <div class="toggle-container highlight" style="margin-top:25px;">
        <label for="chaosMode">ÙˆØ¶Ø¹ Ø§Ù„ÙÙˆØ¶Ù‰ (Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ù„Ø¬Ù…ÙŠØ¹ Ù…Ø­ØªØ§Ù„ÙŠÙ†!) <i class="fas fa-crown" style="color:#ffd700;"></i></label>
        <input type="checkbox" id="chaosMode">
    </div>

    <div class="manual-role-container" id="manual-roles-section">
        <h3>ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø£Ø¯ÙˆØ§Ø± ÙŠØ¯ÙˆÙŠØ§Ù‹ (Pro) <i class="fas fa-crown" style="color:#ffd700;"></i></h3>
        <small style="color:#94a3b8; display:block; margin-bottom:10px;">Ø£Ø¯Ø®Ù„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† (ÙƒÙ„ Ø§Ø³Ù… ÙÙŠ Ø³Ø·Ø±) Ø§Ù„Ø°ÙŠÙ† ØªØ±ÙŠØ¯ Ø£Ù† ÙŠÙƒÙˆÙ†ÙˆØ§ Ù…Ø­ØªØ§Ù„ÙŠÙ† Ø£Ùˆ Ø¨Ù„Ø§ ÙƒÙ„Ù…Ø©.</small>
        <label for="manualImpostors" style="color:#ff4f4f; margin-top:10px;">Ø§Ù„Ù…Ø­ØªØ§Ù„ÙˆÙ† ÙŠØ¯ÙˆÙŠØ§Ù‹</label>
        <textarea id="manualImpostors" rows="3" placeholder="Ø£Ø¯Ø®Ù„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø­ØªØ§Ù„ÙŠÙ† Ù‡Ù†Ø§..."></textarea>
        <label for="manualNoWord" style="color:#6366f1; margin-top:5px;">Ø¨Ù„Ø§ ÙƒÙ„Ù…Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹</label>
        <textarea id="manualNoWord" rows="3" placeholder="Ø£Ø¯Ø®Ù„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ø°ÙŠÙ† Ø¨Ù„Ø§ ÙƒÙ„Ù…Ø© Ù‡Ù†Ø§..."></textarea>
    </div>

    <div class="words-section-header">
         <i class="fas fa-list"></i> Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„ÙƒÙ„Ù…Ø§Øª
         <small style="display: block; font-size: 0.8rem; font-weight: 400; color: #94a3b8; margin-top: 5px;">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± Ù‚Ø³Ù… ÙˆØ§Ø­Ø¯ Ø£Ùˆ Ø£ÙƒØ«Ø±.</small>
    </div>

    <div id="word-categories-container">
        </div>
    
    <div id="word-source-legacy-fields" style="display:none;">
        <label for="source">Ù…ØµØ¯Ø± Ø§Ù„ÙƒÙ„Ù…Ø§Øª</label>
        <select id="source">
            <option value="default">Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© (Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…)</option>
            <option value="custom">ÙƒÙ„Ù…Ø§ØªÙŠ (Ù…Ø®ØµØµØ©)</option>
            <option value="both">Ø§Ù„Ø§Ø«Ù†ÙŠÙ† Ù…Ø¹Ù‹Ø§</option>
        </select>
        <label for="words">ÙƒÙ„Ù…Ø§ØªÙƒ Ø§Ù„Ù…Ø®ØµØµØ© (ÙƒÙ„ ÙƒÙ„Ù…Ø© ÙÙŠ Ø³Ø·Ø± Ù…Ù†ÙØµÙ„)</label>
        <textarea id="words" rows="5" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø§ØªÙƒ Ù‡Ù†Ø§..."></textarea>
    </div>
    <button onclick="saveSettings()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨</button>
</div>

<div class="card" id="promocode-section">
    <h3>ğŸ ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ… Ø£Ùˆ Ø§Ù„ÙƒÙˆÙŠÙ†Ø²</h3>
    <input type="text" id="promocode-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ù‡Ù†Ø§">
    <button onclick="redeemCode()">Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙƒÙˆØ¯</button>
    <div id="promocode-msg" style="margin-top:10px; color:#ffd700;"></div>
    <button id="admin-promocode-btn" style="margin-top:15px; display:none;" onclick="openAdminPage()">âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒÙˆØ¯Ø§Øª</button>
</div>

<script>
const impostorsInput = document.getElementById("impostors");
const timerInput = document.getElementById("discussionTimer");
const noTimerCheckbox = document.getElementById("noTimerMode");
let currentUserData = { totalCoins:0, proExpiryTime:0 };

// ----------------------------------------------------
// Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (Ù…Ø¯Ù…Ø¬Ø© Ù‡Ù†Ø§)
// ----------------------------------------------------
const wordCategories = {
    free: [
        { id: 'objects', name: 'Ø£Ø´ÙŠØ§Ø¡ ÙˆØ£Ø¯ÙˆØ§Øª', icon: 'fas fa-tools', words: ["Ù‚Ù„Ù…", "ÙƒÙˆØ¨", "ÙƒØ±Ø³ÙŠ", "Ù…ÙØªØ§Ø­", "Ù‡Ø§ØªÙ", "ÙƒØªØ§Ø¨", "Ø³Ø§Ø¹Ø©", "Ù…ØµØ¨Ø§Ø­", "Ù…Ù„Ø¹Ù‚Ø©", "Ø­Ø°Ø§Ø¡", "Ø­Ù‚ÙŠØ¨Ø©", "Ø·Ø§ÙˆÙ„Ø©", "Ù…Ø±Ø¢Ø©", "Ø¯ÙØªØ±", "Ù…Ù…Ø­Ø§Ø©", "Ø¬Ø¯Ø§Ø±", "Ø´Ø¨Ø§Ùƒ", "Ø¨Ø§Ø¨", "Ø³Ø±ÙŠØ±", "ÙˆØ³Ø§Ø¯Ø©", "ØºØ·Ø§Ø¡", "Ø¬Ø±Ø³", "Ù…Ø¸Ù„Ø©", "Ù„ÙˆØ­Ø©", "Ù…Ø±ÙˆØ­Ø©", "ØµÙ†Ø¯ÙˆÙ‚", "ÙØ±Ø´Ø§Ø©", "Ù…Ø´Ø·", "Ù…Ù…Ø­Ø§Ø©", "Ù…Ø·Ø±Ù‚Ø©", "Ù…Ø³Ù…Ø§Ø±", "Ø®ÙŠØ·", "Ø¥Ø¨Ø±Ø©", "Ø®Ø²Ø§Ù†Ø©", "Ø­Ø¨Ù„", "Ø´Ø±ÙŠØ·", "ÙƒØ§Ù…ÙŠØ±Ø§", "Ù…Ø§ÙˆØ³", "Ø¨Ø·Ø§Ø±ÙŠØ©", "Ù„Ù…Ø¨Ø©", "Ù…Ù‚Øµ", "Ù…Ù†Ø´ÙØ©", "ØµÙ†Ø¨ÙˆØ±", "Ù‚ÙÙ„", "Ø³Ù„Ø©", "Ø³Ù„Ùƒ", "Ø´Ø§Ø­Ù†", "Ø£Ø±ÙŠÙƒØ©", "Ø±Ù"] },
        { id: 'nature', name: 'Ø§Ù„Ø·Ø¨ÙŠØ¹Ø© ÙˆØ§Ù„Ø¨ÙŠØ¦Ø©', icon: 'fas fa-tree', words: ["Ø´Ø¬Ø±Ø©", "Ù†Ù‡Ø±", "Ø¬Ø¨Ù„", "Ø³Ù…Ø§Ø¡", "Ø¨Ø­Ø±", "Ø´Ù…Ø³", "Ù‚Ù…Ø±", "Ù†Ø¬Ù…", "ØºÙŠÙ…Ø©", "Ù…Ø·Ø±", "Ø«Ù„Ø¬", "ØµØ®Ø±Ø©", "Ø±Ù…Ù„", "Ø¹Ø´Ø¨", "ÙˆØ±Ø¯Ø©", "Ù†Ø®Ù„Ø©", "Ø´Ø§Ø·Ø¦", "Ø¨Ø±ÙƒØ§Ù†", "ØµØ­Ø±Ø§Ø¡", "ÙˆØ§Ø¯ÙŠ", "ÙƒÙ‡Ù", "Ø¨Ø­ÙŠØ±Ø©", "Ø¶Ø¨Ø§Ø¨", "Ø±ÙŠØ§Ø­", "ØµÙ‚ÙŠØ¹", "ØªØ±Ø§Ø¨", "Ù†Ø¨ØªØ©", "Ø¨Ø°Ø±Ø©", "ÙØ¶Ø§Ø¡", "ÙƒÙˆÙƒØ¨", "Ø´Ù‡Ø§Ø¨", "Ø£ÙÙ‚", "Ø¬Ø³Ø±", "Ù…Ø²Ø±Ø¹Ø©", "Ø¹Ø§ØµÙØ©", "Ù†Ø³ÙŠÙ…", "Ø¸Ù„", "Ø¶ÙˆØ¡", "Ù…Ø­ÙŠØ·", "Ø¬Ø²ÙŠØ±Ø©", "Ø´Ù„Ø§Ù„", "Ù†Ø¨Ø¹", "Ø¬Ø°Ø¹", "ÙˆØ±Ù‚Ø©", "ØºØ§Ø¨Ø©", "Ø£Ø²Ù‡Ø§Ø±", "Ø³Ø­Ø§Ø¨Ø©", "Ø¨Ø¦Ø±"] },
        { id: 'jobs', name: 'Ù…Ù‡Ù† ÙˆÙˆØ¸Ø§Ø¦Ù', icon: 'fas fa-briefcase', words: ["Ø·Ø¨ÙŠØ¨", "Ù…Ø¹Ù„Ù…", "Ù…Ù‡Ù†Ø¯Ø³", "Ø´Ø±Ø·ÙŠ", "Ø®Ø¨Ø§Ø²", "Ù…Ø²Ø§Ø±Ø¹", "Ù†Ø¬Ø§Ø±", "Ø·Ø¨Ø§Ø®", "Ø±Ø³Ø§Ù…", "Ù…Ø°ÙŠØ¹", "Ù‚Ø§Ø¶ÙŠ", "ÙƒØ§ØªØ¨", "Ø¬Ù†Ø¯ÙŠ", "Ø¨Ø­Ø§Ø±", "Ø·ÙŠØ§Ø±", "ØµÙŠØ¯Ù„ÙŠ", "Ù…Ù…Ø±Ø¶", "Ù…ØµÙˆØ±", "Ù…ÙˆØ³ÙŠÙ‚ÙŠ", "Ø®ÙŠØ§Ø·", "Ø³Ø§Ø¦Ù‚", "Ù…Ø­Ø§Ù…ÙŠ", "Ø¨Ø§Ø¦Ø¹", "Ù…ØªØ±Ø¬Ù…", "Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠ", "Ø¨Ù†Ø§Ø¡", "ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ", "Ø­Ø¯Ø§Ø¯", "Ø¬Ø²Ø§Ø±", "Ø´Ø§Ø¹Ø±", "ØµØ­ÙÙŠ", "Ù†Ø§Ù‚Ø¯", "Ø­Ø§Ø±Ø³", "Ø±ÙŠØ§Ø¶ÙŠ", "Ø¹Ø§Ù…Ù„", "Ø¥Ø·ÙØ§Ø¦ÙŠ", "Ù…Ø±Ø´Ø¯", "Ø®Ø§Ø¯Ù…", "Ù…Ø­Ø§Ø³Ø¨", "Ù…Ø¯Ø±Ø¨", "ÙÙ†Ø§Ù†", "ØµØ§Ù†Ø¹", "Ù…ÙˆØ²Ø¹", "Ù…ÙØªØ´", "Ø¹Ø§Ù„Ù…", "ÙÙ„ÙƒÙŠ", "Ù…Ø±Ø§Ø³Ù„"] }
    ],
    pro: [
        { id: 'foods', name: 'Ù…Ø£ÙƒÙˆÙ„Ø§Øª ÙˆÙ…Ø´Ø±ÙˆØ¨Ø§Øª', icon: 'fas fa-hamburger', words: ["ØªÙØ§Ø­", "Ù…ÙˆØ²", "Ø¨Ø±ØªÙ‚Ø§Ù„", "Ù…Ø§Ø¡", "Ù‚Ù‡ÙˆØ©", "Ø´Ø§ÙŠ", "Ø®Ø¨Ø²", "Ø£Ø±Ø²", "Ù„Ø­Ù…", "Ø¯Ø¬Ø§Ø¬", "Ø³Ù…Ùƒ", "Ø¹ØµÙŠØ±", "Ø­Ù„ÙŠØ¨", "Ø¬Ø¨Ù†", "Ø¨ÙŠØ¶", "Ø³ÙƒØ±", "Ù…Ù„Ø­", "Ø²ÙŠØª", "Ø²Ø¨Ø¯Ø©", "Ø¹Ø³Ù„", "Ø¨Ø·Ø§Ø·Ø§", "Ø·Ù…Ø§Ø·Ù…", "Ø¨ØµÙ„", "Ø«ÙˆÙ…", "Ø®Ø³", "Ø¬Ø²Ø±", "ÙƒØ¹ÙƒØ©", "Ù…Ø«Ù„Ø¬Ø§Øª", "Ù…ÙƒØ±ÙˆÙ†Ø©", "Ø¨ÙŠØªØ²Ø§", "Ø³Ù„Ø·Ø©", "Ø­Ø³Ø§Ø¡", "ØªÙˆØ§Ø¨Ù„", "Ù…Ø´Ø±ÙˆØ¨", "Ø¹Ù†Ø¨", "Ù…Ø§Ù†Ø¬Ùˆ", "ÙÙ„ÙÙ„", "Ù„ÙŠÙ…ÙˆÙ†", "Ø¨Ø³ÙƒÙˆÙŠØª", "ÙÙˆÙ„", "Ø¹Ø¯Ø³", "ÙØ±Ø§ÙˆÙ„Ø©", "Ø²ÙŠØªÙˆÙ†", "Ù…Ø±Ø¨Ù‰", "Ø³ÙƒØ±", "Ø´ÙˆÙƒÙˆÙ„Ø§ØªØ©", "ÙØ·Ø±", "Ø¹Ù„ÙƒØ©"] },
        { id: 'animals', name: 'Ø­ÙŠÙˆØ§Ù†Ø§Øª ÙˆØ·ÙŠÙˆØ±', icon: 'fas fa-paw', words: ["ÙƒÙ„Ø¨", "Ù‚Ø·Ø©", "Ø£Ø³Ø¯", "Ù†Ù…Ø±", "ÙÙŠÙ„", "Ø²Ø±Ø§ÙØ©", "Ù‚Ø±Ø¯", "Ø­ØµØ§Ù†", "Ø¬Ù…Ù„", "Ø¶ÙØ¯Ø¹", "Ø«Ø¹Ù„Ø¨", "Ø°Ø¦Ø¨", "Ø¯Ø¨", "Ø£Ø±Ù†Ø¨", "Ø³Ù†Ø¬Ø§Ø¨", "Ø·Ø§Ø¦Ø±", "Ø­Ù…Ø§Ù…Ø©", "ØµÙ‚Ø±", "Ø¨ÙˆÙ…Ø©", "Ù†Ø³Ø±", "Ø¨Ø·Ø©", "Ø¯ÙŠÙƒ", "Ø¯Ø¬Ø§Ø¬Ø©", "Ø¨Ù‚Ø±Ø©", "ØºØ²Ø§Ù„", "ØªÙ…Ø³Ø§Ø­", "Ø«Ø¹Ø¨Ø§Ù†", "Ø³Ù…ÙƒØ©", "Ù‚Ø±Ø´", "Ø¯ÙˆÙ„ÙÙŠÙ†", "Ø­ÙˆØª", "Ù†Ø­Ù„Ø©", "Ù†Ù…Ù„Ø©", "Ø¹Ù†ÙƒØ¨ÙˆØª", "ÙØ±Ø§Ø´Ø©", "ÙŠØ±Ø¨ÙˆØ¹", "Ø³Ù„Ø­ÙØ§Ø©", "Ø®Ø±ÙˆÙ", "Ù…Ø§Ø¹Ø²", "ÙØ£Ø±", "Ø¨Ø¨ØºØ§Ø¡", "ÙƒÙ†ØºØ±", "Ø¨Ø·Ø±ÙŠÙ‚", "Ø¶Ø¨Ø¹", "Ù†ÙˆØ±Ø³", "Ø¹Ù‚Ø§Ø¨", "Ø³Ø¹Ø¯Ø§Ù†"] },
        { id: 'clothes', name: 'Ù…Ù„Ø§Ø¨Ø³ ÙˆØ¥ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª', icon: 'fas fa-tshirt', words: ["Ù‚Ù…ÙŠØµ", "Ø¨Ù†Ø·Ø§Ù„", "ÙØ³ØªØ§Ù†", "ØªÙ†ÙˆØ±Ø©", "Ù…Ø¹Ø·Ù", "Ø³ØªØ±Ø©", "Ø­Ø¬Ø§Ø¨", "ÙˆØ´Ø§Ø­", "Ù‚Ø¨Ø¹Ø©", "Ø¬ÙˆØ±Ø¨", "Ù‚ÙØ§Ø²", "Ø­Ø°Ø§Ø¡", "ØµÙ†Ø¯Ù„", "Ø­Ù‚ÙŠØ¨Ø©", "Ù†Ø¸Ø§Ø±Ø©", "Ø­Ø²Ø§Ù…", "Ø³Ø§Ø¹Ø© ÙŠØ¯", "Ø®Ø§ØªÙ…", "Ù‚Ù„Ø§Ø¯Ø©", "Ø³ÙˆØ§Ø±", "Ø¬ÙŠØ¨", "Ø²Ø±", "Ø³Ø­Ø§Ø¨", "Ù‚Ù…Ø§Ø´", "Ø­Ø±ÙŠØ±", "Ø¬Ù„Ø¯", "Ù‚Ø·Ù†", "ØµÙˆÙ", "Ø¹Ø¨Ø§Ø¡Ø©", "Ø¨ÙŠØ¬Ø§Ù…Ø©", "Ø±Ø¨Ø·Ø© Ø¹Ù†Ù‚", "Ù…Ø±ÙŠÙˆÙ„", "ÙƒØ¨Ùƒ", "ÙØ±Ùˆ", "Ø´Ø§Ù„", "ØµØ¯Ø±ÙŠØ©", "Ù…Ù†Ø´ÙØ©", "Ù…Ù†Ø§Ù…Ø©", "Ù‚Ø¨Ø¹Ø© Ø´Ù…Ø³", "Ù…Ø´Ø¯", "Ø²ÙŠ", "Ø¨Ø§Ø±ÙˆÙƒØ©", "Ø¨ÙˆØª", "Ø¬ÙˆØ§Ø±Ø¨", "Ù„Ø¨Ø§Ø³", "Ø±Ø¯Ø§Ø¡", "Ù…Ø¦Ø²Ø±", "Ø³Ø±ÙˆØ§Ù„"] },
        { id: 'places', name: 'Ø£Ù…Ø§ÙƒÙ† ÙˆÙ…Ø¹Ø§Ù„Ù…', icon: 'fas fa-city', words: ["Ù…Ø¯Ø±Ø³Ø©", "Ù…Ø³ØªØ´ÙÙ‰", "Ù…Ù†Ø²Ù„", "Ù…Ø³Ø¬Ø¯", "ÙƒÙ†ÙŠØ³Ø©", "Ø³ÙˆÙ‚", "Ù…ÙƒØªØ¨Ø©", "Ù…Ø·Ø§Ø±", "Ù…Ø­Ø·Ø©", "Ø­Ø¯ÙŠÙ‚Ø©", "Ù…ØªØ­Ù", "Ù…ØµÙ†Ø¹", "Ù…Ù‚Ù‡Ù‰", "Ù…Ø·Ø¹Ù…", "ÙÙ†Ø¯Ù‚", "Ù…Ø¨Ù†Ù‰", "Ø¬Ø³Ø±", "Ø·Ø±ÙŠÙ‚", "Ø´Ø§Ø±Ø¹", "Ø³Ø§Ø­Ø©", "Ù‚ØµØ±", "Ù‚Ù„Ø¹Ø©", "Ø¨Ø±Ø¬", "Ø¨ÙˆØ§Ø¨Ø©", "Ø¨Ø¦Ø±", "Ù…Ù„Ø¹Ø¨", "Ù†Ø§Ø¯ÙŠ", "Ø¬Ø§Ù…Ø¹Ø©", "ÙˆØ²Ø§Ø±Ø©", "Ø³ÙØ§Ø±Ø©", "ÙƒØ±Ø§Ø¬", "Ù†ÙÙ‚", "Ù…Ù…Ø±", "Ù‚Ø¨Ùˆ", "Ø³Ø·Ø­", "Ø´Ø±ÙØ©", "Ù…Ø®Ø²Ù†", "Ù…ÙˆÙ‚Ù", "ØºØ±ÙØ©", "Ù‚Ø§Ø¹Ø©", "Ø¨Ù‡Ùˆ", "Ù…Ø³ØªÙˆØ¯Ø¹", "Ù…Ø¬Ù„Ø³", "Ø®ÙŠÙ…Ø©", "Ù…Ø®Ø¨Ø²", "Ù…ØºØ³Ù„Ø©", "Ø¯ÙƒØ§Ù†"] },
        { id: 'activities', name: 'Ø£ÙØ¹Ø§Ù„ ÙˆÙ†Ø´Ø§Ø·Ø§Øª', icon: 'fas fa-running', words: ["Ø¬Ø±ÙŠ", "Ø³Ø¨Ø§Ø­Ø©", "Ù‚Ø±Ø§Ø¡Ø©", "ÙƒØªØ§Ø¨Ø©", "Ø±Ø³Ù…", "ØºÙ†Ø§Ø¡", "Ø±Ù‚Øµ", "Ù„Ø¹Ø¨", "Ù†ÙˆÙ…", "Ø£ÙƒÙ„", "Ø´Ø±Ø¨", "Ø¶Ø­Ùƒ", "Ø¨ÙƒØ§Ø¡", "ØµØ±Ø§Ø®", "Ù…Ø´Ø§Ù‡Ø¯Ø©", "Ø§Ø³ØªÙ…Ø§Ø¹", "Ø­Ø¯ÙŠØ«", "Ø³ÙØ±", "ØµÙŠØ¯", "Ø·Ø¨Ø®", "ØªÙ†Ø¸ÙŠÙ", "Ø¹Ù…Ù„", "Ø¯Ø±Ø§Ø³Ø©", "Ù‚ÙŠØ§Ø¯Ø©", "Ø¨Ù†Ø§Ø¡", "Ù‡Ø¯Ù…", "Ø²Ø±Ø¹", "Ø­ØµØ§Ø¯", "Ø¥ØµÙ„Ø§Ø­", "ÙƒØ³Ø±", "ÙØªØ­", "Ø¥ØºÙ„Ø§Ù‚", "Ù‚ÙØ²", "ØµØ¹ÙˆØ¯", "Ù‡Ø¨ÙˆØ·", "Ø§Ù†ØªØ¸Ø§Ø±", "ØªÙÙƒÙŠØ±", "Ø­Ù„Ù…", "Ø¨Ù‚Ø§Ø¡", "ØªØ£Ù…Ù„", "ØªØ¬ÙˆÙ„", "Ø§Ø³ØªØ±Ø§Ø­Ø©", "Ø§Ø¬ØªÙ…Ø§Ø¹", "Ø¥Ø´Ø§Ø±Ø©", "Ø¥Ø±Ø³Ø§Ù„", "Ø§Ø³ØªÙ‚Ø¨Ø§Ù„", "Ø³Ø¤Ø§Ù„"] },
        { id: 'adjectives', name: 'ØµÙØ§Øª ÙˆØ£Ø­ÙˆØ§Ù„', icon: 'fas fa-star', words: ["Ø³Ø±ÙŠØ¹", "Ø¨Ø·ÙŠØ¡", "ÙƒØ¨ÙŠØ±", "ØµØºÙŠØ±", "Ø·ÙˆÙŠÙ„", "Ù‚ØµÙŠØ±", "Ø¬Ù…ÙŠÙ„", "Ù‚Ø¨ÙŠØ­", "Ø³Ø¹ÙŠØ¯", "Ø­Ø²ÙŠÙ†", "ØºØ§Ø¶Ø¨", "Ù‡Ø§Ø¯Ø¦", "ØµØ§Ø®Ø¨", "Ù†Ø¸ÙŠÙ", "Ù…ØªØ³Ø®", "Ù‚ÙˆÙŠ", "Ø¶Ø¹ÙŠÙ", "Ø¨Ø§Ø±Ø¯", "Ø­Ø§Ø±", "Ù…Ø´Ø±Ù‚", "Ù…Ø¸Ù„Ù…", "Ø¬Ø¯ÙŠØ¯", "Ù‚Ø¯ÙŠÙ…", "ØµØ¹Ø¨", "Ø³Ù‡Ù„", "Ø®ÙÙŠÙ", "Ø«Ù‚ÙŠÙ„", "Ø¬Ø§Ø¦Ø¹", "Ø¹Ø·Ø´Ø§Ù†", "Ù…Ø±ÙŠØ¶", "Ø³Ù„ÙŠÙ…", "Ø¨Ø¹ÙŠØ¯", "Ù‚Ø±ÙŠØ¨", "Ø­Ù‚ÙŠÙ‚ÙŠ", "ÙˆÙ‡Ù…ÙŠ", "Ø´Ø¬Ø§Ø¹", "Ø¬Ø¨Ø§Ù†", "Ù…Ø¶Ø­Ùƒ", "Ø¬Ø¯ÙŠ", "Ù…Ø£Ù„ÙˆÙ", "ØºØ±ÙŠØ¨", "Ø­ÙƒÙŠÙ…", "Ø£Ø­Ù…Ù‚", "Ù†Ø§Ø¬Ø­", "ÙØ§Ø´Ù„"] }
    ]
};
// ----------------------------------------------------

function isPro(){ return (currentUserData.proExpiryTime || 0) > new Date().getTime(); }
function toggleTimerInput(){ if(noTimerCheckbox.checked){timerInput.value=0; timerInput.disabled=true;}else{if(timerInput.value==0)timerInput.value=120;timerInput.disabled=false;} }
function toggleNoTimer(){ if(Number(timerInput.value)===0){noTimerCheckbox.checked=true; timerInput.disabled=true;}else{noTimerCheckbox.checked=false; timerInput.disabled=false;} }


// ----------------------------------------------------
// Ø¯ÙˆØ§Ù„ Ø§Ø®ØªÙŠØ§Ø± Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ÙƒÙ„Ù…Ø§Øª (Word Categories)
// ----------------------------------------------------

function renderWordCategories() {
    const container = document.getElementById('word-categories-container');
    if (!container) return; 

    container.innerHTML = '';
    const proStatus = isPro();
    
    // Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©
    wordCategories.free.forEach(category => {
        container.appendChild(createCategoryElement(category, 'free', true));
    });

    // Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø© (Pro)
    wordCategories.pro.forEach(category => {
        const isUnlocked = proStatus;
        container.appendChild(createCategoryElement(category, 'pro', isUnlocked));
    });
    
    loadSelectedCategories();
}

function createCategoryElement(category, type, isUnlocked) {
    const div = document.createElement('div');
    const isProCategory = type === 'pro';
    
    div.className = `word-category ${isProCategory ? 'pro-category' : ''} ${isUnlocked ? 'unlocked' : ''}`;
    div.setAttribute('data-id', category.id);
    
    if (isUnlocked || type === 'free') {
        div.onclick = () => toggleCategory(category.id);
    } else {
        div.title = "Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ø­ØµØ±ÙŠ Ù„Ù…Ø´ØªØ±ÙƒÙŠ Pro";
    }

    const iconClass = isProCategory ? 'pro-icon fas fa-crown' : category.icon;
    const smallText = isProCategory && !isUnlocked ? 'Ø­ØµØ±ÙŠ Ù„Ù…Ø´ØªØ±ÙƒÙŠ Pro' : `ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ${category.words.length} ÙƒÙ„Ù…Ø©`;
    
    div.innerHTML = `
        <div class="category-info" style="display: flex; align-items: center; gap: 10px;">
            <i class="${iconClass}"></i>
            <div>
                <span>${category.name}</span>
                <small>${smallText}</small>
            </div>
        </div>
        <input type="checkbox" id="cat-${category.id}" ${(!isUnlocked && isProCategory) ? 'disabled' : ''}>
    `;
    return div;
}

function toggleCategory(categoryId) {
    const element = document.querySelector(`.word-category[data-id="${categoryId}"]`);
    const checkbox = document.getElementById(`cat-${categoryId}`);
    
    if (element && checkbox && !checkbox.disabled) {
        const isSelected = element.classList.toggle('selected');
        checkbox.checked = isSelected;
        saveSelectedCategories();
    }
}

function saveSelectedCategories() {
    const selected = Array.from(document.querySelectorAll('.word-category.selected')).map(el => el.getAttribute('data-id'));
    localStorage.setItem("selectedCategories", JSON.stringify(selected));
}

function loadSelectedCategories() {
    const savedCategories = localStorage.getItem("selectedCategories");
    const proStatus = isPro();
    
    if (savedCategories) {
        try {
            const selected = JSON.parse(savedCategories);
            selected.forEach(id => {
                const element = document.querySelector(`.word-category[data-id="${id}"]`);
                const checkbox = document.getElementById(`cat-${id}`);
                
                if (element && checkbox) {
                    const isProCategory = element.classList.contains('pro-category');
                    if (!isProCategory || proStatus) { 
                        element.classList.add('selected');
                        checkbox.checked = true;
                    }
                }
            });
        } catch (e) {
            console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©:", e);
        }
    }
    // ØªØ£ÙƒØ¯ Ù…Ù† Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø­ØªÙ‰ Ù„Ùˆ ÙƒØ§Ù†Øª ÙØ§Ø±ØºØ©
    saveSelectedCategories(); 
}

function getSelectedWords() {
    const selectedIds = JSON.parse(localStorage.getItem("selectedCategories") || "[]");
    let combinedWords = [];
    
    const collectWords = (categories, isProCategory) => {
        categories.forEach(cat => {
            if (selectedIds.includes(cat.id)) {
                if (!isProCategory || isPro()) { 
                    combinedWords.push(...cat.words);
                }
            }
        });
    };

    collectWords(wordCategories.free, false);
    collectWords(wordCategories.pro, true);
    
    return [...new Set(combinedWords)];
}


// ----------------------------------------------------
// Ø¯Ø§Ù„Ø© Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (LoadSettings)
// ----------------------------------------------------
async function loadSettings(){
  firebase.auth().onAuthStateChanged(async user=>{
    if(!user){window.location.href="auth.html"; return;}
    // Ø§ÙØªØ±Ø¶ Ø£Ù† loadUserData Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ auth.js ÙˆØªÙØ±Ø¬Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    const data = await loadUserData(); 
    if(data) currentUserData = data;
    const pro = isPro();

    const savedSettings = localStorage.getItem("settings");
    let settings = savedSettings ? JSON.parse(savedSettings) : {};
    document.getElementById("impostors").value = settings.impostors||1;
    
    // *** Ø¥Ø²Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„Ù„ÙƒÙ„Ù…Ø§Øª (source Ùˆ words) ***
    // document.getElementById("source").value = settings.source||"default";
    // document.getElementById("words").value = Array.isArray(settings.customWords)?settings.customWords.join('\n'):"";

    // ØªÙØ¹ÙŠÙ„ / ØªØ¹Ø·ÙŠÙ„ Ø®ÙŠØ§Ø±Ø§Øª Pro
    const chaosCheckbox=document.getElementById("chaosMode");
    const manualSection=document.getElementById("manual-roles-section");
    const manualImpostors=document.getElementById("manualImpostors");
    const manualNoWord=document.getElementById("manualNoWord");
    document.getElementById("noWordRole").checked = settings.noWordRole===true;
    document.getElementById("multiWordMode").checked = settings.multiWordMode===true;

    chaosCheckbox.disabled=!pro; manualImpostors.disabled=!pro; manualNoWord.disabled=!pro;
    manualImpostors.value=Array.isArray(settings.manualImpostors)?settings.manualImpostors.join('\n'):"";
    manualNoWord.value=Array.isArray(settings.manualNoWord)?settings.manualNoWord.join('\n'):"";
    if(!pro){ chaosCheckbox.checked=false; manualImpostors.value=""; manualNoWord.value=""; manualSection.style.opacity=0.6; manualSection.title="Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© Ø­ØµØ±ÙŠØ© Ù„Ù…Ø´ØªØ±ÙƒÙŠ Pro"; } 
    else{ chaosCheckbox.checked=settings.chaosMode===true; manualSection.style.opacity=1; manualSection.title=""; }

    const savedTimer=settings.discussionTimer||120;
    if(savedTimer===0){ noTimerCheckbox.checked=true; timerInput.value=0; timerInput.disabled=true; } else { noTimerCheckbox.checked=false; timerInput.value=savedTimer; timerInput.disabled=false; }

    // Ø¹Ø±Ø¶ Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ÙƒÙ„Ù…Ø§Øª
    renderWordCategories();
    
    // Ø§Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø§Ø¯Ù…Ù† Ù„Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø­Ø¯Ø¯
    if(user.email==="clansp245@gmail.com"){ document.getElementById("admin-promocode-btn").style.display="block"; }
  });
}

// ----------------------------------------------------
// Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (SaveSettings)
// ----------------------------------------------------

function saveSettings(){
  const impostorsValue = Number(impostorsInput.value);
  const pro = isPro();
  let chaosModeEnabled = document.getElementById("chaosMode").checked;
  const noWordEnabled=document.getElementById("noWordRole").checked;
  const multiWordEnabled=document.getElementById("multiWordMode").checked;
  let timerValue=noTimerCheckbox.checked?0:Number(timerInput.value);
  const manualImpostorsArray=pro?document.getElementById("manualImpostors").value.split("\n").map(w=>w.trim()).filter(w=>w.length>0):[];
  const manualNoWordArray=pro?document.getElementById("manualNoWord").value.split("\n").map(w=>w.trim()).filter(w=>w.length>0):[];
  if(!pro) chaosModeEnabled=false;

  // *** Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© ***
  const selectedCategories = JSON.parse(localStorage.getItem("selectedCategories") || "[]");
  if(selectedCategories.length === 0) {
      alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù‚Ø³Ù… ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„ÙƒÙ„Ù…Ø§Øª.");
      return;
  }
  
  if(impostorsValue<1||impostorsValue>10||isNaN(impostorsValue)){alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¯Ø¯ ØµØ­ÙŠØ­ Ù„Ù„Ù…Ø­ØªØ§Ù„ÙŠÙ† Ø¨ÙŠÙ† 1 Ùˆ 10."); return;}
  if(timerValue<0||isNaN(timerValue)){alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© Ù„Ù„Ù…Ø¤Ù‚Øª Ù…ÙˆØ¬Ø¨Ø© Ø£Ùˆ ØªÙØ¹ÙŠÙ„ Ø®ÙŠØ§Ø± 'Ø¨Ù„Ø§ Ù…Ø¤Ù‚Øª'."); return;}
  
  const settings={ 
      impostors:impostorsValue, 
      chaosMode:chaosModeEnabled, 
      noWordRole:noWordEnabled, 
      multiWordMode:multiWordEnabled, 
      discussionTimer:timerValue, 
      manualImpostors:manualImpostorsArray, 
      manualNoWord:manualNoWordArray, 
      // Ø­ÙØ¸ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© (Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù† Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø®ØµØµØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©)
      selectedCategories: selectedCategories 
  };
  
  localStorage.setItem("settings",JSON.stringify(settings));
  location.href="game.html";
}


// âš¡ Ø¯ÙˆØ§Ù„ Ø§Ù„ÙƒÙˆØ¯Ø§Øª (Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± Ø¹Ù† Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«)
async function redeemCode() {
    const codeInput = document.getElementById('promocode-input');
    const msgDiv = document.getElementById('promocode-msg');
    const code = codeInput.value.trim().toUpperCase(); 
    msgDiv.innerText = ""; 

    if(!code){ msgDiv.innerText = "âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ ØµØ§Ù„Ø­!"; return; }

    const user = firebase.auth().currentUser; 
    if(!user){ alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„."); return; } 
    
    const db = firebase.firestore(); 
    try { 
        const codeRef = db.collection("promocodes").doc(code); 
        const userRef = db.collection("users").doc(user.uid); 

        await db.runTransaction(async t => { 
            const doc = await t.get(codeRef); 
            if(!doc.exists) throw "âŒ Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©"; 
            
            const data = doc.data(); 
            if(data.active === false) throw "â›” Ø§Ù„ÙƒÙˆØ¯ Ù…ÙˆÙ‚ÙˆÙ"; 
            
            const usedBy = data.redeemedBy || []; 
            const maxUses = data.maxUses || Infinity; 
            const usedCount = data.usedCount || 0; 
            
            if(usedBy.includes(user.uid)) throw "âš ï¸ Ù„Ù‚Ø¯ Ø§Ø³ØªØ®Ø¯Ù…Øª Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§"; 
            if(usedCount >= maxUses) throw "âŒ› Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙƒÙˆØ¯ (ÙˆØµÙ„ Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…)"; 

            const userDoc = await t.get(userRef);
            let userData = userDoc.exists ? userDoc.data() : {totalCoins:0, proExpiryTime:0};

            const now = Date.now();
            let successMessage = "";

            const amount = data.amount || data.coins || 0;
            if (amount > 0) {
                userData.totalCoins = (userData.totalCoins || 0) + amount; 
                successMessage += `ğŸ‰ ØªÙ… Ø¥Ø¶Ø§ÙØ© ${amount} ÙƒÙˆÙŠÙ†Ø² Ù„Ø­Ø³Ø§Ø¨Ùƒ! `;
            } 
            
            const durationDays = data.durationDays || 0;
            if (durationDays > 0) {
                const currentExpiry = (userData.proExpiryTime > now) ? userData.proExpiryTime : now; 
                userData.proExpiryTime = currentExpiry + (durationDays * 24*60*60*1000); 
                successMessage += `ğŸ‰ ØªÙ… ØªÙØ¹ÙŠÙ„ Ø¹Ø¶ÙˆÙŠØ© Pro Ù„Ù…Ø¯Ø© ${durationDays} ÙŠÙˆÙ…Ù‹Ø§! `;
            }
            
            if (successMessage === "") throw "âŒ Ù†ÙˆØ¹ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ Ø£Ùˆ ØºÙŠØ± Ù…Ø­Ø¯Ø¯";

            t.set(userRef, userData, {merge:true}); 
            
            t.update(codeRef, { 
                usedCount: firebase.firestore.FieldValue.increment(1), 
                redeemedBy: firebase.firestore.FieldValue.arrayUnion(user.uid) 
            }); 
            
            msgDiv.innerText = successMessage.trim();
            currentUserData = userData; 
            codeInput.value = ""; 

        }); 
    } catch(err) { 
        msgDiv.innerText = typeof err === "string" ? err : "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒÙˆØ¯"; 
        console.error("Redeem Error:", err); 
    } 
}


function openAdminPage(){ window.open("admin-promocode.html","_blank"); }
</script>
</body>
</html>

