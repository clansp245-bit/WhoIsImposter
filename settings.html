<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©</title>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="auth.js"></script> 

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
    :root {
        --primary: #6366f1;
        --accent-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
        --bg-body: #0a0f1e;
        --card-bg: rgba(30, 41, 59, 0.7);
        --text-main: #f1f5f9;
        --text-dim: #94a3b8;
        --gold: #ffd700;
        --danger: #ef4444;
    }

    body {
        font-family: 'Cairo', sans-serif;
        background-color: var(--bg-body);
        background-image: radial-gradient(circle at top right, #1e1b4b, transparent), radial-gradient(circle at bottom left, #1e1b4b, transparent);
        color: var(--text-main);
        text-align: center;
        padding: 20px;
        min-height: 100vh;
        margin: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    /* Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© */
    #home-link {
        align-self: flex-start;
        color: var(--text-dim);
        font-size: 1.5rem;
        text-decoration: none;
        transition: 0.3s;
        margin-bottom: 10px;
    }
    #home-link:hover { color: var(--primary); transform: translateX(5px); }

    h2 { font-size: 2.2rem; font-weight: 900; margin-bottom: 25px; background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

    .card {
        background: var(--card-bg);
        backdrop-filter: blur(15px);
        padding: 25px;
        border-radius: 24px;
        max-width: 480px;
        width: 100%;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        border: 1px solid rgba(255,255,255,0.1);
        text-align: right;
        box-sizing: border-box;
        margin-bottom: 20px;
    }

    label { display: block; margin-top: 20px; font-weight: 700; color: var(--text-main); font-size: 1rem; }
    
    input[type="number"], input[type="text"], textarea {
        width: 100%;
        margin-top: 8px;
        padding: 12px 15px;
        border-radius: 12px;
        border: 1px solid rgba(255,255,255,0.1);
        background: rgba(15, 23, 42, 0.6);
        color: white;
        font-family: 'Cairo';
        font-size: 1rem;
        box-sizing: border-box;
    }

    .toggle-container {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: 15px;
        padding: 15px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 15px;
        transition: 0.3s;
    }
    .toggle-container input[type="checkbox"] { width: 22px; height: 22px; accent-color: var(--primary); cursor: pointer; }

    .manual-role-container {
        border: 1px dashed rgba(99, 102, 241, 0.4);
        border-radius: 18px;
        padding: 15px;
        margin-top: 25px;
    }
    .manual-role-container h3 { font-size: 1.1rem; color: var(--gold); margin: 0 0 10px 0; display: flex; align-items: center; gap: 8px; }

    .words-section-header {
        text-align: center;
        margin: 30px 0 15px 0;
        font-weight: 900;
        font-size: 1.3rem;
        color: #34d399;
    }

    /* ÙØ¦Ø§Øª Ø§Ù„ÙƒÙ„Ù…Ø§Øª */
    .word-category {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 15px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.05);
        cursor: pointer;
        transition: 0.3s;
    }
    .word-category.selected { background: var(--primary); border-color: var(--primary); box-shadow: 0 0 15px rgba(99, 102, 241, 0.4); }
    .word-category.pro-category { border-right: 4px solid var(--gold); }
    .word-category:not(.unlocked).pro-category { opacity: 0.4; cursor: not-allowed; }

    .save-btn {
        background: var(--accent-gradient);
        color: white;
        border: none;
        padding: 18px;
        border-radius: 18px;
        width: 100%;
        font-size: 1.2rem;
        font-weight: 900;
        cursor: pointer;
        margin-top: 25px;
        box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);
    }

    .redeem-btn { background: #34d399; color: white; border: none; padding: 10px 20px; border-radius: 10px; font-weight: 700; cursor: pointer; width: 100%; margin-top: 10px; }

    small { color: var(--text-dim); display: block; margin-top: 5px; font-size: 0.85rem; }
</style>
</head>

<body onload="loadSettings()">

<div style="width: 100%; max-width: 480px;">
    <a href="index.html" id="home-link"><i class="fas fa-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø©</a>
</div>

<h2>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©</h2>

<div class="card">
    <label>Ù…Ø¤Ù‚Øª Ø§Ù„Ù…Ù†Ø§Ù‚Ø´Ø© (Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ)</label>
    <input type="number" id="discussionTimer" value="120" min="0">
    <div class="toggle-container">
        <label>Ø§Ù„Ù„Ø¹Ø¨ Ø¨Ù„Ø§ Ù…Ø¤Ù‚Øª (ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯)</label>
        <input type="checkbox" id="noTimerMode" onclick="toggleTimerInput()">
    </div>

    <label>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­ØªØ§Ù„ÙŠÙ†</label>
    <input type="number" id="impostors" value="1" min="1" max="5">

    <div class="toggle-container">
        <label>Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ± "Ù„Ø§ ÙƒÙ„Ù…Ø© Ù„Ùƒ!" (Ù…Ø¯Ù†ÙŠ)</label>
        <input type="checkbox" id="noWordRole">
    </div>

    <div class="toggle-container" style="border: 1px solid var(--gold);">
        <label>ÙˆØ¶Ø¹ Ø§Ù„ÙÙˆØ¶Ù‰ (Ø§Ù„ÙƒÙ„ Ù…Ø­ØªØ§Ù„ÙŠÙ†!) <i class="fas fa-crown" style="color:var(--gold);"></i></label>
        <input type="checkbox" id="chaosMode">
    </div>

    <div class="manual-role-container" id="manual-roles-section">
        <h3><i class="fas fa-fingerprint"></i> ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø£Ø¯ÙˆØ§Ø± ÙŠØ¯ÙˆÙŠØ§Ù‹ (Pro)</h3>
        <textarea id="manualImpostors" rows="2" placeholder="Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø­ØªØ§Ù„ÙŠÙ† (Ø§Ø³Ù… ÙÙŠ ÙƒÙ„ Ø³Ø·Ø±)"></textarea>
        <textarea id="manualNoWord" rows="2" placeholder="Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø°ÙŠÙ† Ø¨Ù„Ø§ ÙƒÙ„Ù…Ø© (Ø§Ø³Ù… ÙÙŠ ÙƒÙ„ Ø³Ø·Ø±)" style="margin-top:10px;"></textarea>
    </div>

    <div class="words-section-header">
         <i class="fas fa-layer-group"></i> ÙØ¦Ø§Øª Ø§Ù„ÙƒÙ„Ù…Ø§Øª
    </div>

    <div id="word-categories-container"></div>
    
    <button class="save-btn" onclick="saveSettings()">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª <i class="fas fa-check-circle"></i></button>
</div>

<div class="card" id="promocode-section">
    <h3 style="margin-top:0; color:var(--gold);"><i class="fas fa-gift"></i> ÙƒÙˆØ¯ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©</h3>
    <input type="text" id="promocode-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ù‡Ù†Ø§">
    <button class="redeem-btn" onclick="redeemCode()">Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙƒÙˆØ¯</button>
    <div id="promocode-msg" style="margin-top:10px; font-weight: 700;"></div>
    <button id="admin-promocode-btn" style="margin-top:15px; display:none; background:#475569;" class="redeem-btn" onclick="openAdminPage()">âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒÙˆØ¯Ø§Øª</button>
</div>

<script>
const impostorsInput = document.getElementById("impostors");
const timerInput = document.getElementById("discussionTimer");
const noTimerCheckbox = document.getElementById("noTimerMode");
let currentUserData = { totalCoins:0, proExpiryTime:0, players:[], settings:{}, receivedGifts: [] }; 

const wordCategories = {
    free: [
        { id: 'objects', name: 'Ø£Ø´ÙŠØ§Ø¡ ÙˆØ£Ø¯ÙˆØ§Øª', icon: 'fas fa-tools', count: 50 },
        { id: 'nature', name: 'Ø§Ù„Ø·Ø¨ÙŠØ¹Ø©', icon: 'fas fa-tree', count: 48 },
        { id: 'jobs', name: 'Ù…Ù‡Ù† ÙˆÙˆØ¸Ø§Ø¦Ù', icon: 'fas fa-briefcase', count: 45 }
    ],
    pro: [
        { id: 'foods', name: 'Ø£Ø·Ø¹Ù…Ø© ÙˆÙ…Ø´Ø±ÙˆØ¨Ø§Øª', icon: 'fas fa-hamburger', count: 47 },
        { id: 'animals', name: 'Ø­ÙŠÙˆØ§Ù†Ø§Øª ÙˆØ·ÙŠÙˆØ±', icon: 'fas fa-paw', count: 46 },
        { id: 'clothes', name: 'Ù…Ù„Ø§Ø¨Ø³', icon: 'fas fa-tshirt', count: 48 },
        { id: 'places', name: 'Ø£Ù…Ø§ÙƒÙ† ÙˆÙ…Ø¹Ø§Ù„Ù…', icon: 'fas fa-city', count: 47 },
        { id: 'activities', name: 'Ø£ÙØ¹Ø§Ù„ ÙˆÙ†Ø´Ø§Ø·Ø§Øª', icon: 'fas fa-running', count: 46 },
        { id: 'adjectives', name: 'ØµÙØ§Øª ÙˆØ£Ø­ÙˆØ§Ù„', icon: 'fas fa-star', count: 45 }
    ]
};

function isPro(){ return (currentUserData.proExpiryTime || 0) > new Date().getTime(); }
function toggleTimerInput(){ if(noTimerCheckbox.checked){timerInput.value=0; timerInput.disabled=true;}else{if(timerInput.value==0)timerInput.value=120;timerInput.disabled=false;} }

function renderWordCategories() {
    const container = document.getElementById('word-categories-container');
    container.innerHTML = '';
    const proStatus = isPro();
    
    const allCats = [
        ...wordCategories.free.map(c => ({...c, type: 'free'})),
        ...wordCategories.pro.map(c => ({...c, type: 'pro'}))
    ];

    allCats.forEach(cat => {
        const unlocked = cat.type === 'free' || proStatus;
        const div = document.createElement('div');
        div.className = `word-category ${cat.type === 'pro' ? 'pro-category' : ''} ${unlocked ? 'unlocked' : ''}`;
        div.setAttribute('data-id', cat.id);
        
        if(unlocked) div.onclick = () => toggleCategory(cat.id);

        div.innerHTML = `
            <div style="display:flex; align-items:center; gap:12px;">
                <i class="${cat.type === 'pro' && !proStatus ? 'fas fa-lock' : cat.icon}" style="font-size:1.2rem; color:${cat.type==='pro'?'var(--gold)':'#34d399'}"></i>
                <div style="text-align:right;">
                    <div style="font-weight:700;">${cat.name} ${cat.type==='pro'?'ğŸ‘‘':''}</div>
                    <small>${unlocked ? 'ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ '+cat.count+' ÙƒÙ„Ù…Ø©' : 'Ø­ØµØ±ÙŠ Ù„Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†'}</small>
                </div>
            </div>
            <input type="checkbox" id="cat-${cat.id}" ${!unlocked ? 'disabled' : ''}>
        `;
        container.appendChild(div);
    });
    loadSelectedCategories();
}

function toggleCategory(id) {
    const el = document.querySelector(`.word-category[data-id="${id}"]`);
    const cb = document.getElementById(`cat-${id}`);
    if(el && cb) {
        el.classList.toggle('selected');
        cb.checked = el.classList.contains('selected');
    }
}

function loadSelectedCategories() {
    const saved = currentUserData.settings?.selectedCategories || ['objects'];
    saved.forEach(id => {
        const el = document.querySelector(`.word-category[data-id="${id}"]`);
        const cb = document.getElementById(`cat-${id}`);
        if(el && cb && !cb.disabled) { el.classList.add('selected'); cb.checked = true; }
    });
}

async function loadSettings(){
  firebase.auth().onAuthStateChanged(async user=>{
    if(!user){window.location.href="auth.html"; return;}
    const data = await loadUserData();
    if(data) currentUserData = data;
    const pro = isPro();
    const settings = currentUserData.settings || {}; 
    
    document.getElementById("impostors").value = settings.impostors || 1;
    document.getElementById("noWordRole").checked = settings.noWordRole === true;
    
    if(settings.discussionTimer === 0){ 
        noTimerCheckbox.checked=true; timerInput.disabled=true; timerInput.value=0;
    } else {
        timerInput.value = settings.discussionTimer || 120;
    }

    const chaosCheckbox = document.getElementById("chaosMode");
    chaosCheckbox.disabled = !pro;
    chaosCheckbox.checked = pro && settings.chaosMode;
    
    document.getElementById("manualImpostors").value = (settings.manualImpostors || []).join('\n');
    document.getElementById("manualNoWord").value = (settings.manualNoWord || []).join('\n');
    if(!pro) document.getElementById("manual-roles-section").style.opacity = "0.5";

    renderWordCategories();
    if(user.email==="clansp245@gmail.com") document.getElementById("admin-promocode-btn").style.display="block";
  });
}

async function saveSettings(){
  const pro = isPro();
  const selectedCategories = Array.from(document.querySelectorAll('.word-category.selected')).map(el => el.getAttribute('data-id'));
  
  if(selectedCategories.length === 0) return alert("Ø§Ø®ØªØ± ÙØ¦Ø© ÙƒÙ„Ù…Ø§Øª ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„!");

  const settings = { 
      impostors: Number(impostorsInput.value), 
      chaosMode: pro && document.getElementById("chaosMode").checked, 
      noWordRole: document.getElementById("noWordRole").checked, 
      discussionTimer: noTimerCheckbox.checked ? 0 : Number(timerInput.value), 
      manualImpostors: document.getElementById("manualImpostors").value.split("\n").filter(s=>s.trim()), 
      manualNoWord: document.getElementById("manualNoWord").value.split("\n").filter(s=>s.trim()), 
      selectedCategories: selectedCategories 
  };
  
  const success = await saveUserData({ ...currentUserData, settings: settings });
  if(success) location.href="index.html";
}

async function redeemCode() {
    const code = document.getElementById('promocode-input').value.trim().toUpperCase();
    const msg = document.getElementById('promocode-msg');
    if(!code) return;

    try {
        const db = firebase.firestore();
        const res = await db.runTransaction(async t => {
            const doc = await t.get(db.collection("promocodes").doc(code));
            if(!doc.exists) throw "Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­";
            const d = doc.data();
            if(d.redeemedBy?.includes(firebase.auth().currentUser.uid)) throw "Ø§Ø³ØªØ®Ø¯Ù…Øª Ø§Ù„ÙƒÙˆØ¯ Ø³Ø§Ø¨Ù‚Ø§Ù‹";
            if(d.usedCount >= d.maxUses) throw "Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙƒÙˆØ¯";
            
            t.update(db.collection("promocodes").doc(code), {
                usedCount: firebase.firestore.FieldValue.increment(1),
                redeemedBy: firebase.firestore.FieldValue.arrayUnion(firebase.auth().currentUser.uid)
            });
            return d;
        });

        await updateCoinsAndProTime(currentUserData, res.coins || 0, res.durationDays || 0);
        msg.style.color = "#34d399";
        msg.innerText = "âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© Ø¨Ù†Ø¬Ø§Ø­!";
    } catch(e) {
        msg.style.color = "var(--danger)";
        msg.innerText = "âŒ " + e;
    }
}

function openAdminPage(){ window.open("admin-promocode.html","_blank"); }
</script>
</body>
</html>

