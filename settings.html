<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©</title>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="auth.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
body {
  font-family: 'Cairo', sans-serif;
  background-color: #0f172a; 
  color: #f1f5f9; 
  text-align: center;
  padding: 20px;
  min-height: 100vh;
  margin: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
}
h2 { font-size: 2rem; font-weight: 700; margin-bottom: 25px; color: #34d399; }
.card {
  background-color: #1e293b; 
  padding: 30px;
  border-radius: 12px;
  max-width: 450px;
  width: 90%;
  margin: 10px auto;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1), 0 10px 15px rgba(0,0,0,0.2);
  text-align: right;
}
label { display: block; margin-top: 15px; margin-bottom: 5px; font-weight: 700; color: #94a3b8; font-size: 0.95rem; }
textarea, select, input[type="number"], input[type="text"] {
  font-family: 'Cairo', sans-serif;
  width: 100%;
  margin: 8px 0 15px 0;
  padding: 14px 10px;
  border-radius: 8px;
  border: 1px solid #334155;
  font-size: 16px;
  background-color: #334155; 
  color: #f1f5f9;
  transition: border-color 0.3s, background-color 0.3s;
  box-sizing: border-box;
}
textarea:disabled, select:disabled, input:disabled { cursor: not-allowed; background-color: #1e293b; opacity: 0.8; }
.toggle-container { display: flex; align-items: center; justify-content: space-between; margin-top: 15px; padding: 12px 15px; background-color: #334155; border-radius: 8px; border-left: 5px solid transparent; transition: border-color 0.3s; }
.toggle-container.highlight { border-left-color: #ffcc00; }
.toggle-container label { margin: 0; font-weight: 700; color: #f1f5f9; font-size: 1rem; display: inline; }
.toggle-container input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; margin: 0; background-color: #1e293b; border: 1px solid #94a3b8; accent-color: #34d399; }
.manual-role-container { padding: 15px; border: 1px dashed #334155; border-radius: 8px; margin-top: 20px; text-align: left; }
.manual-role-container h3 { font-size: 1.1rem; color: #6366f1; margin-top: 0; border-bottom: 1px solid #334155; padding-bottom: 10px; margin-bottom: 15px; }
.manual-role-container textarea { min-height: 80px; }
button { margin-top: 15px; padding: 12px 30px; font-size: 18px; font-weight: 700; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s; background-color: #6366f1; color: #ffffff; width: 100%; box-shadow: 0 2px 4px rgba(0,0,0,0.15); }
</style>
</head>
<body onload="loadSettings()">

<h2>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©</h2>

<div class="card">
    <label for="discussionTimer">Ù…Ø¤Ù‚Øª Ø§Ù„Ù…Ù†Ø§Ù‚Ø´Ø© (Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ)</label>
    <input type="number" id="discussionTimer" value="120" min="0" max="600" onchange="toggleNoTimer()">
    <div class="toggle-container" style="margin-top: 10px;">
        <label for="noTimerMode">Ø§Ù„Ù„Ø¹Ø¨ Ø¨Ù„Ø§ Ù…Ø¤Ù‚Øª (ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯)</label>
        <input type="checkbox" id="noTimerMode" onclick="toggleTimerInput()">
    </div>
    <small style="color: #94a3b8; display:block; margin-top:-10px; margin-bottom:15px;">Ø§Ø¬Ø¹Ù„ Ø§Ù„Ù‚ÙŠÙ…Ø© 0 Ø£Ùˆ ÙØ¹Ù‘Ù„ Ø§Ù„Ø®ÙŠØ§Ø± Ù„Ù„Ø¹Ø¨ Ø¨Ù„Ø§ ÙˆÙ‚Øª.</small>

    <label for="impostors">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­ØªØ§Ù„ÙŠÙ†</label>
    <input type="number" id="impostors" value="1" min="1">

    <div class="toggle-container">
        <label for="multiWordMode">ÙƒÙ„Ù…Ø§Øª Ù…Ø¯Ù†ÙŠÙŠÙ† Ù…Ø®ØªÙ„ÙØ© (ØµØ¹ÙˆØ¨Ø© Ø¹Ø§Ù„ÙŠØ©)</label>
        <input type="checkbox" id="multiWordMode">
    </div>
    <small style="color:#94a3b8; display:block; margin-top:-10px; margin-bottom:15px;">ÙŠØ³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ø§Ù„ÙˆØ¶Ø¹ ÙƒÙ„Ù…ØªÙŠÙ† Ù…Ø®ØªÙ„ÙØªÙŠÙ† Ù„Ù„Ù…Ø¯Ù†ÙŠÙŠÙ† ÙˆØ§Ù„Ù…Ø­ØªØ§Ù„.</small>

    <div class="toggle-container">
        <label for="noWordRole">Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ± "Ù„Ø§ ÙƒÙ„Ù…Ø© Ù„Ùƒ!" (Ù…Ø¯Ù†ÙŠ)</label>
        <input type="checkbox" id="noWordRole">
    </div>

    <div class="toggle-container highlight" style="margin-top:25px;">
        <label for="chaosMode">ÙˆØ¶Ø¹ Ø§Ù„ÙÙˆØ¶Ù‰ (Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ù„Ø¬Ù…ÙŠØ¹ Ù…Ø­ØªØ§Ù„ÙŠÙ†!) <i class="fas fa-crown" style="color:#ffd700;"></i></label>
        <input type="checkbox" id="chaosMode">
    </div>

    <div class="manual-role-container" id="manual-roles-section">
        <h3>ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø£Ø¯ÙˆØ§Ø± ÙŠØ¯ÙˆÙŠØ§Ù‹ (Pro) <i class="fas fa-crown" style="color:#ffd700;"></i></h3>
        <small style="color:#94a3b8; display:block; margin-bottom:10px;">Ø£Ø¯Ø®Ù„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† (ÙƒÙ„ Ø§Ø³Ù… ÙÙŠ Ø³Ø·Ø±) Ø§Ù„Ø°ÙŠÙ† ØªØ±ÙŠØ¯ Ø£Ù† ÙŠÙƒÙˆÙ†ÙˆØ§ Ù…Ø­ØªØ§Ù„ÙŠÙ† Ø£Ùˆ Ø¨Ù„Ø§ ÙƒÙ„Ù…Ø©.</small>
        <label for="manualImpostors" style="color:#ff4f4f; margin-top:10px;">Ø§Ù„Ù…Ø­ØªØ§Ù„ÙˆÙ† ÙŠØ¯ÙˆÙŠØ§Ù‹</label>
        <textarea id="manualImpostors" rows="3" placeholder="Ø£Ø¯Ø®Ù„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø­ØªØ§Ù„ÙŠÙ† Ù‡Ù†Ø§..."></textarea>
        <label for="manualNoWord" style="color:#6366f1; margin-top:5px;">Ø¨Ù„Ø§ ÙƒÙ„Ù…Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹</label>
        <textarea id="manualNoWord" rows="3" placeholder="Ø£Ø¯Ø®Ù„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ø°ÙŠÙ† Ø¨Ù„Ø§ ÙƒÙ„Ù…Ø© Ù‡Ù†Ø§..."></textarea>
    </div>

    <label for="source">Ù…ØµØ¯Ø± Ø§Ù„ÙƒÙ„Ù…Ø§Øª</label>
    <select id="source">
        <option value="default">Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© (Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…)</option>
        <option value="custom">ÙƒÙ„Ù…Ø§ØªÙŠ (Ù…Ø®ØµØµØ©)</option>
        <option value="both">Ø§Ù„Ø§Ø«Ù†ÙŠÙ† Ù…Ø¹Ù‹Ø§</option>
    </select>

    <label for="words">ÙƒÙ„Ù…Ø§ØªÙƒ Ø§Ù„Ù…Ø®ØµØµØ© (ÙƒÙ„ ÙƒÙ„Ù…Ø© ÙÙŠ Ø³Ø·Ø± Ù…Ù†ÙØµÙ„)</label>
    <textarea id="words" rows="5" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø§ØªÙƒ Ù‡Ù†Ø§..."></textarea>

    <button onclick="saveSettings()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨</button>
</div>

<!-- Ù‚Ø³Ù… Ø§Ù„ÙƒÙˆØ¯Ø§Øª -->
<div class="card" id="promocode-section">
    <h3>ğŸ ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ… Ø£Ùˆ Ø§Ù„ÙƒÙˆÙŠÙ†Ø²</h3>
    <input type="text" id="promocode-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ù‡Ù†Ø§">
    <button onclick="redeemCode()">Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙƒÙˆØ¯</button>
    <div id="promocode-msg" style="margin-top:10px; color:#ffd700;"></div>
    <button id="admin-promocode-btn" style="margin-top:15px; display:none;" onclick="openAdminPage()">âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒÙˆØ¯Ø§Øª</button>
</div>

<script>
const impostorsInput = document.getElementById("impostors");
const timerInput = document.getElementById("discussionTimer");
const noTimerCheckbox = document.getElementById("noTimerMode");
let currentUserData = { totalCoins:0, proExpiryTime:0 };

function isPro(){ return (currentUserData.proExpiryTime || 0) > new Date().getTime(); }
function toggleTimerInput(){ if(noTimerCheckbox.checked){timerInput.value=0; timerInput.disabled=true;}else{if(timerInput.value==0)timerInput.value=120;timerInput.disabled=false;} }
function toggleNoTimer(){ if(Number(timerInput.value)===0){noTimerCheckbox.checked=true; timerInput.disabled=true;}else{noTimerCheckbox.checked=false; timerInput.disabled=false;} }

async function loadSettings(){
  firebase.auth().onAuthStateChanged(async user=>{
    if(!user){window.location.href="auth.html"; return;}
    const data = await loadUserData();
    if(data) currentUserData = data;
    const pro = isPro();

    const savedSettings = localStorage.getItem("settings");
    let settings = savedSettings ? JSON.parse(savedSettings) : {};
    document.getElementById("impostors").value = settings.impostors||1;
    document.getElementById("source").value = settings.source||"default";
    document.getElementById("words").value = Array.isArray(settings.customWords)?settings.customWords.join('\n'):"";

    const chaosCheckbox=document.getElementById("chaosMode");
    const manualSection=document.getElementById("manual-roles-section");
    const manualImpostors=document.getElementById("manualImpostors");
    const manualNoWord=document.getElementById("manualNoWord");
    document.getElementById("noWordRole").checked = settings.noWordRole===true;
    document.getElementById("multiWordMode").checked = settings.multiWordMode===true;

    chaosCheckbox.disabled=!pro; manualImpostors.disabled=!pro; manualNoWord.disabled=!pro;
    manualImpostors.value=Array.isArray(settings.manualImpostors)?settings.manualImpostors.join('\n'):"";
    manualNoWord.value=Array.isArray(settings.manualNoWord)?settings.manualNoWord.join('\n'):"";
    if(!pro){ chaosCheckbox.checked=false; manualImpostors.value=""; manualNoWord.value=""; manualSection.style.opacity=0.6; manualSection.title="Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© Ø­ØµØ±ÙŠØ© Ù„Ù…Ø´ØªØ±ÙƒÙŠ Pro"; } 
    else{ chaosCheckbox.checked=settings.chaosMode===true; manualSection.style.opacity=1; manualSection.title=""; }

    const savedTimer=settings.discussionTimer||120;
    if(savedTimer===0){ noTimerCheckbox.checked=true; timerInput.value=0; timerInput.disabled=true; } else { noTimerCheckbox.checked=false; timerInput.value=savedTimer; timerInput.disabled=false; }

    // Ø§Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø§Ø¯Ù…Ù† Ù„Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø­Ø¯Ø¯
    if(user.email==="clansp245@gmail.com"){ document.getElementById("admin-promocode-btn").style.display="block"; }
  });
}

function saveSettings(){
  const impostorsValue = Number(impostorsInput.value);
  const sourceValue = document.getElementById("source").value;
  const pro = isPro();
  let chaosModeEnabled = document.getElementById("chaosMode").checked;
  const noWordEnabled=document.getElementById("noWordRole").checked;
  const multiWordEnabled=document.getElementById("multiWordMode").checked;
  let timerValue=noTimerCheckbox.checked?0:Number(timerInput.value);
  const manualImpostorsArray=pro?document.getElementById("manualImpostors").value.split("\n").map(w=>w.trim()).filter(w=>w.length>0):[];
  const manualNoWordArray=pro?document.getElementById("manualNoWord").value.split("\n").map(w=>w.trim()).filter(w=>w.length>0):[];
  if(!pro) chaosModeEnabled=false;
  const customWordsArray=document.getElementById("words").value.split("\n").map(w=>w.trim()).filter(w=>w.length>0);

  if(impostorsValue<1||impostorsValue>10||isNaN(impostorsValue)){alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¯Ø¯ ØµØ­ÙŠØ­ Ù„Ù„Ù…Ø­ØªØ§Ù„ÙŠÙ† Ø¨ÙŠÙ† 1 Ùˆ 10."); return;}
  if(timerValue<0||isNaN(timerValue)){alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© Ù„Ù„Ù…Ø¤Ù‚Øª Ù…ÙˆØ¬Ø¨Ø© Ø£Ùˆ ØªÙØ¹ÙŠÙ„ Ø®ÙŠØ§Ø± 'Ø¨Ù„Ø§ Ù…Ø¤Ù‚Øª'."); return;}
  if((sourceValue==="custom"||sourceValue==="both")&&customWordsArray.length===0){alert("Ø§Ø®ØªØ±Øª Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙ„Ù…Ø§Øª Ù…Ø®ØµØµØ©. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø¹Ø¶ Ø§Ù„ÙƒÙ„Ù…Ø§Øª ÙÙŠ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚."); return;}

  const settings={ impostors:impostorsValue, source:sourceValue, customWords:customWordsArray, chaosMode:chaosModeEnabled, noWordRole:noWordEnabled, multiWordMode:multiWordEnabled, discussionTimer:timerValue, manualImpostors:manualImpostorsArray, manualNoWord:manualNoWordArray };
  localStorage.setItem("settings",JSON.stringify(settings));
  location.href="game.html";
}

// âš¡ Ø¯ÙˆØ§Ù„ Ø§Ù„ÙƒÙˆØ¯Ø§Øª
async function redeemCode() {
const codeInput = document.getElementById('promocode-input');
const msg = document.getElementById('promocode-msg');
const code = codeInput.value.trim();
if(!code){ msg.innerText = "âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ ØµØ§Ù„Ø­!"; return; }

const user = firebase.auth().currentUser; if(!user){ alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„."); return; } const db = firebase.firestore(); try { const codeRef = db.collection("promocodes").doc(code); await db.runTransaction(async t => { const doc = await t.get(codeRef); if(!doc.exists) throw "âŒ Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©"; const data = doc.data(); const usedBy = data.redeemedBy || []; const usedCount = data.usedCount || 0; const maxUses = data.maxUses || Infinity; const active = data.active !== false; // true Ø¥Ø°Ø§ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ if(!active) throw "â›” Ø§Ù„ÙƒÙˆØ¯ Ù…ÙˆÙ‚ÙˆÙ"; if(usedBy.includes(user.uid)) throw "âš ï¸ Ù„Ù‚Ø¯ Ø§Ø³ØªØ®Ø¯Ù…Øª Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§"; if(usedCount >= maxUses) throw "âŒ› Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙƒÙˆØ¯ (ÙˆØµÙ„ Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…)"; // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„ÙƒÙˆØ¯ let userData = await loadUserData(); const now = Date.now(); if(data.type === "coins"){ userData.totalCoins = (userData.totalCoins||0) + data.amount; msg.innerText = `ğŸ‰ ØªÙ… Ø¥Ø¶Ø§ÙØ© ${data.amount} ÙƒÙˆÙŠÙ†Ø² Ù„Ø­Ø³Ø§Ø¨Ùƒ!`; } else if(data.type === "pro"){ const currentExpiry = userData.proExpiryTime > now ? userData.proExpiryTime : now; userData.proExpiryTime = currentExpiry + (data.durationDays * 24*60*60*1000); msg.innerText = `ğŸ‰ ØªÙ… ØªÙØ¹ÙŠÙ„ Ø¹Ø¶ÙˆÙŠØ© Pro Ù„Ù…Ø¯Ø© ${data.durationDays} ÙŠÙˆÙ…Ù‹Ø§!`; } else { throw "âŒ Ù†ÙˆØ¹ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"; } // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… await saveUserData(userData.totalCoins, userData.proExpiryTime); // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙˆØ¯: Ø²ÙŠØ§Ø¯Ø© Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© t.update(codeRef, { usedCount: firebase.firestore.FieldValue.increment(1), redeemedBy: firebase.firestore.FieldValue.arrayUnion(user.uid) }); }); } catch(err) { msg.innerText = typeof err === "string" ? err : "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒÙˆØ¯"; console.error(err); } 

}



function openAdminPage(){ window.open("admin-promocode.html","_blank"); }
</script>
</body>
</html>
