<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ•µï¸ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± - Ø§Ù„Ù…Ø­ØªØ±Ù</title>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="auth.js"></script> 
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
:root {
    --primary: #6366f1;
    --success: #10b981;
    --danger: #ef4444;
    --warning: #f59e0b;
    --bg: #0f172a;
    --card-bg: #1e293b;
}

body {
    font-family: 'Cairo', sans-serif;
    background-color: var(--bg);
    color: #f1f5f9;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
    overflow-x: hidden;
}

/* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ */
.top-bar {
    width: 100%;
    padding: 15px 25px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-sizing: border-box;
    background: rgba(30, 41, 59, 0.5);
    backdrop-filter: blur(10px);
    position: sticky;
    top: 0;
    z-index: 100;
}

#coin-display {
    background: rgba(245, 158, 11, 0.15);
    color: #fbbf24;
    padding: 5px 15px;
    border-radius: 20px;
    font-weight: 800;
    border: 1px solid rgba(245, 158, 11, 0.3);
}

.home-link {
    color: #94a3b8;
    font-size: 1.5rem;
    transition: 0.3s;
}

/* Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
.game-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    width: 100%;
    max-width: 500px;
    padding: 20px;
}

#player-tag {
    background: var(--primary);
    padding: 5px 20px;
    border-radius: 10px;
    font-weight: 800;
    margin-bottom: 20px;
    box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
}

#player-name {
    font-size: 2.2rem;
    font-weight: 800;
    margin: 0 0 30px 0;
    color: #fff;
    text-shadow: 0 2px 10px rgba(0,0,0,0.3);
}

/* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø³Ø­Ø±ÙŠØ© */
.identity-card {
    width: 100%;
    aspect-ratio: 3/2;
    background: var(--card-bg);
    border-radius: 25px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    position: relative;
    border: 2px dashed rgba(148, 163, 184, 0.3);
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}

.identity-card.revealed {
    border-style: solid;
    border-color: var(--primary);
    transform: scale(1.02);
    background: linear-gradient(145deg, #1e293b, #0f172a);
}

.card-icon {
    font-size: 3rem;
    margin-bottom: 15px;
    color: #475569;
}

.instruction {
    color: #94a3b8;
    font-size: 1.1rem;
}

/* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
.action-btn {
    margin-top: 40px;
    width: 100%;
    padding: 15px;
    border: none;
    border-radius: 15px;
    background: var(--primary);
    color: white;
    font-size: 1.2rem;
    font-weight: 800;
    cursor: pointer;
    transition: 0.3s;
    box-shadow: 0 5px 15px rgba(99, 102, 241, 0.4);
}

.action-btn:active { transform: scale(0.95); }

/* Ø§Ù„Ù…Ø¤Ù‚Øª */
#timer-box {
    display: none;
    text-align: center;
    animation: fadeIn 0.5s;
}

#timer-display {
    font-size: 4rem;
    font-weight: 800;
    color: var(--warning);
    font-family: monospace;
}

@keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
</style>
</head>

<body onload="loadGameData()">

<div class="top-bar">
    <div id="coin-display"><i class="fas fa-coins"></i> <span id="total-coins-value">0</span></div>
    <a href="index.html" class="home-link"><i class="fas fa-circle-chevron-right"></i></a>
</div>

<div class="game-container">
    <div id="setup-view">
        <div id="player-tag">Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
        <h1 id="player-name">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h1>

        <div id="card" class="identity-card" 
             ontouchstart="showRole()" ontouchend="hideRole()" 
             onmousedown="showRole()" onmouseup="hideRole()">
            <i class="fas fa-fingerprint card-icon"></i>
            <span class="instruction">Ø§Ø¶ØºØ· Ù…Ø·ÙˆÙ„Ø§Ù‹ Ù„Ù„ÙƒØ´Ù</span>
        </div>

        <button id="nextBtn" class="action-btn" onclick="nextPlayer()">Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„ØªØ§Ù„ÙŠ <i class="fas fa-arrow-left"></i></button>
    </div>

    <div id="timer-box">
        <h2 style="color: var(--success)">ğŸ—£ï¸ ÙˆÙ‚Øª Ø§Ù„Ù†Ù‚Ø§Ø´!</h2>
        <div id="timer-display">00:00</div>
        <p id="end-msg" style="color: #94a3b8">ØªØ­Ø¯Ø«ÙˆØ§ Ø¨Ø­Ø°Ø±.. Ø§Ù„Ù…Ø­ØªØ§Ù„ Ø¨ÙŠÙ†ÙƒÙ…!</p>
    </div>
</div>

<script>
let players = [];
let settings = {};
let currentIndex = 0;
let roles = [];
let civilWord = "";
let impostorWord = "";
const IMP = "IMPOSTOR";
const NW = "NO_WORD";

// Ø¬Ù„Ø¨ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù†ÙØ³ Ø§Ù„ÙƒØ§Ø¦Ù† Ø§Ù„Ø³Ø§Ø¨Ù‚)
const wordCategories = {
    free: [
        { id: 'objects', words: ["Ù‚Ù„Ù…", "ÙƒÙˆØ¨", "ÙƒØ±Ø³ÙŠ", "Ù…ÙØªØ§Ø­", "Ù‡Ø§ØªÙ", "ÙƒØªØ§Ø¨", "Ø³Ø§Ø¹Ø©", "Ù…ØµØ¨Ø§Ø­", "Ù…Ù„Ø¹Ù‚Ø©", "Ø­Ø°Ø§Ø¡", "Ø­Ù‚ÙŠØ¨Ø©"] },
        { id: 'nature', words: ["Ø´Ø¬Ø±Ø©", "Ù†Ù‡Ø±", "Ø¬Ø¨Ù„", "Ø³Ù…Ø§Ø¡", "Ø¨Ø­Ø±", "Ø´Ù…Ø³", "Ù‚Ù…Ø±", "Ù†Ø¬Ù…", "ØºÙŠÙ…Ø©", "Ù…Ø·Ø±"] }
    ],
    pro: [
        { id: 'foods', words: ["ØªÙØ§Ø­", "Ù…ÙˆØ²", "Ø¨Ø±ØªÙ‚Ø§Ù„", "Ù…Ø§Ø¡", "Ù‚Ù‡ÙˆØ©", "Ø´Ø§ÙŠ", "Ø®Ø¨Ø²", "Ø£Ø±Ø²"] },
        { id: 'animals', words: ["ÙƒÙ„Ø¨", "Ù‚Ø·Ø©", "Ø£Ø³Ø¯", "Ù†Ù…Ø±", "ÙÙŠÙ„", "Ø²Ø±Ø§ÙØ©", "Ù‚Ø±Ø¯"] }
    ]
};

async function loadGameData() {
    auth.onAuthStateChanged(async (user) => {
        if (!user) { window.location.href = "auth.html"; return; }
        
        const data = await loadUserData();
        if (data) {
            players = data.players || [];
            settings = data.settings || { discussionTimer: 60, selectedCategories: ['objects'], impostors: 1 };
            document.getElementById("total-coins-value").innerText = data.totalCoins || 0;

            if (players.length < 3) {
                alert("ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© 3 Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹.");
                window.location.href = "index.html";
                return;
            }

            players.sort(() => Math.random() - 0.5);
            setupRoles();
            updateUI();
        }
    });
}

function setupRoles() {
    const isUserPro = isPro();
    let allWords = [];
    const cats = settings.selectedCategories || ['objects'];

    // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø©
    [...wordCategories.free, ...wordCategories.pro].forEach(cat => {
        if (cats.includes(cat.id)) {
            const isProCat = wordCategories.pro.some(p => p.id === cat.id);
            if (!isProCat || isUserPro) allWords.push(...cat.words);
        }
    });

    civilWord = allWords[Math.floor(Math.random() * allWords.length)];
    impostorWord = civilWord;

    // ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±
    roles = Array(players.length).fill("CIVILIAN");
    let indices = Array.from(Array(players.length).keys()).sort(() => Math.random() - 0.5);
    
    for (let j = 0; j < (settings.impostors || 1); j++) {
        roles[indices[j]] = IMP;
    }
}

function updateUI() {
    document.getElementById("player-name").innerText = players[currentIndex];
}

function showRole() {
    const card = document.getElementById("card");
    card.classList.add("revealed");
    const role = roles[currentIndex];
    
    if (role === "CIVILIAN") {
        card.innerHTML = `<h2 style="color:var(--success)">Ù…Ø¯Ù†ÙŠ</h2><p>Ø§Ù„ÙƒÙ„Ù…Ø©: ${civilWord}</p>`;
    } else if (role === IMP) {
        card.innerHTML = `<h2 style="color:var(--danger)">Ù…Ø­ØªØ§Ù„ ğŸ˜ˆ</h2><p>${settings.multiWordMode ? 'Ø§Ù„ÙƒÙ„Ù…Ø©: ' + impostorWord : 'Ø­Ø§ÙˆÙ„ Ø§Ù„ØªÙ…ÙˆÙŠÙ‡!'}</p>`;
    }
}

function hideRole() {
    const card = document.getElementById("card");
    card.classList.remove("revealed");
    card.innerHTML = `<i class="fas fa-fingerprint card-icon"></i><span class="instruction">Ø§Ø¶ØºØ· Ù…Ø·ÙˆÙ„Ø§Ù‹ Ù„Ù„ÙƒØ´Ù</span>`;
}

async function nextPlayer() {
    currentIndex++;
    if (currentIndex >= players.length) {
        document.getElementById("setup-view").style.display = "none";
        document.getElementById("timer-box").style.display = "block";
        startDiscussion(settings.discussionTimer);
        
        // Ù…Ù†Ø­ Ø§Ù„Ø¬ÙˆØ§Ø¦Ø²
        const data = await loadUserData();
        await addXPAndCoins(data, 10, 20);
    } else {
        updateUI();
    }
}

function startDiscussion(seconds) {
    let timeLeft = seconds;
    const display = document.getElementById("timer-display");
    
    const interval = setInterval(() => {
        let m = Math.floor(timeLeft / 60);
        let s = timeLeft % 60;
        display.innerText = `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        
        if (timeLeft <= 0) {
            clearInterval(interval);
            display.innerText = "Ø§Ù†ØªÙ‡Ù‰!";
            alert("Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª! Ø§Ø¨Ø¯Ø£ÙˆØ§ Ø§Ù„ØªØµÙˆÙŠØª Ø§Ù„Ø¢Ù†.");
        }
        timeLeft--;
    }, 1000);
}
</script>
</body>
</html>

