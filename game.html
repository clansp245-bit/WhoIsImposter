<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ•µï¸ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±</title>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="auth.js"></script> 
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
body {
  font-family: 'Cairo', sans-serif;
  background-color: #0f172a; 
  color: #f1f5f9; 
  text-align: center;
  padding: 20px;
  min-height: 100vh;
  margin: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: space-around; 
}
#player { font-size: 2rem; font-weight: 700; margin-top: 50px; color: #34d399; min-height: 30px; }
#card {
  width: 300px; height: 200px; background-color: #1e293b; color: #f1f5f9;
  border-radius: 15px; margin: 50px auto;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  font-size: 24px; font-weight: 700; cursor: pointer;
  box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4); 
  transition: transform 0.3s ease-out, background-color 0.3s;
}
#card.revealed { background-color: #6366f1; color: #ffffff; transform: translateY(-20px); box-shadow: 0 12px 20px rgba(99, 102, 241, 0.5); }
.instruction-text { font-size: 16px; font-weight: 400; margin-top: 10px; color: #94a3b8; }
button {
  margin-top: 30px; padding: 12px 30px; font-size: 18px; font-weight: 700;
  border: none; border-radius: 8px; cursor: pointer;
  transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s;
  background-color: #6366f1; color: #ffffff; box-shadow: 0 2px 4px rgba(0,0,0,0.15);
}
#home-icon { position: absolute; top: 20px; right: 20px; font-size: 24px; color: #94a3b8; cursor: pointer; transition: color 0.3s; }
#timer-container { font-size: 2.5rem; font-weight: 700; color: #ffcc00; margin-top: 30px; display: none; }
#end-message { font-size: 1.5rem; color: #34d399; margin: 20px; display: none; }
#coin-display { position: absolute; top: 20px; left: 20px; font-size: 1.2rem; font-weight: 700; color: #ffd700; }
</style>
</head>

<body onload="loadGameData()">

<a href="index.html" id="home-icon" title="Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"><i class="fas fa-home"></i></a>

<div id="coin-display">
    <i class="fas fa-coins"></i> Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="total-coins-value">0</span>
</div>

<h2 id="player"></h2>

<div id="card" ontouchstart="show()" ontouchend="hide()" onmousedown="show()" onmouseup="hide()">
    <span>Ø§Ø³Ø­Ø¨ Ø£Ùˆ Ø§Ø¶ØºØ· Ù…Ø¹ Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø±</span>
    <div class="instruction-text">Ù„Ù„ÙƒØ´Ù Ø¹Ù† Ø¯ÙˆØ±Ùƒ</div>
</div>

<button id="nextBtn" onclick="next()">Ø§Ù„ØªØ§Ù„ÙŠ <i class="fas fa-arrow-left"></i></button>

<div id="timer-container">00:00</div>
<div id="end-message"></div>

<script>
let players = JSON.parse(localStorage.getItem("players") || "[]");
let settings = JSON.parse(localStorage.getItem("settings") || "{}");

const playerDisplay = document.getElementById("player");
const card = document.getElementById("card");
const nextBtn = document.getElementById("nextBtn");
const timerContainer = document.getElementById("timer-container");
const endMessage = document.getElementById("end-message");
const totalCoinsValue = document.getElementById("total-coins-value");

let i = 0, roles = [], civilWord = "", impostorWord = "";
const IMP = "IMPOSTOR_ROLE_MARKER", NW = "NO_WORD_ROLE_MARKER";
let timerInterval, gameCompleted = false;
let currentUserData = { totalCoins: 0, proExpiryTime: 0 };

async function loadGameData() {
    firebase.auth().onAuthStateChanged(async (user) => {
        if (!user) { alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹."); window.location.href = "auth.html"; return; }
        if (players.length < 3) { alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ 3 Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„."); location.href="settings.html"; return; }
        const data = await loadUserData();
        if(data) currentUserData = data;
        displayTotalCoins(); setupGameRoles(); playerDisplay.innerText = `Ø¯ÙˆØ±: ${players[i]}`;
    });
}

function isPro() { return (currentUserData.proExpiryTime || 0) > new Date().getTime(); }
function getTotalCoins() { return currentUserData.totalCoins || 0; }
function displayTotalCoins() { totalCoinsValue.innerText = getTotalCoins(); }

async function calculateAndAddCoins() {
    const proMultiplier = isPro()?1.5:1;
    const baseCoins = Math.floor(Math.random()*(15-5+1))+5;
    const coinsEarned = Math.floor(baseCoins*proMultiplier);
    const newTotalCoins = getTotalCoins() + coinsEarned;
    const saved = await saveUserData(newTotalCoins,currentUserData.proExpiryTime||0);
    if(saved){ currentUserData.totalCoins=newTotalCoins; displayTotalCoins(); alert(`ğŸ‰ ØªÙ… Ø¥Ø¶Ø§ÙØ© ${coinsEarned} ÙƒÙˆÙŠÙ†Ø²! Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙˆÙŠÙ†Ø²: ${newTotalCoins}`);}
    else alert("âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„ÙƒÙˆÙŠÙ†Ø².");
}

function setupGameRoles(){
    let defaultWords = ["ØªÙØ§Ø­","Ø³ÙŠØ§Ø±Ø©","Ù…Ø¯Ø±Ø³Ø©","Ø¨Ø­Ø±","Ù‡Ø§ØªÙ","Ø·Ø§Ø¦Ø±Ø©","Ø¬ÙˆØ§Ù„","Ù…ÙƒØªØ¨Ø©","Ø·Ø§ÙˆÙ„Ø©","ÙƒØ±Ø³ÙŠ"];
    let proWords = ["ÙƒÙˆÙƒØ¨","Ø¬Ø§Ø³ÙˆØ³","Ø§Ù„Ù…Ø§Ø³","Ù…Ø®ØªØ±Ø¹","Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ©","Ø´Ù„Ø§Ù„","Ù…ØªØ§Ù‡Ø©"];
    let words=[];
    if(settings.source==="default") words=defaultWords;
    else if(settings.source==="custom" && Array.isArray(settings.customWords)) words=settings.customWords;
    else if(settings.source==="both" && Array.isArray(settings.customWords)) words=defaultWords.concat(settings.customWords);
    if(isPro()) words=words.concat(proWords);
    words=[...new Set(words)];
    if(words.length===0){alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙƒÙ„Ù…Ø§Øª."); location.href="settings.html"; return;}
    if(settings.multiWordMode && words.length>=2){ civilWord=words[Math.floor(Math.random()*words.length)]; impostorWord=words.filter(w=>w!==civilWord)[Math.floor(Math.random()*words.filter(w=>w!==civilWord).length)];}
    else { civilWord=impostorWord=words[Math.floor(Math.random()*words.length)]; }
    const totalPlayers=players.length;
    roles=Array(totalPlayers).fill(null);
    const indices=Array.from({length:totalPlayers},(_,k)=>k).sort(()=>Math.random()-0.5);
    if(isPro()&&(settings.manualImpostors?.length||settings.manualNoWord?.length)){
        settings.manualImpostors?.forEach(name=>{const idx=players.indexOf(name);if(idx!==-1)roles[idx]=IMP;});
        settings.manualNoWord?.forEach(name=>{const idx=players.indexOf(name);if(idx!==-1&&roles[idx]!==IMP)roles[idx]=NW;});
    } else if(settings.chaosMode && isPro() && Math.random()<0.2){
        roles=Array(totalPlayers).fill(IMP);
        for(let j=0;j<Math.floor(totalPlayers*0.2);j++) roles[indices[j]]=NW;
    } else {
        const numImpostors=settings.impostors||1;
        let numNoWord=settings.noWordRole?1:0,currImp=0,currNW=0;
        for(let j=0;j<totalPlayers;j++){ const idx=indices[j];
            if(currImp<numImpostors){ roles[idx]=IMP; currImp++; }
            else if(currNW<numNoWord){ roles[idx]=NW; currNW++; }
        }
    }
    for(let k=0;k<totalPlayers;k++){ if(roles[k]===null)roles[k]=civilWord;}
}

function show(){
    card.classList.add("revealed");
    const roleMarker=roles[i]; let displayWord="";
    if(roleMarker===civilWord){ displayWord=`<span style="color:#34d399;">Ø¯ÙˆØ±Ùƒ: Ø§Ù„Ù…Ø¯Ù†ÙŠ</span>`;
        displayWord+=`<div class="instruction-text" style="font-size:1.5rem;color:#f1f5f9;">Ø§Ù„ÙƒÙ„Ù…Ø©: ${civilWord}</div>`; }
    else if(roleMarker===NW) displayWord=`<span style="color:#6366f1;">Ù„Ø§ ÙƒÙ„Ù…Ø© Ù„Ùƒ!</span>`;
    else if(roleMarker===IMP){ displayWord=`<span style="color:#ff4f4f;">Ø£Ù†Øª Ø§Ù„Ù…Ø­ØªØ§Ù„ ğŸ˜ˆ</span>`;
        if(settings.multiWordMode) displayWord+=`<div class="instruction-text" style="font-size:1.5rem;color:#f1f5f9;">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø­ØªØ§Ù„: ${impostorWord}</div><div class="instruction-text" style="font-size:0.8rem;color:#ffcc00;">*ØªØ°ÙƒÙ‘Ø± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø¯Ù†ÙŠ: ${civilWord}*</div>`; }
    else displayWord=`<span style="color:#ffcc00;">Ø®Ø·Ø£: Ø¯ÙˆØ± ØºÙŠØ± Ù…Ø¹Ø±Ù!</span>`;
    card.innerHTML=displayWord;
}
function hide(){ card.classList.remove("revealed"); card.innerHTML=`<span>Ø§Ø³Ø­Ø¨ Ø£Ùˆ Ø§Ø¶ØºØ· Ù…Ø¹ Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø±</span><div class="instruction-text">Ù„Ù„ÙƒØ´Ù Ø¹Ù† Ø¯ÙˆØ±Ùƒ</div>`; }

function startTimer(duration){
    if(!duration||isNaN(duration)||duration<=0){timerContainer.style.display='none'; return;}
    timerContainer.style.display='block'; nextBtn.style.display='none';
    let timeRemaining=duration; clearInterval(timerInterval);
    function updateTimerDisplay(){
        const minutes=String(Math.floor(timeRemaining/60)).padStart(2,'0');
        const seconds=String(timeRemaining%60).padStart(2,'0');
        timerContainer.innerText=`${minutes}:${seconds}`;
        if(timeRemaining<=0){ clearInterval(timerInterval); timerContainer.innerText="Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª!"; timerContainer.style.color='#ff4f4f'; calculateAndAddCoins(); alert("â° Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ù…Ù†Ø§Ù‚Ø´Ø©! Ø­Ø§Ù† ÙˆÙ‚Øª Ø§Ù„ØªØµÙˆÙŠØª."); }
        timeRemaining--;
    }
    updateTimerDisplay(); timerInterval=setInterval(updateTimerDisplay,1000);
}

function next(){
    if(card.classList.contains("revealed")) hide(); i++;
    if(i>=players.length){ gameCompleted=true; playerDisplay.innerText="ØªÙ… ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±! Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù†Ù‚Ø§Ø´."; card.style.display='none'; nextBtn.style.display='none'; endMessage.style.display='block'; endMessage.innerText="Ø­Ø§Ù† ÙˆÙ‚Øª Ø§Ù„Ù…Ù†Ø§Ù‚Ø´Ø© ğŸ—£ï¸"; startTimer(settings.discussionTimer); if(!settings.discussionTimer||settings.discussionTimer===0) calculateAndAddCoins(); return;}
    playerDisplay.innerText=`Ø¯ÙˆØ±: ${players[i]}`;
}
</script>

</body>
</html>
