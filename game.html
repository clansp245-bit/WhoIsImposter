<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ•µï¸ Ø§Ù„Ù…Ø­ØªØ§Ù„ - Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="auth.js"></script> 
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        :root { --primary: #6366f1; --bg: #0f172a; --card-bg: #1e293b; }
        body { font-family: 'Cairo', sans-serif; background-color: var(--bg); color: #f1f5f9; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .top-bar { width: 100%; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(10px); }
        .identity-card { width: 85vw; max-width: 450px; height: 350px; background: var(--card-bg); border-radius: 35px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; border: 4px dashed rgba(255, 255, 255, 0.1); transition: all 0.3s; user-select: none; -webkit-user-select: none; }
        .identity-card.revealed { border-style: solid; border-color: var(--primary); background: #2563eb; transform: scale(1.02); }
        .action-btn { margin-top: 40px; width: 80%; max-width: 300px; padding: 20px; border-radius: 20px; background: var(--primary); color: white; font-weight: 800; border: none; cursor: pointer; }
        #timer-display { font-size: 5rem; color: #f59e0b; font-weight: 900; }
    </style>
</head>

<body onload="initGame()">
    <div class="top-bar">
        <div id="coin-display"><i class="fas fa-coins"></i> <span id="total-coins-value">...</span></div>
        <a href="index.html" style="color:#94a3b8; font-size: 1.8rem;"><i class="fas fa-times-circle"></i></a>
    </div>

    <div id="setup-view" style="width: 100%; display: flex; flex-direction: column; align-items: center; margin-top: 30px;">
        <h1 id="player-name" style="font-size: 2.5rem; margin-bottom: 20px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h1>
        <div id="card" class="identity-card" onmousedown="showRole()" onmouseup="hideRole()" ontouchstart="showRole()" ontouchend="hideRole()">
            <i class="fas fa-fingerprint" style="font-size: 5rem; color: #475569; margin-bottom: 20px;"></i>
            <span id="instruction-text">Ø§Ø¶ØºØ· Ù…Ø·ÙˆÙ„Ø§Ù‹ Ù„Ù„ÙƒØ´Ù</span>
        </div>
        <button id="nextBtn" class="action-btn" onclick="nextPlayer()">Ø§Ù„ØªØ§Ù„ÙŠ</button>
    </div>

    <div id="timer-box" style="display:none; text-align:center; margin-top:50px;">
        <h1 id="status-msg">ğŸ—£ï¸ ÙˆÙ‚Øª Ø§Ù„Ù†Ù‚Ø§Ø´!</h1>
        <div id="timer-display">00:00</div>
    </div>

<script>
// Ù†Ø³Ø®Ø© Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒÙ„Ù…Ø§Øª ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¹Ù…Ù„
const wordData = {
    free: [
        { id: 'objects', words: ["Ù‚Ù„Ù…", "ÙƒÙˆØ¨", "ÙƒØ±Ø³ÙŠ", "Ù…ÙØªØ§Ø­", "Ù‡Ø§ØªÙ", "ÙƒØªØ§Ø¨", "Ø³Ø§Ø¹Ø©", "Ù…ØµØ¨Ø§Ø­", "Ù…Ù„Ø¹Ù‚Ø©", "Ø­Ù‚ÙŠØ¨Ø©"] },
        { id: 'nature', words: ["Ø´Ø¬Ø±Ø©", "Ù†Ù‡Ø±", "Ø¬Ø¨Ù„", "Ø³Ù…Ø§Ø¡", "Ø¨Ø­Ø±", "Ø´Ù…Ø³", "Ù‚Ù…Ø±", "ØºÙŠÙ…Ø©", "Ù…Ø·Ø±", "Ø«Ù„Ø¬"] },
        { id: 'jobs', words: ["Ø·Ø¨ÙŠØ¨", "Ù…Ø¹Ù„Ù…", "Ù…Ù‡Ù†Ø¯Ø³", "Ø´Ø±Ø·ÙŠ", "Ø®Ø¨Ø§Ø²", "Ù…Ø²Ø§Ø±Ø¹", "Ù†Ø¬Ø§Ø±", "Ø·Ø¨Ø§Ø®", "Ø±Ø³Ø§Ù…"] }
    ],
    pro: [
        { id: 'foods', words: ["ØªÙØ§Ø­", "Ù…ÙˆØ²", "Ø¨Ø±ØªÙ‚Ø§Ù„", "Ø£Ø±Ø²", "Ø¨ÙŠØªØ²Ø§", "Ù„Ø­Ù…", "Ø¯Ø¬Ø§Ø¬", "Ø³Ù…Ùƒ", "Ø¹ØµÙŠØ±"] },
        { id: 'animals', words: ["ÙƒÙ„Ø¨", "Ù‚Ø·Ø©", "Ø£Ø³Ø¯", "Ù†Ù…Ø±", "ÙÙŠÙ„", "Ø²Ø±Ø§ÙØ©", "Ù‚Ø±Ø¯", "Ø­ØµØ§Ù†", "Ø¬Ù…Ù„"] },
        { id: 'places', words: ["Ù…Ø¯Ø±Ø³Ø©", "Ù…Ø³ØªØ´ÙÙ‰", "Ù…Ù†Ø²Ù„", "Ù…Ø³Ø¬Ø¯", "Ø³ÙˆÙ‚", "Ù…Ø·Ø§Ø±", "Ø­Ø¯ÙŠÙ‚Ø©", "Ù…ØªØ­Ù"] }
    ]
};

let gamePlayers = [];
let currentIndex = 0;
let civilWord = "";
let gameSettings = {};
let userData = null;

async function initGame() {
    auth.onAuthStateChanged(async (user) => {
        if (!user) return window.location.href = "auth.html";
        
        userData = await loadUserData();
        if(!userData) return;

        gameSettings = userData.settings || {};
        const playersList = userData.players || [];
        
        document.getElementById("total-coins-value").innerText = userData.totalCoins;

        if (playersList.length < 3) {
            alert("Ø£Ø¶Ù 3 Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.");
            window.location.href = "index.html";
            return;
        }

        // --- 1. Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙƒÙ„Ù…Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ---
        let pool = [];
        const selectedCats = gameSettings.selectedCategories || ['objects'];
        
        [...wordData.free, ...wordData.pro].forEach(cat => {
            if (selectedCats.includes(cat.id)) pool.push(...cat.words);
        });

        if (pool.length === 0) pool = wordData.free[0].words; // Ø§Ø­ØªÙŠØ§Ø·ÙŠ
        civilWord = pool[Math.floor(Math.random() * pool.length)];

        // --- 2. ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ---
        let roles = Array(playersList.length).fill("CIVILIAN");
        
        // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­ØªØ§Ù„ÙŠÙ†
        let impostorCount = gameSettings.chaosMode ? playersList.length : (parseInt(gameSettings.impostors) || 1);
        impostorCount = Math.min(impostorCount, playersList.length - (gameSettings.chaosMode ? 0 : 1));

        let currentImpostors = 0;
        while(currentImpostors < impostorCount) {
            let r = Math.floor(Math.random() * playersList.length);
            if(roles[r] === "CIVILIAN") { roles[r] = "IMPOSTOR"; currentImpostors++; }
        }

        // Ø®Ù„Ø· Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù…Ø¹ Ø£Ø¯ÙˆØ§Ø±Ù‡Ù…
        gamePlayers = playersList.map((p, i) => ({ name: p, role: roles[i] }))
                                 .sort(() => Math.random() - 0.5);

        updateUI();
    });
}

function updateUI() {
    document.getElementById("player-name").innerText = gamePlayers[currentIndex].name;
    hideRole(); // Ù‚Ù„Ø¨ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
}

function showRole() {
    const card = document.getElementById("card");
    const player = gamePlayers[currentIndex];
    card.classList.add("revealed");

    if (player.role === "IMPOSTOR") {
        card.innerHTML = `<i class="fas fa-user-secret" style="font-size:5rem; color:#ff4f4f;"></i>
                          <h2 style="color:#ff4f4f;">Ø£Ù†Øª Ø§Ù„Ù…Ø­ØªØ§Ù„ ğŸ˜ˆ</h2>
                          <p>Ø­Ø§ÙˆÙ„ Ø§ÙƒØªØ´Ø§Ù Ø§Ù„ÙƒÙ„Ù…Ø©!</p>`;
    } else {
        // ÙØ­Øµ Ù…ÙŠØ²Ø© "Ø¨Ù„Ø§ ÙƒÙ„Ù…Ø© Ù„Ùƒ"
        const isNoWord = gameSettings.noWordRole && (Math.random() > 0.8); 
        if(isNoWord) {
             card.innerHTML = `<i class="fas fa-comment-slash" style="font-size:4rem;"></i>
                              <h2>Ù„Ø§ ÙƒÙ„Ù…Ø© Ù„Ùƒ! ğŸ˜¶</h2>
                              <p>Ø­Ø§ÙˆÙ„ Ø§Ù„ØªÙ…ÙˆÙŠÙ‡ ÙƒØ£Ù†Ùƒ ØªØ¹Ø±ÙÙ‡Ø§</p>`;
        } else {
             card.innerHTML = `<i class="fas fa-user-check" style="font-size:3rem;"></i>
                              <h2>Ø£Ù†Øª Ù…Ø¯Ù†ÙŠ</h2>
                              <div style="font-size:2.5rem; background:white; color:#2563eb; padding:15px 35px; border-radius:20px; margin-top:15px; font-weight:900;">${civilWord}</div>`;
        }
    }
}

function hideRole() {
    const card = document.getElementById("card");
    card.classList.remove("revealed");
    card.innerHTML = `<i class="fas fa-fingerprint" style="font-size: 5rem; color: #475569; margin-bottom: 20px;"></i>
                      <span>Ø§Ø¶ØºØ· Ù…Ø·ÙˆÙ„Ø§Ù‹ Ù„Ù„ÙƒØ´Ù</span>`;
}

function nextPlayer() {
    currentIndex++;
    if (currentIndex >= gamePlayers.length) {
        document.getElementById("setup-view").style.display = "none";
        document.getElementById("timer-box").style.display = "block";
        startDiscussion();
    } else {
        updateUI();
    }
}

function startDiscussion() {
    // --- 3. ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø¤Ù‚Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ---
    let timeLeft = parseInt(gameSettings.discussionTimer);
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø¤Ù‚Øª 0 Ø£Ùˆ Ù…ÙØ¹Ù„ Ø®ÙŠØ§Ø± "Ø¨Ù„Ø§ Ù…Ø¤Ù‚Øª"
    if (isNaN(timeLeft) || timeLeft <= 0) {
        document.getElementById("timer-display").innerText = "âˆ";
        document.getElementById("status-msg").innerText = "Ù„Ø¹Ø¨ Ø­Ø± (Ø¨Ø¯ÙˆÙ† ÙˆÙ‚Øª)";
        giveRewards(); // Ø¬ÙˆØ§Ø¦Ø² ÙÙˆØ±ÙŠØ© ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø­Ø±
        return;
    }

    const display = document.getElementById("timer-display");
    const timer = setInterval(() => {
        let m = Math.floor(timeLeft / 60);
        let s = timeLeft % 60;
        display.innerText = `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        
        if (timeLeft <= 0) {
            clearInterval(timer);
            display.innerText = "00:00";
            document.getElementById("status-msg").innerText = "Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª! ØµÙˆØªÙˆØ§ Ø§Ù„Ø¢Ù†";
            giveRewards();
        }
        timeLeft--;
    }, 1000);
}

async function giveRewards() {
    if(userData) {
        const reward = await addXPAndCoins(userData, 20, 40);
        console.log("Rewards added:", reward);
    }
}
</script>
</body>
</html>
