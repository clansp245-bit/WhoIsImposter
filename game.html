<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ•µï¸ Ø§Ù„Ù…Ø­ØªØ§Ù„ - Ø§Ù„Ù„Ø¹Ø¨</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="auth.js"></script> 
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        /* Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª (Ù†ÙØ³ Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ Ø§Ù„Ø³Ø§Ø¨Ù‚) */
        :root { --primary: #6366f1; --bg: #0f172a; --card-bg: #1e293b; }
        body { font-family: 'Cairo', sans-serif; background-color: var(--bg); color: #f1f5f9; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow-x: hidden; }
        .top-bar { width: 100%; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(10px); }
        .identity-card { width: 85vw; max-width: 450px; height: 350px; background: var(--card-bg); border-radius: 35px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; border: 4px dashed rgba(255, 255, 255, 0.1); transition: all 0.3s; user-select: none; -webkit-user-select: none; }
        .identity-card.revealed { border-style: solid; border-color: var(--primary); background: #2563eb; transform: scale(1.02); }
        .action-btn { margin-top: 40px; width: 80%; max-width: 300px; padding: 20px; border-radius: 20px; background: var(--primary); color: white; font-weight: 800; border: none; cursor: pointer; }
        #timer-display { font-size: 5rem; color: #f59e0b; font-weight: 900; }
    </style>
</head>

<body onload="initGame()">
    <div class="top-bar">
        <div id="coin-display"><i class="fas fa-coins"></i> <span id="total-coins-value">...</span></div>
        <a href="index.html" style="color:#94a3b8; font-size: 1.8rem;"><i class="fas fa-times-circle"></i></a>
    </div>

    <div id="setup-view" style="width: 100%; display: flex; flex-direction: column; align-items: center; margin-top: 30px;">
        <h1 id="player-name" style="font-size: 2.5rem; margin-bottom: 20px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h1>
        <div id="card" class="identity-card" onmousedown="showRole()" onmouseup="hideRole()" ontouchstart="showRole()" ontouchend="hideRole()">
            <i class="fas fa-fingerprint" style="font-size: 5rem; color: #475569; margin-bottom: 20px;"></i>
            <span>Ø§Ø¶ØºØ· Ù…Ø·ÙˆÙ„Ø§Ù‹ Ù„Ù„ÙƒØ´Ù</span>
        </div>
        <button id="nextBtn" class="action-btn" onclick="nextPlayer()">Ø§Ù„ØªØ§Ù„ÙŠ</button>
    </div>

    <div id="timer-box" style="display:none; text-align:center; margin-top:50px;">
        <h1 id="status-msg">ğŸ—£ï¸ ÙˆÙ‚Øª Ø§Ù„Ù†Ù‚Ø§Ø´!</h1>
        <div id="timer-display">00:00</div>
    </div>

<script>
// Ù†Ø£Ø®Ø° Ù…ØµÙÙˆÙØ© Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ù…Ù† ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ·Ø§Ø¨Ù‚
const allCategories = {
    free: [
        { id: 'objects', words: ["Ù‚Ù„Ù…", "ÙƒÙˆØ¨", "ÙƒØ±Ø³ÙŠ", "Ù…ÙØªØ§Ø­", "Ù‡Ø§ØªÙ", "ÙƒØªØ§Ø¨", "Ø³Ø§Ø¹Ø©"] },
        { id: 'nature', words: ["Ø´Ø¬Ø±Ø©", "Ù†Ù‡Ø±", "Ø¬Ø¨Ù„", "Ø³Ù…Ø§Ø¡", "Ø¨Ø­Ø±", "Ø´Ù…Ø³", "Ù‚Ù…Ø±"] },
        { id: 'jobs', words: ["Ø·Ø¨ÙŠØ¨", "Ù…Ø¹Ù„Ù…", "Ù…Ù‡Ù†Ø¯Ø³", "Ø´Ø±Ø·ÙŠ", "Ø®Ø¨Ø§Ø²", "Ù…Ø²Ø§Ø±Ø¹"] }
    ],
    pro: [
        { id: 'foods', words: ["ØªÙØ§Ø­", "Ù…ÙˆØ²", "Ø¨Ø±ØªÙ‚Ø§Ù„", "Ø£Ø±Ø²", "Ø¨ÙŠØªØ²Ø§", "Ø³Ù„Ø·Ø©"] },
        { id: 'animals', words: ["Ø£Ø³Ø¯", "Ù†Ù…Ø±", "ÙÙŠÙ„", "Ø²Ø±Ø§ÙØ©", "Ù‚Ø±Ø¯", "Ø­ØµØ§Ù†"] }
    ]
};

let players = [];
let roles = [];
let currentIndex = 0;
let civilWord = "";
let impostorWord = "ØŸØŸØŸ"; // Ù„Ù„Ù…ÙˆØ¯ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
let settings = {};
let userData = null;

async function initGame() {
    auth.onAuthStateChanged(async (user) => {
        if (!user) return window.location.href = "auth.html";
        
        userData = await loadUserData();
        settings = userData.settings || { impostors: 1, discussionTimer: 60, selectedCategories: ['objects'] };
        players = userData.players || [];
        
        document.getElementById("total-coins-value").innerText = userData.totalCoins;

        if (players.length < 3) {
            alert("Ø£Ø¶Ù 3 Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø¹Ø¨.");
            window.location.href = "index.html";
            return;
        }

        prepareGameLogic();
        updateUI();
    });
}

function prepareGameLogic() {
    // 1. ØªØ¬Ù…ÙŠØ¹ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    let selectedWords = [];
    const chosenIds = settings.selectedCategories || ['objects'];
    
    [...allCategories.free, ...allCategories.pro].forEach(cat => {
        if (chosenIds.includes(cat.id)) selectedWords.push(...cat.words);
    });

    // Ø§Ø®ØªÙŠØ§Ø± ÙƒÙ„Ù…Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
    civilWord = selectedWords[Math.floor(Math.random() * selectedWords.words?.length)] || selectedWords[0] || "Ù‚Ù„Ù…";

    // 2. ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­ØªØ§Ù„ÙŠÙ† ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    roles = Array(players.length).fill("CIVILIAN");
    
    let impostorCount = settings.chaosMode ? players.length : (settings.impostors || 1);
    // ØªØ£ÙƒØ¯ Ø£Ù† Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­ØªØ§Ù„ÙŠÙ† Ù„Ø§ ÙŠØªØ¬Ø§ÙˆØ² Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
    impostorCount = Math.min(impostorCount, players.length - 1);
    if(settings.chaosMode) impostorCount = players.length; // ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ÙÙˆØ¶Ù‰ Ø§Ù„ÙƒÙ„ Ù…Ù…ÙƒÙ† ÙŠÙƒÙˆÙ† Ù…Ø­ØªØ§Ù„

    let count = 0;
    while(count < impostorCount) {
        let rand = Math.floor(Math.random() * players.length);
        if(roles[rand] === "CIVILIAN") {
            roles[rand] = "IMPOSTOR";
            count++;
        }
    }

    // Ø®Ù„Ø· ØªØ±ØªÙŠØ¨ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
    players = players.map((p, i) => ({name: p, role: roles[i]}))
                     .sort(() => Math.random() - 0.5);
}

function updateUI() {
    document.getElementById("player-name").innerText = players[currentIndex].name;
    hideRole();
}

function showRole() {
    const card = document.getElementById("card");
    const player = players[currentIndex];
    card.classList.add("revealed");

    if (player.role === "IMPOSTOR") {
        card.innerHTML = `<i class="fas fa-user-secret" style="font-size:4rem; color:#ff4f4f;"></i>
                          <h2 style="color:#ff4f4f;">Ø£Ù†Øª Ø§Ù„Ù…Ø­ØªØ§Ù„ ğŸ˜ˆ</h2>
                          <p>Ø®Ø¯Ø¹ Ø§Ù„Ø¬Ù…ÙŠØ¹!</p>`;
    } else {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø®ÙŠØ§Ø± "Ø¨Ù„Ø§ ÙƒÙ„Ù…Ø© Ù„Ùƒ" Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        if (settings.noWordRole && Math.random() > 0.7) {
             card.innerHTML = `<i class="fas fa-comment-slash" style="font-size:4rem;"></i>
                              <h2>Ù„Ø§ ÙƒÙ„Ù…Ø© Ù„Ùƒ! ğŸ˜¶</h2>
                              <p>Ø­Ø§ÙˆÙ„ Ù…Ø³Ø§ÙŠØ±Ø© Ø§Ù„Ø¨Ù‚ÙŠØ©</p>`;
        } else {
             card.innerHTML = `<i class="fas fa-user-check" style="font-size:3rem;"></i>
                              <h2>Ø£Ù†Øª Ù…Ø¯Ù†ÙŠ</h2>
                              <div style="font-size:2.2rem; background:white; color:#2563eb; padding:10px 25px; border-radius:15px; margin-top:10px;">${civilWord}</div>`;
        }
    }
}

function hideRole() {
    const card = document.getElementById("card");
    card.classList.remove("revealed");
    card.innerHTML = `<i class="fas fa-fingerprint" style="font-size: 5rem; color: #475569; margin-bottom: 20px;"></i><span>Ø§Ø¶ØºØ· Ù…Ø·ÙˆÙ„Ø§Ù‹ Ù„Ù„ÙƒØ´Ù</span>`;
}

function nextPlayer() {
    currentIndex++;
    if (currentIndex >= players.length) {
        document.getElementById("setup-view").style.display = "none";
        document.getElementById("timer-box").style.display = "block";
        startDiscussion();
    } else {
        updateUI();
    }
}

function startDiscussion() {
    let timeLeft = settings.discussionTimer || 60;
    if (timeLeft === 0) { // ÙˆØ¶Ø¹ Ø§Ù„Ù„Ø¹Ø¨ Ø¨Ù„Ø§ Ù…Ø¤Ù‚Øª
        document.getElementById("timer-display").innerText = "âˆ";
        giveRewards();
        return;
    }

    const interval = setInterval(() => {
        let m = Math.floor(timeLeft / 60);
        let s = timeLeft % 60;
        document.getElementById("timer-display").innerText = `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        if (timeLeft <= 0) {
            clearInterval(interval);
            document.getElementById("status-msg").innerText = "Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª!";
            giveRewards();
        }
        timeLeft--;
    }, 1000);
}

async function giveRewards() {
    const reward = await addXPAndCoins(userData, 10, 20);
    alert(`Ø­ØµÙ„Øª Ø¹Ù„Ù‰ ${reward.coins} ÙƒÙˆÙŠÙ†Ø² Ùˆ ${reward.xp} XP!`);
}
</script>
</body>
</html>
