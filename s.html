<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ›¡ï¸ ØªØ­Ø§Ù„ÙØ§Øª Ø§Ù„Ø£Ø³Ø§Ø·ÙŠØ± - ØªØ®ØµÙŠØµ ÙƒØ§Ù…Ù„</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="auth.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        :root {
            --primary: #6366f1;
            --clan-gold: #fbbf24;
            --clan-bg: rgba(30, 41, 59, 0.7);
            --danger: #ef4444;
            --glass: rgba(255, 255, 255, 0.05);
            --gem-color: #06b6d4;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: #0a0f1e;
            background-image: radial-gradient(circle at top right, #1e1b4b, transparent);
            color: #f1f5f9; padding: 20px; min-height: 100vh; margin: 0;
        }

        .clan-header { text-align: center; margin-bottom: 30px; }
        .clan-header h1 { font-weight: 900; font-size: 2.2rem; color: var(--clan-gold); text-shadow: 0 0 20px rgba(251, 191, 36, 0.3); }

        .tabs {
            display: flex; gap: 10px; background: var(--clan-bg); padding: 5px; border-radius: 15px;
            max-width: 500px; margin: 0 auto 25px;
        }
        .tab-btn {
            flex: 1; padding: 12px; border: none; background: transparent; color: #94a3b8;
            cursor: pointer; font-family: 'Cairo'; font-weight: bold; border-radius: 12px; transition: 0.3s;
        }
        .tab-btn.active { background: var(--primary); color: white; }

        .clan-container { max-width: 600px; margin: 0 auto; }

        .card {
            background: var(--clan-bg); backdrop-filter: blur(15px); border: 1px solid var(--glass);
            border-radius: 24px; padding: 25px; margin-bottom: 20px; transition: 0.5s;
        }

        .clan-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 15px; border-radius: 18px; margin-bottom: 10px;
            transition: 0.3s; border: 1px solid var(--glass);
        }
        
        .clan-icon { 
            width: 50px; height: 50px; border-radius: 12px; 
            display: flex; align-items: center; justify-content: center; font-size: 1.5rem; 
        }

        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª ÙÙˆØ±Ù… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ */
        .create-form { display: flex; flex-direction: column; gap: 12px; }
        .create-form label { font-size: 0.8rem; color: #94a3b8; margin-bottom: -8px; }
        .create-form input, .create-form select {
            padding: 12px; border-radius: 12px; border: 1px solid var(--glass); background: #0f172a; color: white; font-family: 'Cairo';
        }
        .color-pickers { display: flex; gap: 10px; }
        .color-field { flex: 1; display: flex; flex-direction: column; gap: 5px; }
        .color-field input { height: 45px; padding: 2px; cursor: pointer; }

        .btn-create {
            background: var(--clan-gold); color: #000; font-weight: 900; padding: 15px;
            border: none; border-radius: 12px; cursor: pointer; transition: 0.3s; margin-top: 10px;
        }

        .member-item { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid var(--glass); }
        .role-tag { font-size: 0.75rem; padding: 3px 10px; border-radius: 6px; background: var(--primary); font-weight: bold; }
        
        .gem-requirement { 
            color: var(--gem-color); font-weight: 900; font-size: 1.1rem; 
            background: rgba(6, 182, 212, 0.1); padding: 10px; border-radius: 10px; display: inline-block;
        }
        .loader { text-align: center; padding: 30px; font-size: 1.2rem; color: var(--primary); }
    </style>
</head>
<body>

    <div class="clan-header">
        <h1>ğŸ›¡ï¸ ØªØ­Ø§Ù„ÙØ§Øª Ø§Ù„Ø£Ø³Ø§Ø·ÙŠØ±</h1>
        <p>ØµÙ…Ù… Ù‡ÙˆÙŠØªÙƒ Ø§Ù„Ø®Ø§ØµØ© ÙˆØ³ÙŠØ·Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø§Ø­Ø©</p>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="showTab('explore')"><i class="fas fa-compass"></i> Ø§Ø³ØªÙƒØ´Ø§Ù</button>
        <button class="tab-btn" onclick="showTab('myclan')"><i class="fas fa-shield-halved"></i> ÙƒÙ„Ø§Ù†ÙŠ</button>
        <button class="tab-btn" onclick="showTab('create')"><i class="fas fa-plus"></i> Ø¥Ù†Ø´Ø§Ø¡</button>
    </div>

    <div class="clan-container">
        <div id="tab-explore" class="tab-content card">
            <div id="explore-list">
                <div class="loader"><i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ­Ø¶Ø§Ø± Ø§Ù„ØªØ­Ø§Ù„ÙØ§Øª...</div>
            </div>
        </div>

        <div id="tab-create" class="tab-content card" style="display:none;">
            <div class="create-form">
                <h2 style="margin:0; text-align: center;">ØªØ£Ø³ÙŠØ³ ØªØ­Ø§Ù„ÙÙƒ</h2>
                <div style="text-align:center;">
                    <p class="gem-requirement"><i class="fas fa-gem"></i> Ø§Ù„ØªÙƒÙ„ÙØ©: 1 Ø¬ÙˆÙ‡Ø±Ø©</p>
                </div>

                <label>Ø§Ø³Ù… Ø§Ù„ØªØ­Ø§Ù„Ù</label>
                <input type="text" id="newClanName" placeholder="Ù…Ø«Ù„Ø§Ù‹: ØµÙ‚ÙˆØ± Ø§Ù„Ø¬Ø­ÙŠÙ…">
                
                <label>ÙˆØµÙ Ø§Ù„ØªØ­Ø§Ù„Ù</label>
                <input type="text" id="newClanDesc" placeholder="Ø´Ø¹Ø§Ø±Ù†Ø§ Ù‡Ùˆ Ø§Ù„ÙÙˆØ² Ø¯Ø§Ø¦Ù…Ø§Ù‹...">

                <label>Ø§Ø®ØªØ± Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ÙƒÙ„Ø§Ù†</label>
                <select id="newClanIcon">
                    <option value="fa-shield-alt">ğŸ›¡ï¸ Ø¯Ø±Ø¹</option>
                    <option value="fa-fire">ğŸ”¥ Ù†Ø§Ø±</option>
                    <option value="fa-skull">ğŸ’€ Ø¬Ù…Ø¬Ù…Ø©</option>
                    <option value="fa-crown">ğŸ‘‘ ØªØ§Ø¬</option>
                    <option value="fa-dragon">ğŸ‰ ØªÙ†ÙŠÙ†</option>
                    <option value="fa-ghost">ğŸ‘» Ø´Ø¨Ø­</option>
                    <option value="fa-bolt">âš¡ ØµØ§Ø¹Ù‚Ø©</option>
                    <option value="fa-khanda">âš”ï¸ Ø³ÙŠÙˆÙ</option>
                </select>

                <div class="color-pickers">
                    <div class="color-field">
                        <label>Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ©</label>
                        <input type="color" id="newClanBgColor" value="#1e293b">
                    </div>
                    <div class="color-field">
                        <label>Ù„ÙˆÙ† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©</label>
                        <input type="color" id="newClanIconColor" value="#fbbf24">
                    </div>
                </div>

                <button class="btn-create" onclick="createNewClan()">ØªØ£Ø³ÙŠØ³ Ø§Ù„ØªØ­Ø§Ù„Ù Ø§Ù„Ø¢Ù†</button>
            </div>
        </div>

        <div id="tab-myclan" class="tab-content card" style="display:none;">
            <div id="my-clan-details">
                <div class="loader">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
            </div>
        </div>
    </div>

<script>
    let userData = {};

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            const userDoc = await db.collection("users").doc(user.uid).get();
            userData = userDoc.data() || {};
            loadClans();
            checkMyClan();
        } else { window.location.href = "auth.html"; }
    });

    function showTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-' + tabName).style.display = 'block';
        event.currentTarget.classList.add('active');
    }

    async function loadClans() {
        const list = document.getElementById('explore-list');
        const snap = await db.collection("clans").orderBy("power", "desc").limit(15).get();
        list.innerHTML = "";
        
        snap.forEach(doc => {
            const clan = doc.data();
            list.innerHTML += `
                <div class="clan-item" style="background: ${clan.bgColor || 'rgba(255,255,255,0.05)'}">
                    <div class="clan-info">
                        <div class="clan-icon" style="color: ${clan.iconColor || '#fff'}; background: rgba(0,0,0,0.3)">
                            <i class="fas ${clan.icon || 'fa-shield-alt'}"></i>
                        </div>
                        <div>
                            <div class="clan-name" style="font-weight:900">${clan.name}</div>
                            <div style="font-size:0.7rem; opacity:0.7">${clan.membersCount}/20 Ø¹Ø¶Ùˆ</div>
                        </div>
                    </div>
                    <button class="tab-btn active" style="padding:5px 15px; width:auto; flex:none;" onclick="joinClan('${doc.id}')">Ø§Ù†Ø¶Ù…Ø§Ù…</button>
                </div>
            `;
        });
    }

    async function createNewClan() {
        const name = document.getElementById('newClanName').value.trim();
        const desc = document.getElementById('newClanDesc').value.trim();
        const icon = document.getElementById('newClanIcon').value;
        const iconColor = document.getElementById('newClanIconColor').value;
        const bgColor = document.getElementById('newClanBgColor').value;
        const user = auth.currentUser;

        if (name.length < 3) return alert("Ø§Ù„Ø§Ø³Ù… Ù‚ØµÙŠØ±!");
        if ((userData.s_gems || 0) < 1) return alert("ØªØ­ØªØ§Ø¬ Ø¬ÙˆÙ‡Ø±Ø© ÙˆØ§Ø­Ø¯Ø©!");

        try {
            await db.collection("users").doc(user.uid).update({
                s_gems: firebase.firestore.FieldValue.increment(-1),
                clanId: name 
            });

            await db.collection("clans").doc(name).set({
                name: name,
                description: desc,
                icon: icon,
                iconColor: iconColor,
                bgColor: bgColor,
                leaderId: user.uid,
                leaderName: userData.displayName || "Ù„Ø§Ø¹Ø¨",
                membersCount: 1,
                power: 0,
                createdAt: Date.now()
            });

            await db.collection("clans").doc(name).collection("members").doc(user.uid).set({
                name: userData.displayName || "Ù„Ø§Ø¹Ø¨",
                role: 'leader',
                joinedAt: Date.now()
            });

            alert("ØªÙ… Ø§Ù„ØªØ£Ø³ÙŠØ³ Ø¨Ù†Ø¬Ø§Ø­!");
            location.reload();
        } catch(e) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡"); }
    }

    async function checkMyClan() {
        const container = document.getElementById('my-clan-details');
        if (!userData.clanId) {
            container.innerHTML = `<p style="text-align:center;">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØªØ­Ø§Ù„Ù Ø­Ø§Ù„ÙŠØ§Ù‹.</p>`;
            return;
        }

        const clanDoc = await db.collection("clans").doc(userData.clanId).get();
        const clan = clanDoc.data();
        
        // ØªØºÙŠÙŠØ± Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù„ØªÙ†Ø§Ø³Ø¨ Ù„ÙˆÙ† Ø§Ù„ÙƒÙ„Ø§Ù†
        document.getElementById('tab-myclan').style.background = `linear-gradient(135deg, ${clan.bgColor}, rgba(10,15,30,0.9))`;

        container.innerHTML = `
            <div style="text-align:center;">
                <div class="clan-icon" style="margin: 0 auto 15px; width:80px; height:80px; font-size:2.5rem; color:${clan.iconColor}; background:rgba(0,0,0,0.3); border-radius:20px;">
                    <i class="fas ${clan.icon}"></i>
                </div>
                <h2 style="margin:0; text-shadow: 0 0 10px ${clan.iconColor}55;">${clan.name}</h2>
                <p style="opacity:0.8;">${clan.description}</p>
                <div style="display:flex; justify-content:space-around; margin:20px 0; background:rgba(0,0,0,0.2); padding:10px; border-radius:15px;">
                    <div><small>Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</small><br><b>${clan.membersCount}/20</b></div>
                    <div><small>Ø§Ù„Ù‚ÙˆØ©</small><br><b>${clan.power}</b></div>
                </div>
            </div>
            <div id="members-list-box"></div>
            <button class="btn-leave" style="color:#ff4444; background:none; border:none; cursor:pointer; margin-top:20px;" onclick="leaveClan()">Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØªØ­Ø§Ù„Ù</button>
        `;
        loadClanMembers(userData.clanId);
    }

    async function loadClanMembers(clanId) {
        const snap = await db.collection("clans").doc(clanId).collection("members").get();
        const box = document.getElementById('members-list-box');
        box.innerHTML = "<h3>Ø§Ù„Ù…Ø­Ø§Ø±Ø¨ÙˆÙ†:</h3>";
        snap.forEach(doc => {
            const m = doc.data();
            box.innerHTML += `<div class="member-item"><span>${m.name}</span><span class="role-tag">${m.role == 'leader' ? 'Ø§Ù„Ù‚Ø§Ø¦Ø¯' : 'Ù…Ø­Ø§Ø±Ø¨'}</span></div>`;
        });
    }

    // Ø¯ÙˆØ§Ù„ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… ÙˆØ§Ù„Ù…ØºØ§Ø¯Ø±Ø© ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚...
    async function joinClan(clanId) {
        if (userData.clanId) return alert("ØºØ§Ø¯Ø± ØªØ­Ø§Ù„ÙÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø£ÙˆÙ„Ø§Ù‹!");
        try {
            await db.collection("clans").doc(clanId).update({ membersCount: firebase.firestore.FieldValue.increment(1) });
            await db.collection("clans").doc(clanId).collection("members").doc(auth.currentUser.uid).set({
                name: userData.displayName || "Ù„Ø§Ø¹Ø¨", role: 'member', joinedAt: Date.now()
            });
            await db.collection("users").doc(auth.currentUser.uid).update({ clanId: clanId });
            location.reload();
        } catch(e) { alert("ÙØ´Ù„ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…"); }
    }

    async function leaveClan() {
        if (!confirm("Ù…ØªØ£ÙƒØ¯ØŸ")) return;
        const cid = userData.clanId;
        await db.collection("clans").doc(cid).collection("members").doc(auth.currentUser.uid).delete();
        await db.collection("clans").doc(cid).update({ membersCount: firebase.firestore.FieldValue.increment(-1) });
        await db.collection("users").doc(auth.currentUser.uid).update({ clanId: null });
        location.reload();
    }
</script>
</body>
</html>
