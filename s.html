<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”¥ Ø£Ø³Ø§Ø·ÙŠØ± Ø§Ù„ØªØ­Ø§Ù„ÙØ§Øª - Ultimate Edition</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="auth.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        :root {
            --primary: #8b5cf6;
            --gold: #fbbf24;
            --dark-bg: #0f172a;
            --card-bg: #1e293b;
            --danger: #ef4444;
            --success: #10b981;
            --glass: rgba(255, 255, 255, 0.08);
            --neon-glow: 0 0 15px rgba(139, 92, 246, 0.5);
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: #020617;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(99, 102, 241, 0.15) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(236, 72, 153, 0.15) 0%, transparent 20%);
            color: #f8fafc; margin: 0; padding: 15px; min-height: 100vh;
        }

        /* Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© */
        .header { text-align: center; margin-bottom: 20px; position: relative; }
        .currency-badge {
            background: rgba(0,0,0,0.6); border: 1px solid var(--gold);
            padding: 5px 15px; border-radius: 20px; color: var(--gold);
            font-weight: bold; display: inline-flex; align-items: center; gap: 5px;
            font-size: 0.9rem; margin-top: 5px;
        }

        /* Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª */
        .nav-bar {
            display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 15px;
            scrollbar-width: none;
        }
        .nav-btn {
            background: var(--card-bg); border: 1px solid var(--glass); color: #94a3b8;
            padding: 12px 20px; border-radius: 12px; white-space: nowrap; cursor: pointer;
            transition: 0.3s; font-family: 'Cairo'; font-weight: bold; flex: 1; text-align: center;
        }
        .nav-btn.active {
            background: var(--primary); color: white; box-shadow: var(--neon-glow); border-color: var(--primary);
        }

        /* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© */
        .card {
            background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px);
            border: 1px solid var(--glass); border-radius: 20px; padding: 20px;
            animation: slideUp 0.4s ease; display: none;
        }
        .card.active-view { display: block; }

        /* ØµÙØ­Ø© Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© */
        .creation-container { display: flex; flex-direction: column; align-items: center; gap: 20px; }
        .preview-circle {
            width: 120px; height: 120px; border-radius: 50%;
            background: var(--card-bg); border: 4px solid var(--glass);
            display: flex; align-items: center; justify-content: center;
            font-size: 3rem; color: white; box-shadow: 0 0 30px rgba(0,0,0,0.5);
            transition: 0.3s;
        }
        .input-group { width: 100%; }
        .input-group input, .input-group select {
            width: 100%; padding: 14px; margin-bottom: 12px;
            background: #0f172a; border: 1px solid var(--glass); border-radius: 12px;
            color: white; font-family: 'Cairo'; box-sizing: border-box;
        }

        /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ */
        .member-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px; border-bottom: 1px solid var(--glass);
        }
        .member-actions { display: flex; gap: 5px; }
        .btn-mini {
            padding: 5px 10px; border-radius: 8px; border: none; cursor: pointer; font-size: 0.8rem;
        }
        .btn-kick { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .btn-promo { background: rgba(251, 191, 36, 0.2); color: var(--gold); }

        /* Ø§Ù„Ù…ØªØ¬Ø± */
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .shop-item {
            background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(0,0,0,0.2));
            border: 1px solid var(--glass); border-radius: 15px; padding: 15px;
            text-align: center; position: relative; overflow: hidden;
        }
        .shop-item.locked { opacity: 0.5; filter: grayscale(1); pointer-events: none; }
        .item-price { color: var(--primary); font-weight: 900; margin-top: 5px; }
        
        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
        .btn-main {
            width: 100%; padding: 15px; border-radius: 15px; border: none;
            font-weight: 900; font-size: 1rem; cursor: pointer; transition: 0.2s;
            background: linear-gradient(45deg, var(--primary), #ec4899); color: white;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }
        .btn-danger { background: var(--danger); box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4); }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="header">
        <h1 style="margin:0; text-shadow: 0 0 20px var(--primary);">ğŸ›¡ï¸ CLANS SYSTEM</h1>
        <div id="user-cp-display" class="currency-badge">
            <i class="fas fa-coins"></i> <span id="cp-val">0</span> CP
        </div>
    </div>

    <div class="nav-bar">
        <button class="nav-btn active" onclick="switchTab('home')">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        <button class="nav-btn" onclick="switchTab('shop')">Ø§Ù„Ù…ØªØ¬Ø± ğŸ›’</button>
        <button class="nav-btn" onclick="switchTab('rank')">Ø§Ù„ØªØµÙ†ÙŠÙ ğŸ†</button>
        <button class="nav-btn" onclick="switchTab('create')">Ø¥Ù†Ø´Ø§Ø¡ âš’ï¸</button>
    </div>

    <div id="view-home" class="card active-view">
        <div id="my-clan-content">
            <div style="text-align:center; padding:40px; color:#64748b;">
                <i class="fas fa-search" style="font-size:2rem; margin-bottom:10px;"></i><br>
                Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¨ÙŠØ§Ù†Ø§ØªÙƒ...
            </div>
        </div>
    </div>

    <div id="view-shop" class="card">
        <div style="text-align:center; margin-bottom:15px;">
            <h3>ğŸ›’ Ù…ØªØ¬Ø± Ø§Ù„ÙƒÙ„Ø§Ù† Ø§Ù„Ø£Ø³ÙˆØ¯</h3>
            <p style="font-size:0.8rem; color:#94a3b8;">Ø§Ø¬Ù…Ø¹ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„ÙŠÙˆÙ…ÙŠØ© ÙˆØ§Ø´ØªØ±ÙŠ Ø£ØºØ±Ø§Ø¶ Ù†Ø§Ø¯Ø±Ø©</p>
            <button id="daily-btn" onclick="collectDailyPoints()" class="btn-main" style="background:var(--success); margin-bottom:20px;">
                ğŸ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ
            </button>
        </div>
        <div class="shop-grid" id="shop-container">
            </div>
    </div>

    <div id="view-rank" class="card">
        <h3 style="text-align:center;">ğŸ† Ø§Ù„Ø£Ù‚ÙˆÙ‰ Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹</h3>
        <div id="leaderboard-list"></div>
    </div>

    <div id="view-create" class="card">
        <div class="creation-container">
            <div class="preview-circle" id="live-preview">
                <i class="fas fa-shield-alt" id="prev-icon"></i>
            </div>
            
            <div class="input-group">
                <div style="text-align:center; margin-bottom:10px; color:var(--gold); font-weight:bold;">
                    ØªÙƒÙ„ÙØ© Ø§Ù„ØªØ£Ø³ÙŠØ³: 1 <i class="fas fa-gem"></i>
                </div>
                <input type="text" id="cName" placeholder="Ø§Ø³Ù… Ø§Ù„ÙƒÙ„Ø§Ù† (Ø§Ù„Ø£Ø³Ø§Ø·ÙŠØ±...)">
                <input type="text" id="cDesc" placeholder="Ø´Ø¹Ø§Ø± Ø§Ù„ÙƒÙ„Ø§Ù†">
                
                <label style="font-size:0.8rem; color:#94a3b8;">Ø´ÙƒÙ„ Ø§Ù„Ø´Ø¹Ø§Ø±</label>
                <select id="cIconSelect" onchange="updatePreview()">
                    <option value="fa-dragon">ğŸ‰ ØªÙ†ÙŠÙ† Ø£Ø³Ø·ÙˆØ±ÙŠ</option>
                    <option value="fa-skull">ğŸ’€ Ø¬Ù…Ø¬Ù…Ø© Ø§Ù„Ù…ÙˆØª</option>
                    <option value="fa-crown">ğŸ‘‘ ØªØ§Ø¬ Ø§Ù„Ù…Ù„Ùƒ</option>
                    <option value="fa-shield-alt">ğŸ›¡ï¸ Ø¯Ø±Ø¹ Ø§Ù„Ø­Ù…Ø§ÙŠØ©</option>
                    <option value="fa-biohazard">â˜£ï¸ Ø®Ø·Ø± Ø¨ÙŠÙˆÙ„ÙˆØ¬ÙŠ</option>
                    <option value="fa-bolt">âš¡ ØµØ§Ø¹Ù‚Ø©</option>
                </select>

                <div style="display:flex; gap:10px;">
                    <div style="flex:1">
                        <label style="font-size:0.8rem; color:#94a3b8;">Ù„ÙˆÙ† Ø§Ù„Ø´Ø¹Ø§Ø±</label>
                        <input type="color" id="cIconColor" value="#ffffff" oninput="updatePreview()" style="height:40px; padding:2px;">
                    </div>
                    <div style="flex:1">
                        <label style="font-size:0.8rem; color:#94a3b8;">Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ©</label>
                        <input type="color" id="cBgColor" value="#1e293b" oninput="updatePreview()" style="height:40px; padding:2px;">
                    </div>
                </div>

                <button class="btn-main" onclick="createClan()">ØªØ£Ø³ÙŠØ³ Ø§Ù„ÙƒÙ„Ø§Ù† Ø§Ù„Ø¢Ù†</button>
            </div>
        </div>
    </div>

<script>
    let myUser = {};
    let myClan = null;
    let isLeader = false;

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            const doc = await db.collection("users").doc(user.uid).get();
            myUser = doc.data() || {};
            document.getElementById('cp-val').innerText = myUser.clanPoints || 0;
            
            if (myUser.clanId) {
                const cDoc = await db.collection("clans").doc(myUser.clanId).get();
                if(cDoc.exists) {
                    myClan = cDoc.data();
                    isLeader = (myClan.leaderId === user.uid);
                    renderMyClan();
                    renderShop();
                } else {
                    renderNoClan();
                }
            } else {
                renderNoClan();
            }
            loadLeaderboard();
        } else {
            window.location.href = "auth.html";
        }
    });

    // Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
    function switchTab(viewId) {
        document.querySelectorAll('.card').forEach(c => c.classList.remove('active-view'));
        document.getElementById('view-' + viewId).classList.add('active-view');
        
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }

    // ================== Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø­ÙŠØ© ==================
    function updatePreview() {
        const iconClass = document.getElementById('cIconSelect').value;
        const iconColor = document.getElementById('cIconColor').value;
        const bgColor = document.getElementById('cBgColor').value;
        
        const preview = document.getElementById('live-preview');
        const icon = document.getElementById('prev-icon');
        
        preview.style.backgroundColor = bgColor;
        preview.style.borderColor = iconColor; // Ø¬Ø¹Ù„ Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø¨Ù„ÙˆÙ† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©
        preview.style.boxShadow = `0 0 20px ${iconColor}40`; // ØªÙˆÙ‡Ø¬
        
        icon.className = `fas ${iconClass}`;
        icon.style.color = iconColor;
    }

    // ================== Ø§Ù„Ù…ØªØ¬Ø± (Shop System) ==================
    function renderShop() {
        const container = document.getElementById('shop-container');
        const level = myClan ? Math.floor((myClan.totalXp || 0) / 1000) + 1 : 1;
        
        // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ±
        const items = [
            { id: 'xp_boost', name: '100 XP Ù„Ù„ÙƒÙ„Ø§Ù†', cost: 200, icon: 'fa-rocket', reqLvl: 1 },
            { id: 'rename_card', name: 'ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…', cost: 1500, icon: 'fa-id-card', reqLvl: 3 },
            { id: 'pro_2d', name: 'PRO (ÙŠÙˆÙ…ÙŠÙ†)', cost: 3000, icon: 'fa-star', reqLvl: 5 },
            { id: 'rare_gem', name: 'Ø¬ÙˆÙ‡Ø±Ø© Ù†Ø§Ø¯Ø±Ø©', cost: 10000, icon: 'fa-gem', reqLvl: 10 }
        ];

        container.innerHTML = "";
        items.forEach(item => {
            const isLocked = level < item.reqLvl;
            container.innerHTML += `
                <div class="shop-item ${isLocked ? 'locked' : ''}">
                    ${isLocked ? '<div style="position:absolute; top:5px; right:5px;"><i class="fas fa-lock"></i></div>' : ''}
                    <i class="fas ${item.icon}" style="font-size:2rem; color:${isLocked ? '#555' : 'var(--gold)'}"></i>
                    <div style="font-weight:bold; margin:5px 0;">${item.name}</div>
                    <div class="item-price">${item.cost} CP</div>
                    <small style="color:#64748b">Ù…Ø·Ù„ÙˆØ¨ Ù„ÙÙ„ ${item.reqLvl}</small>
                    <button class="btn-mini" style="width:100%; margin-top:5px; background:var(--primary); color:white" 
                        onclick="buyItem('${item.id}', ${item.cost})">Ø´Ø±Ø§Ø¡</button>
                </div>
            `;
        });
    }

    async function collectDailyPoints() {
        if(!myClan) return alert("ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† ÙÙŠ ÙƒÙ„Ø§Ù†!");
        
        const today = new Date().toDateString();
        if(myUser.lastDailyCP === today) return alert("Ù„Ù‚Ø¯ Ø§Ø³ØªÙ„Ù…Øª Ø±Ø§ØªØ¨Ùƒ Ø§Ù„ÙŠÙˆÙ…!");

        // Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø©: 50 Ù†Ù‚Ø·Ø© Ø£Ø³Ø§Ø³ÙŠØ© + (Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ÙƒÙ„Ø§Ù† * 10)
        const level = Math.floor((myClan.totalXp || 0) / 1000) + 1;
        const amount = 50 + (level * 10);

        await db.collection("users").doc(auth.currentUser.uid).update({
            clanPoints: firebase.firestore.FieldValue.increment(amount),
            lastDailyCP: today
        });
        
        alert(`ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… ${amount} Ù†Ù‚Ø·Ø©!`);
        location.reload();
    }

    async function buyItem(itemId, cost) {
        if((myUser.clanPoints || 0) < cost) return alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ù†Ù‚Ø§Ø· ÙƒØ§ÙÙŠØ©!");
        
        if(!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø´Ø±Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ± Ø¨Ù€ ${cost} Ù†Ù‚Ø·Ø©ØŸ`)) return;

        const batch = db.batch();
        const userRef = db.collection("users").doc(auth.currentUser.uid);

        batch.update(userRef, { clanPoints: firebase.firestore.FieldValue.increment(-cost) });

        // ØªÙ†ÙÙŠØ° Ù…ÙØ¹ÙˆÙ„ Ø§Ù„Ø´Ø±Ø§Ø¡
        if(itemId === 'pro_2d') {
            const future = Date.now() + (2 * 24 * 60 * 60 * 1000);
            batch.update(userRef, { proExpiryTime: future });
        } else if(itemId === 'rare_gem') {
            batch.update(userRef, { s_gems: firebase.firestore.FieldValue.increment(1) });
        } else if(itemId === 'xp_boost') {
            batch.update(db.collection("clans").doc(myUser.clanId), { totalXp: firebase.firestore.FieldValue.increment(100) });
        }

        await batch.commit();
        alert("ØªÙ… Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­!");
        location.reload();
    }

    // ================== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒÙ„Ø§Ù† (Home) ==================
    function renderNoClan() {
        document.getElementById('my-clan-content').innerHTML = `
            <div style="text-align:center; padding:30px;">
                <h2>ğŸš« Ø£Ù†Øª Ù„Ø³Øª ÙÙŠ ÙƒÙ„Ø§Ù†</h2>
                <p>Ø§Ù†Ø¶Ù… Ù„ØªØ­Ø§Ù„Ù Ø£Ùˆ Ø£Ù†Ø´Ø¦ ÙˆØ§Ø­Ø¯Ø§Ù‹ Ù„Ù„Ø³ÙŠØ·Ø±Ø©!</p>
                <button class="btn-main" onclick="switchTab('create')">ØªØ£Ø³ÙŠØ³ ÙƒÙ„Ø§Ù† Ø¬Ø¯ÙŠØ¯</button>
                <button class="btn-main" style="margin-top:10px; background:#334155" onclick="switchTab('rank')">Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙƒÙ„Ø§Ù†</button>
            </div>
        `;
    }

    async function renderMyClan() {
        const level = Math.floor((myClan.totalXp || 0) / 1000) + 1;
        
        let html = `
            <div style="background: linear-gradient(to bottom right, ${myClan.bgColor}, #000); padding:20px; border-radius:15px; border:1px solid ${myClan.iconColor}; text-align:center; position:relative; overflow:hidden;">
                <div style="position:absolute; top:-20px; right:-20px; font-size:6rem; opacity:0.1; color:${myClan.iconColor}">
                    <i class="fas ${myClan.icon}"></i>
                </div>
                
                <i class="fas ${myClan.icon}" style="font-size:3rem; color:${myClan.iconColor}; background:rgba(0,0,0,0.4); padding:20px; border-radius:50%; box-shadow: 0 0 20px ${myClan.iconColor}66;"></i>
                <h1 style="margin:10px 0;">${myClan.name}</h1>
                <div style="background:rgba(0,0,0,0.5); display:inline-block; padding:5px 15px; border-radius:20px;">
                    LVL ${level} â€¢ XP: ${myClan.totalXp || 0}
                </div>
            </div>

            <div style="margin-top:20px;">
                <h3 style="border-right:4px solid var(--primary); padding-right:10px;">Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ (${myClan.membersCount}/20)</h3>
                <div id="clan-members-list"></div>
            </div>
        `;

        // Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ…
        if(isLeader) {
            html += `
                <div style="margin-top:30px; border-top:1px solid var(--glass); padding-top:20px;">
                    <h4 style="color:var(--danger)">Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø®Ø·Ø± (Ø§Ù„Ù‚Ø§Ø¦Ø¯ ÙÙ‚Ø·)</h4>
                    <button class="btn-main btn-danger" onclick="deleteClan()">âŒ Ø­Ù„ Ø§Ù„ÙƒÙ„Ø§Ù† Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹</button>
                </div>
            `;
        } else {
            html += `<button class="btn-main btn-danger" style="margin-top:20px" onclick="smartLeave()">ğŸƒ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ÙƒÙ„Ø§Ù†</button>`;
        }

        document.getElementById('my-clan-content').innerHTML = html;
        loadMembersList();
    }

    async function loadMembersList() {
        const snap = await db.collection("clans").doc(myUser.clanId).collection("members").get();
        const listDiv = document.getElementById('clan-members-list');
        listDiv.innerHTML = "";

        snap.forEach(doc => {
            const m = doc.data();
            const isMe = (doc.id === auth.currentUser.uid);
            
            let actions = "";
            // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ø¯: Ù„Ø§ ØªØ¸Ù‡Ø± Ù„Ù†ÙØ³Ù‡ØŒ ÙˆØªØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ù„Ù‚Ø§Ø¦Ø¯
            if(isLeader && !isMe) {
                actions = `
                    <div class="member-actions">
                        <button class="btn-mini btn-promo" title="ØªØ¹ÙŠÙŠÙ† ÙƒÙ‚Ø§Ø¦Ø¯" onclick="promoteMember('${doc.id}', '${m.name}')"><i class="fas fa-crown"></i></button>
                        <button class="btn-mini btn-kick" title="Ø·Ø±Ø¯" onclick="kickMember('${doc.id}', '${m.name}')"><i class="fas fa-ban"></i></button>
                    </div>
                `;
            }

            listDiv.innerHTML += `
                <div class="member-row">
                    <div>
                        <span style="font-weight:bold; color:${m.role === 'leader' ? 'var(--gold)' : 'white'}">
                            ${m.role === 'leader' ? 'ğŸ‘‘' : 'ğŸ‘¤'} ${m.name}
                        </span>
                    </div>
                    ${actions}
                </div>
            `;
        });
    }

    // ================== Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø³Ø·ÙˆØ±ÙŠØ© (Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©) ==================

    async function kickMember(uid, name) {
        if(!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø·Ø±Ø¯ ${name}ØŸ`)) return;
        
        const batch = db.batch();
        batch.delete(db.collection("clans").doc(myUser.clanId).collection("members").doc(uid));
        batch.update(db.collection("clans").doc(myUser.clanId), { membersCount: firebase.firestore.FieldValue.increment(-1) });
        batch.update(db.collection("users").doc(uid), { clanId: null });
        
        await batch.commit();
        alert(`ØªÙ… Ø·Ø±Ø¯ ${name} Ø¨Ù†Ø¬Ø§Ø­.`);
        location.reload();
    }

    async function promoteMember(uid, name) {
        if(!confirm(`ØªØ­Ø°ÙŠØ±: Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ Ø¹Ù† Ø§Ù„Ù…Ù„ÙƒÙŠØ© Ù„Ù„Ø¹Ø¶Ùˆ ${name}ØŸ Ø³ØªØµØ¨Ø­ Ø¹Ø¶ÙˆØ§Ù‹ Ø¹Ø§Ø¯ÙŠØ§Ù‹.`)) return;

        const batch = db.batch();
        const clanRef = db.collection("clans").doc(myUser.clanId);
        
        // ØªØ­Ø¯ÙŠØ«ÙŠ Ø£Ù†Ø§ (Ø¹Ø¶Ùˆ Ø¹Ø§Ø¯ÙŠ)
        batch.update(clanRef.collection("members").doc(auth.currentUser.uid), { role: 'member' });
        // ØªØ­Ø¯ÙŠØ«Ù‡ Ù‡Ùˆ (Ù‚Ø§Ø¦Ø¯)
        batch.update(clanRef.collection("members").doc(uid), { role: 'leader' });
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙ„Ø§Ù†
        batch.update(clanRef, { leaderId: uid, leaderName: name });

        await batch.commit();
        location.reload();
    }

    async function smartLeave() {
        if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©ØŸ")) return;

        const uid = auth.currentUser.uid;
        const cid = myUser.clanId;

        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù‚Ø§Ø¦Ø¯ ÙˆÙŠÙˆØ¬Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ø¢Ø®Ø±ÙŠÙ† (Ø­Ø§Ù„Ø© Ù†Ø§Ø¯Ø±Ø© Ø¥Ø°Ø§ Ø¸Ù‡Ø± Ø§Ù„Ø²Ø± Ù„Ù„Ù‚Ø§Ø¦Ø¯)
        if(isLeader) {
            const mems = await db.collection("clans").doc(cid).collection("members").get();
            if(mems.size <= 1) {
                // Ù‡Ùˆ Ø§Ù„ÙˆØ­ÙŠØ¯
                return deleteClan(); 
            } else {
                // ØªØ¹ÙŠÙŠÙ† Ø¹Ø´ÙˆØ§Ø¦ÙŠ
                let newLeaderId = null;
                let newLeaderName = "";
                mems.forEach(doc => {
                    if(doc.id !== uid && !newLeaderId) {
                        newLeaderId = doc.id;
                        newLeaderName = doc.data().name;
                    }
                });
                
                // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù‚Ø§Ø¦Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                await db.collection("clans").doc(cid).collection("members").doc(newLeaderId).update({ role: 'leader' });
                await db.collection("clans").doc(cid).update({ leaderId: newLeaderId, leaderName: newLeaderName });
            }
        }

        // Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
        const batch = db.batch();
        batch.delete(db.collection("clans").doc(cid).collection("members").doc(uid));
        batch.update(db.collection("clans").doc(cid), { membersCount: firebase.firestore.FieldValue.increment(-1) });
        batch.update(db.collection("users").doc(uid), { clanId: null });
        
        await batch.commit();
        location.reload();
    }

    async function deleteClan() {
        if(!confirm("âš ï¸ ØªØ­Ø°ÙŠØ± Ø®Ø·ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„ÙƒÙ„Ø§Ù† Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ÙˆØ·Ø±Ø¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡! Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ Ø±Ø¬Ø¹Ø© ÙÙŠÙ‡.")) return;
        
        const cid = myUser.clanId;
        const batch = db.batch();
        
        // 1. Ø­Ø°Ù ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„ÙƒÙ„Ø§Ù†
        batch.delete(db.collection("clans").doc(cid));
        
        // 2. ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ (Ù‡Ø°Ø§ ÙŠØªØ·Ù„Ø¨ Cloud Function ÙÙŠ Ø§Ù„ÙˆØ§Ù‚Ø¹ØŒ Ù„ÙƒÙ† Ù‡Ù†Ø§ Ø³Ù†Ø­Ø¯Ø« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØ§Ù„Ù‚Ø§Ø¦Ø¯)
        // Ù…Ù„Ø§Ø­Ø¸Ø©: ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ© ÙÙ‚Ø· Ù„Ø§ ÙŠÙ…ÙƒÙ†Ù†Ø§ Ø¨Ø³Ù‡ÙˆÙ„Ø© ØªØ­Ø¯ÙŠØ« ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù…ÙŠ Ø§Ù„ÙƒÙ„Ø§Ù† Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†ÙˆØ§ ÙƒØ«Ø±
        // Ù„Ø°Ø§ Ø³Ù†Ø­Ø°Ù Ø§Ù„Ù‚Ø§Ø¦Ø¯ ÙˆÙ†Ø¹ØªÙ…Ø¯ Ø£Ù† Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø³ÙŠÙƒØªØ´ÙÙˆÙ† Ø£Ù† Ø§Ù„ÙƒÙ„Ø§Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        batch.update(db.collection("users").doc(auth.currentUser.uid), { clanId: null });

        await batch.commit();
        alert("ØªÙ… ØªÙÙƒÙŠÙƒ Ø§Ù„ØªØ­Ø§Ù„Ù.");
        location.reload();
    }

    // ================== Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„ ==================
    async function createClan() {
        if(myUser.s_gems < 1) return alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø¬ÙˆØ§Ù‡Ø± ÙƒØ§ÙÙŠØ©!");
        const name = document.getElementById('cName').value.trim();
        if(name.length < 3) return alert("Ø§Ù„Ø§Ø³Ù… Ù‚ØµÙŠØ±");

        const batch = db.batch();
        batch.set(db.collection("clans").doc(name), {
            name: name,
            description: document.getElementById('cDesc').value,
            icon: document.getElementById('cIconSelect').value,
            iconColor: document.getElementById('cIconColor').value,
            bgColor: document.getElementById('cBgColor').value,
            leaderId: auth.currentUser.uid,
            membersCount: 1,
            totalXp: 0,
            createdAt: Date.now()
        });

        batch.set(db.collection("clans").doc(name).collection("members").doc(auth.currentUser.uid), {
            name: myUser.displayName || 'Unknown', role: 'leader', xp: 0
        });

        batch.update(db.collection("users").doc(auth.currentUser.uid), {
            clanId: name, s_gems: firebase.firestore.FieldValue.increment(-1)
        });

        await batch.commit();
        location.reload();
    }

    async function loadLeaderboard() {
        const list = document.getElementById('leaderboard-list');
        const snap = await db.collection("clans").orderBy("totalXp", "desc").limit(10).get();
        list.innerHTML = "";
        
        if(snap.empty) {
            list.innerHTML = "<p style='text-align:center; opacity:0.5'>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ­Ø§Ù„ÙØ§Øª Ø¨Ø¹Ø¯</p>";
            return;
        }

        let rank = 1;
        snap.forEach(doc => {
            const c = doc.data();
            list.innerHTML += `
                <div class="member-row" style="background:rgba(255,255,255,0.05); margin-bottom:5px; border-radius:10px;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span style="font-weight:900; color:var(--gold); width:20px;">#${rank++}</span>
                        <i class="fas ${c.icon}" style="color:${c.iconColor}"></i>
                        <span>${c.name}</span>
                    </div>
                    <span style="color:var(--primary); font-weight:bold;">${c.totalXp} XP</span>
                </div>
            `;
        });
    }
</script>
</body>
</html>
