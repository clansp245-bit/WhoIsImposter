<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âš”ï¸ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­Ø§Ù„ÙØ§Øª Ø§Ù„Ø£Ø³Ø·ÙˆØ±ÙŠ</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="auth.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        :root {
            --neon-blue: #00f2ff;
            --neon-pink: #ff007f;
            --gold: #ffcc00;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-deep: rgba(15, 23, 42, 0.9);
            --grad: linear-gradient(135deg, #6366f1 0%, #ec4899 100%);
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: #020617;
            color: white; margin: 0; padding: 15px; min-height: 100vh;
            background-image: radial-gradient(circle at 10% 20%, rgba(0, 242, 255, 0.1) 0%, transparent 20%), radial-gradient(circle at 90% 80%, rgba(255, 0, 127, 0.1) 0%, transparent 20%);
            overflow-x: hidden;
        }

        .main-header { text-align: center; padding: 20px 0; }
        .clan-identity {
            display: inline-flex; align-items: center; gap: 10px;
            background: var(--glass); padding: 10px 25px; border-radius: 50px;
            border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        .bottom-nav {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 500px; background: var(--glass-deep);
            backdrop-filter: blur(15px); border-radius: 25px; display: flex;
            justify-content: space-around; padding: 10px; border: 1px solid rgba(255,255,255,0.1);
            z-index: 999; box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }
        .nav-item { color: #64748b; font-size: 1.2rem; cursor: pointer; transition: 0.3s; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; border-radius: 15px; }
        .nav-item.active { color: white; background: var(--grad); box-shadow: 0 0 15px rgba(236, 72, 153, 0.4); }

        .section { display: none; animation: fadeIn 0.5s ease; padding-bottom: 100px; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .modern-card { background: var(--glass); border: 1px solid rgba(255,255,255,0.1); border-radius: 30px; padding: 20px; margin-bottom: 20px; backdrop-filter: blur(10px); position: relative; }
        
        /* --- Chat Styles --- */
        #chat-box { height: 250px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 15px; padding: 10px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 8px; }
        .msg { padding: 8px 12px; border-radius: 12px; max-width: 80%; font-size: 0.85rem; }
        .msg.me { align-self: flex-start; background: var(--grad); color: white; }
        .msg.others { align-self: flex-end; background: rgba(255,255,255,0.1); }
        .chat-input-area { display: flex; gap: 10px; }
        .chat-input-area input { flex: 1; background: rgba(0,0,0,0.3); border: 1px solid var(--glass); padding: 10px; border-radius: 12px; color: white; font-family: 'Cairo'; }

        .xp-bar-bg { background: rgba(255,255,255,0.1); height: 10px; border-radius: 10px; overflow: hidden; margin: 10px 0; }
        .xp-bar-fill { height: 100%; background: var(--grad); width: 0%; transition: 1s ease; }

        .reward-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .reward-item { background: rgba(0,0,0,0.3); border-radius: 20px; padding: 20px; text-align: center; border: 1px solid rgba(255,255,255,0.05); }
        .reward-item.locked { opacity: 0.5; filter: grayscale(1); }

        .mega-btn { background: var(--grad); color: white; border: none; padding: 12px 20px; border-radius: 15px; font-weight: 700; cursor: pointer; width: 100%; font-family: 'Cairo'; }
        
        .member-row { display: flex; align-items: center; gap: 12px; padding: 10px; background: rgba(255,255,255,0.03); border-radius: 15px; margin-bottom: 8px; }
        .member-avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--neon-blue); }
    </style>
</head>
<body>

    <div class="main-header">
        <div class="clan-identity">
            <span><i class="fas fa-gem" style="color:var(--neon-blue)"></i> <span id="u-gems">0</span></span>
            <div style="width:1px; height:20px; background:rgba(255,255,255,0.2)"></div>
            <span><i class="fas fa-bolt" style="color:var(--gold)"></i> <span id="u-cp">0</span> CP</span>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="tab('home')"><i class="fas fa-shield-halved"></i></div>
        <div class="nav-item" onclick="tab('find')"><i class="fas fa-search"></i></div>
        <div class="nav-item" onclick="tab('shop')"><i class="fas fa-shopping-cart"></i></div>
        <div class="nav-item" onclick="tab('create')"><i class="fas fa-plus-circle"></i></div>
    </div>

    <div id="tab-home" class="section active">
        <div id="clan-content-area"></div>
    </div>

    <div id="tab-find" class="section">
        <div class="modern-card">
            <h3><i class="fas fa-search"></i> Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ØªØ­Ø§Ù„Ù</h3>
            <input type="text" id="search-in" oninput="searchClans()" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ÙƒÙ„Ø§Ù†..." style="width:100%; padding:15px; background:rgba(0,0,0,0.3); border:1px solid var(--glass); border-radius:15px; color:white;">
            <div id="search-results" style="margin-top:20px"></div>
        </div>
    </div>

    <div id="tab-shop" class="section">
        <div class="modern-card">
            <h3><i class="fas fa-gift"></i> Ù…ÙƒØ§ÙØ¢Øª Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 20+</h3>
            <div class="reward-grid" id="reward-list"></div>
        </div>
    </div>

    <div id="tab-create" class="section">
        <div class="modern-card" style="text-align:center">
            <h2>ØªØ£Ø³ÙŠØ³ ØªØ­Ø§Ù„Ù</h2>
            <input type="text" id="c-name" placeholder="Ø§Ø³Ù… Ø§Ù„ÙƒÙ„Ø§Ù†" style="width:90%; padding:10px; margin:10px; border-radius:10px;">
            <button class="mega-btn" onclick="createClan()">Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ù€ 1 Ø¬ÙˆÙ‡Ø±Ø© ğŸ’</button>
        </div>
    </div>

<script>
let me = {};
let myClan = null;
let chatUnsubscribe = null;

auth.onAuthStateChanged(async (user) => {
    if (user) {
        db.collection("users").doc(user.uid).onSnapshot(async (doc) => {
            me = doc.data();
            me.uid = user.uid;
            document.getElementById('u-gems').innerText = me.s_gems || 0;
            document.getElementById('u-cp').innerText = me.clanPoints || 0;
            if (me.clanId) await syncMyXpWithClan();
            refreshHome();
        });
    } else { window.location.href = "auth.html"; }
});

function getClanLevelData(totalXp) {
    const level = Math.floor((totalXp || 0) / 1000) + 1;
    const progress = ((totalXp % 1000) / 1000) * 100;
    return { level, progress };
}

async function refreshHome() {
    const area = document.getElementById('clan-content-area');
    if (!me.clanId) {
        area.innerHTML = `<div class="modern-card" style="text-align:center"><h2>Ø£Ù†Øª Ù„Ø§ ØªÙ†ØªÙ…ÙŠ Ù„ÙƒÙ„Ø§Ù†</h2><button class="mega-btn" onclick="tab('find')">Ø§Ø¨Ø­Ø« Ø¹Ù† ÙˆØ§Ø­Ø¯</button></div>`;
        return;
    }

    const clanSnap = await db.collection("clans").doc(me.clanId).get();
    if (!clanSnap.exists) return;
    myClan = clanSnap.data();
    const lv = getClanLevelData(myClan.totalXp);

    area.innerHTML = `
        <div class="modern-card" style="border-top: 4px solid ${myClan.iconColor}">
            <h1 style="margin:0">${myClan.name} <small style="font-size:0.5em; color:var(--gold)">LV.${lv.level}</small></h1>
            <div class="xp-bar-bg"><div class="xp-bar-fill" style="width:${lv.progress}%"></div></div>
            
            <div id="chat-container">
                <h4><i class="fas fa-comments"></i> Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„ÙƒÙ„Ø§Ù†</h4>
                <div id="chat-box"></div>
                <div class="chat-input-area">
                    <input type="text" id="msg-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ...">
                    <button onclick="sendMsg()" style="background:var(--neon-blue); border:none; padding:10px; border-radius:10px;"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
        <div class="modern-card">
            <h4>Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</h4>
            <div id="members-list"></div>
        </div>
    `;
    loadMembers(me.clanId);
    listenToChat(me.clanId);
    renderRewards(myClan);
}

// --- ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØµØ­Ø­Ø© ---
async function searchClans() {
    const q = document.getElementById('search-in').value;
    const resDiv = document.getElementById('search-results');
    if(q.length < 2) { resDiv.innerHTML = ""; return; }

    const snap = await db.collection("clans").where("name", ">=", q).where("name", "<=", q + '\uf8ff').limit(10).get();
    resDiv.innerHTML = "";
    snap.forEach(doc => {
        const c = doc.data();
        resDiv.innerHTML += `
            <div class="member-row" style="justify-content:space-between">
                <div><b>${c.name}</b> <br> <small>Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡: ${c.membersCount}</small></div>
                <button class="mega-btn" onclick="joinClan('${doc.id}')" style="width:auto; padding:5px 15px;">Ø§Ù†Ø¶Ù…Ø§Ù…</button>
            </div>`;
    });
}

// --- ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ---
function listenToChat(clanId) {
    if (chatUnsubscribe) chatUnsubscribe();
    chatUnsubscribe = db.collection("clans").doc(clanId).collection("chat")
        .orderBy("time", "desc").limit(20).onSnapshot(snap => {
            const box = document.getElementById('chat-box');
            if(!box) return;
            box.innerHTML = "";
            snap.forEach(doc => {
                const m = doc.data();
                const isMe = m.senderId === me.uid;
                box.innerHTML += `<div class="msg ${isMe ? 'me' : 'others'}"><b>${m.senderName}:</b> ${m.text}</div>`;
            });
        });
}

async function sendMsg() {
    const inp = document.getElementById('msg-input');
    const txt = inp.value.trim();
    if(!txt || !me.clanId) return;
    await db.collection("clans").doc(me.clanId).collection("chat").add({
        text: txt,
        senderId: me.uid,
        senderName: me.displayName || "Ù…Ø­Ø§Ø±Ø¨",
        time: Date.now()
    });
    inp.value = "";
}

// --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬ÙˆØ§Ø¦Ø² Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø¨Ø·Ø§Ù‚Ø© ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…) ---
function renderRewards(clan) {
    const lv = getClanLevelData(clan.totalXp);
    const list = document.getElementById('reward-list');
    if(!list) return;

    const isLocked = lv.level < 20;
    list.innerHTML = `
        <div class="reward-item ${isLocked ? 'locked' : ''}">
            <i class="fas fa-id-card" style="font-size:2rem; color:var(--gold)"></i>
            <h3>Ø¨Ø·Ø§Ù‚Ø© ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</h3>
            <p>Ù…ØªØ§Ø­Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„ÙƒÙ„Ø§Ù† Ù„ÙÙ„ 20+</p>
            ${isLocked ? '<p style="color:red">Ù…Ù‚ÙÙˆÙ„: ÙŠØªØ·Ù„Ø¨ Ù„ÙÙ„ 20</p>' : '<button class="mega-btn" onclick="claimNameCard()">Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</button>'}
        </div>
    `;
}

async function claimNameCard() {
    const lastClaim = me.lastNameClaim || 0;
    const week = 7 * 24 * 60 * 60 * 1000;
    
    if (Date.now() - lastClaim < week) {
        alert("Ù„Ù‚Ø¯ Ø§Ø³ØªÙ„Ù…Øª Ø¨Ø·Ø§Ù‚ØªÙƒ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø¨Ø§Ù„ÙØ¹Ù„! Ø¹Ø¯ Ù„Ø§Ø­Ù‚Ø§Ù‹.");
        return;
    }

    await db.collection("users").doc(me.uid).update({
        hasNameCard: true, // ØªØ¶Ø§Ù Ù…ÙŠØ²Ø© ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù… ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨
        lastNameClaim: Date.now()
    });
    alert("ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! Ø­ØµÙ„Øª Ø¹Ù„Ù‰ Ø¨Ø·Ø§Ù‚Ø© ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ù…Ø¬Ø§Ù†ÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹.");
}

async function syncMyXpWithClan() {
    const clanRef = db.collection("clans").doc(me.clanId);
    const memRef = clanRef.collection("members").doc(me.uid);
    const mDoc = await memRef.get();
    if(mDoc.exists) {
        const diff = (me.xp || 0) - (mDoc.data().xp || 0);
        if(diff > 0) {
            await memRef.update({ xp: me.xp });
            await clanRef.update({ totalXp: firebase.firestore.FieldValue.increment(diff) });
        }
    }
}

async function loadMembers(cid) {
    const snap = await db.collection("clans").doc(cid).collection("members").orderBy("xp", "desc").get();
    const list = document.getElementById('members-list');
    if(!list) return;
    list.innerHTML = "";
    snap.forEach(doc => {
        const m = doc.data();
        list.innerHTML += `<div class="member-row"><img src="${m.photo || 'https://api.dicebear.com/7.x/avataaars/svg?seed=1'}" class="member-avatar"><div><b>${m.name}</b><br><small>${m.xp} XP</small></div></div>`;
    });
}

async function joinClan(cid) {
    if(me.clanId) return alert("Ø£Ù†Øª ÙÙŠ ÙƒÙ„Ø§Ù† Ø¨Ø§Ù„ÙØ¹Ù„!");
    const batch = db.batch();
    batch.set(db.collection("clans").doc(cid).collection("members").doc(me.uid), {
        name: me.displayName || "Ù„Ø§Ø¹Ø¨",
        xp: me.xp || 0,
        role: "member"
    });
    batch.update(db.collection("clans").doc(cid), { membersCount: firebase.firestore.FieldValue.increment(1), totalXp: firebase.firestore.FieldValue.increment(me.xp || 0) });
    batch.update(db.collection("users").doc(me.uid), { clanId: cid });
    await batch.commit();
    tab('home');
}

function tab(id) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById('tab-'+id).classList.add('active');
}
</script>
</body>
</html>
