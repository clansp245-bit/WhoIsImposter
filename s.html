<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âš”ï¸ Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠØ© Ø§Ù„ØªØ­Ø§Ù„ÙØ§Øª - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="auth.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        :root {
            --primary: #6366f1;
            --secondary: #ec4899;
            --gold: #fbbf24;
            --dark-bg: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(255, 255, 255, 0.08);
            --danger: #ef4444;
            --success: #10b981;
            /* Rarity Colors */
            --bg-dev: linear-gradient(45deg, #ff4757, #990000);
            --bg-pro: linear-gradient(45deg, #ffd700, #b8860b);
            --bg-legend: linear-gradient(45deg, #fbbf24, #d97706);
            --bg-gem: linear-gradient(45deg, #00d2ff, #9b59b6);
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--dark-bg);
            background-image: radial-gradient(at 0% 0%, rgba(99,102,241,0.15) 0px, transparent 50%), 
                              radial-gradient(at 100% 100%, rgba(236,72,153,0.15) 0px, transparent 50%);
            color: white; margin: 0; padding: 15px; min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- Header & Nav --- */
        .header { text-align: center; margin-bottom: 20px; animation: fadeInDown 0.8s ease; }
        .currency-bar {
            background: rgba(0,0,0,0.4); display: inline-flex; align-items: center; gap: 15px;
            padding: 8px 20px; border-radius: 50px; border: 1px solid var(--glass-border);
            margin-top: 10px; backdrop-filter: blur(5px);
        }

        .nav-bar {
            display: flex; gap: 10px; overflow-x: auto; padding: 5px; margin-bottom: 20px;
            scrollbar-width: none; background: rgba(0,0,0,0.2); border-radius: 15px;
        }
        .nav-btn {
            flex: 1; padding: 12px; border: none; background: transparent; color: #94a3b8;
            border-radius: 10px; cursor: pointer; font-family: 'Cairo'; font-weight: bold;
            white-space: nowrap; transition: 0.3s;
        }
        .nav-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 15px rgba(99,102,241,0.4); }

        /* --- Cards & Containers --- */
        .view-section { display: none; animation: slideUp 0.5s ease; }
        .view-section.active { display: block; }

        .card {
            background: var(--card-bg); backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border); border-radius: 20px;
            padding: 20px; margin-bottom: 15px; position: relative;
        }

        /* --- Search & List --- */
        .search-box {
            width: 100%; padding: 15px; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border);
            border-radius: 12px; color: white; font-family: 'Cairo'; margin-bottom: 15px; box-sizing: border-box;
        }
        .clan-row, .member-row {
            display: flex; align-items: center; padding: 12px; margin-bottom: 8px;
            background: rgba(255,255,255,0.03); border-radius: 12px; transition: 0.2s; cursor: pointer;
        }
        .clan-row:hover, .member-row:hover { background: rgba(255,255,255,0.08); transform: translateX(-5px); }
        
        /* --- Shop Items --- */
        .shop-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .shop-item {
            background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border);
            border-radius: 15px; padding: 15px; text-align: center; position: relative; overflow: hidden;
        }
        .shop-item.locked { opacity: 0.6; filter: grayscale(1); cursor: not-allowed; }
        .lock-overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.6); display: flex;
            align-items: center; justify-content: center; font-size: 2rem; color: #fff;
        }
        
        /* --- Profile Modal --- */
        .modal {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000;
            align-items: center; justify-content: center; animation: fadeIn 0.3s;
        }
        .modal-content {
            background: #1e293b; width: 90%; max-width: 350px; border-radius: 25px;
            padding: 30px; text-align: center; border: 1px solid var(--primary);
            position: relative; box-shadow: 0 0 50px rgba(99,102,241,0.3);
        }
        .badge-circle {
            width: 25px; height: 25px; border-radius: 50%; display: inline-flex;
            align-items: center; justify-content: center; font-size: 0.7rem; margin: 2px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        /* --- Animations --- */
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- Buttons --- */
        .btn-action {
            width: 100%; padding: 12px; border: none; border-radius: 12px; font-weight: bold;
            cursor: pointer; margin-top: 10px; background: var(--primary); color: white;
        }
        .btn-danger { background: var(--danger); }
        .btn-join { background: var(--success); padding: 5px 15px; border-radius: 8px; font-size: 0.8rem; }
        
        /* --- Top 3 Contributors --- */
        .top3-container { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .top3-item { text-align: center; position: relative; }
        .top3-img { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--gold); }
        .crown-icon { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); color: var(--gold); font-size: 1.2rem; }

    </style>
</head>
<body>

    <div class="header">
        <h1 style="margin:0; background: linear-gradient(to right, #fff, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">ğŸ›¡ï¸ Ø£Ø³Ø§Ø·ÙŠØ± Ø§Ù„ØªØ­Ø§Ù„ÙØ§Øª</h1>
        <div class="currency-bar">
            <span><i class="fas fa-coins" style="color:var(--gold)"></i> <span id="u-coins">0</span></span>
            <span><i class="fas fa-bolt" style="color:#a855f7"></i> <span id="u-cp">0</span> CP</span>
        </div>
    </div>

    <div class="nav-bar">
        <button class="nav-btn active" onclick="nav('home')">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        <button class="nav-btn" onclick="nav('find')">Ø¨Ø­Ø« ğŸ”</button>
        <button class="nav-btn" onclick="nav('shop')">Ø§Ù„Ù…ØªØ¬Ø± ğŸ›’</button>
        <button class="nav-btn" onclick="nav('create')">Ø¥Ù†Ø´Ø§Ø¡ âš’ï¸</button>
    </div>

    <div id="tab-home" class="view-section active">
        <div id="my-clan-area">
            <div style="text-align:center; padding:50px;"><i class="fas fa-circle-notch fa-spin"></i> ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
        </div>
    </div>

    <div id="tab-find" class="view-section">
        <div class="card">
            <h3>ğŸ” Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªØ­Ø§Ù„Ù</h3>
            <input type="text" class="search-box" id="search-input" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ÙƒÙ„Ø§Ù†..." onkeyup="filterClans()">
            <div id="all-clans-list"></div>
        </div>
    </div>

    <div id="tab-shop" class="view-section">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3>ğŸª Ù…ØªØ¬Ø± Ø§Ù„Ø¹Ø´ÙŠØ±Ø©</h3>
                <span id="shop-lvl-badge" style="background:var(--primary); padding:2px 8px; border-radius:5px; font-size:0.8rem;">Lv.0</span>
            </div>
            <div class="shop-grid" id="shop-container"></div>
        </div>
    </div>

    <div id="tab-create" class="view-section">
        <div class="card" style="text-align:center;">
            <div id="preview-box" style="width:100px; height:100px; border-radius:50%; margin:0 auto 15px; display:flex; align-items:center; justify-content:center; border:3px solid white; transition:0.3s;">
                <i id="preview-icon" class="fas fa-shield-alt" style="font-size:2.5rem;"></i>
            </div>
            
            <input type="text" id="c-name" class="search-box" placeholder="Ø§Ø³Ù… Ø§Ù„ÙƒÙ„Ø§Ù†">
            <input type="text" id="c-desc" class="search-box" placeholder="Ø§Ù„ÙˆØµÙ Ø§Ù„Ù…Ø®ØªØµØ±">
            
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <select id="c-icon" class="search-box" onchange="updatePreview()">
                    <option value="fa-dragon">ØªÙ†ÙŠÙ†</option>
                    <option value="fa-skull">Ø¬Ù…Ø¬Ù…Ø©</option>
                    <option value="fa-crown">ØªØ§Ø¬</option>
                    <option value="fa-bolt">ØµØ§Ø¹Ù‚Ø©</option>
                    <option value="fa-fire">Ù†Ø§Ø±</option>
                </select>
                <input type="color" id="c-color" value="#6366f1" style="height:50px; width:50px; padding:0; border:none;" oninput="updatePreview()">
                <input type="color" id="c-bg" value="#1e293b" style="height:50px; width:50px; padding:0; border:none;" oninput="updatePreview()">
            </div>

            <button class="btn-action" onclick="createClan()">ØªØ£Ø³ÙŠØ³ (100 ÙƒÙˆÙŠÙ†Ø²)</button>
        </div>
    </div>

    <div id="profileModal" class="modal" onclick="if(event.target == this) closeModal()">
        <div class="modal-content">
            <div id="modal-body"></div>
            <button class="btn-action" onclick="closeModal()" style="background:#334155; margin-top:15px;">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

<script>
    /* ================= Configuration & Data ================= */
    let currentUser = {};
    let currentClan = null;
    let allClansCache = []; // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„ÙƒÙ„Ø§Ù†Ø§Øª Ù„Ù„Ø¨Ø­Ø«

    const BADGES_CONFIG = {
        "dev_badge": { name: "Ù…Ø·ÙˆØ±", icon: "fa-code", bg: "var(--bg-dev)" },
        "pro_badge": { name: "Ø¨Ø±Ùˆ", icon: "fa-crown", bg: "var(--bg-pro)" },
        "legend_badge": { name: "Ø§Ù„Ø£Ø³Ø·ÙˆØ±Ø©", icon: "fa-shield-halved", bg: "var(--bg-legend)" },
        "gem_king": { name: "Ù…Ù„Ùƒ Ø§Ù„Ø¬ÙˆØ§Ù‡Ø±", icon: "fa-gem", bg: "var(--bg-gem)" },
        "rich_badge": { name: "Ø«Ø±ÙŠ", icon: "fa-money-bill", bg: "#10b981" }
    };

    /* ================= Auth & Init ================= */
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            // Ø§Ø³ØªÙ…Ø§Ø¹ Ø¯Ø§Ø¦Ù… Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            db.collection("users").doc(user.uid).onSnapshot(doc => {
                currentUser = doc.data();
                currentUser.uid = user.uid; // Ø¶Ù…Ø§Ù† ÙˆØ¬ÙˆØ¯ ID
                document.getElementById('u-coins').innerText = currentUser.totalCoins || 0;
                document.getElementById('u-cp').innerText = currentUser.clanPoints || 0;
                
                checkClanStatus(); // ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„ÙƒÙ„Ø§Ù†
            });
            loadAllClans(); // ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ø­Ø«
        } else {
            window.location.href = "auth.html";
        }
    });

    function nav(tabId) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + tabId).classList.add('active');
        event.currentTarget.classList.add('active');
    }

    /* ================= 1. Clan Logic (Home) ================= */
    async function checkClanStatus() {
        const area = document.getElementById('my-clan-area');
        
        if (!currentUser.clanId) {
            area.innerHTML = `
                <div style="text-align:center; padding:30px;">
                    <i class="fas fa-users-slash" style="font-size:3rem; color:#475569; margin-bottom:10px;"></i>
                    <h3>Ù„Ø³Øª Ø¹Ø¶ÙˆØ§Ù‹ ÙÙŠ Ø£ÙŠ ØªØ­Ø§Ù„Ù</h3>
                    <p style="color:#94a3b8; font-size:0.9rem;">Ø§Ù†Ø¶Ù… Ù„ØªØ­Ø§Ù„Ù Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø­Ø« Ø£Ùˆ Ø£Ù†Ø´Ø¦ ØªØ­Ø§Ù„ÙÙƒ Ø§Ù„Ø®Ø§Øµ!</p>
                    <button class="btn-action" onclick="nav('find')" style="width:auto; padding:10px 30px;">Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙƒÙ„Ø§Ù†</button>
                </div>
            `;
            currentClan = null;
            return;
        }

        // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒÙ„Ø§Ù†
        try {
            const clanDoc = await db.collection("clans").doc(currentUser.clanId).get();
            
            // --- Self Healing: Ø¥Ø°Ø§ ØªÙ… Ø­Ø°Ù Ø§Ù„ÙƒÙ„Ø§Ù† ÙˆÙ„ÙƒÙ† Ø§Ù„Ø¹Ø¶Ùˆ Ù…Ø§Ø²Ø§Ù„ ÙŠÙ…Ù„Ùƒ ID ---
            if (!clanDoc.exists) {
                await db.collection("users").doc(currentUser.uid).update({ clanId: null });
                alert("ØªÙ… Ø­Ù„ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙ„Ø§Ù† Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù‚Ø§Ø¦Ø¯.");
                return;
            }

            currentClan = clanDoc.data();
            renderClanView(currentClan);
            renderShopItems(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØ¬Ø± Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ù„ÙÙ„ Ø§Ù„ÙƒÙ„Ø§Ù†
        } catch (e) { console.error(e); }
    }

    async function renderClanView(clan) {
        const isLeader = (clan.leaderId === currentUser.uid);
        const clanLevel = Math.floor((clan.totalXp || 0) / 2000) + 1;
        
        // Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…ØªÙØ§Ø¹Ù„ÙŠÙ†
        const memSnaps = await db.collection("clans").doc(clan.name).collection("members").orderBy("xp", "desc").get();
        let membersHTML = "";
        let top3HTML = "";
        let rank = 1;

        memSnaps.forEach(doc => {
            const m = doc.data();
            const memId = doc.id;
            
            // Top 3 Logic
            if (rank <= 3) {
                top3HTML += `
                    <div class="top3-item" onclick="fetchAndOpenProfile('${memId}')">
                        <i class="fas fa-crown crown-icon" style="display:${rank===1?'block':'none'}"></i>
                        <img src="${m.photo || 'https://via.placeholder.com/50'}" class="top3-img" style="border-color:${rank===1?'gold':(rank===2?'silver':'#cd7f32')}">
                        <div style="font-size:0.7rem; margin-top:5px;">${m.name}</div>
                        <div style="font-size:0.6rem; color:var(--primary)">${m.xp} XP</div>
                    </div>
                `;
            }

            // Member List Logic
            let actions = "";
            if (isLeader && memId !== currentUser.uid) {
                actions = `<i class="fas fa-door-open" style="color:var(--danger); margin-right:10px;" onclick="kickMember('${memId}', '${m.name}')"></i>`;
            }

            membersHTML += `
                <div class="member-row" onclick="if(!event.target.classList.contains('fa-door-open')) fetchAndOpenProfile('${memId}')">
                    <div style="width:30px; font-weight:bold; color:#64748b">#${rank}</div>
                    <div style="flex:1">
                        <span style="font-weight:bold; ${m.role==='leader'?'color:var(--gold)':''}">${m.name}</span>
                        ${m.role==='leader' ? '<i class="fas fa-crown" style="color:var(--gold); font-size:0.7rem;"></i>' : ''}
                        <div style="font-size:0.7rem; color:#94a3b8;">${m.xp || 0} XP Ù…Ø³Ø§Ù‡Ù…Ø©</div>
                    </div>
                    ${actions}
                </div>
            `;
            rank++;
        });

        document.getElementById('my-clan-area').innerHTML = `
            <div class="card" style="text-align:center; background: linear-gradient(to bottom, ${clan.bgColor}dd, var(--card-bg)); border-color:${clan.iconColor}">
                <i class="fas ${clan.icon}" style="font-size:3.5rem; color:${clan.iconColor}; background:rgba(0,0,0,0.3); padding:20px; border-radius:50%; box-shadow:0 0 20px ${clan.iconColor}55;"></i>
                <h2 style="margin:10px 0;">${clan.name}</h2>
                <p style="color:#cbd5e1; font-size:0.9rem;">${clan.description}</p>
                <div style="background:rgba(0,0,0,0.5); padding:5px 15px; border-radius:20px; display:inline-block; margin-top:5px;">
                    Level ${clanLevel} â€¢ ${clan.totalXp} XP
                </div>
            </div>

            <div class="top3-container">${top3HTML}</div>

            <div class="card">
                <h4 style="margin-top:0; border-right:3px solid var(--primary); padding-right:10px;">Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ (${clan.membersCount})</h4>
                <div style="max-height:300px; overflow-y:auto;">${membersHTML}</div>
                
                ${isLeader 
                    ? `<button class="btn-action btn-danger" onclick="deleteClan()">âŒ Ø­Ø°Ù Ø§Ù„ÙƒÙ„Ø§Ù† (Ø§Ù„Ù‚Ø§Ø¦Ø¯ ÙÙ‚Ø·)</button>` 
                    : `<button class="btn-action btn-danger" onclick="leaveClan()">ğŸƒ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ÙƒÙ„Ø§Ù†</button>`
                }
            </div>
        `;
    }

    /* ================= 2. Search & Join ================= */
    async function loadAllClans() {
        const snap = await db.collection("clans").orderBy("totalXp", "desc").limit(20).get();
        allClansCache = [];
        snap.forEach(doc => allClansCache.push(doc.data()));
        filterClans();
    }

    function filterClans() {
        const query = document.getElementById('search-input').value.toLowerCase();
        const container = document.getElementById('all-clans-list');
        container.innerHTML = "";

        const filtered = allClansCache.filter(c => c.name.toLowerCase().includes(query));

        if(filtered.length === 0) {
            container.innerHTML = "<div style='text-align:center; color:#64748b; padding:20px;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>";
            return;
        }

        filtered.forEach(c => {
            const level = Math.floor((c.totalXp || 0) / 2000) + 1;
            container.innerHTML += `
                <div class="clan-row" onclick="viewClanDetails('${c.name}')"> <i class="fas ${c.icon}" style="font-size:1.5rem; color:${c.iconColor}; margin-left:10px; width:30px; text-align:center;"></i>
                    <div style="flex:1;">
                        <div style="font-weight:bold;">${c.name}</div>
                        <div style="font-size:0.75rem; color:#94a3b8;">Level ${level} â€¢ ${c.membersCount} Ø£Ø¹Ø¶Ø§Ø¡</div>
                    </div>
                    ${!currentUser.clanId ? `<button class="btn-join" onclick="joinClan('${c.name}')">Ø§Ù†Ø¶Ù…Ø§Ù…</button>` : ''}
                </div>
            `;
        });
    }

    async function joinClan(clanName) {
        if(currentUser.clanId) return alert("Ø£Ù†Øª ÙÙŠ ÙƒÙ„Ø§Ù† Ø¨Ø§Ù„ÙØ¹Ù„!");
        
        try {
            const batch = db.batch();
            const clanRef = db.collection("clans").doc(clanName);
            const memRef = clanRef.collection("members").doc(currentUser.uid);
            const userRef = db.collection("users").doc(currentUser.uid);

            batch.set(memRef, {
                name: currentUser.displayName,
                photo: currentUser.photoURL || null,
                role: 'member',
                xp: 0,
                joinedAt: Date.now()
            });
            
            batch.update(clanRef, { membersCount: firebase.firestore.FieldValue.increment(1) });
            batch.update(userRef, { clanId: clanName });

            await batch.commit();
            alert("ØªÙ… Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­!");
            nav('home');
        } catch(e) { console.error(e); alert("Ø­Ø¯Ø« Ø®Ø·Ø£"); }
    }

    /* ================= 3. Management Actions ================= */
    async function leaveClan() {
        if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©ØŸ")) return;
        const cid = currentUser.clanId;
        
        const batch = db.batch();
        batch.delete(db.collection("clans").doc(cid).collection("members").doc(currentUser.uid));
        batch.update(db.collection("clans").doc(cid), { membersCount: firebase.firestore.FieldValue.increment(-1) });
        batch.update(db.collection("users").doc(currentUser.uid), { clanId: null });
        
        await batch.commit();
        alert("ØºØ§Ø¯Ø±Øª Ø§Ù„ÙƒÙ„Ø§Ù†.");
    }

    async function deleteClan() {
        if(!confirm("âš ï¸ ØªØ­Ø°ÙŠØ± Ù†Ù‡Ø§Ø¦ÙŠ: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„ÙƒÙ„Ø§Ù† Ù„Ù„Ø£Ø¨Ø¯!")) return;
        
        // ÙÙŠ Firebase Client-SideØŒ Ø­Ø°Ù Ø§Ù„ÙƒÙˆÙ„ÙƒØ´Ù† Ø§Ù„ÙØ±Ø¹ÙŠ ØµØ¹Ø¨.
        // Ø³Ù†Ø­Ø°Ù ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„ÙƒÙ„Ø§Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©ØŒ ÙˆØ¹Ù†Ø¯Ù…Ø§ ÙŠÙØªØ­ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ØŒ Ø³ÙŠØ¹Ù…Ù„ Ù†Ø¸Ø§Ù… Self-Healing
        
        const cid = currentUser.clanId;
        await db.collection("clans").doc(cid).delete();
        await db.collection("users").doc(currentUser.uid).update({ clanId: null });
        
        alert("ØªÙ… ØªÙÙƒÙŠÙƒ Ø§Ù„ÙƒÙ„Ø§Ù†.");
    }

    async function kickMember(uid, name) {
        if(!confirm(`Ø·Ø±Ø¯ ${name}ØŸ`)) return;
        const cid = currentUser.clanId;
        const batch = db.batch();
        
        batch.delete(db.collection("clans").doc(cid).collection("members").doc(uid));
        batch.update(db.collection("users").doc(uid), { clanId: null });
        batch.update(db.collection("clans").doc(cid), { membersCount: firebase.firestore.FieldValue.increment(-1) });
        
        await batch.commit();
    }

    /* ================= 4. Shop System ================= */
    function renderShopItems() {
        const lvl = currentClan ? Math.floor((currentClan.totalXp || 0) / 2000) + 1 : 0;
        document.getElementById('shop-lvl-badge').innerText = `Clan Lv.${lvl}`;

        const items = [
            { id: 1, name: "Ù…Ø¹Ø²Ø² XP", price: 200, icon: "fa-rocket", req: 1, type: "cp" },
            { id: 2, name: "ØªØºÙŠÙŠØ± Ø§Ù„Ø´Ø¹Ø§Ø±", price: 500, icon: "fa-paint-brush", req: 2, type: "cp" },
            { id: 3, name: "Ù…Ù‚Ø¹Ø¯ Ø¥Ø¶Ø§ÙÙŠ", price: 1000, icon: "fa-user-plus", req: 3, type: "cp" },
            { id: 4, name: "Ø´Ø§Ø±Ø© Ø§Ù„ØªÙ†ÙŠÙ†", price: 5000, icon: "fa-dragon", req: 5, type: "cp" },
            { id: 5, name: "Ø¨Ø·Ø§Ù‚Ø© Ø§Ø³Ù…", price: 1500, icon: "fa-id-card", req: 4, type: "cp" },
            { id: 6, name: "Ø¬ÙˆÙ‡Ø±Ø© Ø§Ù„Ø­Ø¸", price: 10000, icon: "fa-gem", req: 10, type: "cp" }
        ];

        const container = document.getElementById('shop-container');
        container.innerHTML = "";

        items.forEach(item => {
            const locked = lvl < item.req;
            container.innerHTML += `
                <div class="shop-item ${locked ? 'locked' : ''}" onclick="${!locked ? `buyItem('${item.name}', ${item.price})` : ''}">
                    ${locked ? `<div class="lock-overlay"><i class="fas fa-lock"></i></div>` : ''}
                    <i class="fas ${item.icon}" style="font-size:2rem; color:var(--gold); margin-bottom:10px;"></i>
                    <div style="font-weight:bold;">${item.name}</div>
                    <div style="color:${locked ? '#94a3b8' : 'var(--primary)'}; font-size:0.9rem;">${item.price} CP</div>
                    ${locked ? `<small style="color:var(--danger)">Ù…Ø·Ù„ÙˆØ¨ Lv.${item.req}</small>` : ''}
                </div>
            `;
        });
    }

    function buyItem(name, price) {
        if((currentUser.clanPoints || 0) < price) return alert("Ù†Ù‚Ø§Ø·Ùƒ Ù„Ø§ ØªÙƒÙÙŠ!");
        if(confirm(`Ø´Ø±Ø§Ø¡ ${name} Ù…Ù‚Ø§Ø¨Ù„ ${price} CPØŸ`)) {
            db.collection("users").doc(currentUser.uid).update({
                clanPoints: firebase.firestore.FieldValue.increment(-price)
            });
            alert("ØªÙ… Ø§Ù„Ø´Ø±Ø§Ø¡ (ØªØ¬Ø±ÙŠØ¨ÙŠ)");
        }
    }

    /* ================= 5. Create & Preview ================= */
    function updatePreview() {
        const p = document.getElementById('preview-box');
        const i = document.getElementById('preview-icon');
        
        p.style.background = document.getElementById('c-bg').value;
        p.style.borderColor = document.getElementById('c-color').value;
        i.className = `fas ${document.getElementById('c-icon').value}`;
        i.style.color = document.getElementById('c-color').value;
    }
    
    async function createClan() {
        const name = document.getElementById('c-name').value;
        if(name.length < 3) return alert("Ø§Ù„Ø§Ø³Ù… Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹");
        if(currentUser.totalCoins < 100) return alert("ØªØ­ØªØ§Ø¬ 100 ÙƒÙˆÙŠÙ†Ø²");

        const batch = db.batch();
        const clanRef = db.collection("clans").doc(name);
        
        batch.set(clanRef, {
            name: name,
            description: document.getElementById('c-desc').value,
            icon: document.getElementById('c-icon').value,
            iconColor: document.getElementById('c-color').value,
            bgColor: document.getElementById('c-bg').value,
            leaderId: currentUser.uid,
            membersCount: 1,
            totalXp: 0,
            createdAt: Date.now()
        });

        batch.set(clanRef.collection("members").doc(currentUser.uid), {
            name: currentUser.displayName, photo: currentUser.photoURL, role: 'leader', xp: 0, joinedAt: Date.now()
        });

        batch.update(db.collection("users").doc(currentUser.uid), {
            clanId: name,
            totalCoins: firebase.firestore.FieldValue.increment(-100)
        });

        try {
            await batch.commit();
            alert("ØªÙ… ØªØ£Ø³ÙŠØ³ Ø§Ù„ÙƒÙ„Ø§Ù†!");
            nav('home');
        } catch(e) { alert("Ø§Ù„Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„ Ø£Ùˆ Ø­Ø¯Ø« Ø®Ø·Ø£"); }
    }

    /* ================= 6. Profile Modal Logic ================= */
    async function fetchAndOpenProfile(targetUid) {
        document.getElementById('profileModal').style.display = 'flex';
        document.getElementById('modal-body').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        const doc = await db.collection("users").doc(targetUid).get();
        const user = doc.data();
        
        // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø´Ø§Ø±Ø§Øª
        let badgesHTML = "";
        if(user.equippedBadges) {
            user.equippedBadges.forEach(bKey => {
                const b = BADGES_CONFIG[bKey];
                if(b) badgesHTML += `<div class="badge-circle" style="background:${b.bg}"><i class="fas ${b.icon}"></i></div>`;
            });
        }

        document.getElementById('modal-body').innerHTML = `
            <div style="width:80px; height:80px; border-radius:50%; border:3px solid var(--primary); overflow:hidden; margin:0 auto 10px;">
                <img src="${user.photoURL || 'https://via.placeholder.com/80'}" style="width:100%; height:100%; object-fit:cover;">
            </div>
            <h2 style="margin:5px 0;">${user.displayName}</h2>
            <div style="margin-bottom:15px;">${badgesHTML}</div>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; background:rgba(0,0,0,0.3); padding:10px; border-radius:15px;">
                <div>
                    <small style="color:#94a3b8">Ø§Ù„Ù…Ø³ØªÙˆÙ‰</small><br>
                    <b>${Math.floor(Math.sqrt((user.xp || 0)/100)) + 1}</b>
                </div>
                <div>
                    <small style="color:#94a3b8">Ù†Ù‚Ø§Ø· Ø§Ù„ÙƒÙ„Ø§Ù†</small><br>
                    <b style="color:var(--primary)">${user.clanPoints || 0}</b>
                </div>
            </div>
        `;
    }

    function closeModal() { document.getElementById('profileModal').style.display = 'none'; }
    updatePreview(); // ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
</script>
</body>
</html>
