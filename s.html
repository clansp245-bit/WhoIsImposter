<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ›¡ï¸ Ø£Ø³Ø§Ø·ÙŠØ± Ø§Ù„ØªØ­Ø§Ù„ÙØ§Øª - Pro System</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="auth.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        :root {
            --primary: #6366f1;
            --clan-gold: #fbbf24;
            --clan-bg: #1e293b;
            --glass: rgba(255, 255, 255, 0.05);
            --pro-glow: 0 0 10px #fbbf24, 0 0 20px #fbbf24;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: #0f172a;
            color: #f1f5f9; padding: 15px; margin: 0; min-height: 100vh;
        }

        /* Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© */
        .clan-header { text-align: center; margin-bottom: 25px; }
        .clan-header h1 { 
            font-weight: 900; color: var(--clan-gold); margin: 0;
            background: linear-gradient(to bottom, #fbbf24, #b45309);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        /* Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª */
        .tabs {
            display: flex; gap: 8px; background: rgba(0,0,0,0.3); padding: 5px; border-radius: 15px;
            overflow-x: auto; margin-bottom: 20px;
        }
        .tab-btn {
            flex: 1; padding: 10px; border: none; background: transparent; color: #94a3b8;
            cursor: pointer; font-family: 'Cairo'; font-weight: bold; border-radius: 10px; 
            white-space: nowrap; transition: 0.3s;
        }
        .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4); }

        /* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
        .card {
            background: var(--clan-bg); border: 1px solid var(--glass);
            border-radius: 20px; padding: 20px; margin-bottom: 15px; position: relative;
            animation: fadeIn 0.5s ease;
        }

        /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† */
        .leader-item {
            display: flex; align-items: center; padding: 12px; margin-bottom: 8px;
            background: rgba(255,255,255,0.03); border-radius: 12px; border: 1px solid transparent;
        }
        .rank-num { font-size: 1.2rem; font-weight: 900; width: 40px; text-align: center; }
        .rank-1 { color: #fbbf24; text-shadow: 0 0 10px #fbbf24; }
        .rank-2 { color: #c0c0c0; }
        .rank-3 { color: #cd7f32; }

        /* Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙƒÙ„Ø§Ù† */
        .clan-xp-bar {
            height: 6px; background: rgba(0,0,0,0.5); border-radius: 3px; margin-top: 5px; overflow: hidden;
        }
        .clan-xp-fill {
            height: 100%; background: linear-gradient(90deg, var(--primary), #a855f7); width: 0%; transition: 1s;
        }

        /* ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ø¨Ø±Ùˆ */
        .is-pro-member {
            border: 1px solid #fbbf24 !important;
            background: linear-gradient(45deg, rgba(251, 191, 36, 0.1), transparent) !important;
        }
        .pro-badge { color: #fbbf24; margin-left: 5px; animation: pulse 2s infinite; }
        .badge-icon { background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-right: 5px; }

        /* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª */
        .reward-box {
            background: linear-gradient(135deg, #4f46e5, #ec4899);
            padding: 20px; border-radius: 20px; text-align: center; margin-top: 20px;
            cursor: pointer; transition: transform 0.2s;
        }
        .reward-box:active { transform: scale(0.95); }
        .reward-icon { font-size: 3rem; margin-bottom: 10px; filter: drop-shadow(0 0 10px rgba(0,0,0,0.5)); }

        /* Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ */
        .create-form input, .create-form select {
            width: 100%; padding: 12px; margin-bottom: 10px;
            background: #0f172a; border: 1px solid var(--glass); color: white; border-radius: 10px;
            box-sizing: border-box; font-family: 'Cairo';
        }
        .btn-action {
            width: 100%; padding: 15px; background: var(--clan-gold); color: black; font-weight: 900;
            border: none; border-radius: 12px; cursor: pointer; margin-top: 10px;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { opacity: 0.7; } 50% { opacity: 1; text-shadow: 0 0 10px #fbbf24; } 100% { opacity: 0.7; } }
    </style>
</head>
<body>

    <div class="clan-header">
        <h1>ğŸ›¡ï¸ Ø³Ø§Ø­Ø© Ø§Ù„Ø£Ø³Ø§Ø·ÙŠØ±</h1>
        <p>ØªÙ†Ø§ÙØ³ØŒ Ø³ÙŠØ·Ø±ØŒ ÙˆØ§Ø±Ø¨Ø­ Ø§Ù„Ø¬ÙˆØ§Ø¦Ø²</p>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="showTab('leaderboard')"><i class="fas fa-trophy"></i> Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†</button>
        <button class="tab-btn" onclick="showTab('myclan')"><i class="fas fa-home"></i> Ù…Ù‚Ø±ÙŠ</button>
        <button class="tab-btn" onclick="showTab('explore')"><i class="fas fa-search"></i> Ø¨Ø­Ø«</button>
        <button class="tab-btn" onclick="showTab('create')"><i class="fas fa-plus"></i> ØªØ£Ø³ÙŠØ³</button>
    </div>

    <div class="clan-container">
        
        <div id="tab-leaderboard" class="tab-content card">
            <h3 style="text-align:center; margin-top:0">ğŸ† Ø£Ù‚ÙˆÙ‰ Ø§Ù„ØªØ­Ø§Ù„ÙØ§Øª (XP)</h3>
            <div id="leaderboard-list">
                <div style="text-align:center; padding:20px;"><i class="fas fa-spinner fa-spin"></i> ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ±ØªÙŠØ¨...</div>
            </div>
        </div>

        <div id="tab-myclan" class="tab-content card" style="display:none;">
            <div id="my-clan-view"></div>
        </div>

        <div id="tab-explore" class="tab-content card" style="display:none;">
            <div id="explore-list"></div>
        </div>

        <div id="tab-create" class="tab-content card" style="display:none;">
            <div style="text-align:center; margin-bottom:15px;">
                <i class="fas fa-gem" style="color:#06b6d4;"></i> Ø§Ù„ØªÙƒÙ„ÙØ©: <b>1 Ø¬ÙˆÙ‡Ø±Ø©</b>
            </div>
            <input type="text" id="cName" placeholder="Ø§Ø³Ù… Ø§Ù„ÙƒÙ„Ø§Ù†" class="create-form">
            <input type="text" id="cDesc" placeholder="Ø§Ù„ÙˆØµÙ" class="create-form">
            <select id="cIcon" class="create-form">
                <option value="fa-dragon">ğŸ‰ ØªÙ†ÙŠÙ†</option>
                <option value="fa-crown">ğŸ‘‘ ØªØ§Ø¬</option>
                <option value="fa-skull">ğŸ’€ Ø¬Ù…Ø¬Ù…Ø©</option>
                <option value="fa-shield-alt">ğŸ›¡ï¸ Ø¯Ø±Ø¹</option>
                <option value="fa-bolt">âš¡ ØµØ§Ø¹Ù‚Ø©</option>
            </select>
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <input type="color" id="cColor" value="#fbbf24" style="height:40px; padding:0;">
                <input type="color" id="cBg" value="#1e293b" style="height:40px; padding:0;">
            </div>
            <button class="btn-action" onclick="createClan()">ØªØ£Ø³ÙŠØ³ Ø§Ù„Ø¢Ù†</button>
        </div>

    </div>

<script>
    let currentUserData = {};
    let isProUser = false;

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            const snap = await db.collection("users").doc(user.uid).get();
            currentUserData = snap.data() || {};
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø±Ùˆ
            isProUser = (currentUserData.proExpiryTime && currentUserData.proExpiryTime > Date.now());

            loadLeaderboard();
            checkMyClan();
            loadExplore();
        } else { window.location.href = "auth.html"; }
    });

    function showTab(t) {
        document.querySelectorAll('.tab-content').forEach(e => e.style.display = 'none');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-' + t).style.display = 'block';
        event.currentTarget.classList.add('active');
    }

    /* ===========================
       1. Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† (XP)
       =========================== */
    async function loadLeaderboard() {
        const list = document.getElementById('leaderboard-list');
        // ØªØ±ØªÙŠØ¨ ØªÙ†Ø§Ø²Ù„ÙŠ Ø­Ø³Ø¨ totalXp
        const snap = await db.collection("clans").orderBy("totalXp", "desc").limit(10).get();
        
        list.innerHTML = "";
        let rank = 1;

        snap.forEach(doc => {
            const c = doc.data();
            let rankClass = rank === 1 ? 'rank-1' : (rank === 2 ? 'rank-2' : (rank === 3 ? 'rank-3' : ''));
            
            list.innerHTML += `
                <div class="leader-item" style="border-right: 3px solid ${c.iconColor}">
                    <div class="rank-num ${rankClass}">#${rank}</div>
                    <div style="flex:1;">
                        <div style="font-weight:bold; display:flex; align-items:center; gap:5px;">
                            <i class="fas ${c.icon}" style="color:${c.iconColor}"></i> ${c.name}
                        </div>
                        <div style="font-size:0.8rem; color:#94a3b8;">${c.membersCount} Ù…Ø­Ø§Ø±Ø¨</div>
                        <div class="clan-xp-bar">
                            <div class="clan-xp-fill" style="width: ${Math.min(c.totalXp / 1000, 100)}%"></div>
                        </div>
                    </div>
                    <div style="font-weight:900; color:var(--primary);">${c.totalXp || 0} XP</div>
                </div>
            `;
            rank++;
        });
    }

    /* ===========================
       2. Ù…Ù†Ø·Ù‚ Ø§Ù„ÙƒÙ„Ø§Ù† ÙˆØ§Ù„Ù…ÙƒØ§ÙØ¢Øª
       =========================== */
    async function checkMyClan() {
        const container = document.getElementById('my-clan-view');
        if (!currentUserData.clanId) {
            container.innerHTML = `<div style="text-align:center; padding:40px; color:#94a3b8;">Ù„Ø§ ØªÙ†ØªÙ…ÙŠ Ù„Ø£ÙŠ ØªØ­Ø§Ù„Ù Ø­Ø§Ù„ÙŠØ§Ù‹.<br>Ø§Ù†Ø¶Ù… Ø£Ùˆ Ø£Ù†Ø´Ø¦ ÙˆØ§Ø­Ø¯Ø§Ù‹!</div>`;
            return;
        }

        const cDoc = await db.collection("clans").doc(currentUserData.clanId).get();
        const clan = cDoc.data();

        // ØªØ­Ø¯ÙŠØ« Ù…Ø¬Ù…ÙˆØ¹ XP Ø§Ù„ÙƒÙ„Ø§Ù† Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ (Ù†Ø¸Ø§Ù… Ø°ÙƒÙŠ)
        updateClanTotalXP(currentUserData.clanId);

        // ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ÙƒÙ„Ø§Ù†
        container.innerHTML = `
            <div style="background:${clan.bgColor}; padding:20px; border-radius:15px; text-align:center; margin-bottom:15px;">
                <i class="fas ${clan.icon}" style="font-size:3rem; color:${clan.iconColor}; background:rgba(0,0,0,0.3); padding:15px; border-radius:50%;"></i>
                <h2 style="margin:10px 0;">${clan.name}</h2>
                <span style="background:rgba(0,0,0,0.3); padding:4px 10px; border-radius:10px; font-size:0.9rem;">
                    Level ${Math.floor((clan.totalXp || 0) / 5000) + 1}
                </span>
            </div>

            <div class="reward-box" onclick="claimClanReward('${currentUserData.clanId}')">
                <div class="reward-icon">ğŸ</div>
                <h3>ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ØªØ­Ø§Ù„Ù Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3>
                <p style="font-size:0.8rem; opacity:0.9">Ø§Ø¶ØºØ· Ù„Ø§Ø³ØªÙ„Ø§Ù… XP ÙˆÙƒÙˆÙŠÙ†Ø²!</p>
            </div>

            <h3 style="margin-top:20px;">Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ (${clan.membersCount}/20)</h3>
            <div id="members-list"></div>
            
            <button onclick="leaveClan()" style="width:100%; padding:10px; background:transparent; border:1px solid #ef4444; color:#ef4444; border-radius:10px; margin-top:20px;">Ù…ØºØ§Ø¯Ø±Ø©</button>
        `;

        loadMembers(currentUserData.clanId);
    }

    async function loadMembers(cid) {
        const snap = await db.collection("clans").doc(cid).collection("members").orderBy("xp", "desc").get();
        const list = document.getElementById('members-list');
        list.innerHTML = "";

        snap.forEach(doc => {
            const m = doc.data();
            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø´Ø§Ø±Ø§Øª ÙˆØ§Ù„Ù…Ù…ÙŠØ²Ø§Øª
            let badgesHTML = "";
            if (m.role === 'leader') badgesHTML += `<span class="badge-icon" style="color:gold">ğŸ‘‘ Ù‚Ø§Ø¦Ø¯</span>`;
            if (m.isPro) badgesHTML += `<i class="fas fa-star pro-badge" title="Ù„Ø§Ø¹Ø¨ Ù…Ø­ØªØ±Ù"></i>`;
            
            list.innerHTML += `
                <div class="leader-item ${m.isPro ? 'is-pro-member' : ''}">
                    <div style="flex:1;">
                        <b>${m.name}</b> ${badgesHTML}
                        <div style="font-size:0.75rem; opacity:0.6;">${m.xp || 0} XP Ù…Ø³Ø§Ù‡Ù…Ø©</div>
                    </div>
                </div>
            `;
        });
    }

    /* ===========================
       3. Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª (Ø¬Ø¯ÙŠØ¯)
       =========================== */
    async function claimClanReward(cid) {
        const today = new Date().toDateString();
        const userRef = db.collection("users").doc(auth.currentUser.uid);
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…
        if (currentUserData.lastClanReward === today) {
            return alert("âœ‹ Ù„Ù‚Ø¯ Ø§Ø³ØªÙ„Ù…Øª Ø¬Ø§Ø¦Ø²ØªÙƒ Ø§Ù„ÙŠÙˆÙ… Ø¨Ø§Ù„ÙØ¹Ù„! Ø¹Ø¯ ØºØ¯Ø§Ù‹.");
        }

        // Ø§Ù„Ø¬Ø§Ø¦Ø²Ø©: 50 ÙƒÙˆÙŠÙ†Ø² + 100 XP
        const rewardCoins = isProUser ? 100 : 50; // Ø§Ù„Ø¨Ø±Ùˆ ÙŠØ£Ø®Ø° Ø§Ù„Ø¶Ø¹Ù
        const rewardXP = 100;

        await userRef.update({
            totalCoins: firebase.firestore.FieldValue.increment(rewardCoins),
            xp: firebase.firestore.FieldValue.increment(rewardXP),
            lastClanReward: today
        });
        
        // ØªØ­Ø¯ÙŠØ« Ù…Ø³Ø§Ù‡Ù…Ø© Ø§Ù„Ø¹Ø¶Ùˆ Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒÙ„Ø§Ù†
        await db.collection("clans").doc(cid).collection("members").doc(auth.currentUser.uid).update({
            xp: firebase.firestore.FieldValue.increment(rewardXP)
        });

        alert(`ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! Ø­ØµÙ„Øª Ø¹Ù„Ù‰ ${rewardCoins} Ø¹Ù…Ù„Ø© Ùˆ ${rewardXP} XP!`);
        location.reload();
    }

    /* ===========================
       4. ØªØ­Ø¯ÙŠØ« XP Ø§Ù„ÙƒÙ„Ø§Ù† (ØªÙ„Ù‚Ø§Ø¦ÙŠ)
       =========================== */
    async function updateClanTotalXP(cid) {
        // Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ØªØ¬Ù…Ø¹ XP ÙƒÙ„ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ ÙˆØªØ­Ø¯Ø« ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„ÙƒÙ„Ø§Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ù„ÙŠØ¯Ø±Ø¨ÙˆØ±Ø¯
        const memSnap = await db.collection("clans").doc(cid).collection("members").get();
        let total = 0;
        memSnap.forEach(d => total += (d.data().xp || 0));
        
        await db.collection("clans").doc(cid).update({ totalXp: total });
    }

    /* ===========================
       5. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ£Ø³ÙŠØ³ ÙˆØ§Ù„Ø¨Ø­Ø«
       =========================== */
    async function createClan() {
        const name = document.getElementById('cName').value;
        const icon = document.getElementById('cIcon').value;
        const color = document.getElementById('cColor').value;
        const bg = document.getElementById('cBg').value;

        if((currentUserData.s_gems || 0) < 1) return alert("ØªØ­ØªØ§Ø¬ 1 Ø¬ÙˆÙ‡Ø±Ø©!");
        if(name.length < 3) return alert("Ø§Ù„Ø§Ø³Ù… Ù‚ØµÙŠØ±");

        const batch = db.batch();
        const clanRef = db.collection("clans").doc(name);
        const userRef = db.collection("users").doc(auth.currentUser.uid);
        const memberRef = clanRef.collection("members").doc(auth.currentUser.uid);

        batch.set(clanRef, {
            name: name,
            description: document.getElementById('cDesc').value,
            icon: icon, iconColor: color, bgColor: bg,
            leaderId: auth.currentUser.uid,
            membersCount: 1,
            totalXp: currentUserData.xp || 0, // ÙŠØ¨Ø¯Ø£ Ø§Ù„ÙƒÙ„Ø§Ù† Ø¨Ù€ XP Ø§Ù„Ù‚Ø§Ø¦Ø¯
            createdAt: Date.now()
        });

        batch.set(memberRef, {
            name: currentUserData.displayName,
            role: 'leader',
            xp: currentUserData.xp || 0,
            isPro: isProUser, // ØªØ®Ø²ÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø±Ùˆ Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø±ÙŠØ¹
            joinedAt: Date.now()
        });

        batch.update(userRef, {
            s_gems: firebase.firestore.FieldValue.increment(-1),
            clanId: name
        });

        await batch.commit();
        location.reload();
    }

    async function loadExplore() {
        const list = document.getElementById('explore-list');
        const snap = await db.collection("clans").limit(10).get();
        list.innerHTML = "";
        snap.forEach(doc => {
            const c = doc.data();
            list.innerHTML += `
                <div class="leader-item">
                    <i class="fas ${c.icon}" style="color:${c.iconColor}; font-size:1.5rem; margin-left:10px;"></i>
                    <div style="flex:1">
                        <b>${c.name}</b>
                        <div style="font-size:0.7rem;">${c.totalXp || 0} XP â€¢ ${c.membersCount} Ø¹Ø¶Ùˆ</div>
                    </div>
                    <button onclick="joinClan('${doc.id}')" style="background:var(--primary); border:none; color:white; padding:5px 15px; border-radius:8px;">Ø§Ù†Ø¶Ù…Ø§Ù…</button>
                </div>
            `;
        });
    }

    async function joinClan(cid) {
        if(currentUserData.clanId) return alert("ØºØ§Ø¯Ø± ÙƒÙ„Ø§Ù†Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø£ÙˆÙ„Ø§Ù‹");
        
        await db.collection("clans").doc(cid).collection("members").doc(auth.currentUser.uid).set({
            name: currentUserData.displayName,
            role: 'member',
            xp: currentUserData.xp || 0,
            isPro: isProUser,
            joinedAt: Date.now()
        });
        
        await db.collection("users").doc(auth.currentUser.uid).update({ clanId: cid });
        
        // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡
        await db.collection("clans").doc(cid).update({
            membersCount: firebase.firestore.FieldValue.increment(1)
        });

        alert("ØªÙ… Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…!");
        location.reload();
    }
    
    async function leaveClan() {
        if(!confirm("Ù…ØºØ§Ø¯Ø±Ø©ØŸ")) return;
        const cid = currentUserData.clanId;
        const batch = db.batch();
        
        batch.delete(db.collection("clans").doc(cid).collection("members").doc(auth.currentUser.uid));
        batch.update(db.collection("clans").doc(cid), { membersCount: firebase.firestore.FieldValue.increment(-1) });
        batch.update(db.collection("users").doc(auth.currentUser.uid), { clanId: null });
        
        await batch.commit();
        location.reload();
    }

</script>
</body>
</html>
