<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ›¡ï¸ Ù†Ø¸Ø§Ù… Ø§Ù„ÙƒÙ„Ø§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø·ÙˆØ±ÙŠØ©</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="auth.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        :root {
            --primary: #6366f1;
            --clan-gold: #fbbf24;
            --clan-bg: rgba(30, 41, 59, 0.7);
            --danger: #ef4444;
            --glass: rgba(255, 255, 255, 0.05);
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: #0a0f1e;
            background-image: radial-gradient(circle at top right, #1e1b4b, transparent);
            color: #f1f5f9; padding: 20px; min-height: 100vh; margin: 0;
        }

        /* Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© */
        .clan-header {
            text-align: center; margin-bottom: 30px;
        }
        .clan-header h1 { font-weight: 900; font-size: 2.2rem; color: var(--clan-gold); text-shadow: 0 0 20px rgba(251, 191, 36, 0.3); }

        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ */
        .tabs {
            display: flex; gap: 10px; background: var(--clan-bg); padding: 5px; border-radius: 15px;
            max-width: 500px; margin: 0 auto 25px;
        }
        .tab-btn {
            flex: 1; padding: 12px; border: none; background: transparent; color: #94a3b8;
            cursor: pointer; font-family: 'Cairo'; font-weight: bold; border-radius: 12px; transition: 0.3s;
        }
        .tab-btn.active { background: var(--primary); color: white; }

        /* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
        .clan-container {
            max-width: 600px; margin: 0 auto;
        }

        .card {
            background: var(--clan-bg); backdrop-filter: blur(15px); border: 1px solid var(--glass);
            border-radius: 24px; padding: 25px; margin-bottom: 20px;
        }

        /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ø­Ø« */
        .search-box {
            display: flex; gap: 10px; margin-bottom: 20px;
        }
        .search-box input {
            flex: 1; padding: 12px; border-radius: 12px; border: 1px solid var(--glass);
            background: rgba(0,0,0,0.2); color: white; font-family: 'Cairo';
        }

        /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒÙ„Ø§Ù†Ø§Øª */
        .clan-item {
            display: flex; align-items: center; justify-content: space-between;
            background: var(--glass); padding: 15px; border-radius: 18px; margin-bottom: 10px;
            border: 1px solid transparent; transition: 0.3s;
        }
        .clan-item:hover { border-color: var(--primary); background: rgba(255,255,255,0.08); }
        .clan-info { display: flex; align-items: center; gap: 15px; }
        .clan-icon { width: 50px; height: 50px; background: var(--primary); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
        .clan-name { font-weight: 900; font-size: 1.1rem; }
        .clan-stats { font-size: 0.8rem; color: #94a3b8; }

        /* ÙÙˆØ±Ù… Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙ„Ø§Ù† */
        .create-form { display: flex; flex-direction: column; gap: 15px; }
        .create-form input, .create-form select {
            padding: 15px; border-radius: 12px; border: 1px solid var(--glass); background: #0f172a; color: white; font-family: 'Cairo';
        }
        .btn-create {
            background: var(--clan-gold); color: #000; font-weight: 900; padding: 15px;
            border: none; border-radius: 12px; cursor: pointer; transition: 0.3s;
        }
        .btn-create:hover { transform: scale(1.02); opacity: 0.9; }

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ÙƒÙ„Ø§Ù† Ø§Ù„Ø®Ø§Øµ Ø¨ÙŠ */
        .my-clan-header { text-align: center; }
        .member-list { margin-top: 20px; }
        .member-item {
            display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid var(--glass);
        }
        .role-tag { font-size: 0.7rem; padding: 2px 8px; border-radius: 5px; background: var(--primary); }

        .btn-leave { color: var(--danger); background: none; border: none; cursor: pointer; margin-top: 20px; }

        .gem-requirement { color: var(--clan-gold); font-weight: bold; font-size: 0.9rem; margin-top: 5px; }

        .loader { text-align: center; padding: 20px; }
    </style>
</head>
<body>

    <div class="clan-header">
        <h1>ğŸ›¡ï¸ ØªØ­Ø§Ù„ÙØ§Øª Ø§Ù„Ø£Ø³Ø§Ø·ÙŠØ±</h1>
        <p>Ø§Ø¬ØªÙ…Ø¹ Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ ÙˆØ³ÙŠØ·Ø±ÙˆØ§ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø§Ø­Ø©</p>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="showTab('explore')"><i class="fas fa-compass"></i> Ø§Ø³ØªÙƒØ´Ø§Ù</button>
        <button class="tab-btn" onclick="showTab('myclan')"><i class="fas fa-shield-halved"></i> ÙƒÙ„Ø§Ù†ÙŠ</button>
        <button class="tab-btn" onclick="showTab('create')"><i class="fas fa-plus"></i> Ø¥Ù†Ø´Ø§Ø¡</button>
    </div>

    <div class="clan-container">
        <div id="tab-explore" class="tab-content card">
            <div class="search-box">
                <input type="text" id="clanSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ø§Ù„ÙƒÙ„Ø§Ù†...">
                <button class="tab-btn active" style="padding: 10px 20px;"><i class="fas fa-search"></i></button>
            </div>
            <div id="explore-list">
                <div class="loader"><i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
            </div>
        </div>

        <div id="tab-create" class="tab-content card" style="display:none;">
            <div class="create-form">
                <h2>Ø£Ù†Ø´Ø¦ ØªØ­Ø§Ù„ÙÙƒ Ø§Ù„Ø®Ø§Øµ</h2>
                <p class="gem-requirement"><i class="fas fa-gem"></i> ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: 100 Ø¬ÙˆÙ‡Ø±Ø©</p>
                <input type="text" id="newClanName" placeholder="Ø§Ø³Ù… Ø§Ù„ÙƒÙ„Ø§Ù† (Ù…Ø«Ù„Ø§Ù‹: Ø§Ù„Ù…Ø­ØªØ§Ù„ÙˆÙ† Ø§Ù„Ø³Ø¨Ø¹Ø©)">
                <input type="text" id="newClanDesc" placeholder="ÙˆØµÙ Ø§Ù„ÙƒÙ„Ø§Ù†...">
                <select id="newClanType">
                    <option value="public">Ø¹Ø§Ù… (ÙŠÙ…ÙƒÙ† Ù„Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…)</option>
                    <option value="private">Ø®Ø§Øµ (Ø¨Ø·Ù„Ø¨ Ø§Ù†Ø¶Ù…Ø§Ù…)</option>
                </select>
                <button class="btn-create" onclick="createNewClan()">ØªØ£Ø³ÙŠØ³ Ø§Ù„ÙƒÙ„Ø§Ù† Ø§Ù„Ø¢Ù†</button>
            </div>
        </div>

        <div id="tab-myclan" class="tab-content card" style="display:none;">
            <div id="my-clan-details">
                <div class="loader">ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¶ÙˆÙŠØªÙƒ...</div>
            </div>
        </div>
    </div>

<script>
    let userData = {};

    // 1. ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            const userDoc = await db.collection("users").doc(user.uid).get();
            userData = userDoc.data();
            loadClans();
            checkMyClan();
        } else { window.location.href = "auth.html"; }
    });

    function showTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-' + tabName).style.display = 'block';
        event.currentTarget.classList.add('active');
    }

    // 2. ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙ„Ø§Ù†Ø§Øª (Ø§Ø³ØªÙƒØ´Ø§Ù)
    async function loadClans() {
        const list = document.getElementById('explore-list');
        const snap = await db.collection("clans").orderBy("power", "desc").limit(10).get();
        
        list.innerHTML = "";
        if(snap.empty) list.innerHTML = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒÙ„Ø§Ù†Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹. ÙƒÙ† Ø£ÙˆÙ„ Ù…Ù† ÙŠÙ†Ø´Ø¦ ÙˆØ§Ø­Ø¯Ø§Ù‹!";

        snap.forEach(doc => {
            const clan = doc.data();
            list.innerHTML += `
                <div class="clan-item">
                    <div class="clan-info">
                        <div class="clan-icon"><i class="fas fa-shield-alt"></i></div>
                        <div>
                            <div class="clan-name">${clan.name}</div>
                            <div class="clan-stats">${clan.membersCount}/20 Ø¹Ø¶Ùˆ â€¢ Ù‚ÙˆØ©: ${clan.power || 0}</div>
                        </div>
                    </div>
                    <button class="tab-btn active" style="padding:5px 15px;" onclick="joinClan('${doc.id}')">Ø§Ù†Ø¶Ù…Ø§Ù…</button>
                </div>
            `;
        });
    }

    // 3. Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙ„Ø§Ù† Ø¬Ø¯ÙŠØ¯ (ÙŠØªØ·Ù„Ø¨ 100 Ø¬ÙˆÙ‡Ø±Ø©)
    async function createNewClan() {
        const name = document.getElementById('newClanName').value.trim();
        const desc = document.getElementById('newClanDesc').value.trim();
        const type = document.getElementById('newClanType').value;
        const user = auth.currentUser;

        if (name.length < 3) return alert("Ø§Ù„Ø§Ø³Ù… Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹");
        if ((userData.s_gems || 0) < 100) return alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø¬ÙˆØ§Ù‡Ø± ÙƒØ§ÙÙŠØ©! ØªØ­ØªØ§Ø¬ 100 Ø¬ÙˆÙ‡Ø±Ø©.");

        try {
            // Ø®ØµÙ… Ø§Ù„Ø¬ÙˆØ§Ù‡Ø±
            await db.collection("users").doc(user.uid).update({
                s_gems: firebase.firestore.FieldValue.increment(-100),
                clanId: name // Ø±Ø¨Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙƒÙ„Ø§Ù†
            });

            // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒÙ„Ø§Ù†
            await db.collection("clans").doc(name).set({
                name: name,
                description: desc,
                type: type,
                leaderId: user.uid,
                leaderName: userData.displayName,
                membersCount: 1,
                power: 0,
                createdAt: Date.now()
            });

            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ±Ø¹ÙŠØ© Ù„Ù„ÙƒÙ„Ø§Ù†
            await db.collection("clans").doc(name).collection("members").doc(user.uid).set({
                name: userData.displayName,
                role: 'leader',
                joinedAt: Date.now()
            });

            alert("Ù…Ø¨Ø±ÙˆÙƒ! ØªÙ… ØªØ£Ø³ÙŠØ³ ÙƒÙ„Ø§Ù†Ùƒ Ø¨Ù†Ø¬Ø§Ø­.");
            location.reload();
        } catch(e) { console.error(e); }
    }

    // 4. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„ÙƒÙ„Ø§Ù† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    async function checkMyClan() {
        const container = document.getElementById('my-clan-details');
        if (!userData.clanId) {
            container.innerHTML = `<div style="text-align:center; padding:40px;">
                <i class="fas fa-ghost fa-3x" style="opacity:0.2"></i>
                <p>Ø£Ù†Øª Ù„Ø³Øª Ø¹Ø¶ÙˆØ§Ù‹ ÙÙŠ Ø£ÙŠ ÙƒÙ„Ø§Ù† Ø­Ø§Ù„ÙŠØ§Ù‹.</p>
                <button class="btn-create" style="background:var(--primary); color:white" onclick="showTab('explore')">Ø§Ø¨Ø­Ø« Ø¹Ù† ÙƒÙ„Ø§Ù†</button>
            </div>`;
            return;
        }

        const clanDoc = await db.collection("clans").doc(userData.clanId).get();
        const clan = clanDoc.data();
        
        container.innerHTML = `
            <div class="my-clan-header">
                <div class="clan-icon" style="margin: 0 auto 15px; width:80px; height:80px; font-size:2rem;">ğŸ›¡ï¸</div>
                <h2>${clan.name}</h2>
                <p style="color:#94a3b8">${clan.description}</p>
                <div style="display:flex; justify-content:center; gap:20px; margin:20px 0;">
                    <div><small>Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</small><br><b>${clan.membersCount}/20</b></div>
                    <div><small>Ø§Ù„Ù‚ÙˆØ© Ø§Ù„Ø¹Ø§Ù…Ø©</small><br><b style="color:var(--clan-gold)">${clan.power}</b></div>
                </div>
            </div>
            <div class="member-list">
                <h3>Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</h3>
                <div id="members-container">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©...</div>
            </div>
            <button class="btn-leave" onclick="leaveClan()"><i class="fas fa-door-open"></i> Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ÙƒÙ„Ø§Ù†</button>
        `;
        loadClanMembers(userData.clanId);
    }

    async function loadClanMembers(clanId) {
        const snap = await db.collection("clans").doc(clanId).collection("members").get();
        const container = document.getElementById('members-container');
        container.innerHTML = "";
        snap.forEach(doc => {
            const m = doc.data();
            container.innerHTML += `
                <div class="member-item">
                    <span>${m.name}</span>
                    <span class="role-tag">${m.role === 'leader' ? 'Ø§Ù„Ù‚Ø§Ø¦Ø¯' : 'Ø¹Ø¶Ùˆ'}</span>
                </div>
            `;
        });
    }

    async function joinClan(clanId) {
        if (userData.clanId) return alert("ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ù…ØºØ§Ø¯Ø±Ø© ÙƒÙ„Ø§Ù†Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø£ÙˆÙ„Ø§Ù‹!");
        
        await db.collection("clans").doc(clanId).update({
            membersCount: firebase.firestore.FieldValue.increment(1)
        });
        
        await db.collection("clans").doc(clanId).collection("members").doc(auth.currentUser.uid).set({
            name: userData.displayName,
            role: 'member',
            joinedAt: Date.now()
        });

        await db.collection("users").doc(auth.currentUser.uid).update({ clanId: clanId });
        alert("ØªÙ… Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ÙƒÙ„Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­!");
        location.reload();
    }

    async function leaveClan() {
        if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ÙƒÙ„Ø§Ù†ØŸ")) return;
        const cid = userData.clanId;
        
        await db.collection("clans").doc(cid).collection("members").doc(auth.currentUser.uid).delete();
        await db.collection("clans").doc(cid).update({
            membersCount: firebase.firestore.FieldValue.increment(-1)
        });
        await db.collection("users").doc(auth.currentUser.uid).update({ clanId: null });
        
        location.reload();
    }
</script>
</body>
</html>
