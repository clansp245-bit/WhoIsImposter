<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ› ï¸ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø·ÙˆØ±</title>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script src="auth.js"></script> 

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght=400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
/* ... Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª (ØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù‡Ø§ ÙƒÙ…Ø§ Ù‡ÙŠ) ... */
body{
  font-family:'Cairo',sans-serif;
  background:#0f172a;
  color:#f1f5f9;
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:20px;
  min-height:100vh;
}
.card{
  background:#1e293b;
  padding:25px;
  border-radius:12px;
  width:90%;
  max-width:500px;
  margin-bottom:20px;
}
h2{text-align:center;color:#34d399;margin-bottom:20px;}
h3{color:#ffd700; border-bottom: 1px solid #334155; padding-bottom: 10px; margin-top: 30px;}
label{display:block;margin-top:12px;}
input{width:100%;margin-top:6px;padding:10px;border-radius:8px;border:1px solid #334155;background:#334155;color:#fff;}
button{
  margin-top:12px;
  padding:10px;
  border:none;
  border-radius:8px;
  background:#6366f1;
  color:#fff;
  cursor:pointer;
  transition: background 0.2s;
}
button:hover{background:#4f46e5;}
#findUserBtn { background: #10b981; }
#findUserBtn:hover { background: #059669; }
#updateUidBtn { background: #ef4444; }
#updateUidBtn:hover { background: #dc2626; }
.msg{margin-top:12px;text-align:center;font-weight: bold;}
#codeMsg { color:#ffd700; }
#uidMsg { color:#34d399; }
.code-box{
  background:#334155;
  padding:15px;
  border-radius:10px;
  margin-top:12px;
  display:flex;
  flex-direction:column;
}
.code-header{display:flex;justify-content:space-between;align-items:center;}
.code-actions button{margin-top:6px;}
#userInfoDisplay{
    background: #334155;
    padding: 15px;
    border-radius: 8px;
    margin-top: 15px;
    text-align: right;
    border-left: 5px solid #34d399;
}
</style>
</head>
<body>

<h2><i class="fas fa-tools"></i> Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø·ÙˆØ±</h2>

<div class="card">
  <h3><i class="fas fa-id-badge"></i> ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ø§Ù… (Public UID)</h3>
  
  <label>UID Ø§Ù„Ø­Ø§Ù„ÙŠ (Firebase UID)</label>
  <input id="targetUidInput" placeholder="Ø£Ø¯Ø®Ù„ Firebase UID Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ù„Ø§Ø¹Ø¨">
  <button id="findUserBtn"><i class="fas fa-search"></i> Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
  
  <div id="userInfoDisplay" style="display:none;">
      <p>Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨: <strong id="currentName">---</strong></p>
      <p>Ø§Ù„Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø­Ø§Ù„ÙŠ: <strong id="currentPublicUid">---</strong></p>
      <label>Ø§Ù„Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Public UID)</label>
      <input id="newPublicUidInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ (IMP-XXXX-XXXX)" maxlength="14">
      <button id="updateUidBtn"><i class="fas fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¹Ø§Ù…</button>
  </div>

  <div id="uidMsg" class="msg"></div>
</div>

<div class="card">
  <h3><i class="fas fa-ticket-alt"></i> Ø¥Ø¯Ø§Ø±Ø© Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø®ØµÙ…</h3>
  <label>Ø§Ø³Ù… Ø§Ù„ÙƒÙˆØ¯</label>
  <input id="codeName" placeholder="Ù…Ø«Ø§Ù„: FREE100">

  <label>Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙˆÙŠÙ†Ø²</label>
  <input type="number" id="coins" value="50">

  <label>Ù…Ø¯Ø© Pro Ø¨Ø§Ù„Ø£ÙŠØ§Ù… (0 = Ø¨Ø¯ÙˆÙ†)</label>
  <input type="number" id="proDays" value="0">

  <label>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… (0 = Ù„Ø§ Ø­Ø¯)</label>
  <input type="number" id="maxUses" value="0">

  <button id="createBtn">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¯</button>
  <div id="codeMsg" class="msg"></div>
</div>

<div id="codesList" style="width:90%; max-width:500px;"></div>

<script>
let targetUserRef = null;
// Ø§Ù„Ù…ØªØºÙŠØ± db Ù…ÙØ¹Ø±Ù‘ÙÙ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ auth.js

firebase.auth().onAuthStateChanged(user => {
  // ğŸš¨ ÙØ­Øµ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ (Admin)
  if(!user || user.email !== "clansp245@gmail.com"){ 
    document.body.innerHTML = "<h2 style='color:#ff4f4f;'>ğŸš« Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©.</h2>"; 
    return;
  }
  
  // ==================================
  // Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ÙƒÙˆØ§Ø¯
  // ==================================
  const dbRef = db.collection("promocodes");
  const codeMsg = document.getElementById("codeMsg");

  document.getElementById("createBtn").onclick = async () => {
    const code = document.getElementById("codeName").value.trim().toUpperCase();
    const coins = Number(document.getElementById("coins").value);
    const proDays = Number(document.getElementById("proDays").value);
    const maxUses = Number(document.getElementById("maxUses").value);
    if(!code){ codeMsg.textContent = "âŒ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ÙƒÙˆØ¯"; return; }
    if(!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¯ ${code}?`)) return;

    try{
      const ref = dbRef.doc(code);
      const snap = await ref.get();
      if(snap.exists){ codeMsg.textContent="âŒ Ø§Ù„ÙƒÙˆØ¯ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§"; return; }

      await ref.set({
        coins: coins,
        durationDays: proDays,
        maxUses,
        redeemedBy: [],
        active:true,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      codeMsg.textContent="âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ù†Ø¬Ø§Ø­";
      loadCodes();
      document.getElementById("codeName").value="";
      document.getElementById("coins").value=50;
      document.getElementById("proDays").value=0;
      document.getElementById("maxUses").value=0;
    }catch(e){
      console.error(e);
      codeMsg.textContent="âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡";
    }
  };

  async function loadCodes(){
    const listDiv = document.getElementById("codesList");
    listDiv.innerHTML = "";
    const snapshot = await dbRef.orderBy("createdAt","desc").get();
    snapshot.forEach(doc=>{
      const data = doc.data();
      const redeemedCount = (data.redeemedBy || []).length;
      const maxUsesDisplay = data.maxUses === 0 ? 'âˆ' : data.maxUses;

      const codeDiv = document.createElement("div");
      codeDiv.className="code-box";
      codeDiv.innerHTML=`
        <div class="code-header">
          <strong style="color: ${data.active ? '#34d399' : '#ff4f4f'};">${doc.id} ${data.active ? '' : '(Ù…Ø¹Ø·Ù‘Ù„)'}</strong>
          <span style="font-size: 0.9rem;">
            Coins: ${data.coins || 0}, ProDays: ${data.durationDays || 0}
          </span>
        </div>
        <div style="font-size: 0.85rem; color: #94a3b8; margin-top: 5px;">
            ØªÙ… Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…: ${redeemedCount} / ${maxUsesDisplay}
        </div>
        <div class="code-actions">
          <button style="background:${data.active?'#f59e0b':'#34d399'};" onclick="toggleActive('${doc.id}',${data.active})">${data.active?'ØªØ¹Ø·ÙŠÙ„':'ØªÙØ¹ÙŠÙ„'}</button>
          <button style="background:#ef4444;" onclick="deleteCode('${doc.id}')">Ø­Ø°Ù</button>
        </div>
      `;
      listDiv.appendChild(codeDiv);
    });
  }

  window.toggleActive = async (codeId,currentStatus) => {
    try{
      await dbRef.doc(codeId).update({active: !currentStatus});
      loadCodes();
    }catch(e){ console.error(e); alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£"); }
  }

  window.deleteCode = async (codeId) => {
    if(!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¯ ${codeId}?`)) return;
    try{
      await dbRef.doc(codeId).delete();
      loadCodes();
    }catch(e){ console.error(e); alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£"); }
  }


  // ==================================
  // Ø¯ÙˆØ§Ù„ ØªØºÙŠÙŠØ± UID
  // ==================================
  const uidMsg = document.getElementById("uidMsg");
  const userInfoDisplay = document.getElementById("userInfoDisplay");

  document.getElementById("findUserBtn").onclick = async () => {
    uidMsg.textContent = "";
    userInfoDisplay.style.display = 'none';
    const targetUid = document.getElementById("targetUidInput").value.trim();
    if (!targetUid) {
      uidMsg.textContent = "âŒ Ø£Ø¯Ø®Ù„ Firebase UID Ù„Ù„Ø¨Ø­Ø«.";
      return;
    }

    try {
      // Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… db Ø§Ù„Ù…ÙØ¹Ø±Ù ÙÙŠ auth.js
      targetUserRef = db.collection("users").doc(targetUid);
      const doc = await targetUserRef.get();

      if (!doc.exists) {
        uidMsg.textContent = `âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø°Ùˆ Ø§Ù„Ù€ UID: ${targetUid} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.`;
        return;
      }

      const data = doc.data();
      document.getElementById("currentName").textContent = data.displayName || data.username || '---';
      document.getElementById("currentPublicUid").textContent = data.publicUid || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
      document.getElementById("newPublicUidInput").value = data.publicUid || '';
      userInfoDisplay.style.display = 'block';
      uidMsg.textContent = "âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….";
    } catch (e) {
      console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«:", e);
      uidMsg.textContent = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…. ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Firebase UID ØµØ­ÙŠØ­.";
    }
  };

  document.getElementById("updateUidBtn").onclick = async () => {
    if (!targetUserRef) {
      uidMsg.textContent = "âŒ ÙŠØ¬Ø¨ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹.";
      return;
    }

    const newPublicUid = document.getElementById("newPublicUidInput").value.trim().toUpperCase();

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ (14 Ø­Ø±ÙÙ‹Ø§ ÙˆØªØ¨Ø¯Ø£ Ø¨Ù€ IMP-)
    if (newPublicUid.length !== 14 || !newPublicUid.startsWith('IMP-')) {
        uidMsg.textContent = "âŒ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 14 Ø­Ø±ÙØ§Ù‹ ÙˆÙŠØ¨Ø¯Ø£ Ø¨Ù€ 'IMP-'.";
        return;
    }

    if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ ${newPublicUid}ØŸ`)) return;

    try {
      // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø§Ù„Ù€ UID Ø§Ù„Ø¬Ø¯ÙŠØ¯
      const existingUser = await db.collection('users').where('publicUid', '==', newPublicUid).limit(1).get();
      if (!existingUser.empty && existingUser.docs[0].id !== targetUserRef.id) {
          uidMsg.textContent = "âŒ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¹Ø§Ù… (Public UID) Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„ Ù…Ù† Ù‚Ø¨Ù„ Ø´Ø®Øµ Ø¢Ø®Ø±!";
          return;
      }

      // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚Ù„
      await targetUserRef.update({
        publicUid: newPublicUid
      });

      uidMsg.textContent = `âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¹Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰: ${newPublicUid}`;
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
      document.getElementById("currentPublicUid").textContent = newPublicUid;
      
    } catch (e) {
      console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«:", e);
      uidMsg.textContent = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø±Ù‘Ù.";
    }
  };

  loadCodes();

});
</script>

</body>
</html>

