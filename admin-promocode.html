<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ÙƒÙˆØ§Ø¯</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="auth.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">

<style>
body{
  font-family:'Cairo',sans-serif;
  background:#0f172a;
  color:#f1f5f9;
  padding:20px;
}
h2{text-align:center;color:#34d399;margin-bottom:20px;}
.card{
  background:#1e293b;
  padding:20px;
  border-radius:12px;
  margin-bottom:15px;
  position:relative;
}
input{
  width:100%;
  margin-top:6px;
  padding:10px;
  border-radius:8px;
  border:1px solid #334155;
  background:#334155;
  color:#fff;
}
button{
  padding:8px 12px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  margin:2px;
}
button.create{background:#34d399;color:#000;font-weight:700;}
button.toggle{background:#facc15;color:#000;}
button.delete{background:#ef4444;color:#fff;}
button.edit{background:#6366f1;color:#fff;}
button:hover{opacity:0.85;}
.cards-container{margin-top:20px;}
.card-actions{margin-top:10px;text-align:left;}
.card small{color:#94a3b8;}
.msg{margin-top:10px;text-align:center;}
</style>
</head>

<body>
<h2>ğŸŸï¸ Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ÙƒÙˆØ§Ø¯</h2>

<div class="card">
  <label>Ø§Ø³Ù… Ø§Ù„ÙƒÙˆØ¯</label>
  <input id="codeName" placeholder="Ù…Ø«Ø§Ù„: FREE100">

  <label>Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙˆÙŠÙ†Ø²</label>
  <input type="number" id="coins" value="50">

  <label>Ù…Ø¯Ø© Pro Ø¨Ø§Ù„Ø£ÙŠØ§Ù… (0 = Ø¨Ø¯ÙˆÙ†)</label>
  <input type="number" id="proDays" value="0">

  <label>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… (0 = ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯)</label>
  <input type="number" id="maxUses" value="0">

  <button class="create" onclick="createCode()">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¯</button>
  <div id="msg" class="msg"></div>
</div>

<h3 style="margin-top:30px;">ğŸ“œ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>
<div class="cards-container" id="codesContainer">
  <!-- Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ù‡Ù†Ø§ -->
</div>

<script>
firebase.auth().onAuthStateChanged(user=>{
  if(!user){
    location.href="auth.html";
  }
});

const db = firebase.firestore();
const codesContainer = document.getElementById("codesContainer");
const msg = document.getElementById("msg");

// Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯
async function createCode(){
  const code = document.getElementById("codeName").value.trim().toUpperCase();
  const coins = Number(document.getElementById("coins").value);
  const proDays = Number(document.getElementById("proDays").value);
  const maxUses = Number(document.getElementById("maxUses").value);
  if(!code){ msg.textContent="âŒ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ÙƒÙˆØ¯"; return; }

  try{
    const ref = db.collection("promocodes").doc(code);
    const snap = await ref.get();
    if(snap.exists){ msg.textContent="âŒ Ø§Ù„ÙƒÙˆØ¯ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§"; return; }

    await ref.set({
      coins,
      durationDays: proDays,
      maxUses: maxUses>0 ? maxUses : Infinity,
      redeemedBy: [],
      active:true,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    msg.textContent="âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ù†Ø¬Ø§Ø­";
    loadCodes();
    document.getElementById("codeName").value="";
  }catch(e){
    console.error(e);
    msg.textContent="âŒ Ø­Ø¯Ø« Ø®Ø·Ø£";
  }
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ ÙˆØ¹Ø±Ø¶Ù‡Ø§
async function loadCodes(){
  codesContainer.innerHTML="";
  const snapshot = await db.collection("promocodes").orderBy("createdAt","desc").get();
  snapshot.forEach(doc=>{
    const data = doc.data();
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <strong>${doc.id}</strong> ${data.active ? 'âœ… Ù…ÙØ¹Ù„':'â›” Ù…ÙˆÙ‚ÙˆÙ'}
      <div>
        <small>Ù†ÙˆØ¹ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©: ${data.coins>0 ? data.coins+" ÙƒÙˆÙŠÙ†Ø²" : ""} ${data.durationDays>0 ? data.durationDays+" ÙŠÙˆÙ… Pro" : ""}</small><br>
        <small>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: ${(data.redeemedBy||[]).length}</small><br>
        <small>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…: ${data.maxUses===Infinity?'ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯':data.maxUses}</small>
      </div>
      <div class="card-actions">
        <button class="toggle" onclick="toggleActive('${doc.id}', ${data.active})">${data.active ? 'ØªØ¹Ø·ÙŠÙ„':'ØªÙØ¹ÙŠÙ„'}</button>
        <button class="delete" onclick="deleteCode('${doc.id}')">Ø­Ø°Ù</button>
      </div>
    `;
    codesContainer.appendChild(card);
  });
}

async function toggleActive(codeId, currentState){
  try{
    await db.collection("promocodes").doc(codeId).update({ active: !currentState });
    msg.textContent=`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ÙƒÙˆØ¯ ${codeId}`;
    loadCodes();
  }catch(e){
    console.error(e);
    msg.textContent="âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«";
  }
}

async function deleteCode(codeId){
  if(!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¯ ${codeId}?`)) return;
  try{
    await db.collection("promocodes").doc(codeId).delete();
    msg.textContent=`âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¯ ${codeId}`;
    loadCodes();
  }catch(e){
    console.error(e);
    msg.textContent="âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù";
  }
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
loadCodes();
</script>
</body>
</html>
