<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ•µï¸ Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ø¯Ù†ÙŠ Ø§Ù„Ù…Ø­ØªØ§Ù„</title>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="auth.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght=400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        /* -------------------------------------------------- */
        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ© ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ù„ÙˆÙŠØ© */
        /* -------------------------------------------------- */
        #user-info-bar {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 15px; /* Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø¹Ù†Ø§ØµØ± */
        }

        #user-name-display {
            font-size: 1.2rem;
            font-weight: 700;
            color: #f1f5f9; /* Ù„ÙˆÙ† Ø§Ù„Ø§Ø³Ù… */
            display: flex;
            align-items: center;
        }

        #coin-display {
            font-size: 1.1rem;
            font-weight: 700;
            color: #94a3b8;
            margin-right: 15px; /* Ù„Ø¥Ø¨Ø¹Ø§Ø¯Ù‡Ø§ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø¹Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        }
        
        #pro-plans-btn {
            font-size: 24px;
            color: #ffd700; 
            cursor: pointer;
            transition: color 0.3s;
        }
        
        /* -------------------------------------------------- */
        /* Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ÙˆØ§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ù…Ø¹ ØªØ­Ø¯ÙŠØ«Ø§Øª Ø¨Ø³ÙŠØ·Ø©) */
        /* -------------------------------------------------- */
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #0f172a; 
            color: #f1f5f9; 
            text-align: center;
            padding: 20px;
            min-height: 100vh;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-top: 50px; /* Ù„ØªØ±Ùƒ Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
            margin-bottom: 30px;
            color: #34d399; 
        }

        .card {
            background-color: #1e293b; 
            padding: 30px;
            border-radius: 12px;
            max-width: 450px;
            width: 90%;
            margin: 10px auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 10px 15px rgba(0, 0, 0, 0.2);
            text-align: right;
        }

        #player-input {
            font-family: 'Cairo', sans-serif;
            width: calc(100% - 24px); 
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #334155;
            font-size: 16px;
            background-color: #334155; 
            color: #f1f5f9;
            margin-bottom: 10px;
        }

        #add-player-btn, #settings-btn-card {
            padding: 10px 20px;
            font-size: 16px;
            font-weight: 700;
            border: none;
            border-radius: 8px; 
            cursor: pointer;
            transition: background-color 0.3s;
            width: 100%;
            margin-top: 10px;
        }
        #add-player-btn {
            background-color: #34d399; 
            color: #ffffff;
        }
        #add-player-btn:hover {
            background-color: #10b981; 
        }
        #settings-btn-card { 
            background-color: #6366f1; 
            color: #ffffff;
            margin-bottom: 20px; 
        }
        #settings-btn-card:hover {
            background-color: #4f46e5;
        }

        #player-list {
            list-style: none;
            padding: 0;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
        }
        #player-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            margin-bottom: 8px;
            background-color: #334155;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .delete-btn {
            background: none;
            border: none;
            color: #ff4f4f; 
            cursor: pointer;
            font-size: 1.1rem;
            transition: color 0.3s;
        }

        #start-game-btn { 
            margin-top: 30px; 
            padding: 12px 30px;
            font-size: 18px;
            font-weight: 700;
            border: none;
            border-radius: 8px; 
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            background-color: #6366f1;
            color: #ffffff;
            width: 100%;
        }
        #start-game-btn:hover:enabled {
            background-color: #4f46e5; 
            transform: translateY(-2px);
        }
        #start-game-btn:disabled {
            background-color: #475569;
            cursor: not-allowed;
        }
        
        #sign-out-btn {
            position: absolute;
            bottom: 20px;
            right: 20px; /* ØªÙ… ØªØºÙŠÙŠØ± Ù…ÙˆØ¶Ø¹Ù‡ Ù„Ù„ÙŠÙ…ÙŠÙ† */
            background: none;
            border: none;
            color: #ff4f4f;
            cursor: pointer;
            font-size: 0.9rem;
            transition: color 0.3s;
        }

        .alert-message {
            color: #ffcc00;
            margin-top: 15px;
            font-size: 0.9rem;
        }

    </style>
</head>

<body onload="checkAuthState()">

    <div id="user-info-bar">
        <div id="user-name-display">
            Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
        </div>
        
        <div id="coin-display">
            <i class="fas fa-coins"></i> Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="total-coins-value">0</span>
        </div>
        
        <a href="plans.html" id="pro-plans-btn" title="Ø®Ø·Ø· Ø§Ù„Ø¹Ø¶ÙˆÙŠØ© Ø§Ù„Ù…ØªÙ…ÙŠØ²Ø© (Pro)">
            <i class="fas fa-crown"></i>
        </a>
    </div>

    <h1>Ø§Ø¨Ø¯Ø£ Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ø¯Ù†ÙŠ Ø§Ù„Ù…Ø­ØªØ§Ù„</h1>

    <div class="card">
        
        <button id="settings-btn-card" onclick="location.href = 'settings.html'">
            <i class="fas fa-cog"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        </button>
        
        <label for="player-input" style="font-weight: 700; color: #f1f5f9;">Ø£Ø¶Ù Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†:</label>
        
        <input type="text" id="player-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨">
        <button id="add-player-btn" onclick="addPlayer()">Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø¹Ø¨</button>

        <p style="color: #94a3b8; font-size: 0.9rem; margin-top: 15px;">ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù„Ø¯ÙŠÙƒ 3 Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.</p>
        
        <ul id="player-list">
            </ul>
        
        <div id="player-count-alert" class="alert-message" style="display: none;">
            Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø¹Ø¨ Ù‡Ùˆ 3 Ù„Ø§Ø¹Ø¨ÙŠÙ†.
        </div>

        <button id="start-game-btn" disabled onclick="saveAndStartGame()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø© <i class="fas fa-play"></i></button>

    </div>
    
    <button id="sign-out-btn" onclick="signOutUser()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ <i class="fas fa-sign-out-alt"></i></button>

<script>
    let players = []; 
    let currentUserData = {}; 
    const playerList = document.getElementById("player-list");
    const playerInput = document.getElementById("player-input");
    const startGameBtn = document.getElementById("start-game-btn"); 
    const playerCountAlert = document.getElementById("player-count-alert");
    const userNameDisplay = document.getElementById("user-name-display"); // Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯

    // ----------------------------------
    // Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙˆØ§Ù„ÙƒÙˆÙŠÙ†Ø²Ø§Øª ÙˆØ¹Ø±Ø¶Ù‡Ø§
    // ----------------------------------
    
    /**
     * @function isProUser
     * @description Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø¶ÙˆØ§Ù‹ Ù…ØªÙ…ÙŠØ²Ø§Ù‹ (Pro).
     */
    function isProUser() {
        const expiryTime = currentUserData.proExpiryTime || 0;
        // Ù†Ø¹ØªØ¨Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Pro Ø¥Ø°Ø§ ÙƒØ§Ù† ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø¨Ø§Ù„Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ©)
        return expiryTime > Date.now();
    }

    /**
     * @function checkAuthState
     * @description Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© (Auth) ÙˆØ¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….
     */
    async function checkAuthState() {
         firebase.auth().onAuthStateChanged(async (user) => {
            if (user) {
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„Ø§Ù‹ØŒ Ù†ÙØ­Ù…Ù‘Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡
                const data = await loadUserData(); 
                if (data) {
                    currentUserData = data;
                }
                
                // ğŸš¨ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ­Ø§Ù„Ø© Pro
                displayUserName(user.displayName || user.email);
                
                displayTotalCoins(); 
                await loadPlayers(); 
            } else {
                window.location.href = "auth.html";
            }
        });
    }

    /**
     * @function displayUserName
     * @description Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ¥Ø¶Ø§ÙØ© Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªØ§Ø¬ Ø¥Ø°Ø§ ÙƒØ§Ù† Pro.
     */
    function displayUserName(name) {
        const isPro = isProUser();
        const proTag = isPro 
            ? '<i class="fas fa-crown" style="color:#ffd700; margin-right: 5px;" title="Ø¹Ø¶Ùˆ Ù…ØªÙ…ÙŠØ² (Pro)"></i>'
            : '';
            
        // Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø³Ù… ÙˆØ¨Ø¬Ø§Ù†Ø¨Ù‡ Ø§Ù„ØªØ§Ø¬ Ø¥Ù† ÙˆØ¬Ø¯
        userNameDisplay.innerHTML = `${proTag} ${name}`;
    }

    /**
     * @function displayTotalCoins
     * @description ØªØ­Ù…ÙŠÙ„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙˆÙŠÙ†Ø²Ø§Øª Ù…Ù† Firestore ÙˆØ¹Ø±Ø¶Ù‡Ø§.
     */
    function displayTotalCoins() {
        document.getElementById("total-coins-value").innerText = currentUserData.totalCoins || 0;
    }
    
    // ----------------------------------
    // Ù…Ù†Ø·Ù‚ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† (ÙŠØ³ØªØ®Ø¯Ù… Firestore)
    // ----------------------------------
    
    function renderPlayers() {
        playerList.innerHTML = '';
        players.forEach((player, index) => {
            const li = document.createElement('li');
            li.innerHTML = `
                <span>${player}</span>
                <button class="delete-btn" onclick="removePlayer(${index})"><i class="fas fa-trash"></i></button>
            `;
            playerList.appendChild(li);
        });
        
        if (players.length >= 3) {
            startGameBtn.disabled = false;
            playerCountAlert.style.display = 'none';
        } else {
            startGameBtn.disabled = true;
            playerCountAlert.style.display = 'block';
        }
    }

    async function savePlayersToFirestore() {
        const user = firebase.auth().currentUser;
        if (!user) return; // ØªÙˆÙ‚Ù Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        
        // ÙŠØ¬Ø¨ Ø£Ù† Ù†Ø±Ø³Ù„ Ø§Ù„ÙƒÙˆÙŠÙ†Ø² ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£ÙŠØ¶Ø§Ù‹ Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„ÙŠÙ‡Ø§
        await saveUserData(
            currentUserData.totalCoins || 0,
            currentUserData.proExpiryTime || 0,
            players, 
            currentUserData.settings || {} 
        );
        currentUserData.players = players;
    }

    async function addPlayer() {
        const playerName = playerInput.value.trim();
        if (playerName && playerName.length > 0 && !players.includes(playerName)) {
            players.push(playerName);
            playerInput.value = '';
            renderPlayers();
            await savePlayersToFirestore(); 
        } else if (players.includes(playerName)) {
            alert("Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„!");
        } else if (playerName.length === 0) {
             alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨.");
        }
    }
    
    async function removePlayer(index) {
        players.splice(index, 1);
        renderPlayers();
        await savePlayersToFirestore(); 
    }
    
    async function loadPlayers() {
        const savedPlayers = currentUserData.players;
        if (Array.isArray(savedPlayers)) {
            players = savedPlayers;
        } else {
            players = [];
        }
        renderPlayers();
    }
    
    async function saveAndStartGame() {
        if (players.length < 3) {
            alert("ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© 3 Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù‚Ø¨Ù„ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©.");
            return;
        }
        
        await savePlayersToFirestore(); 
        
        localStorage.setItem("players", JSON.stringify(players)); 
        
        location.href = "game.html"; 
    }

    playerInput.addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
            event.preventDefault();
            addPlayer();
        }
    });
    
    /**
     * @function signOutUser
     * @description ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Firebase.
     */
    function signOutUser() {
        if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) {
            firebase.auth().signOut().then(() => {
                // Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙˆØ§Ù„ØªÙˆØ¬ÙŠÙ‡
                localStorage.clear();
                window.location.href = "auth.html";
            }).catch((error) => {
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬: " + error.message);
            });
        }
    }

</script>

</body>
</html>

