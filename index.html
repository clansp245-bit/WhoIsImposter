<!DOCTYPE html>  
<html lang="ar" dir="rtl">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>ğŸ•µï¸ Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ø¯Ù†ÙŠ Ø§Ù„Ù…Ø­ØªØ§Ù„ - Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</title>  
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>  
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>  
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>  
    <script src="auth.js"></script>  
  
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">  
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">  

<style>  
    :root {
        --primary: #6366f1;
        --primary-dark: #4f46e5;
        --accent-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
        --bg-body: #0a0f1e;
        --card-bg: rgba(30, 41, 59, 0.7);
        --text-main: #f1f5f9;
        --text-dim: #94a3b8;
    }

    body {  
        font-family: 'Cairo', sans-serif;  
        background-color: var(--bg-body);
        background-image: 
            radial-gradient(circle at top right, #1e1b4b, transparent),
            radial-gradient(circle at bottom left, #1e1b4b, transparent);
        color: var(--text-main);  
        text-align: center;  
        margin: 0;  
        min-height: 100vh;  
        display: flex;  
        flex-direction: column;  
        align-items: center;  
    }  

    /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ Ù…ØªÙ†Ø§Ø³Ù‚ Ù…Ø¹ ØµÙØ­Ø© Ø§Ù„Ù„Ø¹Ø¨ */
    .top-bar { 
        width: 100%; 
        padding: 15px 25px; 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        background: rgba(30, 41, 59, 0.5); 
        backdrop-filter: blur(10px);
        box-sizing: border-box;
    }

    .top-icons { display: flex; gap: 20px; font-size: 1.3rem; }
    #pro-link { color: #ffd700; text-decoration: none; }
    #gift-link { color: #34d399; text-decoration: none; }
    #coin-display { color: #fbbf24; font-weight: bold; }

    /* Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
    .profile-section {
        margin-top: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
    }

    #user-name-display { 
        font-size: 1.8rem; 
        font-weight: 900; 
        background: var(--accent-gradient); 
        -webkit-background-clip: text; 
        -webkit-text-fill-color: transparent;
        text-decoration: none;
        margin-bottom: 5px;
    }

    .level-container {
        font-weight: 700;
        color: var(--text-dim);
        font-size: 0.9rem;
    }

    #xp-bar-container { 
        width: 250px; 
        height: 8px; 
        background: rgba(255,255,255,0.1); 
        border-radius: 10px; 
        margin: 10px auto; 
        overflow: hidden; 
    }
    #xp-bar { 
        height: 100%; 
        width: 0%; 
        background: var(--accent-gradient); 
        transition: width 0.5s ease; 
    }

    h1 { font-weight: 900; letter-spacing: -1px; margin: 20px 0; font-size: 2.2rem; }

    /* Ø§Ù„ÙƒØ§Ø±Øª Ø§Ù„Ø²Ø¬Ø§Ø¬ÙŠ */
    .main-card { 
        background: var(--card-bg); 
        backdrop-filter: blur(15px);
        padding: 30px; 
        border-radius: 30px; 
        width: 90%; 
        max-width: 450px; 
        border: 1px solid rgba(255,255,255,0.1);
        box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        box-sizing: border-box;
    }

    /* Ø´Ø¨ÙƒØ© Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
    .action-grid { 
        display: grid; 
        grid-template-columns: 1fr 1fr; 
        gap: 12px; 
        margin-bottom: 25px; 
    }
    
    .nav-btn { 
        padding: 15px 10px; 
        border-radius: 18px; 
        border: none; 
        color: white; 
        font-weight: 700; 
        cursor: pointer; 
        transition: 0.3s; 
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        gap: 8px;
        font-size: 0.9rem;
        background: rgba(255,255,255,0.05);
    }
    .nav-btn i { font-size: 1.4rem; }
    .nav-btn:hover { background: var(--primary); transform: translateY(-3px); }

    /* Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª */
    .input-group { text-align: right; margin-top: 20px; }
    #player-input { 
        width: 100%; 
        padding: 15px; 
        border-radius: 15px; 
        border: 1px solid rgba(255,255,255,0.1); 
        background: rgba(15, 23, 42, 0.6); 
        color: white; 
        font-family: 'Cairo';
        box-sizing: border-box;
        margin-bottom: 10px;
    }

    #add-player-btn { 
        width: 100%; 
        padding: 12px; 
        border-radius: 15px; 
        background: var(--primary); 
        color: white; 
        border: none; 
        font-weight: 700;
        cursor: pointer;
    }

    /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† */
    #player-list { 
        list-style: none; padding: 0; margin-top: 15px; 
        max-height: 180px; overflow-y: auto;
    }
    #player-list li { 
        background: rgba(255,255,255,0.03); 
        margin-bottom: 8px; 
        padding: 12px 15px; 
        border-radius: 12px; 
        display: flex; 
        justify-content: space-between; 
        align-items: center;
    }
    .player-name-text { font-weight: 700; color: var(--text-main); }
    .delete-btn { color: #ef4444; cursor: pointer; border: none; background: none; }

    /* Ø²Ø± Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ÙƒØ¨ÙŠØ± */
    #start-game-btn { 
        margin-top: 20px; 
        width: 100%; 
        padding: 20px; 
        border-radius: 20px; 
        background: var(--accent-gradient); 
        color: white; 
        font-weight: 900; 
        font-size: 1.3rem;
        border: none; 
        cursor: pointer;
        box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);
    }
    #start-game-btn:disabled { opacity: 0.3; cursor: not-allowed; transform: none; box-shadow: none; }

    #sign-out-btn { margin: 30px 0; color: #ef4444; background: none; border: none; cursor: pointer; font-family: 'Cairo'; }

    /* Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„ÙˆØ§Ø±Ø¯Ø© */
    #incoming-gifts-overlay { 
        position: fixed; inset: 0; background: rgba(0,0,0,0.8); 
        display: none; justify-content: center; align-items: center; z-index: 100; 
    }
    .gift-modal { 
        background: #1e293b; padding: 30px; border-radius: 30px; 
        width: 320px; border: 2px solid var(--primary);
    }
</style>
</head>  

<body onload="checkAuthState()">  

<div class="top-bar">
    <div class="top-icons">
        <a href="plans.html" id="pro-link"><i class="fas fa-crown"></i></a>
        <a href="gifts.html" id="gift-link"><i class="fas fa-gift"></i></a>
    </div>
    <div id="coin-display"><i class="fas fa-coins"></i> <span id="total-coins-value">0</span></div>
</div>

<div class="profile-section">
    <a href="profile.html" id="user-name-display">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</a>
    <div class="level-container">
        Ø§Ù„Ù…Ø³ØªÙˆÙ‰ <span id="user-level">1</span> â€¢ <span id="user-xp">0</span> XP
    </div>
    <div id="xp-bar-container"><div id="xp-bar"></div></div>
</div>

<h1>Ø§Ù„Ù…Ù€Ø¯Ù†ÙŠ Ø§Ù„Ù…Ø­ØªÙ€Ø§Ù„</h1>  

<div class="main-card">  
    <div class="action-grid">
        <button class="nav-btn" onclick="location.href='leaderboard.html'"><i class="fas fa-trophy" style="color:#f59e0b"></i>Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†</button>
        <button class="nav-btn" onclick="location.href='friends.html'"><i class="fas fa-user-friends" style="color:#10b981"></i>Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</button>
        <button class="nav-btn" onclick="location.href='settings.html'"><i class="fas fa-cog" style="color:#94a3b8"></i>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
        <button class="nav-btn" onclick="location.href='online.html'"><i class="fas fa-globe" style="color:#6366f1"></i>Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</button>
    </div>

    <div class="input-group">
        <label style="font-weight: 700; margin-right: 5px;">Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù…Ø­Ù„ÙŠÙŠÙ†:</label>  
        <input type="text" id="player-input" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù‡Ù†Ø§...">  
        <button id="add-player-btn" onclick="addPlayer()">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© <i class="fas fa-user-plus"></i></button>  
    </div>

    <ul id="player-list"></ul>  
    <div id="player-count-alert" style="color:#ef4444; font-size:0.85rem; margin-top:10px; display:none; font-weight:700;">âš ï¸ Ù†Ø­ØªØ§Ø¬ 3 Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø¨Ø¯Ø¡</div>

    <button id="start-game-btn" disabled onclick="saveAndStartGame()">Ø¥Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø¢Ù† <i class="fas fa-play-circle"></i></button>  
</div>  
  
<button id="sign-out-btn" onclick="signOutUser()"><i class="fas fa-sign-out-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>

<div id="incoming-gifts-overlay">
    <div class="gift-modal">
        <h2 style="color:#fbbf24">ğŸ‰ Ù‡Ø¯Ø§ÙŠØ§ Ø¬Ø¯ÙŠØ¯Ø©!</h2>
        <div id="new-gifts-list"></div>
        <button id="add-player-btn" style="margin-top:20px" onclick="clearNewGifts()">ÙØªØ­ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§</button>
    </div>
</div>

<script>  
    let players = [];   
    let currentUserData = {};   

    async function checkAuthState() {  
         firebase.auth().onAuthStateChanged(async (user) => {  
            if (user) {  
                let data = await loadUserData();   
                if (data) {  
                    currentUserData = data;
                    document.getElementById("total-coins-value").innerText = data.totalCoins || 0;
                    document.getElementById("user-name-display").innerText = data.displayName || "Ù„Ø§Ø¹Ø¨";
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª
                    const level = data.level || 1;
                    const xp = data.xp || 0;
                    const required = level * 100; 
                    document.getElementById("user-level").innerText = level;
                    document.getElementById("user-xp").innerText = xp;
                    document.getElementById("xp-bar").style.width = Math.min((xp/required)*100, 100) + "%";

                    if (data.newGifts?.length > 0) displayIncomingGifts(data.newGifts);
                    
                    players = data.players || [];
                    renderPlayers();   
                }  
            } else { window.location.href = "auth.html"; }  
        });  
    }  

    function renderPlayers() {  
        const list = document.getElementById("player-list");
        list.innerHTML = '';  
        players.forEach((p, i) => {  
            list.innerHTML += `<li><span class="player-name-text">${p}</span><i class="fas fa-times delete-btn" onclick="removePlayer(${i})"></i></li>`;
        });  
        const canStart = players.length >= 3;
        document.getElementById("start-game-btn").disabled = !canStart;
        document.getElementById("player-count-alert").style.display = canStart ? 'none' : 'block';
    }  

    async function addPlayer() {  
        const input = document.getElementById("player-input");
        const name = input.value.trim();  
        if (name && !players.includes(name)) {  
            players.push(name);  
            input.value = '';  
            renderPlayers();  
            await syncPlayers();
        }  
    }  

    async function removePlayer(index) {  
        players.splice(index, 1);  
        renderPlayers();  
        await syncPlayers();
    }  

    async function syncPlayers() {
        const user = firebase.auth().currentUser;
        if (user) await firebase.firestore().collection("users").doc(user.uid).update({ players: players });
    }

    function saveAndStartGame() {  
        localStorage.setItem("players", JSON.stringify(players));   
        location.href = "game.html";   
    }  

    function signOutUser() {  
        if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) firebase.auth().signOut().then(() => location.href = "auth.html");  
    }

    function displayIncomingGifts(gifts) {
        const list = document.getElementById("new-gifts-list");
        list.innerHTML = gifts.map(g => `<div style="margin-bottom:10px; font-size:0.9rem;">ğŸ ${g.giftName} Ù…Ù† <b>${g.senderName}</b></div>`).join('');
        document.getElementById("incoming-gifts-overlay").style.display = 'flex';
    }

    async function clearNewGifts() {
        document.getElementById("incoming-gifts-overlay").style.display = 'none';
        const user = firebase.auth().currentUser;
        if (user) await firebase.firestore().collection("users").doc(user.uid).update({ newGifts: [] });
    }
</script>  
</body>  
</html>
