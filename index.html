<!DOCTYPE html>  
<html lang="ar" dir="rtl">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>ğŸ•µï¸ Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ø¯Ù†ÙŠ Ø§Ù„Ù…Ø­ØªØ§Ù„ - Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</title>  
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>  
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>  
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>  
    <script src="auth.js"></script>  
  
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">  
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">  

<style>  
    :root {
        --primary: #6366f1;
        --accent-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
        --bg-body: #0a0f1e;
        --card-bg: rgba(30, 41, 59, 0.7);
        --text-main: #f1f5f9;
        --text-dim: #94a3b8;
        --gold: #ffd700;
        --season-color: #f43f5e;
    }

    body {  
        font-family: 'Cairo', sans-serif;  
        background-color: var(--bg-body);
        background-image: radial-gradient(circle at top right, #1e1b4b, transparent), radial-gradient(circle at bottom left, #1e1b4b, transparent);
        color: var(--text-main);  
        text-align: center;  
        margin: 0;  
        min-height: 100vh;  
        display: flex;  
        flex-direction: column;  
        align-items: center;  
    }  

    .top-bar { 
        width: 100%; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; 
        background: rgba(30, 41, 59, 0.5); backdrop-filter: blur(10px); box-sizing: border-box;
    }

    .top-icons { display: flex; gap: 20px; font-size: 1.3rem; }
    #pro-link { color: var(--gold); text-decoration: none; }
    #gift-link { color: #34d399; text-decoration: none; }
    #coin-display { color: #fbbf24; font-weight: bold; }

    .profile-section { margin-top: 20px; width: 100%; display: flex; flex-direction: column; align-items: center; }
    #user-name-display { 
        font-size: 1.8rem; font-weight: 900; color: white; text-decoration: none; display: flex; align-items: center; gap: 8px;
    }
    .crown-icon { color: var(--gold); text-shadow: 0 0 10px rgba(255, 215, 0, 0.5); font-size: 1.4rem; }

    .level-container { font-weight: 700; color: var(--text-dim); font-size: 0.9rem; margin-top: 5px; }
    
    #xp-bar-container { width: 250px; height: 8px; background: rgba(255,255,255,0.1); border-radius: 10px; margin: 8px auto 4px auto; overflow: hidden; }
    #xp-bar { height: 100%; width: 0%; background: var(--accent-gradient); transition: width 0.8s ease; }
    #xp-remaining { font-size: 0.75rem; color: var(--text-dim); font-weight: 600; }

    h1 { font-weight: 900; margin: 25px 0 15px 0; font-size: 2.2rem; background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

    .main-card { 
        background: var(--card-bg); backdrop-filter: blur(15px); padding: 25px; border-radius: 30px; 
        width: 90%; max-width: 450px; border: 1px solid rgba(255,255,255,0.1); box-sizing: border-box;
    }

    .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 25px; }
    .nav-btn { 
        padding: 15px 10px; border-radius: 18px; border: none; color: white; font-weight: 700; cursor: pointer; transition: 0.3s; 
        display: flex; flex-direction: column; align-items: center; gap: 8px; font-size: 0.85rem; background: rgba(255,255,255,0.05);
    }
    .nav-btn i { font-size: 1.4rem; }
    .nav-btn:hover { background: rgba(255,255,255,0.1); transform: translateY(-3px); }
    
    /* Ø³ØªØ§ÙŠÙ„ Ø²Ø± Ø§Ù„Ø³ÙŠØ²ÙˆÙ† Ø¨Ø§Ø³ Ø§Ù„Ø®Ø§Øµ */
    .btn-season { border: 1px solid rgba(244, 63, 94, 0.3); background: rgba(244, 63, 94, 0.05); }

    #player-input { 
        width: 100%; padding: 15px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1); 
        background: rgba(15, 23, 42, 0.6); color: white; font-family: 'Cairo'; box-sizing: border-box; margin-bottom: 10px;
    }
    #add-player-btn { width: 100%; padding: 12px; border-radius: 15px; background: var(--primary); color: white; border: none; font-weight: 700; cursor: pointer; }

    #player-list { list-style: none; padding: 0; margin-top: 15px; max-height: 160px; overflow-y: auto; }
    #player-list li { 
        background: rgba(255,255,255,0.03); margin-bottom: 8px; padding: 10px 15px; border-radius: 12px; 
        display: flex; justify-content: space-between; align-items: center;
    }
    .delete-btn { color: #ef4444; cursor: pointer; border: none; background: none; }

    #start-game-btn { 
        margin-top: 20px; width: 100%; padding: 18px; border-radius: 20px; background: var(--accent-gradient); 
        color: white; font-weight: 900; font-size: 1.2rem; border: none; cursor: pointer;
    }
    #start-game-btn:disabled { opacity: 0.3; cursor: not-allowed; }

    #sign-out-btn { margin: 30px 0; color: #ef4444; background: none; border: none; cursor: pointer; font-family: 'Cairo'; }
    
    #incoming-gifts-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 100; }
    .gift-modal { background: #1e293b; padding: 30px; border-radius: 30px; width: 320px; border: 2px solid var(--primary); text-align: center;}
</style>
</head>  

<body onload="checkAuthState()">  

<div class="top-bar">
    <div class="top-icons">
        <a href="plans.html" id="pro-link"><i class="fas fa-crown"></i></a>
        <a href="gifts.html" id="gift-link"><i class="fas fa-gift"></i></a>
    </div>
    <div id="coin-display"><i class="fas fa-coins"></i> <span id="total-coins-value">0</span></div>
</div>

<div class="profile-section">
    <a href="profile.html" id="user-name-display">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</a>
    <div class="level-container">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ <span id="user-level">1</span></div>
    <div id="xp-bar-container"><div id="xp-bar"></div></div>
    <div id="xp-remaining">Ø¬Ø§Ø±ÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø®Ø¨Ø±Ø©...</div>
</div>

<h1>Ø§Ù„Ù…Ù€Ø¯Ù†ÙŠ Ø§Ù„Ù…Ø­ØªÙ€Ø§Ù„</h1>  

<div class="main-card">  
    <div class="action-grid">
        <button class="nav-btn" onclick="location.href='leaderboard.html'"><i class="fas fa-trophy" style="color:#f59e0b"></i>Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†</button>
        <button class="nav-btn" onclick="location.href='friends.html'"><i class="fas fa-user-friends" style="color:#10b981"></i>Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</button>
        <button class="nav-btn" onclick="location.href='settings.html'"><i class="fas fa-cog" style="color:#94a3b8"></i>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
        <button class="nav-btn" onclick="location.href='online.html'"><i class="fas fa-globe" style="color:#6366f1"></i>Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</button>
        <button class="nav-btn btn-season" onclick="location.href='seasonpass.html'"><i class="fas fa-star" style="color:var(--season-color)"></i>Ø³ÙŠØ²ÙˆÙ† Ø¨Ø§Ø³</button>
        <button class="nav-btn" onclick="alert('Ù‚Ø±ÙŠØ¨Ø§Ù‹!')"><i class="fas fa-store" style="color:#a855f7"></i>Ø§Ù„Ù…ØªØ¬Ø±</button>
    </div>

    <div style="text-align: right;">
        <input type="text" id="player-input" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù‡Ù†Ø§...">  
        <button id="add-player-btn" onclick="addPlayer()">Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø¹Ø¨ <i class="fas fa-plus-circle"></i></button>  
    </div>

    <ul id="player-list"></ul>  
    <div id="player-count-alert" style="color:#ef4444; font-size:0.8rem; margin-top:10px; display:none; font-weight:700;">âš ï¸ Ø£Ø¶Ù 3 Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø¨Ø¯Ø¡</div>

    <button id="start-game-btn" disabled onclick="saveAndStartGame()">Ø¥Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø¢Ù† <i class="fas fa-play"></i></button>  
</div>  
  
<button id="sign-out-btn" onclick="signOutUser()"><i class="fas fa-sign-out-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>

<div id="incoming-gifts-overlay">
    <div class="gift-modal">
        <h2 style="color:#fbbf24">ğŸ‰ Ù‡Ø¯Ø§ÙŠØ§ Ø¬Ø¯ÙŠØ¯Ø©!</h2>
        <div id="new-gifts-list" style="margin:15px 0;"></div>
        <button id="add-player-btn" onclick="clearNewGifts()">Ø§Ø³ØªÙ„Ø§Ù…</button>
    </div>
</div>

<script>  
    let players = [];   
    let currentUserData = {};   

    function getLevelData(totalXP) {
        const xp = Math.max(0, totalXP);
        let level = 1;
        let currentLevelXPStart = 0;
        
        while (xp >= currentLevelXPStart + (level * 100)) {
            currentLevelXPStart += (level * 100);
            level++;
        }
        
        const xpInCurrentLevel = xp - currentLevelXPStart;
        const targetXPForNextLevel = level * 100;
        const percentage = (xpInCurrentLevel / targetXPForNextLevel) * 100;

        return {
            level: level,
            xpInLevel: xpInCurrentLevel,
            targetXP: targetXPForNextLevel,
            percent: Math.min(percentage, 100)
        };
    }

    async function checkAuthState() {  
         firebase.auth().onAuthStateChanged(async (user) => {  
            if (user) {  
                let data = await loadUserData();   
                if (data) {
                    if (data.xp < 0) {
                        await firebase.firestore().collection("users").doc(user.uid).update({ xp: 0 });
                        data.xp = 0;
                    }
                    
                    currentUserData = data;
                    document.getElementById("total-coins-value").innerText = (data.totalCoins || 0).toLocaleString();
                    
                    const isPro = data.proExpiryTime > Date.now();
                    const nameToDisplay = data.displayName || "Ù„Ø§Ø¹Ø¨";
                    document.getElementById("user-name-display").innerHTML = 
                        `${isPro ? '<i class="fas fa-crown crown-icon"></i>' : ''} ${nameToDisplay}`;

                    updateXPUI(data.xp || 0);

                    if (data.newGifts?.length > 0) displayIncomingGifts(data.newGifts);
                    
                    players = data.players || [];
                    renderPlayers();   
                }  
            } else { window.location.href = "auth.html"; }  
        });  
    }  

    function updateXPUI(xpValue) {
        const lv = getLevelData(xpValue);
        
        document.getElementById("user-level").innerText = lv.level;
        document.getElementById("xp-bar").style.width = lv.percent + "%";
        
        const remaining = lv.targetXP - lv.xpInLevel;
        document.getElementById("xp-remaining").innerText = `Ù…ØªØ¨Ù‚ÙŠ ${remaining} XP Ù„Ù„Ù…Ø³ØªÙˆÙ‰ ${lv.level + 1}`;
        
        // --- Ù†Ø¸Ø§Ù… Ù…ÙƒØ§ÙØ¢Øª ØµØ¹ÙˆØ¯ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ---
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­Ø³ÙˆØ¨
        if (currentUserData.level && lv.level > currentUserData.level) {
            handleLevelUpReward(lv.level);
        } else if (!currentUserData.level) {
            // Ù„Ø£ÙˆÙ„ Ù…Ø±Ø© ÙÙ‚Ø· Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ
            syncLevelOnly(lv.level);
        }
    }

    async function handleLevelUpReward(newLevel) {
        const user = firebase.auth().currentUser;
        if (user) {
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©: Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¬Ø¯ÙŠØ¯ * 100 ÙƒÙˆÙŠÙ†Ø²
            const reward = newLevel * 100;
            const newTotalCoins = (currentUserData.totalCoins || 0) + reward;
            
            await firebase.firestore().collection("users").doc(user.uid).update({ 
                level: newLevel,
                totalCoins: newTotalCoins
            });
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
            currentUserData.level = newLevel;
            currentUserData.totalCoins = newTotalCoins;
            document.getElementById("total-coins-value").innerText = newTotalCoins.toLocaleString();
            
            alert(`ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! ÙˆØµÙ„Øª Ù„Ù„Ù…Ø³ØªÙˆÙ‰ ${newLevel} ÙˆØ­ØµÙ„Øª Ø¹Ù„Ù‰ ${reward} ÙƒÙˆÙŠÙ†Ø² Ù…ÙƒØ§ÙØ£Ø©!`);
        }
    }

    async function syncLevelOnly(newLevel) {
        const user = firebase.auth().currentUser;
        if (user) {
            await firebase.firestore().collection("users").doc(user.uid).update({ level: newLevel });
            currentUserData.level = newLevel;
        }
    }

    function renderPlayers() {  
        const list = document.getElementById("player-list");
        list.innerHTML = '';  
        players.forEach((p, i) => {  
            list.innerHTML += `<li><span style="font-weight:700;">${p}</span><i class="fas fa-trash delete-btn" onclick="removePlayer(${i})"></i></li>`;
        });  
        const canStart = players.length >= 3;
        document.getElementById("start-game-btn").disabled = !canStart;
        document.getElementById("player-count-alert").style.display = canStart ? 'none' : 'block';
    }  

    async function addPlayer() {  
        const input = document.getElementById("player-input");
        const name = input.value.trim();  
        if (name && !players.includes(name)) {  
            players.push(name);  
            input.value = '';  
            renderPlayers();  
            await syncPlayers();
        }  
    }  

    async function removePlayer(index) {  
        players.splice(index, 1);  
        renderPlayers();  
        await syncPlayers();
    }  

    async function syncPlayers() {
        const user = firebase.auth().currentUser;
        if (user) await firebase.firestore().collection("users").doc(user.uid).update({ players: players });
    }

    function saveAndStartGame() {  
        localStorage.setItem("players", JSON.stringify(players));   
        location.href = "game.html";   
    }  

    function signOutUser() {  
        if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) firebase.auth().signOut().then(() => location.href = "auth.html");  
    }

    function displayIncomingGifts(gifts) {
        const list = document.getElementById("new-gifts-list");
        list.innerHTML = gifts.map(g => `<div style="padding:8px; background:rgba(255,255,255,0.05); border-radius:10px; margin-bottom:5px;">ğŸ ${g.giftName} Ù…Ù† <b>${g.senderName}</b></div>`).join('');
        document.getElementById("incoming-gifts-overlay").style.display = 'flex';
    }

    async function clearNewGifts() {
        document.getElementById("incoming-gifts-overlay").style.display = 'none';
        const user = firebase.auth().currentUser;
        if (user) await firebase.firestore().collection("users").doc(user.uid).update({ newGifts: [] });
    }
</script>  
</body>  
</html>
