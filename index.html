<!DOCTYPE html>  
<html lang="ar" dir="rtl">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>ğŸ•µï¸ Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ø¯Ù†ÙŠ Ø§Ù„Ù…Ø­ØªØ§Ù„</title>  
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>  
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>  
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>  
    <script src="auth.js"></script>  
  
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">  
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">  

<style>  
    body {  
        font-family: 'Cairo', sans-serif;  
        background-color: #0f172a;   
        color: #f1f5f9;   
        text-align: center;  
        padding: 20px;  
        min-height: 100vh;  
        margin: 0;  
        display: flex;  
        flex-direction: column;  
        align-items: center;  
        position: relative;   
    }  

    /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ */
    #pro-plans-btn { position: absolute; top: 20px; left: 20px; font-size: 24px; color: #ffd700; cursor: pointer; transition: color 0.3s; }
    #gifts-btn { position: absolute; top: 20px; right: 150px; font-size: 24px; color: #34d399; cursor: pointer; transition: color 0.3s; }
    #coin-display { position: absolute; top: 20px; right: 20px; font-size: 1.1rem; font-weight: 700; color: #94a3b8; }

    /* Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ ÙˆØ§Ù„Ù…Ø³ØªÙˆÙ‰ */
    #user-name-display { font-size: 1.5rem; font-weight: 700; color: #34d399; margin-top: 50px; margin-bottom: 5px; display: flex; align-items: center; justify-content: center; text-decoration: none; cursor: pointer; }
    #user-name-display .pro-tag { color: #ffd700; margin-right: 8px; font-size: 1.2em; }
    #level-xp-display { color:#94a3b8; font-size:0.9rem; margin-bottom: 5px; font-weight: 700; }

    /* Ø´Ø±ÙŠØ· Ø§Ù„Ø®Ø¨Ø±Ø© */
    #xp-bar-container { width: 90%; max-width: 450px; height: 12px; background-color: #334155; border-radius: 6px; margin: 10px auto; overflow: hidden; }
    #xp-bar { height: 100%; width: 0%; background-color: #6366f1; border-radius: 6px; transition: width 0.5s ease-in-out; }
    #xp-next-level-info { color: #94a3b8; font-size: 0.8rem; font-weight: 700; margin-bottom: 25px; }

    .card { background-color: #1e293b; padding: 25px; border-radius: 12px; max-width: 450px; width: 90%; margin: 10px auto; box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2); text-align: right; }

    /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ù„ÙˆÙŠØ© ÙÙŠ Ø§Ù„ÙƒØ§Ø±Ø¯ */
    .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
    .nav-btn { padding: 10px; font-size: 0.9rem; font-weight: 700; border: none; border-radius: 8px; cursor: pointer; color: white; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-leaderboard { background-color: #f59e0b; }
    .btn-friends { background-color: #10b981; }
    .btn-settings { background-color: #6366f1; }
    .btn-online { background-color: #8b5cf6; }

    #player-input { font-family: 'Cairo', sans-serif; width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #334155; font-size: 16px; background-color: #334155; color: #f1f5f9; margin-bottom: 10px; box-sizing: border-box; }
    #add-player-btn { padding: 12px; font-size: 16px; font-weight: 700; border: none; border-radius: 8px; cursor: pointer; width: 100%; background-color: #34d399; color: white; }

    /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† - Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø·ÙˆÙŠÙ„ */
    #player-list { list-style: none; padding: 0; margin-top: 20px; max-height: 200px; overflow-y: auto; }
    #player-list li { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; margin-bottom: 8px; background-color: #334155; border-radius: 8px; }
    .player-name-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 70%; font-weight: bold; }
    .delete-btn { background: none; border: none; color: #ff4f4f; cursor: pointer; font-size: 1.1rem; }

    #start-game-btn { margin-top: 20px; padding: 15px; font-size: 18px; font-weight: 700; border: none; border-radius: 8px; cursor: pointer; transition: 0.3s; background-color: #6366f1; color: white; width: 100%; }
    #start-game-btn:disabled { background-color: #475569; cursor: not-allowed; }
    #sign-out-btn { position: absolute; bottom: 20px; right: 20px; background: none; border: none; color: #ff4f4f; cursor: pointer; font-size: 0.9rem; }

    /* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ */
    #incoming-gifts-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
    #gifts-modal { background: #1e293b; padding: 30px; border-radius: 15px; width: 350px; text-align: center; border: 2px solid #ffd700; }
</style>
</head>  

<body onload="checkAuthState()">  

<a href="plans.html" id="pro-plans-btn" title="Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ"><i class="fas fa-crown"></i></a>  
<a href="gifts.html" id="gifts-btn" title="Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§"><i class="fas fa-gift"></i></a>
  
<div id="coin-display"><i class="fas fa-coins"></i> ÙƒÙˆÙŠÙ†Ø²: <span id="total-coins-value">0</span></div>  

<a href="profile.html" id="user-name-display">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</a>  
<div id="level-xp-display">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ <span id="user-level">1</span> | <span id="user-xp">0</span> XP</div>  

<div id="xp-bar-container"><div id="xp-bar"></div></div>
<div id="xp-next-level-info">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>

<h1>Ø§Ù„Ù…Ø¯Ù†ÙŠ Ø§Ù„Ù…Ø­ØªØ§Ù„</h1>  

<div class="card">  
    <div class="action-grid">
        <button class="nav-btn btn-leaderboard" onclick="location.href='leaderboard.html'"><i class="fas fa-trophy"></i> Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†</button>
        <button class="nav-btn btn-friends" onclick="location.href='friends.html'"><i class="fas fa-user-plus"></i> Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</button>
        <button class="nav-btn btn-settings" onclick="location.href='settings.html'"><i class="fas fa-cog"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
        <button class="nav-btn btn-online" onclick="location.href='online.html'"><i class="fas fa-globe"></i> Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</button>
    </div>

    <label style="font-weight: 700;">Ø£Ø¶Ù Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†:</label>  
    <input type="text" id="player-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨">  
    <button id="add-player-btn" onclick="addPlayer()">Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø¹Ø¨ <i class="fas fa-plus"></i></button>  

    <ul id="player-list"></ul>  
      
    <div id="player-count-alert" style="color:#ff4f4f; font-size:0.8rem; margin-top:10px; display:none;">ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© 3 Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„!</div>

    <button id="start-game-btn" disabled onclick="saveAndStartGame()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø© <i class="fas fa-play"></i></button>  
</div>  
  
<button id="sign-out-btn" onclick="signOutUser()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ <i class="fas fa-sign-out-alt"></i></button>

<div id="incoming-gifts-overlay">
    <div id="gifts-modal">
        <h2>ğŸ‰ Ù‡Ø¯Ø§ÙŠØ§ Ø¬Ø¯ÙŠØ¯Ø©!</h2>
        <div id="new-gifts-list"></div>
        <button id="add-player-btn" style="margin-top:20px" onclick="clearNewGifts()">Ø´ÙƒØ±Ø§Ù‹!</button>
    </div>
</div>

<script>  
    let players = [];   
    let currentUserData = {};   
    const playerList = document.getElementById("player-list");  
    const playerInput = document.getElementById("player-input");  
    const startGameBtn = document.getElementById("start-game-btn");   
    const userNameDisplay = document.getElementById("user-name-display");   
  
    async function checkAuthState() {  
         firebase.auth().onAuthStateChanged(async (user) => {  
            if (user) {  
                let data = await loadUserData();   
                if (data) {  
                    currentUserData = data;
                    if (currentUserData.newGifts?.length > 0) displayIncomingGifts(currentUserData.newGifts);
                    
                    if (typeof checkAndLevelUp === 'function') await checkAndLevelUp(currentUserData);
                    
                    const nameToDisplay = currentUserData.displayName || user.email.split('@')[0];
                    userNameDisplay.innerHTML = `${currentUserData.proExpiryTime > Date.now() ? '<i class="fas fa-crown pro-tag"></i>' : ''} ${nameToDisplay}`; 
                  
                    document.getElementById("total-coins-value").innerText = currentUserData.totalCoins || 0;
                    displayLevelAndXP();   
                    players = currentUserData.players || [];
                    renderPlayers();   
                }  
            } else { window.location.href = "auth.html"; }  
        });  
    }  

    function displayLevelAndXP() {  
        const level = currentUserData.level || 1;  
        const xp = currentUserData.xp || 0;
        let required = (typeof getRequiredXPForLevel === 'function') ? getRequiredXPForLevel(level) : (level * 100);
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù€ XP Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ù„Ù…Ø³ØªÙˆÙ‰
        let currentLevelXP = xp; 
        // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¯Ø§Ù„Ø© ÙÙŠ auth.js ØªØ­Ø³Ø¨ Ø§Ù„Ù€ XP Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠØŒ ÙŠÙØ¶Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù‡Ù†Ø§.
        
        const percent = Math.min((currentLevelXP / required) * 100, 100);
        document.getElementById("user-level").innerText = level;  
        document.getElementById("user-xp").innerText = xp;
        document.getElementById("xp-bar").style.width = percent + "%";
        document.getElementById("xp-next-level-info").innerHTML = `Ù…ØªØ¨Ù‚ÙŠ ${required - currentLevelXP} XP Ù„Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ§Ù„ÙŠ`;
    }

    function renderPlayers() {  
        playerList.innerHTML = '';  
        players.forEach((player, index) => {  
            const li = document.createElement('li');  
            li.innerHTML = `  
                <span class="player-name-text">${player}</span>  
                <button class="delete-btn" onclick="removePlayer(${index})"><i class="fas fa-trash"></i></button>  
            `;  
            playerList.appendChild(li);  
        });  
        startGameBtn.disabled = players.length < 3;
        document.getElementById("player-count-alert").style.display = players.length < 3 ? 'block' : 'none';
    }  

    async function addPlayer() {  
        const name = playerInput.value.trim();  
        if (name && !players.includes(name)) {  
            players.push(name);  
            playerInput.value = '';  
            renderPlayers();  
            await updateFirestorePlayers();
        }  
    }  

    async function removePlayer(index) {  
        players.splice(index, 1);  
        renderPlayers();  
        await updateFirestorePlayers();
    }  

    async function updateFirestorePlayers() {
        const user = firebase.auth().currentUser;
        if (user) {
            await firebase.firestore().collection("users").doc(user.uid).update({ players: players });
        }
    }

    async function saveAndStartGame() {  
        if (players.length >= 3) {
            localStorage.setItem("players", JSON.stringify(players));   
            location.href = "game.html";   
        }
    }  

    function signOutUser() {  
        if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) {  
            firebase.auth().signOut().then(() => { location.href = "auth.html"; });  
        }  
    }

    // Ø¯ÙˆØ§Ù„ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§
    function displayIncomingGifts(gifts) {
        const list = document.getElementById("new-gifts-list");
        list.innerHTML = gifts.map(g => `<div style="margin:10px; padding:10px; background:#334155; border-radius:8px">ğŸ ${g.giftName} Ù…Ù† ${g.senderName}</div>`).join('');
        document.getElementById("incoming-gifts-overlay").style.display = 'flex';
    }

    async function clearNewGifts() {
        document.getElementById("incoming-gifts-overlay").style.display = 'none';
        const user = firebase.auth().currentUser;
        if (user) await firebase.firestore().collection("users").doc(user.uid).update({ newGifts: [] });
    }
</script>  
</body>  
</html>

