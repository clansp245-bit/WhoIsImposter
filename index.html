<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ•µï¸ Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ø¯Ù†ÙŠ Ø§Ù„Ù…Ø­ØªØ§Ù„</title>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="auth.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
body{
    font-family:'Cairo',sans-serif;
    background:#0f172a;
    color:#f1f5f9;
    text-align:center;
    padding:20px;
    margin:0;
}

#coin-display{
    position:absolute;
    top:20px;
    right:20px;
    font-weight:700;
}

#user-name-display{
    margin-top:50px;
    font-size:1.6rem;
    color:#34d399;
    text-decoration:none;
    font-weight:700;
}

#level-box{
    width:100%;
    max-width:450px;
    margin:15px auto 25px;
    background:#1e293b;
    padding:15px;
    border-radius:12px;
}

#level-title{
    font-weight:700;
    margin-bottom:8px;
}

#xp-bar-bg{
    background:#334155;
    height:16px;
    border-radius:10px;
    overflow:hidden;
}

#xp-bar{
    height:100%;
    width:0%;
    background:linear-gradient(90deg,#34d399,#22c55e);
    transition:width .4s;
}

#xp-info{
    margin-top:6px;
    font-size:.85rem;
    color:#94a3b8;
}

.card{
    background:#1e293b;
    padding:25px;
    border-radius:12px;
    max-width:450px;
    margin:auto;
    text-align:right;
}

input,button{
    width:100%;
    padding:12px;
    border-radius:8px;
    border:none;
    font-family:'Cairo';
}

input{
    background:#334155;
    color:white;
}

button{
    background:#6366f1;
    color:white;
    font-weight:700;
    margin-top:10px;
    cursor:pointer;
}

button:disabled{
    background:#475569;
}

#player-list li{
    background:#334155;
    padding:10px;
    border-radius:8px;
    margin-top:8px;
    display:flex;
    justify-content:space-between;
}
</style>
</head>

<body onload="checkAuthState()">

<div id="coin-display">
    <i class="fas fa-coins"></i> <span id="total-coins">0</span>
</div>

<a href="profile.html" id="user-name-display">...</a>

<div id="level-box">
    <div id="level-title">Lv <span id="level">1</span> â€” <span id="rank">Ù…Ø¨ØªØ¯Ø¦</span></div>
    <div id="xp-bar-bg">
        <div id="xp-bar"></div>
    </div>
    <div id="xp-info">
        <span id="xp-text">0 / 20 XP</span> â€” Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ <span id="xp-left">20</span>
    </div>
</div>

<div class="card">
    <input id="player-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨">
    <button onclick="addPlayer()">Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø¹Ø¨</button>
    <ul id="player-list"></ul>
    <button id="start-btn" disabled onclick="startGame()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
</div>

<script>
let currentUserData = {};
let players = [];

/* ---------------- LEVEL SYSTEM ---------------- */

function xpNeeded(level){ return level * 20 }

function rankName(level){
    if(level>=20) return "ğŸ‘‘ Ù…Ù„Ùƒ Ø§Ù„Ù„Ø¹Ø¨Ø©";
    if(level>=10) return "ğŸŸ£ Ø£Ø³Ø·ÙˆØ±ÙŠ";
    if(level>=5) return "ğŸ”µ Ù…Ø­ØªØ±Ù";
    return "ğŸŸ¢ Ù…Ø¨ØªØ¯Ø¦";
}

async function addXP(amount){
    currentUserData.xp += amount;
    await checkLevelUp();
}

async function checkLevelUp(){
    let leveled = false;
    while(currentUserData.xp >= xpNeeded(currentUserData.level)){
        currentUserData.xp -= xpNeeded(currentUserData.level);
        currentUserData.level++;
        currentUserData.totalCoins += currentUserData.level * 50;
        leveled = true;
    }

    if(leveled){
        alert(`ğŸ‰ ØªØ±Ù‚ÙŠØ©! ÙˆØµÙ„Øª Ù„Ù„Ù…Ø³ØªÙˆÙ‰ ${currentUserData.level}\n+ ${currentUserData.level*50} ÙƒÙˆÙŠÙ†Ø²`);
        await saveUserData(
            currentUserData.totalCoins,
            currentUserData.proExpiryTime || 0,
            players,
            {},
            currentUserData.level,
            currentUserData.xp,
            [],
            {}
        );
    }
    updateXPUI();
}

function updateXPUI(){
    const lvl = currentUserData.level;
    const xp = currentUserData.xp;
    const need = xpNeeded(lvl);
    const percent = Math.min((xp/need)*100,100);

    document.getElementById("level").innerText = lvl;
    document.getElementById("rank").innerText = rankName(lvl);
    document.getElementById("xp-bar").style.width = percent+"%";
    document.getElementById("xp-text").innerText = `${xp} / ${need} XP`;
    document.getElementById("xp-left").innerText = need - xp;
    document.getElementById("total-coins").innerText = currentUserData.totalCoins;
}

/* ---------------- AUTH ---------------- */

function checkAuthState(){
    firebase.auth().onAuthStateChanged(async user=>{
        if(!user) return location.href="auth.html";
        currentUserData = await loadUserData();
        currentUserData.level ??= 1;
        currentUserData.xp ??= 0;
        currentUserData.totalCoins ??= 0;
        document.getElementById("user-name-display").innerText = user.displayName || "Ù…Ø³ØªØ®Ø¯Ù…";
        updateXPUI();
    });
}

/* ---------------- PLAYERS ---------------- */

function renderPlayers(){
    const ul = document.getElementById("player-list");
    ul.innerHTML="";
    players.forEach((p,i)=>{
        ul.innerHTML+=`
        <li>${p}
        <button onclick="removePlayer(${i})">âŒ</button>
        </li>`;
    });
    document.getElementById("start-btn").disabled = players.length<3;
}

function addPlayer(){
    const val = document.getElementById("player-input").value.trim();
    if(val && !players.includes(val)){
        players.push(val);
        renderPlayers();
    }
}

function removePlayer(i){
    players.splice(i,1);
    renderPlayers();
}

function startGame(){
    addXP(15); // ØªØ¬Ø±Ø¨Ø©: ØªØ¹Ø·ÙŠ XP Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
    alert("ğŸ® Ø¨Ø¯Ø£Øª Ø§Ù„Ù„Ø¹Ø¨Ø©!");
}
</script>

</body>
</html>
