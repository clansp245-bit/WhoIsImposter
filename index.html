<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ•µï¸ Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ø¯Ù†ÙŠ Ø§Ù„Ù…Ø­ØªØ§Ù„</title>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="auth.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        /* -------------------------------------------------- */
        /* Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ÙˆØ§Ù„Ù‚Ø¯ÙŠÙ…Ø© */
        /* -------------------------------------------------- */
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #0f172a; 
            color: #f1f5f9; 
            text-align: center;
            padding: 20px;
            min-height: 100vh;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative; 
        }

        /* -------------------------------------------------- */
        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ */
        /* -------------------------------------------------- */

        /* Ø§Ù„ØªØ§Ø¬ (Ø£Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø±) */
        #pro-plans-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 24px;
            color: #ffd700; 
            cursor: pointer;
            transition: color 0.3s;
        }

        /* Ø§Ù„ÙƒÙˆÙŠÙ†Ø² (Ø£Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ†) */
        #coin-display {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 1.1rem;
            font-weight: 700;
            color: #94a3b8;
        }
        
        /* Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø±Ø§Ø¨Ø· Ù„ØµÙØ­Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„) */
        #user-name-display {
            font-size: 1.5rem;
            font-weight: 700;
            color: #34d399; 
            margin-top: 50px; 
            margin-bottom: 5px; /* ØªÙ… ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù‡Ø§Ù…Ø´ Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù€ XP */
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none; /* Ù„Ø¥Ø²Ø§Ù„Ø© Ø®Ø· Ø§Ù„Ø±Ø§Ø¨Ø· */
            cursor: pointer;
        }
        #user-name-display:hover {
            color: #10b981;
        }
        #user-name-display .pro-tag {
            color: #ffd700;
            margin-right: 8px;
            font-size: 1.2em;
        }
        
        /* Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ÙˆØ§Ù„Ø®Ø¨Ø±Ø© (Ø¬Ø¯ÙŠØ¯) */
        #level-xp-display {
            color:#94a3b8; 
            font-size:0.9rem; 
            margin-bottom: 25px;
            font-weight: 700;
        }


        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-top: 20px;
            margin-bottom: 30px;
            color: #f1f5f9; 
        }

        .card {
            background-color: #1e293b; 
            padding: 30px;
            border-radius: 12px;
            max-width: 450px;
            width: 90%;
            margin: 10px auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 10px 15px rgba(0, 0, 0, 0.2);
            text-align: right;
        }

        #player-input {
            font-family: 'Cairo', sans-serif;
            width: calc(100% - 24px); 
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #334155;
            font-size: 16px;
            background-color: #334155; 
            color: #f1f5f9;
            margin-bottom: 10px;
        }

        #add-player-btn, #settings-btn-card {
            padding: 10px 20px;
            font-size: 16px;
            font-weight: 700;
            border: none;
            border-radius: 8px; 
            cursor: pointer;
            transition: background-color 0.3s;
            width: 100%;
            margin-top: 10px;
        }
        #add-player-btn {
            background-color: #34d399; 
            color: #ffffff;
        }
        #add-player-btn:hover {
            background-color: #10b981; 
        }
        #settings-btn-card { 
            background-color: #6366f1; 
            color: #ffffff;
            margin-bottom: 20px; 
        }
        #settings-btn-card:hover {
            background-color: #4f46e5;
        }

        #player-list {
            list-style: none;
            padding: 0;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
        }
        #player-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            margin-bottom: 8px;
            background-color: #334155;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .delete-btn {
            background: none;
            border: none;
            color: #ff4f4f; 
            cursor: pointer;
            font-size: 1.1rem;
            transition: color 0.3s;
        }

        #start-game-btn { 
            margin-top: 30px; 
            padding: 12px 30px;
            font-size: 18px;
            font-weight: 700;
            border: none;
            border-radius: 8px; 
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            background-color: #6366f1;
            color: #ffffff;
            width: 100%;
        }
        #start-game-btn:hover:enabled {
            background-color: #4f46e5; 
            transform: translateY(-2px);
        }
        #start-game-btn:disabled {
            background-color: #475569;
            cursor: not-allowed;
        }
        
        #sign-out-btn {
            position: absolute;
            bottom: 20px;
            right: 20px; 
            background: none;
            border: none;
            color: #ff4f4f;
            cursor: pointer;
            font-size: 0.9rem;
            transition: color 0.3s;
        }

        .alert-message {
            color: #ffcc00;
            margin-top: 15px;
            font-size: 0.9rem;
        }

    </style>
</head>

<body onload="checkAuthState()">

    <a href="plans.html" id="pro-plans-btn" title="Ø®Ø·Ø· Ø§Ù„Ø¹Ø¶ÙˆÙŠØ© Ø§Ù„Ù…ØªÙ…ÙŠØ²Ø© (Pro)">
        <i class="fas fa-crown"></i>
    </a>
    
    <div id="coin-display">
        <i class="fas fa-coins"></i> Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="total-coins-value">0</span>
    </div>

    <a href="profile.html" id="user-name-display">
        Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
    </a>

    <div id="level-xp-display">
        Ø§Ù„Ù…Ø³ØªÙˆÙ‰ <span id="user-level">1</span> | Ø®Ø¨Ø±Ø© <span id="user-xp">0</span> XP
    </div>

    <h1>Ø§Ø¨Ø¯Ø£ Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ø¯Ù†ÙŠ Ø§Ù„Ù…Ø­ØªØ§Ù„</h1>

    <div class="card">
        
        <button id="settings-btn-card" onclick="location.href = 'settings.html'">
            <i class="fas fa-cog"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        </button>
        
        <label for="player-input" style="font-weight: 700; color: #f1f5f9;">Ø£Ø¶Ù Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†:</label>
        
        <input type="text" id="player-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨">
        <button id="add-player-btn" onclick="addPlayer()">Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø¹Ø¨</button>

        <p style="color: #94a3b8; font-size: 0.9rem; margin-top: 15px;">ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù„Ø¯ÙŠÙƒ 3 Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.</p>
        
        <ul id="player-list">
            </ul>
        
        <div id="player-count-alert" class="alert-message" style="display: none;">
            Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø¹Ø¨ Ù‡Ùˆ 3 Ù„Ø§Ø¹Ø¨ÙŠÙ†.
        </div>

        <button id="start-game-btn" disabled onclick="saveAndStartGame()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø© <i class="fas fa-play"></i></button>

    </div>
    
    <button id="sign-out-btn" onclick="signOutUser()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ <i class="fas fa-sign-out-alt"></i></button>

<script>
    let players = []; 
    let currentUserData = {}; 
    const playerList = document.getElementById("player-list");
    const playerInput = document.getElementById("player-input");
    const startGameBtn = document.getElementById("start-game-btn"); 
    const playerCountAlert = document.getElementById("player-count-alert");
    const userNameDisplay = document.getElementById("user-name-display"); 

    // ----------------------------------
    // Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙˆØ§Ù„ÙƒÙˆÙŠÙ†Ø²Ø§Øª ÙˆØ¹Ø±Ø¶Ù‡Ø§
    // ----------------------------------
    
    function isProUser() {
        const expiryTime = currentUserData.proExpiryTime || 0;
        return expiryTime > Date.now();
    }

    async function checkAuthState() {
         firebase.auth().onAuthStateChanged(async (user) => {
            if (user) {
                const data = await loadUserData(); 
                if (data) {
                    currentUserData = data;
                }
                
                const displayName = user.displayName;
                if (displayName) {
                    displayUserName(displayName);
                } else if (user.email) {
                    const tempName = user.email.split('@')[0];
                    displayUserName(tempName);
                } else {
                    displayUserName("Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯");
                }
                
                displayTotalCoins(); 
                displayLevelAndXP(); // ğŸš¨ Ø¬Ø¯ÙŠØ¯
                await loadPlayers(); 
            } else {
                window.location.href = "auth.html";
            }
        });
    }

    function displayUserName(name) {
        const isPro = isProUser();
        const proTag = isPro 
            ? '<i class="fas fa-crown pro-tag" title="Ø¹Ø¶Ùˆ Ù…ØªÙ…ÙŠØ² (Pro)"></i>'
            : '';
            
        userNameDisplay.innerHTML = `${proTag} ${name}`;
    }

    function displayTotalCoins() {
        document.getElementById("total-coins-value").innerText = currentUserData.totalCoins || 0;
    }

    /**
     * @function displayLevelAndXP
     * @description Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ÙˆØ§Ù„Ø®Ø¨Ø±Ø©.
     */
    function displayLevelAndXP() {
        // Ù†Ø¶Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ø¨Ø¹Ø¯
        const level = currentUserData.level || 1;
        const xp = currentUserData.xp || 0;
        
        document.getElementById("user-level").innerText = level;
        document.getElementById("user-xp").innerText = xp;
    }
    
    // ----------------------------------
    // Ù…Ù†Ø·Ù‚ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† (ÙŠØ³ØªØ®Ø¯Ù… Firestore)
    // ----------------------------------
    
    function renderPlayers() {
        playerList.innerHTML = '';
        players.forEach((player, index) => {
            const li = document.createElement('li');
            li.innerHTML = `
                <span>${player}</span>
                <button class="delete-btn" onclick="removePlayer(${index})"><i class="fas fa-trash"></i></button>
            `;
            playerList.appendChild(li);
        });
        
        if (players.length >= 3) {
            startGameBtn.disabled = false;
            playerCountAlert.style.display = 'none';
        } else {
            startGameBtn.disabled = true;
            playerCountAlert.style.display = 'block';
        }
    }

    async function savePlayersToFirestore() {
        const user = firebase.auth().currentUser;
        if (!user) return; 
        
        // ÙŠØ¬Ø¨ Ø¥Ø±Ø³Ø§Ù„ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ÙˆØ§Ù„Ø®Ø¨Ø±Ø©
        await saveUserData(
            currentUserData.totalCoins || 0,
            currentUserData.proExpiryTime || 0,
            players, 
            currentUserData.settings || {},
            currentUserData.level || 1, // ğŸš¨ Ù…Ø³ØªÙˆÙ‰
            currentUserData.xp || 0      // ğŸš¨ Ø®Ø¨Ø±Ø©
        );
        currentUserData.players = players;
    }

    async function addPlayer() {
        const playerName = playerInput.value.trim();
        if (playerName && playerName.length > 0 && !players.includes(playerName)) {
            players.push(playerName);
            playerInput.value = '';
            renderPlayers();
            await savePlayersToFirestore(); 
        } else if (players.includes(playerName)) {
            alert("Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„!");
        } else if (playerName.length === 0) {
             alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨.");
        }
    }
    
    async function removePlayer(index) {
        players.splice(index, 1);
        renderPlayers();
        await savePlayersToFirestore(); 
    }
    
    async function loadPlayers() {
        const savedPlayers = currentUserData.players;
        if (Array.isArray(savedPlayers)) {
            players = savedPlayers;
        } else {
            players = [];
        }
        renderPlayers();
    }
    
    async function saveAndStartGame() {
        if (players.length < 3) {
            alert("ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© 3 Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù‚Ø¨Ù„ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©.");
            return;
        }
        
        await savePlayersToFirestore(); 
        
        localStorage.setItem("players", JSON.stringify(players)); 
        
        location.href = "game.html"; 
    }

    playerInput.addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
            event.preventDefault();
            addPlayer();
        }
    });
    
    function signOutUser() {
        if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) {
            firebase.auth().signOut().then(() => {
                localStorage.clear();
                window.location.href = "auth.html";
            }).catch((error) => {
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬: " + error.message);
            });
        }
    }

</script>

</body>
</html>

