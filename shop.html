<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ›’ Ù…ØªØ¬Ø± Ø§Ù„ÙƒÙˆÙŠÙ†Ø² Ø§Ù„ÙƒØ¨ÙŠØ±</title>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="auth.js"></script> 

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
    body {
        font-family: 'Cairo', sans-serif;
        background-color: #0f172a; 
        color: #f1f5f9; 
        text-align: center;
        padding: 20px;
        min-height: 100vh;
        margin: 0;
    }
    .container {
        max-width: 1000px;
        margin: 0 auto;
    }
    h2 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 30px;
        color: #34d399;
    }
    .home-icon {
        position: absolute;
        top: 20px;
        right: 20px;
        font-size: 24px;
        color: #94a3b8;
        cursor: pointer;
        transition: color 0.3s;
    }
    #coin-display {
        position: absolute;
        top: 20px;
        left: 20px;
        font-size: 1.2rem;
        font-weight: 700;
        color: #ffd700; 
    }
    .shop-section {
        margin-bottom: 40px;
        padding: 20px;
        background-color: #1e293b;
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    }
    .shop-section h3 {
        color: #6366f1;
        font-size: 1.8rem;
        border-bottom: 2px solid #334155;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }
    .items-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
    }
    .item-card {
        background-color: #334155;
        padding: 15px;
        border-radius: 8px;
        width: 200px;
        transition: transform 0.2s, box-shadow 0.2s;
        position: relative;
    }
    .item-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.5);
    }
    .item-card h4 {
        margin-top: 0;
        color: #f1f5f9;
        font-size: 1.2rem;
    }
    .item-price {
        font-size: 1.5rem;
        font-weight: 700;
        color: #ffd700;
        margin: 10px 0;
    }
    .item-price i {
        margin-left: 5px;
    }
    .buy-btn {
        padding: 8px 15px;
        background-color: #34d399;
        color: #0f172a;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 700;
        transition: background-color 0.3s;
    }
    .buy-btn:hover:not(:disabled) {
        background-color: #10b981;
    }
    .buy-btn:disabled {
        background-color: #475569 !important;
        cursor: not-allowed;
        color: #ccc;
    }
    .rarity-badge {
        position: absolute;
        top: 5px;
        right: 5px;
        font-size: 0.8rem;
        padding: 3px 8px;
        border-radius: 4px;
        font-weight: 700;
    }
    .rarity-legendary { background-color: #ff9900; color: #000; }
    .rarity-epic { background-color: #6366f1; color: #fff; }
    .rarity-rare { background-color: #34d399; color: #000; }
    .rarity-common { background-color: #94a3b8; color: #0f172a; }
    
    #pack-result-message {
        margin-top: 20px;
        font-size: 1.2rem;
        color: #ffcc00;
        font-weight: 700;
        min-height: 25px; 
    }
</style>
</head>

<body onload="loadShopData()">

<a href="index.html" class="home-icon" title="Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">
    <i class="fas fa-home"></i>
</a>
<div id="coin-display">
    <i class="fas fa-coins"></i> ÙƒÙˆÙŠÙ†Ø²Ø§ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <span id="current-coins-value">0</span>
</div>

<div class="container">
    <h2>ğŸ›’ Ù…ØªØ¬Ø± Ø§Ù„ÙƒÙˆÙŠÙ†Ø² Ø§Ù„ÙƒØ¨ÙŠØ±</h2>

    <div class="shop-section">
        <h3>ğŸ Ø­Ø²Ù… ÙˆØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„ÙƒÙ„Ù…Ø§Øª (Ø§Ù„Ø­Ø¸)</h3>
        <p style="color: #94a3b8;">Ø§ÙØªØ­ Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£Ù‚Ø³Ø§Ù… ÙƒÙ„Ù…Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø¤Ù‚ØªØ© Ø£Ùˆ ÙØ±ØµØ© Ù†Ø§Ø¯Ø±Ø© Ø¬Ø¯Ø§Ù‹ Ù„Ù„Ø¯Ø§Ø¦Ù…!</p>
        <div id="pack-result-message"></div>
        <div class="items-container">
            <div class="item-card" data-cost="100">
                <h4>ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø¨ØªØ¯Ø¦ÙŠÙ†</h4>
                <p style="font-size: 0.9rem; color: #ccc;">ÙØ±ØµØ© Ø¹Ø§Ù„ÙŠØ© Ù„Ù„Ù…Ø¤Ù‚Øª Ø§Ù„Ù‚ØµÙŠØ±.</p>
                <div class="item-price">100 <i class="fas fa-coins"></i></div>
                <button class="buy-btn" onclick="openWordPack(100, 3)">Ø§ÙØªØ­ (3% Ø¯Ø§Ø¦Ù…)</button>
                <div class="rarity-badge rarity-common">Ø£Ø³Ø§Ø³ÙŠ</div>
            </div>
            <div class="item-card" data-cost="250">
                <h4>ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù†Ø¬ÙˆÙ…</h4>
                <p style="font-size: 0.9rem; color: #ccc;">ÙØ±ØµØ© Ø£ÙØ¶Ù„ Ù„Ø£Ù‚Ø³Ø§Ù… Ø£Ø·ÙˆÙ„.</p>
                <div class="item-price">250 <i class="fas fa-coins"></i></div>
                <button class="buy-btn" onclick="openWordPack(250, 1.5)">Ø§ÙØªØ­ (1.5% Ø¯Ø§Ø¦Ù…)</button>
                <div class="rarity-badge rarity-epic">Ù†Ø§Ø¯Ø±</div>
            </div>
            <div class="item-card" data-cost="500">
                <h4>ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø£Ø³Ø§Ø·ÙŠØ±</h4>
                <p style="font-size: 0.9rem; color: #ccc;">ÙØ±ØµØ© Ù†Ø§Ø¯Ø±Ø© Ø¬Ø¯Ø§Ù‹ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø·ÙˆØ±ÙŠ Ø§Ù„Ø¯Ø§Ø¦Ù….</p>
                <div class="item-price">500 <i class="fas fa-coins"></i></div>
                <button class="buy-btn" onclick="openWordPack(500, 0.5)">Ø§ÙØªØ­ (0.5% Ø¯Ø§Ø¦Ù…)</button>
                <div class="rarity-badge rarity-legendary">Ø£Ø³Ø·ÙˆØ±ÙŠ</div>
            </div>
        </div>
    </div>
    
    <div class="shop-section">
        <h3>ğŸ’ª Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù„Ø¹Ø¨ (Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù„Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©)</h3>
        <p style="color: #94a3b8;">Ù…ÙŠØ²Ø§Øª ØªÙØ³ØªØ®Ø¯Ù… Ù‚Ø¨Ù„ Ø¨Ø¯Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©. (ÙŠØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„ ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù‚Ø¨Ù„ Ø¨Ø¯Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø©).</p>
        <div class="items-container">
            <div class="item-card" data-id="doubleCoins">
                <h4>Ù…Ø¶Ø§Ø¹Ù Ø§Ù„ÙƒÙˆÙŠÙ†Ø² (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©)</h4>
                <p style="font-size: 0.9rem; color: #ccc;">ÙŠØ¶Ø§Ø¹Ù ÙƒÙˆÙŠÙ†Ø² Ø§Ù„Ø±Ø¨Ø­ ÙÙŠ Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©.</p>
                <div class="item-price">500 <i class="fas fa-coins"></i></div>
                <button class="buy-btn" onclick="buyFeature('doubleCoins', 500)">Ø´Ø±Ø§Ø¡</button>
                <div class="rarity-badge rarity-epic">Ù‚ÙˆÙŠØ©</div>
            </div>
             <div class="item-card" data-id="imposterHint">
                <h4>ØªÙ„Ù…ÙŠØ­ Ø§Ù„Ù…Ø­ØªØ§Ù„ Ø§Ù„Ø³Ø±ÙŠØ¹</h4>
                <p style="font-size: 0.9rem; color: #ccc;">ÙƒÙ…Ø¯Ù†ÙŠ: ÙŠØ­Ø¯Ø¯ Ø£ÙØ¶Ù„ Ù…Ø´ØªØ¨Ù‡ Ø¨Ù‡ Ù„ÙƒØ´ÙÙ‡.</p>
                <div class="item-price">800 <i class="fas fa-coins"></i></div>
                <button class="buy-btn" onclick="buyFeature('imposterHint', 800)">Ø´Ø±Ø§Ø¡</button>
                <div class="rarity-badge rarity-legendary">ØªÙ„Ù…ÙŠØ­</div>
            </div>
            <div class="item-card" data-id="wordReroll">
                <h4>ØªØºÙŠÙŠØ± Ø§Ù„ÙƒÙ„Ù…Ø© (Ù„Ù„Ù…Ø­ØªØ±Ù)</h4>
                <p style="font-size: 0.9rem; color: #ccc;">ÙƒÙ…Ø­ØªØ§Ù„: ÙŠÙ…Ù†Ø­Ùƒ Ø¥Ø¹Ø§Ø¯Ø© Ø³Ø­Ø¨ Ù„ÙƒÙ„Ù…ØªÙƒ Ø§Ù„Ø³Ø±ÙŠØ©.</p>
                <div class="item-price">300 <i class="fas fa-coins"></i></div>
                <button class="buy-btn" onclick="buyFeature('wordReroll', 300)">Ø´Ø±Ø§Ø¡</button>
                <div class="rarity-badge rarity-rare">ÙØ±ØµØ©</div>
            </div>
        </div>
    </div>
    
    <div class="shop-section">
        <h3>ğŸ¨ ØªØ®ØµÙŠØµ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙˆØ§Ù„Ø£Ù„ÙˆØ§Ù† (Ø¯Ø§Ø¦Ù…)</h3>
        <p style="color: #94a3b8;">Ø®Ù„ÙÙŠØ§Øª ÙˆØ£Ù„ÙˆØ§Ù† ÙˆØ´Ø§Ø±Ø§Øª Ø¯Ø§Ø¦Ù…Ø© Ù„Ù„Ø¹Ø¨Ø©. (ÙŠØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª).</p>
        <div class="items-container" id="customization-container">
            <div class="item-card" data-id="bg_space">
                <h4>Ø®Ù„ÙÙŠØ© Ø§Ù„ÙØ¶Ø§Ø¡ Ø§Ù„Ù…Ø¸Ù„Ù…</h4>
                <p style="font-size: 0.9rem; color: #ccc;">Ø®Ù„ÙÙŠØ© Ù†Ø¬ÙˆÙ… Ø³Ø§Ø·Ø¹Ø©.</p>
                <div class="item-price">800 <i class="fas fa-coins"></i></div>
                <button class="buy-btn" onclick="buyCustomization('bg_space', 800)">Ø´Ø±Ø§Ø¡</button>
                <div class="rarity-badge rarity-epic">Ø®Ù„ÙÙŠØ©</div>
            </div>
            <div class="item-card" data-id="color_gold">
                <h4>Ù„ÙˆÙ† Ø§Ù„Ù†Øµ Ø§Ù„Ø°Ù‡Ø¨ÙŠ</h4>
                <p style="font-size: 0.9rem; color: #ccc;">Ù„ÙˆÙ† Ø°Ù‡Ø¨ÙŠ Ø­ØµØ±ÙŠ Ù„Ø§Ø³Ù…Ùƒ.</p>
                <div class="item-price">1200 <i class="fas fa-coins"></i></div>
                <button class="buy-btn" onclick="buyCustomization('color_gold', 1200)">Ø´Ø±Ø§Ø¡</button>
                <div class="rarity-badge rarity-legendary">Ù„ÙˆÙ†</div>
            </div>
            <div class="item-card" data-id="bg_neon">
                <h4>Ø®Ù„ÙÙŠØ© Ø§Ù„Ù†ÙŠÙˆÙ†</h4>
                <p style="font-size: 0.9rem; color: #ccc;">Ø£Ø¶ÙˆØ§Ø¡ Ù†ÙŠÙˆÙ† Ø²Ø±Ù‚Ø§Ø¡ Ù…ØªÙˆÙ‡Ø¬Ø©.</p>
                <div class="item-price">950 <i class="fas fa-coins"></i></div>
                <button class="buy-btn" onclick="buyCustomization('bg_neon', 950)">Ø´Ø±Ø§Ø¡</button>
                <div class="rarity-badge rarity-epic">Ø®Ù„ÙÙŠØ©</div>
            </div>
            <div class="item-card" data-id="badge_crown">
                <h4>Ø´Ø§Ø±Ø© Ø§Ù„ØªØ§Ø¬ Ø§Ù„ØµØºÙŠØ±</h4>
                <p style="font-size: 0.9rem; color: #ccc;">Ø±Ù…Ø² ØªØ§Ø¬ ÙŠØ¸Ù‡Ø± Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ø³Ù…Ùƒ.</p>
                <div class="item-price">1500 <i class="fas fa-coins"></i></div>
                <button class="buy-btn" onclick="buyCustomization('badge_crown', 1500)">Ø´Ø±Ø§Ø¡</button>
                <div class="rarity-badge rarity-legendary">Ø´Ø§Ø±Ø©</div>
            </div>
        </div>
    </div>
    
    <div class="shop-section">
        <h3>ğŸ‘‘ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ© Ø§Ù„Ù…ØªÙ…ÙŠØ²Ø© (PRO)</h3>
        <p style="color: #94a3b8;">Ù„ØªÙØ¹ÙŠÙ„ Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© ÙˆØ­Ø²Ù… Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø­ØµØ±ÙŠØ©.</p>
        <a href="pro.html" style="text-decoration: none;">
            <button class="buy-btn" style="background-color: #ff9900; color: #1e293b; padding: 12px 30px; font-size: 1.1rem;">
                Ø§Ø°Ù‡Ø¨ Ù„ØµÙØ­Ø© PRO <i class="fas fa-crown"></i>
            </button>
        </a>
    </div>

</div>

<script>

// ** ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ« Ù‡Ø°Ø§ Ø§Ù„ÙƒØ§Ø¦Ù† Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© Ø­Ù‚ÙˆÙ„ ØªØ®ØµÙŠØµ Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ auth.js **
let currentUserData = { totalCoins: 0, proExpiryTime: 0, players: [], settings: {}, ownedPacksPermanent: [], ownedPacksTemporary: [], ownedCustomizations: [] }; 
const packResultMessage = document.getElementById("pack-result-message");

// ****************************************************
// 1. ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙˆØ§Ù„Ù†Ø¯Ø±Ø©
// ****************************************************

// ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ†Ù‡Ø§ Ø¹Ù†Ø¯ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ openWordPack Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚
let CURRENT_PACK_COST = 0; 
let CURRENT_PERMANENT_ROLL_CHANCE = 0; 

// Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø¤Ù‚ØªØ©: (Ø§Ù„ÙØ±ØµØ© Ø§Ù„ÙƒÙ„ÙŠØ© 100%) - ØªÙ… Ø²ÙŠØ§Ø¯Ø© Ø¹Ø¯Ø¯Ù‡Ø§
const possiblePacks = [
    // Rare - 2 Days (Chance Total: 40%)
    { id: 'foods', name: 'Ø§Ù„Ù…Ø£ÙƒÙˆÙ„Ø§Øª', rarity: 'rare', chance: 15, duration: 2, icon: 'ğŸ½ï¸' }, 
    { id: 'animals', name: 'Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª', rarity: 'rare', chance: 15, duration: 2, icon: 'ğŸ¾' }, 
    { id: 'jobs', name: 'Ø§Ù„Ù…Ù‡Ù†', rarity: 'rare', chance: 10, duration: 2, icon: 'ğŸ‘·' }, 
    // Epic - 5 Days (Chance Total: 35%)
    { id: 'places', name: 'Ø§Ù„Ø£Ù…Ø§ÙƒÙ†', rarity: 'epic', chance: 10, duration: 5, icon: 'ğŸ“' }, 
    { id: 'activities', name: 'Ø§Ù„Ø£Ù†Ø´Ø·Ø©', rarity: 'epic', chance: 10, duration: 5, icon: 'ğŸƒ' },
    { id: 'emotions', name: 'Ø§Ù„Ù…Ø´Ø§Ø¹Ø±', rarity: 'epic', chance: 10, duration: 5, icon: 'ğŸ˜Š' },
    { id: 'sports', name: 'Ø§Ù„Ø±ÙŠØ§Ø¶Ø©', rarity: 'epic', chance: 5, duration: 5, icon: 'âš½' },
    // Legendary - 7 Days (Chance Total: 25%)
    { id: 'adjectives', name: 'Ø§Ù„ØµÙØ§Øª', rarity: 'legendary', chance: 10, duration: 7, icon: 'âœ¨' },
    { id: 'movies', name: 'Ø§Ù„Ø£ÙÙ„Ø§Ù…', rarity: 'legendary', chance: 7, duration: 7, icon: 'ğŸ¬' },
    { id: 'history', name: 'Ø§Ù„ØªØ§Ø±ÙŠØ®', rarity: 'legendary', chance: 5, duration: 7, icon: 'ğŸ“œ' },
    { id: 'tech', name: 'Ø§Ù„ØªÙ‚Ù†ÙŠØ©', rarity: 'legendary', chance: 3, duration: 7, icon: 'ğŸ’»' },
];

// Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø¯Ø§Ø¦Ù…Ø©: (Ø§Ù„ÙØ±ØµØ© Ø§Ù„ÙƒÙ„ÙŠØ© 100% Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù„ÙØ© Ø§Ù„Ø¯Ø§Ø¦Ù…Ø©) - ØªÙ… Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø·ÙŠØ±
const permanentPackChances = [
    { id: 'secret', name: 'Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ©', rarity: 'legendary', chance: 0.1, icon: 'ğŸ”‘' }, // ğŸš¨ Ù†Ø§Ø¯Ø±Ø© Ø¬Ø¯Ø§Ù‹
    { id: 'movies', name: 'Ø§Ù„Ø£ÙÙ„Ø§Ù… (Ø¯Ø§Ø¦Ù…)', rarity: 'legendary', chance: 0.4, icon: 'ğŸ†' }, 
    { id: 'history', name: 'Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø¯Ø§Ø¦Ù…)', rarity: 'legendary', chance: 0.5, icon: 'ğŸ›ï¸' }, 
    { id: 'adjectives', name: 'Ø§Ù„ØµÙØ§Øª (Ø¯Ø§Ø¦Ù…)', rarity: 'epic', chance: 2, icon: 'â­' }, 
    { id: 'places', name: 'Ø§Ù„Ø£Ù…Ø§ÙƒÙ† (Ø¯Ø§Ø¦Ù…)', rarity: 'rare', chance: 5, icon: 'ğŸ ' }, 
    { id: 'fail', name: 'ÙƒÙˆÙŠÙ†Ø²Ø§Øª Ø¨Ø³ÙŠØ·Ø©', rarity: 'common', chance: 92, icon: 'ğŸ’°' } // 92% ÙØ±ØµØ© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø´ÙŠØ¡ Ø¹Ø§Ø¯ÙŠ 
];

// ****************************************************
// 2. Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
// ****************************************************

async function loadShopData() {
    firebase.auth().onAuthStateChanged(async (user) => {
        if (!user) {
            window.location.href = "auth.html";
            return;
        }
        
        const data = await loadUserData(); 
        if (data) {
            currentUserData = data;
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ‡ÙŠØ¦Ø© Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ®ØµÙŠØµ
            currentUserData.settings.customizations = currentUserData.settings.customizations || [];
            currentUserData.settings.activeFeatures = currentUserData.settings.activeFeatures || {};
        }
        
        displayTotalCoins();
        updateCustomizationButtons();
        updateFeatureButtons();
    });
}

function getTotalCoins() {
    return currentUserData.totalCoins || 0;
}

function displayTotalCoins() {
    document.getElementById("current-coins-value").innerText = getTotalCoins();
    updatePackButtons();
    updateCustomizationButtons();
    updateFeatureButtons();
}

// ****************************************************
// 3. Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­Ø²Ù… ÙˆØ§Ù„Ù†Ø¯Ø±Ø©
// ****************************************************

function getLootResult(isPermanentRoll) {
    let roll = Math.random() * 100;
    let cumulativeChance = 0;
    
    const targetArray = isPermanentRoll ? permanentPackChances : possiblePacks;
    
    for (const item of targetArray) {
        cumulativeChance += item.chance;
        if (roll <= cumulativeChance) {
            return item;
        }
    }
    return targetArray[targetArray.length - 1]; 
}

function getRarityCoinValue(rarity, cost) {
    // Ù…ÙƒØ§ÙØ£Ø© Ø¹Ø§Ù„ÙŠØ© Ø¬Ø¯Ø§Ù‹ Ù„Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø£Ø³Ø·ÙˆØ±ÙŠØ© Ø§Ù„Ù…ÙƒØ±Ø±Ø©
    switch(rarity) {
        case 'common': return cost * 0.5;
        case 'rare': return cost * 2; 
        case 'epic': return cost * 4; 
        case 'legendary': return cost * 10; // Ù…ÙƒØ§ÙØ£Ø© Ø¶Ø®Ù…Ø© (10 Ø£Ø¶Ø¹Ø§Ù Ø§Ù„Ø³Ø¹Ø± Ù„Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø£ØºÙ„Ù‰)
        default: return cost;
    }
}

function updatePackButtons() {
    const currentCoins = getTotalCoins();
    document.querySelectorAll('.shop-section:first-of-type .item-card').forEach(card => {
        const cost = Number(card.getAttribute('data-cost'));
        const button = card.querySelector('.buy-btn');

        button.disabled = currentCoins < cost;
        
        if (button.disabled) {
            button.innerText = 'Ø§Ù„ÙƒÙˆÙŠÙ†Ø²Ø§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ©';
        } else {
            // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚
            const permanentChance = card.onclick.toString().match(/openWordPack\(\d+, (\d+\.?\d*)\)/)[1];
            button.innerText = `Ø§ÙØªØ­ (${permanentChance}% Ø¯Ø§Ø¦Ù…)`;
        }
    });
}

/**
 * @function openWordPack
 * @description ÙØªØ­ Ø­Ø²Ù…Ø© ØºØ§Ù…Ø¶Ø© ÙˆØªØ·Ø¨ÙŠÙ‚ Ù…Ù†Ø·Ù‚ Ø§Ù„Ù†Ø¯Ø±Ø© ÙˆØ§Ù„Ù…ÙƒØ§ÙØ£Ø©.
 * @param {number} cost - ØªÙƒÙ„ÙØ© Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚.
 * @param {number} permanentChance - ÙØ±ØµØ© Ø§Ù„Ø¯Ø§Ø¦Ù… Ù„Ù‡Ø°Ø§ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ (Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©).
 */
async function openWordPack(cost, permanentChance) {
    if (getTotalCoins() < cost) return;

    CURRENT_PACK_COST = cost;
    CURRENT_PERMANENT_ROLL_CHANCE = permanentChance;

    // Ø®ØµÙ… Ø§Ù„ÙƒÙ„ÙØ© ÙÙˆØ±Ø§Ù‹
    currentUserData.totalCoins -= CURRENT_PACK_COST; 

    // ** 1. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†ØªÙŠØ¬Ø©: Ø¯Ø§Ø¦Ù…Ø© Ø£Ù… Ù…Ø¤Ù‚ØªØ©ØŸ **
    const isPermanentRoll = Math.random() * 100 < CURRENT_PERMANENT_ROLL_CHANCE; 
    const result = getLootResult(isPermanentRoll);
    
    let coinsEarned = 0;
    let message = "";
    
    let tempPacks = { ...currentUserData.ownedPacksTemporary };
    let permPacks = [...currentUserData.ownedPacksPermanent];
    
    const now = new Date().getTime();

    if (isPermanentRoll) {
        // ** Ø£. Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¯Ø§Ø¦Ù…Ø© **
        
        if (result.id === 'fail') {
            coinsEarned = getRarityCoinValue('common', CURRENT_PACK_COST); 
            message = `${result.icon} Ù„Ù… ØªÙƒÙ† Ù…Ø­Ø¸ÙˆØ¸Ù‹Ø§ ÙÙŠ Ø§Ù„Ù„ÙØ© Ø§Ù„Ø¯Ø§Ø¦Ù…Ø©ØŒ Ù„ÙƒÙ†Ùƒ Ø±Ø¨Ø­Øª ${coinsEarned} ÙƒÙˆÙŠÙ†Ø² ØªØ¹ÙˆÙŠØ¶Ù‹Ø§.`;
        } 
        else if (permPacks.includes(result.id)) {
            // Ù„Ø¯ÙŠÙ‡ Ø§Ù„Ø­Ø²Ù…Ø© Ø§Ù„Ø¯Ø§Ø¦Ù…Ø© Ø¨Ø§Ù„ÙØ¹Ù„: Ù…ÙƒØ§ÙØ£Ø© Ù†Ø¯Ø±Ø©
            coinsEarned = getRarityCoinValue(result.rarity, CURRENT_PACK_COST);
            message = `ğŸ‰ Ù„Ø¯ÙŠÙƒ Ø¨Ø§Ù„ÙØ¹Ù„ Ù‚Ø³Ù… ${result.name} Ø¯Ø§Ø¦Ù…Ù‹Ø§! Ù…ÙƒØ§ÙØ£Ø© Ù†Ø¯Ø±Ø© ${coinsEarned} ÙƒÙˆÙŠÙ†Ø²!`;
        } else {
            // Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø­Ø²Ù…Ø© Ø¯Ø§Ø¦Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©
            permPacks.push(result.id);
            message = `ğŸ’ Ù…Ø¨Ø±ÙˆÙƒ! Ø­ØµÙ„Øª Ø¹Ù„Ù‰ Ù‚Ø³Ù… ${result.name} (Ø¯Ø§Ø¦Ù…)!`;
            coinsEarned = 0;
        }

    } else {
        // ** Ø¨. Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù…Ø¤Ù‚ØªØ© **
        
        if (permPacks.includes(result.id)) {
            // ÙŠÙ…Ù„ÙƒÙ‡Ø§ Ø¯Ø§Ø¦Ù…Ù‹Ø§ØŒ ÙŠØ¹Ø·Ù‰ ÙƒÙˆÙŠÙ†Ø² Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù…Ø¤Ù‚Øª
             coinsEarned = getRarityCoinValue(result.rarity, CURRENT_PACK_COST) / 2;
             message = `${result.icon} Ø­ØµÙ„Øª Ø¹Ù„Ù‰ Ù‚Ø³Ù… ${result.name} (Ù…Ø¤Ù‚Øª)ØŒ Ù„ÙƒÙ† Ù„Ø¯ÙŠÙƒ Ø§Ù„Ø¯Ø§Ø¦Ù…! Ù…ÙƒØ§ÙØ£Ø©: ${coinsEarned} ÙƒÙˆÙŠÙ†Ø².`;
        } else {
             const durationMs = result.duration * 24 * 60 * 60 * 1000;
             if (tempPacks[result.id] && tempPacks[result.id] > now) {
                tempPacks[result.id] += durationMs;
                message = `${result.icon} ØªÙ… ØªÙ…Ø¯ÙŠØ¯ Ù‚Ø³Ù… ${result.name} Ù„Ù€ ${result.duration} Ø£ÙŠØ§Ù… Ø¥Ø¶Ø§ÙÙŠØ©.`;
            } else {
                tempPacks[result.id] = now + durationMs;
                message = `${result.icon} Ø­ØµÙ„Øª Ø¹Ù„Ù‰ Ù‚Ø³Ù… ${result.name} Ù„Ù…Ø¯Ø© ${result.duration} Ø£ÙŠØ§Ù…!`;
            }
        }
    }
    
    currentUserData.totalCoins += coinsEarned;
    
    // ** 2. Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø© **
    const saveSuccessful = await saveUserData(
        currentUserData.totalCoins, 
        currentUserData.proExpiryTime, 
        currentUserData.players, 
        currentUserData.settings,
        permPacks, 
        tempPacks  
    );

    packResultMessage.innerHTML = message;
    
    if (saveSuccessful) {
        displayTotalCoins();
    } else {
        currentUserData.totalCoins += CURRENT_PACK_COST; 
        packResultMessage.innerHTML = "âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸. ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.";
        displayTotalCoins();
    }
}


// ****************************************************
// 4. Ù…Ù†Ø·Ù‚ Ø´Ø±Ø§Ø¡ Ø§Ù„ØªØ®ØµÙŠØµ ÙˆØ§Ù„Ù…ÙŠØ²Ø§Øª
// ****************************************************

/**
 * @function buyCustomization
 * @description Ø´Ø±Ø§Ø¡ Ø¹Ù†ØµØ± ØªØ®ØµÙŠØµ Ø¯Ø§Ø¦Ù….
 */
async function buyCustomization(itemId, cost) {
    if (getTotalCoins() < cost) {
        alert("Ø§Ù„ÙƒÙˆÙŠÙ†Ø²Ø§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ©!");
        return;
    }
    
    // ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ customizations Ù…Ø¨Ø§Ø´Ø±Ø© Ø¥Ù„Ù‰ settings
    currentUserData.settings.customizations = currentUserData.settings.customizations || [];

    if (currentUserData.settings.customizations.includes(itemId)) {
        alert("Ø£Ù†Øª ØªÙ…Ù„Ùƒ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ± Ø¨Ø§Ù„ÙØ¹Ù„!");
        return;
    }

    if (!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø´Ø±Ø§Ø¡ ${itemId} Ù…Ù‚Ø§Ø¨Ù„ ${cost} ÙƒÙˆÙŠÙ†Ø²ØŸ`)) return;

    currentUserData.totalCoins -= cost;
    let newCustomizations = [...currentUserData.settings.customizations, itemId];
    currentUserData.settings.customizations = newCustomizations;


    const saveSuccessful = await saveUserData(
        currentUserData.totalCoins, 
        currentUserData.proExpiryTime, 
        currentUserData.players, 
        currentUserData.settings, // ØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ Ù‡Ù†Ø§
        currentUserData.ownedPacksPermanent, 
        currentUserData.ownedPacksTemporary 
    );
    
    if (saveSuccessful) {
        alert("âœ… ØªÙ… Ø´Ø±Ø§Ø¡ Ø¹Ù†ØµØ± Ø§Ù„ØªØ®ØµÙŠØµ Ø¨Ù†Ø¬Ø§Ø­!");
        displayTotalCoins();
    } else {
        currentUserData.totalCoins += cost;
        alert("âŒ ÙØ´Ù„ Ø­ÙØ¸ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø´Ø±Ø§Ø¡.");
        displayTotalCoins();
    }
}

/**
 * @function buyFeature
 * @description Ø´Ø±Ø§Ø¡ Ù…ÙŠØ²Ø© ØªØ³ØªØ®Ø¯Ù… Ù„Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©.
 */
async function buyFeature(featureId, cost) {
     if (getTotalCoins() < cost) {
        alert("Ø§Ù„ÙƒÙˆÙŠÙ†Ø²Ø§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ©!");
        return;
    }
    
    if (!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø´Ø±Ø§Ø¡ ${featureId} Ù…Ù‚Ø§Ø¨Ù„ ${cost} ÙƒÙˆÙŠÙ†Ø²ØŸ Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ùƒ ÙÙŠ Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©.`)) return;

    currentUserData.totalCoins -= cost;
    
    // Ø²ÙŠØ§Ø¯Ø© Ø¹Ø¯Ø¯ Ø§Ø³ØªØ®Ø¯Ø§Ù…Ø§Øª Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø©
    currentUserData.settings.activeFeatures = currentUserData.settings.activeFeatures || {};
    currentUserData.settings.activeFeatures[featureId] = (currentUserData.settings.activeFeatures[featureId] || 0) + 1;


    const saveSuccessful = await saveUserData(
        currentUserData.totalCoins, 
        currentUserData.proExpiryTime, 
        currentUserData.players, 
        currentUserData.settings, // ØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ Ù‡Ù†Ø§
        currentUserData.ownedPacksPermanent, 
        currentUserData.ownedPacksTemporary 
    );

    if (saveSuccessful) {
        alert(`âœ… ØªÙ… Ø´Ø±Ø§Ø¡ Ù…ÙŠØ²Ø© ${featureId}! Ù„Ø¯ÙŠÙƒ Ø§Ù„Ø¢Ù† ${currentUserData.settings.activeFeatures[featureId]} Ø§Ø³ØªØ®Ø¯Ø§Ù….`);
        displayTotalCoins();
    } else {
        currentUserData.totalCoins += cost;
        alert("âŒ ÙØ´Ù„ Ø­ÙØ¸ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø´Ø±Ø§Ø¡.");
        displayTotalCoins();
    }
}

// ****************************************************
// 5. ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø´Ø±Ø§Ø¡
// ****************************************************

function updateCustomizationButtons() {
    const currentCoins = getTotalCoins();
    const ownedCustoms = currentUserData.settings.customizations || [];

    document.querySelectorAll('#customization-container .item-card').forEach(card => {
        const itemId = card.getAttribute('data-id');
        const button = card.querySelector('.buy-btn');
        const cost = Number(card.querySelector('.item-price').textContent.split(' ')[0]);

        if (ownedCustoms.includes(itemId)) {
            button.disabled = true;
            button.innerText = 'Ù…Ù…Ù„ÙˆÙƒ';
            button.style.backgroundColor = '#6366f1';
        } else if (currentCoins < cost) {
            button.disabled = true;
            button.innerText = 'ÙƒÙˆÙŠÙ†Ø² ØºÙŠØ± ÙƒØ§ÙÙŠØ©';
            button.style.backgroundColor = '#475569';
        } else {
            button.disabled = false;
            button.innerText = 'Ø´Ø±Ø§Ø¡';
            button.style.backgroundColor = '#34d399';
        }
    });
}

function updateFeatureButtons() {
     const currentCoins = getTotalCoins();
     document.querySelectorAll('.shop-section:nth-child(3) .item-card').forEach(card => {
        const button = card.querySelector('.buy-btn');
        const cost = Number(card.querySelector('.item-price').textContent.split(' ')[0]);
        
        if (currentCoins < cost) {
            button.disabled = true;
            button.innerText = 'ÙƒÙˆÙŠÙ†Ø² ØºÙŠØ± ÙƒØ§ÙÙŠØ©';
            button.style.backgroundColor = '#475569';
        } else {
            button.disabled = false;
            button.innerText = 'Ø´Ø±Ø§Ø¡';
            button.style.backgroundColor = '#34d399';
        }
    });
}
</script>

</body>
</html>

